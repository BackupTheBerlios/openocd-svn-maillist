From dbrownell at users.sourceforge.net  Sat Jan  2 11:11:07 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sat,  2 Jan 2010 10:11:07 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-31-g9d167d6
Message-ID: <E1NR0wv-0005oR-M7@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  9d167d62f2eadf81e0028e471e05154c9aabbbfb (commit)
       via  be01786186951b42d8aa8b8968ac1615e080a9c7 (commit)
       via  668f20d0abc22765dda6dd5d094eb79bea321ace (commit)
      from  384e9193e99d54d6cafb979b6b2e1fd8e3fbd200 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 9d167d62f2eadf81e0028e471e05154c9aabbbfb
Author: Dean Glazeski <dnglaze at gmail.com>
Date:   Thu Dec 31 16:01:32 2009 -0600

    Fix usage/help search for subcommands.
    
    This makes it so that the usage/help command properly uses the whole command,
    including subcommand, in the search for help information.  This previously
    caused erroneous output from the usage command handler.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/helper/command.c b/src/helper/command.c
index e55f9e7..b4e31ea 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -960,18 +960,45 @@ static COMMAND_HELPER(command_help_show, struct command *c, unsigned n,
 COMMAND_HANDLER(handle_help_command)
 {
 	bool full = strcmp(CMD_NAME, "help") == 0;
-
+	int retval;
 	struct command *c = CMD_CTX->commands;
+	char *match = NULL;
 
-	const char *match = "";
 	if (CMD_ARGC == 0)
 		match = "";
-	else if (CMD_ARGC == 1)
-		match = CMD_ARGV[0]; 
-	else
+	else if (CMD_ARGC >= 1) {
+		unsigned i;
+
+		for (i = 0; i < CMD_ARGC; ++i) {
+			if (NULL != match) {
+				char *prev = match;
+
+				match = alloc_printf("%s %s", match,
+						CMD_ARGV[i]);
+				free(prev);
+				if (NULL == match) {
+					LOG_ERROR("unable to build "
+							"search string");
+					return -ENOMEM;
+				}
+			} else {
+				match = alloc_printf("%s", CMD_ARGV[i]);
+				if (NULL == match) {
+					LOG_ERROR("unable to build "
+							"search string");
+					return -ENOMEM;
+				}
+			}
+		}
+	} else
 		return ERROR_COMMAND_SYNTAX_ERROR;
-		
-	return CALL_COMMAND_HANDLER(command_help_show_list, c, 0, full, match);
+
+	retval = CALL_COMMAND_HANDLER(command_help_show_list,
+			c, 0, full, match);
+
+	if (CMD_ARGC >= 1)
+		free(match);
+	return retval;
 }
 
 static int command_unknown_find(unsigned argc, Jim_Obj *const *argv,

commit be01786186951b42d8aa8b8968ac1615e080a9c7
Author: Dean Glazeski <dnglaze at gmail.com>
Date:   Fri Jan 1 19:58:38 2010 -0600

    Add the current command to the command information
    
    I wanted to make it so I can be ignorant of a commands invocation string, so
    I tried to use CMD_CURRENT (aka cmd->current) which is supposed to house a
    pointer to the current command. ??It turns out that this wasn't being set.
    
    This patch adds the current command structure to the command invocation
    structure before sending it along to the command handler.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/helper/command.c b/src/helper/command.c
index b991544..e55f9e7 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -580,6 +580,7 @@ static int run_command(struct command_context *context,
 
 	struct command_invocation cmd = {
 			.ctx = context,
+			.current = c,
 			.name = c->name,
 			.argc = num_words - 1,
 			.argv = words + 1,

commit 668f20d0abc22765dda6dd5d094eb79bea321ace
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Thu Dec 31 20:19:26 2009 +0800

    Added ST FlashLINK interface config file.
    
    The relevant cable config is already in OpenOCD, but not a config for
    the JTAG adapter.  I have tested with FlashLINK on ARM926.
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/tcl/interface/flashlink.cfg b/tcl/interface/flashlink.cfg
new file mode 100644
index 0000000..4b00de9
--- /dev/null
+++ b/tcl/interface/flashlink.cfg
@@ -0,0 +1,10 @@
+#
+# ST FlashLINK JTAG parallel cable
+#
+# http://www.st.com/mcu/contentid-94-80-FL_101.html
+# http://www.st.com/stonline/products/literature/um/7889.pdf
+#
+
+interface parport
+parport_port 0
+parport_cable flashlink

-----------------------------------------------------------------------

Summary of changes:
 src/helper/command.c        |   42 +++++++++++++++++++++++++++++++++++-------
 tcl/interface/flashlink.cfg |   10 ++++++++++
 2 files changed, 45 insertions(+), 7 deletions(-)
 create mode 100644 tcl/interface/flashlink.cfg


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sun Jan  3 01:31:41 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sun,  3 Jan 2010 00:31:41 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-37-g4ed5b45
Message-ID: <E1NRENi-0003js-79@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  4ed5b45097cb2c13f9ef0682848c4682b5fd7240 (commit)
       via  858226aae27b262cb3cb8274c6c7459a0068cc8a (commit)
       via  6105f2bc4a65e1e42a0fb238096cbc0577b994c0 (commit)
       via  e60c164cdb50a0aa268165e57de0a4cd0d58fcdf (commit)
       via  ec88ccc51cb5d8594ae95660c826954f3a9042ec (commit)
       via  b3bf1d12b2fdfba1c1cbee3e1afbfbb27cbd1a26 (commit)
      from  9d167d62f2eadf81e0028e471e05154c9aabbbfb (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 4ed5b45097cb2c13f9ef0682848c4682b5fd7240
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 2 15:53:33 2010 -0800

    ARM: ADIv5 JTAG symbol cleanup
    
    Rename DAP_IR_* as JTAG_DP_* since those symbols are specifically
    for JTAG-DP (or SWJ-DP in JTAG mode), and won't work with SWD.
    Define the JTAG ABORT and IDCODE instructions for completeness;
    add a comment about where to (someday) use ABORT.
    
    Fix messaging which assumes everything is an SWJ-DP; say "JTAG-DP"
    instead, it's at least more appropriate for all JTAG transports.
    
    Shrink the affected lines.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 72a07cd..82a2a28 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -101,7 +101,10 @@ static int adi_jtag_dp_scan(struct swjdp_common *swjdp,
 	arm_jtag_set_instr(jtag_info, instr, NULL);
 
 	/* Add specified number of tck clocks before accessing memory bus */
-	if ((instr == DAP_IR_APACC) && ((reg_addr == AP_REG_DRW)||((reg_addr&0xF0) == AP_REG_BD0))&& (swjdp->memaccess_tck != 0))
+	if ((instr == JTAG_DP_APACC)
+			&& ((reg_addr == AP_REG_DRW)
+				|| ((reg_addr & 0xF0) == AP_REG_BD0))
+			&& (swjdp->memaccess_tck != 0))
 		jtag_add_runtest(swjdp->memaccess_tck, jtag_set_end_state(TAP_IDLE));
 
 	fields[0].tap = jtag_info->tap;
@@ -134,7 +137,10 @@ static int adi_jtag_dp_scan_u32(struct swjdp_common *swjdp,
 	arm_jtag_set_instr(jtag_info, instr, NULL);
 
 	/* Add specified number of tck clocks before accessing memory bus */
-	if ((instr == DAP_IR_APACC) && ((reg_addr == AP_REG_DRW)||((reg_addr&0xF0) == AP_REG_BD0))&& (swjdp->memaccess_tck != 0))
+	if ((instr == JTAG_DP_APACC)
+			&& ((reg_addr == AP_REG_DRW)
+				|| ((reg_addr & 0xF0) == AP_REG_BD0))
+			&& (swjdp->memaccess_tck != 0))
 		jtag_add_runtest(swjdp->memaccess_tck, jtag_set_end_state(TAP_IDLE));
 
 	fields[0].tap = jtag_info->tap;
@@ -172,15 +178,15 @@ static int scan_inout_check(struct swjdp_common *swjdp,
 	adi_jtag_dp_scan(swjdp, instr, reg_addr, RnW, outvalue, NULL, NULL);
 
 	if ((RnW == DPAP_READ) && (invalue != NULL))
-	{
-		adi_jtag_dp_scan(swjdp, DAP_IR_DPACC, DP_RDBUFF, DPAP_READ, 0, invalue, &swjdp->ack);
-	}
+		adi_jtag_dp_scan(swjdp, JTAG_DP_DPACC,
+				DP_RDBUFF, DPAP_READ, 0, invalue, &swjdp->ack);
 
-	/* In TRANS_MODE_ATOMIC all DAP_IR_APACC transactions wait for ack = OK/FAULT and the check CTRL_STAT */
-	if ((instr == DAP_IR_APACC) && (swjdp->trans_mode == TRANS_MODE_ATOMIC))
-	{
+	/* In TRANS_MODE_ATOMIC all JTAG_DP_APACC transactions wait for
+	 * ack = OK/FAULT and the check CTRL_STAT
+	 */
+	if ((instr == JTAG_DP_APACC)
+			&& (swjdp->trans_mode == TRANS_MODE_ATOMIC))
 		return swjdp_transaction_endcheck(swjdp);
-	}
 
 	return ERROR_OK;
 }
@@ -192,15 +198,15 @@ static int scan_inout_check_u32(struct swjdp_common *swjdp,
 	adi_jtag_dp_scan_u32(swjdp, instr, reg_addr, RnW, outvalue, NULL, NULL);
 
 	if ((RnW == DPAP_READ) && (invalue != NULL))
-	{
-		adi_jtag_dp_scan_u32(swjdp, DAP_IR_DPACC, DP_RDBUFF, DPAP_READ, 0, invalue, &swjdp->ack);
-	}
+		adi_jtag_dp_scan_u32(swjdp, JTAG_DP_DPACC,
+				DP_RDBUFF, DPAP_READ, 0, invalue, &swjdp->ack);
 
-	/* In TRANS_MODE_ATOMIC all DAP_IR_APACC transactions wait for ack = OK/FAULT and then check CTRL_STAT */
-	if ((instr == DAP_IR_APACC) && (swjdp->trans_mode == TRANS_MODE_ATOMIC))
-	{
+	/* In TRANS_MODE_ATOMIC all JTAG_DP_APACC transactions wait for
+	 * ack = OK/FAULT and then check CTRL_STAT
+	 */
+	if ((instr == JTAG_DP_APACC)
+			&& (swjdp->trans_mode == TRANS_MODE_ATOMIC))
 		return swjdp_transaction_endcheck(swjdp);
-	}
 
 	return ERROR_OK;
 }
@@ -214,7 +220,8 @@ int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
 
 #if 0
 	/* Danger!!!! BROKEN!!!! */
-	scan_inout_check_u32(swjdp, DAP_IR_DPACC, DP_CTRL_STAT, DPAP_READ, 0, &ctrlstat);
+	scan_inout_check_u32(swjdp, JTAG_DP_DPACC,
+			DP_CTRL_STAT, DPAP_READ, 0, &ctrlstat);
 	/* Danger!!!! BROKEN!!!! Why will jtag_execute_queue() fail here????
 	R956 introduced the check on return value here and now Michael Schwingen reports
 	that this code no longer works....
@@ -228,7 +235,8 @@ int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
 	/* Why??? second time it works??? */
 #endif
 
-	scan_inout_check_u32(swjdp, DAP_IR_DPACC, DP_CTRL_STAT, DPAP_READ, 0, &ctrlstat);
+	scan_inout_check_u32(swjdp, JTAG_DP_DPACC,
+			DP_CTRL_STAT, DPAP_READ, 0, &ctrlstat);
 	if ((retval = jtag_execute_queue()) != ERROR_OK)
 		return retval;
 
@@ -243,17 +251,24 @@ int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
 			{
 				if ((timeval_ms()-then) > 1000)
 				{
-					LOG_WARNING("Timeout (1000ms) waiting for ACK = OK/FAULT in SWJDP transaction");
+					/* NOTE:  this would be a good spot
+					 * to use JTAG_DP_ABORT.
+					 */
+					LOG_WARNING("Timeout (1000ms) waiting "
+						"for ACK=OK/FAULT "
+						"in JTAG-DP transaction");
 					return ERROR_JTAG_DEVICE_ERROR;
 				}
 			}
 			else
 			{
-				LOG_WARNING("Invalid ACK in SWJDP transaction");
+				LOG_WARNING("Invalid ACK "
+						"in JTAG-DP transaction");
 				return ERROR_JTAG_DEVICE_ERROR;
 			}
 
-			scan_inout_check_u32(swjdp, DAP_IR_DPACC, DP_CTRL_STAT, DPAP_READ, 0, &ctrlstat);
+			scan_inout_check_u32(swjdp, JTAG_DP_DPACC,
+					DP_CTRL_STAT, DPAP_READ, 0, &ctrlstat);
 			if ((retval = jtag_execute_queue()) != ERROR_OK)
 				return retval;
 			swjdp->ack = swjdp->ack & 0x7;
@@ -279,14 +294,19 @@ int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
 			/* Print information about last AHBAP access */
 			LOG_ERROR("AHBAP Cached values: dp_select 0x%" PRIx32 ", ap_csw 0x%" PRIx32 ", ap_tar 0x%" PRIx32 "", swjdp->dp_select_value, swjdp->ap_csw_value, swjdp->ap_tar_value);
 			if (ctrlstat & SSTICKYORUN)
-				LOG_ERROR("SWJ-DP OVERRUN - check clock or reduce jtag speed");
+				LOG_ERROR("JTAG-DP OVERRUN - "
+					"check clock or reduce jtag speed");
 
 			if (ctrlstat & SSTICKYERR)
-				LOG_ERROR("SWJ-DP STICKY ERROR");
+				LOG_ERROR("JTAG-DP STICKY ERROR");
 
 			/* Clear Sticky Error Bits */
-			scan_inout_check_u32(swjdp, DAP_IR_DPACC, DP_CTRL_STAT, DPAP_WRITE, swjdp->dp_ctrl_stat | SSTICKYORUN | SSTICKYERR, NULL);
-			scan_inout_check_u32(swjdp, DAP_IR_DPACC, DP_CTRL_STAT, DPAP_READ, 0, &ctrlstat);
+			scan_inout_check_u32(swjdp, JTAG_DP_DPACC,
+					DP_CTRL_STAT, DPAP_WRITE,
+					swjdp->dp_ctrl_stat | SSTICKYORUN
+						| SSTICKYERR, NULL);
+			scan_inout_check_u32(swjdp, JTAG_DP_DPACC,
+					DP_CTRL_STAT, DPAP_READ, 0, &ctrlstat);
 			if ((retval = jtag_execute_queue()) != ERROR_OK)
 				return retval;
 
@@ -316,13 +336,15 @@ int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
 static int dap_dp_write_reg(struct swjdp_common *swjdp,
 		uint32_t value, uint8_t reg_addr)
 {
-	return scan_inout_check_u32(swjdp, DAP_IR_DPACC, reg_addr, DPAP_WRITE, value, NULL);
+	return scan_inout_check_u32(swjdp, JTAG_DP_DPACC,
+			reg_addr, DPAP_WRITE, value, NULL);
 }
 
 static int dap_dp_read_reg(struct swjdp_common *swjdp,
 		uint32_t *value, uint8_t reg_addr)
 {
-	return scan_inout_check_u32(swjdp, DAP_IR_DPACC, reg_addr, DPAP_READ, 0, value);
+	return scan_inout_check_u32(swjdp, JTAG_DP_DPACC,
+			reg_addr, DPAP_READ, 0, value);
 }
 
 int dap_ap_select(struct swjdp_common *swjdp,uint8_t apsel)
@@ -360,7 +382,8 @@ static int dap_ap_write_reg(struct swjdp_common *swjdp,
 		uint32_t reg_addr, uint8_t *out_value_buf)
 {
 	dap_dp_bankselect(swjdp, reg_addr);
-	scan_inout_check(swjdp, DAP_IR_APACC, reg_addr, DPAP_WRITE, out_value_buf, NULL);
+	scan_inout_check(swjdp, JTAG_DP_APACC, reg_addr,
+			DPAP_WRITE, out_value_buf, NULL);
 
 	return ERROR_OK;
 }
@@ -371,7 +394,8 @@ int dap_ap_write_reg_u32(struct swjdp_common *swjdp, uint32_t reg_addr, uint32_t
 
 	buf_set_u32(out_value_buf, 0, 32, value);
 	dap_dp_bankselect(swjdp, reg_addr);
-	scan_inout_check(swjdp, DAP_IR_APACC, reg_addr, DPAP_WRITE, out_value_buf, NULL);
+	scan_inout_check(swjdp, JTAG_DP_APACC, reg_addr,
+			DPAP_WRITE, out_value_buf, NULL);
 
 	return ERROR_OK;
 }
@@ -379,7 +403,8 @@ int dap_ap_write_reg_u32(struct swjdp_common *swjdp, uint32_t reg_addr, uint32_t
 int dap_ap_read_reg_u32(struct swjdp_common *swjdp, uint32_t reg_addr, uint32_t *value)
 {
 	dap_dp_bankselect(swjdp, reg_addr);
-	scan_inout_check_u32(swjdp, DAP_IR_APACC, reg_addr, DPAP_READ, 0, value);
+	scan_inout_check_u32(swjdp, JTAG_DP_APACC, reg_addr,
+			DPAP_READ, 0, value);
 
 	return ERROR_OK;
 }
@@ -758,15 +783,20 @@ int mem_ap_read_buf_u32(struct swjdp_common *swjdp, uint8_t *buffer, int count,
 		dap_setup_accessport(swjdp, CSW_32BIT | CSW_ADDRINC_SINGLE, address);
 
 		/* Scan out first read */
-		adi_jtag_dp_scan(swjdp, DAP_IR_APACC, AP_REG_DRW, DPAP_READ, 0, NULL, NULL);
+		adi_jtag_dp_scan(swjdp, JTAG_DP_APACC, AP_REG_DRW,
+				DPAP_READ, 0, NULL, NULL);
 		for (readcount = 0; readcount < blocksize - 1; readcount++)
 		{
 			/* Scan out read instruction and scan in previous value */
-			adi_jtag_dp_scan(swjdp, DAP_IR_APACC, AP_REG_DRW, DPAP_READ, 0, buffer + 4 * readcount, &swjdp->ack);
+			adi_jtag_dp_scan(swjdp, JTAG_DP_APACC, AP_REG_DRW,
+					DPAP_READ, 0, buffer + 4 * readcount,
+					&swjdp->ack);
 		}
 
 		/* Scan in last value */
-		adi_jtag_dp_scan(swjdp, DAP_IR_DPACC, DP_RDBUFF, DPAP_READ, 0, buffer + 4 * readcount, &swjdp->ack);
+		adi_jtag_dp_scan(swjdp, JTAG_DP_DPACC, DP_RDBUFF,
+				DPAP_READ, 0, buffer + 4 * readcount,
+				&swjdp->ack);
 		if (swjdp_transaction_endcheck(swjdp) == ERROR_OK)
 		{
 			wcount = wcount - blocksize;
diff --git a/src/target/arm_adi_v5.h b/src/target/arm_adi_v5.h
index bfa5105..4e1b1aa 100644
--- a/src/target/arm_adi_v5.h
+++ b/src/target/arm_adi_v5.h
@@ -32,8 +32,11 @@
 
 #include "arm_jtag.h"
 
-#define DAP_IR_DPACC	0xA
-#define DAP_IR_APACC	0xB
+/* JTAG instructions/registers for JTAG-DP and SWJ-DP */
+#define JTAG_DP_ABORT		0x8
+#define JTAG_DP_DPACC		0xA
+#define JTAG_DP_APACC		0xB
+#define JTAG_DP_IDCODE		0xE
 
 #define DPAP_WRITE		0
 #define DPAP_READ		1

commit 858226aae27b262cb3cb8274c6c7459a0068cc8a
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 2 15:53:18 2010 -0800

    ARM: dap info fix + tweaks
    
    Fix: don't print the BASE address except if it's a MEM-AP;
    that's an unlikely error, but there's no point getting it wrong.
    Tweaks: comments, capitalization.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 19154ce..72a07cd 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -1075,7 +1075,7 @@ is_dap_cid_ok(uint32_t cid3, uint32_t cid2, uint32_t cid1, uint32_t cid0)
 int dap_info_command(struct command_context *cmd_ctx, struct swjdp_common *swjdp, int apsel)
 {
 
-	uint32_t dbgbase,apid;
+	uint32_t dbgbase, apid;
 	int romtable_present = 0;
 	uint8_t mem_ap;
 	uint32_t apselold;
@@ -1087,25 +1087,31 @@ int dap_info_command(struct command_context *cmd_ctx, struct swjdp_common *swjdp
 	swjdp_transaction_endcheck(swjdp);
 	/* Now we read ROM table ID registers, ref. ARM IHI 0029B sec  */
 	mem_ap = ((apid&0x10000) && ((apid&0x0F) != 0));
-	command_print(cmd_ctx, "ap identification register 0x%8.8" PRIx32 "", apid);
+	command_print(cmd_ctx, "AP ID register 0x%8.8" PRIx32, apid);
 	if (apid)
 	{
 		switch (apid&0x0F)
 		{
 			case 0:
-				command_print(cmd_ctx, "\tType is jtag-ap");
+				command_print(cmd_ctx, "\tType is JTAG-AP");
 				break;
 			case 1:
-				command_print(cmd_ctx, "\tType is mem-ap AHB");
+				command_print(cmd_ctx, "\tType is MEM-AP AHB");
 				break;
 			case 2:
-				command_print(cmd_ctx, "\tType is mem-ap APB");
+				command_print(cmd_ctx, "\tType is MEM-AP APB");
 				break;
 			default:
-				command_print(cmd_ctx, "\tUnknown AP-type");
-			break;
+				command_print(cmd_ctx, "\tUnknown AP type");
+				break;
 		}
-		command_print(cmd_ctx, "ap debugbase 0x%8.8" PRIx32 "", dbgbase);
+
+		/* NOTE: a MEM-AP may have a single CoreSight component that's
+		 * not a ROM table ... or have no such components at all.
+		 */
+		if (mem_ap)
+			command_print(cmd_ctx, "AP BASE 0x%8.8" PRIx32,
+					dbgbase);
 	}
 	else
 	{

commit 6105f2bc4a65e1e42a0fb238096cbc0577b994c0
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 2 15:53:06 2010 -0800

    ARM: ADIv5 export cleanup
    
    Make some private functions "static".  Remove their public declarations,
    and what is now an obviously unused function.  Shrinks this object's size
    (about 5% on x86_64) while making the code's scope easier to understand.
    Shrink the affected lines.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 59f5638..19154ce 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -89,7 +89,9 @@ static uint32_t max_tar_block_size(uint32_t tar_autoincr_block, uint32_t address
 ***************************************************************************/
 
 /* Scan out and in from target ordered uint8_t buffers */
-int adi_jtag_dp_scan(struct swjdp_common *swjdp, uint8_t instr, uint8_t reg_addr, uint8_t RnW, uint8_t *outvalue, uint8_t *invalue, uint8_t *ack)
+static int adi_jtag_dp_scan(struct swjdp_common *swjdp,
+		uint8_t instr, uint8_t reg_addr, uint8_t RnW,
+		uint8_t *outvalue, uint8_t *invalue, uint8_t *ack)
 {
 	struct arm_jtag *jtag_info = swjdp->jtag_info;
 	struct scan_field fields[2];
@@ -119,7 +121,9 @@ int adi_jtag_dp_scan(struct swjdp_common *swjdp, uint8_t instr, uint8_t reg_addr
 }
 
 /* Scan out and in from host ordered uint32_t variables */
-int adi_jtag_dp_scan_u32(struct swjdp_common *swjdp, uint8_t instr, uint8_t reg_addr, uint8_t RnW, uint32_t outvalue, uint32_t *invalue, uint8_t *ack)
+static int adi_jtag_dp_scan_u32(struct swjdp_common *swjdp,
+		uint8_t instr, uint8_t reg_addr, uint8_t RnW,
+		uint32_t outvalue, uint32_t *invalue, uint8_t *ack)
 {
 	struct arm_jtag *jtag_info = swjdp->jtag_info;
 	struct scan_field fields[2];
@@ -161,7 +165,9 @@ int adi_jtag_dp_scan_u32(struct swjdp_common *swjdp, uint8_t instr, uint8_t reg_
 }
 
 /* scan_inout_check adds one extra inscan for DPAP_READ commands to read variables */
-int scan_inout_check(struct swjdp_common *swjdp, uint8_t instr, uint8_t reg_addr, uint8_t RnW, uint8_t *outvalue, uint8_t *invalue)
+static int scan_inout_check(struct swjdp_common *swjdp,
+		uint8_t instr, uint8_t reg_addr, uint8_t RnW,
+		uint8_t *outvalue, uint8_t *invalue)
 {
 	adi_jtag_dp_scan(swjdp, instr, reg_addr, RnW, outvalue, NULL, NULL);
 
@@ -179,7 +185,9 @@ int scan_inout_check(struct swjdp_common *swjdp, uint8_t instr, uint8_t reg_addr
 	return ERROR_OK;
 }
 
-int scan_inout_check_u32(struct swjdp_common *swjdp, uint8_t instr, uint8_t reg_addr, uint8_t RnW, uint32_t outvalue, uint32_t *invalue)
+static int scan_inout_check_u32(struct swjdp_common *swjdp,
+		uint8_t instr, uint8_t reg_addr, uint8_t RnW,
+		uint32_t outvalue, uint32_t *invalue)
 {
 	adi_jtag_dp_scan_u32(swjdp, instr, reg_addr, RnW, outvalue, NULL, NULL);
 
@@ -305,12 +313,14 @@ int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
  *                                                                         *
 ***************************************************************************/
 
-int dap_dp_write_reg(struct swjdp_common *swjdp, uint32_t value, uint8_t reg_addr)
+static int dap_dp_write_reg(struct swjdp_common *swjdp,
+		uint32_t value, uint8_t reg_addr)
 {
 	return scan_inout_check_u32(swjdp, DAP_IR_DPACC, reg_addr, DPAP_WRITE, value, NULL);
 }
 
-int dap_dp_read_reg(struct swjdp_common *swjdp, uint32_t *value, uint8_t reg_addr)
+static int dap_dp_read_reg(struct swjdp_common *swjdp,
+		uint32_t *value, uint8_t reg_addr)
 {
 	return scan_inout_check_u32(swjdp, DAP_IR_DPACC, reg_addr, DPAP_READ, 0, value);
 }
@@ -332,7 +342,7 @@ int dap_ap_select(struct swjdp_common *swjdp,uint8_t apsel)
 	return ERROR_OK;
 }
 
-int dap_dp_bankselect(struct swjdp_common *swjdp,uint32_t ap_reg)
+static int dap_dp_bankselect(struct swjdp_common *swjdp, uint32_t ap_reg)
 {
 	uint32_t select;
 	select = (ap_reg & 0x000000F0);
@@ -346,7 +356,8 @@ int dap_dp_bankselect(struct swjdp_common *swjdp,uint32_t ap_reg)
 	return ERROR_OK;
 }
 
-int dap_ap_write_reg(struct swjdp_common *swjdp, uint32_t reg_addr, uint8_t* out_value_buf)
+static int dap_ap_write_reg(struct swjdp_common *swjdp,
+		uint32_t reg_addr, uint8_t *out_value_buf)
 {
 	dap_dp_bankselect(swjdp, reg_addr);
 	scan_inout_check(swjdp, DAP_IR_APACC, reg_addr, DPAP_WRITE, out_value_buf, NULL);
@@ -354,13 +365,6 @@ int dap_ap_write_reg(struct swjdp_common *swjdp, uint32_t reg_addr, uint8_t* out
 	return ERROR_OK;
 }
 
-int dap_ap_read_reg(struct swjdp_common *swjdp, uint32_t reg_addr, uint8_t *in_value_buf)
-{
-	dap_dp_bankselect(swjdp, reg_addr);
-	scan_inout_check(swjdp, DAP_IR_APACC, reg_addr, DPAP_READ, 0, in_value_buf);
-
-	return ERROR_OK;
-}
 int dap_ap_write_reg_u32(struct swjdp_common *swjdp, uint32_t reg_addr, uint32_t value)
 {
 	uint8_t out_value_buf[4];
@@ -534,7 +538,8 @@ int mem_ap_write_buf_u32(struct swjdp_common *swjdp, uint8_t *buffer, int count,
 	return retval;
 }
 
-int mem_ap_write_buf_packed_u16(struct swjdp_common *swjdp, uint8_t *buffer, int count, uint32_t address)
+static int mem_ap_write_buf_packed_u16(struct swjdp_common *swjdp,
+		uint8_t *buffer, int count, uint32_t address)
 {
 	int retval = ERROR_OK;
 	int wcount, blocksize, writecount, i;
@@ -630,7 +635,8 @@ int mem_ap_write_buf_u16(struct swjdp_common *swjdp, uint8_t *buffer, int count,
 	return retval;
 }
 
-int mem_ap_write_buf_packed_u8(struct swjdp_common *swjdp, uint8_t *buffer, int count, uint32_t address)
+static int mem_ap_write_buf_packed_u8(struct swjdp_common *swjdp,
+		uint8_t *buffer, int count, uint32_t address)
 {
 	int retval = ERROR_OK;
 	int wcount, blocksize, writecount, i;
@@ -800,7 +806,8 @@ int mem_ap_read_buf_u32(struct swjdp_common *swjdp, uint8_t *buffer, int count,
 	return retval;
 }
 
-int mem_ap_read_buf_packed_u16(struct swjdp_common *swjdp, uint8_t *buffer, int count, uint32_t address)
+static int mem_ap_read_buf_packed_u16(struct swjdp_common *swjdp,
+		uint8_t *buffer, int count, uint32_t address)
 {
 	uint32_t invalue;
 	int retval = ERROR_OK;
@@ -895,7 +902,8 @@ int mem_ap_read_buf_u16(struct swjdp_common *swjdp, uint8_t *buffer, int count,
  * The solution is to arrange for a large out/in scan in this loop and
  * and convert data afterwards.
  */
-int mem_ap_read_buf_packed_u8(struct swjdp_common *swjdp, uint8_t *buffer, int count, uint32_t address)
+static int mem_ap_read_buf_packed_u8(struct swjdp_common *swjdp,
+		uint8_t *buffer, int count, uint32_t address)
 {
 	uint32_t invalue;
 	int retval = ERROR_OK;
diff --git a/src/target/arm_adi_v5.h b/src/target/arm_adi_v5.h
index 2a09684..bfa5105 100644
--- a/src/target/arm_adi_v5.h
+++ b/src/target/arm_adi_v5.h
@@ -134,20 +134,16 @@ static inline uint8_t dap_ap_get_select(struct swjdp_common *swjdp)
 	return (uint8_t)(swjdp ->apsel >> 24);
 }
 
-/* Internal functions used in the module, partial transactions, use with caution */
-int dap_dp_write_reg(struct swjdp_common *swjdp, uint32_t value, uint8_t reg_addr);
-/* int swjdp_write_apacc(struct swjdp_common *swjdp, uint32_t value, uint8_t reg_addr); */
-int dap_dp_read_reg(struct swjdp_common *swjdp, uint32_t *value, uint8_t reg_addr);
-/* int swjdp_read_apacc(struct swjdp_common *swjdp, uint32_t *value, uint8_t reg_addr); */
-int dap_setup_accessport(struct swjdp_common *swjdp, uint32_t csw, uint32_t tar);
+/* Queued transactions -- use with care */
+int dap_setup_accessport(struct swjdp_common *swjdp,
+		uint32_t csw, uint32_t tar);
 int dap_ap_select(struct swjdp_common *swjdp,uint8_t apsel);
+int dap_ap_write_reg_u32(struct swjdp_common *swjdp,
+		uint32_t addr, uint32_t value);
+int dap_ap_read_reg_u32(struct swjdp_common *swjdp,
+		uint32_t addr, uint32_t *value);
 
-int dap_ap_write_reg(struct swjdp_common *swjdp, uint32_t addr, uint8_t* out_buf);
-int dap_ap_write_reg_u32(struct swjdp_common *swjdp, uint32_t addr, uint32_t value);
-int dap_ap_read_reg(struct swjdp_common *swjdp, uint32_t addr, uint8_t *in_buf);
-int dap_ap_read_reg_u32(struct swjdp_common *swjdp, uint32_t addr, uint32_t *value);
-
-/* External interface, partial operations must be completed with swjdp_transaction_endcheck() */
+/* Queued transactions must be completed with swjdp_transaction_endcheck() */
 int swjdp_transaction_endcheck(struct swjdp_common *swjdp);
 
 /* MEM-AP memory mapped bus single uint32_t register transfers, without endcheck */

commit e60c164cdb50a0aa268165e57de0a4cd0d58fcdf
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 2 15:53:03 2010 -0800

    ARM: ADIv5 symbol and comment cleanup
    
    Instead of magic numbers, use their AP_REG_* constants.  Rename
    the ROM address symbol as BASE to match ARM's documentation.
    
    Comment various other symbols in the header; add some missing ones.
    Remove an unused struct.  Add some doxygen for stuff including the
    DAP structure and initialization.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 6ca50ab..59f5638 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -7,7 +7,7 @@
  *                                                                         *
  *   Copyright (C) 2009 by Oyvind Harboe                                   *
  *   oyvind.harboe at zylin.com                                               *
- *																		   *
+ *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
  *   it under the terms of the GNU General Public License as published by  *
  *   the Free Software Foundation; either version 2 of the License, or     *
@@ -23,16 +23,34 @@
  *   Free Software Foundation, Inc.,                                       *
  *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
  ***************************************************************************/
-/***************************************************************************
- *                                                                         *
- * This file implements support for the ARM Debug Interface v5  (ADI_V5)   *
- *                                                                         *
- * ARM(tm) Debug Interface v5 Architecture Specification    ARM IHI 0031A  *
- *                                                                         *
- * CoreSight(tm) DAP-Lite TRM, ARM DDI 0316D                               *
- * Cortex-M3(tm) TRM, ARM DDI 0337G                                        *
- *                                                                         *
-***************************************************************************/
+
+/**
+ * @file
+ * This file implements support for the ARM Debug Interface version 5 (ADIv5)
+ * debugging architecture.  Compared with previous versions, this includes
+ * a low pin-count Serial Wire Debug (SWD) alternative to JTAG for message
+ * transport, and focusses on memory mapped resources as defined by the
+ * CoreSight architecture.
+ *
+ * A key concept in ADIv5 is the Debug Access Port, or DAP.  A DAP has two
+ * basic components:  a Debug Port (DP) transporting messages to and from a
+ * debugger, and an Access Port (AP) accessing resources.  Three types of DP
+ * are defined.  One uses only JTAG for communication, and is called JTAG-DP.
+ * One uses only SWD for communication, and is called SW-DP.  The third can
+ * use either SWD or JTAG, and is called SWJ-DP.  The most common type of AP
+ * is used to access memory mapped resources and is called a MEM-AP.  Also a
+ * JTAG-AP is also defined, bridging to JTAG resources; those are uncommon.
+ */
+
+/*
+ * Relevant specifications from ARM include:
+ *
+ * ARM(tm) Debug Interface v5 Architecture Specification    ARM IHI 0031A
+ * CoreSight(tm) v1.0 Architecture Specification            ARM IHI 0029B
+ *
+ * CoreSight(tm) DAP-Lite TRM, ARM DDI 0316D
+ * Cortex-M3(tm) TRM, ARM DDI 0337G
+ */
 
 #ifdef HAVE_CONFIG_H
 #include "config.h"
@@ -950,6 +968,13 @@ int mem_ap_read_buf_u8(struct swjdp_common *swjdp, uint8_t *buffer, int count, u
 	return retval;
 }
 
+/**
+ * Initialize a DAP.
+ *
+ * @todo Rename this.  We also need an initialization scheme which account
+ * for SWD transports not just JTAG; that will need to address differences
+ * in layering.  (JTAG is useful without any debug target; but not SWD.)
+ */
 int ahbap_debugport_init(struct swjdp_common *swjdp)
 {
 	uint32_t idreg, romaddr, dummy;
@@ -959,9 +984,17 @@ int ahbap_debugport_init(struct swjdp_common *swjdp)
 
 	LOG_DEBUG(" ");
 
+	/* Default MEM-AP setup.
+	 *
+	 * REVISIT AP #0 may be an inappropriate default for this.
+	 * Should we probe, or receve a hint from the caller?
+	 * Presumably we can ignore the possibility of multiple APs.
+	 */
 	swjdp->apsel = 0;
 	swjdp->ap_csw_value = -1;
 	swjdp->ap_tar_value = -1;
+
+	/* DP initialization */
 	swjdp->trans_mode = TRANS_MODE_ATOMIC;
 	dap_dp_read_reg(swjdp, &dummy, DP_CTRL_STAT);
 	dap_dp_write_reg(swjdp, SSTICKYERR, DP_CTRL_STAT);
@@ -999,8 +1032,14 @@ int ahbap_debugport_init(struct swjdp_common *swjdp)
 	dap_dp_write_reg(swjdp, swjdp->dp_ctrl_stat, DP_CTRL_STAT);
 	dap_dp_read_reg(swjdp, &dummy, DP_CTRL_STAT);
 
-	dap_ap_read_reg_u32(swjdp, 0xFC, &idreg);
-	dap_ap_read_reg_u32(swjdp, 0xF8, &romaddr);
+	/*
+	 * REVISIT this isn't actually *initializing* anything in an AP,
+	 * and doesn't care if it's a MEM-AP at all (much less AHB-AP).
+	 * Should it?  If the ROM address is valid, is this the right
+	 * place to scan the table and do any topology detection?
+	 */
+	dap_ap_read_reg_u32(swjdp, AP_REG_IDR, &idreg);
+	dap_ap_read_reg_u32(swjdp, AP_REG_BASE, &romaddr);
 
 	LOG_DEBUG("AHB-AP ID Register 0x%" PRIx32 ", Debug ROM Address 0x%" PRIx32 "", idreg, romaddr);
 
@@ -1035,8 +1074,8 @@ int dap_info_command(struct command_context *cmd_ctx, struct swjdp_common *swjdp
 
 	apselold = swjdp->apsel;
 	dap_ap_select(swjdp, apsel);
-	dap_ap_read_reg_u32(swjdp, 0xF8, &dbgbase);
-	dap_ap_read_reg_u32(swjdp, 0xFC, &apid);
+	dap_ap_read_reg_u32(swjdp, AP_REG_BASE, &dbgbase);
+	dap_ap_read_reg_u32(swjdp, AP_REG_IDR, &apid);
 	swjdp_transaction_endcheck(swjdp);
 	/* Now we read ROM table ID registers, ref. ARM IHI 0029B sec  */
 	mem_ap = ((apid&0x10000) && ((apid&0x0F) != 0));
@@ -1387,7 +1426,7 @@ DAP_COMMAND_HANDLER(dap_baseaddr_command)
 	if (apselsave != apsel)
 		dap_ap_select(swjdp, apsel);
 
-	dap_ap_read_reg_u32(swjdp, 0xF8, &baseaddr);
+	dap_ap_read_reg_u32(swjdp, AP_REG_BASE, &baseaddr);
 	retval = swjdp_transaction_endcheck(swjdp);
 	command_print(CMD_CTX, "0x%8.8" PRIx32, baseaddr);
 
@@ -1436,7 +1475,7 @@ DAP_COMMAND_HANDLER(dap_apsel_command)
 	}
 
 	dap_ap_select(swjdp, apsel);
-	dap_ap_read_reg_u32(swjdp, 0xFC, &apid);
+	dap_ap_read_reg_u32(swjdp, AP_REG_IDR, &apid);
 	retval = swjdp_transaction_endcheck(swjdp);
 	command_print(CMD_CTX, "ap %" PRIi32 " selected, identification register 0x%8.8" PRIx32,
 			apsel, apid);
@@ -1464,7 +1503,7 @@ DAP_COMMAND_HANDLER(dap_apid_command)
 	if (apselsave != apsel)
 		dap_ap_select(swjdp, apsel);
 
-	dap_ap_read_reg_u32(swjdp, 0xFC, &apid);
+	dap_ap_read_reg_u32(swjdp, AP_REG_IDR, &apid);
 	retval = swjdp_transaction_endcheck(swjdp);
 	command_print(CMD_CTX, "0x%8.8" PRIx32, apid);
 	if (apselsave != apsel)
diff --git a/src/target/arm_adi_v5.h b/src/target/arm_adi_v5.h
index a78193c..2a09684 100644
--- a/src/target/arm_adi_v5.h
+++ b/src/target/arm_adi_v5.h
@@ -23,6 +23,13 @@
 #ifndef ARM_ADI_V5_H
 #define ARM_ADI_V5_H
 
+/**
+ * @file
+ * This defines formats and data structures used to talk to ADIv5 entities.
+ * Those include a DAP, different types of Debug Port (DP), and memory mapped
+ * resources accessed through a MEM-AP.
+ */
+
 #include "arm_jtag.h"
 
 #define DAP_IR_DPACC	0xA
@@ -30,14 +37,22 @@
 
 #define DPAP_WRITE		0
 #define DPAP_READ		1
+
+/* A[3:0] for DP registers (for JTAG, stored in DPACC) */
 #define DP_ZERO			0
 #define DP_CTRL_STAT	0x4
 #define DP_SELECT		0x8
 #define DP_RDBUFF		0xC
 
+/* Fields of the DP's CTRL/STAT register */
 #define CORUNDETECT		(1 << 0)
 #define SSTICKYORUN		(1 << 1)
+/* 3:2 - transaction mode (e.g. pushed compare) */
 #define SSTICKYERR		(1 << 5)
+#define READOK			(1 << 6)
+#define WDATAERR		(1 << 7)
+/* 11:8 - mask lanes for pushed compare or verify ops */
+/* 21:12 - transaction counter */
 #define CDBGRSTREQ		(1 << 26)
 #define CDBGRSTACK		(1 << 27)
 #define CDBGPWRUPREQ	(1 << 28)
@@ -45,26 +60,35 @@
 #define CSYSPWRUPREQ	(1 << 30)
 #define CSYSPWRUPACK	(1 << 31)
 
-#define	AP_REG_CSW		0x00
+/* MEM-AP register addresses */
+/* TODO: rename as MEM_AP_REG_* */
+#define AP_REG_CSW		0x00
 #define AP_REG_TAR		0x04
 #define AP_REG_DRW		0x0C
 #define AP_REG_BD0		0x10
 #define AP_REG_BD1		0x14
 #define AP_REG_BD2		0x18
 #define AP_REG_BD3		0x1C
-#define AP_REG_DBGROMA	0xF8
+#define AP_REG_CFG		0xF4		/* big endian? */
+#define AP_REG_BASE		0xF8
+
+/* Generic AP register address */
 #define AP_REG_IDR		0xFC
 
+/* Fields of the MEM-AP's CSW register */
 #define CSW_8BIT		0
 #define CSW_16BIT		1
 #define CSW_32BIT		2
-
 #define CSW_ADDRINC_MASK	(3 << 4)
 #define CSW_ADDRINC_OFF		0
 #define CSW_ADDRINC_SINGLE	(1 << 4)
 #define CSW_ADDRINC_PACKED	(2 << 4)
-#define CSW_HPROT			(1 << 25)
-#define CSW_MASTER_DEBUG	(1 << 29)
+#define CSW_DEVICE_EN		(1 << 6)
+#define CSW_TRIN_PROG		(1 << 7)
+#define CSW_SPIDEN			(1 << 23)
+/* 30:24 - implementation-defined! */
+#define CSW_HPROT			(1 << 25)		/* ? */
+#define CSW_MASTER_DEBUG	(1 << 29)		/* ? */
 #define CSW_DBGSWENABLE		(1 << 31)
 
 /* transaction mode */
@@ -74,12 +98,14 @@
 /* Freerunning transactions with delays and overrun checking */
 #define TRANS_MODE_COMPOSITE	2
 
-struct swjdp_reg
-{
-	int addr;
-	struct arm_jtag *jtag_info;
-};
-
+/**
+ * This represents an ARM Debug Interface (v5) Debug Access Port (DAP).
+ * A DAP has two types of component:  one Debug Port (DP), which is a
+ * transport agent; and at least one Access Port (AP), controlling
+ * resource access.  Most common is a MEM-AP, for memory access.
+ *
+ * @todo Rename "swjdp_common" as "dap".  Use of SWJ-DP is optional!
+ */
 struct swjdp_common
 {
 	struct arm_jtag *jtag_info;

commit ec88ccc51cb5d8594ae95660c826954f3a9042ec
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 2 15:52:52 2010 -0800

    Cortex-M3: minor breakpoint cleanup
    
    Shrink some lines, add some comments, simplify some tests.
    During debug startup, log the core revision level too.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index 556928f..9685821 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -42,6 +42,9 @@
 
 /* NOTE:  most of this should work fine for the Cortex-M1 and
  * Cortex-M0 cores too, although they're ARMv6-M not ARMv7-M.
+ * Some differences:  M0/M1 doesn't have FBP remapping or the
+ * DWT tracing/profiling support.  (So the cycle counter will
+ * not be usable; the other stuff isn't currently used here.)
  *
  * Although there are some workarounds for errata seen only in r0p0
  * silicon, such old parts are hard to find and thus not much tested
@@ -579,7 +582,7 @@ static void cortex_m3_enable_breakpoints(struct target *target)
 	/* set any pending breakpoints */
 	while (breakpoint)
 	{
-		if (breakpoint->set == 0)
+		if (!breakpoint->set)
 			cortex_m3_set_breakpoint(target, breakpoint);
 		breakpoint = breakpoint->next;
 	}
@@ -936,16 +939,25 @@ cortex_m3_set_breakpoint(struct target *target, struct breakpoint *breakpoint)
 	else if (breakpoint->type == BKPT_SOFT)
 	{
 		uint8_t code[4];
+
+		/* NOTE: on ARMv6-M and ARMv7-M, BKPT(0xab) is used for
+		 * semihosting; don't use that.  Otherwise the BKPT
+		 * parameter is arbitrary.
+		 */
 		buf_set_u32(code, 0, 32, ARMV5_T_BKPT(0x11));
-		if ((retval = target_read_memory(target, breakpoint->address & 0xFFFFFFFE, breakpoint->length, 1, breakpoint->orig_instr)) != ERROR_OK)
-		{
+		retval = target_read_memory(target,
+				breakpoint->address & 0xFFFFFFFE,
+				breakpoint->length, 1,
+				breakpoint->orig_instr);
+		if (retval != ERROR_OK)
 			return retval;
-		}
-		if ((retval = target_write_memory(target, breakpoint->address & 0xFFFFFFFE, breakpoint->length, 1, code)) != ERROR_OK)
-		{
+		retval = target_write_memory(target,
+				breakpoint->address & 0xFFFFFFFE,
+				breakpoint->length, 1,
+				code);
+		if (retval != ERROR_OK)
 			return retval;
-		}
-		breakpoint->set = 0x11; /* Any nice value but 0 */
+		breakpoint->set = true;
 	}
 
 	LOG_DEBUG("BPID: %d, Type: %d, Address: 0x%08" PRIx32 " Length: %d (set=%d)",
@@ -1008,7 +1020,7 @@ cortex_m3_unset_breakpoint(struct target *target, struct breakpoint *breakpoint)
 			}
 		}
 	}
-	breakpoint->set = 0;
+	breakpoint->set = false;
 
 	return ERROR_OK;
 }
@@ -1187,7 +1199,7 @@ cortex_m3_unset_watchpoint(struct target *target, struct watchpoint *watchpoint)
 	target_write_u32(target, comparator->dwt_comparator_address + 8,
 			comparator->function);
 
-	watchpoint->set = 0;
+	watchpoint->set = false;
 
 	return ERROR_OK;
 }
@@ -1273,7 +1285,7 @@ static void cortex_m3_enable_watchpoints(struct target *target)
 	/* set any pending watchpoints */
 	while (watchpoint)
 	{
-		if (watchpoint->set == 0)
+		if (!watchpoint->set)
 			cortex_m3_set_watchpoint(target, watchpoint);
 		watchpoint = watchpoint->next;
 	}
@@ -1647,7 +1659,8 @@ static int cortex_m3_examine(struct target *target)
 			return retval;
 
 		if (((cpuid >> 4) & 0xc3f) == 0xc23)
-			LOG_DEBUG("CORTEX-M3 processor detected");
+			LOG_DEBUG("Cortex-M3 r%dp%d processor detected",
+				(cpuid >> 20) & 0xf, (cpuid >> 0) & 0xf);
 		LOG_DEBUG("cpuid: 0x%8.8" PRIx32 "", cpuid);
 
 		/* NOTE: FPB and DWT are both optional. */

commit b3bf1d12b2fdfba1c1cbee3e1afbfbb27cbd1a26
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 2 15:52:35 2010 -0800

    streamline and document helptext mode displays
    
    Most commands are usable only at runtime; so don't bother saying
    that, it's noise.  Moreover, tokens like EXEC are cryptic.  Be
    more clear: highlight only the commands which may (also) be used
    during the config stage, thus matching the docs more closely.
    There are
    
     - Configuration commands (per documentation)
     - And also some commands that valid at *any* time.
    
    Update the docs to note that "help" now shows this mode info.
    
    This also highlighted a few mistakes in command configuration,
    mostly commands listed as "valid at any time" which shouldn't
    have been.  This just fixes ones I noted when sanity testing.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index cc0edf8..3f5882c 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -1630,9 +1630,14 @@ supported.
 When the OpenOCD server process starts up, it enters a
 @emph{configuration stage} which is the only time that
 certain commands, @emph{configuration commands}, may be issued.
+Normally, configuration commands are only available
+inside startup scripts.
+
 In this manual, the definition of a configuration command is
 presented as a @emph{Config Command}, not as a @emph{Command}
 which may be issued interactively.
+The runtime @command{help} command also highlights configuration
+commands, and those which may be issued at any time.
 
 Those configuration commands include declaration of TAPs,
 flash banks,
@@ -5093,13 +5098,15 @@ port is 5555.
 Exits the current telnet session.
 @end deffn
 
- at c note EXTREMELY ANNOYING word wrap at column 75
- at c even when lines are e.g. 100+ columns ...
- at c coded in startup.tcl
 @deffn {Command} help [string]
 With no parameters, prints help text for all commands.
 Otherwise, prints each helptext containing @var{string}.
 Not every command provides helptext.
+
+Configuration commands, and commands valid at any time, are
+explicitly noted in parenthesis.
+In most cases, no such restriction is listed; this indicates commands
+which are only available after the configuration stage has completed.
 @end deffn
 
 @deffn Command sleep msec [@option{busy}]
diff --git a/src/flash/nor/stellaris.c b/src/flash/nor/stellaris.c
index f414ca6..8d35f9b 100644
--- a/src/flash/nor/stellaris.c
+++ b/src/flash/nor/stellaris.c
@@ -1182,7 +1182,7 @@ static const struct command_registration stellaris_exec_command_handlers[] = {
 static const struct command_registration stellaris_command_handlers[] = {
 	{
 		.name = "stellaris",
-		.mode = COMMAND_ANY,
+		.mode = COMMAND_EXEC,
 		.help = "Stellaris flash command group",
 		.chain = stellaris_exec_command_handlers,
 	},
diff --git a/src/helper/command.c b/src/helper/command.c
index b4e31ea..ab82785 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -914,7 +914,7 @@ static COMMAND_HELPER(command_help_show, struct command *c, unsigned n,
 	bool is_match = (strstr(cmd_name, match) != NULL) ||
 	((c->usage != NULL) && (strstr(c->usage, match) != NULL)) ||
 	((c->help != NULL) && (strstr(c->help, match) != NULL));
-	
+
 	if (is_match)
 	{
 		command_help_show_indent(n);
@@ -934,15 +934,27 @@ static COMMAND_HELPER(command_help_show, struct command *c, unsigned n,
 
 	if (is_match && show_help)
 	{
-		const char *stage_msg;
-		switch (c->mode) {
-		case COMMAND_CONFIG: stage_msg = "CONFIG"; break;
-		case COMMAND_EXEC: stage_msg = "EXEC"; break;
-		case COMMAND_ANY: stage_msg = "CONFIG or EXEC"; break;
-		default: stage_msg = "***UNKNOWN***"; break;
-		}
-		char *msg = alloc_printf("%s%sValid Modes: %s",
-			c->help ? : "", c->help ? "  " : "", stage_msg);
+		char *msg;
+
+		/* Normal commands are runtime-only; highlight exceptions */
+		if (c->mode != COMMAND_EXEC) {
+			const char *stage_msg = "";
+
+			switch (c->mode) {
+			case COMMAND_CONFIG:
+				stage_msg = " (configuration command)";
+				break;
+			case COMMAND_ANY:
+				stage_msg = " (command valid any time)";
+				break;
+			default:
+				stage_msg = " (?mode error?)";
+				break;
+			}
+			msg = alloc_printf("%s%s", c->help ? : "", stage_msg);
+		} else
+			msg = alloc_printf("%s", c->help ? : "");
+
 		if (NULL != msg)
 		{
 			command_help_show_wrap(msg, n + 3, n + 3);
diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index cf62864..d5d7042 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -2272,6 +2272,7 @@ static int gdb_target_start(struct target *target, uint16_t port)
 	return ERROR_OK;
 }
 
+/* FIXME static */
 int gdb_target_add_one(struct target *target)
 {
 	if (gdb_port == 0 && server_use_pipes == 0)
@@ -2420,7 +2421,7 @@ static const struct command_registration gdb_command_handlers[] = {
 	{
 		.name = "gdb_port",
 		.handler = &handle_gdb_port_command,
-		.mode = COMMAND_ANY,
+		.mode = COMMAND_CONFIG,
 		.help = "daemon configuration command gdb_port",
 		.usage = "<port>",
 	},
diff --git a/src/target/armv7m.c b/src/target/armv7m.c
index d4f6309..d0f58de 100644
--- a/src/target/armv7m.c
+++ b/src/target/armv7m.c
@@ -834,7 +834,7 @@ static const struct command_registration armv7m_exec_command_handlers[] = {
 const struct command_registration armv7m_command_handlers[] = {
 	{
 		.name = "dap",
-		.mode = COMMAND_ANY,
+		.mode = COMMAND_EXEC,
 		.help = "Cortex DAP command group",
 		.chain = armv7m_exec_command_handlers,
 	},
diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index edf9b6f..556928f 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -2003,7 +2003,7 @@ static const struct command_registration cortex_m3_command_handlers[] = {
 	},
 	{
 		.name = "cortex_m3",
-		.mode = COMMAND_ANY,
+		.mode = COMMAND_EXEC,
 		.help = "Cortex-M3 command group",
 		.chain = cortex_m3_exec_command_handlers,
 	},
diff --git a/src/target/target.c b/src/target/target.c
index d3d1bee..73a762d 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -4866,7 +4866,7 @@ static const struct command_registration target_exec_command_handlers[] = {
 	{
 		.name = "fast_load",
 		.handler = &handle_fast_load_command,
-		.mode = COMMAND_ANY,
+		.mode = COMMAND_EXEC,
 		.help = "loads active fast load image to current target "
 			"- mainly for profiling purposes",
 	},
diff --git a/src/target/trace.c b/src/target/trace.c
index 99d6bae..56a18a4 100644
--- a/src/target/trace.c
+++ b/src/target/trace.c
@@ -177,7 +177,7 @@ static const struct command_registration trace_exec_command_handlers[] = {
 static const struct command_registration trace_command_handlers[] = {
 	{
 		.name = "trace",
-		.mode = COMMAND_ANY,
+		.mode = COMMAND_EXEC,
 		.help = "trace command group",
 		.chain = trace_exec_command_handlers,
 	},

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi          |   13 ++-
 src/flash/nor/stellaris.c |    2 +-
 src/helper/command.c      |   32 ++++--
 src/server/gdb_server.c   |    3 +-
 src/target/arm_adi_v5.c   |  243 ++++++++++++++++++++++++++++++---------------
 src/target/arm_adi_v5.h   |   75 +++++++++-----
 src/target/armv7m.c       |    2 +-
 src/target/cortex_m3.c    |   39 +++++---
 src/target/target.c       |    2 +-
 src/target/trace.c        |    2 +-
 10 files changed, 277 insertions(+), 136 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sun Jan  3 22:10:38 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sun,  3 Jan 2010 21:10:38 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-39-ge033829
Message-ID: <E1NRXih-0005WN-Nz@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  e0338293b80211aee4254848ea56e0cf38bf3b9a (commit)
       via  d9508b30e096b5cc44a4fdbf2d6b99ca173a43f1 (commit)
      from  4ed5b45097cb2c13f9ef0682848c4682b5fd7240 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit e0338293b80211aee4254848ea56e0cf38bf3b9a
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sun Jan 3 13:07:18 2010 -0800

    JTAG/drivers: cleanup jtag_interface structs
    
    Get rid of excess indents.
    Ditto superfluous "&" before function pointers.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/drivers/arm-jtag-ew.c b/src/jtag/drivers/arm-jtag-ew.c
index 6221011..e54c8c6 100644
--- a/src/jtag/drivers/arm-jtag-ew.c
+++ b/src/jtag/drivers/arm-jtag-ew.c
@@ -513,17 +513,15 @@ static const struct command_registration armjtagew_command_handlers[] = {
 };
 
 struct jtag_interface armjtagew_interface = {
-		.name = "arm-jtag-ew",
-
-		.commands = armjtagew_command_handlers,
-
-		.execute_queue = &armjtagew_execute_queue,
-		.speed = &armjtagew_speed,
-		.khz = &armjtagew_khz,
-
-		.init = &armjtagew_init,
-		.quit = &armjtagew_quit,
-	};
+	.name = "arm-jtag-ew",
+	.commands = armjtagew_command_handlers,
+
+	.execute_queue = armjtagew_execute_queue,
+	.speed = armjtagew_speed,
+	.khz = armjtagew_khz,
+	.init = armjtagew_init,
+	.quit = armjtagew_quit,
+};
 
 /***************************************************************************/
 /* ARM-JTAG-EW tap functions */
diff --git a/src/jtag/drivers/ft2232.c b/src/jtag/drivers/ft2232.c
index 06fc252..a3ac142 100644
--- a/src/jtag/drivers/ft2232.c
+++ b/src/jtag/drivers/ft2232.c
@@ -4018,12 +4018,13 @@ static const struct command_registration ft2232_command_handlers[] = {
 };
 
 struct jtag_interface ft2232_interface = {
-		.name = "ft2232",
-		.commands = ft2232_command_handlers,
-		.init = &ft2232_init,
-		.quit = &ft2232_quit,
-		.speed = &ft2232_speed,
-		.speed_div = &ft2232_speed_div,
-		.khz = &ft2232_khz,
-		.execute_queue = &ft2232_execute_queue,
-	};
+	.name = "ft2232",
+	.commands = ft2232_command_handlers,
+
+	.init = ft2232_init,
+	.quit = ft2232_quit,
+	.speed = ft2232_speed,
+	.speed_div = ft2232_speed_div,
+	.khz = ft2232_khz,
+	.execute_queue = ft2232_execute_queue,
+};
diff --git a/src/jtag/drivers/gw16012.c b/src/jtag/drivers/gw16012.c
index 9083e92..38e5dd7 100644
--- a/src/jtag/drivers/gw16012.c
+++ b/src/jtag/drivers/gw16012.c
@@ -574,10 +574,11 @@ static const struct command_registration gw16012_command_handlers[] = {
 };
 
 struct jtag_interface gw16012_interface = {
-		.name = "gw16012",
-		.commands = gw16012_command_handlers,
-		.init = &gw16012_init,
-		.quit = &gw16012_quit,
-		.speed = &gw16012_speed,
-		.execute_queue = &gw16012_execute_queue,
-	};
+	.name = "gw16012",
+	.commands = gw16012_command_handlers,
+
+	.init = gw16012_init,
+	.quit = gw16012_quit,
+	.speed = gw16012_speed,
+	.execute_queue = gw16012_execute_queue,
+};
diff --git a/src/jtag/drivers/jlink.c b/src/jtag/drivers/jlink.c
index 4ca4349..6596849 100644
--- a/src/jtag/drivers/jlink.c
+++ b/src/jtag/drivers/jlink.c
@@ -645,18 +645,16 @@ static const struct command_registration jlink_command_handlers[] = {
 };
 
 struct jtag_interface jlink_interface = {
-		.name = "jlink",
-
-		.commands = jlink_command_handlers,
-
-		.execute_queue = &jlink_execute_queue,
-		.speed = &jlink_speed,
-		.speed_div = &jlink_speed_div,
-		.khz = &jlink_khz,
-
-		.init = &jlink_init,
-		.quit = &jlink_quit,
-	};
+	.name = "jlink",
+	.commands = jlink_command_handlers,
+
+	.execute_queue = jlink_execute_queue,
+	.speed = jlink_speed,
+	.speed_div = jlink_speed_div,
+	.khz = jlink_khz,
+	.init = jlink_init,
+	.quit = jlink_quit,
+};
 
 /***************************************************************************/
 /* J-Link tap functions */
diff --git a/src/jtag/drivers/parport.c b/src/jtag/drivers/parport.c
index 04ac272..2e6b9ed 100644
--- a/src/jtag/drivers/parport.c
+++ b/src/jtag/drivers/parport.c
@@ -517,16 +517,13 @@ static const struct command_registration parport_command_handlers[] = {
 };
 
 struct jtag_interface parport_interface = {
-		.name = "parport",
-
-		.commands = parport_command_handlers,
-
-		.init = &parport_init,
-		.quit = &parport_quit,
-
-		.khz = &parport_khz,
-		.speed_div = &parport_speed_div,
-		.speed = &parport_speed,
-
-		.execute_queue = &bitbang_execute_queue,
-	};
+	.name = "parport",
+	.commands = parport_command_handlers,
+
+	.init = parport_init,
+	.quit = parport_quit,
+	.khz = parport_khz,
+	.speed_div = parport_speed_div,
+	.speed = parport_speed,
+	.execute_queue = bitbang_execute_queue,
+};
diff --git a/src/jtag/drivers/presto.c b/src/jtag/drivers/presto.c
index fac5e82..0baf561 100644
--- a/src/jtag/drivers/presto.c
+++ b/src/jtag/drivers/presto.c
@@ -786,15 +786,13 @@ static int presto_jtag_quit(void)
 }
 
 struct jtag_interface presto_interface = {
-		.name = "presto",
-
-		.commands = presto_command_handlers,
-
-		.execute_queue = &bitq_execute_queue,
-		.speed = &presto_jtag_speed,
-		.khz = &presto_jtag_khz,
-		.speed_div = &presto_jtag_speed_div,
-
-		.init = &presto_jtag_init,
-		.quit = &presto_jtag_quit,
-	};
+	.name = "presto",
+	.commands = presto_command_handlers,
+
+	.execute_queue = bitq_execute_queue,
+	.speed = presto_jtag_speed,
+	.khz = presto_jtag_khz,
+	.speed_div = presto_jtag_speed_div,
+	.init = presto_jtag_init,
+	.quit = presto_jtag_quit,
+};
diff --git a/src/jtag/drivers/usbprog.c b/src/jtag/drivers/usbprog.c
index f6d8a97..0d51b27 100644
--- a/src/jtag/drivers/usbprog.c
+++ b/src/jtag/drivers/usbprog.c
@@ -652,9 +652,10 @@ static void usbprog_jtag_tms_send(struct usbprog_jtag *usbprog_jtag)
 }
 
 struct jtag_interface usbprog_interface = {
-		.name = "usbprog",
-		.execute_queue = &usbprog_execute_queue,
-		.speed = &usbprog_speed,
-		.init = &usbprog_init,
-		.quit = &usbprog_quit
-	};
+	.name = "usbprog",
+
+	.execute_queue = usbprog_execute_queue,
+	.speed = usbprog_speed,
+	.init = usbprog_init,
+	.quit = usbprog_quit
+};
diff --git a/src/jtag/drivers/vsllink.c b/src/jtag/drivers/vsllink.c
index bbbb5f9..d301290 100644
--- a/src/jtag/drivers/vsllink.c
+++ b/src/jtag/drivers/vsllink.c
@@ -1891,13 +1891,13 @@ static const struct command_registration vsllink_command_handlers[] = {
 };
 
 struct jtag_interface vsllink_interface = {
-		.name = "vsllink",
-		.commands = vsllink_command_handlers,
-
-		.init = &vsllink_init,
-		.quit = &vsllink_quit,
-		.khz = &vsllink_khz,
-		.speed = &vsllink_speed,
-		.speed_div = &vsllink_speed_div,
-		.execute_queue = &vsllink_execute_queue,
-	};
+	.name = "vsllink",
+	.commands = vsllink_command_handlers,
+
+	.init = vsllink_init,
+	.quit = vsllink_quit,
+	.khz = vsllink_khz,
+	.speed = vsllink_speed,
+	.speed_div = vsllink_speed_div,
+	.execute_queue = vsllink_execute_queue,
+};

commit d9508b30e096b5cc44a4fdbf2d6b99ca173a43f1
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sun Jan 3 12:59:51 2010 -0800

    JTAG/drivers: amt_jtagaccel fixes + cleanup
    
    Build fixes:  it failed abysmally with PPDEV enabled.  Swapped
    a build-time error with a FIXME comment in the affected macros.
    
    Cleanup: remove "&" before function pointers, and excess indent,
    for the interface struct declaration.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/drivers/amt_jtagaccel.c b/src/jtag/drivers/amt_jtagaccel.c
index 8ba1583..de7cdcb 100644
--- a/src/jtag/drivers/amt_jtagaccel.c
+++ b/src/jtag/drivers/amt_jtagaccel.c
@@ -55,13 +55,41 @@ static int rtck_enabled = 0;
 #if PARPORT_USE_PPDEV == 1
 static int device_handle;
 
-static int addr_mode = IEEE1284_MODE_EPP | IEEE1284_ADDR ;
-#define AMT_AW(val)	do { ioctl(device_handle, PPSETMODE, &addr_mode); write(device_handle, &val, 1); } while (0)
-#define AMT_AR(val)	do { ioctl(device_handle, PPSETMODE, &addr_mode); read(device_handle, &val, 1); } while (0)
-
-static int data_mode = IEEE1284_MODE_EPP | IEEE1284_DATA ;
-#define AMT_DW(val)	do { ioctl(device_handle, PPSETMODE, &data_mode); write(device_handle, &val, 1); } while (0)
-#define AMT_DR(val)	do { ioctl(device_handle, PPSETMODE, &data_mode); read(device_handle, &val, 1); } while (0)
+static const int addr_mode = IEEE1284_MODE_EPP | IEEE1284_ADDR;
+
+/* FIXME do something sane when these ioctl/read/write calls fail. */
+
+#define AMT_AW(val) \
+	do { \
+		int __retval; \
+		\
+		__retval = ioctl(device_handle, PPSETMODE, &addr_mode); \
+		__retval = write(device_handle, &val, 1); \
+	} while (0)
+#define AMT_AR(val) \
+	do { \
+		int __retval; \
+		\
+		__retval = ioctl(device_handle, PPSETMODE, &addr_mode); \
+		__retval = read(device_handle, &val, 1); \
+	} while (0)
+
+static const int data_mode = IEEE1284_MODE_EPP | IEEE1284_DATA;
+
+#define AMT_DW(val) \
+	do { \
+		int __retval; \
+		\
+		__retval = ioctl(device_handle, PPSETMODE, &data_mode); \
+		__retval = write(device_handle, &val, 1); \
+	} while (0)
+#define AMT_DR(val) \
+	do { \
+		int __retval; \
+		\
+		__retval = ioctl(device_handle, PPSETMODE, &data_mode); \
+		__retval = read(device_handle, &val, 1); \
+	} while (0)
 
 #else
 
@@ -559,10 +587,11 @@ static const struct command_registration amtjtagaccel_command_handlers[] = {
 };
 
 struct jtag_interface amt_jtagaccel_interface = {
-		.name = "amt_jtagaccel",
-		.commands = amtjtagaccel_command_handlers,
-		.init = &amt_jtagaccel_init,
-		.quit = &amt_jtagaccel_quit,
-		.speed = &amt_jtagaccel_speed,
-		.execute_queue = &amt_jtagaccel_execute_queue,
-	};
+	.name = "amt_jtagaccel",
+	.commands = amtjtagaccel_command_handlers,
+
+	.init = amt_jtagaccel_init,
+	.quit = amt_jtagaccel_quit,
+	.speed = amt_jtagaccel_speed,
+	.execute_queue = amt_jtagaccel_execute_queue,
+};

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/drivers/amt_jtagaccel.c |   57 ++++++++++++++++++++++++++++---------
 src/jtag/drivers/arm-jtag-ew.c   |   20 ++++++-------
 src/jtag/drivers/ft2232.c        |   19 ++++++------
 src/jtag/drivers/gw16012.c       |   15 +++++----
 src/jtag/drivers/jlink.c         |   22 ++++++--------
 src/jtag/drivers/parport.c       |   23 ++++++--------
 src/jtag/drivers/presto.c        |   22 ++++++--------
 src/jtag/drivers/usbprog.c       |   13 ++++----
 src/jtag/drivers/vsllink.c       |   20 ++++++------
 9 files changed, 117 insertions(+), 94 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sun Jan  3 22:33:03 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sun,  3 Jan 2010 21:33:03 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-40-g4aedb02
Message-ID: <E1NRY4O-0006Lm-Pq@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  4aedb02fcd4a16d77caeab8f6a3cf505ce9a93bf (commit)
      from  e0338293b80211aee4254848ea56e0cf38bf3b9a (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 4aedb02fcd4a16d77caeab8f6a3cf505ce9a93bf
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sun Jan 3 13:30:06 2010 -0800

    JTAG: Amontec JTAG accelerater "rtck" is back
    
    The command processing conversion a while back lost the
    "rtck" enable/disable command; restore it.
    
    NOTE that having such a command is wrong; there's a standard
    way to enable adaptive clocking ("speed 0").
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/drivers/amt_jtagaccel.c b/src/jtag/drivers/amt_jtagaccel.c
index de7cdcb..974761e 100644
--- a/src/jtag/drivers/amt_jtagaccel.c
+++ b/src/jtag/drivers/amt_jtagaccel.c
@@ -577,7 +577,7 @@ static const struct command_registration amtjtagaccel_command_handlers[] = {
 		.usage = "<port_num>",
 	},
 	{
-		.name = "parport_port",
+		.name = "rtck",
 		.handler = &amt_jtagaccel_handle_rtck_command,
 		.mode = COMMAND_CONFIG,
 		.help = "enable RTCK",

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/drivers/amt_jtagaccel.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Mon Jan  4 00:15:12 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sun,  3 Jan 2010 23:15:12 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-43-g237a707
Message-ID: <E1NRZfG-0004gA-UO@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  237a707f9653d7ca8a1ec550b497e9a8d0ce0311 (commit)
       via  e1258c703bf9e6a0868f4d9e939c4be77567c53e (commit)
       via  50fb3a512931586cc689ac8c36fb3b6832dc0c5a (commit)
      from  4aedb02fcd4a16d77caeab8f6a3cf505ce9a93bf (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 237a707f9653d7ca8a1ec550b497e9a8d0ce0311
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sun Jan 3 15:02:51 2010 -0800

    FT2232: fix doc typo
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/drivers/ft2232.c b/src/jtag/drivers/ft2232.c
index e9eba54..82132d3 100644
--- a/src/jtag/drivers/ft2232.c
+++ b/src/jtag/drivers/ft2232.c
@@ -33,7 +33,7 @@
  * popular low cost JTAG debug solutions.  Many FT2232 based JTAG adapters
  * are discrete, but development boards may integrate them as alternatives
  * to more capable (and expensive) third party JTAG pods.  Since JTAG uses
- * only one of the two parts on these devices, on integrated boards the
+ * only one of the two ports on these devices, on integrated boards the
  * second port often serves as a USB-to-serial adapter for the target's
  * console UART even when the JTAG port is not in use.  (Systems which
  * support ARM's SWD in addition to JTAG, or instead of it, may use that

commit e1258c703bf9e6a0868f4d9e939c4be77567c53e
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sun Jan 3 14:54:52 2010 -0800

    JTAG/drivers: ft2232 docs
    
    Add doxyegen description for this driver.
    
    Correct the helptext (configures *or* displays based on #params),
    and usage (use the same BNF as the User's Guide).
    
    Remove superfluous #include
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/drivers/ft2232.c b/src/jtag/drivers/ft2232.c
index a3ac142..e9eba54 100644
--- a/src/jtag/drivers/ft2232.c
+++ b/src/jtag/drivers/ft2232.c
@@ -27,13 +27,40 @@
 *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
 ***************************************************************************/
 
-/* This code uses information contained in the MPSSE specification which was
+/**
+ * @file
+ * JTAG adapters based on the FT2232 full and high speed USB parts are
+ * popular low cost JTAG debug solutions.  Many FT2232 based JTAG adapters
+ * are discrete, but development boards may integrate them as alternatives
+ * to more capable (and expensive) third party JTAG pods.  Since JTAG uses
+ * only one of the two parts on these devices, on integrated boards the
+ * second port often serves as a USB-to-serial adapter for the target's
+ * console UART even when the JTAG port is not in use.  (Systems which
+ * support ARM's SWD in addition to JTAG, or instead of it, may use that
+ * second port for reading SWV trace data.)
+ *
+ * FT2232 based JTAG adapters are "dumb" not "smart", because most JTAG
+ * request/response interactions involve round trips over the USB link.
+ * A "smart" JTAG adapter has intelligence close to the scan chain, so it
+ * can for example poll quickly for a status change (usually taking on the
+ * order of microseconds not milliseconds) before beginning a queued
+ * transaction which require the previous one to have completed.
+ *
+ * There are dozens of adapters of this type, differing in details which
+ * this driver needs to understand.  Those "layout" details are required
+ * as part of FT2232 driver configuration.
+ *
+ * This code uses information contained in the MPSSE specification which was
  * found here:
  * http://www.ftdichip.com/Documents/AppNotes/AN2232C-01_MPSSE_Cmnd.pdf
  * Hereafter this is called the "MPSSE Spec".
  *
  * The datasheet for the ftdichip.com's FT2232D part is here:
  * http://www.ftdichip.com/Documents/DataSheets/DS_FT2232D.pdf
+ *
+ * Also note the issue with code 0x4b (clock data to TMS) noted in
+ * http://developer.intra2net.com/mailarchive/html/libftdi/2009/msg00292.html
+ * which can affect longer JTAG state paths.
  */
 
 #ifdef HAVE_CONFIG_H
@@ -42,7 +69,6 @@
 
 /* project specific includes */
 #include <jtag/interface.h>
-#include <jtag/commands.h>
 #include <helper/time_support.h>
 
 #if IS_CYGWIN == 1
@@ -3983,14 +4009,14 @@ static const struct command_registration ft2232_command_handlers[] = {
 		.handler = &ft2232_handle_device_desc_command,
 		.mode = COMMAND_CONFIG,
 		.help = "set the USB device description of the FTDI FT2232 device",
-		.usage = "<description>",
+		.usage = "description_string",
 	},
 	{
 		.name = "ft2232_serial",
 		.handler = &ft2232_handle_serial_command,
 		.mode = COMMAND_CONFIG,
 		.help = "set the serial number of the FTDI FT2232 device",
-		.usage = "<serial#>",
+		.usage = "serial_string",
 	},
 	{
 		.name = "ft2232_layout",
@@ -3998,21 +4024,21 @@ static const struct command_registration ft2232_command_handlers[] = {
 		.mode = COMMAND_CONFIG,
 		.help = "set the layout of the FT2232 GPIO signals used "
 			"to control output-enables and reset signals",
-		.usage = "<layout>",
+		.usage = "layout_name",
 	},
 	{
 		.name = "ft2232_vid_pid",
 		.handler = &ft2232_handle_vid_pid_command,
 		.mode = COMMAND_CONFIG,
 		.help = "the vendor ID and product ID of the FTDI FT2232 device",
-		.usage = "<vid> <pid> [...]",
+		.usage = "(vid pid)* ",
 	},
 	{
 		.name = "ft2232_latency",
 		.handler = &ft2232_handle_latency_command,
 		.mode = COMMAND_CONFIG,
 		.help = "set the FT2232 latency timer to a new value",
-		.usage = "<vid> <pid> [...]",
+		.usage = "value",
 	},
 	COMMAND_REGISTRATION_DONE
 };

commit 50fb3a512931586cc689ac8c36fb3b6832dc0c5a
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sun Jan 3 14:51:01 2010 -0800

    JTAG/Drivers: Amontec JTAG accelerator fixes
    
    Remove superfluous #include.
    
    Correct the helptext (configures *or* displays based on #params),
    and usage (use the same BNF as the User's Guide).
    
    Add doxygen -- file-level description and a @todo for doing
    RTCK correctly.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/drivers/amt_jtagaccel.c b/src/jtag/drivers/amt_jtagaccel.c
index 974761e..121649b 100644
--- a/src/jtag/drivers/amt_jtagaccel.c
+++ b/src/jtag/drivers/amt_jtagaccel.c
@@ -22,8 +22,6 @@
 #endif
 
 #include <jtag/interface.h>
-#include <jtag/commands.h>
-
 
 #if PARPORT_USE_PPDEV == 1
 #include <linux/parport.h>
@@ -41,6 +39,15 @@
 #endif
 #endif
 
+/**
+ * @file
+ * Support the Amontec Chameleon POD with JTAG Accelerator support.
+ * This is a parallel port JTAG adapter with a CPLD between the
+ * parallel port and the JTAG connection.  VHDL code running in the
+ * CPLD significantly accelerates JTAG operations compared to the
+ * bitbanging "Wiggler" style of most parallel port adapters.
+ */
+
 /* configuration */
 static uint16_t amt_jtagaccel_port;
 
@@ -573,15 +580,21 @@ static const struct command_registration amtjtagaccel_command_handlers[] = {
 		.name = "parport_port",
 		.handler = &amt_jtagaccel_handle_parport_port_command,
 		.mode = COMMAND_CONFIG,
-		.help = "configure the parallel port to use",
-		.usage = "<port_num>",
+		.help = "configure or display the parallel port to use",
+		.usage = "[port_num]",
 	},
 	{
+		/**
+		 * @todo Remove this "rtck" command; just use the standard
+		 * mechanism to enable/disable adaptive clocking.  First
+		 * implement the standard mechanism and deprecate "rtck";
+		 * after a year or so, it'll be safe to remove this.
+		 */
 		.name = "rtck",
 		.handler = &amt_jtagaccel_handle_rtck_command,
 		.mode = COMMAND_CONFIG,
-		.help = "enable RTCK",
-		.usage = "<enable|disable>",
+		.help = "configure or display RTCK support",
+		.usage = "[enable|disable]",
 	},
 	COMMAND_REGISTRATION_DONE
 };

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/drivers/amt_jtagaccel.c |   25 ++++++++++++++++++-----
 src/jtag/drivers/ft2232.c        |   40 +++++++++++++++++++++++++++++++------
 2 files changed, 52 insertions(+), 13 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Tue Jan  5 10:54:17 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Tue,  5 Jan 2010 09:54:17 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-45-g6d4abe9
Message-ID: <E1NS67H-00027g-R0@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  6d4abe906fe4b3f3a70f8ccfa356f8c0ebbfabad (commit)
       via  1b3f15d51ee3388e18edb06201f5c6c8b75c3361 (commit)
      from  237a707f9653d7ca8a1ec550b497e9a8d0ce0311 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 6d4abe906fe4b3f3a70f8ccfa356f8c0ebbfabad
Author: Johannes Stezenbach <js at sig21.net>
Date:   Mon Jan 4 16:08:10 2010 +0100

    update udev rules for new udev version
    
    New versions of udev (148+) emit the following warnings:
    
    udevd[425]: BUS= will be removed in a future udev version,
      please use SUBSYSTEM= to match the event device, or
      SUBSYSTEMS= to match a parent device, in /lib/udev/rules.d/60-openocd.rules:1
    udevd[425]: SYSFS{}= will be removed in a future udev version,
      please use ATTR{}= to match the event device, or
      ATTRS{}= to match a parent device, in /lib/udev/rules.d/60-openocd.rules:4
    udevd[425]: SYSFS{}= will be removed in a future udev version,
      please use ATTR{}= to match the event device, or
      ATTRS{}= to match a parent device, in /lib/udev/rules.d/60-openocd.rules:7
    ...
    
    See also http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=560141
    
    [dbrownell at users.sourceforge.net: add IDs for Stellaris ICDI, Olimex Tiny-H]
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/contrib/openocd.udev b/contrib/openocd.udev
index c878975..bcec6af 100644
--- a/contrib/openocd.udev
+++ b/contrib/openocd.udev
@@ -1,60 +1,68 @@
-BUS!="usb", ACTION!="add", SUBSYSTEM!=="usb_device", GOTO="openocd_rules_end"
+ACTION!="add|change", GOTO="openocd_rules_end"
+SUBSYSTEM!="usb", GOTO="openocd_rules_end"
+ENV{DEVTYPE}!="usb_device", GOTO="openocd_rules_end"
 
 # Olimex ARM-USB-OCD
-SYSFS{idVendor}=="15ba", SYSFS{idProduct}=="0003", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="15ba", ATTRS{idProduct}=="0003", MODE="664", GROUP="plugdev"
 
 # Olimex ARM-USB-OCD-TINY
-SYSFS{idVendor}=="15ba", SYSFS{idProduct}=="0004", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="15ba", ATTRS{idProduct}=="0004", MODE="664", GROUP="plugdev"
 
 # Olimex ARM-JTAG-EW
-SYSFS{idVendor}=="15ba", SYSFS{idProduct}=="001e", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="15ba", ATTRS{idProduct}=="001e", MODE="664", GROUP="plugdev"
+
+# Olimex ARM-USB-OCD-TINY-H
+ATTRS{idVendor}=="15ba", ATTRS{idProduct}=="002a", MODE="664", GROUP="plugdev"
 
 # USBprog with OpenOCD firmware
-SYSFS{idVendor}=="1781", SYSFS{idProduct}=="0c63", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="1781", ATTRS{idProduct}=="0c63", MODE="664", GROUP="plugdev"
 
 # Amontec JTAGkey and JTAGkey-tiny
-SYSFS{idVendor}=="0403", SYSFS{idProduct}=="cff8", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="0403", ATTRS{idProduct}=="cff8", MODE="664", GROUP="plugdev"
 
 # Amontec JTAGkey-HiSpeed
-SYSFS{idVendor}=="0fbb", SYSFS{idProduct}=="1000", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="0fbb", ATTRS{idProduct}=="1000", MODE="664", GROUP="plugdev"
 
 # Axiom AXM-0432 Link (Symphony SoundBite?)
 # Calao Systems USB-A9260-C01
 # TinCanTools Flyswatter
 # OOCD-Link
 # Marvell Sheevaplug (early development versions)
-SYSFS{idVendor}=="0403", SYSFS{idProduct}=="6010", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="0403", ATTRS{idProduct}=="6010", MODE="664", GROUP="plugdev"
 
 # Calao Systems USB-A9260-C02
-SYSFS{idVendor}=="0403", SYSFS{idProduct}=="6001", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="0403", ATTRS{idProduct}=="6001", MODE="664", GROUP="plugdev"
 
 # IAR J-Link USB
-SYSFS{idVendor}=="1366", SYSFS{idProduct}=="0101", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="1366", ATTRS{idProduct}=="0101", MODE="664", GROUP="plugdev"
 
 # Raisonance RLink
-SYSFS{idVendor}=="138e", SYSFS{idProduct}=="9000", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="138e", ATTRS{idProduct}=="9000", MODE="664", GROUP="plugdev"
 
 # Hitex STR9-comStick
-SYSFS{idVendor}=="0640", SYSFS{idProduct}=="002c", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="0640", ATTRS{idProduct}=="002c", MODE="664", GROUP="plugdev"
 
 # Hitex STM32-PerformanceStick
-SYSFS{idVendor}=="0640", SYSFS{idProduct}=="002d", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="0640", ATTRS{idProduct}=="002d", MODE="664", GROUP="plugdev"
+
+# TI/Luminary Stellaris Evaluation Board (several)
+ATTRS{idVendor}=="0403", ATTRS{idProduct}=="bcd9", MODE="664", GROUP="plugdev"
 
-# Luminary Micro Stellaris/LM3S811
-SYSFS{idVendor}=="0403", SYSFS{idProduct}=="bcd9", MODE="664", GROUP="plugdev"
+# TI/Luminary Stellaris In-Circuit Debug Interface (ICDI) Board
+ATTRS{idVendor}=="0403", ATTRS{idProduct}=="bcda", MODE="664", GROUP="plugdev"
 
 # Xverve Signalyzer Tool (DT-USB-ST)
-SYSFS{idVendor}=="0403", SYSFS{idProduct}=="bca0", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="0403", ATTRS{idProduct}=="bca0", MODE="664", GROUP="plugdev"
 
 # egnite Turtelizer 2
-SYSFS{idVendor}=="0403", SYSFS{idProduct}=="bdc8", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="0403", ATTRS{idProduct}=="bdc8", MODE="664", GROUP="plugdev"
 
 # Marvell Sheevaplug
-SYSFS{idVendor}=="9e88", SYSFS{idProduct}=="9e8f", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="9e88", ATTRS{idProduct}=="9e8f", MODE="664", GROUP="plugdev"
 
 # Section5 ICEbear
-SYSFS{idVendor}=="0403", SYSFS{idProduct}=="c140", MODE="664", GROUP="plugdev"
-SYSFS{idVendor}=="0403", SYSFS{idProduct}=="c141", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="0403", ATTRS{idProduct}=="c140", MODE="664", GROUP="plugdev"
+ATTRS{idVendor}=="0403", ATTRS{idProduct}=="c141", MODE="664", GROUP="plugdev"
 
 LABEL="openocd_rules_end"
 

commit 1b3f15d51ee3388e18edb06201f5c6c8b75c3361
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Mon Jan 4 22:11:34 2010 -0800

    ARMv7-M:  use AP_REG_* symbol
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/armv7m.c b/src/target/armv7m.c
index d0f58de..9d8132d 100644
--- a/src/target/armv7m.c
+++ b/src/target/armv7m.c
@@ -731,7 +731,12 @@ COMMAND_HANDLER(handle_dap_baseaddr_command)
 	if (apselsave != apsel)
 		dap_ap_select(swjdp, apsel);
 
-	dap_ap_read_reg_u32(swjdp, 0xF8, &baseaddr);
+	/* NOTE:  assumes we're talking to a MEM-AP, which
+	 * has a base address.  There are other kinds of AP,
+	 * though they're not common for now.  This should
+	 * use the ID register to verify it's a MEM-AP.
+	 */
+	dap_ap_read_reg_u32(swjdp, AP_REG_BASE, &baseaddr);
 	retval = swjdp_transaction_endcheck(swjdp);
 	command_print(CMD_CTX, "0x%8.8" PRIx32 "", baseaddr);
 

-----------------------------------------------------------------------

Summary of changes:
 contrib/openocd.udev |   48 ++++++++++++++++++++++++++++--------------------
 src/target/armv7m.c  |    7 ++++++-
 2 files changed, 34 insertions(+), 21 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Jan  5 20:25:08 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Tue,  5 Jan 2010 19:25:08 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-46-g95f86e8
Message-ID: <E1NSF1j-0001xz-0H@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  95f86e8e0525fc93093cc2bc060df5017d2f504e (commit)
      from  6d4abe906fe4b3f3a70f8ccfa356f8c0ebbfabad (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 95f86e8e0525fc93093cc2bc060df5017d2f504e
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Tue Jan 5 14:57:45 2010 +0100

    gdb: fix regression in gdb_port command
    
    The gdb_port command can be invoked during normal execution
    to report the port used for gdb, whereas it was listed as
    CONFIG stage only, which caused an error when excuting
    it to return the reported error.
    
    Also in line with the grander goal of making more commands
    available during all "modes" (perhaps retiring config mode),
    there is no particular reason to limit gdb_port to the
    config stage.
    
    Regression was introduced in:
    
    b3bf1d12b2fdfba1c1cbee3e1afbfbb27cbd1a26 aka
    v0.4.0-rc1-32-gb3bf1d1
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index d5d7042..96b9dbf 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -2421,8 +2421,9 @@ static const struct command_registration gdb_command_handlers[] = {
 	{
 		.name = "gdb_port",
 		.handler = &handle_gdb_port_command,
-		.mode = COMMAND_CONFIG,
-		.help = "daemon configuration command gdb_port",
+		.mode = COMMAND_ANY,
+		.help = "daemon configuration command gdb_port. No arguments reports "
+				"GDB port.",
 		.usage = "<port>",
 	},
 	{

-----------------------------------------------------------------------

Summary of changes:
 src/server/gdb_server.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Tue Jan  5 20:55:30 2010
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Tue,  5 Jan 2010 19:55:30 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-51-g9d83df7
Message-ID: <E1NSFV5-00058W-Rz@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  9d83df72dcbfc791b470b12949890df3f2d1508d (commit)
       via  ba96fc3e9de935708cd5fa7c38e547dc7598087d (commit)
       via  f6412d9c7b22ab25caec6be19317f0fc4a840fdd (commit)
       via  faad9e59233306e608a3a01388a38099ece9688b (commit)
       via  03e8649bc699053ccdbbd4a3c2eaf05241e22a5b (commit)
      from  95f86e8e0525fc93093cc2bc060df5017d2f504e (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 9d83df72dcbfc791b470b12949890df3f2d1508d
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Tue Jan 5 17:43:29 2010 +0000

    MIPS: pracc access tweaks
    
    reorder the pracc access so we can save a few access cycles
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/src/target/mips32_pracc.c b/src/target/mips32_pracc.c
index 4bd1da7..26d5a6b 100644
--- a/src/target/mips32_pracc.c
+++ b/src/target/mips32_pracc.c
@@ -319,9 +319,8 @@ int mips32_pracc_read_mem32(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_B(NEG16(27)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_B(NEG16(28)),								/* b start */
-		MIPS32_NOP,
 	};
 
 	int retval = ERROR_OK;
@@ -422,9 +421,8 @@ int mips32_pracc_read_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
-		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_B(NEG16(28)),								/* b start */
-		MIPS32_NOP,
+		MIPS32_B(NEG16(27)),								/* b start */
+		MIPS32_MFC0(15,30,0),								/* move COP0 DeSave to $15 */
 	};
 
 	/* TODO remove array */
@@ -500,9 +498,8 @@ int mips32_pracc_read_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int cou
 		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_B(NEG16(27)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_B(NEG16(28)),								/* b start */
-		MIPS32_NOP,
 	};
 
 	/* TODO remove array */
@@ -677,9 +674,8 @@ int mips32_pracc_write_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int c
 		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_B(NEG16(26)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_B(NEG16(27)),								/* b start */
-		MIPS32_NOP,
 	};
 
 	/* TODO remove array */
@@ -736,9 +732,8 @@ int mips32_pracc_write_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_B(NEG16(26)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_B(NEG16(27)),								/* b start */
-		MIPS32_NOP,
 	};
 
 	/* TODO remove array */
@@ -819,9 +814,8 @@ int mips32_pracc_write_regs(struct mips_ejtag *ejtag_info, uint32_t *regs)
 
 		MIPS32_LW(2,2*4,1), 							/* lw $2,2*4($1) */
 		MIPS32_LW(1,0,15), 								/* lw $1,($15) */
+		MIPS32_B(NEG16(53)),							/* b start */
 		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-		MIPS32_B(NEG16(54)),							/* b start */
-		MIPS32_NOP,
 	};
 
 	int retval;
@@ -895,9 +889,8 @@ int mips32_pracc_read_regs(struct mips_ejtag *ejtag_info, uint32_t *regs)
 
 		MIPS32_LW(2,0,15), 								/* lw $2,($15) */
 		MIPS32_LW(1,0,15), 								/* lw $1,($15) */
+		MIPS32_B(NEG16(58)),							/* b start */
 		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-		MIPS32_B(NEG16(59)),							/* b start */
-		MIPS32_NOP,
 	};
 
 	int retval;

commit ba96fc3e9de935708cd5fa7c38e547dc7598087d
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Mon Dec 21 17:23:09 2009 +0000

    PIC32: enable ram execution
    
    add reset-init script to allow ram execution from reset, this is required for ejtag fastdata access.
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/tcl/target/pic32mx.cfg b/tcl/target/pic32mx.cfg
index e0ebdc2..1561d73 100644
--- a/tcl/target/pic32mx.cfg
+++ b/tcl/target/pic32mx.cfg
@@ -31,7 +31,23 @@ jtag newtap $_CHIPNAME cpu -irlen 5  -ircapture 0x1 -irmask 0x1f -expected-id $_
 set _TARGETNAME $_CHIPNAME.cpu
 target create $_TARGETNAME mips_m4k -endian $_ENDIAN -chain-position $_TARGETNAME
 
-$_TARGETNAME configure -work-area-phys 0xa0000000 -work-area-size 16384 -work-area-backup 0
+$_TARGETNAME configure -work-area-phys 0xa0000800 -work-area-size 16384 -work-area-backup 0
+
+$_TARGETNAME configure -event reset-init {
+	#
+	# from reset the pic32 cannot execute code in ram - enable ram execution
+	# minimum offset from start of ram is 2k
+	#
+
+	# BMXCON
+	mww 0xbf882000 0x001f0040
+	# BMXDKPBA: 0xa0000800
+	mww 0xbf882010 0x00000800
+	# BMXDUDBA
+	mww 0xbf882020 0x00004000
+	# BMXDUPBA
+	mww 0xbf882030 0x00004000
+}
 
 set _FLASHNAME $_CHIPNAME.flash
 flash bank $_FLASHNAME pic32mx 0xbd000000 0 0 0 $_TARGETNAME

commit f6412d9c7b22ab25caec6be19317f0fc4a840fdd
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Mon Dec 21 16:33:03 2009 +0000

    MIPS: optimize pracc access
    
    remove unnecessary nops when accessing ejtag pracc
    general fastdata patch cleanup
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/src/target/mips32_pracc.c b/src/target/mips32_pracc.c
index 34794f3..4bd1da7 100644
--- a/src/target/mips32_pracc.c
+++ b/src/target/mips32_pracc.c
@@ -33,7 +33,6 @@ instruction after a branch instruction (one delay slot).
 
 For example:
 
-
     LW $2, ($5 +10)
     B foo
     LW $1, ($2 +100)
@@ -129,7 +128,7 @@ static int mips32_pracc_exec_read(struct mips32_pracc_context *ctx, uint32_t add
 		data = ctx->local_oparam[offset];
 	}
 	else if ((address >= MIPS32_PRACC_TEXT)
-		&& (address <= MIPS32_PRACC_TEXT + ctx->code_len*4))
+		&& (address <= MIPS32_PRACC_TEXT + ctx->code_len * 4))
 	{
 		offset = (address - MIPS32_PRACC_TEXT) / 4;
 		data = ctx->code[offset];
@@ -145,7 +144,7 @@ static int mips32_pracc_exec_read(struct mips32_pracc_context *ctx, uint32_t add
 		 * to start of debug vector */
 
 		data = 0;
-		LOG_ERROR("Error reading unexpected address %8.8" PRIx32 "", address);
+		LOG_ERROR("Error reading unexpected address 0x%8.8" PRIx32 "", address);
 		return ERROR_JTAG_DEVICE_ERROR;
 	}
 
@@ -154,7 +153,6 @@ static int mips32_pracc_exec_read(struct mips32_pracc_context *ctx, uint32_t add
 	mips_ejtag_drscan_32(ctx->ejtag_info, &data);
 
 	/* Clear the access pending bit (let the processor eat!) */
-
 	ejtag_ctrl = ejtag_info->ejtag_ctrl & ~EJTAG_CTRL_PRACC;
 	mips_ejtag_set_instr(ctx->ejtag_info, EJTAG_INST_CONTROL, NULL);
 	mips_ejtag_drscan_32(ctx->ejtag_info, &ejtag_ctrl);
@@ -201,7 +199,7 @@ static int mips32_pracc_exec_write(struct mips32_pracc_context *ctx, uint32_t ad
 	}
 	else
 	{
-		LOG_ERROR("Error writing unexpected address %8.8" PRIx32 "", address);
+		LOG_ERROR("Error writing unexpected address 0x%8.8" PRIx32 "", address);
 		return ERROR_JTAG_DEVICE_ERROR;
 	}
 
@@ -234,8 +232,6 @@ int mips32_pracc_exec(struct mips_ejtag *ejtag_info, int code_len, const uint32_
 		mips_ejtag_set_instr(ejtag_info, EJTAG_INST_ADDRESS, NULL);
 		mips_ejtag_drscan_32(ejtag_info, &address);
 
-//		printf("Adres: %.8x\n", address);
-
 		/* Check for read or write */
 		if (ejtag_ctrl & EJTAG_CTRL_PRNW)
 		{
@@ -305,9 +301,8 @@ int mips32_pracc_read_mem32(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(10,4,8),									/* $10 = mem[$8 + 4]; read count */
 		MIPS32_LUI(11,UPPER16(MIPS32_PRACC_PARAM_OUT)), 	/* $11 = MIPS32_PRACC_PARAM_OUT */
 		MIPS32_ORI(11,11,LOWER16(MIPS32_PRACC_PARAM_OUT)),
-		MIPS32_NOP,
 															/* loop: */
-		MIPS32_BEQ(0,10,9),									/* beq 0, $10, end */
+		MIPS32_BEQ(0,10,8),									/* beq 0, $10, end */
 		MIPS32_NOP,
 
 		MIPS32_LW(8,0,9), 									/* lw $8,0($9), Load $8 with the word @mem[$9] */
@@ -317,8 +312,7 @@ int mips32_pracc_read_mem32(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_ADDI(9,9,4), 								/* $1 += 4 */
 		MIPS32_ADDI(11,11,4), 								/* $11 += 4 */
 
-		MIPS32_NOP,
-		MIPS32_B(NEG16(9)),									/* b loop */
+		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
 															/* end: */
 		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
@@ -326,8 +320,7 @@ int mips32_pracc_read_mem32(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(31)),								/* b start */
+		MIPS32_B(NEG16(28)),								/* b start */
 		MIPS32_NOP,
 	};
 
@@ -370,15 +363,14 @@ int mips32_pracc_read_u32(struct mips_ejtag *ejtag_info, uint32_t addr, uint32_t
 		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_STACK)),
 		MIPS32_SW(8,0,15), 									/* sw $8,($15) */
 
-		MIPS32_LW(8,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN), 15),  //load R8 @ param_in[0] = address
+		MIPS32_LW(8,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN),15), /* load R8 @ param_in[0] = address */
 
 		MIPS32_LW(8,0,8), 									/* lw $8,0($8), Load $8 with the word @mem[$8] */
-		MIPS32_SW(8,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_OUT),15), 									/* sw $8,0($9) */
+		MIPS32_SW(8,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_OUT),15), /* store R8 @ param_out[0] */
 
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
-		MIPS32_B(NEG16(9)),	//was 17							/* b start */
-		MIPS32_MFC0(15,31,0),   //this instruction will be executed (MIPS executes instruction after jump)							/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
+		MIPS32_B(NEG16(9)),									/* b start */
+		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
 	};
 
 	int retval = ERROR_OK;
@@ -387,7 +379,7 @@ int mips32_pracc_read_u32(struct mips_ejtag *ejtag_info, uint32_t addr, uint32_t
 	param_in[0] = addr;
 
 	if ((retval = mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code,
-		ARRAY_SIZE(param_in), param_in, sizeof(uint32_t), buf, 1)) != ERROR_OK)
+		ARRAY_SIZE(param_in), param_in, 1, buf, 1)) != ERROR_OK)
 	{
 		return retval;
 	}
@@ -413,9 +405,8 @@ int mips32_pracc_read_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(10,4,8),									/* $10 = mem[$8 + 4]; read count */
 		MIPS32_LUI(11,UPPER16(MIPS32_PRACC_PARAM_OUT)),		/* $11 = MIPS32_PRACC_PARAM_OUT */
 		MIPS32_ORI(11,11,LOWER16(MIPS32_PRACC_PARAM_OUT)),
-		MIPS32_NOP,
 															/* loop: */
-		MIPS32_BEQ(0,10,9), 								/* beq 0, $10, end */
+		MIPS32_BEQ(0,10,8), 								/* beq 0, $10, end */
 		MIPS32_NOP,
 
 		MIPS32_LHU(8,0,9), 									/* lw $8,0($9), Load $8 with the halfword @mem[$9] */
@@ -424,21 +415,19 @@ int mips32_pracc_read_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_ADDI(10,10,NEG16(1)), 						/* $10-- */
 		MIPS32_ADDI(9,9,2), 								/* $9 += 2 */
 		MIPS32_ADDI(11,11,4), 								/* $11 += 4 */
+		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
-		MIPS32_B(NEG16(9)),									/* b loop */
-		MIPS32_NOP,
-
+															/* end: */
 		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
 		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(31)),								/* b start */
+		MIPS32_B(NEG16(28)),								/* b start */
 		MIPS32_NOP,
 	};
 
-//	/* TODO remove array */
+	/* TODO remove array */
 	uint32_t *param_out = malloc(count * sizeof(uint32_t));
 	int i;
 
@@ -494,9 +483,8 @@ int mips32_pracc_read_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int cou
 		MIPS32_LW(10,4,8), 									/* $10 = mem[$8 + 4]; read count */
 		MIPS32_LUI(11,UPPER16(MIPS32_PRACC_PARAM_OUT)), 	/* $11 = MIPS32_PRACC_PARAM_OUT */
 		MIPS32_ORI(11,11,LOWER16(MIPS32_PRACC_PARAM_OUT)),
-		MIPS32_NOP,
 															/* loop: */
-		MIPS32_BEQ(0,10,9), 								/* beq 0, $10, end */
+		MIPS32_BEQ(0,10,8), 								/* beq 0, $10, end */
 		MIPS32_NOP,
 
 		MIPS32_LBU(8,0,9), 									/* lw $8,0($9), Load t4 with the byte @mem[t1] */
@@ -505,8 +493,7 @@ int mips32_pracc_read_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int cou
 		MIPS32_ADDI(10,10,NEG16(1)), 						/* $10-- */
 		MIPS32_ADDI(9,9,1), 								/* $9 += 1 */
 		MIPS32_ADDI(11,11,4), 								/* $11 += 4 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(9)),									/* b loop */
+		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
 															/* end: */
 		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
@@ -514,12 +501,11 @@ int mips32_pracc_read_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int cou
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(31)),								/* b start */
+		MIPS32_B(NEG16(28)),								/* b start */
 		MIPS32_NOP,
 	};
 
-//	/* TODO remove array */
+	/* TODO remove array */
 	uint32_t *param_out = malloc(count * sizeof(uint32_t));
 	int i;
 
@@ -577,8 +563,6 @@ int mips32_pracc_write_mem(struct mips_ejtag *ejtag_info, uint32_t addr, int siz
 
 int mips32_pracc_write_mem32(struct mips_ejtag *ejtag_info, uint32_t addr, int count, uint32_t *buf)
 {
-
-//NC: use destination pointer as loop counter (last address is in $10)
 	static const uint32_t code[] = {
 															/* start: */
 		MIPS32_MTC0(15,31,0),								/* move $15 to COP0 DeSave */
@@ -589,32 +573,32 @@ int mips32_pracc_write_mem32(struct mips_ejtag *ejtag_info, uint32_t addr, int c
 		MIPS32_SW(10,0,15), 								/* sw $10,($15) */
 		MIPS32_SW(11,0,15), 								/* sw $11,($15) */
 
-		MIPS32_ADDI(8,15,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN)),  //$8= MIPS32_PRACC_PARAM_IN
+		MIPS32_ADDI(8,15,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN)),  /* $8= MIPS32_PRACC_PARAM_IN */
 		MIPS32_LW(9,0,8), 									/* Load write addr to $9 */
-		MIPS32_LW(10,4,8),	//last address 									/* Load write count to $10 */
-		MIPS32_ADDI(8,8,8), 	// $8 += 8 beginning of data
+		MIPS32_LW(10,4,8),									/* Load write count to $10 */
+		MIPS32_ADDI(8,8,8),									/* $8 += 8 beginning of data */
 
-//loop:
+															/* loop: */
 		MIPS32_LW(11,0,8), 									/* lw $11,0($8), Load $11 with the word @mem[$8] */
 		MIPS32_SW(11,0,9), 									/* sw $11,0($9) */
 
 		MIPS32_ADDI(9,9,4), 								/* $9 += 4 */
-		MIPS32_BNE(10,9,NEG16(4)),  //was 9 BNE $10, 9, loop									/* b loop */
-		MIPS32_ADDI(8,8,4),  //this instruction is part of the loop (one delay slot)!	/* $8 += 4 */
+		MIPS32_BNE(10,9,NEG16(4)),							/* bne $10, $9, loop */
+		MIPS32_ADDI(8,8,4),									/* $8 += 4 */
+
 															/* end: */
 		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
 		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
-		MIPS32_B(NEG16(21)),	 //was 30							/* b start */
+		MIPS32_B(NEG16(21)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_NOP, //this one will not be executed
 	};
 
 	/* TODO remove array */
 	uint32_t *param_in = malloc((count + 2) * sizeof(uint32_t));
 	param_in[0] = addr;
-	param_in[1] = addr + count * sizeof(uint32_t);	//last address
+	param_in[1] = addr + (count * sizeof(uint32_t));	/* last address */
 
 	memcpy(&param_in[2], buf, count * sizeof(uint32_t));
 
@@ -636,16 +620,15 @@ int mips32_pracc_write_u32(struct mips_ejtag *ejtag_info, uint32_t addr, uint32_
 		MIPS32_SW(8,0,15), 									/* sw $8,($15) */
 		MIPS32_SW(9,0,15), 									/* sw $9,($15) */
 
-		MIPS32_LW(8,NEG16((MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN)-4), 15),  //load R8 @ param_in[1] = data
-		MIPS32_LW(9,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN), 15),  //load R9 @ param_in[0] = address
+		MIPS32_LW(8,NEG16((MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN)-4), 15),	/* load R8 @ param_in[1] = data */
+		MIPS32_LW(9,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN), 15),		/* load R9 @ param_in[0] = address */
 
 		MIPS32_SW(8,0,9), 									/* sw $8,0($9) */
 
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
 		MIPS32_B(NEG16(11)),								/* b start */
-		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
+		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
 	};
 
 	/* TODO remove array */
@@ -654,7 +637,7 @@ int mips32_pracc_write_u32(struct mips_ejtag *ejtag_info, uint32_t addr, uint32_
 	param_in[1] = *buf;
 
 	mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code, \
-		ARRAY_SIZE(param_in),param_in, 0, NULL, 1);
+		ARRAY_SIZE(param_in), param_in, 0, NULL, 1);
 
 	return ERROR_OK;
 }
@@ -676,9 +659,8 @@ int mips32_pracc_write_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int c
 		MIPS32_LW(9,0,8), 									/* Load write addr to $9 */
 		MIPS32_LW(10,4,8), 									/* Load write count to $10 */
 		MIPS32_ADDI(8,8,8), 								/* $8 += 8 */
-		MIPS32_NOP,
 															/* loop: */
-		MIPS32_BEQ(0,10,9),									/* beq $0, $10, end */
+		MIPS32_BEQ(0,10,8),									/* beq $0, $10, end */
 		MIPS32_NOP,
 
 		MIPS32_LW(11,0,8), 									/* lw $11,0($8), Load $11 with the word @mem[$8] */
@@ -688,8 +670,7 @@ int mips32_pracc_write_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int c
 		MIPS32_ADDI(9,9,2), 								/* $9 += 2 */
 		MIPS32_ADDI(8,8,4), 								/* $8 += 4 */
 
-		MIPS32_NOP,
-		MIPS32_B(NEG16(9)),									/* b loop */
+		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
 															/* end: */
 		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
@@ -697,8 +678,7 @@ int mips32_pracc_write_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int c
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(30)),								/* b start */
+		MIPS32_B(NEG16(27)),								/* b start */
 		MIPS32_NOP,
 	};
 
@@ -738,9 +718,8 @@ int mips32_pracc_write_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(9,0,8), 									/* Load write addr to $9 */
 		MIPS32_LW(10,4,8), 									/* Load write count to $10 */
 		MIPS32_ADDI(8,8,8), 								/* $8 += 8 */
-		MIPS32_NOP,
 															/* loop: */
-		MIPS32_BEQ(0,10,9),									/* beq $0, $10, end */
+		MIPS32_BEQ(0,10,8),									/* beq $0, $10, end */
 		MIPS32_NOP,
 
 		MIPS32_LW(11,0,8), 									/* lw $11,0($8), Load $11 with the word @mem[$8] */
@@ -750,8 +729,7 @@ int mips32_pracc_write_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_ADDI(9,9,1), 								/* $9 += 1 */
 		MIPS32_ADDI(8,8,4), 								/* $8 += 4 */
 
-		MIPS32_NOP,
-		MIPS32_B(NEG16(9)),									/* b loop */
+		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
 															/* end: */
 		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
@@ -759,8 +737,7 @@ int mips32_pracc_write_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(30)),								/* b start */
+		MIPS32_B(NEG16(27)),								/* b start */
 		MIPS32_NOP,
 	};
 
@@ -777,7 +754,7 @@ int mips32_pracc_write_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 	}
 
 	retval = mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code, \
-		count +2, param_in, 0, NULL, 1);
+		count + 2, param_in, 0, NULL, 1);
 
 	free(param_in);
 
@@ -843,15 +820,14 @@ int mips32_pracc_write_regs(struct mips_ejtag *ejtag_info, uint32_t *regs)
 		MIPS32_LW(2,2*4,1), 							/* lw $2,2*4($1) */
 		MIPS32_LW(1,0,15), 								/* lw $1,($15) */
 		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(55)),							/* b start */
+		MIPS32_B(NEG16(54)),							/* b start */
 		MIPS32_NOP,
 	};
 
 	int retval;
 
 	retval = mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code, \
-		38, regs, 0, NULL, 1);
+			MIPS32NUMCOREREGS, regs, 0, NULL, 1);
 
 	return retval;
 }
@@ -920,15 +896,14 @@ int mips32_pracc_read_regs(struct mips_ejtag *ejtag_info, uint32_t *regs)
 		MIPS32_LW(2,0,15), 								/* lw $2,($15) */
 		MIPS32_LW(1,0,15), 								/* lw $1,($15) */
 		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(60)),							/* b start */
+		MIPS32_B(NEG16(59)),							/* b start */
 		MIPS32_NOP,
 	};
 
 	int retval;
 
 	retval = mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code, \
-		0, NULL, 38, regs, 1);
+		0, NULL, MIPS32NUMCOREREGS, regs, 1);
 
 	return retval;
 }
@@ -970,7 +945,6 @@ int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_are
 		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_TEXT)),
 		MIPS32_JR(15),									/* jr start */
 		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
 	};
 
 	uint32_t jmp_code[] = {
@@ -981,9 +955,6 @@ int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_are
 		MIPS32_NOP,
 	};
 
-#define JMP_CODE_SIZE (sizeof(jmp_code)/sizeof(jmp_code[0]))
-#define HANDLER_CODE_SIZE sizeof(handler_code)/sizeof(handler_code[0])
-
 	int retval, i;
 	uint32_t val, ejtag_ctrl, address;
 
@@ -1002,7 +973,7 @@ int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_are
 	}
 
 	/* write program into RAM */
-	mips32_pracc_write_mem32(ejtag_info, source->address, HANDLER_CODE_SIZE, handler_code);
+	mips32_pracc_write_mem32(ejtag_info, source->address, ARRAY_SIZE(handler_code), handler_code);
 
 	/* quick verify RAM is working */
 	mips32_pracc_read_u32(ejtag_info, source->address, &val);
@@ -1017,7 +988,7 @@ int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_are
 	jmp_code[1] |= UPPER16(source->address);
 	jmp_code[2] |= LOWER16(source->address);
 
-	for (i = 0; i < (int) JMP_CODE_SIZE; i++)
+	for (i = 0; i < (int) ARRAY_SIZE(jmp_code); i++)
 	{
 		if ((retval = wait_for_pracc_rw(ejtag_info, &ejtag_ctrl)) != ERROR_OK)
 			return retval;
@@ -1026,7 +997,6 @@ int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_are
 		mips_ejtag_drscan_32(ejtag_info, &jmp_code[i]);
 
 		/* Clear the access pending bit (let the processor eat!) */
-
 		ejtag_ctrl = ejtag_info->ejtag_ctrl & ~EJTAG_CTRL_PRACC;
 		mips_ejtag_set_instr(ejtag_info, EJTAG_INST_CONTROL, NULL);
 		mips_ejtag_drscan_32(ejtag_info, &ejtag_ctrl);
diff --git a/src/target/mips32_pracc.h b/src/target/mips32_pracc.h
index 41a7325..a914686 100644
--- a/src/target/mips32_pracc.h
+++ b/src/target/mips32_pracc.h
@@ -28,7 +28,6 @@
 #define MIPS32_PRACC_FASTDATA_AREA		0xFF200000
 #define MIPS32_PRACC_FASTDATA_SIZE		16
 #define MIPS32_PRACC_TEXT			0xFF200200
-//#define MIPS32_PRACC_STACK			0xFF2FFFFC
 #define MIPS32_PRACC_STACK			0xFF204000
 #define MIPS32_PRACC_PARAM_IN		0xFF201000
 #define MIPS32_PRACC_PARAM_IN_SIZE	0x1000
diff --git a/src/target/mips_ejtag.c b/src/target/mips_ejtag.c
index 6f7baf0..bebad9a 100644
--- a/src/target/mips_ejtag.c
+++ b/src/target/mips_ejtag.c
@@ -139,10 +139,8 @@ int mips_ejtag_step_enable(struct mips_ejtag *ejtag_info)
 			MIPS32_MFC0(1,23,0),			/* move COP0 Debug to $1 */
 			MIPS32_ORI(1,1,0x0100),			/* set SSt bit in debug reg */
 			MIPS32_MTC0(1,23,0),			/* move $1 to COP0 Debug */
+			MIPS32_B(NEG16(5)),
 			MIPS32_MFC0(1,31,0),			/* move COP0 DeSave to $1 */
-			MIPS32_NOP,
-			MIPS32_B(NEG16(7)),
-			MIPS32_NOP,
 	};
 
 	mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code, \
@@ -165,10 +163,8 @@ int mips_ejtag_step_disable(struct mips_ejtag *ejtag_info)
 			MIPS32_MTC0(1,23,0),							/* move $1 to COP0 Debug */
 			MIPS32_LW(2,0,15),
 			MIPS32_LW(1,0,15),
+			MIPS32_B(NEG16(13)),
 			MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-			MIPS32_NOP,
-			MIPS32_B(NEG16(15)),
-			MIPS32_NOP,
 	};
 
 	mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code, \
@@ -230,10 +226,8 @@ int mips_ejtag_read_debug(struct mips_ejtag *ejtag_info, uint32_t* debug_reg)
 			MIPS32_SW(2,0,1),
 			MIPS32_LW(2,0,15),
 			MIPS32_LW(1,0,15),
+			MIPS32_B(NEG16(12)),
 			MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-			MIPS32_NOP,
-			MIPS32_B(NEG16(14)),
-			MIPS32_NOP,
 	};
 
 	mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code, \
diff --git a/src/target/mips_m4k.c b/src/target/mips_m4k.c
index f3191ae..4adc1f1 100644
--- a/src/target/mips_m4k.c
+++ b/src/target/mips_m4k.c
@@ -993,14 +993,14 @@ int mips_m4k_bulk_write_memory(struct target *target, uint32_t address, uint32_t
 	if (target->endianness == TARGET_BIG_ENDIAN)
 	{
 		uint32_t i, t32;
-		for(i = 0; i < (count*4); i+=4)
+		for(i = 0; i < (count * 4); i += 4)
 		{
 			t32 = be_to_h_u32((uint8_t *) &buffer[i]);
 			h_u32_to_le(&buffer[i], t32);
 		}
 	}
 
-	retval = mips32_pracc_fastdata_xfer(ejtag_info, source, write, address, count, (uint32_t *) buffer);
+	retval = mips32_pracc_fastdata_xfer(ejtag_info, source, write, address, count, (uint32_t*) buffer);
 
 	if (source)
 		target_free_working_area(target, source);

commit faad9e59233306e608a3a01388a38099ece9688b
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Thu Dec 17 11:53:39 2009 +0000

    parport: output port as hex rather than dec
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/src/jtag/drivers/parport.c b/src/jtag/drivers/parport.c
index 2e6b9ed..b280d04 100644
--- a/src/jtag/drivers/parport.c
+++ b/src/jtag/drivers/parport.c
@@ -424,7 +424,7 @@ COMMAND_HANDLER(parport_handle_parport_port_command)
 		}
 	}
 
-	command_print(CMD_CTX, "parport port = %u", parport_port);
+	command_print(CMD_CTX, "parport port = 0x%" PRIx16 "", parport_port);
 
 	return ERROR_OK;
 }

commit 03e8649bc699053ccdbbd4a3c2eaf05241e22a5b
Author: David Claffey <dnclaffey at gmail.com>
Date:   Wed Dec 16 11:23:52 2009 +0000

    MIPS: merge mips fast_data patch from David N. Claffey
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/src/target/mips32.c b/src/target/mips32.c
index e8ea541..0f6f9b0 100644
--- a/src/target/mips32.c
+++ b/src/target/mips32.c
@@ -29,7 +29,6 @@
 #include "mips32.h"
 #include "register.h"
 
-
 char* mips32_core_reg_list[] =
 {
 	"zero", "at", "v0", "v1", "a0", "a1", "a2", "a3",
diff --git a/src/target/mips32.h b/src/target/mips32.h
index 7d1928e..9ad5293 100644
--- a/src/target/mips32.h
+++ b/src/target/mips32.h
@@ -77,6 +77,7 @@ struct mips32_core_reg
 #define MIPS32_OP_ADDI	0x08
 #define MIPS32_OP_AND	0x24
 #define MIPS32_OP_COP0	0x10
+#define MIPS32_OP_JR	0x08
 #define MIPS32_OP_LUI	0x0F
 #define MIPS32_OP_LW	0x23
 #define MIPS32_OP_LBU	0x24
@@ -103,6 +104,7 @@ struct mips32_core_reg
 #define MIPS32_B(off)				MIPS32_BEQ(0, 0, off)
 #define MIPS32_BEQ(src,tar,off)		MIPS32_I_INST(MIPS32_OP_BEQ, src, tar, off)
 #define MIPS32_BNE(src,tar,off)		MIPS32_I_INST(MIPS32_OP_BNE, src, tar, off)
+#define MIPS32_JR(reg)				MIPS32_R_INST(0, reg, 0, 0, 0, MIPS32_OP_JR)
 #define MIPS32_MFC0(gpr, cpr, sel)	MIPS32_R_INST(MIPS32_OP_COP0, MIPS32_COP0_MF, gpr, cpr, 0, sel)
 #define MIPS32_MTC0(gpr,cpr, sel)	MIPS32_R_INST(MIPS32_OP_COP0, MIPS32_COP0_MT, gpr, cpr, 0, sel)
 #define MIPS32_LBU(reg, off, base)	MIPS32_I_INST(MIPS32_OP_LBU, base, reg, off)
diff --git a/src/target/mips32_pracc.c b/src/target/mips32_pracc.c
index 604d34e..34794f3 100644
--- a/src/target/mips32_pracc.c
+++ b/src/target/mips32_pracc.c
@@ -4,6 +4,8 @@
  *                                                                         *
  *   Copyright (C) 2008 by David T.L. Wong                                 *
  *                                                                         *
+ *   Copyright (C) 2009 by David N. Claffey <dnclaffey at gmail.com>          *
+ *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
  *   it under the terms of the GNU General Public License as published by  *
  *   the Free Software Foundation; either version 2 of the License, or     *
@@ -69,7 +71,6 @@ OpenOCD is used as a flash programmer or as a debug tool.
 Nico Coesel
 */
 
-
 #ifdef HAVE_CONFIG_H
 #include "config.h"
 #endif
@@ -161,7 +162,6 @@ static int mips32_pracc_exec_read(struct mips32_pracc_context *ctx, uint32_t add
 	jtag_add_clocks(5);
 	jtag_execute_queue();
 
-
 	return ERROR_OK;
 }
 
@@ -254,7 +254,6 @@ int mips32_pracc_exec(struct mips_ejtag *ejtag_info, int code_len, const uint32_
 
 			if ((retval = mips32_pracc_exec_read(&ctx, address)) != ERROR_OK)
 				return retval;
-
 		}
 
 		if (cycle == 0)
@@ -933,3 +932,149 @@ int mips32_pracc_read_regs(struct mips_ejtag *ejtag_info, uint32_t *regs)
 
 	return retval;
 }
+
+/* fastdata upload/download requires an initialized working area
+ * to load the download code; it should not be called otherwise
+ * fetch order from the fastdata area
+ * 1. start addr
+ * 2. end addr
+ * 3. data ...
+ */
+int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_area *source,
+								int write, uint32_t addr, int count, uint32_t *buf)
+{
+	uint32_t handler_code[] = {
+		/* caution when editing, table is modified below */
+		/* r15 points to the start of this code */
+		MIPS32_SW(8,MIPS32_FASTDATA_HANDLER_SIZE - 4,15),
+		MIPS32_SW(9,MIPS32_FASTDATA_HANDLER_SIZE - 8,15),
+		MIPS32_SW(10,MIPS32_FASTDATA_HANDLER_SIZE - 12,15),
+		MIPS32_SW(11,MIPS32_FASTDATA_HANDLER_SIZE - 16,15),
+		/* start of fastdata area in t0 */
+		MIPS32_LUI(8,UPPER16(MIPS32_PRACC_FASTDATA_AREA)),
+		MIPS32_ORI(8,8,LOWER16(MIPS32_PRACC_FASTDATA_AREA)),
+		MIPS32_LW(9,0,8),								/* start addr in t1 */
+		MIPS32_LW(10,0,8),								/* end addr to t2 */
+														/* loop: */
+		/* 8 */ MIPS32_LW(11,0,0),						/* lw t3,[t8 | r9] */
+		/* 9 */ MIPS32_SW(11,0,0),						/* sw t3,[r9 | r8] */
+		MIPS32_BNE(10,9,NEG16(3)),						/* bne $t2,t1,loop */
+		MIPS32_ADDI(9,9,4),								/* addi t1,t1,4 */
+
+		MIPS32_LW(8,MIPS32_FASTDATA_HANDLER_SIZE - 4,15),
+		MIPS32_LW(9,MIPS32_FASTDATA_HANDLER_SIZE - 8,15),
+		MIPS32_LW(10,MIPS32_FASTDATA_HANDLER_SIZE - 12,15),
+		MIPS32_LW(11,MIPS32_FASTDATA_HANDLER_SIZE - 16,15),
+
+		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_TEXT)),
+		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_TEXT)),
+		MIPS32_JR(15),									/* jr start */
+		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
+		MIPS32_NOP,
+	};
+
+	uint32_t jmp_code[] = {
+		MIPS32_MTC0(15,31,0),			/* move $15 to COP0 DeSave */
+		/* 1 */ MIPS32_LUI(15,0),		/* addr of working area added below */
+		/* 2 */ MIPS32_ORI(15,15,0),	/* addr of working area added below */
+		MIPS32_JR(15),					/* jump to ram program */
+		MIPS32_NOP,
+	};
+
+#define JMP_CODE_SIZE (sizeof(jmp_code)/sizeof(jmp_code[0]))
+#define HANDLER_CODE_SIZE sizeof(handler_code)/sizeof(handler_code[0])
+
+	int retval, i;
+	uint32_t val, ejtag_ctrl, address;
+
+	if (source->size < MIPS32_FASTDATA_HANDLER_SIZE)
+		return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
+
+	if (write)
+	{
+		handler_code[8] = MIPS32_LW(11,0,8);	/* load data from probe at fastdata area */
+		handler_code[9] = MIPS32_SW(11,0,9);	/* store data to RAM @ r9 */
+	}
+	else
+	{
+		handler_code[8] = MIPS32_LW(11,0,9);	/* load data from RAM @ r9 */
+		handler_code[9] = MIPS32_SW(11,0,8);	/* store data to probe at fastdata area */
+	}
+
+	/* write program into RAM */
+	mips32_pracc_write_mem32(ejtag_info, source->address, HANDLER_CODE_SIZE, handler_code);
+
+	/* quick verify RAM is working */
+	mips32_pracc_read_u32(ejtag_info, source->address, &val);
+	if (val != handler_code[0])
+	{
+		LOG_ERROR("fastdata handler verify failed\n");
+		return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
+	}
+
+	LOG_INFO("%s using 0x%.8x for write handler\n", __func__, source->address);
+
+	jmp_code[1] |= UPPER16(source->address);
+	jmp_code[2] |= LOWER16(source->address);
+
+	for (i = 0; i < (int) JMP_CODE_SIZE; i++)
+	{
+		if ((retval = wait_for_pracc_rw(ejtag_info, &ejtag_ctrl)) != ERROR_OK)
+			return retval;
+
+		mips_ejtag_set_instr(ejtag_info, EJTAG_INST_DATA, NULL);
+		mips_ejtag_drscan_32(ejtag_info, &jmp_code[i]);
+
+		/* Clear the access pending bit (let the processor eat!) */
+
+		ejtag_ctrl = ejtag_info->ejtag_ctrl & ~EJTAG_CTRL_PRACC;
+		mips_ejtag_set_instr(ejtag_info, EJTAG_INST_CONTROL, NULL);
+		mips_ejtag_drscan_32(ejtag_info, &ejtag_ctrl);
+	}
+
+	if ((retval = wait_for_pracc_rw(ejtag_info, &ejtag_ctrl)) != ERROR_OK)
+		return retval;
+
+	/* next fetch to dmseg should be in FASTDATA_AREA, check */
+	address = 0;
+	mips_ejtag_set_instr(ejtag_info, EJTAG_INST_ADDRESS, NULL);
+	mips_ejtag_drscan_32(ejtag_info, &address);
+
+	if (address != MIPS32_PRACC_FASTDATA_AREA)
+		return ERROR_FAIL;
+
+	/* Send the load start address */
+	val = addr;
+	mips_ejtag_set_instr(ejtag_info, EJTAG_INST_FASTDATA, NULL);
+	mips_ejtag_fastdata_scan(ejtag_info, 1, &val);
+
+	/* Send the load end address */
+	val = addr + (count - 1) * 4;
+	mips_ejtag_set_instr(ejtag_info, EJTAG_INST_FASTDATA, NULL);
+	mips_ejtag_fastdata_scan(ejtag_info, 1, &val);
+
+	for (i = 0; i < count; i++)
+	{
+		/* Send the data out using fastdata (clears the access pending bit) */
+		if ((retval = mips_ejtag_fastdata_scan(ejtag_info, write, buf++)) != ERROR_OK)
+			return retval;
+	}
+
+	if ((retval = jtag_execute_queue()) != ERROR_OK)
+	{
+		LOG_ERROR("fastdata load failed");
+		return retval;
+	}
+
+	if ((retval = wait_for_pracc_rw(ejtag_info, &ejtag_ctrl)) != ERROR_OK)
+		return retval;
+
+	address = 0;
+	mips_ejtag_set_instr(ejtag_info, EJTAG_INST_ADDRESS, NULL);
+	mips_ejtag_drscan_32(ejtag_info, &address);
+
+	if (address != MIPS32_PRACC_TEXT)
+		LOG_ERROR("mini program did not return to start\n");
+
+	return retval;
+}
diff --git a/src/target/mips32_pracc.h b/src/target/mips32_pracc.h
index 5d1cf3d..41a7325 100644
--- a/src/target/mips32_pracc.h
+++ b/src/target/mips32_pracc.h
@@ -22,8 +22,11 @@
 #ifndef MIPS32_PRACC_H
 #define MIPS32_PRACC_H
 
-#include "mips_ejtag.h"
+#include <target/mips32.h>
+#include <target/mips_ejtag.h>
 
+#define MIPS32_PRACC_FASTDATA_AREA		0xFF200000
+#define MIPS32_PRACC_FASTDATA_SIZE		16
 #define MIPS32_PRACC_TEXT			0xFF200200
 //#define MIPS32_PRACC_STACK			0xFF2FFFFC
 #define MIPS32_PRACC_STACK			0xFF204000
@@ -32,6 +35,7 @@
 #define MIPS32_PRACC_PARAM_OUT		(MIPS32_PRACC_PARAM_IN + MIPS32_PRACC_PARAM_IN_SIZE)
 #define MIPS32_PRACC_PARAM_OUT_SIZE	0x1000
 
+#define MIPS32_FASTDATA_HANDLER_SIZE	0x80
 #define UPPER16(uint32_t) (uint32_t >> 16)
 #define LOWER16(uint32_t) (uint32_t & 0xFFFF)
 #define NEG16(v) (((~(v)) + 1) & 0xFFFF)
@@ -41,6 +45,8 @@ int mips32_pracc_read_mem(struct mips_ejtag *ejtag_info,
 		uint32_t addr, int size, int count, void *buf);
 int mips32_pracc_write_mem(struct mips_ejtag *ejtag_info,
 		uint32_t addr, int size, int count, void *buf);
+int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_area *source,
+		int write, uint32_t addr, int count, uint32_t *buf);
 
 int mips32_pracc_read_mem8(struct mips_ejtag *ejtag_info,
 		uint32_t addr, int count, uint8_t *buf);
diff --git a/src/target/mips_ejtag.c b/src/target/mips_ejtag.c
index 68a39fa..6f7baf0 100644
--- a/src/target/mips_ejtag.c
+++ b/src/target/mips_ejtag.c
@@ -4,6 +4,8 @@
  *                                                                         *
  *   Copyright (C) 2008 by David T.L. Wong                                 *
  *                                                                         *
+ *   Copyright (C) 2009 by David N. Claffey <dnclaffey at gmail.com>          *
+ *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
  *   it under the terms of the GNU General Public License as published by  *
  *   the Free Software Foundation; either version 2 of the License, or     *
@@ -286,3 +288,42 @@ int mips_ejtag_init(struct mips_ejtag *ejtag_info)
 
 	return ERROR_OK;
 }
+
+int mips_ejtag_fastdata_scan(struct mips_ejtag *ejtag_info, int write, uint32_t *data)
+{
+	struct jtag_tap *tap;
+	tap = ejtag_info->tap;
+
+	if (tap == NULL)
+		return ERROR_FAIL;
+
+	struct scan_field fields[2];
+	uint8_t spracc = 0;
+	uint8_t t[4] = {0, 0, 0, 0};
+
+	/* fastdata 1-bit register */
+	fields[0].tap = tap;
+	fields[0].num_bits = 1;
+	fields[0].out_value = &spracc;
+	fields[0].in_value = NULL;
+
+	/* processor access data register 32 bit */
+	fields[1].tap = tap;
+	fields[1].num_bits = 32;
+	fields[1].out_value = t;
+
+	if (write)
+	{
+		fields[1].in_value = NULL;
+		buf_set_u32(t, 0, 32, *data);
+	}
+	else
+	{
+		fields[1].in_value = (uint8_t *) data;
+	}
+
+	jtag_add_dr_scan(2, fields, jtag_get_end_state());
+	keep_alive();
+
+	return ERROR_OK;
+}
diff --git a/src/target/mips_ejtag.h b/src/target/mips_ejtag.h
index 93b4a6a..eb42d67 100644
--- a/src/target/mips_ejtag.h
+++ b/src/target/mips_ejtag.h
@@ -118,6 +118,7 @@ int mips_ejtag_exit_debug(struct mips_ejtag *ejtag_info);
 int mips_ejtag_get_impcode(struct mips_ejtag *ejtag_info, uint32_t *impcode);
 int mips_ejtag_get_idcode(struct mips_ejtag *ejtag_info, uint32_t *idcode);
 int mips_ejtag_drscan_32(struct mips_ejtag *ejtag_info, uint32_t *data);
+int mips_ejtag_fastdata_scan(struct mips_ejtag *ejtag_info, int write, uint32_t *data);
 
 int mips_ejtag_init(struct mips_ejtag *ejtag_info);
 int mips_ejtag_config_step(struct mips_ejtag *ejtag_info, int enable_step);
diff --git a/src/target/mips_m4k.c b/src/target/mips_m4k.c
index a83217f..f3191ae 100644
--- a/src/target/mips_m4k.c
+++ b/src/target/mips_m4k.c
@@ -4,6 +4,8 @@
  *                                                                         *
  *   Copyright (C) 2008 by David T.L. Wong                                 *
  *                                                                         *
+ *   Copyright (C) 2009 by David N. Claffey <dnclaffey at gmail.com>          *
+ *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
  *   it under the terms of the GNU General Public License as published by  *
  *   the Free Software Foundation; either version 2 of the License, or     *
@@ -30,7 +32,6 @@
 #include "target_type.h"
 #include "register.h"
 
-
 /* cli handling */
 
 /* forward declarations */
@@ -962,7 +963,49 @@ int mips_m4k_examine(struct target *target)
 
 int mips_m4k_bulk_write_memory(struct target *target, uint32_t address, uint32_t count, uint8_t *buffer)
 {
-	return mips_m4k_write_memory(target, address, 4, count, buffer);
+	struct mips32_common *mips32 = target->arch_info;
+	struct mips_ejtag *ejtag_info = &mips32->ejtag_info;
+	struct working_area *source;
+	int retval;
+	int write = 1;
+
+	LOG_DEBUG("address: 0x%8.8x, count: 0x%8.8x", address, count);
+
+	if (target->state != TARGET_HALTED)
+	{
+		LOG_WARNING("target not halted");
+		return ERROR_TARGET_NOT_HALTED;
+	}
+
+	/* check alignment */
+	if (address & 0x3u)
+		return ERROR_TARGET_UNALIGNED_ACCESS;
+
+	/* Get memory for block write handler */
+	retval = target_alloc_working_area(target, MIPS32_FASTDATA_HANDLER_SIZE, &source);
+	if (retval != ERROR_OK)
+	{
+		LOG_WARNING("No working area available, falling back to non-bulk write");
+		return mips_m4k_write_memory(target, address, 4, count, buffer);
+	}
+
+	/* TAP data register is loaded LSB first (little endian) */
+	if (target->endianness == TARGET_BIG_ENDIAN)
+	{
+		uint32_t i, t32;
+		for(i = 0; i < (count*4); i+=4)
+		{
+			t32 = be_to_h_u32((uint8_t *) &buffer[i]);
+			h_u32_to_le(&buffer[i], t32);
+		}
+	}
+
+	retval = mips32_pracc_fastdata_xfer(ejtag_info, source, write, address, count, (uint32_t *) buffer);
+
+	if (source)
+		target_free_working_area(target, source);
+
+	return retval;
 }
 
 int mips_m4k_checksum_memory(struct target *target, uint32_t address, uint32_t size, uint32_t *checksum)

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/drivers/parport.c |    2 +-
 src/target/mips32.c        |    1 -
 src/target/mips32.h        |    2 +
 src/target/mips32_pracc.c  |  268 +++++++++++++++++++++++++++++++-------------
 src/target/mips32_pracc.h  |    9 +-
 src/target/mips_ejtag.c    |   53 +++++++--
 src/target/mips_ejtag.h    |    1 +
 src/target/mips_m4k.c      |   47 ++++++++-
 tcl/target/pic32mx.cfg     |   18 +++-
 9 files changed, 305 insertions(+), 96 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Tue Jan  5 22:10:32 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Tue,  5 Jan 2010 21:10:32 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-53-gfccb812
Message-ID: <E1NSGfi-0000k0-FL@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  fccb812f829e55940e26466c4cda8c25765d4f6c (commit)
       via  adf2a9a267422a2914a50b4a4a35a0e19b25d1c3 (commit)
      from  9d83df72dcbfc791b470b12949890df3f2d1508d (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit fccb812f829e55940e26466c4cda8c25765d4f6c
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Tue Jan 5 13:03:27 2010 -0800

    ARM: add #defines for JTAG ack codes
    
    JTAG has only two possible JTAG ack codes for APACC and DPACC
    register reads/writes.  Define them, and remove empty "else"
    clause in the code which now uses those codes.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 9f26064..96accf3 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -249,12 +249,14 @@ int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
 
 	swjdp->ack = swjdp->ack & 0x7;
 
-	if (swjdp->ack != 2)
+	/* common code path avoids calling timeval_ms() */
+	if (swjdp->ack != JTAG_ACK_OK_FAULT)
 	{
 		long long then = timeval_ms();
-		while (swjdp->ack != 2)
+
+		while (swjdp->ack != JTAG_ACK_OK_FAULT)
 		{
-			if (swjdp->ack == 1)
+			if (swjdp->ack == JTAG_ACK_WAIT)
 			{
 				if ((timeval_ms()-then) > 1000)
 				{
@@ -280,9 +282,6 @@ int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
 				return retval;
 			swjdp->ack = swjdp->ack & 0x7;
 		}
-	} else
-	{
-		/* common code path avoids fn to timeval_ms() */
 	}
 
 	/* Check for STICKYERR and STICKYORUN */
diff --git a/src/target/arm_adi_v5.h b/src/target/arm_adi_v5.h
index 4e1b1aa..675a173 100644
--- a/src/target/arm_adi_v5.h
+++ b/src/target/arm_adi_v5.h
@@ -38,6 +38,10 @@
 #define JTAG_DP_APACC		0xB
 #define JTAG_DP_IDCODE		0xE
 
+/* three-bit ACK values for DPACC and APACC reads */
+#define JTAG_ACK_OK_FAULT	0x2
+#define JTAG_ACK_WAIT		0x1
+
 #define DPAP_WRITE		0
 #define DPAP_READ		1
 

commit adf2a9a267422a2914a50b4a4a35a0e19b25d1c3
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Tue Jan 5 12:55:46 2010 -0800

    ARM: add comments re DAP assumptions
    
    I think some of these assumptions are not well-founded.
    Related, that swjdp_transaction_endcheck() is a bit iffy.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 82a2a28..9f26064 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -195,8 +195,12 @@ static int scan_inout_check_u32(struct swjdp_common *swjdp,
 		uint8_t instr, uint8_t reg_addr, uint8_t RnW,
 		uint32_t outvalue, uint32_t *invalue)
 {
+	/* Issue the read or write */
 	adi_jtag_dp_scan_u32(swjdp, instr, reg_addr, RnW, outvalue, NULL, NULL);
 
+	/* For reads,  collect posted value; RDBUFF has no other effect.
+	 * Assumes read gets acked with OK/FAULT, and CTRL_STAT says "OK".
+	 */
 	if ((RnW == DPAP_READ) && (invalue != NULL))
 		adi_jtag_dp_scan_u32(swjdp, JTAG_DP_DPACC,
 				DP_RDBUFF, DPAP_READ, 0, invalue, &swjdp->ack);
@@ -235,6 +239,9 @@ int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
 	/* Why??? second time it works??? */
 #endif
 
+	/* Post CTRL/STAT read; discard any previous posted read value
+	 * but collect its ACK status.
+	 */
 	scan_inout_check_u32(swjdp, JTAG_DP_DPACC,
 			DP_CTRL_STAT, DPAP_READ, 0, &ctrlstat);
 	if ((retval = jtag_execute_queue()) != ERROR_OK)
@@ -787,13 +794,18 @@ int mem_ap_read_buf_u32(struct swjdp_common *swjdp, uint8_t *buffer, int count,
 				DPAP_READ, 0, NULL, NULL);
 		for (readcount = 0; readcount < blocksize - 1; readcount++)
 		{
-			/* Scan out read instruction and scan in previous value */
+			/* Scan out next read; scan in posted value for the
+			 * previous one.  Assumes read is acked "OK/FAULT",
+			 * and CTRL_STAT says that meant "OK".
+			 */
 			adi_jtag_dp_scan(swjdp, JTAG_DP_APACC, AP_REG_DRW,
 					DPAP_READ, 0, buffer + 4 * readcount,
 					&swjdp->ack);
 		}
 
-		/* Scan in last value */
+		/* Scan in last posted value; RDBUFF has no other effect,
+		 * assuming ack is OK/FAULT and CTRL_STAT says "OK".
+		 */
 		adi_jtag_dp_scan(swjdp, JTAG_DP_DPACC, DP_RDBUFF,
 				DPAP_READ, 0, buffer + 4 * readcount,
 				&swjdp->ack);

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm_adi_v5.c |   27 +++++++++++++++++++--------
 src/target/arm_adi_v5.h |    4 ++++
 2 files changed, 23 insertions(+), 8 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Tue Jan  5 22:33:14 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Tue,  5 Jan 2010 21:33:14 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-54-g844b5eb
Message-ID: <E1NSH1f-0005e6-5Y@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  844b5eb49d7fd4afa4f0309ce47f29d99886a2f7 (commit)
      from  fccb812f829e55940e26466c4cda8c25765d4f6c (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 844b5eb49d7fd4afa4f0309ce47f29d99886a2f7
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Tue Jan 5 13:32:39 2010 -0800

    don't require 'openocd.cfg' to start
    
    Starting the daemon with with just a bare "openocd" I saw:
    
    	Can't find openocd.cfg
    
    That's not an error; don't treat it as if it were.  There may
    be an error later -- like, "no interface set up" -- but let
    messages only report real errors, not fake ones.

diff --git a/src/helper/configuration.c b/src/helper/configuration.c
index 007246c..eedd8a1 100644
--- a/src/helper/configuration.c
+++ b/src/helper/configuration.c
@@ -115,8 +115,10 @@ int parse_config_file(struct command_context *cmd_ctx)
 	int retval;
 	char **cfg;
 
-	if (!config_file_names)
-		add_config_command ("script openocd.cfg");
+	if (!config_file_names) {
+		command_run_line(cmd_ctx, "script openocd.cfg");
+		return ERROR_OK;
+	}
 
 	cfg = config_file_names;
 

-----------------------------------------------------------------------

Summary of changes:
 src/helper/configuration.c |    6 ++++--
 1 files changed, 4 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Tue Jan  5 23:16:15 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Tue,  5 Jan 2010 22:16:15 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-55-g2bc7446
Message-ID: <E1NSHhI-00018z-2v@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  2bc7446bb8caf751f7d6900af26384f6c64cc791 (commit)
      from  844b5eb49d7fd4afa4f0309ce47f29d99886a2f7 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 2bc7446bb8caf751f7d6900af26384f6c64cc791
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Tue Jan 5 14:11:03 2010 -0800

    buildfix with -DNDEBUG
    
    Don't save that state unless its only user, an assertion,
    is compiled.  Saving it broke a cygwin build.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/drivers/driver.c b/src/jtag/drivers/driver.c
index c57386a..45c5d10 100644
--- a/src/jtag/drivers/driver.c
+++ b/src/jtag/drivers/driver.c
@@ -215,7 +215,10 @@ int interface_jtag_add_dr_scan(int in_num_fields, const struct scan_field *in_fi
 
 		if (!tap->bypass)
 		{
-			struct scan_field * start_field = field;	/* keep initial position for assert() */
+#ifndef NDEBUG
+			/* remember initial position for assert() */
+			struct scan_field *start_field = field;
+#endif /* NDEBUG */
 
 			for (int j = 0; j < in_num_fields; j++)
 			{

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/drivers/driver.c |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Thu Jan  7 23:41:05 2010
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Thu,  7 Jan 2010 22:41:05 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-58-g991d030
Message-ID: <E1NT12Q-0001C1-EW@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  991d030fcc9be971f29498ea7e1b3afbed05815b (commit)
       via  c68c2751f309103cc7116464e6c3242d54c1007b (commit)
       via  2d450b90333b01fbd85570e5d881c3a795038744 (commit)
      from  2bc7446bb8caf751f7d6900af26384f6c64cc791 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 991d030fcc9be971f29498ea7e1b3afbed05815b
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Thu Jan 7 22:39:35 2010 +0000

    MIPS: change bulk_write_memory fallback msg to LOG_DEBUG
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/src/target/mips_m4k.c b/src/target/mips_m4k.c
index 312fc09..f229690 100644
--- a/src/target/mips_m4k.c
+++ b/src/target/mips_m4k.c
@@ -1004,7 +1004,7 @@ int mips_m4k_bulk_write_memory(struct target *target, uint32_t address, uint32_t
 	if (retval != ERROR_OK)
 	{
 		/* FASTDATA access failed, try normal memory write */
-		LOG_WARNING("Fastdata access Failed, falling back to non-bulk write");
+		LOG_DEBUG("Fastdata access Failed, falling back to non-bulk write");
 		retval = mips_m4k_write_memory(target, address, 4, count, buffer);
 	}
 

commit c68c2751f309103cc7116464e6c3242d54c1007b
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Thu Jan 7 20:56:07 2010 +0000

    MIPS: whitespace cleanup
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/src/target/mips32.h b/src/target/mips32.h
index 9ad5293..4fe61bc 100644
--- a/src/target/mips32.h
+++ b/src/target/mips32.h
@@ -123,7 +123,7 @@ struct mips32_core_reg
 /* ejtag specific instructions */
 #define MIPS32_DRET					0x4200001F
 #define MIPS32_SDBBP				0x7000003F
-#define MIPS16_SDBBP 				0xE801
+#define MIPS16_SDBBP				0xE801
 
 int mips32_arch_state(struct target *target);
 
diff --git a/src/target/mips32_pracc.c b/src/target/mips32_pracc.c
index ac1d1b3..52d31bd 100644
--- a/src/target/mips32_pracc.c
+++ b/src/target/mips32_pracc.c
@@ -288,37 +288,37 @@ int mips32_pracc_read_mem32(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 	static const uint32_t code[] = {
 															/* start: */
 		MIPS32_MTC0(15,31,0),								/* move $15 to COP0 DeSave */
-		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)), 		/* $15 = MIPS32_PRACC_STACK */
+		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)),			/* $15 = MIPS32_PRACC_STACK */
 		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_STACK)),
-		MIPS32_SW(8,0,15), 									/* sw $8,($15) */
-		MIPS32_SW(9,0,15), 									/* sw $9,($15) */
-		MIPS32_SW(10,0,15), 								/* sw $10,($15) */
-		MIPS32_SW(11,0,15), 								/* sw $11,($15) */
+		MIPS32_SW(8,0,15),									/* sw $8,($15) */
+		MIPS32_SW(9,0,15),									/* sw $9,($15) */
+		MIPS32_SW(10,0,15),									/* sw $10,($15) */
+		MIPS32_SW(11,0,15),									/* sw $11,($15) */
 
 		MIPS32_LUI(8,UPPER16(MIPS32_PRACC_PARAM_IN)),		/* $8 = MIPS32_PRACC_PARAM_IN */
 		MIPS32_ORI(8,8,LOWER16(MIPS32_PRACC_PARAM_IN)),
 		MIPS32_LW(9,0,8),									/* $9 = mem[$8]; read addr */
 		MIPS32_LW(10,4,8),									/* $10 = mem[$8 + 4]; read count */
-		MIPS32_LUI(11,UPPER16(MIPS32_PRACC_PARAM_OUT)), 	/* $11 = MIPS32_PRACC_PARAM_OUT */
+		MIPS32_LUI(11,UPPER16(MIPS32_PRACC_PARAM_OUT)),		/* $11 = MIPS32_PRACC_PARAM_OUT */
 		MIPS32_ORI(11,11,LOWER16(MIPS32_PRACC_PARAM_OUT)),
 															/* loop: */
 		MIPS32_BEQ(0,10,8),									/* beq 0, $10, end */
 		MIPS32_NOP,
 
-		MIPS32_LW(8,0,9), 									/* lw $8,0($9), Load $8 with the word @mem[$9] */
-		MIPS32_SW(8,0,11), 									/* sw $8,0($11) */
+		MIPS32_LW(8,0,9),									/* lw $8,0($9), Load $8 with the word @mem[$9] */
+		MIPS32_SW(8,0,11),									/* sw $8,0($11) */
 
-		MIPS32_ADDI(10,10,NEG16(1)), 						/* $10-- */
-		MIPS32_ADDI(9,9,4), 								/* $1 += 4 */
-		MIPS32_ADDI(11,11,4), 								/* $11 += 4 */
+		MIPS32_ADDI(10,10,NEG16(1)),						/* $10-- */
+		MIPS32_ADDI(9,9,4),									/* $1 += 4 */
+		MIPS32_ADDI(11,11,4),								/* $11 += 4 */
 
 		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
 															/* end: */
-		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
-		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
-		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
-		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_LW(11,0,15),									/* lw $11,($15) */
+		MIPS32_LW(10,0,15),									/* lw $10,($15) */
+		MIPS32_LW(9,0,15),									/* lw $9,($15) */
+		MIPS32_LW(8,0,15),									/* lw $8,($15) */
 		MIPS32_B(NEG16(27)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
 	};
@@ -358,16 +358,16 @@ int mips32_pracc_read_u32(struct mips_ejtag *ejtag_info, uint32_t addr, uint32_t
 	static const uint32_t code[] = {
 															/* start: */
 		MIPS32_MTC0(15,31,0),								/* move $15 to COP0 DeSave */
-		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)), 		/* $15 = MIPS32_PRACC_STACK */
+		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)),			/* $15 = MIPS32_PRACC_STACK */
 		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_STACK)),
-		MIPS32_SW(8,0,15), 									/* sw $8,($15) */
+		MIPS32_SW(8,0,15),									/* sw $8,($15) */
 
 		MIPS32_LW(8,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN),15), /* load R8 @ param_in[0] = address */
 
-		MIPS32_LW(8,0,8), 									/* lw $8,0($8), Load $8 with the word @mem[$8] */
+		MIPS32_LW(8,0,8),									/* lw $8,0($8), Load $8 with the word @mem[$8] */
 		MIPS32_SW(8,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_OUT),15), /* store R8 @ param_out[0] */
 
-		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_LW(8,0,15),									/* lw $8,($15) */
 		MIPS32_B(NEG16(9)),									/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
 	};
@@ -391,12 +391,12 @@ int mips32_pracc_read_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 	static const uint32_t code[] = {
 															/* start: */
 		MIPS32_MTC0(15,31,0),								/* move $15 to COP0 DeSave */
-		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)), 		/* $15 = MIPS32_PRACC_STACK */
+		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)),			/* $15 = MIPS32_PRACC_STACK */
 		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_STACK)),
-		MIPS32_SW(8,0,15), 									/* sw $8,($15) */
-		MIPS32_SW(9,0,15), 									/* sw $9,($15) */
-		MIPS32_SW(10,0,15), 								/* sw $10,($15) */
-		MIPS32_SW(11,0,15), 								/* sw $11,($15) */
+		MIPS32_SW(8,0,15),									/* sw $8,($15) */
+		MIPS32_SW(9,0,15),									/* sw $9,($15) */
+		MIPS32_SW(10,0,15),									/* sw $10,($15) */
+		MIPS32_SW(11,0,15),									/* sw $11,($15) */
 
 		MIPS32_LUI(8,UPPER16(MIPS32_PRACC_PARAM_IN)),		/* $8 = MIPS32_PRACC_PARAM_IN */
 		MIPS32_ORI(8,8,LOWER16(MIPS32_PRACC_PARAM_IN)),
@@ -405,22 +405,22 @@ int mips32_pracc_read_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LUI(11,UPPER16(MIPS32_PRACC_PARAM_OUT)),		/* $11 = MIPS32_PRACC_PARAM_OUT */
 		MIPS32_ORI(11,11,LOWER16(MIPS32_PRACC_PARAM_OUT)),
 															/* loop: */
-		MIPS32_BEQ(0,10,8), 								/* beq 0, $10, end */
+		MIPS32_BEQ(0,10,8),									/* beq 0, $10, end */
 		MIPS32_NOP,
 
-		MIPS32_LHU(8,0,9), 									/* lw $8,0($9), Load $8 with the halfword @mem[$9] */
-		MIPS32_SW(8,0,11), 									/* sw $8,0($11) */
+		MIPS32_LHU(8,0,9),									/* lw $8,0($9), Load $8 with the halfword @mem[$9] */
+		MIPS32_SW(8,0,11),									/* sw $8,0($11) */
 
-		MIPS32_ADDI(10,10,NEG16(1)), 						/* $10-- */
-		MIPS32_ADDI(9,9,2), 								/* $9 += 2 */
-		MIPS32_ADDI(11,11,4), 								/* $11 += 4 */
+		MIPS32_ADDI(10,10,NEG16(1)),						/* $10-- */
+		MIPS32_ADDI(9,9,2),									/* $9 += 2 */
+		MIPS32_ADDI(11,11,4),								/* $11 += 4 */
 		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
 															/* end: */
-		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
-		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
-		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
-		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_LW(11,0,15),									/* lw $11,($15) */
+		MIPS32_LW(10,0,15),									/* lw $10,($15) */
+		MIPS32_LW(9,0,15),									/* lw $9,($15) */
+		MIPS32_LW(8,0,15),									/* lw $8,($15) */
 		MIPS32_B(NEG16(27)),								/* b start */
 		MIPS32_MFC0(15,30,0),								/* move COP0 DeSave to $15 */
 	};
@@ -468,36 +468,36 @@ int mips32_pracc_read_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int cou
 	static const uint32_t code[] = {
 															/* start: */
 		MIPS32_MTC0(15,31,0),								/* move $15 to COP0 DeSave */
-		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)), 		/* $15 = MIPS32_PRACC_STACK */
+		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)),			/* $15 = MIPS32_PRACC_STACK */
 		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_STACK)),
-		MIPS32_SW(8,0,15), 									/* sw $8,($15) */
-		MIPS32_SW(9,0,15), 									/* sw $9,($15) */
-		MIPS32_SW(10,0,15), 								/* sw $10,($15) */
-		MIPS32_SW(11,0,15), 								/* sw $11,($15) */
+		MIPS32_SW(8,0,15),									/* sw $8,($15) */
+		MIPS32_SW(9,0,15),									/* sw $9,($15) */
+		MIPS32_SW(10,0,15),									/* sw $10,($15) */
+		MIPS32_SW(11,0,15),									/* sw $11,($15) */
 
-		MIPS32_LUI(8,UPPER16(MIPS32_PRACC_PARAM_IN)), 		/* $8 = MIPS32_PRACC_PARAM_IN */
+		MIPS32_LUI(8,UPPER16(MIPS32_PRACC_PARAM_IN)),		/* $8 = MIPS32_PRACC_PARAM_IN */
 		MIPS32_ORI(8,8,LOWER16(MIPS32_PRACC_PARAM_IN)),
-		MIPS32_LW(9,0,8), 									/* $9 = mem[$8]; read addr */
-		MIPS32_LW(10,4,8), 									/* $10 = mem[$8 + 4]; read count */
-		MIPS32_LUI(11,UPPER16(MIPS32_PRACC_PARAM_OUT)), 	/* $11 = MIPS32_PRACC_PARAM_OUT */
+		MIPS32_LW(9,0,8),									/* $9 = mem[$8]; read addr */
+		MIPS32_LW(10,4,8),									/* $10 = mem[$8 + 4]; read count */
+		MIPS32_LUI(11,UPPER16(MIPS32_PRACC_PARAM_OUT)),		/* $11 = MIPS32_PRACC_PARAM_OUT */
 		MIPS32_ORI(11,11,LOWER16(MIPS32_PRACC_PARAM_OUT)),
 															/* loop: */
-		MIPS32_BEQ(0,10,8), 								/* beq 0, $10, end */
+		MIPS32_BEQ(0,10,8),									/* beq 0, $10, end */
 		MIPS32_NOP,
 
-		MIPS32_LBU(8,0,9), 									/* lw $8,0($9), Load t4 with the byte @mem[t1] */
-		MIPS32_SW(8,0,11), 									/* sw $8,0($11) */
+		MIPS32_LBU(8,0,9),									/* lw $8,0($9), Load t4 with the byte @mem[t1] */
+		MIPS32_SW(8,0,11),									/* sw $8,0($11) */
 
-		MIPS32_ADDI(10,10,NEG16(1)), 						/* $10-- */
-		MIPS32_ADDI(9,9,1), 								/* $9 += 1 */
-		MIPS32_ADDI(11,11,4), 								/* $11 += 4 */
+		MIPS32_ADDI(10,10,NEG16(1)),						/* $10-- */
+		MIPS32_ADDI(9,9,1),									/* $9 += 1 */
+		MIPS32_ADDI(11,11,4),								/* $11 += 4 */
 		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
 															/* end: */
-		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
-		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
-		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
-		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_LW(11,0,15),									/* lw $11,($15) */
+		MIPS32_LW(10,0,15),									/* lw $10,($15) */
+		MIPS32_LW(9,0,15),									/* lw $9,($15) */
+		MIPS32_LW(8,0,15),									/* lw $8,($15) */
 		MIPS32_B(NEG16(27)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
 	};
@@ -563,31 +563,31 @@ int mips32_pracc_write_mem32(struct mips_ejtag *ejtag_info, uint32_t addr, int c
 	static const uint32_t code[] = {
 															/* start: */
 		MIPS32_MTC0(15,31,0),								/* move $15 to COP0 DeSave */
-		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)), 		/* $15 = MIPS32_PRACC_STACK */
+		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)),			/* $15 = MIPS32_PRACC_STACK */
 		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_STACK)),
-		MIPS32_SW(8,0,15), 									/* sw $8,($15) */
-		MIPS32_SW(9,0,15), 									/* sw $9,($15) */
-		MIPS32_SW(10,0,15), 								/* sw $10,($15) */
-		MIPS32_SW(11,0,15), 								/* sw $11,($15) */
+		MIPS32_SW(8,0,15),									/* sw $8,($15) */
+		MIPS32_SW(9,0,15),									/* sw $9,($15) */
+		MIPS32_SW(10,0,15),									/* sw $10,($15) */
+		MIPS32_SW(11,0,15),									/* sw $11,($15) */
 
 		MIPS32_ADDI(8,15,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN)),  /* $8= MIPS32_PRACC_PARAM_IN */
-		MIPS32_LW(9,0,8), 									/* Load write addr to $9 */
+		MIPS32_LW(9,0,8),									/* Load write addr to $9 */
 		MIPS32_LW(10,4,8),									/* Load write count to $10 */
 		MIPS32_ADDI(8,8,8),									/* $8 += 8 beginning of data */
 
 															/* loop: */
-		MIPS32_LW(11,0,8), 									/* lw $11,0($8), Load $11 with the word @mem[$8] */
-		MIPS32_SW(11,0,9), 									/* sw $11,0($9) */
+		MIPS32_LW(11,0,8),									/* lw $11,0($8), Load $11 with the word @mem[$8] */
+		MIPS32_SW(11,0,9),									/* sw $11,0($9) */
 
-		MIPS32_ADDI(9,9,4), 								/* $9 += 4 */
+		MIPS32_ADDI(9,9,4),									/* $9 += 4 */
 		MIPS32_BNE(10,9,NEG16(4)),							/* bne $10, $9, loop */
 		MIPS32_ADDI(8,8,4),									/* $8 += 4 */
 
 															/* end: */
-		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
-		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
-		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
-		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_LW(11,0,15),									/* lw $11,($15) */
+		MIPS32_LW(10,0,15),									/* lw $10,($15) */
+		MIPS32_LW(9,0,15),									/* lw $9,($15) */
+		MIPS32_LW(8,0,15),									/* lw $8,($15) */
 		MIPS32_B(NEG16(21)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
 	};
@@ -612,18 +612,18 @@ int mips32_pracc_write_u32(struct mips_ejtag *ejtag_info, uint32_t addr, uint32_
 	static const uint32_t code[] = {
 															/* start: */
 		MIPS32_MTC0(15,31,0),								/* move $15 to COP0 DeSave */
-		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)), 		/* $15 = MIPS32_PRACC_STACK */
+		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)),			/* $15 = MIPS32_PRACC_STACK */
 		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_STACK)),
-		MIPS32_SW(8,0,15), 									/* sw $8,($15) */
-		MIPS32_SW(9,0,15), 									/* sw $9,($15) */
+		MIPS32_SW(8,0,15),									/* sw $8,($15) */
+		MIPS32_SW(9,0,15),									/* sw $9,($15) */
 
 		MIPS32_LW(8,NEG16((MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN)-4), 15),	/* load R8 @ param_in[1] = data */
 		MIPS32_LW(9,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN), 15),		/* load R9 @ param_in[0] = address */
 
-		MIPS32_SW(8,0,9), 									/* sw $8,0($9) */
+		MIPS32_SW(8,0,9),									/* sw $8,0($9) */
 
-		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
-		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_LW(9,0,15),									/* lw $9,($15) */
+		MIPS32_LW(8,0,15),									/* lw $8,($15) */
 		MIPS32_B(NEG16(11)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
 	};
@@ -644,36 +644,36 @@ int mips32_pracc_write_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int c
 	static const uint32_t code[] = {
 															/* start: */
 		MIPS32_MTC0(15,31,0),								/* move $15 to COP0 DeSave */
-		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)), 		/* $15 = MIPS32_PRACC_STACK */
+		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)),			/* $15 = MIPS32_PRACC_STACK */
 		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_STACK)),
-		MIPS32_SW(8,0,15), 									/* sw $8,($15) */
-		MIPS32_SW(9,0,15), 									/* sw $9,($15) */
-		MIPS32_SW(10,0,15), 								/* sw $10,($15) */
-		MIPS32_SW(11,0,15), 								/* sw $11,($15) */
+		MIPS32_SW(8,0,15),									/* sw $8,($15) */
+		MIPS32_SW(9,0,15),									/* sw $9,($15) */
+		MIPS32_SW(10,0,15),									/* sw $10,($15) */
+		MIPS32_SW(11,0,15),									/* sw $11,($15) */
 
-		MIPS32_LUI(8,UPPER16(MIPS32_PRACC_PARAM_IN)), 		/* $8 = MIPS32_PRACC_PARAM_IN */
+		MIPS32_LUI(8,UPPER16(MIPS32_PRACC_PARAM_IN)),		/* $8 = MIPS32_PRACC_PARAM_IN */
 		MIPS32_ORI(8,8,LOWER16(MIPS32_PRACC_PARAM_IN)),
-		MIPS32_LW(9,0,8), 									/* Load write addr to $9 */
-		MIPS32_LW(10,4,8), 									/* Load write count to $10 */
-		MIPS32_ADDI(8,8,8), 								/* $8 += 8 */
+		MIPS32_LW(9,0,8),									/* Load write addr to $9 */
+		MIPS32_LW(10,4,8),									/* Load write count to $10 */
+		MIPS32_ADDI(8,8,8),									/* $8 += 8 */
 															/* loop: */
 		MIPS32_BEQ(0,10,8),									/* beq $0, $10, end */
 		MIPS32_NOP,
 
-		MIPS32_LW(11,0,8), 									/* lw $11,0($8), Load $11 with the word @mem[$8] */
-		MIPS32_SH(11,0,9), 									/* sh $11,0($9) */
+		MIPS32_LW(11,0,8),									/* lw $11,0($8), Load $11 with the word @mem[$8] */
+		MIPS32_SH(11,0,9),									/* sh $11,0($9) */
 
-		MIPS32_ADDI(10,10,NEG16(1)), 						/* $10-- */
-		MIPS32_ADDI(9,9,2), 								/* $9 += 2 */
-		MIPS32_ADDI(8,8,4), 								/* $8 += 4 */
+		MIPS32_ADDI(10,10,NEG16(1)),						/* $10-- */
+		MIPS32_ADDI(9,9,2),									/* $9 += 2 */
+		MIPS32_ADDI(8,8,4),									/* $8 += 4 */
 
 		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
 															/* end: */
-		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
-		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
-		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
-		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_LW(11,0,15),									/* lw $11,($15) */
+		MIPS32_LW(10,0,15),									/* lw $10,($15) */
+		MIPS32_LW(9,0,15),									/* lw $9,($15) */
+		MIPS32_LW(8,0,15),									/* lw $8,($15) */
 		MIPS32_B(NEG16(26)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
 	};
@@ -702,36 +702,36 @@ int mips32_pracc_write_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 	static const uint32_t code[] = {
 															/* start: */
 		MIPS32_MTC0(15,31,0),								/* move $15 to COP0 DeSave */
-		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)), 		/* $15 = MIPS32_PRACC_STACK */
+		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)),			/* $15 = MIPS32_PRACC_STACK */
 		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_STACK)),
-		MIPS32_SW(8,0,15), 									/* sw $8,($15) */
-		MIPS32_SW(9,0,15), 									/* sw $9,($15) */
-		MIPS32_SW(10,0,15), 								/* sw $10,($15) */
-		MIPS32_SW(11,0,15), 								/* sw $11,($15) */
+		MIPS32_SW(8,0,15),									/* sw $8,($15) */
+		MIPS32_SW(9,0,15),									/* sw $9,($15) */
+		MIPS32_SW(10,0,15),									/* sw $10,($15) */
+		MIPS32_SW(11,0,15),									/* sw $11,($15) */
 
-		MIPS32_LUI(8,UPPER16(MIPS32_PRACC_PARAM_IN)), 		/* $8 = MIPS32_PRACC_PARAM_IN */
+		MIPS32_LUI(8,UPPER16(MIPS32_PRACC_PARAM_IN)),		/* $8 = MIPS32_PRACC_PARAM_IN */
 		MIPS32_ORI(8,8,LOWER16(MIPS32_PRACC_PARAM_IN)),
-		MIPS32_LW(9,0,8), 									/* Load write addr to $9 */
-		MIPS32_LW(10,4,8), 									/* Load write count to $10 */
-		MIPS32_ADDI(8,8,8), 								/* $8 += 8 */
+		MIPS32_LW(9,0,8),									/* Load write addr to $9 */
+		MIPS32_LW(10,4,8),									/* Load write count to $10 */
+		MIPS32_ADDI(8,8,8),									/* $8 += 8 */
 															/* loop: */
 		MIPS32_BEQ(0,10,8),									/* beq $0, $10, end */
 		MIPS32_NOP,
 
-		MIPS32_LW(11,0,8), 									/* lw $11,0($8), Load $11 with the word @mem[$8] */
-		MIPS32_SB(11,0,9), 									/* sb $11,0($9) */
+		MIPS32_LW(11,0,8),									/* lw $11,0($8), Load $11 with the word @mem[$8] */
+		MIPS32_SB(11,0,9),									/* sb $11,0($9) */
 
-		MIPS32_ADDI(10,10,NEG16(1)), 						/* $10-- */
-		MIPS32_ADDI(9,9,1), 								/* $9 += 1 */
-		MIPS32_ADDI(8,8,4), 								/* $8 += 4 */
+		MIPS32_ADDI(10,10,NEG16(1)),						/* $10-- */
+		MIPS32_ADDI(9,9,1),									/* $9 += 1 */
+		MIPS32_ADDI(8,8,4),									/* $8 += 4 */
 
 		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
 															/* end: */
-		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
-		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
-		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
-		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_LW(11,0,15),									/* lw $11,($15) */
+		MIPS32_LW(10,0,15),									/* lw $10,($15) */
+		MIPS32_LW(9,0,15),									/* lw $9,($15) */
+		MIPS32_LW(8,0,15),									/* lw $8,($15) */
 		MIPS32_B(NEG16(26)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
 	};
@@ -760,60 +760,60 @@ int mips32_pracc_write_regs(struct mips_ejtag *ejtag_info, uint32_t *regs)
 {
 	static const uint32_t code[] = {
 														/* start: */
-		MIPS32_LUI(2,UPPER16(MIPS32_PRACC_PARAM_IN)), 	/* $2 = MIPS32_PRACC_PARAM_IN */
+		MIPS32_LUI(2,UPPER16(MIPS32_PRACC_PARAM_IN)),	/* $2 = MIPS32_PRACC_PARAM_IN */
 		MIPS32_ORI(2,2,LOWER16(MIPS32_PRACC_PARAM_IN)),
-		MIPS32_LW(1,1*4,2), 							/* lw $1,1*4($2) */
-		MIPS32_LW(15,15*4,2), 							/* lw $15,15*4($2) */
+		MIPS32_LW(1,1*4,2),								/* lw $1,1*4($2) */
+		MIPS32_LW(15,15*4,2),							/* lw $15,15*4($2) */
 		MIPS32_MTC0(15,31,0),							/* move $15 to COP0 DeSave */
-		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)), 	/* $15 = MIPS32_PRACC_STACK */
+		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)),		/* $15 = MIPS32_PRACC_STACK */
 		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_STACK)),
-		MIPS32_SW(1,0,15), 								/* sw $1,($15) */
-		MIPS32_LUI(1,UPPER16(MIPS32_PRACC_PARAM_IN)), 	/* $1 = MIPS32_PRACC_PARAM_IN */
+		MIPS32_SW(1,0,15),								/* sw $1,($15) */
+		MIPS32_LUI(1,UPPER16(MIPS32_PRACC_PARAM_IN)),	/* $1 = MIPS32_PRACC_PARAM_IN */
 		MIPS32_ORI(1,1,LOWER16(MIPS32_PRACC_PARAM_IN)),
-		MIPS32_LW(3,3*4,1), 							/* lw $3,3*4($1) */
-		MIPS32_LW(4,4*4,1), 							/* lw $4,4*4($1) */
-		MIPS32_LW(5,5*4,1), 							/* lw $5,5*4($1) */
-		MIPS32_LW(6,6*4,1), 							/* lw $6,6*4($1) */
-		MIPS32_LW(7,7*4,1), 							/* lw $7,7*4($1) */
-		MIPS32_LW(8,8*4,1), 							/* lw $8,8*4($1) */
-		MIPS32_LW(9,9*4,1), 							/* lw $9,9*4($1) */
-		MIPS32_LW(10,10*4,1), 							/* lw $10,10*4($1) */
-		MIPS32_LW(11,11*4,1), 							/* lw $11,11*4($1) */
-		MIPS32_LW(12,12*4,1), 							/* lw $12,12*4($1) */
-		MIPS32_LW(13,13*4,1), 							/* lw $13,13*4($1) */
-		MIPS32_LW(14,14*4,1), 							/* lw $14,14*4($1) */
-		MIPS32_LW(16,16*4,1), 							/* lw $16,16*4($1) */
-		MIPS32_LW(17,17*4,1), 							/* lw $17,17*4($1) */
-		MIPS32_LW(18,18*4,1), 							/* lw $18,18*4($1) */
-		MIPS32_LW(19,19*4,1), 							/* lw $19,19*4($1) */
-		MIPS32_LW(20,20*4,1), 							/* lw $20,20*4($1) */
-		MIPS32_LW(21,21*4,1), 							/* lw $21,21*4($1) */
-		MIPS32_LW(22,22*4,1), 							/* lw $22,22*4($1) */
-		MIPS32_LW(23,23*4,1), 							/* lw $23,23*4($1) */
-		MIPS32_LW(24,24*4,1), 							/* lw $24,24*4($1) */
-		MIPS32_LW(25,25*4,1), 							/* lw $25,25*4($1) */
-		MIPS32_LW(26,26*4,1), 							/* lw $26,26*4($1) */
-		MIPS32_LW(27,27*4,1), 							/* lw $27,27*4($1) */
-		MIPS32_LW(28,28*4,1), 							/* lw $28,28*4($1) */
-		MIPS32_LW(29,29*4,1), 							/* lw $29,29*4($1) */
-		MIPS32_LW(30,30*4,1), 							/* lw $30,30*4($1) */
-		MIPS32_LW(31,31*4,1), 							/* lw $31,31*4($1) */
-
-		MIPS32_LW(2,32*4,1), 							/* lw $2,32*4($1) */
+		MIPS32_LW(3,3*4,1),								/* lw $3,3*4($1) */
+		MIPS32_LW(4,4*4,1),								/* lw $4,4*4($1) */
+		MIPS32_LW(5,5*4,1),								/* lw $5,5*4($1) */
+		MIPS32_LW(6,6*4,1),								/* lw $6,6*4($1) */
+		MIPS32_LW(7,7*4,1),								/* lw $7,7*4($1) */
+		MIPS32_LW(8,8*4,1),								/* lw $8,8*4($1) */
+		MIPS32_LW(9,9*4,1),								/* lw $9,9*4($1) */
+		MIPS32_LW(10,10*4,1),							/* lw $10,10*4($1) */
+		MIPS32_LW(11,11*4,1),							/* lw $11,11*4($1) */
+		MIPS32_LW(12,12*4,1),							/* lw $12,12*4($1) */
+		MIPS32_LW(13,13*4,1),							/* lw $13,13*4($1) */
+		MIPS32_LW(14,14*4,1),							/* lw $14,14*4($1) */
+		MIPS32_LW(16,16*4,1),							/* lw $16,16*4($1) */
+		MIPS32_LW(17,17*4,1),							/* lw $17,17*4($1) */
+		MIPS32_LW(18,18*4,1),							/* lw $18,18*4($1) */
+		MIPS32_LW(19,19*4,1),							/* lw $19,19*4($1) */
+		MIPS32_LW(20,20*4,1),							/* lw $20,20*4($1) */
+		MIPS32_LW(21,21*4,1),							/* lw $21,21*4($1) */
+		MIPS32_LW(22,22*4,1),							/* lw $22,22*4($1) */
+		MIPS32_LW(23,23*4,1),							/* lw $23,23*4($1) */
+		MIPS32_LW(24,24*4,1),							/* lw $24,24*4($1) */
+		MIPS32_LW(25,25*4,1),							/* lw $25,25*4($1) */
+		MIPS32_LW(26,26*4,1),							/* lw $26,26*4($1) */
+		MIPS32_LW(27,27*4,1),							/* lw $27,27*4($1) */
+		MIPS32_LW(28,28*4,1),							/* lw $28,28*4($1) */
+		MIPS32_LW(29,29*4,1),							/* lw $29,29*4($1) */
+		MIPS32_LW(30,30*4,1),							/* lw $30,30*4($1) */
+		MIPS32_LW(31,31*4,1),							/* lw $31,31*4($1) */
+
+		MIPS32_LW(2,32*4,1),							/* lw $2,32*4($1) */
 		MIPS32_MTC0(2,12,0),							/* move $2 to status */
-		MIPS32_LW(2,33*4,1), 							/* lw $2,33*4($1) */
+		MIPS32_LW(2,33*4,1),							/* lw $2,33*4($1) */
 		MIPS32_MTLO(2),									/* move $2 to lo */
-		MIPS32_LW(2,34*4,1), 							/* lw $2,34*4($1) */
+		MIPS32_LW(2,34*4,1),							/* lw $2,34*4($1) */
 		MIPS32_MTHI(2),									/* move $2 to hi */
-		MIPS32_LW(2,35*4,1), 							/* lw $2,35*4($1) */
+		MIPS32_LW(2,35*4,1),							/* lw $2,35*4($1) */
 		MIPS32_MTC0(2,8,0),								/* move $2 to badvaddr */
-		MIPS32_LW(2,36*4,1), 							/* lw $2,36*4($1) */
+		MIPS32_LW(2,36*4,1),							/* lw $2,36*4($1) */
 		MIPS32_MTC0(2,13,0),							/* move $2 to cause*/
-		MIPS32_LW(2,37*4,1), 							/* lw $2,37*4($1) */
+		MIPS32_LW(2,37*4,1),							/* lw $2,37*4($1) */
 		MIPS32_MTC0(2,24,0),							/* move $2 to pc */
 
-		MIPS32_LW(2,2*4,1), 							/* lw $2,2*4($1) */
-		MIPS32_LW(1,0,15), 								/* lw $1,($15) */
+		MIPS32_LW(2,2*4,1),								/* lw $2,2*4($1) */
+		MIPS32_LW(1,0,15),								/* lw $1,($15) */
 		MIPS32_B(NEG16(53)),							/* b start */
 		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
 	};
@@ -831,64 +831,64 @@ int mips32_pracc_read_regs(struct mips_ejtag *ejtag_info, uint32_t *regs)
 	static const uint32_t code[] = {
 														/* start: */
 		MIPS32_MTC0(2,31,0),							/* move $2 to COP0 DeSave */
-		MIPS32_LUI(2,UPPER16(MIPS32_PRACC_PARAM_OUT)), 	/* $2 = MIPS32_PRACC_PARAM_OUT */
+		MIPS32_LUI(2,UPPER16(MIPS32_PRACC_PARAM_OUT)),	/* $2 = MIPS32_PRACC_PARAM_OUT */
 		MIPS32_ORI(2,2,LOWER16(MIPS32_PRACC_PARAM_OUT)),
 		MIPS32_SW(0,0*4,2),								/* sw $0,0*4($2) */
-		MIPS32_SW(1,1*4,2), 							/* sw $1,1*4($2) */
-		MIPS32_SW(15,15*4,2), 							/* sw $15,15*4($2) */
+		MIPS32_SW(1,1*4,2),								/* sw $1,1*4($2) */
+		MIPS32_SW(15,15*4,2),							/* sw $15,15*4($2) */
 		MIPS32_MFC0(2,31,0),							/* move COP0 DeSave to $2 */
 		MIPS32_MTC0(15,31,0),							/* move $15 to COP0 DeSave */
-		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)), 	/* $15 = MIPS32_PRACC_STACK */
+		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)),		/* $15 = MIPS32_PRACC_STACK */
 		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_STACK)),
-		MIPS32_SW(1,0,15), 								/* sw $1,($15) */
-		MIPS32_SW(2,0,15), 								/* sw $2,($15) */
-		MIPS32_LUI(1,UPPER16(MIPS32_PRACC_PARAM_OUT)), 	/* $1 = MIPS32_PRACC_PARAM_OUT */
+		MIPS32_SW(1,0,15),								/* sw $1,($15) */
+		MIPS32_SW(2,0,15),								/* sw $2,($15) */
+		MIPS32_LUI(1,UPPER16(MIPS32_PRACC_PARAM_OUT)),	/* $1 = MIPS32_PRACC_PARAM_OUT */
 		MIPS32_ORI(1,1,LOWER16(MIPS32_PRACC_PARAM_OUT)),
-		MIPS32_SW(2,2*4,1), 							/* sw $2,2*4($1) */
-		MIPS32_SW(3,3*4,1), 							/* sw $3,3*4($1) */
-		MIPS32_SW(4,4*4,1), 							/* sw $4,4*4($1) */
-		MIPS32_SW(5,5*4,1), 							/* sw $5,5*4($1) */
-		MIPS32_SW(6,6*4,1), 							/* sw $6,6*4($1) */
-		MIPS32_SW(7,7*4,1), 							/* sw $7,7*4($1) */
-		MIPS32_SW(8,8*4,1), 							/* sw $8,8*4($1) */
-		MIPS32_SW(9,9*4,1), 							/* sw $9,9*4($1) */
-		MIPS32_SW(10,10*4,1), 							/* sw $10,10*4($1) */
-		MIPS32_SW(11,11*4,1), 							/* sw $11,11*4($1) */
-		MIPS32_SW(12,12*4,1), 							/* sw $12,12*4($1) */
-		MIPS32_SW(13,13*4,1), 							/* sw $13,13*4($1) */
-		MIPS32_SW(14,14*4,1), 							/* sw $14,14*4($1) */
-		MIPS32_SW(16,16*4,1), 							/* sw $16,16*4($1) */
-		MIPS32_SW(17,17*4,1), 							/* sw $17,17*4($1) */
-		MIPS32_SW(18,18*4,1), 							/* sw $18,18*4($1) */
-		MIPS32_SW(19,19*4,1), 							/* sw $19,19*4($1) */
-		MIPS32_SW(20,20*4,1), 							/* sw $20,20*4($1) */
-		MIPS32_SW(21,21*4,1), 							/* sw $21,21*4($1) */
-		MIPS32_SW(22,22*4,1), 							/* sw $22,22*4($1) */
-		MIPS32_SW(23,23*4,1), 							/* sw $23,23*4($1) */
-		MIPS32_SW(24,24*4,1), 							/* sw $24,24*4($1) */
-		MIPS32_SW(25,25*4,1), 							/* sw $25,25*4($1) */
-		MIPS32_SW(26,26*4,1), 							/* sw $26,26*4($1) */
-		MIPS32_SW(27,27*4,1), 							/* sw $27,27*4($1) */
-		MIPS32_SW(28,28*4,1), 							/* sw $28,28*4($1) */
-		MIPS32_SW(29,29*4,1), 							/* sw $29,29*4($1) */
-		MIPS32_SW(30,30*4,1), 							/* sw $30,30*4($1) */
-		MIPS32_SW(31,31*4,1), 							/* sw $31,31*4($1) */
+		MIPS32_SW(2,2*4,1),								/* sw $2,2*4($1) */
+		MIPS32_SW(3,3*4,1),								/* sw $3,3*4($1) */
+		MIPS32_SW(4,4*4,1),								/* sw $4,4*4($1) */
+		MIPS32_SW(5,5*4,1),								/* sw $5,5*4($1) */
+		MIPS32_SW(6,6*4,1),								/* sw $6,6*4($1) */
+		MIPS32_SW(7,7*4,1),								/* sw $7,7*4($1) */
+		MIPS32_SW(8,8*4,1),								/* sw $8,8*4($1) */
+		MIPS32_SW(9,9*4,1),								/* sw $9,9*4($1) */
+		MIPS32_SW(10,10*4,1),							/* sw $10,10*4($1) */
+		MIPS32_SW(11,11*4,1),							/* sw $11,11*4($1) */
+		MIPS32_SW(12,12*4,1),							/* sw $12,12*4($1) */
+		MIPS32_SW(13,13*4,1),							/* sw $13,13*4($1) */
+		MIPS32_SW(14,14*4,1),							/* sw $14,14*4($1) */
+		MIPS32_SW(16,16*4,1),							/* sw $16,16*4($1) */
+		MIPS32_SW(17,17*4,1),							/* sw $17,17*4($1) */
+		MIPS32_SW(18,18*4,1),							/* sw $18,18*4($1) */
+		MIPS32_SW(19,19*4,1),							/* sw $19,19*4($1) */
+		MIPS32_SW(20,20*4,1),							/* sw $20,20*4($1) */
+		MIPS32_SW(21,21*4,1),							/* sw $21,21*4($1) */
+		MIPS32_SW(22,22*4,1),							/* sw $22,22*4($1) */
+		MIPS32_SW(23,23*4,1),							/* sw $23,23*4($1) */
+		MIPS32_SW(24,24*4,1),							/* sw $24,24*4($1) */
+		MIPS32_SW(25,25*4,1),							/* sw $25,25*4($1) */
+		MIPS32_SW(26,26*4,1),							/* sw $26,26*4($1) */
+		MIPS32_SW(27,27*4,1),							/* sw $27,27*4($1) */
+		MIPS32_SW(28,28*4,1),							/* sw $28,28*4($1) */
+		MIPS32_SW(29,29*4,1),							/* sw $29,29*4($1) */
+		MIPS32_SW(30,30*4,1),							/* sw $30,30*4($1) */
+		MIPS32_SW(31,31*4,1),							/* sw $31,31*4($1) */
 
 		MIPS32_MFC0(2,12,0),							/* move status to $2 */
-		MIPS32_SW(2,32*4,1), 							/* sw $2,32*4($1) */
+		MIPS32_SW(2,32*4,1),							/* sw $2,32*4($1) */
 		MIPS32_MFLO(2),									/* move lo to $2 */
-		MIPS32_SW(2,33*4,1), 							/* sw $2,33*4($1) */
+		MIPS32_SW(2,33*4,1),							/* sw $2,33*4($1) */
 		MIPS32_MFHI(2),									/* move hi to $2 */
-		MIPS32_SW(2,34*4,1), 							/* sw $2,34*4($1) */
+		MIPS32_SW(2,34*4,1),							/* sw $2,34*4($1) */
 		MIPS32_MFC0(2,8,0),								/* move badvaddr to $2 */
-		MIPS32_SW(2,35*4,1), 							/* sw $2,35*4($1) */
+		MIPS32_SW(2,35*4,1),							/* sw $2,35*4($1) */
 		MIPS32_MFC0(2,13,0),							/* move cause to $2 */
-		MIPS32_SW(2,36*4,1), 							/* sw $2,36*4($1) */
+		MIPS32_SW(2,36*4,1),							/* sw $2,36*4($1) */
 		MIPS32_MFC0(2,24,0),							/* move pc to $2 */
-		MIPS32_SW(2,37*4,1), 							/* sw $2,37*4($1) */
+		MIPS32_SW(2,37*4,1),							/* sw $2,37*4($1) */
 
-		MIPS32_LW(2,0,15), 								/* lw $2,($15) */
-		MIPS32_LW(1,0,15), 								/* lw $1,($15) */
+		MIPS32_LW(2,0,15),								/* lw $2,($15) */
+		MIPS32_LW(1,0,15),								/* lw $1,($15) */
 		MIPS32_B(NEG16(58)),							/* b start */
 		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
 	};
diff --git a/src/target/mips32_pracc.h b/src/target/mips32_pracc.h
index a914686..f8b00d0 100644
--- a/src/target/mips32_pracc.h
+++ b/src/target/mips32_pracc.h
@@ -27,17 +27,17 @@
 
 #define MIPS32_PRACC_FASTDATA_AREA		0xFF200000
 #define MIPS32_PRACC_FASTDATA_SIZE		16
-#define MIPS32_PRACC_TEXT			0xFF200200
-#define MIPS32_PRACC_STACK			0xFF204000
-#define MIPS32_PRACC_PARAM_IN		0xFF201000
-#define MIPS32_PRACC_PARAM_IN_SIZE	0x1000
-#define MIPS32_PRACC_PARAM_OUT		(MIPS32_PRACC_PARAM_IN + MIPS32_PRACC_PARAM_IN_SIZE)
-#define MIPS32_PRACC_PARAM_OUT_SIZE	0x1000
+#define MIPS32_PRACC_TEXT				0xFF200200
+#define MIPS32_PRACC_STACK				0xFF204000
+#define MIPS32_PRACC_PARAM_IN			0xFF201000
+#define MIPS32_PRACC_PARAM_IN_SIZE		0x1000
+#define MIPS32_PRACC_PARAM_OUT			(MIPS32_PRACC_PARAM_IN + MIPS32_PRACC_PARAM_IN_SIZE)
+#define MIPS32_PRACC_PARAM_OUT_SIZE		0x1000
 
 #define MIPS32_FASTDATA_HANDLER_SIZE	0x80
-#define UPPER16(uint32_t) (uint32_t >> 16)
-#define LOWER16(uint32_t) (uint32_t & 0xFFFF)
-#define NEG16(v) (((~(v)) + 1) & 0xFFFF)
+#define UPPER16(uint32_t) 				(uint32_t >> 16)
+#define LOWER16(uint32_t) 				(uint32_t & 0xFFFF)
+#define NEG16(v) 						(((~(v)) + 1) & 0xFFFF)
 /*#define NEG18(v) (((~(v)) + 1) & 0x3FFFF)*/
 
 int mips32_pracc_read_mem(struct mips_ejtag *ejtag_info,
diff --git a/src/target/mips_ejtag.c b/src/target/mips_ejtag.c
index bebad9a..58bd392 100644
--- a/src/target/mips_ejtag.c
+++ b/src/target/mips_ejtag.c
@@ -28,7 +28,6 @@
 #include "mips32.h"
 #include "mips_ejtag.h"
 
-
 int mips_ejtag_set_instr(struct mips_ejtag *ejtag_info, int new_instr, void *delete_me_and_submit_patch)
 {
 	struct jtag_tap *tap;
@@ -152,12 +151,12 @@ int mips_ejtag_step_disable(struct mips_ejtag *ejtag_info)
 {
 	uint32_t code[] = {
 			MIPS32_MTC0(15,31,0),							/* move $15 to COP0 DeSave */
-			MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)), 	/* $15 = MIPS32_PRACC_STACK */
+			MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)),		/* $15 = MIPS32_PRACC_STACK */
 			MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_STACK)),
-			MIPS32_SW(1,0,15), 								/* sw $1,($15) */
-			MIPS32_SW(2,0,15), 								/* sw $2,($15) */
+			MIPS32_SW(1,0,15),								/* sw $1,($15) */
+			MIPS32_SW(2,0,15),								/* sw $2,($15) */
 			MIPS32_MFC0(1,23,0),							/* move COP0 Debug to $1 */
-			MIPS32_LUI(2,0xFFFF), 							/* $2 = 0xfffffeff */
+			MIPS32_LUI(2,0xFFFF),							/* $2 = 0xfffffeff */
 			MIPS32_ORI(2,2,0xFEFF),
 			MIPS32_AND(1,1,2),
 			MIPS32_MTC0(1,23,0),							/* move $1 to COP0 Debug */
@@ -216,11 +215,11 @@ int mips_ejtag_read_debug(struct mips_ejtag *ejtag_info, uint32_t* debug_reg)
 	/* read ejtag ECR */
 	uint32_t code[] = {
 			MIPS32_MTC0(15,31,0),							/* move $15 to COP0 DeSave */
-			MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)), 	/* $15 = MIPS32_PRACC_STACK */
+			MIPS32_LUI(15,UPPER16(MIPS32_PRACC_STACK)),		/* $15 = MIPS32_PRACC_STACK */
 			MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_STACK)),
-			MIPS32_SW(1,0,15), 								/* sw $1,($15) */
-			MIPS32_SW(2,0,15), 								/* sw $2,($15) */
-			MIPS32_LUI(1,UPPER16(MIPS32_PRACC_PARAM_OUT)), 	/* $1 = MIPS32_PRACC_PARAM_OUT */
+			MIPS32_SW(1,0,15),								/* sw $1,($15) */
+			MIPS32_SW(2,0,15),								/* sw $2,($15) */
+			MIPS32_LUI(1,UPPER16(MIPS32_PRACC_PARAM_OUT)),	/* $1 = MIPS32_PRACC_PARAM_OUT */
 			MIPS32_ORI(1,1,LOWER16(MIPS32_PRACC_PARAM_OUT)),
 			MIPS32_MFC0(2,23,0),							/* move COP0 Debug to $2 */
 			MIPS32_SW(2,0,1),
diff --git a/src/target/mips_ejtag.h b/src/target/mips_ejtag.h
index eb42d67..e9da39e 100644
--- a/src/target/mips_ejtag.h
+++ b/src/target/mips_ejtag.h
@@ -96,11 +96,11 @@
 #define EJTAG_IBA1				0xFF301100
 #define EJTAG_DBS				0xFF302000
 #define EJTAG_DBA1				0xFF302100
-#define		EJTAG_DBCn_NOSB				(1 << 13)
-#define		EJTAG_DBCn_NOLB				(1 << 12)
-#define		EJTAG_DBCn_BLM_MASK			0xff
-#define		EJTAG_DBCn_BLM_SHIFT		4
-#define		EJTAG_DBCn_BE				(1 << 0)
+#define	EJTAG_DBCn_NOSB			(1 << 13)
+#define	EJTAG_DBCn_NOLB			(1 << 12)
+#define	EJTAG_DBCn_BLM_MASK		0xff
+#define	EJTAG_DBCn_BLM_SHIFT	4
+#define	EJTAG_DBCn_BE			(1 << 0)
 
 struct mips_ejtag
 {

commit 2d450b90333b01fbd85570e5d881c3a795038744
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Wed Jan 6 20:24:31 2010 +0000

    MIPS: fastdata bulk write fallback
    
    If fastdata access fails, then fallback to default mips_m4k_write_memory
    Remove unnecessary fastdata loader verify check
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/src/target/mips32_pracc.c b/src/target/mips32_pracc.c
index 26d5a6b..ac1d1b3 100644
--- a/src/target/mips32_pracc.c
+++ b/src/target/mips32_pracc.c
@@ -968,15 +968,7 @@ int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_are
 	/* write program into RAM */
 	mips32_pracc_write_mem32(ejtag_info, source->address, ARRAY_SIZE(handler_code), handler_code);
 
-	/* quick verify RAM is working */
-	mips32_pracc_read_u32(ejtag_info, source->address, &val);
-	if (val != handler_code[0])
-	{
-		LOG_ERROR("fastdata handler verify failed\n");
-		return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
-	}
-
-	LOG_INFO("%s using 0x%.8x for write handler\n", __func__, source->address);
+	LOG_DEBUG("%s using 0x%.8x for write handler\n", __func__, source->address);
 
 	jmp_code[1] |= UPPER16(source->address);
 	jmp_code[2] |= LOWER16(source->address);
diff --git a/src/target/mips_m4k.c b/src/target/mips_m4k.c
index 4adc1f1..312fc09 100644
--- a/src/target/mips_m4k.c
+++ b/src/target/mips_m4k.c
@@ -1001,6 +1001,12 @@ int mips_m4k_bulk_write_memory(struct target *target, uint32_t address, uint32_t
 	}
 
 	retval = mips32_pracc_fastdata_xfer(ejtag_info, source, write, address, count, (uint32_t*) buffer);
+	if (retval != ERROR_OK)
+	{
+		/* FASTDATA access failed, try normal memory write */
+		LOG_WARNING("Fastdata access Failed, falling back to non-bulk write");
+		retval = mips_m4k_write_memory(target, address, 4, count, buffer);
+	}
 
 	if (source)
 		target_free_working_area(target, source);

-----------------------------------------------------------------------

Summary of changes:
 src/target/mips32.h       |    2 +-
 src/target/mips32_pracc.c |  400 ++++++++++++++++++++++-----------------------
 src/target/mips32_pracc.h |   18 +-
 src/target/mips_ejtag.c   |   17 +-
 src/target/mips_ejtag.h   |   10 +-
 src/target/mips_m4k.c     |    6 +
 6 files changed, 225 insertions(+), 228 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Fri Jan  8 02:07:29 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Fri,  8 Jan 2010 01:07:29 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-69-g12c143d
Message-ID: <E1NT3K7-0004hx-2j@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  12c143d5948355b3b54c9c0decc779177b22d5d9 (commit)
       via  82c0fb527783a56f7cf82e21b85546b425378b00 (commit)
       via  e7965cd3eb6204e618f9555331b7172e3dba7df8 (commit)
       via  a42bea654ce1316dd521b1c9beffa8f829bf8be0 (commit)
       via  e0b6e5deef2d7b0054058116b6ddf9c684053739 (commit)
       via  199abf49ea02f03aedd1239b6ef3928d35f5dbb7 (commit)
       via  48d51e1719c2b48509786bba7c84c09d329929d3 (commit)
       via  17921f51abc4402c9c5aadf3e664eb37663f744f (commit)
       via  e19fe9ad09e28df1976257052afe6edf765aa778 (commit)
       via  dd8f679aa2ea447a96f393db3a8938259f63eebc (commit)
       via  7c3aee96b2f122fd16ec20e305cb16fe89180c9b (commit)
      from  991d030fcc9be971f29498ea7e1b3afbed05815b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 12c143d5948355b3b54c9c0decc779177b22d5d9
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 7 16:41:42 2010 -0800

    misc ARM help/usage updates
    
    Usage syntax messages have the same EBNF as the User's Guide;
    there should be no angle brackets in either place.
    
    Uupdate some helptext to be more accurate.
    
    Don't use "&function"; functions are like arrays, their address
    is their name.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm926ejs.c b/src/target/arm926ejs.c
index 4ac92a2..e099919 100644
--- a/src/target/arm926ejs.c
+++ b/src/target/arm926ejs.c
@@ -757,7 +757,7 @@ static int arm926ejs_mmu(struct target *target, int *enabled)
 static const struct command_registration arm926ejs_exec_command_handlers[] = {
 	{
 		.name = "cache_info",
-		.handler = &arm926ejs_handle_cache_info_command,
+		.handler = arm926ejs_handle_cache_info_command,
 		.mode = COMMAND_EXEC,
 		.help = "display information about target caches",
 
diff --git a/src/target/arm9tdmi.c b/src/target/arm9tdmi.c
index ae0c4e0..823e962 100644
--- a/src/target/arm9tdmi.c
+++ b/src/target/arm9tdmi.c
@@ -918,7 +918,9 @@ static const struct command_registration arm9tdmi_exec_command_handlers[] = {
 		.name = "vector_catch",
 		.handler = handle_arm9tdmi_catch_vectors_command,
 		.mode = COMMAND_EXEC,
-		.usage = "[all|none|reset|undef|swi|pabt|dabt|irq|fiq] ...",
+		.help = "Display, after optionally updating, configuration "
+			"of vector catch unit.",
+		.usage = "[all|none|(reset|undef|swi|pabt|dabt|irq|fiq)*]",
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/target/armv4_5.c b/src/target/armv4_5.c
index 1c4923b..c7b7367 100644
--- a/src/target/armv4_5.c
+++ b/src/target/armv4_5.c
@@ -928,22 +928,22 @@ static int jim_mcrmrc(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 static const struct command_registration arm_exec_command_handlers[] = {
 	{
 		.name = "reg",
-		.handler = &handle_armv4_5_reg_command,
+		.handler = handle_armv4_5_reg_command,
 		.mode = COMMAND_EXEC,
 		.help = "display ARM core registers",
 	},
 	{
 		.name = "core_state",
-		.handler = &handle_armv4_5_core_state_command,
+		.handler = handle_armv4_5_core_state_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<arm | thumb>",
+		.usage = "['arm'|'thumb']",
 		.help = "display/change ARM core state",
 	},
 	{
 		.name = "disassemble",
-		.handler = &handle_armv4_5_disassemble_command,
+		.handler = handle_armv4_5_disassemble_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<address> [<count> ['thumb']]",
+		.usage = "address [count ['thumb']]",
 		.help = "disassemble instructions ",
 	},
 	{

commit 82c0fb527783a56f7cf82e21b85546b425378b00
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 7 16:39:32 2010 -0800

    ARM966: help/usage updates
    
    Usage syntax messages have the same EBNF as the User's Guide;
    there should be no angle brackets in either place.
    
    Fix the User's Guide to say where the magic CP15 bits are defined;
    and add comments in case someone provides mcr/mrc methods.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 285603a..84bdb3c 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -6030,6 +6030,10 @@ and ARM9 commands.
 @deffn Command {arm966e cp15} regnum [value]
 Display cp15 register @var{regnum};
 else if a @var{value} is provided, that value is written to that register.
+The six bit @var{regnum} values are bits 37..32 from table 7-2 of the
+ARM966E-S TRM.
+There is no current control over bits 31..30 from that table,
+as required for BIST support.
 @end deffn
 
 @subsection XScale specific commands
diff --git a/src/target/arm966e.c b/src/target/arm966e.c
index 82be738..86af0f6 100644
--- a/src/target/arm966e.c
+++ b/src/target/arm966e.c
@@ -68,6 +68,13 @@ static int arm966e_verify_pointer(struct command_context *cmd_ctx,
 	return ERROR_OK;
 }
 
+/*
+ * REVISIT:  The "read_cp15" and "write_cp15" commands could hook up
+ * to eventual mrc() and mcr() routines ... the reg_addr values being
+ * constructed (for CP15 only) from Opcode_1, Opcode_2, and CRn values.
+ * See section 7.3 of the ARM966E-S TRM.
+ */
+
 static int arm966e_read_cp15(struct target *target, int reg_addr, uint32_t *value)
 {
 	int retval = ERROR_OK;
@@ -86,6 +93,9 @@ static int arm966e_read_cp15(struct target *target, int reg_addr, uint32_t *valu
 
 	fields[0].tap = jtag_info->tap;
 	fields[0].num_bits = 32;
+	/* REVISIT: table 7-2 shows that bits 31-31 need to be
+	 * specified for accessing BIST registers ...
+	 */
 	fields[0].out_value = NULL;
 	fields[0].in_value = NULL;
 
@@ -227,7 +237,7 @@ static const struct command_registration arm966e_exec_command_handlers[] = {
 		.name = "cp15",
 		.handler = arm966e_handle_cp15_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<opcode> [value]",
+		.usage = "regnum [value]",
 		.help = "display/modify cp15 register",
 	},
 	COMMAND_REGISTRATION_DONE

commit e7965cd3eb6204e618f9555331b7172e3dba7df8
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 7 16:34:44 2010 -0800

    Xscale: User's Guide updates
    
    Fix some EBNF goofs ... these commands have *optional* params, etc
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index bf7402d..285603a 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -6105,7 +6105,7 @@ else if a @var{value} is provided, that value is written to that register.
 Changes the address used for the specified target's debug handler.
 @end deffn
 
- at deffn Command {xscale dcache} (@option{enable}|@option{disable})
+ at deffn Command {xscale dcache} [@option{enable}|@option{disable}]
 Enables or disable the CPU's data cache.
 @end deffn
 
@@ -6113,17 +6113,18 @@ Enables or disable the CPU's data cache.
 Dumps the raw contents of the trace buffer to @file{filename}.
 @end deffn
 
- at deffn Command {xscale icache} (@option{enable}|@option{disable})
+ at deffn Command {xscale icache} [@option{enable}|@option{disable}]
 Enables or disable the CPU's instruction cache.
 @end deffn
 
- at deffn Command {xscale mmu} (@option{enable}|@option{disable})
+ at deffn Command {xscale mmu} [@option{enable}|@option{disable}]
 Enables or disable the CPU's memory management unit.
 @end deffn
 
- at deffn Command {xscale trace_buffer} (@option{enable}|@option{disable}) [@option{fill} [n] | @option{wrap}]
-Enables or disables the trace buffer,
-and controls how it is emptied.
+ at deffn Command {xscale trace_buffer} [@option{enable}|@option{disable} [@option{fill} [n] | @option{wrap}]]
+Displays the trace buffer status, after optionally
+enabling or disabling the trace buffer
+and modifying how it is emptied.
 @end deffn
 
 @deffn Command {xscale trace_image} filename [offset [type]]
@@ -6155,7 +6156,7 @@ The mask bits correspond with bit 16..23 in the DCSR:
 @end deffn
 
 @anchor{xscale vector_table}
- at deffn Command {xscale vector_table} [<low|high> <index> <value>]
+ at deffn Command {xscale vector_table} [(@option{low}|@option{high}) index value]
 @cindex vector_table
 
 Set an entry in the mini-IC vector table. There are two tables: one for

commit a42bea654ce1316dd521b1c9beffa8f829bf8be0
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 7 16:30:09 2010 -0800

    ARM720: help/usage updates
    
    Deprecate the "pass an instruction opcode" flavor of cp15
    access in favor of the "arm mcr ..." and "arm mrc ..."
    commands, which offer fewer ways to break things.
    
    Use the same EBNF syntax in the code as for the user's guide.
    
    Update User's Guide to say where to find those magic values
    (which table in the ARM920 TRM).
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index ea23bf7..bf7402d 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -5978,13 +5978,21 @@ is an ARM920T (2x16kByte cache) or ARM922T (2x8kByte cache).
 @deffn Command {arm920t cp15} regnum [value]
 Display cp15 register @var{regnum};
 else if a @var{value} is provided, that value is written to that register.
+This uses "physical access" and the register number is as
+shown in bits 38..33 of table 9-9 in the ARM920T TRM.
+(Not all registers can be written.)
 @end deffn
 
 @deffn Command {arm920t cp15i} opcode [value [address]]
-Interpreted access using cp15 @var{opcode}.
+ at emph{DEPRECATED -- avoid using this.
+Use the @command{arm mrc} or @command{arm mcr} commands instead.}
+
+Interpreted access using ARM instruction @var{opcode}, which should
+be the value of either an MRC or MCR instruction
+(as shown tables 9-11, 9-12, and 9-13 in the ARM920T TRM).
 If no @var{value} is provided, the result is displayed.
 Else if that value is written using the specified @var{address},
-or using zero if no other address is not provided.
+or using zero if no other address is provided.
 @end deffn
 
 @deffn Command {arm920t read_cache} filename
diff --git a/src/target/arm920t.c b/src/target/arm920t.c
index c5b7c88..29eb62d 100644
--- a/src/target/arm920t.c
+++ b/src/target/arm920t.c
@@ -1384,35 +1384,39 @@ static int arm920t_mcr(struct target *target, int cpnum,
 static const struct command_registration arm920t_exec_command_handlers[] = {
 	{
 		.name = "cp15",
-		.handler = &arm920t_handle_cp15_command,
+		.handler = arm920t_handle_cp15_command,
 		.mode = COMMAND_EXEC,
 		.help = "display/modify cp15 register",
-		.usage = "<num> [value]",
+		.usage = "regnum [value]",
 	},
 	{
 		.name = "cp15i",
-		.handler = &arm920t_handle_cp15i_command,
+		.handler = arm920t_handle_cp15i_command,
 		.mode = COMMAND_EXEC,
-		.help = "display/modify cp15 (interpreted access)",
-		.usage = "<opcode> [value] [address]",
+		/* prefer using less error-prone "arm mcr" or "arm mrc" */
+		.help = "display/modify cp15 register using ARM opcode"
+			" (DEPRECATED)",
+		.usage = "instruction [value [address]]",
 	},
 	{
 		.name = "cache_info",
-		.handler = &arm920t_handle_cache_info_command,
+		.handler = arm920t_handle_cache_info_command,
 		.mode = COMMAND_EXEC,
 		.help = "display information about target caches",
 	},
 	{
 		.name = "read_cache",
-		.handler = &arm920t_handle_read_cache_command,
+		.handler = arm920t_handle_read_cache_command,
 		.mode = COMMAND_EXEC,
-		.help = "display I/D cache content",
+		.help = "dump I/D cache content to file",
+		.usage = "filename",
 	},
 	{
 		.name = "read_mmu",
-		.handler = &arm920t_handle_read_mmu_command,
+		.handler = arm920t_handle_read_mmu_command,
 		.mode = COMMAND_EXEC,
-		.help = "display I/D mmu content",
+		.help = "dump I/D mmu content to file",
+		.usage = "filename",
 	},
 	COMMAND_REGISTRATION_DONE
 };

commit e0b6e5deef2d7b0054058116b6ddf9c684053739
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 7 16:25:03 2010 -0800

    ARM720: help/usage updates
    
    Deprecate the "pass an instruction opcode" flavor of cp15 access
    in favor of the "arm mcr ..." and "arm mrc ..." commands, which
    offer fewer ways to break things.
    
    Use the same EBNF syntax in the code as for the user's guide.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index a6fb970..ea23bf7 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -5921,9 +5921,13 @@ which are implementations of the ARMv4T architecture
 based on the ARM7TDMI-S integer core.
 They are available in addition to the ARM and ARM7/ARM9 commands.
 
- at deffn Command {arm720t cp15} regnum [value]
-Display cp15 register @var{regnum};
+ at deffn Command {arm720t cp15} opcode [value]
+ at emph{DEPRECATED -- avoid using this.
+Use the @command{arm mrc} or @command{arm mcr} commands instead.}
+
+Display cp15 register returned by the ARM instruction @var{opcode};
 else if a @var{value} is provided, that value is written to that register.
+The @var{opcode} should be the value of either an MRC or MCR instruction.
 @end deffn
 
 @subsection ARM9 specific commands
diff --git a/src/target/arm720t.c b/src/target/arm720t.c
index 84c66b8..2f51699 100644
--- a/src/target/arm720t.c
+++ b/src/target/arm720t.c
@@ -516,8 +516,10 @@ static const struct command_registration arm720t_exec_command_handlers[] = {
 		.name = "cp15",
 		.handler = arm720t_handle_cp15_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<opcode> [value]",
-		.help = "display/modify cp15 register",
+		/* prefer using less error-prone "arm mcr" or "arm mrc" */
+		.help = "display/modify cp15 register using ARM opcode"
+			" (DEPRECATED)",
+		.usage = "instruction [value]",
 	},
 	COMMAND_REGISTRATION_DONE
 };

commit 199abf49ea02f03aedd1239b6ef3928d35f5dbb7
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 7 16:21:10 2010 -0800

    ARM11: help/usage updates
    
    Usage syntax messages have the same EBNF as the User's Guide;
    there should be no angle brackets in either place.
    
    Uupdate some helptext to be more accurate.
    
    Fix the User's Guide in a few places to be more consistent (mostly
    to use brackets not parentheses) and to recognize that parameter may
    be entirely optional (in which case the command just displays output,
    and changes nothing).  Also reference NXP, not Philips, for LPC chips.
    
    Don't use "&function"; functions are like arrays, their address
    is their name.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index b91e754..a6fb970 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -6162,27 +6162,29 @@ Without arguments, the current settings are displayed.
 @subsection ARM11 specific commands
 @cindex ARM11
 
- at deffn Command {arm11 memwrite burst} [value]
+ at deffn Command {arm11 memwrite burst} [@option{enable}|@option{disable}]
 Displays the value of the memwrite burst-enable flag,
-which is enabled by default. Burst writes are only used
-for memory writes larger than 1 word. Single word writes
-are likely to be from reset init scripts and those writes
-are often to non-memory locations which could easily have
-many wait states, which could easily break burst writes.
-If @var{value} is defined, first assigns that.
+which is enabled by default.
+If a boolean parameter is provided, first assigns that flag.
+Burst writes are only used for memory writes larger than 1 word.
+They improve performance by assuming that the CPU has read each data
+word over JTAG and completed its write before the next word arrives,
+instead of polling for a status flag to verify that completion.
+This is usually safe, because JTAG runs much slower than the CPU.
 @end deffn
 
- at deffn Command {arm11 memwrite error_fatal} [value]
+ at deffn Command {arm11 memwrite error_fatal} [@option{enable}|@option{disable}]
 Displays the value of the memwrite error_fatal flag,
 which is enabled by default.
-If @var{value} is defined, first assigns that.
+If a boolean parameter is provided, first assigns that flag.
+When set, certain memory write errors cause earlier transfer termination.
 @end deffn
 
- at deffn Command {arm11 step_irq_enable}  [value]
+ at deffn Command {arm11 step_irq_enable} [@option{enable}|@option{disable}]
 Displays the value of the flag controlling whether
 IRQs are enabled during single stepping;
 they are disabled by default.
-If @var{value} is defined, first assigns that.
+If a boolean parameter is provided, first assigns that.
 @end deffn
 
 @deffn Command {arm11 vcr} [value]
diff --git a/src/target/arm11.c b/src/target/arm11.c
index 67a8409..082930a 100644
--- a/src/target/arm11.c
+++ b/src/target/arm11.c
@@ -1318,17 +1318,20 @@ COMMAND_HANDLER(arm11_handle_vcr)
 static const struct command_registration arm11_mw_command_handlers[] = {
 	{
 		.name = "burst",
-		.handler = &arm11_handle_bool_memwrite_burst,
+		.handler = arm11_handle_bool_memwrite_burst,
 		.mode = COMMAND_ANY,
-		.help = "Enable/Disable potentially risky fast burst mode"
-			" (default: enabled)",
+		.help = "Display or modify flag controlling potentially "
+			"risky fast burst mode (default: enabled)",
+		.usage = "['enable'|'disable']",
 	},
 	{
 		.name = "error_fatal",
-		.handler = &arm11_handle_bool_memwrite_error_fatal,
+		.handler = arm11_handle_bool_memwrite_error_fatal,
 		.mode = COMMAND_ANY,
-		.help = "Terminate program if transfer error was found"
+		.help = "Display or modify flag controlling transfer "
+			"termination on transfer errors"
 			" (default: enabled)",
+		.usage = "['enable'|'disable']",
 	},
 	COMMAND_REGISTRATION_DONE
 };
@@ -1338,11 +1341,11 @@ static const struct command_registration arm11_any_command_handlers[] = {
 		 * simulate + breakpoint implementation is broken.
 		 * TEMPORARY! NOT DOCUMENTED! */
 		.name = "hardware_step",
-		.handler = &arm11_handle_bool_hardware_step,
+		.handler = arm11_handle_bool_hardware_step,
 		.mode = COMMAND_ANY,
 		.help = "DEBUG ONLY - Hardware single stepping"
 			" (default: disabled)",
-		.usage = "(enable|disable)",
+		.usage = "['enable'|'disable']",
 	},
 	{
 		.name = "memwrite",
@@ -1352,16 +1355,18 @@ static const struct command_registration arm11_any_command_handlers[] = {
 	},
 	{
 		.name = "step_irq_enable",
-		.handler = &arm11_handle_bool_step_irq_enable,
+		.handler = arm11_handle_bool_step_irq_enable,
 		.mode = COMMAND_ANY,
-		.help = "Enable interrupts while stepping"
-			" (default: disabled)",
+		.help = "Display or modify flag controlling interrupt "
+			"enable while stepping (default: disabled)",
+		.usage = "['enable'|'disable']",
 	},
 	{
 		.name = "vcr",
-		.handler = &arm11_handle_vcr,
+		.handler = arm11_handle_vcr,
 		.mode = COMMAND_ANY,
-		.help = "Control (Interrupt) Vector Catch Register",
+		.help = "Display or modify Vector Catch Register",
+		.usage = "[value]",
 	},
 	COMMAND_REGISTRATION_DONE
 };

commit 48d51e1719c2b48509786bba7c84c09d329929d3
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 7 16:20:14 2010 -0800

    ARM7/ARM9: help/usage updates
    
    Provide helptext which was sometimes missing; update some of it
    to be more accurate.
    
    Usage syntax messages have the same EBNF as the User's Guide;
    there should be no angle brackets in either place.
    
    Fix the User's Guide in a few places to be more consistent (mostly
    to use brackets not parentheses) and to recognize that parameter may
    be entirely optional (in which case the command just displays output,
    and changes nothing).  Also reference NXP, not Philips, for LPC chips.
    
    Don't use "&function"; functions are like arrays, their address
    is their name.  Shrink some overlong lines.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 6057aad..b91e754 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -2501,7 +2501,7 @@ signal implementations.
 The default behaviour if no option given is @option{separate},
 indicating everything behaves normally.
 @option{srst_pulls_trst} states that the
-test logic is reset together with the reset of the system (e.g. Philips
+test logic is reset together with the reset of the system (e.g. NXP
 LPC2000, "broken" board layout), @option{trst_pulls_srst} says that
 the system is reset together with the test logic (only hypothetical, I
 haven't seen hardware with such a bug, and can be worked around).
@@ -5867,26 +5867,36 @@ ARM9TDMI, ARM920T or ARM926EJ-S.
 They are available in addition to the ARM commands,
 and any other core-specific commands that may be available.
 
- at deffn Command {arm7_9 dbgrq} (@option{enable}|@option{disable})
-Control use of the EmbeddedIce DBGRQ signal to force entry into debug mode,
-instead of breakpoints.  This should be
-safe for all but ARM7TDMI--S cores (like Philips LPC).
+ at deffn Command {arm7_9 dbgrq} [@option{enable}|@option{disable}]
+Displays the value of the flag controlling use of the
+the EmbeddedIce DBGRQ signal to force entry into debug mode,
+instead of breakpoints.
+If a boolean parameter is provided, first assigns that flag.
+
+This should be
+safe for all but ARM7TDMI-S cores (like NXP LPC).
 This feature is enabled by default on most ARM9 cores,
 including ARM9TDMI, ARM920T, and ARM926EJ-S.
 @end deffn
 
- at deffn Command {arm7_9 dcc_downloads} (@option{enable}|@option{disable})
+ at deffn Command {arm7_9 dcc_downloads} [@option{enable}|@option{disable}]
 @cindex DCC
-Control the use of the debug communications channel (DCC) to write larger (>128 byte)
-amounts of memory. DCC downloads offer a huge speed increase, but might be
+Displays the value of the flag controlling use of the debug communications
+channel (DCC) to write larger (>128 byte) amounts of memory.
+If a boolean parameter is provided, first assigns that flag.
+
+DCC downloads offer a huge speed increase, but might be
 unsafe, especially with targets running at very low speeds. This command was introduced
 with OpenOCD rev. 60, and requires a few bytes of working area.
 @end deffn
 
 @anchor{arm7_9 fast_memory_access}
- at deffn Command {arm7_9 fast_memory_access} (@option{enable}|@option{disable})
-Enable or disable memory writes and reads that don't check completion of
-the operation. This provides a huge speed increase, especially with USB JTAG
+ at deffn Command {arm7_9 fast_memory_access} [@option{enable}|@option{disable}]
+Displays the value of the flag controlling use of memory writes and reads
+that don't check completion of the operation.
+If a boolean parameter is provided, first assigns that flag.
+
+This provides a huge speed increase, especially with USB JTAG
 cables (FT2232), but might be unsafe if used with targets running at very low
 speeds, like the 32kHz startup clock of an AT91RM9200.
 @end deffn
diff --git a/src/target/arm7_9_common.c b/src/target/arm7_9_common.c
index a09b0ad..2f4c408 100644
--- a/src/target/arm7_9_common.c
+++ b/src/target/arm7_9_common.c
@@ -2864,32 +2864,32 @@ int arm7_9_init_arch_info(struct target *target, struct arm7_9_common *arm7_9)
 static const struct command_registration arm7_9_any_command_handlers[] = {
 	{
 		"dbgrq",
-		.handler = &handle_arm7_9_dbgrq_command,
+		.handler = handle_arm7_9_dbgrq_command,
 		.mode = COMMAND_ANY,
-		.usage = "<enable|disable>",
+		.usage = "['enable'|'disable']",
 		.help = "use EmbeddedICE dbgrq instead of breakpoint "
 			"for target halt requests",
 	},
 	{
 		"fast_memory_access",
-		.handler = &handle_arm7_9_fast_memory_access_command,
+		.handler = handle_arm7_9_fast_memory_access_command,
 		.mode = COMMAND_ANY,
-		.usage = "<enable|disable>",
+		.usage = "['enable'|'disable']",
 		.help = "use fast memory accesses instead of slower "
 			"but potentially safer accesses",
 	},
 	{
 		"dcc_downloads",
-		.handler = &handle_arm7_9_dcc_downloads_command,
+		.handler = handle_arm7_9_dcc_downloads_command,
 		.mode = COMMAND_ANY,
-		.usage = "<enable | disable>",
+		.usage = "['enable'|'disable']",
 		.help = "use DCC downloads for larger memory writes",
 	},
 	{
 		"semihosting",
-		.handler = &handle_arm7_9_semihosting_command,
+		.handler = handle_arm7_9_semihosting_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<enable | disable>",
+		.usage = "['enable'|'disable']",
 		.help = "activate support for semihosting operations",
 	},
 	COMMAND_REGISTRATION_DONE

commit 17921f51abc4402c9c5aadf3e664eb37663f744f
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 7 15:52:38 2010 -0800

    ARMv7: help/usage updates
    
    Provide helptext which was sometimes missing; update some of it
    to be more accurate.
    
    Usage syntax messages have the same EBNF as the User's Guide;
    there should be no angle brackets in either place.
    
    Don't use "&function"; functions are like arrays, their address
    is their name.  Shrink some overlong lines, remove some empties.
    
    Add a couple comments about things that should change:  those
    extra TCK cycles for MEM-AP reads are in the wrong place (that
    might explain some problems we've seen); the DAP command tables
    should be shared, not copied.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 3f5882c..6057aad 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -6198,26 +6198,28 @@ These commands are specific to ARM architecture v7 Debug Access Port (DAP),
 included on Cortex-M3 and Cortex-A8 systems.
 They are available in addition to other core-specific commands that may be available.
 
- at deffn Command {dap info} [num]
-Displays dap info for ap @var{num}, defaulting to the currently selected AP.
+ at deffn Command {dap apid} [num]
+Displays ID register from AP @var{num},
+defaulting to the currently selected AP.
 @end deffn
 
 @deffn Command {dap apsel} [num]
 Select AP @var{num}, defaulting to 0.
 @end deffn
 
- at deffn Command {dap apid} [num]
-Displays id register from AP @var{num},
+ at deffn Command {dap baseaddr} [num]
+Displays debug base address from MEM-AP @var{num},
 defaulting to the currently selected AP.
 @end deffn
 
- at deffn Command {dap baseaddr} [num]
-Displays debug base address from AP @var{num},
+ at deffn Command {dap info} [num]
+Displays the ROM table for MEM-AP @var{num},
 defaulting to the currently selected AP.
 @end deffn
 
 @deffn Command {dap memaccess} [value]
-Displays the number of extra tck for mem-ap memory bus access [0-255].
+Displays the number of extra tck cycles in the JTAG idle to use for MEM-AP
+memory bus access [0-255], giving additional time to respond to reads.
 If @var{value} is defined, first assigns that.
 @end deffn
 
diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 96accf3..e490f2e 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -101,6 +101,10 @@ static int adi_jtag_dp_scan(struct swjdp_common *swjdp,
 	arm_jtag_set_instr(jtag_info, instr, NULL);
 
 	/* Add specified number of tck clocks before accessing memory bus */
+
+	/* REVISIT these TCK cycles should be *AFTER*  updating APACC, since
+	 * they provide more time for the (MEM) AP to complete the read ...
+	 */
 	if ((instr == JTAG_DP_APACC)
 			&& ((reg_addr == AP_REG_DRW)
 				|| ((reg_addr & 0xF0) == AP_REG_BD0))
@@ -137,6 +141,10 @@ static int adi_jtag_dp_scan_u32(struct swjdp_common *swjdp,
 	arm_jtag_set_instr(jtag_info, instr, NULL);
 
 	/* Add specified number of tck clocks before accessing memory bus */
+
+	/* REVISIT these TCK cycles should be *AFTER*  updating APACC, since
+	 * they provide more time for the (MEM) AP to complete the read ...
+	 */
 	if ((instr == JTAG_DP_APACC)
 			&& ((reg_addr == AP_REG_DRW)
 				|| ((reg_addr & 0xF0) == AP_REG_BD0))
diff --git a/src/target/armv7a.c b/src/target/armv7a.c
index 31538c2..fe87fee 100644
--- a/src/target/armv7a.c
+++ b/src/target/armv7a.c
@@ -174,40 +174,49 @@ COMMAND_HANDLER(handle_dap_info_command)
 	return dap_info_command(CMD_CTX, swjdp, apsel);
 }
 
+/* FIXME this table should be part of generic DAP support, and
+ * be shared by the ARMv7-A/R and ARMv7-M support ...
+ */
 static const struct command_registration armv7a_exec_command_handlers[] = {
 	{
 		.name = "info",
-		.handler = &handle_dap_info_command,
+		.handler = handle_dap_info_command,
 		.mode = COMMAND_EXEC,
-		.help = "dap info for ap [num], "
-			"default currently selected AP",
+		.help = "display ROM table for MEM-AP "
+			"(default currently selected AP)",
+		.usage = "[ap_num]",
 	},
 	{
 		.name = "apsel",
-		.handler = &handle_dap_apsel_command,
+		.handler = handle_dap_apsel_command,
 		.mode = COMMAND_EXEC,
-		.help = "select a different AP [num] (default 0)",
+		.help = "Set the currently selected AP (default 0) "
+			"and display the result",
+		.usage = "[ap_num]",
 	},
 	{
 		.name = "apid",
-		.handler = &handle_dap_apid_command,
+		.handler = handle_dap_apid_command,
 		.mode = COMMAND_EXEC,
-		.help = "return id reg from AP [num], "
-			"default currently selected AP",
+		.help = "return ID register from AP "
+			"(default currently selected AP)",
+		.usage = "[ap_num]",
 	},
 	{
 		.name = "baseaddr",
-		.handler = &handle_dap_baseaddr_command,
+		.handler = handle_dap_baseaddr_command,
 		.mode = COMMAND_EXEC,
-		.help = "return debug base address from AP [num], "
-			"default currently selected AP",
+		.help = "return debug base address from MEM-AP "
+			"(default currently selected AP)",
+		.usage = "[ap_num]",
 	},
 	{
 		.name = "memaccess",
-		.handler = &handle_dap_memaccess_command,
+		.handler = handle_dap_memaccess_command,
 		.mode = COMMAND_EXEC,
-		.help = "set/get number of extra tck for mem-ap memory "
+		.help = "set/get number of extra tck for MEM-AP memory "
 			"bus access [0-255]",
+		.usage = "[cycles]",
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/target/armv7m.c b/src/target/armv7m.c
index 9d8132d..233fb95 100644
--- a/src/target/armv7m.c
+++ b/src/target/armv7m.c
@@ -799,40 +799,49 @@ COMMAND_HANDLER(handle_dap_info_command)
 	return dap_info_command(CMD_CTX, swjdp, apsel);
 }
 
+/* FIXME this table should be part of generic DAP support, and
+ * be shared by the ARMv7-A/R and ARMv7-M support ...
+ */
 static const struct command_registration armv7m_exec_command_handlers[] = {
 	{
 		.name = "info",
-		.handler = &handle_dap_info_command,
+		.handler = handle_dap_info_command,
 		.mode = COMMAND_EXEC,
-		.help = "dap info for ap [num], "
-			"default currently selected AP",
+		.help = "display ROM table for MEM-AP "
+			"(default currently selected AP)",
+		.usage = "[ap_num]",
 	},
 	{
 		.name = "apsel",
-		.handler = &handle_dap_apsel_command,
+		.handler = handle_dap_apsel_command,
 		.mode = COMMAND_EXEC,
-		.help = "select a different AP [num] (default 0)",
+		.help = "Set the currently selected AP (default 0) "
+			"and display the result",
+		.usage = "[ap_num]",
 	},
 	{
 		.name = "apid",
-		.handler = &handle_dap_apid_command,
+		.handler = handle_dap_apid_command,
 		.mode = COMMAND_EXEC,
-		.help = "return id reg from AP [num], "
-			"default currently selected AP",
+		.help = "return ID register from AP "
+			"(default currently selected AP)",
+		.usage = "[ap_num]",
 	},
 	{
 		.name = "baseaddr",
-		.handler = &handle_dap_baseaddr_command,
+		.handler = handle_dap_baseaddr_command,
 		.mode = COMMAND_EXEC,
-		.help = "return debug base address from AP [num], "
-			"default currently selected AP",
+		.help = "return debug base address from MEM-AP "
+			"(default currently selected AP)",
+		.usage = "[ap_num]",
 	},
 	{
 		.name = "memaccess",
-		.handler = &handle_dap_memaccess_command,
+		.handler = handle_dap_memaccess_command,
 		.mode = COMMAND_EXEC,
-		.help = "set/get number of extra tck for mem-ap memory "
+		.help = "set/get number of extra tck for MEM-AP memory "
 			"bus access [0-255]",
+		.usage = "[cycles]",
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/target/cortex_a8.c b/src/target/cortex_a8.c
index 424263d..18edd95 100644
--- a/src/target/cortex_a8.c
+++ b/src/target/cortex_a8.c
@@ -1642,13 +1642,13 @@ COMMAND_HANDLER(cortex_a8_handle_dbginit_command)
 static const struct command_registration cortex_a8_exec_command_handlers[] = {
 	{
 		.name = "cache_info",
-		.handler = &cortex_a8_handle_cache_info_command,
+		.handler = cortex_a8_handle_cache_info_command,
 		.mode = COMMAND_EXEC,
 		.help = "display information about target caches",
 	},
 	{
 		.name = "dbginit",
-		.handler = &cortex_a8_handle_dbginit_command,
+		.handler = cortex_a8_handle_dbginit_command,
 		.mode = COMMAND_EXEC,
 		.help = "Initialize core debug",
 	},
diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index 9685821..c6b1bb2 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -1989,24 +1989,24 @@ COMMAND_HANDLER(handle_cortex_m3_mask_interrupts_command)
 static const struct command_registration cortex_m3_exec_command_handlers[] = {
 	{
 		.name = "disassemble",
-		.handler = &handle_cortex_m3_disassemble_command,
+		.handler = handle_cortex_m3_disassemble_command,
 		.mode = COMMAND_EXEC,
 		.help = "disassemble Thumb2 instructions",
-		.usage = "<address> [<count>]",
+		.usage = "address [count]",
 	},
 	{
 		.name = "maskisr",
-		.handler = &handle_cortex_m3_mask_interrupts_command,
+		.handler = handle_cortex_m3_mask_interrupts_command,
 		.mode = COMMAND_EXEC,
 		.help = "mask cortex_m3 interrupts",
 		.usage = "['on'|'off']",
 	},
 	{
 		.name = "vector_catch",
-		.handler = &handle_cortex_m3_vector_catch_command,
+		.handler = handle_cortex_m3_vector_catch_command,
 		.mode = COMMAND_EXEC,
-		.help = "catch hardware vectors",
-		.usage = "['all'|'none'|<list>]",
+		.help = "configure hardware vectors to trigger debug entry",
+		.usage = "['all'|'none'|('bus_err'|'chk_err'|...)*]",
 	},
 	COMMAND_REGISTRATION_DONE
 };

commit e19fe9ad09e28df1976257052afe6edf765aa778
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 7 15:22:41 2010 -0800

    ARM ETM/ETB/trace: help/usage updates
    
    Provide helptext which was sometimes missing; update some of it
    to be more accurate.
    
    Usage syntax messages have the same EBNF as the User's Guide;
    no angle brackets in either place.
    
    Don't use "&function"; functions are like arrays, their address
    is their name.  Shrink some overlong lines, remove some empties.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/etb.c b/src/target/etb.c
index fb2dd60..18258f6 100644
--- a/src/target/etb.c
+++ b/src/target/etb.c
@@ -447,17 +447,21 @@ COMMAND_HANDLER(handle_etb_trigger_percent_command)
 
 static const struct command_registration etb_config_command_handlers[] = {
 	{
+		/* NOTE:  with ADIv5, ETBs are accessed using DAP operations,
+		 * possibly over SWD, not through separate TAPs...
+		 */
 		.name = "config",
-		.handler = &handle_etb_config_command,
+		.handler = handle_etb_config_command,
 		.mode = COMMAND_CONFIG,
+		.help = "Associate ETB with target and JTAG TAP.",
 		.usage = "target tap",
 	},
 	{
 		.name = "trigger_percent",
-		.handler = &handle_etb_trigger_percent_command,
+		.handler = handle_etb_trigger_percent_command,
 		.mode = COMMAND_EXEC,
-		.help = "percent of trace buffer to be filled "
-			"after the trigger occurs",
+		.help = "Set percent of trace buffer to be filled "
+			"after the trigger occurs (2..100).",
 		.usage = "[percent]",
 	},
 	COMMAND_REGISTRATION_DONE
diff --git a/src/target/etm.c b/src/target/etm.c
index d22bc40..3126efc 100644
--- a/src/target/etm.c
+++ b/src/target/etm.c
@@ -1259,12 +1259,16 @@ COMMAND_HANDLER(handle_etm_tracemode_command)
 	case 0:
 		break;
 	case 4:
-		CALL_COMMAND_HANDLER(handle_etm_tracemode_command_update, &tracemode);
+		CALL_COMMAND_HANDLER(handle_etm_tracemode_command_update,
+				&tracemode);
 		break;
 	default:
-		command_print(CMD_CTX, "usage: configure trace mode "
-				"<none | data | address | all> "
-				"<context id bits> <cycle accurate> <branch output>");
+		command_print(CMD_CTX, "usage: tracemode "
+				"('none'|'data'|'address'|'all') "
+				"context_id_bits "
+				"('enable'|'disable') "
+				"('enable'|'disable')"
+				);
 		return ERROR_FAIL;
 	}
 
@@ -2112,11 +2116,16 @@ COMMAND_HANDLER(handle_etm_analyze_command)
 
 static const struct command_registration etm_config_command_handlers[] = {
 	{
+		/* NOTE:  with ADIv5, ETMs are accessed by DAP operations,
+		 * possibly over SWD, not JTAG scanchain 6 of 'target'.
+		 *
+		 * Also, these parameters don't match ETM v3+ modules...
+		 */
 		.name = "config",
-		.handler = &handle_etm_config_command,
+		.handler = handle_etm_config_command,
 		.mode = COMMAND_CONFIG,
-		.usage = "<target> <port_width> <port_mode> "
-			"<clocking> <capture_driver>",
+		.help = "Set up ETM output port.",
+		.usage = "target port_width port_mode clocking capture_driver",
 	},
 	COMMAND_REGISTRATION_DONE
 };
@@ -2132,33 +2141,36 @@ const struct command_registration etm_command_handlers[] = {
 
 static const struct command_registration etm_exec_command_handlers[] = {
 	{
-		.name = "tracemode", handle_etm_tracemode_command,
+		.name = "tracemode",
+		.handler = handle_etm_tracemode_command,
 		.mode = COMMAND_EXEC,
 		.help = "configure/display trace mode",
-		.usage = "<none | data | address | all> "
-			"<context_id_bits> <cycle_accurate> <branch_output>",
+		.usage = "('none'|'data'|'address'|'all') "
+			"context_id_bits "
+			"['enable'|'disable'] "
+			"['enable'|'disable']",
 	},
 	{
 		.name = "info",
-		.handler = &handle_etm_info_command,
+		.handler = handle_etm_info_command,
 		.mode = COMMAND_EXEC,
 		.help = "display info about the current target's ETM",
 	},
 	{
 		.name = "status",
-		.handler = &handle_etm_status_command,
+		.handler = handle_etm_status_command,
 		.mode = COMMAND_EXEC,
 		.help = "display current target's ETM status",
 	},
 	{
 		.name = "start",
-		.handler = &handle_etm_start_command,
+		.handler = handle_etm_start_command,
 		.mode = COMMAND_EXEC,
 		.help = "start ETM trace collection",
 	},
 	{
 		.name = "stop",
-		.handler = &handle_etm_stop_command,
+		.handler = handle_etm_stop_command,
 		.mode = COMMAND_EXEC,
 		.help = "stop ETM trace collection",
 	},
@@ -2167,7 +2179,7 @@ static const struct command_registration etm_exec_command_handlers[] = {
 		.handler = handle_etm_trigger_debug_command,
 		.mode = COMMAND_EXEC,
 		.help = "enable/disable debug entry on trigger",
-		.usage = "(enable | disable)",
+		.usage = "['enable'|'disable']",
 	},
 	{
 		.name = "analyze",
@@ -2177,19 +2189,21 @@ static const struct command_registration etm_exec_command_handlers[] = {
 	},
 	{
 		.name = "image",
-		.handler = &handle_etm_image_command,
+		.handler = handle_etm_image_command,
 		.mode = COMMAND_EXEC,
-		.help = "load image from <file> [base address]",
+		.help = "load image from file with optional offset",
+		.usage = "filename [offset]",
 	},
 	{
 		.name = "dump",
-		.handler = &handle_etm_dump_command,
+		.handler = handle_etm_dump_command,
 		.mode = COMMAND_EXEC,
-		.help = "dump captured trace data <file>",
+		.help = "dump captured trace data to file",
+		.usage = "filename",
 	},
 	{
 		.name = "load",
-		.handler = &handle_etm_load_command,
+		.handler = handle_etm_load_command,
 		.mode = COMMAND_EXEC,
 		.help = "load trace data for analysis <file>",
 	},
diff --git a/src/target/etm_dummy.c b/src/target/etm_dummy.c
index 19a078f..f9c6fe7 100644
--- a/src/target/etm_dummy.c
+++ b/src/target/etm_dummy.c
@@ -61,9 +61,9 @@ COMMAND_HANDLER(handle_etm_dummy_config_command)
 static const struct command_registration etm_dummy_config_command_handlers[] = {
 	{
 		.name = "config",
-		.handler = &handle_etm_dummy_config_command,
+		.handler = handle_etm_dummy_config_command,
 		.mode = COMMAND_CONFIG,
-		.usage = "<target>",
+		.usage = "target",
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/target/oocd_trace.c b/src/target/oocd_trace.c
index 2533c40..3b43571 100644
--- a/src/target/oocd_trace.c
+++ b/src/target/oocd_trace.c
@@ -398,13 +398,13 @@ COMMAND_HANDLER(handle_oocd_trace_resync_command)
 static const struct command_registration oocd_trace_all_command_handlers[] = {
 	{
 		.name = "config",
-		.handler = &handle_oocd_trace_config_command,
+		.handler = handle_oocd_trace_config_command,
 		.mode = COMMAND_CONFIG,
-		.usage = "<target>",
+		.usage = "target",
 	},
 	{
 		.name = "status",
-		.handler = &handle_oocd_trace_status_command,
+		.handler = handle_oocd_trace_status_command,
 		.mode = COMMAND_EXEC,
 		.help = "display OpenOCD + trace status",
 	},

commit dd8f679aa2ea447a96f393db3a8938259f63eebc
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 7 15:05:26 2010 -0800

    target misc: help/usage updates
    
    Provide helptext which was sometimes missing; update some of it
    to be more accurate.
    
    Usage syntax messages have the same EBNF as the User's Guide.
    
    Don't use "&function"; functions are like arrays, their address
    is their name.  Shrink some overlong lines; remove some empties.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/target.c b/src/target/target.c
index 73a762d..c29c45e 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -45,8 +45,10 @@
 #include "image.h"
 
 
-static int target_array2mem(Jim_Interp *interp, struct target *target, int argc, Jim_Obj *const *argv);
-static int target_mem2array(Jim_Interp *interp, struct target *target, int argc, Jim_Obj *const *argv);
+static int target_array2mem(Jim_Interp *interp, struct target *target,
+		int argc, Jim_Obj *const *argv);
+static int target_mem2array(Jim_Interp *interp, struct target *target,
+		int argc, Jim_Obj *const *argv);
 
 /* targets */
 extern struct target_type arm7tdmi_target;
@@ -2960,7 +2962,8 @@ static void writeGmon(uint32_t *samples, uint32_t sampleNum, const char *filenam
 	fclose(f);
 }
 
-/* profiling samples the CPU PC as quickly as OpenOCD is able, which will be used as a random sampling of PC */
+/* profiling samples the CPU PC as quickly as OpenOCD is able,
+ * which will be used as a random sampling of PC */
 COMMAND_HANDLER(handle_profile_command)
 {
 	struct target *target = get_current_target(CMD_CTX);
@@ -2976,6 +2979,12 @@ COMMAND_HANDLER(handle_profile_command)
 
 	timeval_add_time(&timeout, offset, 0);
 
+	/**
+	 * @todo: Some cores let us sample the PC without the
+	 * annoying halt/resume step; for example, ARMv7 PCSR.
+	 * Provide a way to use that more efficient mechanism.
+	 */
+
 	command_print(CMD_CTX, "Starting profiling. Halting and resuming the target as often as we can...");
 
 	static const int maxSample = 10000;
@@ -3287,7 +3296,9 @@ static int jim_array2mem(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 
 	return target_array2mem(interp,target, argc-1, argv + 1);
 }
-static int target_array2mem(Jim_Interp *interp, struct target *target, int argc, Jim_Obj *const *argv)
+
+static int target_array2mem(Jim_Interp *interp, struct target *target,
+		int argc, Jim_Obj *const *argv)
 {
 	long l;
 	uint32_t width;
@@ -3789,11 +3800,13 @@ static int target_configure(Jim_GetOptInfo *goi, struct target *target)
 	return JIM_OK;
 }
 
-static int jim_target_configure(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
+static int
+jim_target_configure(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 {
 	Jim_GetOptInfo goi;
+
 	Jim_GetOpt_Setup(&goi, interp, argc - 1, argv + 1);
-	goi.isconfigure = strcmp(Jim_GetString(argv[0], NULL), "configure") == 0;
+	goi.isconfigure = !strcmp(Jim_GetString(argv[0], NULL), "configure");
 	int need_args = 1 + goi.isconfigure;
 	if (goi.argc < need_args)
 	{
@@ -3988,13 +4001,15 @@ static int jim_target_md(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 	return JIM_OK;
 }
 
-static int jim_target_mem2array(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
+static int jim_target_mem2array(Jim_Interp *interp,
+		int argc, Jim_Obj *const *argv)
 {
 	struct target *target = Jim_CmdPrivData(interp);
 	return target_mem2array(interp, target, argc - 1, argv + 1);
 }
 
-static int jim_target_array2mem(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
+static int jim_target_array2mem(Jim_Interp *interp,
+		int argc, Jim_Obj *const *argv)
 {
 	struct target *target = Jim_CmdPrivData(interp);
 	return target_array2mem(interp, target, argc - 1, argv + 1);
@@ -4219,108 +4234,123 @@ static const struct command_registration target_instance_command_handlers[] = {
 	{
 		.name = "configure",
 		.mode = COMMAND_CONFIG,
-		.jim_handler = &jim_target_configure,
-		.usage = "[<target_options> ...]",
+		.jim_handler = jim_target_configure,
 		.help  = "configure a new target for use",
+		.usage = "[target_attribute ...]",
 	},
 	{
 		.name = "cget",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_target_configure,
-		.usage = "<target_type> [<target_options> ...]",
-		.help  = "configure a new target for use",
+		.jim_handler = jim_target_configure,
+		.help  = "returns the specified target attribute",
+		.usage = "target_attribute",
 	},
 	{
 		.name = "mww",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_mw,
-		.usage = "<address> <data> [<count>]",
+		.jim_handler = jim_target_mw,
 		.help = "Write 32-bit word(s) to target memory",
+		.usage = "address data [count]",
 	},
 	{
 		.name = "mwh",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_mw,
-		.usage = "<address> <data> [<count>]",
+		.jim_handler = jim_target_mw,
 		.help = "Write 16-bit half-word(s) to target memory",
+		.usage = "address data [count]",
 	},
 	{
 		.name = "mwb",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_mw,
-		.usage = "<address> <data> [<count>]",
+		.jim_handler = jim_target_mw,
 		.help = "Write byte(s) to target memory",
+		.usage = "address data [count]",
 	},
 	{
 		.name = "mdw",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_md,
-		.usage = "<address> [<count>]",
+		.jim_handler = jim_target_md,
 		.help = "Display target memory as 32-bit words",
+		.usage = "address [count]",
 	},
 	{
 		.name = "mdh",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_md,
-		.usage = "<address> [<count>]",
+		.jim_handler = jim_target_md,
 		.help = "Display target memory as 16-bit half-words",
+		.usage = "address [count]",
 	},
 	{
 		.name = "mdb",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_md,
-		.usage = "<address> [<count>]",
+		.jim_handler = jim_target_md,
 		.help = "Display target memory as 8-bit bytes",
+		.usage = "address [count]",
 	},
 	{
 		.name = "array2mem",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_array2mem,
+		.jim_handler = jim_target_array2mem,
+		.help = "Writes Tcl array of 8/16/32 bit numbers "
+			"to target memory",
+		.usage = "arrayname bitwidth address count",
 	},
 	{
 		.name = "mem2array",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_mem2array,
+		.jim_handler = jim_target_mem2array,
+		.help = "Loads Tcl array of 8/16/32 bit numbers "
+			"from target memory",
+		.usage = "arrayname bitwidth address count",
 	},
 	{
 		.name = "eventlist",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_event_list,
+		.jim_handler = jim_target_event_list,
+		.help = "displays a table of events defined for this target",
 	},
 	{
 		.name = "curstate",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_current_state,
+		.jim_handler = jim_target_current_state,
+		.help = "displays the current state of this target",
 	},
 	{
 		.name = "arp_examine",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_examine,
+		.jim_handler = jim_target_examine,
+		.help = "used internally for reset processing",
 	},
 	{
 		.name = "arp_poll",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_poll,
+		.jim_handler = jim_target_poll,
+		.help = "used internally for reset processing",
 	},
 	{
 		.name = "arp_reset",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_reset,
+		.jim_handler = jim_target_reset,
+		.help = "used internally for reset processing",
 	},
 	{
 		.name = "arp_halt",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_halt,
+		.jim_handler = jim_target_halt,
+		.help = "used internally for reset processing",
 	},
 	{
 		.name = "arp_waitstate",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_wait_state,
+		.jim_handler = jim_target_wait_state,
+		.help = "used internally for reset processing",
 	},
 	{
 		.name = "invoke-event",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_target_invoke_event,
+		.jim_handler = jim_target_invoke_event,
+		.help = "invoke handler for specified event",
+		.usage = "event_name",
 	},
 	COMMAND_REGISTRATION_DONE
 };
@@ -4472,7 +4502,7 @@ static int target_create(Jim_GetOptInfo *goi)
 		}
 		*tpp = target;
 	}
-	
+
 	/* now - create the new target name command */
 	const const struct command_registration target_subcommands[] = {
 		{
@@ -4615,51 +4645,54 @@ static const struct command_registration target_subcommand_handlers[] = {
 	{
 		.name = "init",
 		.mode = COMMAND_CONFIG,
-		.handler = &handle_target_init_command,
+		.handler = handle_target_init_command,
 		.help = "initialize targets",
 	},
 	{
 		.name = "create",
+		/* REVISIT this should be COMMAND_CONFIG ... */
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_target_create,
-		.usage = "<name> <type> ...",
-		.help = "Returns the currently selected target",
+		.jim_handler = jim_target_create,
+		.usage = "name type '-chain-position' name [options ...]",
+		.help = "Creates and selects a new target",
 	},
 	{
 		.name = "current",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_target_current,
+		.jim_handler = jim_target_current,
 		.help = "Returns the currently selected target",
 	},
 	{
 		.name = "types",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_target_types,
-		.help = "Returns the available target types as a list of strings",
+		.jim_handler = jim_target_types,
+		.help = "Returns the available target types as "
+				"a list of strings",
 	},
 	{
 		.name = "names",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_target_names,
+		.jim_handler = jim_target_names,
 		.help = "Returns the names of all targets as a list of strings",
 	},
 	{
 		.name = "number",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_target_number,
-		.usage = "<number>",
-		.help = "Returns the name of target <n>",
+		.jim_handler = jim_target_number,
+		.usage = "number",
+		.help = "Returns the name of the numbered target "
+			"(DEPRECATED)",
 	},
 	{
 		.name = "count",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_target_count,
-		.help = "Returns the number of targets as an integer",
+		.jim_handler = jim_target_count,
+		.help = "Returns the number of targets as an integer "
+			"(DEPRECATED)",
 	},
 	COMMAND_REGISTRATION_DONE
 };
 
-
 struct FastLoad
 {
 	uint32_t address;
@@ -4833,11 +4866,11 @@ COMMAND_HANDLER(handle_fast_load_command)
 static const struct command_registration target_command_handlers[] = {
 	{
 		.name = "targets",
-		.handler = &handle_targets_command,
+		.handler = handle_targets_command,
 		.mode = COMMAND_ANY,
-		.help = "change current command line target (one parameter) "
-			"or list targets (no parameters)",
-		.usage = "[<new_current_target>]",
+		.help = "change current default target (one parameter) "
+			"or prints table of all targets (no parameters)",
+		.usage = "[target]",
 	},
 	{
 		.name = "target",
@@ -4857,69 +4890,75 @@ int target_register_commands(struct command_context *cmd_ctx)
 static const struct command_registration target_exec_command_handlers[] = {
 	{
 		.name = "fast_load_image",
-		.handler = &handle_fast_load_image_command,
+		.handler = handle_fast_load_image_command,
 		.mode = COMMAND_ANY,
-		.help = "Load image into memory, mainly for profiling purposes",
-		.usage = "<file> <address> ['bin'|'ihex'|'elf'|'s19'] "
-			"[min_address] [max_length]",
+		.help = "Load image into server memory for later use by "
+			"fast_load; primarily for profiling",
+		.usage = "filename address ['bin'|'ihex'|'elf'|'s19'] "
+			"[min_address [max_length]]",
 	},
 	{
 		.name = "fast_load",
-		.handler = &handle_fast_load_command,
+		.handler = handle_fast_load_command,
 		.mode = COMMAND_EXEC,
 		.help = "loads active fast load image to current target "
 			"- mainly for profiling purposes",
 	},
 	{
 		.name = "profile",
-		.handler = &handle_profile_command,
+		.handler = handle_profile_command,
 		.mode = COMMAND_EXEC,
 		.help = "profiling samples the CPU PC",
 	},
 	/** @todo don't register virt2phys() unless target supports it */
 	{
 		.name = "virt2phys",
-		.handler = &handle_virt2phys_command,
+		.handler = handle_virt2phys_command,
 		.mode = COMMAND_ANY,
 		.help = "translate a virtual address into a physical address",
+		.usage = "virual_address",
 	},
-
 	{
 		.name = "reg",
-		.handler = &handle_reg_command,
+		.handler = handle_reg_command,
 		.mode = COMMAND_EXEC,
-		.help = "display or set a register",
+		.help = "display or set a register; with no arguments, "
+			"displays all registers and their values",
+		.usage = "[(register_name|register_number) [value]]",
 	},
-
 	{
 		.name = "poll",
-		.handler = &handle_poll_command,
+		.handler = handle_poll_command,
 		.mode = COMMAND_EXEC,
-		.help = "poll target state",
+		.help = "poll target state; or reconfigure background polling",
+		.usage = "['on'|'off']",
 	},
 	{
 		.name = "wait_halt",
-		.handler = &handle_wait_halt_command,
+		.handler = handle_wait_halt_command,
 		.mode = COMMAND_EXEC,
-		.help = "wait for target halt",
-		.usage = "[time (s)]",
+		.help = "wait up to the specified number of milliseconds "
+			"(default 5) for a previously requested halt",
+		.usage = "[milliseconds]",
 	},
 	{
 		.name = "halt",
-		.handler = &handle_halt_command,
+		.handler = handle_halt_command,
 		.mode = COMMAND_EXEC,
-		.help = "halt target",
+		.help = "request target to halt, then wait up to the specified"
+			"number of milliseconds (default 5) for it to complete",
+		.usage = "[milliseconds]",
 	},
 	{
 		.name = "resume",
-		.handler = &handle_resume_command,
+		.handler = handle_resume_command,
 		.mode = COMMAND_EXEC,
-		.help = "resume target",
-		.usage = "[<address>]",
+		.help =	"resume target execution from current PC or address",
+		.usage = "[address]",
 	},
 	{
 		.name = "reset",
-		.handler = &handle_reset_command,
+		.handler = handle_reset_command,
 		.mode = COMMAND_EXEC,
 		.usage = "[run|halt|init]",
 		.help = "Reset all targets into the specified mode."
@@ -4927,133 +4966,127 @@ static const struct command_registration target_exec_command_handlers[] = {
 	},
 	{
 		.name = "soft_reset_halt",
-		.handler = &handle_soft_reset_halt_command,
+		.handler = handle_soft_reset_halt_command,
 		.mode = COMMAND_EXEC,
 		.help = "halt the target and do a soft reset",
 	},
 	{
-
 		.name = "step",
-		.handler = &handle_step_command,
+		.handler = handle_step_command,
 		.mode = COMMAND_EXEC,
-		.help =	"step one instruction from current PC or [addr]",
-		.usage = "[<address>]",
+		.help =	"step one instruction from current PC or address",
+		.usage = "[address]",
 	},
 	{
-
 		.name = "mdw",
-		.handler = &handle_md_command,
+		.handler = handle_md_command,
 		.mode = COMMAND_EXEC,
 		.help = "display memory words",
-		.usage = "[phys] <addr> [count]",
+		.usage = "['phys'] address [count]",
 	},
 	{
 		.name = "mdh",
-		.handler = &handle_md_command,
+		.handler = handle_md_command,
 		.mode = COMMAND_EXEC,
 		.help = "display memory half-words",
-		.usage = "[phys] <addr> [count]",
+		.usage = "['phys'] address [count]",
 	},
 	{
 		.name = "mdb",
-		.handler = &handle_md_command,
+		.handler = handle_md_command,
 		.mode = COMMAND_EXEC,
 		.help = "display memory bytes",
-		.usage = "[phys] <addr> [count]",
+		.usage = "['phys'] address [count]",
 	},
 	{
-
 		.name = "mww",
-		.handler = &handle_mw_command,
+		.handler = handle_mw_command,
 		.mode = COMMAND_EXEC,
 		.help = "write memory word",
-		.usage = "[phys]  <addr> <value> [count]",
+		.usage = "['phys'] address value [count]",
 	},
 	{
 		.name = "mwh",
-		.handler = &handle_mw_command,
+		.handler = handle_mw_command,
 		.mode = COMMAND_EXEC,
 		.help = "write memory half-word",
-		.usage = "[phys] <addr> <value> [count]",
+		.usage = "['phys'] address value [count]",
 	},
 	{
 		.name = "mwb",
-		.handler = &handle_mw_command,
+		.handler = handle_mw_command,
 		.mode = COMMAND_EXEC,
 		.help = "write memory byte",
-		.usage = "[phys] <addr> <value> [count]",
+		.usage = "['phys'] address value [count]",
 	},
 	{
-
 		.name = "bp",
-		.handler = &handle_bp_command,
+		.handler = handle_bp_command,
 		.mode = COMMAND_EXEC,
-		.help = "list or set breakpoint",
-		.usage = "[<address> <length> [hw]]",
+		.help = "list or set hardware or software breakpoint",
+		.usage = "[address length ['hw']]",
 	},
 	{
 		.name = "rbp",
-		.handler = &handle_rbp_command,
+		.handler = handle_rbp_command,
 		.mode = COMMAND_EXEC,
 		.help = "remove breakpoint",
-		.usage = "<address>",
+		.usage = "address",
 	},
 	{
-
 		.name = "wp",
-		.handler = &handle_wp_command,
+		.handler = handle_wp_command,
 		.mode = COMMAND_EXEC,
-		.help = "list or set watchpoint",
-		.usage = "[<address> <length> <r/w/a> [value] [mask]]",
+		.help = "list (no params) or create watchpoints",
+		.usage = "[address length [('r'|'w'|'a') value [mask]]]",
 	},
 	{
 		.name = "rwp",
-		.handler = &handle_rwp_command,
+		.handler = handle_rwp_command,
 		.mode = COMMAND_EXEC,
 		.help = "remove watchpoint",
-		.usage = "<address>",
-
+		.usage = "address",
 	},
 	{
 		.name = "load_image",
-		.handler = &handle_load_image_command,
+		.handler = handle_load_image_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<file> <address> ['bin'|'ihex'|'elf'|'s19'] "
+		.usage = "filename address ['bin'|'ihex'|'elf'|'s19'] "
 			"[min_address] [max_length]",
 	},
 	{
 		.name = "dump_image",
-		.handler = &handle_dump_image_command,
+		.handler = handle_dump_image_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<file> <address> <size>",
+		.usage = "filename address size",
 	},
 	{
 		.name = "verify_image",
-		.handler = &handle_verify_image_command,
+		.handler = handle_verify_image_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<file> [offset] [type]",
+		.usage = "filename [offset [type]]",
 	},
 	{
 		.name = "test_image",
-		.handler = &handle_test_image_command,
+		.handler = handle_test_image_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<file> [offset] [type]",
+		.usage = "filename [offset [type]]",
 	},
 	{
 		.name = "ocd_mem2array",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_mem2array,
-		.help = "read memory and return as a TCL array "
+		.jim_handler = jim_mem2array,
+		.help = "read 8/16/32 bit memory and return as a TCL array "
 			"for script processing",
-		.usage = "<arrayname> <width=32|16|8> <address> <count>",
+		.usage = "arrayname bitwidth address count",
 	},
 	{
 		.name = "ocd_array2mem",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_array2mem,
+		.jim_handler = jim_array2mem,
 		.help = "convert a TCL array to memory locations "
-			"and write the values",
-		.usage = "<arrayname> <width=32|16|8> <address> <count>",
+			"and write the 8/16/32 bit values",
+		.usage = "arrayname bitwidth address count",
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/target/target_request.c b/src/target/target_request.c
index d22b8a2..ec3d48e 100644
--- a/src/target/target_request.c
+++ b/src/target/target_request.c
@@ -303,10 +303,10 @@ COMMAND_HANDLER(handle_target_request_debugmsgs_command)
 static const struct command_registration target_req_exec_command_handlers[] = {
 	{
 		.name = "debugmsgs",
-		.handler = &handle_target_request_debugmsgs_command,
+		.handler = handle_target_request_debugmsgs_command,
 		.mode = COMMAND_EXEC,
-		.help = "set reception of debug messages from target",
-		.usage = "(enable|disable)",
+		.help = "display and/or modify reception of debug messages from target",
+		.usage = "['enable'|'charmsg'|'disable']",
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/target/trace.c b/src/target/trace.c
index 56a18a4..a8ec143 100644
--- a/src/target/trace.c
+++ b/src/target/trace.c
@@ -159,18 +159,18 @@ COMMAND_HANDLER(handle_trace_history_command)
 static const struct command_registration trace_exec_command_handlers[] = {
 	{
 		.name = "history",
-		.handler = &handle_trace_history_command,
+		.handler = handle_trace_history_command,
 		.mode = COMMAND_EXEC,
-		.help = "display trace history, clear history or set [size]",
-		.usage = "[clear|<size>]",
+		.help = "display trace history, clear history or set size",
+		.usage = "['clear'|size]",
 	},
 	{
 		.name = "point",
-		.handler = &handle_trace_point_command,
+		.handler = handle_trace_point_command,
 		.mode = COMMAND_EXEC,
 		.help = "display trace points, clear list of trace points, "
-			"or add new tracepoint at [address]",
-		.usage = "[clear|<address>]",
+			"or add new tracepoint at address",
+		.usage = "['clear'|address]",
 	},
 	COMMAND_REGISTRATION_DONE
 };

commit 7c3aee96b2f122fd16ec20e305cb16fe89180c9b
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 7 14:51:59 2010 -0800

    XScale: help/usage updates
    
    Provide helptext which was sometimes missing; update some of it
    to be more accurate (mostly they display something w/no args).
    
    Usage syntax messages have the same EBNF as the User's Guide.
    In some cases, *exactly* what the user's guide shows... e.g.
    talking about "offset" not "address" for trace_image.
    
    Don't use "&function"; functions are like arrays, their name
    is their address.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/xscale.c b/src/target/xscale.c
index 6efe59c..fc71ea3 100644
--- a/src/target/xscale.c
+++ b/src/target/xscale.c
@@ -3607,94 +3607,101 @@ COMMAND_HANDLER(xscale_handle_cp15)
 static const struct command_registration xscale_exec_command_handlers[] = {
 	{
 		.name = "cache_info",
-		.handler = &xscale_handle_cache_info_command,
-		.mode = COMMAND_EXEC, NULL,
+		.handler = xscale_handle_cache_info_command,
+		.mode = COMMAND_EXEC,
+		.help = "display information about CPU caches",
 	},
-
 	{
 		.name = "mmu",
-		.handler = &xscale_handle_mmu_command,
+		.handler = xscale_handle_mmu_command,
 		.mode = COMMAND_EXEC,
-		.usage = "[enable|disable]",
 		.help = "enable or disable the MMU",
+		.usage = "['enable'|'disable']",
 	},
 	{
 		.name = "icache",
-		.handler = &xscale_handle_idcache_command,
+		.handler = xscale_handle_idcache_command,
 		.mode = COMMAND_EXEC,
-		.usage = "[enable|disable]",
-		.help = "enable or disable the ICache",
+		.help = "display ICache state, optionally enabling or "
+			"disabling it",
+		.usage = "['enable'|'disable']",
 	},
 	{
 		.name = "dcache",
-		.handler = &xscale_handle_idcache_command,
+		.handler = xscale_handle_idcache_command,
 		.mode = COMMAND_EXEC,
-		.usage = "[enable|disable]",
-		.help = "enable or disable the DCache",
+		.help = "display DCache state, optionally enabling or "
+			"disabling it",
+		.usage = "['enable'|'disable']",
 	},
-
 	{
 		.name = "vector_catch",
-		.handler = &xscale_handle_vector_catch_command,
+		.handler = xscale_handle_vector_catch_command,
 		.mode = COMMAND_EXEC,
-		.help = "mask of vectors that should be caught",
-		.usage = "[<mask>]",
+		.help = "set or display 8-bit mask of vectors "
+			"that should trigger debug entry",
+		.usage = "[mask]",
 	},
 	{
 		.name = "vector_table",
-		.handler = &xscale_handle_vector_table_command,
+		.handler = xscale_handle_vector_table_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<high|low> <index> <code>",
-		.help = "set static code for exception handler entry",
+		.help = "set vector table entry in mini-ICache, "
+			"or display current tables",
+		.usage = "[('high'|'low') index code]",
 	},
-
 	{
 		.name = "trace_buffer",
-		.handler = &xscale_handle_trace_buffer_command,
+		.handler = xscale_handle_trace_buffer_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<enable | disable> [fill [n]|wrap]",
+		.help = "display trace buffer status, enable or disable "
+			"tracing, and optionally reconfigure trace mode",
+		.usage = "['enable'|'disable' ['fill' number|'wrap']]",
 	},
 	{
 		.name = "dump_trace",
-		.handler = &xscale_handle_dump_trace_command,
+		.handler = xscale_handle_dump_trace_command,
 		.mode = COMMAND_EXEC,
-		.help = "dump content of trace buffer to <file>",
-		.usage = "<file>",
+		.help = "dump content of trace buffer to file",
+		.usage = "filename",
 	},
 	{
 		.name = "analyze_trace",
-		.handler = &xscale_handle_analyze_trace_buffer_command,
+		.handler = xscale_handle_analyze_trace_buffer_command,
 		.mode = COMMAND_EXEC,
 		.help = "analyze content of trace buffer",
+		.usage = "",
 	},
 	{
 		.name = "trace_image",
-		.handler = &xscale_handle_trace_image_command,
-		COMMAND_EXEC,
-		.help = "load image from <file> [base address]",
-		.usage = "<file> [address] [type]",
+		.handler = xscale_handle_trace_image_command,
+		.mode = COMMAND_EXEC,
+		.help = "load image from file to address (default 0)",
+		.usage = "filename [offset [filetype]]",
 	},
-
 	{
 		.name = "cp15",
-		.handler = &xscale_handle_cp15,
+		.handler = xscale_handle_cp15,
 		.mode = COMMAND_EXEC,
-		.help = "access coproc 15",
-		.usage = "<register> [value]",
+		.help = "Read or write coprocessor 15 register.",
+		.usage = "register [value]",
 	},
 	COMMAND_REGISTRATION_DONE
 };
 static const struct command_registration xscale_any_command_handlers[] = {
 	{
 		.name = "debug_handler",
-		.handler = &xscale_handle_debug_handler_command,
+		.handler = xscale_handle_debug_handler_command,
 		.mode = COMMAND_ANY,
-		.usage = "<target#> <address>",
+		.help = "Change address used for debug handler.",
+		.usage = "target address",
 	},
 	{
 		.name = "cache_clean_address",
-		.handler = &xscale_handle_cache_clean_address_command,
+		.handler = xscale_handle_cache_clean_address_command,
 		.mode = COMMAND_ANY,
+		.help = "Change address used for cleaning data cache.",
+		.usage = "address",
 	},
 	{
 		.chain = xscale_exec_command_handlers,

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi            |  111 +++++++++++------
 src/target/arm11.c          |   29 +++--
 src/target/arm720t.c        |    6 +-
 src/target/arm7_9_common.c  |   16 ++--
 src/target/arm920t.c        |   24 ++--
 src/target/arm926ejs.c      |    2 +-
 src/target/arm966e.c        |   12 ++-
 src/target/arm9tdmi.c       |    4 +-
 src/target/arm_adi_v5.c     |    8 ++
 src/target/armv4_5.c        |   10 +-
 src/target/armv7a.c         |   35 ++++--
 src/target/armv7m.c         |   35 ++++--
 src/target/cortex_a8.c      |    4 +-
 src/target/cortex_m3.c      |   12 +-
 src/target/etb.c            |   12 ++-
 src/target/etm.c            |   54 ++++++---
 src/target/etm_dummy.c      |    4 +-
 src/target/oocd_trace.c     |    6 +-
 src/target/target.c         |  277 ++++++++++++++++++++++++-------------------
 src/target/target_request.c |    6 +-
 src/target/trace.c          |   12 +-
 src/target/xscale.c         |   79 +++++++------
 22 files changed, 448 insertions(+), 310 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sat Jan  9 01:49:44 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sat,  9 Jan 2010 00:49:44 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-70-g296a011
Message-ID: <E1NTPWT-0007gi-Rd@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  296a011db5833b8a3258a058e6a805cc5ddb2bfe (commit)
      from  12c143d5948355b3b54c9c0decc779177b22d5d9 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 296a011db5833b8a3258a058e6a805cc5ddb2bfe
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 8 16:47:58 2010 -0800

    NOR: add FIXMEs for writing ones
    
    It can invalidate ECC codes, and in general is not guaranteed
    to work.  (However on some chips it _appears_ to behave.)  Just
    don't do it; don't write in those cases.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/TODO b/TODO
index 8fed264..73e4aa7 100644
--- a/TODO
+++ b/TODO
@@ -209,6 +209,12 @@ https://lists.berlios.de/pipermail/openocd-development/2009-October/011506.html
   - ocl
   - str9xpec
 
+- Don't expect writing all-ones to be a safe way to write without
+  changing bit values.  Minimally it loses on flash modules with
+  internal ECC, where it may change the ECC.
+  - NOR flash_write_unlock() does that between sectors
+  - there may be other cases too
+
 @subsection thelistflashcfi CFI
 
 - finish implementing bus width/chip width handling (suggested by NC)
diff --git a/src/flash/nor/core.c b/src/flash/nor/core.c
index 01088f3..7e783d4 100644
--- a/src/flash/nor/core.c
+++ b/src/flash/nor/core.c
@@ -449,9 +449,12 @@ int flash_write_unlock(struct target *target, struct image *image,
 				break;
 			}
 
-			/* REVISIT This needlessly touches sectors BETWEEN the
+			/* FIXME This needlessly touches sectors BETWEEN the
 			 * sections it's writing.  Without auto erase, it just
-			 * writes ones; unlikely to destroy data.
+			 * writes ones.  That WILL INVALIDATE data in cases
+			 * like Stellaris Tempest chips, corrupting internal
+			 * ECC codes; and at least FreeScale suggests issues
+			 * with that approach (in HC11 documentation).
 			 *
 			 * With auto erase enabled, data in those sectors will
 			 * be needlessly destroyed; and some of the limited

-----------------------------------------------------------------------

Summary of changes:
 TODO                 |    6 ++++++
 src/flash/nor/core.c |    7 +++++--
 2 files changed, 11 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sat Jan  9 02:22:18 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sat,  9 Jan 2010 01:22:18 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-71-gc1cb209
Message-ID: <E1NTQ1z-0000FS-OC@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  c1cb20971ea89e4602bb23ba66180d647880bbef (commit)
      from  296a011db5833b8a3258a058e6a805cc5ddb2bfe (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit c1cb20971ea89e4602bb23ba66180d647880bbef
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 8 17:20:47 2010 -0800

    Coexist with quilt: rename PATCHES --> PATCHES.txt
    
    The issues is on Win32, which ignores case in filesystem
    and thus doesn't tolerate the quilt "patches" directory.
    
    Rename, and add "patches" to .gitignore so that developers
    can choose to use quilt for local patch management.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/.gitignore b/.gitignore
index 5ec831e..e37ee5a 100644
--- a/.gitignore
+++ b/.gitignore
@@ -66,6 +66,9 @@ stamp-vti
 INSTALL
 NOTES
 
+# coexist with quilt
+patches
+
 # Eclipse stuff
 .project
 .cproject
diff --git a/BUGS b/BUGS
index 961b339..36a7da3 100644
--- a/BUGS
+++ b/BUGS
@@ -26,8 +26,8 @@ that may be important.
     http://www.kernel.org/pub/software/scm/git/docs/git-bisect.html
 
 If possible, please develop and attach a patch that helps to expose or
-solve the reported problem.  See the PATCHES file for more information
-for that process.
+solve the reported problem.  See the PATCHES.txt file for information
+about that process.
 
 Attach all files directly to your posting.  The mailing list knows to
 transform attachments to links, but attachments must be less than 300KB
diff --git a/Doxyfile.in b/Doxyfile.in
index 49630f2..519bb2f 100644
--- a/Doxyfile.in
+++ b/Doxyfile.in
@@ -567,7 +567,7 @@ WARN_LOGFILE           =
 INPUT                  = @srcdir@/doc/manual \
                          @srcdir@/TODO \
                          @srcdir@/BUGS \
-                         @srcdir@/PATCHES \
+                         @srcdir@/PATCHES.txt \
                          @srcdir@/src \
                          @srcdir@/config.h
 
diff --git a/NEWS b/NEWS
index ba7e0e6..b169606 100644
--- a/NEWS
+++ b/NEWS
@@ -8,6 +8,7 @@ JTAG Layer:
 	Support USB-JTAG, Altera USB-Blaster and compatibles.
 
 Boundary Scan:
+
 Target Layer:
 	General
 		- new "reset-assert" event, for systems without SRST
@@ -36,6 +37,8 @@ Target Layer:
 	ETM, ETB
 		- "trigger_percent" command moved ETM --> ETB
 		- "etm trigger_debug" command added
+	MIPS
+		- use fastdata writes
 	Freescale DSP563xx cores (partial support)
 
 Flash Layer:
@@ -81,4 +84,4 @@ For older NEWS, see the NEWS files associated with each release
 
 For more information about contributing test reports, bug fixes, or new
 features and device support, please read the new Developer Manual (or
-the BUGS and PATCHES files in the source archive).
+the BUGS and PATCHES.txt files in the source archive).
diff --git a/PATCHES b/PATCHES.txt
similarity index 100%
rename from PATCHES
rename to PATCHES.txt
diff --git a/doc/openocd.texi b/doc/openocd.texi
index 84bdb3c..2e0143e 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -223,7 +223,7 @@ communication between developers:
 @uref{https://lists.berlios.de/mailman/listinfo/openocd-development}
 
 Discuss and submit patches to this list.
-The @file{PATCHES} file contains basic information about how
+The @file{PATCHES.txt} file contains basic information about how
 to prepare patches.
 
 
diff --git a/tools/release.sh b/tools/release.sh
index c464c49..12dfdb6 100755
--- a/tools/release.sh
+++ b/tools/release.sh
@@ -205,7 +205,7 @@ For older NEWS, see the NEWS files associated with each release
 
 For more information about contributing test reports, bug fixes, or new
 features and device support, please read the new Developer Manual (or
-the BUGS and PATCHES files in the source archive).
+the BUGS and PATCHES.txt files in the source archive).
 NEWS
 	git add NEWS
 

-----------------------------------------------------------------------

Summary of changes:
 .gitignore             |    3 +++
 BUGS                   |    4 ++--
 Doxyfile.in            |    2 +-
 NEWS                   |    5 ++++-
 PATCHES => PATCHES.txt |    0
 doc/openocd.texi       |    2 +-
 tools/release.sh       |    2 +-
 7 files changed, 12 insertions(+), 6 deletions(-)
 rename PATCHES => PATCHES.txt (100%)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sat Jan  9 05:58:12 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sat,  9 Jan 2010 04:58:12 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-73-gb800eb0
Message-ID: <E1NTTOv-00077s-HY@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  b800eb0336a190ed53da90a2b7216a35bfbfdb23 (commit)
       via  1a2c258ed4537ca95b50e1f9e776215d82de2a86 (commit)
      from  c1cb20971ea89e4602bb23ba66180d647880bbef (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit b800eb0336a190ed53da90a2b7216a35bfbfdb23
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 8 20:16:05 2010 -0800

    *SVF: help/usage updates
    
    Usage messages should use the same EBNF as the User's Guide;
    no angle brackets.  Be more complete too ... some params were
    missing.
    
    Don't use "&function"; its name is its address.
    
    Unrelated: fix typo in one "target.c" usage message.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/svf/svf.c b/src/svf/svf.c
index dfdecbc..7cb2200 100644
--- a/src/svf/svf.c
+++ b/src/svf/svf.c
@@ -1461,10 +1461,10 @@ static int svf_run_command(struct command_context *cmd_ctx, char *cmd_str)
 static const struct command_registration svf_command_handlers[] = {
 	{
 		.name = "svf",
-		.handler = &handle_svf_command,
+		.handler = handle_svf_command,
 		.mode = COMMAND_EXEC,
 		.help = "Runs a SVF file.",
-		.usage = "<file>",
+		.usage = "filename ['quiet']",
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/target/target.c b/src/target/target.c
index c29c45e..7994aff 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -4916,7 +4916,7 @@ static const struct command_registration target_exec_command_handlers[] = {
 		.handler = handle_virt2phys_command,
 		.mode = COMMAND_ANY,
 		.help = "translate a virtual address into a physical address",
-		.usage = "virual_address",
+		.usage = "virtual_address",
 	},
 	{
 		.name = "reg",
diff --git a/src/xsvf/xsvf.c b/src/xsvf/xsvf.c
index b1ddea9..539fbdc 100644
--- a/src/xsvf/xsvf.c
+++ b/src/xsvf/xsvf.c
@@ -1053,13 +1053,13 @@ COMMAND_HANDLER(handle_xsvf_command)
 static const struct command_registration xsvf_command_handlers[] = {
 	{
 		.name = "xsvf",
-		.handler = &handle_xsvf_command,
+		.handler = handle_xsvf_command,
 		.mode = COMMAND_EXEC,
 		.help = "Runs a XSVF file.  If 'virt2' is given, xruntest "
 			"counts are interpreted as TCK cycles rather than "
 			"as microseconds.  Without the 'quiet' option, all "
 			"comments, retries, and mismatches will be reported.",
-		.usage = "<file> [virt2] [quiet]",
+		.usage = "(tapname|'plain') filename ['virt2'] ['quiet']",
 	},
 	COMMAND_REGISTRATION_DONE
 };

commit 1a2c258ed4537ca95b50e1f9e776215d82de2a86
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 8 20:12:18 2010 -0800

    MFLASH: help/usage updates
    
    Make "usage" messages use the same EBNF as the User's Guide;
    no angle brackets.  Improve and correct various helptexts.
    
    Don't use "&function"; a function's name is its address.
    Remove a couple instances of pointless whitespace.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/flash/mflash.c b/src/flash/mflash.c
index 04f5c77..289fe5e 100644
--- a/src/flash/mflash.c
+++ b/src/flash/mflash.c
@@ -762,7 +762,7 @@ COMMAND_HANDLER(mg_write_cmd)
 	return ERROR_OK;
 
 mg_write_cmd_err:
- 	free(buffer);
+	free(buffer);
 	fileio_close(&fileio);
 
 	return ret;
@@ -829,7 +829,7 @@ COMMAND_HANDLER(mg_dump_cmd)
 	return ERROR_OK;
 
 mg_dump_cmd_err:
- 	free(buffer);
+	free(buffer);
 	fileio_close(&fileio);
 
 	return ret;
@@ -1271,30 +1271,33 @@ COMMAND_HANDLER(mg_config_cmd)
 static const struct command_registration mflash_exec_command_handlers[] = {
 	{
 		.name = "probe",
-		.handler = &mg_probe_cmd,
+		.handler = mg_probe_cmd,
 		.mode = COMMAND_EXEC,
 		.help = "Detect bank configuration information",
 	},
 	{
 		.name = "write",
-		.handler = &mg_write_cmd,
+		.handler = mg_write_cmd,
 		.mode = COMMAND_EXEC,
-		.usage = "<num> <file> <address>",
-		.help = "Write a file at the specified address",
+		/* FIXME bank_num is unused */
+		.usage = "bank_num filename address",
+		.help = "Write binary file at the specified address.",
 	},
 	{
 		.name = "dump",
-		.handler = &mg_dump_cmd,
+		.handler = mg_dump_cmd,
 		.mode = COMMAND_EXEC,
-		.usage = "<num> <file> <address> <size>",
-		.help = "Dump to a file from the specified address",
+		/* FIXME bank_num is unused */
+		.usage = "bank_num filename address size",
+		.help = "Write specified number of bytes from a binary file "
+			"to the specified, address.",
 	},
 	{
 		.name = "config",
-		.handler = &mg_config_cmd,
+		.handler = mg_config_cmd,
 		.mode = COMMAND_EXEC,
-		.usage = "<num> <stage>",
-		.help = "Dump to a file from the specified address",
+		.help = "Configure MFLASH options.",
+		.usage = "('boot'|'storage'|'pll' frequency)",
 	},
 	COMMAND_REGISTRATION_DONE
 };
@@ -1367,15 +1370,15 @@ COMMAND_HANDLER(mg_bank_cmd)
 static const struct command_registration mflash_config_command_handlers[] = {
 	{
 		.name = "bank",
-		.handler = &mg_bank_cmd,
+		.handler = mg_bank_cmd,
 		.mode = COMMAND_CONFIG,
 		.help = "configure a mflash device bank",
-		.usage = "<soc> <base> <RST pin> <target #>",
+		.usage = "soc_type base_addr pin_id target",
 	},
 	{
 		.name = "init",
 		.mode = COMMAND_CONFIG,
-		.handler = &handle_mflash_init_command,
+		.handler = handle_mflash_init_command,
 		.help = "initialize mflash devices",
 	},
 	COMMAND_REGISTRATION_DONE

-----------------------------------------------------------------------

Summary of changes:
 src/flash/mflash.c  |   33 ++++++++++++++++++---------------
 src/svf/svf.c       |    4 ++--
 src/target/target.c |    2 +-
 src/xsvf/xsvf.c     |    4 ++--
 4 files changed, 23 insertions(+), 20 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sat Jan  9 09:10:26 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sat,  9 Jan 2010 08:10:26 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-77-gaafd387
Message-ID: <E1NTWOx-0004x6-Kk@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  aafd3877e6fbc1745dbfc5d4f54a2c7efe8cc3d6 (commit)
       via  973cd9a299d904ab22bb089319beab65c339d783 (commit)
       via  2a76c1bcf94f8ed00c9e744a5405d0ac07cdc85a (commit)
       via  ae710059291ba9830a9b20d899bdef6a5122dd73 (commit)
      from  b800eb0336a190ed53da90a2b7216a35bfbfdb23 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit aafd3877e6fbc1745dbfc5d4f54a2c7efe8cc3d6
Author: Masaki Muranaka <monaka at monami-software.com>
Date:   Sat Jan 9 15:41:31 2010 +0900

    buildfix on MacOS
    
    Recent Apple gcc versions use __APPLE__ instead of __DARWIN__; accept
    that too.
    
    Also use #warning, not #warn; neither is standard, but most CPP versions
    require it to be spelled out.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/helper/command.c b/src/helper/command.c
index ab82785..0ddcd01 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -1361,7 +1361,7 @@ struct command_context* command_init(const char *startup_tcl, Jim_Interp *interp
 	HostOs = "winxx";
 #elif defined(__linux__)
 	HostOs = "linux";
-#elif defined(__DARWIN__)
+#elif defined(__APPLE__) || defined(__DARWIN__)
 	HostOs = "darwin";
 #elif defined(__CYGWIN__)
 	HostOs = "cygwin";
@@ -1370,7 +1370,7 @@ struct command_context* command_init(const char *startup_tcl, Jim_Interp *interp
 #elif defined(__ECOS)
 	HostOs = "ecos";
 #else
-#warn unrecognized host OS...
+#warning "Unrecognized host OS..."
 	HostOs = "other";
 #endif
 	Jim_SetGlobalVariableStr(interp, "ocd_HOSTOS",

commit 973cd9a299d904ab22bb089319beab65c339d783
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 8 23:23:55 2010 -0800

    PLD: usage/help updates
    
    Make "usage" messages use the same EBNF as the User's Guide;
    no angle brackets.  Improve and correct various helptexts.
    
    Don't use "&function"; a function's name is its address.
    Remove a couple instances of pointless whitespace, shrink
    a few overlong lines.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/pld/pld.c b/src/pld/pld.c
index 6a0bd93..5ed7596 100644
--- a/src/pld/pld.c
+++ b/src/pld/pld.c
@@ -76,7 +76,7 @@ COMMAND_HANDLER(handle_pld_device_command)
 			/* register pld specific commands */
 			int retval;
 			if (pld_drivers[i]->commands) {
-				retval = register_commands(CMD_CTX, NULL, 
+				retval = register_commands(CMD_CTX, NULL,
 						pld_drivers[i]->commands);
 				if (ERROR_OK != retval)
 				{
@@ -89,10 +89,12 @@ COMMAND_HANDLER(handle_pld_device_command)
 			c->driver = pld_drivers[i];
 			c->next = NULL;
 
-			retval = CALL_COMMAND_HANDLER(pld_drivers[i]->pld_device_command, c);
+			retval = CALL_COMMAND_HANDLER(
+					pld_drivers[i]->pld_device_command, c);
 			if (ERROR_OK != retval)
 			{
-				LOG_ERROR("'%s' driver rejected pld device", CMD_ARGV[0]);
+				LOG_ERROR("'%s' driver rejected pld device",
+						CMD_ARGV[0]);
 				free(c);
 				return ERROR_OK;
 			}
@@ -191,16 +193,16 @@ COMMAND_HANDLER(handle_pld_load_command)
 static const struct command_registration pld_exec_command_handlers[] = {
 	{
 		.name = "devices",
-		.handler = &handle_pld_devices_command,
+		.handler = handle_pld_devices_command,
 		.mode = COMMAND_EXEC,
 		.help = "list configured pld devices",
 	},
 	{
 		.name = "load",
-		.handler = &handle_pld_load_command,
+		.handler = handle_pld_load_command,
 		.mode = COMMAND_EXEC,
 		.help = "load configuration file into PLD",
-		.usage = "<device#> <file>",
+		.usage = "pld_num filename",
 	},
 	COMMAND_REGISTRATION_DONE
 };
@@ -234,14 +236,14 @@ static const struct command_registration pld_config_command_handlers[] = {
 	{
 		.name = "device",
 		.mode = COMMAND_CONFIG,
-		.handler = &handle_pld_device_command,
+		.handler = handle_pld_device_command,
 		.help = "configure a PLD device",
-		.usage = "<driver> ...",
+		.usage = "driver_name [driver_args ... ]",
 	},
 	{
 		.name = "init",
 		.mode = COMMAND_CONFIG,
-		.handler = &handle_pld_init_command,
+		.handler = handle_pld_init_command,
 		.help = "initialize PLD devices",
 	},
 	COMMAND_REGISTRATION_DONE
@@ -251,7 +253,6 @@ static const struct command_registration pld_command_handler[] = {
 		.name = "pld",
 		.mode = COMMAND_ANY,
 		.help = "programmable logic device commands",
-
 		.chain = pld_config_command_handlers,
 	},
 	COMMAND_REGISTRATION_DONE
diff --git a/src/pld/virtex2.c b/src/pld/virtex2.c
index 77eb866..bbf6b66 100644
--- a/src/pld/virtex2.c
+++ b/src/pld/virtex2.c
@@ -237,9 +237,9 @@ static const struct command_registration virtex2_exec_command_handlers[] = {
 	{
 		.name = "read_stat",
 		.mode = COMMAND_EXEC,
-		.handler = &virtex2_handle_read_stat_command,
+		.handler = virtex2_handle_read_stat_command,
 		.help = "read status register",
-		.usage = "<device_id>",
+		.usage = "pld_num",
 	},
 	COMMAND_REGISTRATION_DONE
 };

commit 2a76c1bcf94f8ed00c9e744a5405d0ac07cdc85a
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 8 23:18:46 2010 -0800

    NAND: help/usage/doc updates
    
    Usage messages should use the same EBNF as the User's Guide;
    no angle brackets.  Be more complete too ... some params were
    missing.  Improve and correct various helptexts.
    
    Make user's guide refer to the NAND "driver" name, not the
    controller name; that's a bit more precise.
    
    Don't use "&function"; its name is its address.  Line up struct
    initializers properly.  Remove some blank lines.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 2e0143e..3adc33a 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -4673,7 +4673,7 @@ NAND chips must be declared in configuration scripts,
 plus some additional configuration that's done after
 OpenOCD has initialized.
 
- at deffn {Config Command} {nand device} name controller target [configparams...]
+ at deffn {Config Command} {nand device} name driver target [configparams...]
 Declares a NAND device, which can be read and written to
 after it has been configured through @command{nand probe}.
 In OpenOCD, devices are single chips; this is unlike some
@@ -4688,8 +4688,8 @@ configuration files, not interactively.
 
 @itemize @bullet
 @item @var{name} ... may be used to reference the NAND bank
-in other commands.
- at item @var{controller} ... identifies the controller driver
+in most other NAND commands.  A number is also available.
+ at item @var{driver} ... identifies the NAND controller driver
 associated with the NAND device being declared.
 @xref{NAND Driver List}.
 @item @var{target} ... names the target used when issuing
diff --git a/src/flash/nand/at91sam9.c b/src/flash/nand/at91sam9.c
index 5cfbb0a..92ab047 100644
--- a/src/flash/nand/at91sam9.c
+++ b/src/flash/nand/at91sam9.c
@@ -697,28 +697,30 @@ static const struct command_registration at91sam9_sub_command_handlers[] = {
 		.handler = handle_at91sam9_cle_command,
 		.mode = COMMAND_CONFIG,
 		.help = "set command latch enable address line (default is 22)",
-		.usage = "<device_id> <address_line>",
+		.usage = "bank_id address_line",
 	},
 	{
 		.name = "ale",
 		.handler = handle_at91sam9_ale_command,
 		.mode = COMMAND_CONFIG,
 		.help = "set address latch enable address line (default is 21)",
-		.usage = "<device_id> <address_line>",
+		.usage = "bank_id address_line",
 	},
 	{
 		.name = "rdy_busy",
 		.handler = handle_at91sam9_rdy_busy_command,
 		.mode = COMMAND_CONFIG,
-		.help = "set the input pin connected to RDY/~BUSY signal (no default)",
-		.usage = "<device_id> <base_pioc> <pin_num>",
+		.help = "set the GPIO input pin connected to "
+			"the RDY/~BUSY signal (no default)",
+		.usage = "bank_id pio_base_addr pin_num",
 	},
 	{
 		.name = "ce",
 		.handler = handle_at91sam9_ce_command,
 		.mode = COMMAND_CONFIG,
-		.help = "set the output pin connected to chip enable signal (no default)",
-		.usage = "<device_id> <base_pioc> <pin_num>",
+		.help = "set the GPIO output pin connected to "
+			"the chip enable signal (no default)",
+		.usage = "bank_id pio_base_addr pin_num",
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/flash/nand/lpc3180.c b/src/flash/nand/lpc3180.c
index 4268b66..51ab34b 100644
--- a/src/flash/nand/lpc3180.c
+++ b/src/flash/nand/lpc3180.c
@@ -878,10 +878,10 @@ COMMAND_HANDLER(handle_lpc3180_select_command)
 static const struct command_registration lpc3180_exec_command_handlers[] = {
 	{
 		.name = "select",
-		.handler = &handle_lpc3180_select_command,
+		.handler = handle_lpc3180_select_command,
 		.mode = COMMAND_EXEC,
-		.help = "select <'mlc'|'slc'> controller (default is mlc)",
-		.usage = "<device_id> (mlc|slc)",
+		.help = "select MLC or SLC controller (default is MLC)",
+		.usage = "bank_id ['mlc'|'slc']",
 	},
 	COMMAND_REGISTRATION_DONE
 };
@@ -896,17 +896,17 @@ static const struct command_registration lpc3180_command_handler[] = {
 };
 
 struct nand_flash_controller lpc3180_nand_controller = {
-		.name = "lpc3180",
-		.commands = lpc3180_command_handler,
-		.nand_device_command = lpc3180_nand_device_command,
-		.init = lpc3180_init,
-		.reset = lpc3180_reset,
-		.command = lpc3180_command,
-		.address = lpc3180_address,
-		.write_data = lpc3180_write_data,
-		.read_data = lpc3180_read_data,
-		.write_page = lpc3180_write_page,
-		.read_page = lpc3180_read_page,
-		.controller_ready = lpc3180_controller_ready,
-		.nand_ready = lpc3180_nand_ready,
-	};
+	.name = "lpc3180",
+	.commands = lpc3180_command_handler,
+	.nand_device_command = lpc3180_nand_device_command,
+	.init = lpc3180_init,
+	.reset = lpc3180_reset,
+	.command = lpc3180_command,
+	.address = lpc3180_address,
+	.write_data = lpc3180_write_data,
+	.read_data = lpc3180_read_data,
+	.write_page = lpc3180_write_page,
+	.read_page = lpc3180_read_page,
+	.controller_ready = lpc3180_controller_ready,
+	.nand_ready = lpc3180_nand_ready,
+};
diff --git a/src/flash/nand/tcl.c b/src/flash/nand/tcl.c
index 4f90c7b..29b4b69 100644
--- a/src/flash/nand/tcl.c
+++ b/src/flash/nand/tcl.c
@@ -446,68 +446,67 @@ COMMAND_HANDLER(handle_nand_raw_access_command)
 static const struct command_registration nand_exec_command_handlers[] = {
 	{
 		.name = "list",
-		.handler = &handle_nand_list_command,
+		.handler = handle_nand_list_command,
 		.mode = COMMAND_EXEC,
 		.help = "list configured NAND flash devices",
 	},
 	{
 		.name = "info",
-		.handler = &handle_nand_info_command,
+		.handler = handle_nand_info_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank>",
-		.help = "print info about a NAND flash device",
+		.usage = "[banknum | first_bank_num last_bank_num]",
+		.help = "print info about one or more NAND flash devices",
 	},
 	{
 		.name = "probe",
-		.handler = &handle_nand_probe_command,
+		.handler = handle_nand_probe_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank>",
-		.help = "identify NAND flash device <num>",
-
+		.usage = "bank_id",
+		.help = "identify NAND flash device",
 	},
 	{
 		.name = "check_bad_blocks",
-		.handler = &handle_nand_check_bad_blocks_command,
+		.handler = handle_nand_check_bad_blocks_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank> [<offset> <length>]",
-		.help = "check NAND flash device <num> for bad blocks",
+		.usage = "bank_id [offset length]",
+		.help = "check all or part of NAND flash device for bad blocks",
 	},
 	{
 		.name = "erase",
-		.handler = &handle_nand_erase_command,
+		.handler = handle_nand_erase_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank> [<offset> <length>]",
-		.help = "erase blocks on NAND flash device",
+		.usage = "bank_id [offset length]",
+		.help = "erase all or subset of blocks on NAND flash device",
 	},
 	{
 		.name = "dump",
-		.handler = &handle_nand_dump_command,
+		.handler = handle_nand_dump_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank> <filename> <offset> <length> "
-			"[oob_raw | oob_only]",
+		.usage = "bank_id filename offset length "
+			"['oob_raw'|'oob_only']",
 		.help = "dump from NAND flash device",
 	},
 	{
 		.name = "verify",
-		.handler = &handle_nand_verify_command,
+		.handler = handle_nand_verify_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank> <filename> <offset> "
-			"[oob_raw | oob_only | oob_softecc | oob_softecc_kw]",
+		.usage = "bank_id filename offset "
+			"['oob_raw'|'oob_only'|'oob_softecc'|'oob_softecc_kw']",
 		.help = "verify NAND flash device",
 	},
 	{
 		.name = "write",
-		.handler = &handle_nand_write_command,
+		.handler = handle_nand_write_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank> <filename> <offset> "
-			"[oob_raw | oob_only | oob_softecc | oob_softecc_kw]",
+		.usage = "bank_id filename offset "
+			"['oob_raw'|'oob_only'|'oob_softecc'|'oob_softecc_kw']",
 		.help = "write to NAND flash device",
 	},
 	{
 		.name = "raw_access",
-		.handler = &handle_nand_raw_access_command,
+		.handler = handle_nand_raw_access_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<num> ['enable'|'disable']",
+		.usage = "bank_id ['enable'|'disable']",
 		.help = "raw access to NAND flash device",
 	},
 	COMMAND_REGISTRATION_DONE
@@ -614,6 +613,7 @@ static const struct command_registration nand_config_command_handlers[] = {
 		.handler = &handle_nand_device_command,
 		.mode = COMMAND_CONFIG,
 		.help = "defines a new NAND bank",
+		.usage = "bank_id driver target [driver_options ...]",
 	},
 	{
 		.name = "drivers",

commit ae710059291ba9830a9b20d899bdef6a5122dd73
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 8 23:13:39 2010 -0800

    Doc/examples: clarify usage messages
    
    Update/bugfix the "hello" example; emphasize using EBNF syntax,
    matching the User's Guide.  Correct the Texinfo style guide to
    say EBNF, not BNF.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/manual/primer/commands.txt b/doc/manual/primer/commands.txt
index 6169734..5f89d50 100644
--- a/doc/manual/primer/commands.txt
+++ b/doc/manual/primer/commands.txt
@@ -68,9 +68,9 @@ static const struct command_registration hello_command_handlers[] = {
 	{
 		.name = "hello",
 		.mode = COMMAND_ANY,
-		.handler = &handle_hello_command,
-		.help = "print a warm greetings",
-		.usage = "[<name>]",
+		.handler = handle_hello_command,
+		.help = "print a warm greeting",
+		.usage = "[name]",
 	},
 	{
 		.chain = foo_command_handlers,
@@ -84,7 +84,12 @@ int hello_register_commands(struct command_context_s *cmd_ctx)
 }
 @endcode
 
-That's it!  The command should now be registered and avaiable to scripts.
+Note that the "usage" text should use the same EBNF that's found
+in the User's Guide:  literals in 'single quotes', sequences of
+optional parameters in [square brackets], and alternatives in
+(parentheses|with|vertical bars), and so forth.  No angle brackets.
+
+That's it!  The command should now be registered and available to scripts.
 
 @section primercmdchain Command Chaining
 
diff --git a/doc/manual/style.txt b/doc/manual/style.txt
index 71bb5f6..87b1e6b 100644
--- a/doc/manual/style.txt
+++ b/doc/manual/style.txt
@@ -308,7 +308,7 @@ For technical reference material:
    - Else it's a "Config Command" if it must be used before the
      configuration stage completes.
    - For a "Driver", list its name.
-   - Use BNF style regular expressions to define parameters:
+   - Use EBNF style regular expressions to define parameters:
      brackets around zero-or-one choices, parentheses around
      exactly-one choices.
    - Use \@option, \@file, \@var and other mechanisms where appropriate.
diff --git a/src/hello.c b/src/hello.c
index 0cd06ad..8cd5fab 100644
--- a/src/hello.c
+++ b/src/hello.c
@@ -58,14 +58,14 @@ static const struct command_registration foo_command_handlers[] = {
 		.name = "bar",
 		.handler = &handle_foo_command,
 		.mode = COMMAND_ANY,
-		.usage = "<address> [enable|disable]",
+		.usage = "address ['enable'|'disable']",
 		.help = "an example command",
 	},
 	{
 		.name = "baz",
 		.handler = &handle_foo_command,
 		.mode = COMMAND_ANY,
-		.usage = "<address> [enable|disable]",
+		.usage = "address ['enable'|'disable']",
 		.help = "a sample command",
 	},
 	{
@@ -107,10 +107,10 @@ COMMAND_HANDLER(handle_hello_command)
 const struct command_registration hello_command_handlers[] = {
 	{
 		.name = "hello",
-		.handler = &handle_hello_command,
+		.handler = handle_hello_command,
 		.mode = COMMAND_ANY,
 		.help = "prints a warm welcome",
-		.usage = "[<name>]",
+		.usage = "[name]",
 	},
 	{
 		.name = "foo",

-----------------------------------------------------------------------

Summary of changes:
 doc/manual/primer/commands.txt |   13 +++++++---
 doc/manual/style.txt           |    2 +-
 doc/openocd.texi               |    6 ++--
 src/flash/nand/at91sam9.c      |   14 ++++++----
 src/flash/nand/lpc3180.c       |   34 +++++++++++++-------------
 src/flash/nand/tcl.c           |   50 ++++++++++++++++++++--------------------
 src/hello.c                    |    8 +++---
 src/helper/command.c           |    4 +-
 src/pld/pld.c                  |   21 ++++++++--------
 src/pld/virtex2.c              |    4 +-
 10 files changed, 82 insertions(+), 74 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sat Jan  9 10:02:51 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sat,  9 Jan 2010 09:02:51 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-78-gfc9a2d0
Message-ID: <E1NTXDh-0004gr-Ai@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  fc9a2d0e6f3270dc86f84749ad10dd79d97c8392 (commit)
      from  aafd3877e6fbc1745dbfc5d4f54a2c7efe8cc3d6 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit fc9a2d0e6f3270dc86f84749ad10dd79d97c8392
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 9 00:55:41 2010 -0800

    src/server: usage/help/doc updates
    
    Make "usage" messages use the same EBNF as the User's Guide;
    no angle brackets.  Improve and correct various helptexts.
    
    Specifically for the port commands, clarify that the number
    is optional, and omitting it causes the current number to be
    displayed.
    
    Don't use "&function"; a function's name is its address.
    Remove a couple instances of pointless whitespace; shrink a
    few overlong lines.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 3adc33a..47951c6 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -1721,17 +1721,17 @@ In such cases, just specify the relevant port number as zero.
 If you disable all access through TCP/IP, you will need to
 use the command line @option{-pipe} option.
 
- at deffn {Command} gdb_port (number)
+ at deffn {Command} gdb_port [number]
 @cindex GDB server
 Specify or query the first port used for incoming GDB connections.
 The GDB port for the
 first target will be gdb_port, the second target will listen on gdb_port + 1, and so on.
 When not specified during the configuration stage,
 the port @var{number} defaults to 3333.
-When specified as zero, this port is not activated.
+When specified as zero, GDB remote access ports are not activated.
 @end deffn
 
- at deffn {Command} tcl_port (number)
+ at deffn {Command} tcl_port [number]
 Specify or query the port used for a simplified RPC
 connection that can be used by clients to issue TCL commands and get the
 output from the Tcl engine.
@@ -1741,7 +1741,7 @@ the port @var{number} defaults to 6666.
 When specified as zero, this port is not activated.
 @end deffn
 
- at deffn {Command} telnet_port (number)
+ at deffn {Command} telnet_port [number]
 Specify or query the
 port on which to listen for incoming telnet connections.
 This port is intended for interaction with one human through TCL commands.
diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index 96b9dbf..08daa68 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -2412,7 +2412,7 @@ COMMAND_HANDLER(handle_gdb_breakpoint_override_command)
 static const struct command_registration gdb_command_handlers[] = {
 	{
 		.name = "gdb_sync",
-		.handler = &handle_gdb_sync_command,
+		.handler = handle_gdb_sync_command,
 		.mode = COMMAND_ANY,
 		.help = "next stepi will return immediately allowing "
 			"GDB to fetch register state without affecting "
@@ -2420,40 +2420,41 @@ static const struct command_registration gdb_command_handlers[] = {
 	},
 	{
 		.name = "gdb_port",
-		.handler = &handle_gdb_port_command,
+		.handler = handle_gdb_port_command,
 		.mode = COMMAND_ANY,
-		.help = "daemon configuration command gdb_port. No arguments reports "
-				"GDB port.",
-		.usage = "<port>",
+		.help = "Display or specify base port on which to listen "
+			"for incoming GDB connections.  "
+			"No arguments reports GDB port; zero disables.",
+		.usage = "[port_num]",
 	},
 	{
 		.name = "gdb_memory_map",
-		.handler = &handle_gdb_memory_map_command,
+		.handler = handle_gdb_memory_map_command,
 		.mode = COMMAND_CONFIG,
 		.help = "enable or disable memory map",
-		.usage = "enable|disable"
+		.usage = "('enable'|'disable')"
 	},
 	{
 		.name = "gdb_flash_program",
-		.handler = &handle_gdb_flash_program_command,
+		.handler = handle_gdb_flash_program_command,
 		.mode = COMMAND_CONFIG,
 		.help = "enable or disable flash program",
-		.usage = "enable|disable"
+		.usage = "('enable'|'disable')"
 	},
 	{
 		.name = "gdb_report_data_abort",
-		.handler = &handle_gdb_report_data_abort_command,
+		.handler = handle_gdb_report_data_abort_command,
 		.mode = COMMAND_CONFIG,
 		.help = "enable or disable reporting data aborts",
-		.usage = "enable|disable"
+		.usage = "('enable'|'disable')"
 	},
 	{
 		.name = "gdb_breakpoint_override",
-		.handler = &handle_gdb_breakpoint_override_command,
+		.handler = handle_gdb_breakpoint_override_command,
 		.mode = COMMAND_EXEC,
-		.help = "force type of breakpoint "
-			"used by gdb 'break' commands.",
-		.usage = "hard|soft|disable",
+		.help = "Display or specify type of breakpoint "
+			"to be used by gdb 'break' commands.",
+		.usage = "('hard'|'soft'|'disable')"
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/server/httpd.c b/src/server/httpd.c
index 9554ff0..af8c3c8 100644
--- a/src/server/httpd.c
+++ b/src/server/httpd.c
@@ -118,11 +118,11 @@ static int httpd_Jim_Command_writeform(Jim_Interp *interp, int argc,
 	// Find length
 	const char *data;
 	int actual;
-
 	int retcode;
-
-	const char *script = alloc_printf("set dummy_val $httppostdata(%s); set dummy_val",
+	const char *script = alloc_printf(
+			"set dummy_val $httppostdata(%s); set dummy_val",
 			name);
+
 	retcode = Jim_Eval_Named(interp, script, __FILE__, __LINE__);
 	free((void *) script);
 	if (retcode != JIM_OK)
@@ -154,27 +154,25 @@ httpd_Jim_Command_formfetch(Jim_Interp *interp,
                                    int argc,
                                    Jim_Obj *const *argv)
 {
-    if (argc != 2)
-    {
-        Jim_WrongNumArgs(interp, 1, argv, "method ?CMD_ARGV ...?");
-        return JIM_ERR;
-    }
-    char *name = (char*)Jim_GetString(argv[1], NULL);
-
-
-    const char *script = alloc_printf("set dummy_val $httppostdata(%s); set dummy_val",
-    			name);
-    	int retcode = Jim_Eval_Named(interp, script, __FILE__, __LINE__);
-    	free((void *) script);
-    	if (retcode != JIM_OK)
-    	{
-    	    Jim_SetResult(interp, Jim_NewEmptyStringObj(interp));
-    	} else
-    	{
-    	    Jim_SetResult(interp, Jim_GetResult(interp));
-    	}
-
-    return JIM_OK;
+	if (argc != 2)
+	{
+		Jim_WrongNumArgs(interp, 1, argv, "method ?CMD_ARGV ...?");
+		return JIM_ERR;
+	}
+
+	char *name = (char*)Jim_GetString(argv[1], NULL);
+	const char *script = alloc_printf(
+		"set dummy_val $httppostdata(%s); set dummy_val",
+		name);
+	int retcode = Jim_Eval_Named(interp, script, __FILE__, __LINE__);
+
+	free((void *) script);
+	if (retcode != JIM_OK)
+		Jim_SetResult(interp, Jim_NewEmptyStringObj(interp));
+	else
+		Jim_SetResult(interp, Jim_GetResult(interp));
+
+	return JIM_OK;
 }
 
 struct httpd_request
@@ -467,16 +465,16 @@ static struct MHD_Daemon * d;
 static const struct command_registration httpd_command_handlers[] = {
 	{
 		.name = "formfetch",
-		.jim_handler = &httpd_Jim_Command_formfetch,
+		.jim_handler = httpd_Jim_Command_formfetch,
 		.mode = COMMAND_EXEC,
-		.usage = "<parameter_name>",
+		.usage = "parameter_name",
 		.help = "Reads a posted form value.",
 	},
 	{
 		.name = "writeform",
-		.jim_handler = &httpd_Jim_Command_writeform,
+		.jim_handler = httpd_Jim_Command_writeform,
 		.mode = COMMAND_EXEC,
-		.usage = "<parameter_name> <file>",
+		.usage = "parameter_name filename",
 		.help = "Writes a form value to a file.",
 	},
 	COMMAND_REGISTRATION_DONE
diff --git a/src/server/tcl_server.c b/src/server/tcl_server.c
index a772c0a..a88c436 100644
--- a/src/server/tcl_server.c
+++ b/src/server/tcl_server.c
@@ -181,11 +181,12 @@ COMMAND_HANDLER(handle_tcl_port_command)
 static const struct command_registration tcl_command_handlers[] = {
 	{
 		.name = "tcl_port",
-		.handler = &handle_tcl_port_command,
+		.handler = handle_tcl_port_command,
 		.mode = COMMAND_CONFIG,
-		.help = "port on which to listen "
-			"for incoming TCL syntax",
-		.usage = "<port>",
+		.help = "Specify port on which to listen "
+			"for incoming Tcl syntax.  "
+			"No arguments reports Tcl port; zero disables.",
+		.usage = "[port_num]",
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/server/telnet_server.c b/src/server/telnet_server.c
index 92e7480..6f26f0a 100644
--- a/src/server/telnet_server.c
+++ b/src/server/telnet_server.c
@@ -619,17 +619,18 @@ COMMAND_HANDLER(handle_exit_command)
 static const struct command_registration telnet_command_handlers[] = {
 	{
 		.name = "exit",
-		.handler = &handle_exit_command,
+		.handler = handle_exit_command,
 		.mode = COMMAND_EXEC,
 		.help = "exit telnet session",
 	},
 	{
 		.name = "telnet_port",
-		.handler = &handle_telnet_port_command,
+		.handler = handle_telnet_port_command,
 		.mode = COMMAND_ANY,
-		.help = "port on which to listen "
-			"for incoming telnet connections",
-		.usage = "<port>",
+		.help = "Specify port on which to listen "
+			"for incoming telnet connections.  "
+			"No arguments reports telnet port; zero disables.",
+		.usage = "[port_num]",
 	},
 	COMMAND_REGISTRATION_DONE
 };

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi           |    8 +++---
 src/server/gdb_server.c    |   31 +++++++++++++------------
 src/server/httpd.c         |   54 +++++++++++++++++++++----------------------
 src/server/tcl_server.c    |    9 ++++---
 src/server/telnet_server.c |   11 +++++----
 5 files changed, 57 insertions(+), 56 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Sat Jan  9 14:46:07 2010
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Sat,  9 Jan 2010 13:46:07 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-79-g70738bd
Message-ID: <E1NTbdp-0004o3-Et@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  70738bd75dbc122e380ff3288542ac4e73700eed (commit)
      from  fc9a2d0e6f3270dc86f84749ad10dd79d97c8392 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 70738bd75dbc122e380ff3288542ac4e73700eed
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Fri Jan 8 22:35:08 2010 +0000

    MIPS: update arch_info access to match other targets
    
     - add target_to_mips32 and target_to_m4k to match test of codebase.
     - mips32_arch_state now shows if processer is running mips16e isa.
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/src/target/mips32.c b/src/target/mips32.c
index 0f6f9b0..5bb4104 100644
--- a/src/target/mips32.c
+++ b/src/target/mips32.c
@@ -38,6 +38,11 @@ char* mips32_core_reg_list[] =
 	"status", "lo", "hi", "badvaddr", "cause", "pc"
 };
 
+const char *mips_isa_strings[] =
+{
+	"MIPS32", "MIPS16e"
+};
+
 struct mips32_core_reg mips32_core_reg_list_arch_info[MIPS32NUMCOREREGS] =
 {
 	{0, NULL, NULL},
@@ -103,7 +108,7 @@ int mips32_get_core_reg(struct reg *reg)
 	int retval;
 	struct mips32_core_reg *mips32_reg = reg->arch_info;
 	struct target *target = mips32_reg->target;
-	struct mips32_common *mips32_target = target->arch_info;
+	struct mips32_common *mips32_target = target_to_mips32(target);
 
 	if (target->state != TARGET_HALTED)
 	{
@@ -139,7 +144,7 @@ int mips32_read_core_reg(struct target *target, int num)
 	struct mips32_core_reg *mips_core_reg;
 
 	/* get pointers to arch-specific information */
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 
 	if ((num < 0) || (num >= MIPS32NUMCOREREGS))
 		return ERROR_INVALID_ARGUMENTS;
@@ -159,7 +164,7 @@ int mips32_write_core_reg(struct target *target, int num)
 	struct mips32_core_reg *mips_core_reg;
 
 	/* get pointers to arch-specific information */
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 
 	if ((num < 0) || (num >= MIPS32NUMCOREREGS))
 		return ERROR_INVALID_ARGUMENTS;
@@ -177,7 +182,7 @@ int mips32_write_core_reg(struct target *target, int num)
 int mips32_get_gdb_reg_list(struct target *target, struct reg **reg_list[], int *reg_list_size)
 {
 	/* get pointers to arch-specific information */
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	int i;
 
 	/* include floating point registers */
@@ -203,7 +208,7 @@ int mips32_save_context(struct target *target)
 	int i;
 
 	/* get pointers to arch-specific information */
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	struct mips_ejtag *ejtag_info = &mips32->ejtag_info;
 
 	/* read core registers */
@@ -225,7 +230,7 @@ int mips32_restore_context(struct target *target)
 	int i;
 
 	/* get pointers to arch-specific information */
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	struct mips_ejtag *ejtag_info = &mips32->ejtag_info;
 
 	for (i = 0; i < MIPS32NUMCOREREGS; i++)
@@ -244,15 +249,10 @@ int mips32_restore_context(struct target *target)
 
 int mips32_arch_state(struct target *target)
 {
-	struct mips32_common *mips32 = target->arch_info;
-
-	if (mips32->common_magic != MIPS32_COMMON_MAGIC)
-	{
-		LOG_ERROR("BUG: called for a non-MIPS32 target");
-		return ERROR_FAIL;
-	}
+	struct mips32_common *mips32 = target_to_mips32(target);
 
-	LOG_USER("target halted due to %s, pc: 0x%8.8" PRIx32 "",
+	LOG_USER("target halted in %s mode due to %s, pc: 0x%8.8" PRIx32 "",
+		mips_isa_strings[mips32->isa_mode],
 		debug_reason_name(target),
 		buf_get_u32(mips32->core_cache->reg_list[MIPS32_PC].value, 0, 32));
 
@@ -267,7 +267,7 @@ static const struct reg_arch_type mips32_reg_type = {
 struct reg_cache *mips32_build_reg_cache(struct target *target)
 {
 	/* get pointers to arch-specific information */
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 
 	int num_regs = MIPS32NUMCOREREGS;
 	struct reg_cache **cache_p = register_get_last_cache_p(&target->reg_cache);
@@ -327,7 +327,7 @@ int mips32_run_algorithm(struct target *target, int num_mem_params, struct mem_p
 
 int mips32_examine(struct target *target)
 {
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 
 	if (!target_was_examined(target))
 	{
@@ -347,7 +347,7 @@ int mips32_examine(struct target *target)
 int mips32_configure_break_unit(struct target *target)
 {
 	/* get pointers to arch-specific information */
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	int retval;
 	uint32_t dcr, bpinfo;
 	int i;
@@ -359,7 +359,7 @@ int mips32_configure_break_unit(struct target *target)
 	if ((retval = target_read_u32(target, EJTAG_DCR, &dcr)) != ERROR_OK)
 		return retval;
 
-	if (dcr & (1 << 16))
+	if (dcr & EJTAG_DCR_IB)
 	{
 		/* get number of inst breakpoints */
 		if ((retval = target_read_u32(target, EJTAG_IBS, &bpinfo)) != ERROR_OK)
@@ -378,7 +378,7 @@ int mips32_configure_break_unit(struct target *target)
 			return retval;
 	}
 
-	if (dcr & (1 << 17))
+	if (dcr & EJTAG_DCR_DB)
 	{
 		/* get number of data breakpoints */
 		if ((retval = target_read_u32(target, EJTAG_DBS, &bpinfo)) != ERROR_OK)
@@ -416,19 +416,19 @@ int mips32_enable_interrupts(struct target *target, int enable)
 
 	if (enable)
 	{
-		if (!(dcr & (1 << 4)))
+		if (!(dcr & EJTAG_DCR_INTE))
 		{
 			/* enable interrupts */
-			dcr |= (1 << 4);
+			dcr |= EJTAG_DCR_INTE;
 			update = 1;
 		}
 	}
 	else
 	{
-		if (dcr & (1 << 4))
+		if (dcr & EJTAG_DCR_INTE)
 		{
 			/* disable interrupts */
-			dcr &= ~(1 << 4);
+			dcr &= ~EJTAG_DCR_INTE;
 			update = 1;
 		}
 	}
diff --git a/src/target/mips32.h b/src/target/mips32.h
index 4fe61bc..b731c68 100644
--- a/src/target/mips32.h
+++ b/src/target/mips32.h
@@ -26,7 +26,6 @@
 #include "target.h"
 #include "mips32_pracc.h"
 
-
 #define MIPS32_COMMON_MAGIC		0xB320B320
 
 /* offsets into mips32 core register cache */
@@ -36,10 +35,17 @@ enum
 	MIPS32NUMCOREREGS
 };
 
+enum mips32_isa_mode
+{
+	MIPS32_ISA_MIPS32 = 0,
+	MIPS32_ISA_MIPS16E = 1,
+};
+
+extern const char *mips_isa_strings[];
+
 struct mips32_comparator
 {
 	int used;
-	//int type;
 	uint32_t bp_value;
 	uint32_t reg_address;
 };
@@ -51,6 +57,7 @@ struct mips32_common
 	struct reg_cache *core_cache;
 	struct mips_ejtag ejtag_info;
 	uint32_t core_regs[MIPS32NUMCOREREGS];
+	enum mips32_isa_mode isa_mode;
 
 	int bp_scanned;
 	int num_inst_bpoints;
@@ -65,6 +72,12 @@ struct mips32_common
 	int (*write_core_reg)(struct target *target, int num);
 };
 
+static inline struct mips32_common *
+target_to_mips32(struct target *target)
+{
+	return target->arch_info;
+}
+
 struct mips32_core_reg
 {
 	uint32_t num;
diff --git a/src/target/mips32_pracc.c b/src/target/mips32_pracc.c
index 52d31bd..11d5a43 100644
--- a/src/target/mips32_pracc.c
+++ b/src/target/mips32_pracc.c
@@ -810,7 +810,7 @@ int mips32_pracc_write_regs(struct mips_ejtag *ejtag_info, uint32_t *regs)
 		MIPS32_LW(2,36*4,1),							/* lw $2,36*4($1) */
 		MIPS32_MTC0(2,13,0),							/* move $2 to cause*/
 		MIPS32_LW(2,37*4,1),							/* lw $2,37*4($1) */
-		MIPS32_MTC0(2,24,0),							/* move $2 to pc */
+		MIPS32_MTC0(2,24,0),							/* move $2 to depc (pc) */
 
 		MIPS32_LW(2,2*4,1),								/* lw $2,2*4($1) */
 		MIPS32_LW(1,0,15),								/* lw $1,($15) */
@@ -884,7 +884,7 @@ int mips32_pracc_read_regs(struct mips_ejtag *ejtag_info, uint32_t *regs)
 		MIPS32_SW(2,35*4,1),							/* sw $2,35*4($1) */
 		MIPS32_MFC0(2,13,0),							/* move cause to $2 */
 		MIPS32_SW(2,36*4,1),							/* sw $2,36*4($1) */
-		MIPS32_MFC0(2,24,0),							/* move pc to $2 */
+		MIPS32_MFC0(2,24,0),							/* move depc (pc) to $2 */
 		MIPS32_SW(2,37*4,1),							/* sw $2,37*4($1) */
 
 		MIPS32_LW(2,0,15),								/* lw $2,($15) */
diff --git a/src/target/mips_ejtag.c b/src/target/mips_ejtag.c
index 58bd392..336adb5 100644
--- a/src/target/mips_ejtag.c
+++ b/src/target/mips_ejtag.c
@@ -264,16 +264,15 @@ int mips_ejtag_init(struct mips_ejtag *ejtag_info)
 			break;
 	}
 	LOG_DEBUG("EJTAG: features:%s%s%s%s%s%s%s",
-		ejtag_info->impcode & (1 << 28) ? " R3k":    " R4k",
-		ejtag_info->impcode & (1 << 24) ? " DINT":   "",
-		ejtag_info->impcode & (1 << 22) ? " ASID_8": "",
-		ejtag_info->impcode & (1 << 21) ? " ASID_6": "",
-		ejtag_info->impcode & (1 << 16) ? " MIPS16": "",
-		ejtag_info->impcode & (1 << 14) ? " noDMA":  " DMA",
-		ejtag_info->impcode & (1 << 0)  ? " MIPS64": " MIPS32"
-);
-
-	if ((ejtag_info->impcode & (1 << 14)) == 0)
+		ejtag_info->impcode & EJTAG_IMP_R3K ? " R3k" : " R4k",
+		ejtag_info->impcode & EJTAG_IMP_DINT ? " DINT" : "",
+		ejtag_info->impcode & (1 << 22) ? " ASID_8" : "",
+		ejtag_info->impcode & (1 << 21) ? " ASID_6" : "",
+		ejtag_info->impcode & EJTAG_IMP_MIPS16 ? " MIPS16" : "",
+		ejtag_info->impcode & EJTAG_IMP_NODMA ? " noDMA" : " DMA",
+		ejtag_info->impcode & EJTAG_DCR_MIPS64  ? " MIPS64" : " MIPS32");
+
+	if ((ejtag_info->impcode & EJTAG_IMP_NODMA) == 0)
 		LOG_DEBUG("EJTAG: DMA Access Mode Support Enabled");
 
 	/* set initial state for ejtag control reg */
diff --git a/src/target/mips_ejtag.h b/src/target/mips_ejtag.h
index e9da39e..2f62f2b 100644
--- a/src/target/mips_ejtag.h
+++ b/src/target/mips_ejtag.h
@@ -40,7 +40,7 @@
 #define EJTAG_INST_TCBDATA		0x12
 #define EJTAG_INST_BYPASS		0xFF
 
-/* debug control register bits ECR */
+/* ejtag control register bits ECR */
 #define EJTAG_CTRL_TOF			(1 << 1)
 #define EJTAG_CTRL_TIF			(1 << 2)
 #define EJTAG_CTRL_BRKST		(1 << 3)
@@ -87,11 +87,20 @@
 #define EJTAG_DEBUG_DBD			(1 << 31)
 
 /* implementaion register bits */
+#define EJTAG_IMP_R3K			(1 << 28)
+#define EJTAG_IMP_DINT			(1 << 24)
 #define EJTAG_IMP_NODMA			(1 << 14)
 #define EJTAG_IMP_MIPS16		(1 << 16)
+#define EJTAG_DCR_MIPS64		(1 << 0)
 
-/* breakpoint support */
+/* Debug Control Register DCR */
 #define EJTAG_DCR				0xFF300000
+#define EJTAG_DCR_ENM			(1 << 29)
+#define EJTAG_DCR_DB			(1 << 17)
+#define EJTAG_DCR_IB			(1 << 16)
+#define EJTAG_DCR_INTE			(1 << 4)
+
+/* breakpoint support */
 #define EJTAG_IBS				0xFF301000
 #define EJTAG_IBA1				0xFF301100
 #define EJTAG_DBS				0xFF302000
@@ -107,7 +116,6 @@ struct mips_ejtag
 	struct jtag_tap *tap;
 	uint32_t impcode;
 	uint32_t idcode;
-	/*int use_dma;*/
 	uint32_t ejtag_ctrl;
 };
 
diff --git a/src/target/mips_m4k.c b/src/target/mips_m4k.c
index f229690..1a65c50 100644
--- a/src/target/mips_m4k.c
+++ b/src/target/mips_m4k.c
@@ -107,12 +107,12 @@ int mips_m4k_examine_debug_reason(struct target *target)
 		}
 
 		/* get info about data breakpoint support */
-		if ((retval = target_read_u32(target, 0xFF302000, &break_status)) != ERROR_OK)
+		if ((retval = target_read_u32(target, EJTAG_DBS, &break_status)) != ERROR_OK)
 			return retval;
 		if (break_status & 0x1f)
 		{
 			/* we have halted on a  breakpoint */
-			if ((retval = target_write_u32(target, 0xFF302000, 0)) != ERROR_OK)
+			if ((retval = target_write_u32(target, EJTAG_DBS, 0)) != ERROR_OK)
 				return retval;
 			target->debug_reason = DBG_REASON_WATCHPOINT;
 		}
@@ -123,14 +123,14 @@ int mips_m4k_examine_debug_reason(struct target *target)
 
 int mips_m4k_debug_entry(struct target *target)
 {
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	struct mips_ejtag *ejtag_info = &mips32->ejtag_info;
 	uint32_t debug_reg;
 
 	/* read debug register */
 	mips_ejtag_read_debug(ejtag_info, &debug_reg);
 
-	/* make sure break uit configured */
+	/* make sure break unit configured */
 	mips32_configure_break_unit(target);
 
 	/* attempt to find halt reason */
@@ -145,9 +145,21 @@ int mips_m4k_debug_entry(struct target *target)
 
 	mips32_save_context(target);
 
+	/* default to mips32 isa, it will be changed below if required */
+	mips32->isa_mode = MIPS32_ISA_MIPS32;
+
+	if (ejtag_info->impcode & EJTAG_IMP_MIPS16)
+	{
+		if (buf_get_u32(mips32->core_cache->reg_list[MIPS32_PC].value, 0, 32) & 0x01)
+		{
+			/* core is running mips16e isa */
+			mips32->isa_mode = MIPS32_ISA_MIPS16E;
+		}
+	}
+
 	LOG_DEBUG("entered debug state at PC 0x%" PRIx32 ", target->state: %s",
-		*(uint32_t*)(mips32->core_cache->reg_list[MIPS32_PC].value),
-		  target_state_name(target));
+			buf_get_u32(mips32->core_cache->reg_list[MIPS32_PC].value, 0, 32),
+			target_state_name(target));
 
 	return ERROR_OK;
 }
@@ -155,7 +167,7 @@ int mips_m4k_debug_entry(struct target *target)
 int mips_m4k_poll(struct target *target)
 {
 	int retval;
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	struct mips_ejtag *ejtag_info = &mips32->ejtag_info;
 	uint32_t ejtag_ctrl = ejtag_info->ejtag_ctrl;
 
@@ -215,7 +227,7 @@ int mips_m4k_poll(struct target *target)
 
 int mips_m4k_halt(struct target *target)
 {
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	struct mips_ejtag *ejtag_info = &mips32->ejtag_info;
 
 	LOG_DEBUG("target->state: %s",
@@ -260,7 +272,7 @@ int mips_m4k_halt(struct target *target)
 
 int mips_m4k_assert_reset(struct target *target)
 {
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	struct mips_ejtag *ejtag_info = &mips32->ejtag_info;
 
 	LOG_DEBUG("target->state: %s",
@@ -339,7 +351,7 @@ int mips_m4k_soft_reset_halt(struct target *target)
 
 int mips_m4k_single_step_core(struct target *target)
 {
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	struct mips_ejtag *ejtag_info = &mips32->ejtag_info;
 
 	/* configure single step mode */
@@ -358,7 +370,7 @@ int mips_m4k_single_step_core(struct target *target)
 
 int mips_m4k_resume(struct target *target, int current, uint32_t address, int handle_breakpoints, int debug_execution)
 {
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	struct mips_ejtag *ejtag_info = &mips32->ejtag_info;
 	struct breakpoint *breakpoint = NULL;
 	uint32_t resume_pc;
@@ -430,7 +442,7 @@ int mips_m4k_resume(struct target *target, int current, uint32_t address, int ha
 int mips_m4k_step(struct target *target, int current, uint32_t address, int handle_breakpoints)
 {
 	/* get pointers to arch-specific information */
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	struct mips_ejtag *ejtag_info = &mips32->ejtag_info;
 	struct breakpoint *breakpoint = NULL;
 
@@ -494,7 +506,7 @@ void mips_m4k_enable_breakpoints(struct target *target)
 
 int mips_m4k_set_breakpoint(struct target *target, struct breakpoint *breakpoint)
 {
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	struct mips32_comparator * comparator_list = mips32->inst_break_list;
 	int retval;
 
@@ -585,8 +597,8 @@ int mips_m4k_set_breakpoint(struct target *target, struct breakpoint *breakpoint
 int mips_m4k_unset_breakpoint(struct target *target, struct breakpoint *breakpoint)
 {
 	/* get pointers to arch-specific information */
-	struct mips32_common *mips32 = target->arch_info;
-	struct mips32_comparator * comparator_list = mips32->inst_break_list;
+	struct mips32_common *mips32 = target_to_mips32(target);
+	struct mips32_comparator *comparator_list = mips32->inst_break_list;
 	int retval;
 
 	if (!breakpoint->set)
@@ -659,7 +671,7 @@ int mips_m4k_unset_breakpoint(struct target *target, struct breakpoint *breakpoi
 
 int mips_m4k_add_breakpoint(struct target *target, struct breakpoint *breakpoint)
 {
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 
 	if (breakpoint->type == BKPT_HARD)
 	{
@@ -680,7 +692,7 @@ int mips_m4k_add_breakpoint(struct target *target, struct breakpoint *breakpoint
 int mips_m4k_remove_breakpoint(struct target *target, struct breakpoint *breakpoint)
 {
 	/* get pointers to arch-specific information */
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 
 	if (target->state != TARGET_HALTED)
 	{
@@ -701,8 +713,8 @@ int mips_m4k_remove_breakpoint(struct target *target, struct breakpoint *breakpo
 
 int mips_m4k_set_watchpoint(struct target *target, struct watchpoint *watchpoint)
 {
-	struct mips32_common *mips32 = target->arch_info;
-	struct mips32_comparator * comparator_list = mips32->data_break_list;
+	struct mips32_common *mips32 = target_to_mips32(target);
+	struct mips32_comparator *comparator_list = mips32->data_break_list;
 	int wp_num = 0;
 	/*
 	 * watchpoint enabled, ignore all byte lanes in value register
@@ -769,8 +781,8 @@ int mips_m4k_set_watchpoint(struct target *target, struct watchpoint *watchpoint
 int mips_m4k_unset_watchpoint(struct target *target, struct watchpoint *watchpoint)
 {
 	/* get pointers to arch-specific information */
-	struct mips32_common *mips32 = target->arch_info;
-	struct mips32_comparator * comparator_list = mips32->data_break_list;
+	struct mips32_common *mips32 = target_to_mips32(target);
+	struct mips32_comparator *comparator_list = mips32->data_break_list;
 
 	if (!watchpoint->set)
 	{
@@ -794,7 +806,7 @@ int mips_m4k_unset_watchpoint(struct target *target, struct watchpoint *watchpoi
 
 int mips_m4k_add_watchpoint(struct target *target, struct watchpoint *watchpoint)
 {
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 
 	if (mips32->num_data_bpoints_avail < 1)
 	{
@@ -811,7 +823,7 @@ int mips_m4k_add_watchpoint(struct target *target, struct watchpoint *watchpoint
 int mips_m4k_remove_watchpoint(struct target *target, struct watchpoint *watchpoint)
 {
 	/* get pointers to arch-specific information */
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 
 	if (target->state != TARGET_HALTED)
 	{
@@ -844,7 +856,7 @@ void mips_m4k_enable_watchpoints(struct target *target)
 
 int mips_m4k_read_memory(struct target *target, uint32_t address, uint32_t size, uint32_t count, uint8_t *buffer)
 {
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	struct mips_ejtag *ejtag_info = &mips32->ejtag_info;
 
 	LOG_DEBUG("address: 0x%8.8" PRIx32 ", size: 0x%8.8" PRIx32 ", count: 0x%8.8" PRIx32 "", address, size, count);
@@ -876,7 +888,7 @@ int mips_m4k_read_memory(struct target *target, uint32_t address, uint32_t size,
 
 int mips_m4k_write_memory(struct target *target, uint32_t address, uint32_t size, uint32_t count, uint8_t *buffer)
 {
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	struct mips_ejtag *ejtag_info = &mips32->ejtag_info;
 
 	LOG_DEBUG("address: 0x%8.8" PRIx32 ", size: 0x%8.8" PRIx32 ", count: 0x%8.8" PRIx32 "", address, size, count);
@@ -923,7 +935,7 @@ int mips_m4k_init_arch_info(struct target *target, struct mips_m4k_common *mips_
 
 int mips_m4k_target_create(struct target *target, Jim_Interp *interp)
 {
-	struct mips_m4k_common *mips_m4k = calloc(1,sizeof(struct mips_m4k_common));
+	struct mips_m4k_common *mips_m4k = calloc(1, sizeof(struct mips_m4k_common));
 
 	mips_m4k_init_arch_info(target, mips_m4k, target->tap);
 
@@ -933,7 +945,7 @@ int mips_m4k_target_create(struct target *target, Jim_Interp *interp)
 int mips_m4k_examine(struct target *target)
 {
 	int retval;
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	struct mips_ejtag *ejtag_info = &mips32->ejtag_info;
 	uint32_t idcode = 0;
 
@@ -963,7 +975,7 @@ int mips_m4k_examine(struct target *target)
 
 int mips_m4k_bulk_write_memory(struct target *target, uint32_t address, uint32_t count, uint8_t *buffer)
 {
-	struct mips32_common *mips32 = target->arch_info;
+	struct mips32_common *mips32 = target_to_mips32(target);
 	struct mips_ejtag *ejtag_info = &mips32->ejtag_info;
 	struct working_area *source;
 	int retval;
diff --git a/src/target/mips_m4k.h b/src/target/mips_m4k.h
index c5f9be2..4fe14a0 100644
--- a/src/target/mips_m4k.h
+++ b/src/target/mips_m4k.h
@@ -35,6 +35,13 @@ struct mips_m4k_common
 	struct mips32_common mips32_common;
 };
 
+static inline struct mips_m4k_common *
+target_to_m4k(struct target *target)
+{
+	return container_of(target->arch_info,
+			struct mips_m4k_common, mips32_common);
+}
+
 int mips_m4k_bulk_write_memory(struct target *target,
 		uint32_t address, uint32_t count, uint8_t *buffer);
 

-----------------------------------------------------------------------

Summary of changes:
 src/target/mips32.c       |   46 +++++++++++++++---------------
 src/target/mips32.h       |   17 ++++++++++-
 src/target/mips32_pracc.c |    4 +-
 src/target/mips_ejtag.c   |   19 ++++++------
 src/target/mips_ejtag.h   |   14 +++++++--
 src/target/mips_m4k.c     |   68 ++++++++++++++++++++++++++------------------
 src/target/mips_m4k.h     |    7 ++++
 7 files changed, 107 insertions(+), 68 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sat Jan  9 19:28:48 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sat,  9 Jan 2010 18:28:48 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-80-g1c5c57e
Message-ID: <E1NTg3N-0007lF-A9@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  1c5c57ec8e3f285cc81d4ad101edccb82b721beb (commit)
      from  70738bd75dbc122e380ff3288542ac4e73700eed (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 1c5c57ec8e3f285cc81d4ad101edccb82b721beb
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 9 08:58:38 2010 -0800

    src/flash/nor: usage/help/doc updates
    
    Make "usage" messages use the same EBNF as the User's Guide;
    no angle brackets.  Improve and correct various helptexts.
    
    Don't use "&function"; a function's name is its address.
    Remove a couple instances of pointless whitespace; shrink a
    few overlong lines; fix some bad indents.
    
    Add TODO list entry re full support for NAND/NOR bank names.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/TODO b/TODO
index 73e4aa7..41d3457 100644
--- a/TODO
+++ b/TODO
@@ -215,6 +215,10 @@ https://lists.berlios.de/pipermail/openocd-development/2009-October/011506.html
   - NOR flash_write_unlock() does that between sectors
   - there may be other cases too
 
+- Make sure all commands accept either a bank name or a bank number,
+  and be sure both identifiers show up in "flash banks" and "nand list".
+  Right now the user-friendly names are pretty much hidden...
+
 @subsection thelistflashcfi CFI
 
 - finish implementing bus width/chip width handling (suggested by NC)
diff --git a/doc/openocd.texi b/doc/openocd.texi
index 47951c6..f8956a3 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -3737,7 +3737,7 @@ see the driver-specific documentation.
 
 @itemize @bullet
 @item @var{name} ... may be used to reference the flash bank
-in other flash commands.
+in other flash commands.  A number is also available.
 @item @var{driver} ... identifies the controller driver
 associated with the flash bank being declared.
 This is usually @code{cfi} for external flash, or else
@@ -4103,7 +4103,7 @@ plane (of up to 256KB), and it will be used automatically when you issue
 @command{flash erase_sector} or @command{flash erase_address} commands.
 
 @deffn Command {at91sam7 gpnvm} bitnum (@option{set}|@option{clear})
-Set or clear a ``General Purpose Non-Volatle Memory'' (GPNVM)
+Set or clear a ``General Purpose Non-Volatile Memory'' (GPNVM)
 bit for the processor.   Each processor has a number of such bits,
 used for controlling features such as brownout detection (so they
 are not truly general purpose).
diff --git a/src/flash/nor/at91sam3.c b/src/flash/nor/at91sam3.c
index 1194e25..5dacf6f 100644
--- a/src/flash/nor/at91sam3.c
+++ b/src/flash/nor/at91sam3.c
@@ -2288,7 +2288,7 @@ COMMAND_HANDLER(sam3_handle_info_command)
 			return ERROR_FAIL;
 		}
 	}
-	// above garentees the "chip details" structure is valid
+	// above guarantees the "chip details" structure is valid
 	// and thus, bank private areas are valid
 	// and we have a SAM3 chip, what a concept!
 
@@ -2386,7 +2386,7 @@ COMMAND_HANDLER(sam3_handle_gpnvm_command)
 
 	if (0 == strcmp("show", CMD_ARGV[0])) {
 		if (who == -1) {
-		showall:
+showall:
 			r = ERROR_OK;
 			for (x = 0 ; x < pChip->details.n_gpnvms ; x++) {
 				r = FLASHD_GetGPNVM(&(pChip->details.bank[0]), x, &v);
@@ -2466,24 +2466,27 @@ COMMAND_HANDLER(sam3_handle_slowclk_command)
 static const struct command_registration at91sam3_exec_command_handlers[] = {
 	{
 		.name = "gpnvm",
-		.handler = &sam3_handle_gpnvm_command,
+		.handler = sam3_handle_gpnvm_command,
 		.mode = COMMAND_EXEC,
-		.usage = "[(set|clear) [<bit_id>]]",
-		.help = "Without arguments, shows the gpnvm register; "
-			"otherwise, sets or clear the specified bit.",
+		.usage = "[('clr'|'set'|'show') bitnum]",
+		.help = "Without arguments, shows all bits in the gpnvm "
+			"register.  Otherwise, clears, sets, or shows one "
+			"General Purpose Non-Volatile Memory (gpnvm) bit.",
 	},
 	{
 		.name = "info",
-		.handler = &sam3_handle_info_command,
+		.handler = sam3_handle_info_command,
 		.mode = COMMAND_EXEC,
-		.help = "print information about the current sam3 chip",
+		.help = "Print information about the current at91sam3 chip"
+			"and its flash configuration.",
 	},
 	{
 		.name = "slowclk",
-		.handler = &sam3_handle_slowclk_command,
+		.handler = sam3_handle_slowclk_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<value>",
-		.help = "set the slowclock frequency (default 32768hz)",
+		.usage = "[clock_hz]",
+		.help = "Display or set the slowclock frequency "
+			"(default 32768 Hz).",
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/flash/nor/at91sam7.c b/src/flash/nor/at91sam7.c
index 97d6b56..cca0cf2 100644
--- a/src/flash/nor/at91sam7.c
+++ b/src/flash/nor/at91sam7.c
@@ -1182,10 +1182,11 @@ COMMAND_HANDLER(at91sam7_handle_gpnvm_command)
 static const struct command_registration at91sam7_exec_command_handlers[] = {
 	{
 		.name = "gpnvm",
-		.handler = &at91sam7_handle_gpnvm_command,
+		.handler = at91sam7_handle_gpnvm_command,
 		.mode = COMMAND_EXEC,
-		.usage = "gpnvm <bit> set | clear, "
-			"set or clear one gpnvm bit",
+		.help = "set or clear one General Purpose Non-Volatile Memory "
+			"(gpnvm) bit",
+		.usage = "bitnum ('set'|'clear')",
 	},
 	COMMAND_REGISTRATION_DONE
 };
@@ -1200,15 +1201,15 @@ static const struct command_registration at91sam7_command_handlers[] = {
 };
 
 struct flash_driver at91sam7_flash = {
-		.name = "at91sam7",
-		.commands = at91sam7_command_handlers,
-		.flash_bank_command = &at91sam7_flash_bank_command,
-		.erase = &at91sam7_erase,
-		.protect = &at91sam7_protect,
-		.write = &at91sam7_write,
-		.probe = &at91sam7_probe,
-		.auto_probe = &at91sam7_probe,
-		.erase_check = &at91sam7_erase_check,
-		.protect_check = &at91sam7_protect_check,
-		.info = &at91sam7_info,
-	};
+	.name = "at91sam7",
+	.commands = at91sam7_command_handlers,
+	.flash_bank_command = at91sam7_flash_bank_command,
+	.erase = at91sam7_erase,
+	.protect = at91sam7_protect,
+	.write = at91sam7_write,
+	.probe = at91sam7_probe,
+	.auto_probe = at91sam7_probe,
+	.erase_check = at91sam7_erase_check,
+	.protect_check = at91sam7_protect_check,
+	.info = at91sam7_info,
+};
diff --git a/src/flash/nor/lpc2900.c b/src/flash/nor/lpc2900.c
index 13dd731..d39b2dd 100644
--- a/src/flash/nor/lpc2900.c
+++ b/src/flash/nor/lpc2900.c
@@ -953,43 +953,47 @@ static const struct command_registration lpc2900_exec_command_handlers[] = {
 		.name = "signature",
 		.handler = &lpc2900_handle_signature_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank>",
-		.help = "print device signature of flash bank",
+		.usage = "bank_id",
+		.help = "Calculate and display signature of flash bank.",
 	},
 	{
 		.name = "read_custom",
 		.handler = &lpc2900_handle_read_custom_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank> <filename>",
-		.help = "read customer information from index sector to file",
+		.usage = "bank_id filename",
+		.help = "Copies 912 bytes of customer information "
+			"from index sector into file.",
 	},
 	{
 		.name = "password",
 		.handler = &lpc2900_handle_password_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank> <password>",
-		.help = "enter password to enable 'dangerous' options",
+		.usage = "bank_id password",
+		.help = "Enter fixed password to enable 'dangerous' options.",
 	},
 	{
 		.name = "write_custom",
 		.handler = &lpc2900_handle_write_custom_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank> <filename> [<type>]",
-		.help = "write customer info from file to index sector",
+		.usage = "bank_id filename ('bin'|'ihex'|'elf'|'s19')",
+		.help = "Copies 912 bytes of customer info from file "
+			"to index sector.",
 	},
 	{
 		.name = "secure_sector",
 		.handler = &lpc2900_handle_secure_sector_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank> <first> <last>",
-		.help = "activate sector security for a range of sectors",
+		.usage = "bank_id first_sector last_sector",
+		.help = "Activate sector security for a range of sectors.  "
+			"It will be effective after a power cycle.",
 	},
 	{
 		.name = "secure_jtag",
 		.handler = &lpc2900_handle_secure_jtag_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank> <level>",
-		.help = "activate JTAG security",
+		.usage = "bank_id",
+		.help = "Disable the JTAG port.  "
+			"It will be effective after a power cycle.",
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/flash/nor/stm32x.c b/src/flash/nor/stm32x.c
index 9e08576..75dcf3b 100644
--- a/src/flash/nor/stm32x.c
+++ b/src/flash/nor/stm32x.c
@@ -1066,29 +1066,36 @@ COMMAND_HANDLER(stm32x_handle_options_write_command)
 		return ERROR_TARGET_NOT_HALTED;
 	}
 
+	/* REVISIT: ignores some options which we will display...
+	 * and doesn't insist on the specified syntax.
+	 */
+
+	/* OPT_RDWDGSW */
 	if (strcmp(CMD_ARGV[1], "SWWDG") == 0)
 	{
 		optionbyte |= (1 << 0);
 	}
-	else
+	else	/* REVISIT must be "HWWDG" then ... */
 	{
 		optionbyte &= ~(1 << 0);
 	}
 
+	/* OPT_RDRSTSTDBY */
 	if (strcmp(CMD_ARGV[2], "NORSTSTNDBY") == 0)
 	{
 		optionbyte |= (1 << 1);
 	}
-	else
+	else	/* REVISIT must be "RSTSTNDBY" then ... */
 	{
 		optionbyte &= ~(1 << 1);
 	}
 
+	/* OPT_RDRSTSTOP */
 	if (strcmp(CMD_ARGV[3], "NORSTSTOP") == 0)
 	{
 		optionbyte |= (1 << 2);
 	}
-	else
+	else	/* REVISIT must be "RSTSTOP" then ... */
 	{
 		optionbyte &= ~(1 << 2);
 	}
@@ -1188,36 +1195,38 @@ static const struct command_registration stm32x_exec_command_handlers[] = {
 		.name = "lock",
 		.handler = &stm32x_handle_lock_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank>",
-		.help = "lock device",
+		.usage = "bank_id",
+		.help = "Lock entire flash device.",
 	},
 	{
 		.name = "unlock",
 		.handler = &stm32x_handle_unlock_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank>",
-		.help = "unlock protected device",
+		.usage = "bank_id",
+		.help = "Unlock entire protected flash device.",
 	},
 	{
 		.name = "mass_erase",
 		.handler = &stm32x_handle_mass_erase_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank>",
-		.help = "mass erase device",
+		.usage = "bank_id",
+		.help = "Erase entire flash device.",
 	},
 	{
 		.name = "options_read",
 		.handler = &stm32x_handle_options_read_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank>",
-		.help = "read device option bytes",
+		.usage = "bank_id",
+		.help = "Read and display device option byte.",
 	},
 	{
 		.name = "options_write",
 		.handler = &stm32x_handle_options_write_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank> <SWWDG | HWWDG> <RSTSTNDBY | NORSTSTNDBY> <RSTSTOP | NORSTSTOP>",
-		.help = "write device option bytes",
+		.usage = "bank_id ('SWWDG'|'HWWDG') "
+			"('RSTSTNDBY'|'NORSTSTNDBY') "
+			"('RSTSTOP'|'NORSTSTOP')",
+		.help = "Replace bits in device option byte.",
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/flash/nor/str9x.c b/src/flash/nor/str9x.c
index 9cddb50..bf3f750 100644
--- a/src/flash/nor/str9x.c
+++ b/src/flash/nor/str9x.c
@@ -679,11 +679,12 @@ COMMAND_HANDLER(str9x_handle_flash_config_command)
 
 static const struct command_registration str9x_config_command_handlers[] = {
 	{
-		.name = "disable_jtag",
+		.name = "flash_config",
 		.handler = &str9x_handle_flash_config_command,
 		.mode = COMMAND_EXEC,
-		.help = "configure str9x flash controller",
-		.usage = "<bank_id> <BBSR> <NBBSR> <BBADR> <NBBADR>",
+		.help = "Configure str9x flash controller, prior to "
+			"programming the flash.",
+		.usage = "bank_id BBSR NBBSR BBADR NBBADR",
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/flash/nor/tcl.c b/src/flash/nor/tcl.c
index ad2b8f1..65523fb 100644
--- a/src/flash/nor/tcl.c
+++ b/src/flash/nor/tcl.c
@@ -654,89 +654,99 @@ void flash_set_dirty(void)
 static const struct command_registration flash_exec_command_handlers[] = {
 	{
 		.name = "probe",
-		.handler = &handle_flash_probe_command,
+		.handler = handle_flash_probe_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank>",
-		.help = "identify flash bank",
+		.usage = "bank_id",
+		.help = "Identify a flash bank.",
 	},
 	{
 		.name = "info",
-		.handler = &handle_flash_info_command,
+		.handler = handle_flash_info_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank>",
-		.help = "print bank information",
+		.usage = "bank_id",
+		.help = "Print information about a flash bank.",
 	},
 	{
 		.name = "erase_check",
-		.handler = &handle_flash_erase_check_command,
+		.handler = handle_flash_erase_check_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank>",
-		.help = "check erase state of sectors",
+		.usage = "bank_id",
+		.help = "Check erase state of all blocks in a "
+			"flash bank.",
 	},
 	{
 		.name = "protect_check",
-		.handler = &handle_flash_protect_check_command,
+		.handler = handle_flash_protect_check_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank>",
-		.help = "check protection state of sectors",
+		.usage = "bank_id",
+		.help = "Check protection state of all blocks in a "
+			"flash bank.",
 	},
 	{
 		.name = "erase_sector",
-		.handler = &handle_flash_erase_command,
+		.handler = handle_flash_erase_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank> <first> <last>",
-		.help = "erase sectors",
+		.usage = "bank_id first_sector_num last_sector_num",
+		.help = "Erase a range of sectors in a flash bank.",
 	},
 	{
 		.name = "erase_address",
-		.handler = &handle_flash_erase_address_command,
+		.handler = handle_flash_erase_address_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<address> <length>",
-		.help = "erase address range",
-
+		.usage = "address length",
+		.help = "Erase flash blocks starting at address "
+			"and continuing for length bytes.",
 	},
 	{
 		.name = "fillw",
-		.handler = &handle_flash_fill_command,
+		.handler = handle_flash_fill_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<address> <word_pattern> <count>",
-		.help = "fill with pattern (no autoerase)",
+		.usage = "address value n",
+		.help = "Fill n words with 32-bit value, starting at "
+			"word address.  (No autoerase.)",
 	},
 	{
 		.name = "fillh",
-		.handler = &handle_flash_fill_command,
+		.handler = handle_flash_fill_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<address> <halfword_pattern> <count>",
-		.help = "fill with pattern",
+		.usage = "address value n",
+		.help = "Fill n halfwords with 16-bit value, starting at "
+			"word address.  (No autoerase.)",
 	},
 	{
 		.name = "fillb",
-		.handler = &handle_flash_fill_command,
+		.handler = handle_flash_fill_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<address> <byte_pattern> <count>",
-		.help = "fill with pattern",
-
+		.usage = "address value n",
+		.help = "Fill n bytes with 8-bit value, starting at "
+			"word address.  (No autoerase.)",
 	},
 	{
 		.name = "write_bank",
-		.handler = &handle_flash_write_bank_command,
+		.handler = handle_flash_write_bank_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank> <file> <offset>",
-		.help = "write binary data",
+		.usage = "bank_id filename offset",
+		.help = "Write binary data from file to flash bank, "
+			"starting at specified byte offset from the "
+			"beginning of the bank.",
 	},
 	{
 		.name = "write_image",
-		.handler = &handle_flash_write_image_command,
+		.handler = handle_flash_write_image_command,
 		.mode = COMMAND_EXEC,
-		.usage = "[erase] [unlock] <file> [offset] [type]",
-		.help = "write an image to flash"
+		.usage = "[erase] [unlock] filename [offset [file_type]]",
+		.help = "Write an image to flash.  Optionally first unprotect "
+			"and/or erase the region to be used.  Allow optional "
+			"offset from beginning of bank (defaults to zero)",
 	},
 	{
 		.name = "protect",
-		.handler = &handle_flash_protect_command,
+		.handler = handle_flash_protect_command,
 		.mode = COMMAND_EXEC,
-		.usage = "<bank> <first> <last> <on | off>",
-		.help = "set protection of sectors",
+		.usage = "bank_id first_sector [last_sector|'last'] "
+			"('on'|'off')",
+		.help = "Turn protection on or off for a range of sectors "
+			"in a given flash bank.",
 	},
 	COMMAND_REGISTRATION_DONE
 };
@@ -893,8 +903,8 @@ static const struct command_registration flash_config_command_handlers[] = {
 		.name = "bank",
 		.handler = &handle_flash_bank_command,
 		.mode = COMMAND_CONFIG,
-		.usage = "<name> <driver> <base> <size> "
-			"<chip_width> <bus_width> <target> "
+		.usage = "bank_id driver_name base_address size_bytes "
+			"chip_width_bytes bus_width_bytes target "
 			"[driver_options ...]",
 		.help = "Define a new bank with the given name, "
 			"using the specified NOR flash driver.",
@@ -903,19 +913,19 @@ static const struct command_registration flash_config_command_handlers[] = {
 		.name = "init",
 		.mode = COMMAND_CONFIG,
 		.handler = &handle_flash_init_command,
-		.help = "initialize flash devices",
+		.help = "Initialize flash devices.",
 	},
 	{
 		.name = "banks",
 		.mode = COMMAND_ANY,
 		.handler = &handle_flash_banks_command,
-		.help = "return readable information about the flash banks",
+		.help = "Display table with information about flash banks.",
 	},
 	{
 		.name = "list",
 		.mode = COMMAND_ANY,
 		.jim_handler = &jim_flash_list,
-		.help = "returns a list of details about the flash banks",
+		.help = "Returns a list of details about the flash banks.",
 	},
 	COMMAND_REGISTRATION_DONE
 };

-----------------------------------------------------------------------

Summary of changes:
 TODO                     |    4 ++
 doc/openocd.texi         |    4 +-
 src/flash/nor/at91sam3.c |   25 +++++++-----
 src/flash/nor/at91sam7.c |   31 ++++++++-------
 src/flash/nor/lpc2900.c  |   28 ++++++++------
 src/flash/nor/stm32x.c   |   35 ++++++++++------
 src/flash/nor/str9x.c    |    7 ++-
 src/flash/nor/tcl.c      |   96 +++++++++++++++++++++++++--------------------
 8 files changed, 131 insertions(+), 99 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sat Jan  9 22:38:00 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sat,  9 Jan 2010 21:38:00 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-81-g1dd5277
Message-ID: <E1NTj0T-0005E0-CJ@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  1dd5277ba3eb8c5938832b41c2bf6cb5bf19146e (commit)
      from  1c5c57ec8e3f285cc81d4ad101edccb82b721beb (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 1dd5277ba3eb8c5938832b41c2bf6cb5bf19146e
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 9 13:32:08 2010 -0800

    src/helper: usage/help updates
    
    Make "usage" messages use the same EBNF as the User's Guide;
    no angle brackets.  Improve and correct various helptexts.
    
    Don't use "&function"; a function's name is its address.
    Fix some whitespace glitches, shrink a few overlong lines.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/helper/command.c b/src/helper/command.c
index 0ddcd01..288ed72 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -1087,6 +1087,7 @@ static int jim_command_mode(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 {
 	struct command_context *cmd_ctx = current_command_context(interp);
 	enum command_mode mode;
+
 	if (argc > 1)
 	{
 		struct command *c = cmd_ctx->commands;
@@ -1223,7 +1224,7 @@ COMMAND_HANDLER(handle_help_add_command)
 	return help_add_command(CMD_CTX, c, cmd_name, help, usage);
 }
 
-/* sleep command sleeps for <n> miliseconds
+/* sleep command sleeps for <n> milliseconds
  * this is useful in target startup scripts
  */
 COMMAND_HANDLER(handle_sleep_command)
@@ -1263,19 +1264,22 @@ static const struct command_registration command_subcommand_handlers[] = {
 	{
 		.name = "mode",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_command_mode,
-		.usage = "[<name> ...]",
+		.jim_handler = jim_command_mode,
+		.usage = "[command_name ...]",
 		.help = "Returns the command modes allowed by a  command:"
 			"'any', 'config', or 'exec'.  If no command is"
-			"specified, returns the current command mode.",
+			"specified, returns the current command mode.  "
+			"Returns 'unknown' if an unknown command is given. "
+			"Command can be multiple tokens.",
 	},
 	{
 		.name = "type",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_command_type,
-		.usage = "<name> ...",
+		.jim_handler = jim_command_type,
+		.usage = "command_name [...]",
 		.help = "Returns the type of built-in command:"
-			"'native', 'simple', 'group', or 'unknown'",
+			"'native', 'simple', 'group', or 'unknown'. "
+			"Command can be multiple tokens.",
 	},
 	COMMAND_REGISTRATION_DONE
 };
@@ -1283,39 +1287,43 @@ static const struct command_registration command_subcommand_handlers[] = {
 static const struct command_registration command_builtin_handlers[] = {
 	{
 		.name = "add_help_text",
-		.handler = &handle_help_add_command,
+		.handler = handle_help_add_command,
 		.mode = COMMAND_ANY,
-		.help = "add new command help text",
-		.usage = "<command> [...] <help_text>]",
+		.help = "Add new command help text; "
+			"Command can be multiple tokens.",
+		.usage = "command_name helptext_string",
 	},
 	{
 		.name = "add_usage_text",
-		.handler = &handle_help_add_command,
+		.handler = handle_help_add_command,
 		.mode = COMMAND_ANY,
-		.help = "add new command usage text",
-		.usage = "<command> [...] <usage_text>]",
+		.help = "Add new command usage text; "
+			"command can be multiple tokens.",
+		.usage = "command_name usage_string",
 	},
 	{
 		.name = "sleep",
-		.handler = &handle_sleep_command,
+		.handler = handle_sleep_command,
 		.mode = COMMAND_ANY,
-		.help = "sleep for n milliseconds.  "
-			"\"busy\" will busy wait",
-		.usage = "<n> [busy]",
+		.help = "Sleep for specified number of milliseconds.  "
+			"\"busy\" will busy wait instead (avoid this).",
+		.usage = "milliseconds ['busy']",
 	},
 	{
 		.name = "help",
-		.handler = &handle_help_command,
+		.handler = handle_help_command,
 		.mode = COMMAND_ANY,
-		.help = "show full command help",
-		.usage = "[<command> ...]",
+		.help = "Show full command help; "
+			"command can be multiple tokens.",
+		.usage = "[command_name]",
 	},
 	{
 		.name = "usage",
-		.handler = &handle_help_command,
+		.handler = handle_help_command,
 		.mode = COMMAND_ANY,
-		.help = "show basic command usage",
-		.usage = "[<command> ...]",
+		.help = "Show basic command usage; "
+			"command can be multiple tokens.",
+		.usage = "[command_name]",
 	},
 	{
 		.name = "command",
diff --git a/src/helper/ioutil.c b/src/helper/ioutil.c
index 27bffad..14f6e91 100644
--- a/src/helper/ioutil.c
+++ b/src/helper/ioutil.c
@@ -191,6 +191,7 @@ COMMAND_HANDLER(handle_append_command)
 
 	int retval = ERROR_FAIL;
 	FILE *config_file = NULL;
+
 	config_file = fopen(CMD_ARGV[0], "a");
 	if (config_file != NULL)
 	{
@@ -199,7 +200,8 @@ COMMAND_HANDLER(handle_append_command)
 		unsigned i;
 		for (i = 1; i < CMD_ARGC; i++)
 		{
-			if (fwrite(CMD_ARGV[i], 1, strlen(CMD_ARGV[i]), config_file) != strlen(CMD_ARGV[i]))
+			if (fwrite(CMD_ARGV[i], 1, strlen(CMD_ARGV[i]),
+					config_file) != strlen(CMD_ARGV[i]))
 				break;
 			if (i != CMD_ARGC - 1)
 			{
@@ -208,9 +210,8 @@ COMMAND_HANDLER(handle_append_command)
 			}
 		}
 		if ((i == CMD_ARGC) && (fwrite("\n", 1, 1, config_file) == 1))
-		{
 			retval = ERROR_OK;
-		}
+
 		fclose(config_file);
 	}
 
@@ -619,76 +620,86 @@ static int zylinjtag_Jim_Command_mac(Jim_Interp *interp, int argc,
 static const struct command_registration ioutil_command_handlers[] = {
 	{
 		.name = "cat",
-		.handler = &handle_cat_command,
+		.handler = handle_cat_command,
 		.mode = COMMAND_ANY,
-		.help = "display file content",
-		.usage= "<file_name>",
+		.help = "display text file content",
+		.usage= "file_name",
 	},
 	{
 		.name = "trunc",
-		.handler = &handle_trunc_command,
+		.handler = handle_trunc_command,
 		.mode = COMMAND_ANY,
-		.help = "truncate a file 0 size",
-		.usage= "<file_name>",
+		.help = "truncate a file to zero length",
+		.usage= "file_name",
 	},
 	{
 		.name = "cp",
-		.handler = &handle_cp_command,
+		.handler = handle_cp_command,
 		.mode = COMMAND_ANY,
 		.help = "copy a file",
-		.usage = "<src> <dst>",
+		.usage = "src_file_name dst_file_name",
 	},
 	{
 		.name = "append_file",
-		.handler = &handle_append_command,
+		.handler = handle_append_command,
 		.mode = COMMAND_ANY,
 		.help = "append a variable number of strings to a file",
-		.usage= "<file_name> [<string> ...]",
+		.usage= "file_name [string ...]",
 	},
 	{
 		.name = "meminfo",
-		.handler = &handle_meminfo_command,
+		.handler = handle_meminfo_command,
 		.mode = COMMAND_ANY,
-		.help = "display available ram memory",
+		.help = "display free heap space",
 	},
 	{
 		.name = "rm",
 		.mode = COMMAND_ANY,
-		.handler = &handle_rm_command,
-		.help = "remove a file",
-		.usage = "<file>",
+		.handler = handle_rm_command,
+		.help = "remove a directory or file",
+		.usage = "file_name",
 	},
+
+	/*
+	 * REVISIT shouldn't most, or all, these zylinjtag_*()
+	 * entries be #ifdef ZY1000?  If not, why so they have
+	 * those names?
+	 *
+	 * Peek and poke are security holes -- they manipulate
+	 * server-internal addresses.
+	 */
+
 	// jim handlers
 	{
 		.name = "peek",
 		.mode = COMMAND_ANY,
-		.jim_handler = &zylinjtag_Jim_Command_peek,
+		.jim_handler = zylinjtag_Jim_Command_peek,
 		.help = "peek at a memory address",
-		.usage = "<addr>",
+		.usage = "address",
 	},
 	{
 		.name = "poke",
 		.mode = COMMAND_ANY,
-		.jim_handler = &zylinjtag_Jim_Command_poke,
+		.jim_handler = zylinjtag_Jim_Command_poke,
 		.help = "poke at a memory address",
-		.usage = "<addr> <value>",
+		.usage = "address value",
 	},
 	{
 		.name = "ls",
 		.mode = COMMAND_ANY,
-		.jim_handler = &zylinjtag_Jim_Command_ls,
+		.jim_handler = zylinjtag_Jim_Command_ls,
 		.help = "show a listing of files",
-		.usage = "<dir>",
+		.usage = "dirname",
 	},
 	{
 		.name = "mac",
 		.mode = COMMAND_ANY,
-		.jim_handler = &zylinjtag_Jim_Command_mac,
+		.jim_handler = zylinjtag_Jim_Command_mac,
 		.help = "show MAC address",
 	},
 	{
 		.name = "ip",
-		.jim_handler = &zylinjtag_Jim_Command_ip,
+		.jim_handler = zylinjtag_Jim_Command_ip,
 		.mode = COMMAND_ANY,
 		.help = "show IP address",
 	},
diff --git a/src/helper/log.c b/src/helper/log.c
index 6adde4b..7450fef 100644
--- a/src/helper/log.c
+++ b/src/helper/log.c
@@ -286,13 +286,16 @@ COMMAND_HANDLER(handle_debug_level_command)
 
 	if (debug_level >= LOG_LVL_DEBUG && server_use_pipes == 1)
 	{
-		/* if we are enabling debug info then we need to write to a log file
-		 * otherwise the pipe will get full and cause issues with gdb */
+		/* if we are enabling debug info then we need to write to a
+		 * log file otherwise the pipe will get full and cause issues
+		 * with gdb
+		 */
 		FILE* file = fopen("openocd.log", "w");
 		if (file)
 		{
 			log_output = file;
-			LOG_WARNING("enabling log output as we are using pipes");
+			LOG_WARNING("enabling logfile output because "
+				"we are using pipes to talk to GDB.");
 		}
 	}
 
@@ -319,17 +322,19 @@ COMMAND_HANDLER(handle_log_output_command)
 static struct command_registration log_command_handlers[] = {
 	{
 		.name = "log_output",
-		.handler = &handle_log_output_command,
+		.handler = handle_log_output_command,
 		.mode = COMMAND_ANY,
 		.help = "redirect logging to a file (default: stderr)",
-		.usage = "<file_name>",
+		.usage = "file_name",
 	},
 	{
 		.name = "debug_level",
-		.handler = &handle_debug_level_command,
+		.handler = handle_debug_level_command,
 		.mode = COMMAND_ANY,
-		.help = "sets the verbosity level of debugging output",
-		.usage = "<level:0-3>",
+		.help = "Sets the verbosity level of debugging output. "
+			"0 shows errors only; 1 adds warnings; "
+			"2 (default) adds other info; 3 adds debugging.",
+		.usage = "number",
 	},
 	COMMAND_REGISTRATION_DONE
 };

-----------------------------------------------------------------------

Summary of changes:
 src/helper/command.c |   54 ++++++++++++++++++++++++------------------
 src/helper/ioutil.c  |   63 +++++++++++++++++++++++++++++--------------------
 src/helper/log.c     |   21 ++++++++++------
 3 files changed, 81 insertions(+), 57 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sun Jan 10 07:20:58 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sun, 10 Jan 2010 06:20:58 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-86-gab4307e
Message-ID: <E1NTrAa-0001Jv-Cp@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  ab4307e693dad8181f1570b5cdd7f132661a608b (commit)
       via  5cb1dcfad34aab7de64ef85f6227f28f3711dd85 (commit)
       via  0811f6b192674788a00e02fbbfe29e0a2a138ea2 (commit)
       via  ad5fd390634799ecabddc32d0ce415ef72036b4a (commit)
       via  ff647e6bb4180a7c376b61caeb14951ba84d5717 (commit)
      from  1dd5277ba3eb8c5938832b41c2bf6cb5bf19146e (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit ab4307e693dad8181f1570b5cdd7f132661a608b
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 9 22:15:57 2010 -0800

    jtag/tcl help/usage fixups
    
    The usual: expand several helptexts to be more correct and to use
    full sentences; make the usage messages use the same EBNF as the
    User's Guide; use function names for their addresses.
    
    Also add a comment about that odd jtag_command_handlers_to_move[] thing.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/tcl.c b/src/jtag/tcl.c
index 00b1038..7329cee 100644
--- a/src/jtag/tcl.c
+++ b/src/jtag/tcl.c
@@ -269,26 +269,39 @@ static int Jim_Command_flush_count(Jim_Interp *interp, int argc, Jim_Obj *const
 	return JIM_OK;
 }
 
+/* REVISIT Just what about these should "move" ... ?
+ * These registrations, into the main JTAG table?
+ *
+ * There's a minor compatibility issue, these all show up twice;
+ * that's not desirable:
+ *  - jtag drscan ... NOT DOCUMENTED!
+ *  - drscan ...
+ *
+ * The "irscan" command (for example) doesn't show twice.
+ */
 static const struct command_registration jtag_command_handlers_to_move[] = {
 	{
 		.name = "drscan",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &Jim_Command_drscan,
-		.help = "execute DR scan <device> "
-			"<num_bits> <value> <num_bits1> <value2> ...",
+		.jim_handler = Jim_Command_drscan,
+		.help = "Execute Data Register (DR) scan for one TAP.  "
+			"Other TAPs must be in BYPASS mode.",
+		.usage = "tap_name [num_bits value]* ['-endstate' state_name]",
 	},
 	{
 		.name = "flush_count",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &Jim_Command_flush_count,
-		.help = "returns number of times the JTAG queue has been flushed",
+		.jim_handler = Jim_Command_flush_count,
+		.help = "Returns the number of times the JTAG queue "
+			"has been flushed.",
 	},
 	{
 		.name = "pathmove",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &Jim_Command_pathmove,
-		.usage = "<state1>,<state2>,<state3>... ",
-		.help = "move JTAG to state1 then to state2, state3, etc.",
+		.jim_handler = Jim_Command_pathmove,
+		.usage = "start_state state1 [state2 [state3 ...]]",
+		.help = "Move JTAG state machine from current state "
+			"(start_state) to state1, then state2, state3, etc.",
 	},
 	COMMAND_REGISTRATION_DONE
 };
@@ -658,7 +671,8 @@ static void jtag_tap_handle_event(struct jtag_tap *tap, enum jtag_event e)
 	}
 }
 
-static int jim_jtag_interface(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
+static int
+jim_jtag_interface(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 {
 	Jim_GetOptInfo goi;
 	Jim_GetOpt_Setup(&goi, interp, argc-1, argv + 1);
@@ -845,73 +859,88 @@ static const struct command_registration jtag_subcommand_handlers[] = {
 	{
 		.name = "init",
 		.mode = COMMAND_ANY,
-		.handler = &handle_jtag_init_command,
+		.handler = handle_jtag_init_command,
 		.help = "initialize jtag scan chain",
 	},
 	{
 		.name = "interface",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_jtag_interface,
-		.help = "Returns the selected interface",
+		.jim_handler = jim_jtag_interface,
+		.help = "Returns the name of the currently selected interface.",
 	},
 	{
 		.name = "arp_init",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_jtag_arp_init,
+		.jim_handler = jim_jtag_arp_init,
+		.help = "Validates JTAG scan chain against the list of "
+			"declared TAPs using just the four standard JTAG "
+			"signals.",
 	},
 	{
 		.name = "arp_init-reset",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_jtag_arp_init_reset,
+		.jim_handler = jim_jtag_arp_init_reset,
+		.help = "Uses TRST and SRST to try resetting everything on "
+			"the JTAG scan chain, then performs 'jtag arp_init'."
 	},
 	{
 		.name = "newtap",
 		.mode = COMMAND_CONFIG,
-		.jim_handler = &jim_jtag_newtap,
-		.help = "Create a new TAP instance",
-		.usage = "<name> <type> -irlen <count> [-ircapture <count>] "
-			"[-irmask <count>] [-enable|-disable]",
+		.jim_handler = jim_jtag_newtap,
+		.help = "Create a new TAP instance named basename.tap_type, "
+			"and appends it to the scan chain.",
+		.usage = "basename tap_type '-irlen' count "
+			"['-enable'|'-disable'] "
+			"['-expected_id' number] "
+			"['-ignore-version'] "
+			"['-ircapture' number] "
+			"['-mask' number] ",
 	},
 	{
 		.name = "tapisenabled",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_jtag_tap_enabler,
-		.help = "Returns a integer indicating TAP state (0/1)",
-		.usage = "<name>",
+		.jim_handler = jim_jtag_tap_enabler,
+		.help = "Returns a Tcl boolean (0/1) indicating whether "
+			"the TAP is enabled (1) or not (0).",
+		.usage = "tap_name",
 	},
 	{
 		.name = "tapenable",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_jtag_tap_enabler,
-		.help = "Enable the specified TAP",
-		.usage = "<name>",
+		.jim_handler = jim_jtag_tap_enabler,
+		.help = "Try to enable the specified TAP using the "
+			"'tap-enable' TAP event.",
+		.usage = "tap_name",
 	},
 	{
 		.name = "tapdisable",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_jtag_tap_enabler,
-		.help = "Enable the specified TAP",
-		.usage = "<name>",
+		.jim_handler = jim_jtag_tap_enabler,
+		.help = "Try to disable the specified TAP using the "
+			"'tap-disable' TAP event.",
+		.usage = "tap_name",
 	},
 	{
 		.name = "configure",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_jtag_configure,
-		.help = "Enable the specified TAP",
-		.usage = "<name> [<key> <value> ...]",
+		.jim_handler = jim_jtag_configure,
+		.help = "Provide a Tcl handler for the specified "
+			"TAP event.",
+		.usage = "tap_name '-event' event_name handler",
 	},
 	{
 		.name = "cget",
 		.mode = COMMAND_EXEC,
-		.jim_handler = &jim_jtag_configure,
-		.help = "Enable the specified TAP",
-		.usage = "<name> [<key> <value> ...]",
+		.jim_handler = jim_jtag_configure,
+		.help = "Return any Tcl handler for the specified "
+			"TAP event.",
+		.usage = "tap_name '-event' event_name",
 	},
 	{
 		.name = "names",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_jtag_names,
-		.help = "Returns list of all JTAG tap names",
+		.jim_handler = jim_jtag_names,
+		.help = "Returns list of all JTAG tap names.",
 	},
 	{
 		.chain = jtag_command_handlers_to_move,
@@ -1574,34 +1603,38 @@ COMMAND_HANDLER(handle_tms_sequence_command)
 static const struct command_registration jtag_command_handlers[] = {
 	{
 		.name = "interface",
-		.handler = &handle_interface_command,
+		.handler = handle_interface_command,
 		.mode = COMMAND_CONFIG,
-		.help = "select a JTAG interface",
-		.usage = "<driver_name>",
+		.help = "Select a JTAG interface",
+		.usage = "driver_name",
 	},
 	{
 		.name = "interface_list",
-		.handler = &handle_interface_list_command,
+		.handler = handle_interface_list_command,
 		.mode = COMMAND_ANY,
-		.help = "list all built-in interfaces",
+		.help = "List all built-in interfaces",
 	},
 	{
 		.name = "jtag_khz",
-		.handler = &handle_jtag_khz_command,
+		.handler = handle_jtag_khz_command,
 		.mode = COMMAND_ANY,
-		.help = "set maximum jtag speed (if supported)",
-		.usage = "<khz:0=rtck>",
+		.help = "With an argument, change to the specified maximum "
+			"jtag speed.  Pass 0 to require adaptive clocking. "
+			"With or without argument, display current setting.",
+		.usage = "[khz]",
 	},
 	{
 		.name = "jtag_rclk",
-		.handler = &handle_jtag_rclk_command,
+		.handler = handle_jtag_rclk_command,
 		.mode = COMMAND_ANY,
-		.help = "set JTAG speed to RCLK or use fallback speed",
-		.usage = "<fallback_speed_khz>",
+		.help = "With an argument, change to to use adaptive clocking "
+			"if possible; else to use the fallback speed.  "
+			"With or without argument, display current setting.",
+		.usage = "[fallback_speed_khz]",
 	},
 	{
 		.name = "reset_config",
-		.handler = &handle_reset_config_command,
+		.handler = handle_reset_config_command,
 		.mode = COMMAND_ANY,
 		.help = "configure JTAG reset behavior",
 		.usage = "[none|trst_only|srst_only|trst_and_srst] "
@@ -1612,79 +1645,87 @@ static const struct command_registration jtag_command_handlers[] = {
 	},
 	{
 		.name = "jtag_nsrst_delay",
-		.handler = &handle_jtag_nsrst_delay_command,
+		.handler = handle_jtag_nsrst_delay_command,
 		.mode = COMMAND_ANY,
 		.help = "delay after deasserting srst in ms",
-		.usage = "<ms>",
+		.usage = "[milliseconds]",
 	},
 	{
 		.name = "jtag_ntrst_delay",
-		.handler = &handle_jtag_ntrst_delay_command,
+		.handler = handle_jtag_ntrst_delay_command,
 		.mode = COMMAND_ANY,
 		.help = "delay after deasserting trst in ms",
-		.usage = "<ms>"
+		.usage = "[milliseconds]",
 	},
 	{
 		.name = "jtag_nsrst_assert_width",
-		.handler = &handle_jtag_nsrst_assert_width_command,
+		.handler = handle_jtag_nsrst_assert_width_command,
 		.mode = COMMAND_ANY,
 		.help = "delay after asserting srst in ms",
-		.usage = "<ms>"
+		.usage = "[milliseconds]",
 	},
 	{
 		.name = "jtag_ntrst_assert_width",
-		.handler = &handle_jtag_ntrst_assert_width_command,
+		.handler = handle_jtag_ntrst_assert_width_command,
 		.mode = COMMAND_ANY,
 		.help = "delay after asserting trst in ms",
-		.usage = "<ms>"
+		.usage = "[milliseconds]",
 	},
 	{
 		.name = "scan_chain",
-		.handler = &handle_scan_chain_command,
+		.handler = handle_scan_chain_command,
 		.mode = COMMAND_EXEC,
 		.help = "print current scan chain configuration",
 	},
 	{
 		.name = "jtag_reset",
-		.handler = &handle_jtag_reset_command,
+		.handler = handle_jtag_reset_command,
 		.mode = COMMAND_EXEC,
-		.help = "toggle reset lines",
-		.usage = "<trst> <srst>",
+		.help = "Set reset line values.  Value '1' is active, "
+			"value '0' is inactive.",
+		.usage = "trst_active srst_active",
 	},
 	{
 		.name = "runtest",
-		.handler = &handle_runtest_command,
+		.handler = handle_runtest_command,
 		.mode = COMMAND_EXEC,
-		.help = "move to Run-Test/Idle, and execute <num_cycles>",
-		.usage = "<num_cycles>"
+		.help = "Move to Run-Test/Idle, and issue TCK for num_cycles.",
+		.usage = "num_cycles"
 	},
 	{
 		.name = "irscan",
-		.handler = &handle_irscan_command,
+		.handler = handle_irscan_command,
 		.mode = COMMAND_EXEC,
-		.help = "execute IR scan",
-		.usage = "<device> <instr> [dev2] [instr2] ...",
+		.help = "Execute Instruction Register (DR) scan.  The "
+			"specified opcodes are put into each TAP's IR, "
+			"and other TAPs are put in BYPASS.",
+		.usage = "[tap_name instruction]* ['-endstate' state_name]",
 	},
 	{
 		.name = "verify_ircapture",
-		.handler = &handle_verify_ircapture_command,
+		.handler = handle_verify_ircapture_command,
 		.mode = COMMAND_ANY,
-		.help = "verify value captured during Capture-IR",
-		.usage = "<enable | disable>",
+		.help = "Display or assign flag controlling whether to "
+			"verify values captured during Capture-IR.",
+		.usage = "['enable'|'disable']",
 	},
 	{
 		.name = "verify_jtag",
-		.handler = &handle_verify_jtag_command,
+		.handler = handle_verify_jtag_command,
 		.mode = COMMAND_ANY,
-		.help = "verify value capture",
-		.usage = "<enable | disable>",
+		.help = "Display or assign flag controlling whether to "
+			"verify values captured during IR and DR scans.",
+		.usage = "['enable'|'disable']",
 	},
 	{
 		.name = "tms_sequence",
-		.handler = &handle_tms_sequence_command,
+		.handler = handle_tms_sequence_command,
 		.mode = COMMAND_ANY,
-		.help = "choose short(default) or long tms_sequence",
-		.usage = "<short | long>",
+		.help = "Display or change what style TMS sequences to use "
+			"for JTAG state transitions:  short (default) or "
+			"long.  Only for working around JTAG bugs.",
+			/* Specifically for working around DRIVER bugs... */
+		.usage = "['short'|'long']",
 	},
 	{
 		.name = "jtag",

commit 5cb1dcfad34aab7de64ef85f6227f28f3711dd85
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 9 22:14:08 2010 -0800

    ZY1000 help/usage fixups
    
    The usual:  same EBNF as in the User's Guide, full sentence helptext,
    function names *are* their addresses.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/zy1000/zy1000.c b/src/jtag/zy1000/zy1000.c
index 7c5f440..e66a8b5 100644
--- a/src/jtag/zy1000/zy1000.c
+++ b/src/jtag/zy1000/zy1000.c
@@ -832,29 +832,32 @@ void embeddedice_write_dcc(struct jtag_tap *tap, int reg_addr, uint8_t *buffer,
 static const struct command_registration zy1000_commands[] = {
 	{
 		.name = "power",
-		.handler = &handle_power_command,
+		.handler = handle_power_command,
 		.mode = COMMAND_ANY,
-		.help = "turn power switch to target on/off. No arguments - print status.",
-		.usage = "power <on/off>",
+		.help = "Turn power switch to target on/off. "
+			"With no arguments, prints status.",
+		.usage = "('on'|'off)",
 	},
 	{
 		.name = "zy1000_version",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_zy1000_version,
-		.help = "print version info for zy1000",
+		.jim_handler = jim_zy1000_version,
+		.help = "Print version info for zy1000.",
+		.usage = "['openocd'|'zy1000'|'date'|'time'|'pcb'|'fpga']",
 	},
 	{
 		.name = "powerstatus",
 		.mode = COMMAND_ANY,
-		.jim_handler = & zylinjtag_Jim_Command_powerstatus,
-		.help = "print power status of target",
+		.jim_handler = zylinjtag_Jim_Command_powerstatus,
+		.help = "Returns power status of target",
 	},
 #ifdef CYGPKG_HAL_NIOS2
 	{
 		.name = "updatezy1000firmware",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_zy1000_writefirmware,
+		.jim_handler = jim_zy1000_writefirmware,
 		.help = "writes firmware to flash",
+		/* .usage = "some_string", */
 	},
 #endif
 	COMMAND_REGISTRATION_DONE

commit 0811f6b192674788a00e02fbbfe29e0a2a138ea2
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 9 22:09:08 2010 -0800

    jtag: presto, parport help/usage updates
    
    Presto: add doxygen file comment.
    
    Parport: note a couple gaps in layout config.
    
    Both: use the uniform EBNF for usage, bugfix helptexts, use function
    name as its address not "&name".
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/drivers/parport.c b/src/jtag/drivers/parport.c
index b280d04..a38ccfd 100644
--- a/src/jtag/drivers/parport.c
+++ b/src/jtag/drivers/parport.c
@@ -437,10 +437,13 @@ COMMAND_HANDLER(parport_handle_parport_cable_command)
 	/* only if the cable name wasn't overwritten by cmdline */
 	if (parport_cable == 0)
 	{
+		/* REVISIT first verify that it's listed in cables[] ... */
 		parport_cable = malloc(strlen(CMD_ARGV[0]) + sizeof(char));
 		strcpy(parport_cable, CMD_ARGV[0]);
 	}
 
+	/* REVISIT it's probably worth returning the current value ... */
+
 	return ERROR_OK;
 }
 
@@ -484,34 +487,37 @@ COMMAND_HANDLER(parport_handle_parport_toggling_time_command)
 static const struct command_registration parport_command_handlers[] = {
 	{
 		.name = "parport_port",
-		.handler = &parport_handle_parport_port_command,
+		.handler = parport_handle_parport_port_command,
 		.mode = COMMAND_CONFIG,
-		.help = "either the address of the I/O port "
-			"or the number of the '/dev/parport' device",
-		.usage = "[<port|devname>]",
+		.help = "Display the address of the I/O port (e.g. 0x378) "
+			"or the number of the '/dev/parport' device used.  "
+			"If a parameter is provided, first change that port.",
+		.usage = "[port_number]",
 	},
 	{
 		.name = "parport_cable",
-		.handler = &parport_handle_parport_cable_command,
+		.handler = parport_handle_parport_cable_command,
 		.mode = COMMAND_CONFIG,
-		.help = "the layout of the parallel port cable "
-			"used to connect to the target",
-		.usage = "[<layout>]",
+		.help = "Set the layout of the parallel port cable "
+			"used to connect to the target.",
+		/* REVISIT there's no way to list layouts we know ... */
+		.usage = "[layout]",
 	},
 	{
 		.name = "parport_write_on_exit",
-		.handler = &parport_handle_write_on_exit_command,
+		.handler = parport_handle_write_on_exit_command,
 		.mode = COMMAND_CONFIG,
-		.help = "configure the parallel driver to write "
-			"a known value to the parallel interface",
-		.usage = "[<on|off>]",
+		.help = "Configure the parallel driver to write "
+			"a known value to the parallel interface on exit.",
+		.usage = "('on'|'off')",
 	},
 	{
 		.name = "parport_toggling_time",
-		.handler = &parport_handle_parport_toggling_time_command,
+		.handler = parport_handle_parport_toggling_time_command,
 		.mode = COMMAND_CONFIG,
-		.help = "time <ns> it takes for the hardware to toggle TCK",
-		.usage = "[<ns>]",
+		.help = "Displays or assigns how many nanoseconds it "
+			"takes for the hardware to toggle TCK.",
+		.usage = "[nanoseconds]",
 	},
 	COMMAND_REGISTRATION_DONE
 };
diff --git a/src/jtag/drivers/presto.c b/src/jtag/drivers/presto.c
index 0baf561..ababf09 100644
--- a/src/jtag/drivers/presto.c
+++ b/src/jtag/drivers/presto.c
@@ -17,6 +17,11 @@
  *   Free Software Foundation, Inc.,                                       *
  *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
  ***************************************************************************/
+
+/**
+ * @file Holds driver for PRESTO programmer from ASIX.
+ * http://tools.asix.net/prg_presto.htm
+ */
 #ifdef HAVE_CONFIG_H
 #include "config.h"
 #endif
@@ -742,10 +747,10 @@ COMMAND_HANDLER(presto_handle_serial_command)
 static const struct command_registration presto_command_handlers[] = {
 	{
 		.name = "presto_serial",
-		.handler = &presto_handle_serial_command,
+		.handler = presto_handle_serial_command,
 		.mode = COMMAND_CONFIG,
-		.help = "configure serial port",
-		.usage = "<devname>",
+		.help = "Configure USB serial number of Presto device.",
+		.usage = "serial_string",
 	},
 	COMMAND_REGISTRATION_DONE
 };

commit ad5fd390634799ecabddc32d0ce415ef72036b4a
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 9 22:05:55 2010 -0800

    jtag/gw16012 usage/help updates
    
    Use standard BNF.  Improve/correct helptext for its "parport_port"
    command.  Function address is just its name.

diff --git a/src/jtag/drivers/gw16012.c b/src/jtag/drivers/gw16012.c
index 38e5dd7..0e9f3fe 100644
--- a/src/jtag/drivers/gw16012.c
+++ b/src/jtag/drivers/gw16012.c
@@ -565,10 +565,12 @@ COMMAND_HANDLER(gw16012_handle_parport_port_command)
 static const struct command_registration gw16012_command_handlers[] = {
 	{
 		.name = "parport_port",
-		.handler = &gw16012_handle_parport_port_command,
+		.handler = gw16012_handle_parport_port_command,
 		.mode = COMMAND_CONFIG,
-		.help = "configure the parallel port to use",
-		.usage = "<port_num>",
+		.help = "Display the address of the I/O port (e.g. 0x378) "
+			"or the number of the '/dev/parport' device used.  "
+			"If a parameter is provided, first change that port.",
+		.usage = "[port_number]",
 	},
 	COMMAND_REGISTRATION_DONE
 };

commit ff647e6bb4180a7c376b61caeb14951ba84d5717
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 9 21:56:11 2010 -0800

    parport (mostly) doc fixes
    
    The "parport_port" commands generally don't *require* a port_number;
    they're of the "apply any parameter, then print result" variety.  Update
    the User's Guide accordingly.
    
    Some of those commands are intended to be write-once: parport_port,
    and parport_cable.  Say so.
    
    Use proper EBNF for the parport_write_on_exit parameter.
    
    Parport address 0xc8b8 is evidently mutant.  Say so in the "parport.cfg"
    file, to avoid breaking anyone with that mutant config.  But update the
    User's Guide to include a sane example for the LP2 port.
    
    Finally document the "presto_serial" command.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index f8956a3..6466d6d 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -2073,9 +2073,11 @@ $_TARGETNAME configure -event reset-assert \
 Gateworks GW16012 JTAG programmer.
 This has one driver-specific command:
 
- at deffn {Config Command} {parport_port} number
-Specifies either the address of the I/O port (default: 0x378 for LPT1) or
-the number of the @file{/dev/parport} device.
+ at deffn {Config Command} {parport_port} [port_number]
+Display either the address of the I/O port
+(default: 0x378 for LPT1) or the number of the @file{/dev/parport} device.
+If a parameter is provided, first switch to use that port.
+This is a write-once setting.
 @end deffn
 @end deffn
 
@@ -2094,7 +2096,8 @@ These interfaces have several commands, used to configure the driver
 before initializing the JTAG scan chain:
 
 @deffn {Config Command} {parport_cable} name
-The layout of the parallel port cable used to connect to the target.
+Set the layout of the parallel port cable used to connect to the target.
+This is a write-once setting.
 Currently valid cable @var{name} values include:
 
 @itemize @minus
@@ -2122,9 +2125,11 @@ several clones, such as the Olimex ARM-JTAG
 @end itemize
 @end deffn
 
- at deffn {Config Command} {parport_port} number
-Either the address of the I/O port (default: 0x378 for LPT1) or the number of
-the @file{/dev/parport} device
+ at deffn {Config Command} {parport_port} [port_number]
+Display either the address of the I/O port
+(default: 0x378 for LPT1) or the number of the @file{/dev/parport} device.
+If a parameter is provided, first switch to use that port.
+This is a write-once setting.
 
 When using PPDEV to access the parallel port, use the number of the parallel port:
 @option{parport_port 0} (the default). If @option{parport_port 0x378} is specified
@@ -2167,25 +2172,26 @@ match for the jtag_khz rate you specified; be conservative.
 @end quotation
 @end deffn
 
- at deffn {Config Command} {parport_write_on_exit} (on|off)
+ at deffn {Config Command} {parport_write_on_exit} (@option{on}|@option{off})
 This will configure the parallel driver to write a known
-cable-specific value to the parallel interface on exiting OpenOCD
+cable-specific value to the parallel interface on exiting OpenOCD.
 @end deffn
 
 For example, the interface configuration file for a
-classic ``Wiggler'' cable might look something like this:
+classic ``Wiggler'' cable on LPT2 might look something like this:
 
 @example
 interface parport
-parport_port 0xc8b8
+parport_port 0x278
 parport_cable wiggler
 @end example
 @end deffn
 
 @deffn {Interface Driver} {presto}
 ASIX PRESTO USB JTAG programmer.
- at c command:	presto_serial str
- at c     sets serial number
+ at deffn {Config Command} {presto_serial} serial_string
+Configures the USB serial number of the Presto device to use.
+ at end deffn
 @end deffn
 
 @deffn {Interface Driver} {rlink}
diff --git a/tcl/interface/parport.cfg b/tcl/interface/parport.cfg
index 2a2668d..22be8f3 100644
--- a/tcl/interface/parport.cfg
+++ b/tcl/interface/parport.cfg
@@ -1,6 +1,8 @@
 #
 # Parallel port wiggler (many clones available) on port 0xc8b8
 #
+# REVISIT this address seems very wrong.
+# Surely 0x378/LPT1 or 0x278/LPT2 ...
 
 interface parport
 parport_port 0xc8b8

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi           |   32 +++++---
 src/jtag/drivers/gw16012.c |    8 +-
 src/jtag/drivers/parport.c |   36 +++++----
 src/jtag/drivers/presto.c  |   11 ++-
 src/jtag/tcl.c             |  189 +++++++++++++++++++++++++++-----------------
 src/jtag/zy1000/zy1000.c   |   19 +++--
 tcl/interface/parport.cfg  |    2 +
 7 files changed, 181 insertions(+), 116 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sun Jan 10 07:25:12 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sun, 10 Jan 2010 06:25:12 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-87-g5e221fa
Message-ID: <E1NTrEg-0005ZZ-WE@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  5e221fa3a72dcdde92cf749495131748d32f7d8a (commit)
      from  ab4307e693dad8181f1570b5cdd7f132661a608b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 5e221fa3a72dcdde92cf749495131748d32f7d8a
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 9 22:24:43 2010 -0800

    Presto: doxygen fix
    
    Newline needed.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/drivers/presto.c b/src/jtag/drivers/presto.c
index ababf09..72126a1 100644
--- a/src/jtag/drivers/presto.c
+++ b/src/jtag/drivers/presto.c
@@ -19,7 +19,8 @@
  ***************************************************************************/
 
 /**
- * @file Holds driver for PRESTO programmer from ASIX.
+ * @file
+ * Holds driver for PRESTO programmer from ASIX.
  * http://tools.asix.net/prg_presto.htm
  */
 #ifdef HAVE_CONFIG_H

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/drivers/presto.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sun Jan 10 19:11:52 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sun, 10 Jan 2010 18:11:52 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-88-gc826793
Message-ID: <E1NU2GY-00008D-SI@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  c8267930c7cff5685b33cd0174deb75a46dbb09b (commit)
      from  5e221fa3a72dcdde92cf749495131748d32f7d8a (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit c8267930c7cff5685b33cd0174deb75a46dbb09b
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sun Jan 10 10:06:58 2010 -0800

    FreeBSD build fixes
    
    Based on notes from Tomek Cedro <tomek.cedro at gmail.com> and
    Steve Franks <bahamasfranks at gmail.com>.
    
    In the User's Guide, sort the list of operating systems reported
    through Tcl with $ocd_HOSTOS ... and include FreeBSD.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 6466d6d..0eb40b1 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -6913,11 +6913,12 @@ variables. JimTCL, as implemented in OpenOCD creates $ocd_HOSTOS which
 holds one of the following values:
 
 @itemize @bullet
- at item @b{winxx}    Built using Microsoft Visual Studio
- at item @b{linux}    Linux is the underlying operating sytem
- at item @b{darwin}   Darwin (mac-os) is the underlying operating sytem.
 @item @b{cygwin}   Running under Cygwin
+ at item @b{darwin}   Darwin (Mac-OS) is the underlying operating sytem.
+ at item @b{freebsd}  Running under FreeBSD
+ at item @b{linux}    Linux is the underlying operating sytem
 @item @b{mingw32}  Running under MingW32
+ at item @b{winxx}    Built using Microsoft Visual Studio
 @item @b{other}    Unknown, none of the above.
 @end itemize
 
diff --git a/src/helper/command.c b/src/helper/command.c
index 288ed72..568596d 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -1358,6 +1358,7 @@ struct command_context* command_init(const char *startup_tcl, Jim_Interp *interp
 #endif
 	context->interp = interp;
 
+	/* Stick to lowercase for HostOS strings. */
 #if defined(_MSC_VER)
 	/* WinXX - is generic, the forward
 	 * looking problem is this:
@@ -1377,6 +1378,8 @@ struct command_context* command_init(const char *startup_tcl, Jim_Interp *interp
 	HostOs = "mingw32";
 #elif defined(__ECOS)
 	HostOs = "ecos";
+#elif defined(__FreeBSD__)
+	HostOs = "freebsd";
 #else
 #warning "Unrecognized host OS..."
 	HostOs = "other";

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi     |    7 ++++---
 src/helper/command.c |    3 +++
 2 files changed, 7 insertions(+), 3 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Sun Jan 10 22:03:39 2010
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Sun, 10 Jan 2010 21:03:39 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-89-gd746dee
Message-ID: <E1NU4wm-0002Is-4U@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  d746dee833ef4774adcee6a33c97f8039a5bd744 (commit)
      from  c8267930c7cff5685b33cd0174deb75a46dbb09b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit d746dee833ef4774adcee6a33c97f8039a5bd744
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Sun Jan 10 14:30:06 2010 +0000

    build: doxygen build
    
     - Fix for building doxygen out of tree
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/Doxyfile.in b/Doxyfile.in
index 519bb2f..f6e3ced 100644
--- a/Doxyfile.in
+++ b/Doxyfile.in
@@ -569,7 +569,7 @@ INPUT                  = @srcdir@/doc/manual \
                          @srcdir@/BUGS \
                          @srcdir@/PATCHES.txt \
                          @srcdir@/src \
-                         @srcdir@/config.h
+                         @builddir@/config.h
 
 # This tag can be used to specify the character encoding of the source files
 # that doxygen parses. Internally doxygen uses the UTF-8 encoding, which is
diff --git a/Makefile.am b/Makefile.am
index fab4704..7d42fd3 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -26,6 +26,7 @@ Doxyfile: $(srcdir)/Doxyfile.in
 	  echo "### @@@ -= DO NOT EDIT THIS FILE =- @@@ ###" && \
 	  echo "### @@@ Make changes to Doxyfile.in @@@ ###" && \
 	  sed -e 's, at srcdir\@,$(srcdir),' \
+	    -e 's, at builddir\@,$(builddir),' \
 	    -e 's, at doxygen_as_html\@,$(doxygen_as_html),' \
 	    -e 's, at doxygen_as_pdf\@,$(doxygen_as_pdf),' $< \
 	) > $@

-----------------------------------------------------------------------

Summary of changes:
 Doxyfile.in |    2 +-
 Makefile.am |    1 +
 2 files changed, 2 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Jan 11 09:11:51 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Mon, 11 Jan 2010 08:11:51 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-90-g88907cc
Message-ID: <E1NUFNQ-0006xM-93@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  88907cc7f941ce85f0dc35ed3dbc4d2dbc87cef7 (commit)
      from  d746dee833ef4774adcee6a33c97f8039a5bd744 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 88907cc7f941ce85f0dc35ed3dbc4d2dbc87cef7
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Fri Jan 8 15:30:10 2010 +0100

    shutdown: more graceful shutdown
    
    Shutdown is not an error condition, do not return error
    from main.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/server/server.c b/src/server/server.c
index f762704..173beb8 100644
--- a/src/server/server.c
+++ b/src/server/server.c
@@ -563,9 +563,11 @@ int server_quit(void)
 /* tell the server we want to shut down */
 COMMAND_HANDLER(handle_shutdown_command)
 {
+	LOG_USER("shutdown command invoked");
+
 	shutdown_openocd = 1;
 
-	return ERROR_COMMAND_CLOSE_CONNECTION;
+	return ERROR_OK;
 }
 
 static const struct command_registration server_command_handlers[] = {

-----------------------------------------------------------------------

Summary of changes:
 src/server/server.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Mon Jan 11 09:17:32 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Mon, 11 Jan 2010 08:17:32 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-91-g8c730aa
Message-ID: <E1NUFSy-00060m-4q@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  8c730aaee22a505cf66666be3ff28734ac885418 (commit)
      from  88907cc7f941ce85f0dc35ed3dbc4d2dbc87cef7 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 8c730aaee22a505cf66666be3ff28734ac885418
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Mon Jan 11 00:14:01 2010 -0800

    Doxygen file comments
    
    Add file comments to a few files.  Make the GDB server use
    more conventional (pointer-free) hex digit conversion.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/flash/nor/core.c b/src/flash/nor/core.c
index 7e783d4..9083ed1 100644
--- a/src/flash/nor/core.c
+++ b/src/flash/nor/core.c
@@ -29,6 +29,13 @@
 #include <target/image.h>
 
 
+/**
+ * @file
+ * Upper level of NOR flash framework.
+ * The lower level interfaces are to drivers.  These upper level ones
+ * primarily support access from Tcl scripts or from GDB.
+ */
+
 struct flash_bank *flash_banks;
 
 int flash_driver_erase(struct flash_bank *bank, int first, int last)
diff --git a/src/flash/nor/core.h b/src/flash/nor/core.h
index c1e26cd..36e163d 100644
--- a/src/flash/nor/core.h
+++ b/src/flash/nor/core.h
@@ -24,6 +24,11 @@
 
 #include <flash/common.h>
 
+/**
+ * @file
+ * Upper level NOR flash interfaces.
+ */
+
 struct image;
 
 #define FLASH_MAX_ERROR_STR	(128)
diff --git a/src/flash/nor/tcl.c b/src/flash/nor/tcl.c
index 65523fb..b7e80df 100644
--- a/src/flash/nor/tcl.c
+++ b/src/flash/nor/tcl.c
@@ -26,6 +26,11 @@
 #include <helper/time_support.h>
 #include <target/image.h>
 
+/**
+ * @file
+ * Implements Tcl commands used to access NOR flash facilities.
+ */
+
 COMMAND_HELPER(flash_command_get_bank, unsigned name_index,
 		struct flash_bank **bank)
 {
diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index 08daa68..f4a99ca 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -37,6 +37,15 @@
 #include <jtag/jtag.h>
 
 
+/**
+ * @file
+ * GDB server implementation.
+ *
+ * This implements the GDB Remote Serial Protocol, over TCP connections,
+ * giving GDB access to the JTAG or other hardware debugging facilities
+ * found in most modern embedded processors.
+ */
+
 /* private connection data for GDB */
 struct gdb_connection
 {
@@ -68,7 +77,7 @@ static enum breakpoint_type gdb_breakpoint_override_type;
 extern int gdb_error(struct connection *connection, int retval);
 static unsigned short gdb_port = 3333;
 static unsigned short gdb_port_next = 0;
-static const char *DIGITS = "0123456789abcdef";
+static const char DIGITS[16] = "0123456789abcdef";
 
 static void gdb_log_callback(void *priv, const char *file, unsigned line,
 		const char *function, const char *string);

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/core.c    |    7 +++++++
 src/flash/nor/core.h    |    5 +++++
 src/flash/nor/tcl.c     |    5 +++++
 src/server/gdb_server.c |   11 ++++++++++-
 4 files changed, 27 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Jan 11 10:25:07 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Mon, 11 Jan 2010 09:25:07 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-92-gc74ca40
Message-ID: <E1NUGWK-0004Gi-GH@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  c74ca40e09baebe8b86b1a77ad343f7b8ebde5d6 (commit)
      from  8c730aaee22a505cf66666be3ff28734ac885418 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit c74ca40e09baebe8b86b1a77ad343f7b8ebde5d6
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Jan 11 10:21:56 2010 +0100

    zy1000: reset bugfix
    
    flush JTAG FIFO before reset. Fixes RCLK problems observed
    w/lpc2148, but really fixes a wider range of problems.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/jtag/zy1000/zy1000.c b/src/jtag/zy1000/zy1000.c
index e66a8b5..9070f2e 100644
--- a/src/jtag/zy1000/zy1000.c
+++ b/src/jtag/zy1000/zy1000.c
@@ -132,6 +132,13 @@ static int zy1000_power_dropout(int *dropout)
 void zy1000_reset(int trst, int srst)
 {
 	LOG_DEBUG("zy1000 trst=%d, srst=%d", trst, srst);
+
+	/* flush the JTAG FIFO. Not flushing the queue before messing with
+	 * reset has such interesting bugs as causing hard to reproduce
+	 * RCLK bugs as RCLK will stop responding when TRST is asserted
+	 */
+	waitIdle();
+
 	if (!srst)
 	{
 		ZY1000_POKE(ZY1000_JTAG_BASE + 0x14, 0x00000001);
@@ -156,7 +163,6 @@ void zy1000_reset(int trst, int srst)
 
 	if (trst||(srst && (jtag_get_reset_config() & RESET_SRST_PULLS_TRST)))
 	{
-		waitIdle();
 		/* we're now in the RESET state until trst is deasserted */
 		ZY1000_POKE(ZY1000_JTAG_BASE + 0x20, TAP_RESET);
 	} else

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/zy1000/zy1000.c |    8 +++++++-
 1 files changed, 7 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Jan 11 12:59:33 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Mon, 11 Jan 2010 11:59:33 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-94-gfb71a0a
Message-ID: <E1NUIvn-00053P-Eo@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  fb71a0a0dddf68fa3f266aab5e35409773acc567 (commit)
       via  6d8604de37855da6e9acf79adbb488788bdc9917 (commit)
      from  c74ca40e09baebe8b86b1a77ad343f7b8ebde5d6 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit fb71a0a0dddf68fa3f266aab5e35409773acc567
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Jan 11 12:54:49 2010 +0100

    reset: better error messages
    
    Use correct tcl syntax to throw exception.
    
    the syntax is "return -code error" not "return -error"
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/startup.tcl b/src/target/startup.tcl
index b597b84..d68417e 100644
--- a/src/target/startup.tcl
+++ b/src/target/startup.tcl
@@ -41,7 +41,7 @@ proc ocd_process_reset_inner { MODE } {
 		set halt 0;
 	}
 	if { $halt < 0 } {
-		return -error "Invalid mode: $MODE, must be one of: halt, init, or run";
+		return -code error "Invalid mode: $MODE, must be one of: halt, init, or run";
 	}
 
 	# Target event handlers *might* change which TAPs are enabled
@@ -119,7 +119,7 @@ proc ocd_process_reset_inner { MODE } {
 			set s [$t curstate]
 
 			if { 0 != [string compare $s "halted" ] } {
-				return -error [format "TARGET: %s - Not halted" $t]
+				return -code error [format "TARGET: %s - Not halted" $t]
 			}
 		}
 	}

commit 6d8604de37855da6e9acf79adbb488788bdc9917
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Jan 11 12:53:55 2010 +0100

    commands: make error messages a bit more terse
    
    we don't need to know the build path of command.c when
    reading normal user level error messages.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/helper/command.c b/src/helper/command.c
index 568596d..cf66f8a 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -349,7 +349,7 @@ static int register_command_handler(struct command_context *cmd_ctx,
 	if (NULL == override_name)
 		return JIM_ERR;
 
-	retval = Jim_Eval_Named(interp, override_name, __FILE__, __LINE__);
+	retval = Jim_Eval_Named(interp, override_name, __THIS__FILE__ , __LINE__);
 	free((void *)override_name);
 
 	return retval;

-----------------------------------------------------------------------

Summary of changes:
 src/helper/command.c   |    2 +-
 src/target/startup.tcl |    4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Jan 11 15:01:27 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Mon, 11 Jan 2010 14:01:27 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-95-ge5349bf
Message-ID: <E1NUKpk-0005Ed-O0@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  e5349bfb4954366579b521dc8181c01c5bd4679e (commit)
      from  fb71a0a0dddf68fa3f266aab5e35409773acc567 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit e5349bfb4954366579b521dc8181c01c5bd4679e
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Jan 11 14:59:14 2010 +0100

    target: return JIM_OK instead of ERROR_OK
    
    No change in actual binary as JIM_OK == ERROR_OK,
    but JIM_OK is correct here.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/jtag/tcl.c b/src/jtag/tcl.c
index 7329cee..f48993f 100644
--- a/src/jtag/tcl.c
+++ b/src/jtag/tcl.c
@@ -623,7 +623,7 @@ static int jim_newtap_cmd(Jim_GetOptInfo *goi)
 	if (pTap->ir_length != 0)
 	{
 		jtag_tap_init(pTap);
-		return ERROR_OK;
+		return JIM_OK;
 	}
 
 	Jim_SetResult_sprintf(goi->interp,

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/tcl.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Jan 11 15:58:21 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Mon, 11 Jan 2010 14:58:21 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-96-g1de107a
Message-ID: <E1NULio-0002xc-PT@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  1de107a5a269fa71c9a69eba182fecea68e38a06 (commit)
      from  e5349bfb4954366579b521dc8181c01c5bd4679e (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 1de107a5a269fa71c9a69eba182fecea68e38a06
Author: Vladimir Zapolskiy <vzapolskiy at gmail.com>
Date:   Mon Jan 11 17:49:37 2010 +0300

    Added Openmoko USB JTAG interface config file.
    
    Added interface config file for JTAG/RS232 debug board originally
    integrated to Neo 1973 and Neo FreeRunner phones.
    Adapter was tested with i.MX31, S3C2410 and AT91SAM9260 processors.
    
    Signed-off-by: Vladimir Zapolskiy <vzapolskiy at gmail.com>

diff --git a/tcl/interface/neodb.cfg b/tcl/interface/neodb.cfg
new file mode 100644
index 0000000..8e2f526
--- /dev/null
+++ b/tcl/interface/neodb.cfg
@@ -0,0 +1,10 @@
+#
+# Openmoko USB JTAG/RS232 adapter
+#
+# http://wiki.openmoko.org/wiki/Debug_Board_v3
+#
+
+interface ft2232
+ft2232_device_desc "Debug Board for Neo1973"
+ft2232_layout jtagkey
+ft2232_vid_pid 0x1457 0x5118

-----------------------------------------------------------------------

Summary of changes:
 tcl/interface/neodb.cfg |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)
 create mode 100644 tcl/interface/neodb.cfg


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Tue Jan 12 21:41:33 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Tue, 12 Jan 2010 20:41:33 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-97-gb4a4d5c
Message-ID: <E1NUnYV-0002ga-Pt@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  b4a4d5c7310c88ef263bfaaa060b5c249d98c446 (commit)
      from  1de107a5a269fa71c9a69eba182fecea68e38a06 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit b4a4d5c7310c88ef263bfaaa060b5c249d98c446
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Tue Jan 12 12:40:39 2010 -0800

    ARM: bugfix for "movt" disassembly
    
    Use the correct bitfield to specify the register whose
    top halfword gets replaced.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_disassembler.c b/src/target/arm_disassembler.c
index 912e37c..587131b 100644
--- a/src/target/arm_disassembler.c
+++ b/src/target/arm_disassembler.c
@@ -3247,7 +3247,7 @@ static int t2ev_data_immed(uint32_t opcode, uint32_t address,
 	case 0x0c:
 		/* move constant to top 16 bits of register */
 		immed |= (opcode >> 4) & 0xf000;
-		sprintf(cp, "MOVT\tr%d, #%d\t; %#4.4x", rn, immed, immed);
+		sprintf(cp, "MOVT\tr%d, #%d\t; %#4.4x", rd, immed, immed);
 		return ERROR_OK;
 	case 0x10:
 	case 0x12:

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm_disassembler.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Wed Jan 13 08:33:51 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Wed, 13 Jan 2010 07:33:51 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-98-g6c75f52
Message-ID: <E1NUxjm-00062v-2y@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  6c75f5249cf721aa8b8c2d774cdeeac6f9770e32 (commit)
      from  b4a4d5c7310c88ef263bfaaa060b5c249d98c446 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 6c75f5249cf721aa8b8c2d774cdeeac6f9770e32
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Jan 11 15:54:52 2010 +0100

    debug: make logging of commands terser
    
    one line / command instead of one line per argument.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/helper/command.c b/src/helper/command.c
index cf66f8a..ebd9aa6 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -108,10 +108,15 @@ static int command_retval_set(Jim_Interp *interp, int retval)
 
 extern struct command_context *global_cmd_ctx;
 
+/* dump a single line to the log for the command.
+ * Do nothing in case we are not at debug level 3 */
 void script_debug(Jim_Interp *interp, const char *name,
 		unsigned argc, Jim_Obj *const *argv)
 {
-	LOG_DEBUG("command - %s", name);
+	if (debug_level < LOG_LVL_DEBUG)
+		return;
+
+	char * dbg = alloc_printf("command - %s", name);
 	for (unsigned i = 0; i < argc; i++)
 	{
 		int len;
@@ -121,8 +126,12 @@ void script_debug(Jim_Interp *interp, const char *name,
 		if (*w == '#')
 			break;
 
-		LOG_DEBUG("%s - argv[%d]=%s", name, i, w);
+		char * t = alloc_printf("%s %s", dbg, w);
+		free (dbg);
+		dbg = t;
 	}
+	LOG_DEBUG("%s", dbg);
+	free(dbg);
 }
 
 static void script_command_args_free(const char **words, unsigned nwords)

-----------------------------------------------------------------------

Summary of changes:
 src/helper/command.c |   13 +++++++++++--
 1 files changed, 11 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Wed Jan 13 12:14:48 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Wed, 13 Jan 2010 11:14:48 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-99-g3e33393
Message-ID: <E1NV1Ba-000182-Ek@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  3e33393078105f25ebd591b5b76c7c1501ff41d5 (commit)
      from  6c75f5249cf721aa8b8c2d774cdeeac6f9770e32 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 3e33393078105f25ebd591b5b76c7c1501ff41d5
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Jan 11 09:22:08 2010 +0100

    gdbserver: fix typo that broke read/write watchpoint
    
    It looks like a bugfix from normal breakpoints was not
    copied over.
    
    Do not use clever mathematics and assumptions to convert from
    GDB enum for break/watchpoints to OpenOCD enum.
    
    Drop connection upon unknown breakpoint type, this code path
    was not really considered by the previous code I think.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index f4a99ca..8018e6f 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -1423,7 +1423,7 @@ int gdb_breakpoint_watchpoint_packet(struct connection *connection, struct targe
 {
 	int type;
 	enum breakpoint_type bp_type = BKPT_SOFT /* dummy init to avoid warning */;
-	enum watchpoint_rw wp_type;
+	enum watchpoint_rw wp_type = WPT_READ /* dummy init to avoid warning */;
 	uint32_t address;
 	uint32_t size;
 	char *separator;
@@ -1443,6 +1443,12 @@ int gdb_breakpoint_watchpoint_packet(struct connection *connection, struct targe
 		wp_type = WPT_READ;
 	else if (type == 4) /* access watchpoint */
 		wp_type = WPT_ACCESS;
+	else
+	{
+		LOG_ERROR("invalid gdb watch/breakpoint type(%d), dropping connection", type);
+		return ERROR_SERVER_REMOTE_CLOSED;
+	}
+
 
 	if (gdb_breakpoint_override && ((bp_type == BKPT_SOFT)||(bp_type == BKPT_HARD)))
 	{
@@ -1493,7 +1499,7 @@ int gdb_breakpoint_watchpoint_packet(struct connection *connection, struct targe
 		{
 			if (packet[0] == 'Z')
 			{
-				if ((retval = watchpoint_add(target, address, size, type-2, 0, 0xffffffffu)) != ERROR_OK)
+				if ((retval = watchpoint_add(target, address, size, wp_type, 0, 0xffffffffu)) != ERROR_OK)
 				{
 					if ((retval = gdb_error(connection, retval)) != ERROR_OK)
 						return retval;

-----------------------------------------------------------------------

Summary of changes:
 src/server/gdb_server.c |   10 ++++++++--
 1 files changed, 8 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Wed Jan 13 12:16:44 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Wed, 13 Jan 2010 11:16:44 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-102-gb8e930e
Message-ID: <E1NV1DS-00054D-Ag@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  b8e930e3bfc78f4a0582edb8b7cec44b5c9f4cad (commit)
       via  ee519ab3562870aa5bb1bc79f3c24cb3b3074d65 (commit)
       via  dc793455e9a04be556b0b25eb1513ecbb7be3f51 (commit)
      from  3e33393078105f25ebd591b5b76c7c1501ff41d5 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit b8e930e3bfc78f4a0582edb8b7cec44b5c9f4cad
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Jan 11 15:30:22 2010 +0100

    arm7/9: enable check that DCC downloads have been enabled
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/arm720t.c b/src/target/arm720t.c
index 2f51699..a5dde2c 100644
--- a/src/target/arm720t.c
+++ b/src/target/arm720t.c
@@ -578,4 +578,5 @@ struct target_type arm720t_target =
 	.target_create = arm720t_target_create,
 	.init_target = arm720t_init_target,
 	.examine = arm7_9_examine,
+	.check_reset = arm7_9_check_reset,
 };
diff --git a/src/target/arm7_9_common.c b/src/target/arm7_9_common.c
index a5a0f80..0f8f263 100644
--- a/src/target/arm7_9_common.c
+++ b/src/target/arm7_9_common.c
@@ -2732,6 +2732,8 @@ int arm7_9_check_reset(struct target *target)
 	{
 		LOG_WARNING("NOTE! DCC downloads have not been enabled, defaulting to slow memory writes. Type 'help dcc'.");
 	}
+
+	return ERROR_OK;
 }
 
 COMMAND_HANDLER(handle_arm7_9_dbgrq_command)
diff --git a/src/target/arm7tdmi.c b/src/target/arm7tdmi.c
index d576d07..16f16b0 100644
--- a/src/target/arm7tdmi.c
+++ b/src/target/arm7tdmi.c
@@ -752,4 +752,5 @@ struct target_type arm7tdmi_target =
 	.target_create  = arm7tdmi_target_create,
 	.init_target = arm7tdmi_init_target,
 	.examine = arm7_9_examine,
+	.check_reset = arm7_9_check_reset,
 };
diff --git a/src/target/arm920t.c b/src/target/arm920t.c
index 29eb62d..e0b1c70 100644
--- a/src/target/arm920t.c
+++ b/src/target/arm920t.c
@@ -1476,4 +1476,5 @@ struct target_type arm920t_target =
 	.target_create = arm920t_target_create,
 	.init_target = arm9tdmi_init_target,
 	.examine = arm7_9_examine,
+	.check_reset = arm7_9_check_reset,
 };
diff --git a/src/target/arm926ejs.c b/src/target/arm926ejs.c
index e099919..32ecf72 100644
--- a/src/target/arm926ejs.c
+++ b/src/target/arm926ejs.c
@@ -815,6 +815,7 @@ struct target_type arm926ejs_target =
 	.target_create = arm926ejs_target_create,
 	.init_target = arm9tdmi_init_target,
 	.examine = arm7_9_examine,
+	.check_reset = arm7_9_check_reset,
 	.virt2phys = arm926ejs_virt2phys,
 	.mmu = arm926ejs_mmu,
 
diff --git a/src/target/arm966e.c b/src/target/arm966e.c
index 86af0f6..2f5e390 100644
--- a/src/target/arm966e.c
+++ b/src/target/arm966e.c
@@ -294,4 +294,5 @@ struct target_type arm966e_target =
 	.target_create = arm966e_target_create,
 	.init_target = arm9tdmi_init_target,
 	.examine = arm7_9_examine,
+	.check_reset = arm7_9_check_reset,
 };
diff --git a/src/target/arm9tdmi.c b/src/target/arm9tdmi.c
index 823e962..761e7cf 100644
--- a/src/target/arm9tdmi.c
+++ b/src/target/arm9tdmi.c
@@ -975,4 +975,5 @@ struct target_type arm9tdmi_target =
 	.target_create = arm9tdmi_target_create,
 	.init_target = arm9tdmi_init_target,
 	.examine = arm7_9_examine,
+	.check_reset = arm7_9_check_reset,
 };
diff --git a/src/target/fa526.c b/src/target/fa526.c
index 7c6cae6..b6149e3 100644
--- a/src/target/fa526.c
+++ b/src/target/fa526.c
@@ -390,4 +390,5 @@ struct target_type fa526_target =
 	.target_create = fa526_target_create,
 	.init_target = arm9tdmi_init_target,
 	.examine = arm7_9_examine,
+	.check_reset = arm7_9_check_reset,
 };

commit ee519ab3562870aa5bb1bc79f3c24cb3b3074d65
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Jan 11 15:29:09 2010 +0100

    arm7/9: add fn to check if dcc downloads have been enabled
    
    DCC downloads should be enabled for any self repecting
    openocd config file for arm7/9. Print out note about
    it otherwise.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/arm7_9_common.c b/src/target/arm7_9_common.c
index 2f4c408..a5a0f80 100644
--- a/src/target/arm7_9_common.c
+++ b/src/target/arm7_9_common.c
@@ -2,7 +2,7 @@
  *   Copyright (C) 2005 by Dominic Rath                                    *
  *   Dominic.Rath at gmx.de                                                   *
  *                                                                         *
- *   Copyright (C) 2007,2008 ??yvind Harboe                                 *
+ *   Copyright (C) 2007-2009 ??yvind Harboe                                 *
  *   oyvind.harboe at zylin.com                                               *
  *                                                                         *
  *   Copyright (C) 2008 by Spencer Oliver                                  *
@@ -2723,6 +2723,17 @@ int arm7_9_examine(struct target *target)
 	return retval;
 }
 
+
+int arm7_9_check_reset(struct target *target)
+{
+	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
+
+	if (get_target_reset_nag() && !arm7_9->dcc_downloads)
+	{
+		LOG_WARNING("NOTE! DCC downloads have not been enabled, defaulting to slow memory writes. Type 'help dcc'.");
+	}
+}
+
 COMMAND_HANDLER(handle_arm7_9_dbgrq_command)
 {
 	struct target *target = get_current_target(CMD_CTX);
diff --git a/src/target/arm7_9_common.h b/src/target/arm7_9_common.h
index 021238e..93bee07 100644
--- a/src/target/arm7_9_common.h
+++ b/src/target/arm7_9_common.h
@@ -157,5 +157,6 @@ int arm7_9_execute_sys_speed(struct target *target);
 
 int arm7_9_init_arch_info(struct target *target, struct arm7_9_common *arm7_9);
 int arm7_9_examine(struct target *target);
+int arm7_9_check_reset(struct target *target);
 
 #endif /* ARM7_9_COMMON_H */

commit dc793455e9a04be556b0b25eb1513ecbb7be3f51
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Jan 11 15:28:18 2010 +0100

    target: add check_reset hook
    
    Allow targets to run checks post reset. Used to check
    that e.g. DCC downloads have been enabled.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/target.c b/src/target/target.c
index 7994aff..c56265c 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -477,6 +477,11 @@ int target_process_reset(struct command_context *cmd_ctx, enum target_reset_mode
 	/* We want any events to be processed before the prompt */
 	retval = target_call_timer_callbacks_now();
 
+	struct target *target;
+	for (target = all_targets; target; target = target->next) {
+		target->type->check_reset(target);
+	}
+
 	return retval;
 }
 
@@ -499,6 +504,12 @@ static int default_examine(struct target *target)
 	return ERROR_OK;
 }
 
+/* no check by default */
+static int default_check_reset(struct target *target)
+{
+	return ERROR_OK;
+}
+
 int target_examine_one(struct target *target)
 {
 	return target->type->examine(target);
@@ -708,6 +719,9 @@ static int target_init_one(struct command_context *cmd_ctx,
 	if (type->examine == NULL)
 		type->examine = default_examine;
 
+	if (type->check_reset== NULL)
+		type->check_reset = default_check_reset;
+
 	int retval = type->init_target(cmd_ctx, target);
 	if (ERROR_OK != retval)
 	{
@@ -4887,6 +4901,20 @@ int target_register_commands(struct command_context *cmd_ctx)
 	return register_commands(cmd_ctx, NULL, target_command_handlers);
 }
 
+static bool target_reset_nag = true;
+
+bool get_target_reset_nag(void)
+{
+	return target_reset_nag;
+}
+
+COMMAND_HANDLER(handle_target_reset_nag)
+{
+	return CALL_COMMAND_HANDLER(handle_command_parse_bool,
+			&target_reset_nag, "Nag after each reset about options to improve "
+			"performance");
+}
+
 static const struct command_registration target_exec_command_handlers[] = {
 	{
 		.name = "fast_load_image",
@@ -5088,6 +5116,14 @@ static const struct command_registration target_exec_command_handlers[] = {
 			"and write the 8/16/32 bit values",
 		.usage = "arrayname bitwidth address count",
 	},
+	{
+		.name = "reset_nag",
+		.handler = handle_target_reset_nag,
+		.mode = COMMAND_ANY,
+		.help = "Nag after each reset about options that could have been "
+				"enabled to improve performance. ",
+		.usage = "['enable'|'disable']",
+	},
 	COMMAND_REGISTRATION_DONE
 };
 int target_register_user_commands(struct command_context *cmd_ctx)
diff --git a/src/target/target.h b/src/target/target.h
index 4151c22..da91d46 100644
--- a/src/target/target.h
+++ b/src/target/target.h
@@ -2,7 +2,7 @@
  *   Copyright (C) 2005 by Dominic Rath                                    *
  *   Dominic.Rath at gmx.de                                                   *
  *                                                                         *
- *   Copyright (C) 2007,2008,2009 ??yvind Harboe                            *
+ *   Copyright (C) 2007-9 ??yvind Harboe                                    *
  *   oyvind.harboe at zylin.com                                               *
  *                                                                         *
  *   Copyright (C) 2008 by Spencer Oliver                                  *
@@ -483,4 +483,6 @@ void target_all_handle_event(enum target_event e);
 
 const char *target_strerror_safe(int err);
 
+extern bool get_target_reset_nag(void);
+
 #endif /* TARGET_H */
diff --git a/src/target/target_type.h b/src/target/target_type.h
index 67041b3..70eb962 100644
--- a/src/target/target_type.h
+++ b/src/target/target_type.h
@@ -213,6 +213,13 @@ struct target_type
 
 	int (*mmu)(struct target *target, int *enabled);
 
+	/* after reset is complete, the target can check if things are properly set up.
+	 *
+	 * This can be used to check if e.g. DCC memory writes have been enabled for
+	 * arm7/9 targets, which they really should except in the most contrived
+	 * circumstances.
+	 */
+	int (*check_reset)(struct target *target);
 };
 
 #endif // TARGET_TYPE_H

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm720t.c       |    1 +
 src/target/arm7_9_common.c |   15 ++++++++++++++-
 src/target/arm7_9_common.h |    1 +
 src/target/arm7tdmi.c      |    1 +
 src/target/arm920t.c       |    1 +
 src/target/arm926ejs.c     |    1 +
 src/target/arm966e.c       |    1 +
 src/target/arm9tdmi.c      |    1 +
 src/target/fa526.c         |    1 +
 src/target/target.c        |   36 ++++++++++++++++++++++++++++++++++++
 src/target/target.h        |    4 +++-
 src/target/target_type.h   |    7 +++++++
 12 files changed, 68 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Wed Jan 13 12:26:38 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Wed, 13 Jan 2010 11:26:38 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-103-gd91941d
Message-ID: <E1NV1N2-0006Xp-1B@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  d91941d5a01ca0b9d43571edc03ba18741076cca (commit)
      from  b8e930e3bfc78f4a0582edb8b7cec44b5c9f4cad (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit d91941d5a01ca0b9d43571edc03ba18741076cca
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Wed Jan 13 03:16:37 2010 -0800

    Cortex-M3: improved core exception handling
    
    This updates three aspects of debugger/exception interactions:
    
     - Save the user's "vector_catch" setting, and restore it after reset.
       Previously, it was obliterated (rather annoyingly) each time.
    
     - Don't catch BusFault and HardFault exceptions unless the user says
       to do so.  Target firmware may need to handle them.
    
     - Don't modify SHCSR to prevent escalating BusFault to HardFault.
       Target firmware may expect to handle it as a HardFault.
    
    Those simplifications fix several bugs.  In one annoying case, OpenOCD
    would cause the target to lock up on ome faults which triggered after
    the debugger disconnected.
    
    NOTE:  a known remaining issue is that OpenOCD can still leave DEMCR
    set after an otherwise-clean OpenOCD shutdown.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/NEWS b/NEWS
index b169606..a8b2b44 100644
--- a/NEWS
+++ b/NEWS
@@ -34,6 +34,8 @@ Target Layer:
 		- watchpoint support
 	Cortex-M3
 		- Exposed DWT registers like cycle counter
+		- vector_catch settings not clobbered by resets
+		- no longer interferes with firmware's fault handling
 	ETM, ETB
 		- "trigger_percent" command moved ETM --> ETB
 		- "etm trigger_debug" command added
diff --git a/src/target/armv7m.h b/src/target/armv7m.h
index ac559b9..86caae2 100644
--- a/src/target/armv7m.h
+++ b/src/target/armv7m.h
@@ -106,9 +106,14 @@ struct armv7m_common
 	int exception_number;
 	struct swjdp_common swjdp_info;
 
+	uint32_t demcr;
+
 	/* Direct processor core register read and writes */
-	int (*load_core_reg_u32)(struct target *target, enum armv7m_regtype type, uint32_t num, uint32_t *value);
-	int (*store_core_reg_u32)(struct target *target, enum armv7m_regtype type, uint32_t num, uint32_t value);
+	int (*load_core_reg_u32)(struct target *target,
+		enum armv7m_regtype type, uint32_t num, uint32_t *value);
+	int (*store_core_reg_u32)(struct target *target,
+		enum armv7m_regtype type, uint32_t num, uint32_t value);
+
 	/* register cache to processor synchronization */
 	int (*read_core_reg)(struct target *target, unsigned num);
 	int (*write_core_reg)(struct target *target, unsigned num);
diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index c6b1bb2..48f8114 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -185,11 +185,12 @@ static int cortex_m3_endreset_event(struct target *target)
 	int i;
 	uint32_t dcb_demcr;
 	struct cortex_m3_common *cortex_m3 = target_to_cm3(target);
+	struct armv7m_common *armv7m = &cortex_m3->armv7m;
 	struct swjdp_common *swjdp = &cortex_m3->armv7m.swjdp_info;
 	struct cortex_m3_fp_comparator *fp_list = cortex_m3->fp_comparator_list;
 	struct cortex_m3_dwt_comparator *dwt_list = cortex_m3->dwt_comparator_list;
 
-	/* FIXME handling of DEMCR clobbers vector_catch config ... */
+	/* REVISIT The four debug monitor bits are currently ignored... */
 	mem_ap_read_atomic_u32(swjdp, DCB_DEMCR, &dcb_demcr);
 	LOG_DEBUG("DCB_DEMCR = 0x%8.8" PRIx32 "",dcb_demcr);
 
@@ -204,21 +205,14 @@ static int cortex_m3_endreset_event(struct target *target)
 	/* clear any interrupt masking */
 	cortex_m3_write_debug_halt_mask(target, 0, C_MASKINTS);
 
-	/* Enable trace and DWT; trap hard and bus faults.
+	/* Enable features controlled by ITM and DWT blocks, and catch only
+	 * the vectors we were told to pay attention to.
 	 *
-	 * REVISIT why trap those two?  And why trash the vector_catch
-	 * config, instead of preserving it?  Catching HARDERR and BUSERR
-	 * will interfere with code that handles those itself...
+	 * Target firmware is responsible for all fault handling policy
+	 * choices *EXCEPT* explicitly scripted overrides like "vector_catch"
+	 * or manual updates to the NVIC SHCSR and CCR registers.
 	 */
-	mem_ap_write_u32(swjdp, DCB_DEMCR, TRCENA | VC_HARDERR | VC_BUSERR);
-
-	/* Monitor bus faults as such (instead of as generic HARDERR), but
-	 * leave memory management and usage faults disabled.
-	 *
-	 * REVISIT setting BUSFAULTENA interferes with code which relies
-	 * on the default setting.  Why do it?
-	 */
-	mem_ap_write_u32(swjdp, NVIC_SHCSR, SHCSR_BUSFAULTENA);
+	mem_ap_write_u32(swjdp, DCB_DEMCR, TRCENA | armv7m->demcr);
 
 	/* Paranoia: evidently some (early?) chips don't preserve all the
 	 * debug state (including FBP, DWT, etc) across reset...
@@ -533,7 +527,7 @@ static int cortex_m3_soft_reset_halt(struct target *target)
 	uint32_t dcb_dhcsr = 0;
 	int retval, timeout = 0;
 
-	/* Enter debug state on reset; see end_reset_event() */
+	/* Enter debug state on reset; restore DEMCR in endreset_event() */
 	mem_ap_write_u32(swjdp, DCB_DEMCR,
 			TRCENA | VC_HARDERR | VC_BUSERR | VC_CORERESET);
 
@@ -782,14 +776,15 @@ static int cortex_m3_assert_reset(struct target *target)
 
 		/* clear C_HALT in dhcsr reg */
 		cortex_m3_write_debug_halt_mask(target, 0, C_HALT);
-
-		/* Enter debug state on reset, cf. end_reset_event() */
-		mem_ap_write_u32(swjdp, DCB_DEMCR,
-				TRCENA | VC_HARDERR | VC_BUSERR);
 	}
 	else
 	{
-		/* Enter debug state on reset, cf. end_reset_event() */
+		/* Halt in debug on reset; endreset_event() restores DEMCR.
+		 *
+		 * REVISIT catching BUSERR presumably helps to defend against
+		 * bad vector table entries.  Should this include MMERR or
+		 * other flags too?
+		 */
 		mem_ap_write_atomic_u32(swjdp, DCB_DEMCR,
 				TRCENA | VC_HARDERR | VC_BUSERR | VC_CORERESET);
 	}
@@ -1938,12 +1933,20 @@ COMMAND_HANDLER(handle_cortex_m3_vector_catch_command)
 			}
 		}
 write:
+		/* For now, armv7m->demcr only stores vector catch flags. */
+		armv7m->demcr = catch;
+
 		demcr &= ~0xffff;
 		demcr |= catch;
 
-		/* write, but don't assume it stuck */
+		/* write, but don't assume it stuck (why not??) */
 		mem_ap_write_u32(swjdp, DCB_DEMCR, demcr);
 		mem_ap_read_atomic_u32(swjdp, DCB_DEMCR, &demcr);
+
+		/* FIXME be sure to clear DEMCR on clean server shutdown.
+		 * Otherwise the vector catch hardware could fire when there's
+		 * no debugger hooked up, causing much confusion...
+		 */
 	}
 
 	for (unsigned i = 0; i < ARRAY_SIZE(vec_ids); i++)

-----------------------------------------------------------------------

Summary of changes:
 NEWS                   |    2 ++
 src/target/armv7m.h    |    9 +++++++--
 src/target/cortex_m3.c |   45 ++++++++++++++++++++++++---------------------
 3 files changed, 33 insertions(+), 23 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Thu Jan 14 08:34:00 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Thu, 14 Jan 2010 07:34:00 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-105-gb60dd35
Message-ID: <E1NVKDT-0008TX-F6@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  b60dd35e33b622216c12d5804f949df087eb59fa (commit)
       via  73566405b6e105b0a8b7f21db48331926bec97ad (commit)
      from  d91941d5a01ca0b9d43571edc03ba18741076cca (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit b60dd35e33b622216c12d5804f949df087eb59fa
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Wed Jan 13 23:33:53 2010 -0800

    User's Guide updates
    
    Capture various bits of useful information that have come up on the
    list but haven't yet gotten into the documentation:
    
     - Watchdog timers firing during JTAG debug need attention;
    
     - Some chips have special registers to help JTAG debug;
    
     - Cortex-M3 stepping example with IRQs and maskisr;
    
     - Clarifications re adaptive clocking:  not all ARMs do it, and
       explain it a bit better.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 3e0b5db..4446046 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -942,6 +942,33 @@ handling issues like:
 
 @itemize @bullet
 
+ at item @b{Watchdog Timers}...
+Watchog timers are typically used to automatically reset systems if
+some application task doesn't periodically reset the timer.  (The
+assumption is that the system has locked up if the task can't run.)
+When a JTAG debugger halts the system, that task won't be able to run
+and reset the timer ... potentially causing resets in the middle of
+your debug sessions.
+
+It's rarely a good idea to disable such watchdogs, since their usage
+needs to be debugged just like all other parts of your firmware.
+That might however be your only option.
+
+Look instead for chip-specific ways to stop the watchdog from counting
+while the system is in a debug halt state.  It may be simplest to set
+that non-counting mode in your debugger startup scripts.  You may however
+need a different approach when, for example, a motor could be physically
+damaged by firmware remaining inactive in a debug halt state.  That might
+involve a type of firmware mode where that "non-counting" mode is disabled
+at the beginning then re-enabled at the end; a watchdog reset might fire
+and complicate the debug session, but hardware (or people) would be
+protected. at footnote{Note that many systems support a "monitor mode" debug
+that is a somewhat cleaner way to address such issues.  You can think of
+it as only halting part of the system, maybe just one task,
+instead of the whole thing.
+At this writing, January 2010, OpenOCD based debugging does not support
+monitor mode debug, only "halt mode" debug.}
+
 @item @b{ARM Semihosting}...
 @cindex ARM semihosting
 When linked with a special runtime library provided with many
@@ -964,7 +991,12 @@ via the @code{WFI} instruction (or its coprocessor equivalent, before ARMv7).
 
 You may want to @emph{disable that instruction} in source code,
 or otherwise prevent using that state,
-to ensure you can get JTAG access at any time.
+to ensure you can get JTAG access at any time. at footnote{As a more
+polite alternative, some processors have special debug-oriented
+registers which can be used to change various features including
+how the low power states are clocked while debugging.
+The STM32 DBGMCU_CR register is an example; at the cost of extra
+power consumption, JTAG can be used during low power states.}
 For example, the OpenOCD @command{halt} command may not
 work for an idle processor otherwise.
 
@@ -6699,8 +6731,10 @@ to debug remote targets.
 Setting up GDB to work with OpenOCD can involve several components:
 
 @itemize
- at item OpenOCD itself may need to be configured.  @xref{GDB Configuration}.
- at item GDB itself may need configuration, as shown in this chapter.
+ at item The OpenOCD server support for GDB may need to be configured.
+ at xref{GDB Configuration}.
+ at item GDB's support for OpenOCD may need configuration,
+as shown in this chapter.
 @item If you have a GUI environment like Eclipse,
 that also will probably need to be configured.
 @end itemize
@@ -6803,6 +6837,24 @@ With that particular hardware (Cortex-M3) the hardware breakpoints
 only work for code running from flash memory.  Most other ARM systems
 do not have such restrictions.
 
+Another example of useful GDB configuration came from a user who
+found that single stepping his Cortex-M3 didn't work well with IRQs
+and an RTOS until he told GDB to disable the IRQs while stepping:
+
+ at example
+define hook-step
+mon cortex_m3 maskisr on
+end
+define hookpost-step
+mon cortex_m3 maskisr off
+end
+ at end example
+
+Rather than typing such commands interactively, you may prefer to
+save them in a file and have GDB execute them as it starts, perhaps
+using a @file{.gdbinit} in your project directory or starting GDB
+using @command{gdb -x filename}.
+
 @section Programming using GDB
 @cindex Programming using GDB
 
@@ -6947,36 +6999,48 @@ is jim, not real tcl).
 
 In digital circuit design it is often refered to as ``clock
 synchronisation'' the JTAG interface uses one clock (TCK or TCLK)
-operating at some speed, your target is operating at another.  The two
-clocks are not synchronised, they are ``asynchronous''
+operating at some speed, your CPU target is operating at another.
+The two clocks are not synchronised, they are ``asynchronous''
 
-In order for the two to work together they must be synchronised. Otherwise
-the two systems will get out of sync with each other and nothing will
-work. There are 2 basic options:
+In order for the two to work together they must be synchronised
+well enough to work; JTAG can't go ten times faster than the CPU,
+for example.  There are 2 basic options:
 @enumerate
 @item
-Use a special circuit.
+Use a special "adaptive clocking" circuit to change the JTAG
+clock rate to match what the CPU currently supports.
 @item
-One clock must be some multiple slower than the other.
+The JTAG clock must be fixed at some speed that's enough slower than
+the CPU clock that all TMS and TDI transitions can be detected.
 @end enumerate
 
 @b{Does this really matter?} For some chips and some situations, this
-is a non-issue (i.e.: A 500MHz ARM926) but for others - for example some
-Atmel SAM7 and SAM9 chips start operation from reset at 32kHz -
-program/enable the oscillators and eventually the main clock. It is in
-those critical times you must slow the JTAG clock to sometimes 1 to
-4kHz.
-
-Imagine debugging a 500MHz ARM926 hand held battery powered device
-that ``deep sleeps'' at 32kHz between every keystroke. It can be
-painful.
+is a non-issue, like a 500MHz ARM926 with a 5 MHz JTAG link;
+the CPU has no difficulty keeping up with JTAG.
+Startup sequences are often problematic though, as are other
+situations where the CPU clock rate changes (perhaps to save
+power).
+
+For example, Atmel AT91SAM chips start operation from reset with
+a 32kHz system clock.  Boot firmware may activate the main oscillator
+and PLL before switching to a faster clock (perhaps that 500 MHz
+ARM926 scenario).
+If you're using JTAG to debug that startup sequence, you must slow
+the JTAG clock to sometimes 1 to 4kHz.  After startup completes,
+JTAG can use a faster clock.
+
+Consider also debugging a 500MHz ARM926 hand held battery powered
+device that enters a low power ``deep sleep'' mode, at 32kHz CPU
+clock, between keystrokes unless it has work to do.   When would
+that 5 MHz JTAG clock be usable?
 
 @b{Solution #1 - A special circuit}
 
-In order to make use of this, your JTAG dongle must support the RTCK
+In order to make use of this,
+both your CPU and your JTAG dongle must support the RTCK
 feature. Not all dongles support this - keep reading!
 
-The RTCK signal often found in some ARM chips is used to help with
+The RTCK ("Return TCK") signal in some ARM chips is used to help with
 this problem. ARM has a good description of the problem described at
 this link: @url{http://www.arm.com/support/faqdev/4170.html} [checked
 28/nov/2008]. Link title: ``How does the JTAG synchronisation logic
@@ -7013,8 +7077,9 @@ ARM11 cores use an 8:1 division.
 Note: Many FTDI2232C based JTAG dongles are limited to 6MHz.
 
 You can still debug the 'low power' situations - you just need to
-manually adjust the clock speed at every step. While painful and
-tedious, it is not always practical.
+either use a fixed and very slow JTAG clock rate ... or else
+manually adjust the clock speed at every step. (Adjusting is painful
+and tedious, and is not always practical.)
 
 It is however easy to ``code your way around it'' - i.e.: Cheat a little,
 have a special debug mode in your application that does a ``high power

commit 73566405b6e105b0a8b7f21db48331926bec97ad
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Wed Jan 13 23:33:25 2010 -0800

    NOR: add optional "flash erase_address" sector padding
    
    Add a NOR flash mechanism where erase_address ranges can be padded
    out to sector boundaries, triggering a diagnostic:
    
      > flash erase_address 0x0001f980 16
      address range 0x0001f980 .. 0x0001f98f is not sector-aligned
      Command handler execution failed
      in procedure 'flash' called at file "command.c", line 647
      called at file "command.c", line 361
      >
    
      > flash erase_address pad 0x0001f980 16
      Adding extra erase range, 0x0001f800 to 0x0001f97f
      Adding extra erase range, 0x0001f990 to 0x0001fbff
      erased address 0x0001f980 (length 16) in 0.095975s (0.163 kb/s)
      >
    
    This addresses what would otherwise be something of a functional
    regression.  An earlier version of the interface had a dangerous
    problem:  it would silently erase data outside the range it was
    told to erase.  Fixing that bug turned up some folk who relied on
    that unsafe behavior.  (The classic problem with interface bugs!)
    Now they can get that behavior again.  If they really need it,
    just specify "pad".
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/NEWS b/NEWS
index a8b2b44..ce4896f 100644
--- a/NEWS
+++ b/NEWS
@@ -50,7 +50,9 @@ Flash Layer:
 		- <driver_name>[.N]: reference the driver's Nth bank
 	New 'nand verify' command to check bank against an image file.
 	The "flash erase_address" command now rejects partial sectors;
-		previously it would silently erase extra data.
+		previously it would silently erase extra data.  If you
+		want to erase the rest of the first and/or last sectors
+		instead of failing, you must pass an explicit "pad" flag.
 	New at91sam9 NAND controller driver.
 
 Board, Target, and Interface Configuration Scripts:
diff --git a/doc/openocd.texi b/doc/openocd.texi
index 0eb40b1..3e0b5db 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -3841,8 +3841,12 @@ specifies "to the end of the flash bank".
 The @var{num} parameter is a value shown by @command{flash banks}.
 @end deffn
 
- at deffn Command {flash erase_address} address length
+ at deffn Command {flash erase_address} [@option{pad}] address length
 Erase sectors starting at @var{address} for @var{length} bytes.
+Unless @option{pad} is specified, @math{address} must begin a
+flash sector, and @math{address + length - 1} must end a sector.
+Specifying @option{pad} erases extra data at the beginning and/or
+end of the specified region, as needed to erase only full sectors.
 The flash bank to use is inferred from the @var{address}, and
 the specified length must stay within that bank.
 As a special case, when @var{length} is zero and @var{address} is
diff --git a/src/flash/nor/core.c b/src/flash/nor/core.c
index 9083ed1..aedaa86 100644
--- a/src/flash/nor/core.c
+++ b/src/flash/nor/core.c
@@ -287,9 +287,22 @@ int default_flash_blank_check(struct flash_bank *bank)
 	return ERROR_OK;
 }
 
-/* erase given flash region, selects proper bank according to target and address */
+/* Manipulate given flash region, selecting the bank according to target
+ * and address.  Maps an address range to a set of sectors, and issues
+ * the callback() on that set ... e.g. to erase or unprotect its members.
+ *
+ * (Note a current bad assumption:  that protection operates on the same
+ * size sectors as erase operations use.)
+ *
+ * The "pad_reason" parameter is a kind of boolean:  when it's NULL, the
+ * range must fit those sectors exactly.  This is clearly safe; it can't
+ * erase data which the caller said to leave alone, for example.  If it's
+ * non-NULL, rather than failing, extra data in the first and/or last
+ * sectors will be added to the range, and that reason string is used when
+ * warning about those additions.
+ */
 static int flash_iterate_address_range(struct target *target,
-		uint32_t addr, uint32_t length,
+		char *pad_reason, uint32_t addr, uint32_t length,
 		int (*callback)(struct flash_bank *bank, int first, int last))
 {
 	struct flash_bank *c;
@@ -328,18 +341,53 @@ static int flash_iterate_address_range(struct target *target,
 	for (i = 0; i < c->num_sectors; i++)
 	{
 		struct flash_sector *f = c->sectors + i;
+		uint32_t end = f->offset + f->size;
 
 		/* start only on a sector boundary */
 		if (first < 0) {
+			/* scanned past the first sector? */
+			if (addr < f->offset)
+				break;
+
 			/* is this the first sector? */
 			if (addr == f->offset)
 				first = i;
-			else if (addr < f->offset)
-				break;
+
+			/* Does this need head-padding?  If so, pad and warn;
+			 * or else force an error.
+			 *
+			 * Such padding can make trouble, since *WE* can't
+			 * ever know if that data was in use.  The warning
+			 * should help users sort out messes later.
+			 */
+			else if (addr < end && pad_reason) {
+				/* FIXME say how many bytes (e.g. 80 KB) */
+				LOG_WARNING("Adding extra %s range, "
+						"%#8.8x to %#8.8x",
+					pad_reason,
+					(unsigned) f->offset,
+					(unsigned) addr - 1);
+				first = i;
+			} else
+				continue;
 		}
 
 		/* is this (also?) the last sector? */
-		if (last_addr == f->offset + f->size) {
+		if (last_addr == end) {
+			last = i;
+			break;
+		}
+
+		/* Does this need tail-padding?  If so, pad and warn;
+		 * or else force an error.
+		 */
+		if (last_addr < end && pad_reason) {
+			/* FIXME say how many bytes (e.g. 80 KB) */
+			LOG_WARNING("Adding extra %s range, "
+					"%#8.8x to %#8.8x",
+				pad_reason,
+				(unsigned) last_addr,
+				(unsigned) end - 1);
 			last = i;
 			break;
 		}
@@ -358,18 +406,17 @@ static int flash_iterate_address_range(struct target *target,
 		return ERROR_FLASH_DST_BREAKS_ALIGNMENT;
 	}
 
-	/* The NOR driver may trim this range down, based on
-	 * whether or not a given sector is already erased.
-	 *
-	 * REVISIT should *we* trim it... ?
+	/* The NOR driver may trim this range down, based on what
+	 * sectors are already erased/unprotected.  GDB currently
+	 * blocks such optimizations.
 	 */
 	return callback(c, first, last);
 }
 
 int flash_erase_address_range(struct target *target,
-		uint32_t addr, uint32_t length)
+		bool pad, uint32_t addr, uint32_t length)
 {
-	return flash_iterate_address_range(target,
+	return flash_iterate_address_range(target, pad ? "erase" : NULL,
 			addr, length, &flash_driver_erase);
 }
 
@@ -380,7 +427,11 @@ static int flash_driver_unprotect(struct flash_bank *bank, int first, int last)
 
 static int flash_unlock_address_range(struct target *target, uint32_t addr, uint32_t length)
 {
-	return flash_iterate_address_range(target,
+	/* By default, pad to sector boundaries ... the real issue here
+	 * is that our (only) caller *permanently* removes protection,
+	 * and doesn't restore it.
+	 */
+	return flash_iterate_address_range(target, "unprotect",
 			addr, length, &flash_driver_unprotect);
 }
 
@@ -394,6 +445,12 @@ int flash_write_unlock(struct target *target, struct image *image,
 	struct flash_bank *c;
 	int *padding;
 
+	/* REVISIT do_pad should perhaps just be another parameter.
+	 * GDB wouldn't ever need it, since it erases separately.
+	 * But "flash write_image" commands might want that option.
+	 */
+	bool do_pad = false;
+
 	section = 0;
 	section_offset = 0;
 
@@ -470,7 +527,8 @@ int flash_write_unlock(struct target *target, struct image *image,
 			 * In both cases, the extra writes slow things down.
 			 */
 
-			/* if we have multiple sections within our image, flash programming could fail due to alignment issues
+			/* if we have multiple sections within our image,
+			 * flash programming could fail due to alignment issues
 			 * attempt to rebuild a consecutive buffer for the flash loader */
 			pad_bytes = (image->sections[section_last + 1].base_address) - (run_address + run_size);
 			if ((run_address + run_size + pad_bytes) > (c->base + c->size))
@@ -560,7 +618,8 @@ int flash_write_unlock(struct target *target, struct image *image,
 			if (erase)
 			{
 				/* calculate and erase sectors */
-				retval = flash_erase_address_range(target, run_address, run_size);
+				retval = flash_erase_address_range(target,
+						do_pad, run_address, run_size);
 			}
 		}
 
diff --git a/src/flash/nor/core.h b/src/flash/nor/core.h
index 36e163d..b164b8d 100644
--- a/src/flash/nor/core.h
+++ b/src/flash/nor/core.h
@@ -102,10 +102,14 @@ int flash_init_drivers(struct command_context *cmd_ctx);
 
 /**
  * Erases @a length bytes in the @a target flash, starting at @a addr.
+ * The range @a addr to @a addr + @a length - 1 must be strictly
+ * sector aligned, unless @a pad is true.  Setting @a pad true extends
+ * the range, at beginning and/or end, if needed for sector alignment.
  * @returns ERROR_OK if successful; otherwise, an error code.
  */
 int flash_erase_address_range(struct target *target,
-		uint32_t addr, uint32_t length);
+		bool pad, uint32_t addr, uint32_t length);
+
 /**
  * Writes @a image into the @a target flash.  The @a written parameter
  * will contain the
diff --git a/src/flash/nor/tcl.c b/src/flash/nor/tcl.c
index b7e80df..cf40a81 100644
--- a/src/flash/nor/tcl.c
+++ b/src/flash/nor/tcl.c
@@ -203,14 +203,29 @@ COMMAND_HANDLER(handle_flash_erase_address_command)
 	int retval;
 	int address;
 	int length;
-
+	bool do_pad = false;
 	struct target *target = get_current_target(CMD_CTX);
 
-	if (CMD_ARGC != 2)
+	switch (CMD_ARGC) {
+	case 3:
+		/* Optionally pad out the address range to block/sector
+		 * boundaries.  We can't know if there's data in that part
+		 * of the flash; only do padding if we're told to.
+		 */
+		if (strcmp("pad", CMD_ARGV[0]) != 0)
+			return ERROR_COMMAND_SYNTAX_ERROR;
+		do_pad = true;
+		CMD_ARGC--;
+		CMD_ARGV++;
+		/* FALL THROUGH */
+	case 2:
+		COMMAND_PARSE_NUMBER(int, CMD_ARGV[0], address);
+		COMMAND_PARSE_NUMBER(int, CMD_ARGV[1], length);
+		break;
+	default:
 		return ERROR_COMMAND_SYNTAX_ERROR;
+	}
 
-	COMMAND_PARSE_NUMBER(int, CMD_ARGV[0], address);
-	COMMAND_PARSE_NUMBER(int, CMD_ARGV[1], length);
 	if (length <= 0)
 	{
 		command_print(CMD_CTX, "Length must be >0");
@@ -229,7 +244,7 @@ COMMAND_HANDLER(handle_flash_erase_address_command)
 	struct duration bench;
 	duration_start(&bench);
 
-	retval = flash_erase_address_range(target, address, length);
+	retval = flash_erase_address_range(target, do_pad, address, length);
 
 	if ((ERROR_OK == retval) && (duration_measure(&bench) == ERROR_OK))
 	{
@@ -698,9 +713,12 @@ static const struct command_registration flash_exec_command_handlers[] = {
 		.name = "erase_address",
 		.handler = handle_flash_erase_address_command,
 		.mode = COMMAND_EXEC,
-		.usage = "address length",
-		.help = "Erase flash blocks starting at address "
-			"and continuing for length bytes.",
+		.usage = "['pad'] address length",
+		.help = "Erase flash sectors starting at address and "
+			"continuing for length bytes.  If 'pad' is specified, "
+			"data outside that range may also be erased: the start "
+			"address may be decreased, and length increased, so "
+			"that all of the first and last sectors are erased.",
 	},
 	{
 		.name = "fillw",
diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index 8018e6f..4191cc2 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -1928,9 +1928,19 @@ int gdb_v_packet(struct connection *connection, struct target *target, char *pac
 		flash_set_dirty();
 
 		/* perform any target specific operations before the erase */
-		target_call_event_callbacks(gdb_service->target, TARGET_EVENT_GDB_FLASH_ERASE_START);
-		result = flash_erase_address_range(gdb_service->target, addr, length);
-		target_call_event_callbacks(gdb_service->target, TARGET_EVENT_GDB_FLASH_ERASE_END);
+		target_call_event_callbacks(gdb_service->target,
+				TARGET_EVENT_GDB_FLASH_ERASE_START);
+
+		/* vFlashErase:addr,length messages require region start and
+		 * end to be "block" aligned ... if padding is ever needed,
+		 * GDB will have become dangerously confused.
+		 */
+		result = flash_erase_address_range(gdb_service->target,
+				false, addr, length);
+
+		/* perform any target specific operations after the erase */
+		target_call_event_callbacks(gdb_service->target,
+				TARGET_EVENT_GDB_FLASH_ERASE_END);
 
 		/* perform erase */
 		if (result != ERROR_OK)

-----------------------------------------------------------------------

Summary of changes:
 NEWS                    |    4 +-
 doc/openocd.texi        |  117 +++++++++++++++++++++++++++++++++++++----------
 src/flash/nor/core.c    |   87 +++++++++++++++++++++++++++++------
 src/flash/nor/core.h    |    6 ++-
 src/flash/nor/tcl.c     |   34 ++++++++++---
 src/server/gdb_server.c |   16 +++++-
 6 files changed, 213 insertions(+), 51 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Thu Jan 14 10:36:08 2010
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Thu, 14 Jan 2010 09:36:08 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-106-ge2d3266
Message-ID: <E1NVM7d-0004yR-5L@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  e2d3266ff1e10068d03e9a8ba3fc6c2238ff2251 (commit)
      from  b60dd35e33b622216c12d5804f949df087eb59fa (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit e2d3266ff1e10068d03e9a8ba3fc6c2238ff2251
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Thu Jan 14 00:58:07 2010 +0000

    GDB: change gdb_breakpoint_override to COMMAND_ANY
    
     - enable gdb_breakpoint_override to be used within config script.
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index 4191cc2..d656745 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -2476,7 +2476,7 @@ static const struct command_registration gdb_command_handlers[] = {
 	{
 		.name = "gdb_breakpoint_override",
 		.handler = handle_gdb_breakpoint_override_command,
-		.mode = COMMAND_EXEC,
+		.mode = COMMAND_ANY,
 		.help = "Display or specify type of breakpoint "
 			"to be used by gdb 'break' commands.",
 		.usage = "('hard'|'soft'|'disable')"

-----------------------------------------------------------------------

Summary of changes:
 src/server/gdb_server.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Thu Jan 14 12:16:15 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Thu, 14 Jan 2010 11:16:15 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-107-ge1679a2
Message-ID: <E1NVNgX-00071u-AO@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  e1679a29f084e3172077d513d14a0fde9ea2ea77 (commit)
      from  e2d3266ff1e10068d03e9a8ba3fc6c2238ff2251 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit e1679a29f084e3172077d513d14a0fde9ea2ea77
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 14 03:16:07 2010 -0800

    ARM7/9 minor cleanups
    
    Shrink some overlong lines.  Add my 2009 copyright.
    Move a declaration to the beginning of its block.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm7_9_common.c b/src/target/arm7_9_common.c
index 0f8f263..baf3e45 100644
--- a/src/target/arm7_9_common.c
+++ b/src/target/arm7_9_common.c
@@ -11,6 +11,8 @@
  *   Copyright (C) 2008 by Hongtao Zheng                                   *
  *   hontor at 126.com                                                        *
  *                                                                         *
+ *   Copyright (C) 2009 by David Brownell                                  *
+ *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
  *   it under the terms of the GNU General Public License as published by  *
  *   the Free Software Foundation; either version 2 of the License, or     *
@@ -941,11 +943,11 @@ int arm7_9_poll(struct target *target)
 int arm7_9_assert_reset(struct target *target)
 {
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
+	enum reset_types jtag_reset_config = jtag_get_reset_config();
 
 	LOG_DEBUG("target->state: %s",
 		  target_state_name(target));
 
-	enum reset_types jtag_reset_config = jtag_get_reset_config();
 	if (!(jtag_reset_config & RESET_HAS_SRST))
 	{
 		LOG_ERROR("Can't assert SRST");
@@ -973,28 +975,43 @@ int arm7_9_assert_reset(struct target *target)
 	if (target->reset_halt)
 	{
 		/*
-		 * Some targets do not support communication while SRST is asserted. We need to
-		 * set up the reset vector catch here.
+		 * For targets that don't support communication while SRST is
+		 * asserted, we need to set up the reset vector catch first.
 		 *
-		 * If TRST is asserted, then these settings will be reset anyway, so setting them
-		 * here is harmless.
+		 * When we use TRST+SRST and that's equivalent to a power-up
+		 * reset, these settings may well be reset anyway; so setting
+		 * them here won't matter.
 		 */
 		if (arm7_9->has_vector_catch)
 		{
-			/* program vector catch register to catch reset vector */
-			embeddedice_write_reg(&arm7_9->eice_cache->reg_list[EICE_VEC_CATCH], 0x1);
+			/* program vector catch register to catch reset */
+			embeddedice_write_reg(&arm7_9->eice_cache
+					->reg_list[EICE_VEC_CATCH], 0x1);
 
-			/* extra runtest added as issues were found with certain ARM9 cores (maybe more) - AT91SAM9260 and STR9 */
+			/* extra runtest added as issues were found with
+			 * certain ARM9 cores (maybe more) - AT91SAM9260
+			 * and STR9
+			 */
 			jtag_add_runtest(1, jtag_get_end_state());
 		}
 		else
 		{
-			/* program watchpoint unit to match on reset vector address */
-			embeddedice_write_reg(&arm7_9->eice_cache->reg_list[EICE_W0_ADDR_VALUE], 0x0);
-			embeddedice_write_reg(&arm7_9->eice_cache->reg_list[EICE_W0_ADDR_MASK], 0x3);
-			embeddedice_write_reg(&arm7_9->eice_cache->reg_list[EICE_W0_DATA_MASK], 0xffffffff);
-			embeddedice_write_reg(&arm7_9->eice_cache->reg_list[EICE_W0_CONTROL_VALUE], EICE_W_CTRL_ENABLE);
-			embeddedice_write_reg(&arm7_9->eice_cache->reg_list[EICE_W0_CONTROL_MASK], ~EICE_W_CTRL_nOPC & 0xff);
+			/* program watchpoint unit to match on reset vector
+			 * address
+			 */
+			embeddedice_write_reg(&arm7_9->eice_cache
+					->reg_list[EICE_W0_ADDR_VALUE], 0x0);
+			embeddedice_write_reg(&arm7_9->eice_cache
+					->reg_list[EICE_W0_ADDR_MASK], 0x3);
+			embeddedice_write_reg(&arm7_9->eice_cache
+					->reg_list[EICE_W0_DATA_MASK],
+						0xffffffff);
+			embeddedice_write_reg(&arm7_9->eice_cache
+					->reg_list[EICE_W0_CONTROL_VALUE],
+						EICE_W_CTRL_ENABLE);
+			embeddedice_write_reg(&arm7_9->eice_cache
+					->reg_list[EICE_W0_CONTROL_MASK],
+						~EICE_W_CTRL_nOPC & 0xff);
 		}
 	}
 
@@ -1012,9 +1029,10 @@ int arm7_9_assert_reset(struct target *target)
 
 	register_cache_invalidate(arm7_9->armv4_5_common.core_cache);
 
-	if ((target->reset_halt) && ((jtag_reset_config & RESET_SRST_PULLS_TRST) == 0))
+	if (target->reset_halt
+			&& !(jtag_reset_config & RESET_SRST_PULLS_TRST))
 	{
-		/* debug entry was already prepared in arm7_9_assert_reset() */
+		/* debug entry was prepared above */
 		target->debug_reason = DBG_REASON_DBGRQ;
 	}
 

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm7_9_common.c |   52 +++++++++++++++++++++++++++++--------------
 1 files changed, 35 insertions(+), 17 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Thu Jan 14 15:09:03 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Thu, 14 Jan 2010 14:09:03 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-108-g24653c9
Message-ID: <E1NVQNk-0005Cb-NH@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  24653c950a18c49d267efb17a36423d9c455a886 (commit)
      from  e1679a29f084e3172077d513d14a0fde9ea2ea77 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 24653c950a18c49d267efb17a36423d9c455a886
Author: Laurentiu Cocanu <laurentiu.cocanu at zylin.com>
Date:   Thu Jan 14 13:59:36 2010 +0100

    str9x.c: remove optimization when erasing the whole bank
    
    Using the erase bank command will cause a time out error. Replacing
    this with the erase sector bank will provide a slower but safer and
    stable method to erase the flash.
    
    Signed-off-by: Laurentiu Cocanu <laurentiu.cocanu at zylin.com>
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nor/str9x.c b/src/flash/nor/str9x.c
index bf3f750..d0c1278 100644
--- a/src/flash/nor/str9x.c
+++ b/src/flash/nor/str9x.c
@@ -230,17 +230,9 @@ static int str9x_erase(struct flash_bank *bank, int first, int last)
 		return ERROR_TARGET_NOT_HALTED;
 	}
 
-	/* Check if we erase whole bank */
-	if ((first == 0) && (last == (bank->num_sectors - 1)))
-	{
-		/* Optimize to run erase bank command instead of sector */
-		erase_cmd = 0x80;
-	}
-	else
-	{
-		/* Erase sector command */
-		erase_cmd = 0x20;
-	}
+	/*A slower but stable way of erasing*/
+	/* Erase sector command */
+	erase_cmd = 0x20;
 
 	for (i = first; i <= last; i++)
 	{
@@ -296,10 +288,6 @@ static int str9x_erase(struct flash_bank *bank, int first, int last)
 			LOG_ERROR("error erasing flash bank, status: 0x%x", status);
 			return ERROR_FLASH_OPERATION_FAILED;
 		}
-
-		/* If we ran erase bank command, we are finished */
-		if (erase_cmd == 0x80)
-			break;
 	}
 
 	for (i = first; i <= last; i++)

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/str9x.c |   18 +++---------------
 1 files changed, 3 insertions(+), 15 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Thu Jan 14 21:08:10 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Thu, 14 Jan 2010 20:08:10 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-109-g000a1cf
Message-ID: <E1NVVzH-0008EZ-OL@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  000a1cfd011d0b1e9ae30446df4eabe269202550 (commit)
      from  24653c950a18c49d267efb17a36423d9c455a886 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 000a1cfd011d0b1e9ae30446df4eabe269202550
Author: Peter Korsgaard <jacmet at sunsite.dk>
Date:   Mon Jan 11 22:59:29 2010 +0100

    nand flash support for s3c64xx
    
    Identical to the existing 2412/2443 support except for the base address
    and NFCONF value (bit 2 is reserved and should be written as 1 ref UM).
    
    Tested on a s3c6410 board, but controller is identical in 6400/6410
    except for 8bit MLC ECC support in 6410 which isn't supported by the
    driver.
    
    Signed-off-by: Peter Korsgaard <jacmet at sunsite.dk>
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 4446046..a0fc0fb 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -5041,7 +5041,8 @@ change any behavior.
 @deffnx {NAND Driver} s3c2412
 @deffnx {NAND Driver} s3c2440
 @deffnx {NAND Driver} s3c2443
-These S3C24xx family controllers don't have any special
+ at deffnx {NAND Driver} s3c6400
+These S3C family controllers don't have any special
 @command{nand device} options, and don't define any
 specialized commands.
 At this writing, their drivers don't include @code{write_page}
diff --git a/src/flash/nand/Makefile.am b/src/flash/nand/Makefile.am
index 2ffa4c4..a495dfd 100644
--- a/src/flash/nand/Makefile.am
+++ b/src/flash/nand/Makefile.am
@@ -25,6 +25,7 @@ NAND_DRIVERS = \
 	s3c2412.c \
 	s3c2440.c \
 	s3c2443.c \
+	s3c6400.c \
 	at91sam9.c
 
 noinst_HEADERS = \
diff --git a/src/flash/nand/driver.c b/src/flash/nand/driver.c
index 0e174b2..1c28dbc 100644
--- a/src/flash/nand/driver.c
+++ b/src/flash/nand/driver.c
@@ -36,6 +36,7 @@ extern struct nand_flash_controller s3c2410_nand_controller;
 extern struct nand_flash_controller s3c2412_nand_controller;
 extern struct nand_flash_controller s3c2440_nand_controller;
 extern struct nand_flash_controller s3c2443_nand_controller;
+extern struct nand_flash_controller s3c6400_nand_controller;
 extern struct nand_flash_controller imx31_nand_flash_controller;
 extern struct nand_flash_controller at91sam9_nand_controller;
 
@@ -51,6 +52,7 @@ static struct nand_flash_controller *nand_flash_controllers[] =
 	&s3c2412_nand_controller,
 	&s3c2440_nand_controller,
 	&s3c2443_nand_controller,
+	&s3c6400_nand_controller,
 	&imx31_nand_flash_controller,
 	&at91sam9_nand_controller,
 /*	&boundary_scan_nand_controller, */
diff --git a/src/flash/nand/s3c6400.c b/src/flash/nand/s3c6400.c
new file mode 100644
index 0000000..20b6cc1
--- /dev/null
+++ b/src/flash/nand/s3c6400.c
@@ -0,0 +1,76 @@
+/***************************************************************************
+ *   Copyright (C) 2010 by Peter Korsgaard <jacmet at sunsite.dk>             *
+ *   Heavily based on s3c2412.c by Ben Dooks <ben at fluff.org>               *
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ *   This program is distributed in the hope that it will be useful,       *
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
+ *   GNU General Public License for more details.                          *
+ *                                                                         *
+ *   You should have received a copy of the GNU General Public License     *
+ *   along with this program; if not, write to the                         *
+ *   Free Software Foundation, Inc.,                                       *
+ *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
+ ***************************************************************************/
+
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
+#include "s3c24xx.h"
+/* s3c64xx uses another base address for the nand controller than 24xx */
+#undef S3C2410_NFREG
+#define S3C2410_NFREG(x) ((x) + 0x70200000)
+
+NAND_DEVICE_COMMAND_HANDLER(s3c6400_nand_device_command)
+{
+	struct s3c24xx_nand_controller *info;
+	CALL_S3C24XX_DEVICE_COMMAND(nand, &info);
+
+	/* fill in the address fields for the core device */
+	info->cmd = S3C2440_NFCMD;
+	info->addr = S3C2440_NFADDR;
+	info->data = S3C2440_NFDATA;
+	info->nfstat = S3C2412_NFSTAT;
+
+	return ERROR_OK;
+}
+
+static int s3c6400_init(struct nand_device *nand)
+{
+	struct s3c24xx_nand_controller *s3c24xx_info = nand->controller_priv;
+	struct target *target = s3c24xx_info->target;
+
+	target_write_u32(target, S3C2410_NFCONF,
+			 S3C2440_NFCONF_TACLS(3) |
+			 S3C2440_NFCONF_TWRPH0(7) |
+			 S3C2440_NFCONF_TWRPH1(7) | 4);
+
+	target_write_u32(target, S3C2440_NFCONT,
+			 S3C2412_NFCONT_INIT_MAIN_ECC |
+			 S3C2440_NFCONT_ENABLE);
+
+	return ERROR_OK;
+}
+
+struct nand_flash_controller s3c6400_nand_controller = {
+		.name = "s3c6400",
+		.nand_device_command = &s3c6400_nand_device_command,
+		.init = &s3c6400_init,
+		.reset = &s3c24xx_reset,
+		.command = &s3c24xx_command,
+		.address = &s3c24xx_address,
+		.write_data = &s3c24xx_write_data,
+		.read_data = &s3c24xx_read_data,
+		.write_page = s3c24xx_write_page,
+		.read_page = s3c24xx_read_page,
+		.write_block_data = &s3c2440_write_block_data,
+		.read_block_data = &s3c2440_read_block_data,
+		.controller_ready = &s3c24xx_controller_ready,
+		.nand_ready = &s3c2440_nand_ready,
+	};

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi                        |    3 ++-
 src/flash/nand/Makefile.am              |    1 +
 src/flash/nand/driver.c                 |    2 ++
 src/flash/nand/{s3c2443.c => s3c6400.c} |   28 ++++++++++++----------------
 4 files changed, 17 insertions(+), 17 deletions(-)
 copy src/flash/nand/{s3c2443.c => s3c6400.c} (81%)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Thu Jan 14 21:46:47 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Thu, 14 Jan 2010 20:46:47 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-110-g1d140c4
Message-ID: <E1NVWae-0006OS-KO@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  1d140c4dcd79cf5e6257d53986db23dc71c2521b (commit)
      from  000a1cfd011d0b1e9ae30446df4eabe269202550 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 1d140c4dcd79cf5e6257d53986db23dc71c2521b
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 14 12:45:58 2010 -0800

    ARM7/ARM9: improved reset support
    
    Teach most remaining ARM cores how to use the "reset-assert" event.
    
    Same model as elsewhere:  iff a handler is provided for that event,
    use that instead of trying to assert SRST (which may be unavailable,
    or inappropriate since it resets too much).  Else no change.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm7_9_common.c b/src/target/arm7_9_common.c
index baf3e45..ca1d84f 100644
--- a/src/target/arm7_9_common.c
+++ b/src/target/arm7_9_common.c
@@ -944,13 +944,15 @@ int arm7_9_assert_reset(struct target *target)
 {
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
 	enum reset_types jtag_reset_config = jtag_get_reset_config();
+	bool use_event = false;
 
 	LOG_DEBUG("target->state: %s",
 		  target_state_name(target));
 
-	if (!(jtag_reset_config & RESET_HAS_SRST))
-	{
-		LOG_ERROR("Can't assert SRST");
+	if (target_has_event_action(target, TARGET_EVENT_RESET_ASSERT))
+		use_event = true;
+	else if (!(jtag_reset_config & RESET_HAS_SRST)) {
+		LOG_ERROR("%s: how to reset?", target_name(target));
 		return ERROR_FAIL;
 	}
 
@@ -965,7 +967,8 @@ int arm7_9_assert_reset(struct target *target)
 	 */
 	bool srst_asserted = false;
 
-	if (((jtag_reset_config & RESET_SRST_PULLS_TRST) == 0)
+	if (!use_event
+			&& !(jtag_reset_config & RESET_SRST_PULLS_TRST)
 			&& (jtag_reset_config & RESET_SRST_NO_GATING))
 	{
 		jtag_add_reset(0, 1);
@@ -1015,22 +1018,28 @@ int arm7_9_assert_reset(struct target *target)
 		}
 	}
 
-	/* here we should issue an SRST only, but we may have to assert TRST as well */
-	if (jtag_reset_config & RESET_SRST_PULLS_TRST)
-	{
-		jtag_add_reset(1, 1);
-	} else if (!srst_asserted)
-	{
-		jtag_add_reset(0, 1);
+	if (use_event) {
+		target_handle_event(target, TARGET_EVENT_RESET_ASSERT);
+	} else {
+		/* If we use SRST ... we'd like to issue just SRST, but the
+		 * board or chip may be set up so we have to assert TRST as
+		 * well.  On some chips that combination is equivalent to a
+		 * power-up reset, and generally clobbers EICE state.
+		 */
+		if (jtag_reset_config & RESET_SRST_PULLS_TRST)
+			jtag_add_reset(1, 1);
+		else if (!srst_asserted)
+			jtag_add_reset(0, 1);
+		jtag_add_sleep(50000);
 	}
 
 	target->state = TARGET_RESET;
-	jtag_add_sleep(50000);
-
 	register_cache_invalidate(arm7_9->armv4_5_common.core_cache);
 
+	/* REVISIT why isn't standard debug entry logic sufficient?? */
 	if (target->reset_halt
-			&& !(jtag_reset_config & RESET_SRST_PULLS_TRST))
+			&& (!(jtag_reset_config & RESET_SRST_PULLS_TRST)
+				|| use_event))
 	{
 		/* debug entry was prepared above */
 		target->debug_reason = DBG_REASON_DBGRQ;

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm7_9_common.c |   37 +++++++++++++++++++++++--------------
 1 files changed, 23 insertions(+), 14 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Thu Jan 14 21:59:57 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Thu, 14 Jan 2010 20:59:57 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-111-g8e1b5c3
Message-ID: <E1NVWnO-0002D4-E7@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  8e1b5c313840544ec4aafbb9a6f464824b6414a9 (commit)
      from  1d140c4dcd79cf5e6257d53986db23dc71c2521b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 8e1b5c313840544ec4aafbb9a6f464824b6414a9
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 14 12:58:39 2010 -0800

    ARM ADIv5: add comments
    
    Add doxygen and other comments for what's more or less the lowest
    level JDAG-DP primitive, to access JTAG_DP_{A,D}PACC registers.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index e490f2e..1a86458 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -88,7 +88,24 @@ static uint32_t max_tar_block_size(uint32_t tar_autoincr_block, uint32_t address
  *                                                                         *
 ***************************************************************************/
 
-/* Scan out and in from target ordered uint8_t buffers */
+/**
+ * Scan DPACC or APACC using target ordered uint8_t buffers.  No endianness
+ * conversions are performed.  See section 4.4.3 of the ADIv5 spec, which
+ * discusses operations which access these registers.
+ *
+ * Note that only one scan is performed.  If RnW is set, a separate scan
+ * will be needed to collect the data which was read; the "invalue" collects
+ * the posted result of a preceding operation, not the current one.
+ *
+ * @param swjdp the DAP
+ * @param instr JTAG_DP_APACC (AP access) or JTAG_DP_DPACC (DP access)
+ * @param reg_addr two significant bits; A[3:2]; for APACC access, the
+ *	SELECT register has more addressing bits.
+ * @param RnW false iff outvalue will be written to the DP or AP
+ * @param outvalue points to a 32-bit (little-endian) integer
+ * @param invalue NULL, or points to a 32-bit (little-endian) integer
+ * @param ack points to where the three bit JTAG_ACK_* code will be stored
+ */
 static int adi_jtag_dp_scan(struct swjdp_common *swjdp,
 		uint8_t instr, uint8_t reg_addr, uint8_t RnW,
 		uint8_t *outvalue, uint8_t *invalue, uint8_t *ack)
@@ -104,6 +121,7 @@ static int adi_jtag_dp_scan(struct swjdp_common *swjdp,
 
 	/* REVISIT these TCK cycles should be *AFTER*  updating APACC, since
 	 * they provide more time for the (MEM) AP to complete the read ...
+	 * See "Minimum Response Time" for JTAG-DP, in the ADIv5 spec.
 	 */
 	if ((instr == JTAG_DP_APACC)
 			&& ((reg_addr == AP_REG_DRW)
@@ -111,12 +129,20 @@ static int adi_jtag_dp_scan(struct swjdp_common *swjdp,
 			&& (swjdp->memaccess_tck != 0))
 		jtag_add_runtest(swjdp->memaccess_tck, jtag_set_end_state(TAP_IDLE));
 
+	/* Scan out a read or write operation using some DP or AP register.
+	 * For APACC access with any sticky error flag set, this is discarded.
+	 */
 	fields[0].tap = jtag_info->tap;
 	fields[0].num_bits = 3;
 	buf_set_u32(&out_addr_buf, 0, 3, ((reg_addr >> 1) & 0x6) | (RnW & 0x1));
 	fields[0].out_value = &out_addr_buf;
 	fields[0].in_value = ack;
 
+	/* NOTE: if we receive JTAG_ACK_WAIT, the previous operation did not
+	 * complete; data we write is discarded, data we read is unpredictable.
+	 * When overrun detect is active, STICKYORUN is set.
+	 */
+
 	fields[1].tap = jtag_info->tap;
 	fields[1].num_bits = 32;
 	fields[1].out_value = outvalue;

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm_adi_v5.c |   28 +++++++++++++++++++++++++++-
 1 files changed, 27 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Thu Jan 14 23:39:55 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Thu, 14 Jan 2010 22:39:55 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-112-g0f7cea2
Message-ID: <E1NVYM8-0003lG-57@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  0f7cea2847d718f671b807c9d37cc6a4b648bc28 (commit)
      from  8e1b5c313840544ec4aafbb9a6f464824b6414a9 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 0f7cea2847d718f671b807c9d37cc6a4b648bc28
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 14 14:38:24 2010 -0800

    jtag.h whitespace/comment cleanup
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/jtag.h b/src/jtag/jtag.h
index f79ef93..0555754 100644
--- a/src/jtag/jtag.h
+++ b/src/jtag/jtag.h
@@ -525,8 +525,8 @@ int jtag_add_statemove(tap_state_t goal_state);
  * to @a endstate (unless it is also TAP_IDLE).
  *
  * @param num_cycles Number of cycles in TAP_IDLE state.  This argument
- * 	may be 0, in which case this routine will navigate to @a endstate
- * 	via TAP_IDLE.
+ *	may be 0, in which case this routine will navigate to @a endstate
+ *	via TAP_IDLE.
  * @param endstate The final state.
  */
 void jtag_add_runtest(int num_cycles, tap_state_t endstate);
@@ -563,23 +563,22 @@ void jtag_add_reset(int req_tlr_or_trst, int srst);
  * Set a global variable to \a state if \a state != TAP_INVALID.
  *
  * Return the value of the global variable.
- *
- **/
+ */
 tap_state_t jtag_set_end_state(tap_state_t state);
+
 /**
  * Function jtag_get_end_state
  *
  * Return the value of the global variable for end state
- *
- **/
+ */
 tap_state_t jtag_get_end_state(void);
-void jtag_add_sleep(uint32_t us);
 
+void jtag_add_sleep(uint32_t us);
 
 /**
- * Function jtag_add_stable_clocks
+ * Function jtag_add_clocks
  * first checks that the state in which the clocks are to be issued is
- * stable, then queues up clock_count clocks for transmission.
+ * stable, then queues up num_cycles clocks for transmission.
  */
 void jtag_add_clocks(int num_cycles);
 

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/jtag.h |   17 ++++++++---------
 1 files changed, 8 insertions(+), 9 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Fri Jan 15 18:36:42 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Fri, 15 Jan 2010 17:36:42 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-113-g187ccb6
Message-ID: <E1NVq6F-0006gX-QP@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  187ccb60eece14a1fb6cdeb38ab0ce4ccac443af (commit)
      from  0f7cea2847d718f671b807c9d37cc6a4b648bc28 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 187ccb60eece14a1fb6cdeb38ab0ce4ccac443af
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 15 09:36:01 2010 -0800

    NEWS: include s3c64xx NAND driver
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/NEWS b/NEWS
index ce4896f..c4abd13 100644
--- a/NEWS
+++ b/NEWS
@@ -54,6 +54,7 @@ Flash Layer:
 		want to erase the rest of the first and/or last sectors
 		instead of failing, you must pass an explicit "pad" flag.
 	New at91sam9 NAND controller driver.
+	New s3c64xx NAND controller driver.
 
 Board, Target, and Interface Configuration Scripts:
 	ARM9

-----------------------------------------------------------------------

Summary of changes:
 NEWS |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Fri Jan 15 21:53:35 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Fri, 15 Jan 2010 20:53:35 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-114-g6c4a643
Message-ID: <E1NVtAm-0006sm-Ug@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  6c4a643d632c6cff647c5099bd450d1e417903ea (commit)
      from  187ccb60eece14a1fb6cdeb38ab0ce4ccac443af (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 6c4a643d632c6cff647c5099bd450d1e417903ea
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 15 12:53:26 2010 -0800

    ARM DPM: disable some nyet-ready breakpoint code
    
    Until we manage breakpoints at runtime (patches not ready for 0.4)
    the only way this code should touch them is to disable them at server
    startup (a previous debug session may have left them active).
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_dpm.c b/src/target/arm_dpm.c
index 0908ca9..4bd22ff 100644
--- a/src/target/arm_dpm.c
+++ b/src/target/arm_dpm.c
@@ -341,13 +341,21 @@ int arm_dpm_write_dirty_registers(struct arm_dpm *dpm, bool bpwp)
 	if (retval != ERROR_OK)
 		goto done;
 
-	/* enable/disable hardware breakpoints */
-	for (unsigned i = 0; i < dpm->nbp; i++) {
-		struct dpm_bp *dbp = dpm->dbp + i;
-		struct breakpoint *bp = dbp->bp;
+	/* If we're managing hardware breakpoints for this core, enable
+	 * or disable them as requested.
+	 *
+	 * REVISIT We don't yet manage them for ANY cores.  Eventually
+	 * we should be able to assume we handle them; but until then,
+	 * cope with the hand-crafted breakpoint code.
+	 */
+	if (0) {
+		for (unsigned i = 0; i < dpm->nbp; i++) {
+			struct dpm_bp *dbp = dpm->dbp + i;
+			struct breakpoint *bp = dbp->bp;
 
-		retval = dpm_maybe_update_bpwp(dpm, bpwp, &dbp->bpwp,
-				bp ? &bp->set : NULL);
+			retval = dpm_maybe_update_bpwp(dpm, bpwp, &dbp->bpwp,
+					bp ? &bp->set : NULL);
+		}
 	}
 
 	/* enable/disable watchpoints */

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm_dpm.c |   20 ++++++++++++++------
 1 files changed, 14 insertions(+), 6 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Fri Jan 15 22:03:49 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Fri, 15 Jan 2010 21:03:49 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-115-g1837657
Message-ID: <E1NVtKg-0007PJ-Jr@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  183765707fb4d819b790b9431b83a9bf637fadc5 (commit)
      from  6c4a643d632c6cff647c5099bd450d1e417903ea (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 183765707fb4d819b790b9431b83a9bf637fadc5
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 15 13:02:45 2010 -0800

    ADIv5 improved diagnostic
    
    Don't just complain about an invalid ACK; say what the
    value was, to help troubleshooting.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 1a86458..ba5db3b 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -305,8 +305,9 @@ int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
 			}
 			else
 			{
-				LOG_WARNING("Invalid ACK "
-						"in JTAG-DP transaction");
+				LOG_WARNING("Invalid ACK %#x"
+						"in JTAG-DP transaction",
+						swjdp->ack);
 				return ERROR_JTAG_DEVICE_ERROR;
 			}
 

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm_adi_v5.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sat Jan 16 21:32:41 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sat, 16 Jan 2010 20:32:41 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-116-gdaa1ff3
Message-ID: <E1NWFK6-0004io-VQ@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  daa1ff3535c2dc1f6ae6da2b740cdf23f4f5f7a6 (commit)
      from  183765707fb4d819b790b9431b83a9bf637fadc5 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit daa1ff3535c2dc1f6ae6da2b740cdf23f4f5f7a6
Author: richard vegh <vegh.ricsi at gmail.com>
Date:   Sat Jan 16 12:27:45 2010 -0800

    NAND: lpc3180 crashes on LPC3250
    
    The LPC3180 NAND driver was crashing on some large page chips.
    Fix:
    
     - Crash and related functionality (don't memset too much OOB data)
     - Some debug messages
     - Command handling now works
    
    [dbrownell at users.sourceforge.net: whitespace/linelength/message cleanup]
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/flash/nand/lpc3180.c b/src/flash/nand/lpc3180.c
index 51ab34b..acb5f58 100644
--- a/src/flash/nand/lpc3180.c
+++ b/src/flash/nand/lpc3180.c
@@ -500,9 +500,10 @@ static int lpc3180_write_page(struct nand_device *nand, uint32_t page, uint8_t *
 			return ERROR_NAND_OPERATION_NOT_SUPPORTED;
 		}
 
-		if (oob && (oob_size > 6))
+		if (oob && (oob_size > 24))
 		{
-			LOG_ERROR("LPC3180 MLC controller can't write more than 6 bytes of OOB data");
+			LOG_ERROR("LPC3180 MLC controller can't write more "
+				"than 6 bytes for each quarter's OOB data");
 			return ERROR_NAND_OPERATION_NOT_SUPPORTED;
 		}
 
@@ -559,10 +560,10 @@ static int lpc3180_write_page(struct nand_device *nand, uint32_t page, uint8_t *
 				data += thisrun_data_size;
 			}
 
-			memset(oob_buffer, 0xff, (nand->page_size == 512) ? 6 : 24);
+			memset(oob_buffer, 0xff, 6);
 			if (oob)
 			{
-				memcpy(page_buffer, oob, thisrun_oob_size);
+				memcpy(oob_buffer, oob, thisrun_oob_size);
 				oob_size -= thisrun_oob_size;
 				oob += thisrun_oob_size;
 			}
@@ -570,8 +571,10 @@ static int lpc3180_write_page(struct nand_device *nand, uint32_t page, uint8_t *
 			/* write MLC_ECC_ENC_REG to start encode cycle */
 			target_write_u32(target, 0x200b8008, 0x0);
 
-			target_write_memory(target, 0x200a8000, 4, 128, page_buffer + (quarter * 512));
-			target_write_memory(target, 0x200a8000, 1, 6, oob_buffer + (quarter * 6));
+			target_write_memory(target, 0x200a8000,
+					4, 128, page_buffer);
+			target_write_memory(target, 0x200a8000,
+					1, 6, oob_buffer);
 
 			/* write MLC_ECC_AUTO_ENC_REG to start auto encode */
 			target_write_u32(target, 0x200b8010, 0x0);
@@ -760,7 +763,6 @@ static int lpc3180_controller_ready(struct nand_device *nand, int timeout)
 {
 	struct lpc3180_nand_controller *lpc3180_info = nand->controller_priv;
 	struct target *target = lpc3180_info->target;
-	uint8_t status = 0x0;
 
 	if (target->state != TARGET_HALTED)
 	{
@@ -768,20 +770,35 @@ static int lpc3180_controller_ready(struct nand_device *nand, int timeout)
 		return ERROR_NAND_OPERATION_FAILED;
 	}
 
+	LOG_DEBUG("lpc3180_controller_ready count start=%d", timeout);
+
 	do
 	{
 		if (lpc3180_info->selected_controller == LPC3180_MLC_CONTROLLER)
 		{
+			uint8_t status;
+
 			/* Read MLC_ISR, wait for controller to become ready */
 			target_read_u8(target, 0x200b8048, &status);
 
-			if (status & 2)
+			if (status & 2) {
+				LOG_DEBUG("lpc3180_controller_ready count=%d",
+						timeout);
 				return 1;
+			}
 		}
 		else if (lpc3180_info->selected_controller == LPC3180_SLC_CONTROLLER)
 		{
-			/* we pretend that the SLC controller is always ready */
-			return 1;
+			uint32_t status;
+
+			/* Read SLC_STAT and check READY bit */
+			target_read_u32(target, 0x20020018, &status);
+
+			if (status & 1) {
+				LOG_DEBUG("lpc3180_controller_ready count=%d",
+						timeout);
+				return 1;
+			}
 		}
 
 		alive_sleep(1);
@@ -801,6 +818,8 @@ static int lpc3180_nand_ready(struct nand_device *nand, int timeout)
 		return ERROR_NAND_OPERATION_FAILED;
 	}
 
+	LOG_DEBUG("lpc3180_nand_ready count start=%d", timeout);
+
 	do
 	{
 		if (lpc3180_info->selected_controller == LPC3180_MLC_CONTROLLER)
@@ -810,8 +829,11 @@ static int lpc3180_nand_ready(struct nand_device *nand, int timeout)
 			/* Read MLC_ISR, wait for NAND flash device to become ready */
 			target_read_u8(target, 0x200b8048, &status);
 
-			if (status & 1)
+			if (status & 1) {
+				LOG_DEBUG("lpc3180_nand_ready count end=%d",
+						timeout);
 				return 1;
+			}
 		}
 		else if (lpc3180_info->selected_controller == LPC3180_SLC_CONTROLLER)
 		{
@@ -820,8 +842,11 @@ static int lpc3180_nand_ready(struct nand_device *nand, int timeout)
 			/* Read SLC_STAT and check READY bit */
 			target_read_u32(target, 0x20020018, &status);
 
-			if (status & 1)
+			if (status & 1) {
+				LOG_DEBUG("lpc3180_nand_ready count end=%d",
+						timeout);
 				return 1;
+			}
 		}
 
 		alive_sleep(1);
@@ -844,7 +869,7 @@ COMMAND_HANDLER(handle_lpc3180_select_command)
 	}
 
 	unsigned num;
-	COMMAND_PARSE_NUMBER(uint, CMD_ARGV[1], num);
+	COMMAND_PARSE_NUMBER(uint, CMD_ARGV[0], num);
 	struct nand_device *nand = get_nand_device_by_num(num);
 	if (!nand)
 	{

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nand/lpc3180.c |   51 ++++++++++++++++++++++++++++++++++-----------
 1 files changed, 38 insertions(+), 13 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Mon Jan 18 08:39:08 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Mon, 18 Jan 2010 07:39:08 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-117-g0b641da
Message-ID: <E1NWmCc-0006VU-W2@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  0b641dac717ffe1391cc53dc33ad78ba79a26d2c (commit)
      from  daa1ff3535c2dc1f6ae6da2b740cdf23f4f5f7a6 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 0b641dac717ffe1391cc53dc33ad78ba79a26d2c
Author: simon qian <simonqian.openocd at gmail.com>
Date:   Sun Jan 17 23:37:15 2010 -0800

    read target voltage first in vsllink
    
    The very first command after init command should be "read target voltage".
    
    This is a tweak for the Old Versaloon firmware.  Without this, in most
    most cases, it works.   Under Ubuntu9.04, there is a chance that the USB
    will fail.  The problem disappears if I read target voltage first.
    
    For the lastest Versaloon firmware, it's OK.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/drivers/vsllink.c b/src/jtag/drivers/vsllink.c
index d301290..5c9a8db 100644
--- a/src/jtag/drivers/vsllink.c
+++ b/src/jtag/drivers/vsllink.c
@@ -476,6 +476,14 @@ static int vsllink_init(void)
 	}
 	VSLLINK_USB_TIMEOUT = to_tmp;
 
+	vsllink_simple_command(0x01);
+	result = vsllink_usb_read(vsllink_handle);
+	if (result != 2)
+		LOG_WARNING("Fail to get target voltage");
+	else
+		LOG_INFO("Target runs at %d mV", vsllink_usb_in_buffer[0]
+				+ (vsllink_usb_in_buffer[1] << 8));
+
 	// connect to vsllink
 	vsllink_connect();
 	// initialize function pointers

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/drivers/vsllink.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Jan 18 21:42:33 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Mon, 18 Jan 2010 20:42:33 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-118-g56d2c86
Message-ID: <E1NWyQk-0003ud-Rk@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  56d2c86500be87c87150bcfc1b2fe59ece9a45f4 (commit)
      from  0b641dac717ffe1391cc53dc33ad78ba79a26d2c (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 56d2c86500be87c87150bcfc1b2fe59ece9a45f4
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Jan 18 14:45:08 2010 +0100

    commands: allow scan_chain command to be executed during config
    
    Adding taps and then dumping them is quite reasonable thing
    to do in a config script.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/jtag/tcl.c b/src/jtag/tcl.c
index f48993f..ffb5d27 100644
--- a/src/jtag/tcl.c
+++ b/src/jtag/tcl.c
@@ -1674,7 +1674,7 @@ static const struct command_registration jtag_command_handlers[] = {
 	{
 		.name = "scan_chain",
 		.handler = handle_scan_chain_command,
-		.mode = COMMAND_EXEC,
+		.mode = COMMAND_ANY,
 		.help = "print current scan chain configuration",
 	},
 	{

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/tcl.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Mon Jan 18 22:19:35 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Mon, 18 Jan 2010 21:19:35 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-119-g5ab34b2
Message-ID: <E1NWz0a-0005mo-D0@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  5ab34b28ce3378a0a36b122a07af4f0f4769a24f (commit)
      from  56d2c86500be87c87150bcfc1b2fe59ece9a45f4 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 5ab34b28ce3378a0a36b122a07af4f0f4769a24f
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Mon Jan 18 13:17:05 2010 -0800

    vsllink -- add comment
    
    Previous patch deserved *inline* comment, not just
    in git revision history.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/drivers/vsllink.c b/src/jtag/drivers/vsllink.c
index 5c9a8db..65c3bf1 100644
--- a/src/jtag/drivers/vsllink.c
+++ b/src/jtag/drivers/vsllink.c
@@ -476,6 +476,9 @@ static int vsllink_init(void)
 	}
 	VSLLINK_USB_TIMEOUT = to_tmp;
 
+	/* Some older firmware versions sometimes fail if the
+	 * voltage isn't read first.
+	 */
 	vsllink_simple_command(0x01);
 	result = vsllink_usb_read(vsllink_handle);
 	if (result != 2)

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/drivers/vsllink.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Jan 19 11:13:53 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Tue, 19 Jan 2010 10:13:53 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-122-g924bf27
Message-ID: <E1NXB5u-0002lk-Dr@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  924bf27596f31ab8e79fbb4de702be4a9fa12874 (commit)
       via  c795b0d8f143a52e0b7196c6e353b381ac04f8ae (commit)
       via  cdcb9b0885cdb2ca2a212536ab68acc2e9bc7fad (commit)
      from  5ab34b28ce3378a0a36b122a07af4f0f4769a24f (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 924bf27596f31ab8e79fbb4de702be4a9fa12874
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Jan 18 21:54:58 2010 +0100

    zy1000: flush jtag buffer before changing speed
    
    It is conceivable that there could be commands in the
    queue when a speed change request comes in. Flush the
    hw queue before changing speed. Not observed, found by
    inspection.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/jtag/zy1000/zy1000.c b/src/jtag/zy1000/zy1000.c
index 9070f2e..2c205b7 100644
--- a/src/jtag/zy1000/zy1000.c
+++ b/src/jtag/zy1000/zy1000.c
@@ -199,6 +199,9 @@ void zy1000_reset(int trst, int srst)
 
 int zy1000_speed(int speed)
 {
+	/* flush JTAG master FIFO before setting speed */
+	waitIdle();
+
 	if (speed == 0)
 	{
 		/*0 means RCLK*/

commit c795b0d8f143a52e0b7196c6e353b381ac04f8ae
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Tue Jan 19 09:46:49 2010 +0100

    zy1000: print out PCB revision upon boot
    
    Simplify debugging a bit.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/ecosboard.c b/src/ecosboard.c
index de2a42c..2e73585 100644
--- a/src/ecosboard.c
+++ b/src/ecosboard.c
@@ -956,7 +956,11 @@ int main(int argc, char *argv[])
 
 	diag_init_putc(_zylinjtag_diag_write_char);
 	// We want this in the log.
-	diag_printf("Zylin ZY1000.\n");
+#ifdef CYGPKG_HAL_NIOS2
+	diag_printf("Zylin ZY1000 PCB revc.\n");
+#else
+	diag_printf("Zylin ZY1000 PCB revb.\n");
+#endif
 
 	err = mount("", "/ram", "ramfs");
 	if (err < 0)

commit cdcb9b0885cdb2ca2a212536ab68acc2e9bc7fad
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Tue Jan 19 09:47:21 2010 +0100

    flash: add error messages upon incorrect arguments to flash iteration
    
    According to OpenOCD error handling rules the error is
    logged at where it occurs(same site where an exception
    would have been thrown).
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nor/core.c b/src/flash/nor/core.c
index aedaa86..277da38 100644
--- a/src/flash/nor/core.c
+++ b/src/flash/nor/core.c
@@ -324,14 +324,20 @@ static int flash_iterate_address_range(struct target *target,
 	{
 		/* special case, erase whole bank when length is zero */
 		if (addr != c->base)
+		{
+			LOG_ERROR("Whole bank access must start at beginning of bank.");
 			return ERROR_FLASH_DST_BREAKS_ALIGNMENT;
+		}
 
 		return callback(c, 0, c->num_sectors - 1);
 	}
 
 	/* check whether it all fits in this bank */
 	if (addr + length - 1 > c->base + c->size - 1)
+	{
+		LOG_ERROR("Flash access does not fit into bank.");
 		return ERROR_FLASH_DST_BREAKS_ALIGNMENT;
+	}
 
 	/** @todo: handle erasures that cross into adjacent banks */
 

-----------------------------------------------------------------------

Summary of changes:
 src/ecosboard.c          |    6 +++++-
 src/flash/nor/core.c     |    6 ++++++
 src/jtag/zy1000/zy1000.c |    3 +++
 3 files changed, 14 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Tue Jan 19 22:57:39 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Tue, 19 Jan 2010 21:57:39 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-123-gfb42398
Message-ID: <E1NXM4y-00063x-If@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  fb4239866c6a9aa429b58be7488a93ec1245597b (commit)
      from  924bf27596f31ab8e79fbb4de702be4a9fa12874 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit fb4239866c6a9aa429b58be7488a93ec1245597b
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Tue Jan 19 13:56:33 2010 -0800

    NOR: fix diagnostic
    
    The "NOR: last_addr also needs correction when checking alignment"
    patch omitted a necessary update to the key diagnostic; fix.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/flash/nor/core.c b/src/flash/nor/core.c
index 277da38..2c61519 100644
--- a/src/flash/nor/core.c
+++ b/src/flash/nor/core.c
@@ -408,7 +408,7 @@ static int flash_iterate_address_range(struct target *target,
 		LOG_ERROR("address range 0x%8.8x .. 0x%8.8x "
 				"is not sector-aligned",
 				(unsigned) (c->base + addr),
-				(unsigned) (last_addr - 1));
+				(unsigned) (c->base + last_addr - 1));
 		return ERROR_FLASH_DST_BREAKS_ALIGNMENT;
 	}
 

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/core.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Wed Jan 20 00:02:42 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Tue, 19 Jan 2010 23:02:42 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-124-g4f310aa
Message-ID: <E1NXN5w-00084L-Jh@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  4f310aa0c962930eec7bfb22aface78f8dd91bb9 (commit)
      from  fb4239866c6a9aa429b58be7488a93ec1245597b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 4f310aa0c962930eec7bfb22aface78f8dd91bb9
Author: Andreas Fritiofson <andreas.fritiofson at gmail.com>
Date:   Sat Nov 21 16:53:31 2009 +0100

    update win32 script search path
    
    The default script search path on Windows is out of date with
    the current layout (from installation and documentation), which
    makes the standard script library not be found after a normal
    
    	./configure && make && make install
    
    under msys/MinGW. The same should hold true for cygwin native builds
    (not verified).
    
    Update search path to ../share/openocd/scripts not ../lib/openocd,
    relative to the openocd executable.
    
    Signed-off-by: Andreas Fritiofson <andreas.fritiofson at gmail.com>
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/helper/options.c b/src/helper/options.c
index 573026a..63c5b05 100644
--- a/src/helper/options.c
+++ b/src/helper/options.c
@@ -74,21 +74,21 @@ static void add_default_dirs(void)
 		add_script_search_dir(strExePath);
 	}
 	/*
-	 * Add support for the default (as of 20080121) layout when
-	 * using autotools and cygwin to build native MinGW binary.
+	 * Add support for the default (as of 20091118) layout when
+	 * using autotools and cygwin/MinGW to build native binary.
 	 * Path separator is converted to UNIX style so that MinGW is
 	 * pleased.
 	 *
 	 * bin/openocd.exe
-	 * lib/openocd/event/at91eb40a_reset.cfg
-	 * lib/openocd/target/at91eb40a.cfg
+	 * share/openocd/scripts/interface/dummy.cfg
+	 * share/openocd/scripts/target/at91eb40a.cfg
 	 */
 	{
 		char strExePath [MAX_PATH];
 		char *p;
 		GetModuleFileName (NULL, strExePath, MAX_PATH);
 		*strrchr(strExePath, '\\') = 0;
-		strcat(strExePath, "/../lib/"PACKAGE);
+		strcat(strExePath, "/../share/"PACKAGE"/scripts");
 		for (p = strExePath; *p; p++) {
 			if (*p == '\\')
 				*p = '/';

-----------------------------------------------------------------------

Summary of changes:
 src/helper/options.c |   10 +++++-----
 1 files changed, 5 insertions(+), 5 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Wed Jan 20 08:33:19 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Wed, 20 Jan 2010 07:33:19 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-126-g44aaba3
Message-ID: <E1NXV45-00015g-0M@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  44aaba3d08bebbd809aabbe1c05d5aecb54eff12 (commit)
       via  bf1e9a83c877f1439fe0e7b170ba897e11d08b1b (commit)
      from  4f310aa0c962930eec7bfb22aface78f8dd91bb9 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 44aaba3d08bebbd809aabbe1c05d5aecb54eff12
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Tue Jan 19 23:32:54 2010 -0800

    gdb_server -- subroutinize memory map logic
    
    Put the memory map logic into its own subroutine.
    This will make it a bit easier to package bugfixes,
    and simplifies the query packet handling.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index b2527d2..6ed7243 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -1647,9 +1647,121 @@ static int compare_bank (const void * a, const void * b)
 	}
 }
 
-static int gdb_query_packet(struct connection *connection,
+static int gdb_memory_map(struct connection *connection,
 		struct target *target, char *packet, int packet_size)
 {
+	/* We get away with only specifying flash here. Regions that are not
+	 * specified are treated as if we provided no memory map(if not we
+	 * could detect the holes and mark them as RAM).
+	 * Normally we only execute this code once, but no big deal if we
+	 * have to regenerate it a couple of times.
+	 */
+
+	struct flash_bank *p;
+	char *xml = NULL;
+	int size = 0;
+	int pos = 0;
+	int retval = ERROR_OK;
+	struct flash_bank **banks;
+	int offset;
+	int length;
+	char *separator;
+	int blocksize;
+	uint32_t ram_start = 0;
+	int i;
+
+	/* skip command character */
+	packet += 23;
+
+	offset = strtoul(packet, &separator, 16);
+	length = strtoul(separator + 1, &separator, 16);
+
+	xml_printf(&retval, &xml, &pos, &size, "<memory-map>\n");
+
+	/* Sort banks in ascending order.  We need to report non-flash
+	 * memory as ram (or rather read/write) by default for GDB, since
+	 * it has no concept of non-cacheable read/write memory (i/o etc).
+	 *
+	 * FIXME Most non-flash addresses are *NOT* RAM!  Don't lie.
+	 */
+	banks = malloc(sizeof(struct flash_bank *)*flash_get_bank_count());
+
+	for (i = 0; i < flash_get_bank_count(); i++) {
+		p = get_flash_bank_by_num(i);
+		if (p == NULL) {
+			free(banks);
+			retval = ERROR_FAIL;
+			gdb_send_error(connection, retval);
+			return retval;
+		}
+		banks[i] = p;
+	}
+
+	qsort(banks, flash_get_bank_count(), sizeof(struct flash_bank *),
+			compare_bank);
+
+	for (i = 0; i < flash_get_bank_count(); i++) {
+		p = banks[i];
+
+		if (ram_start < p->base)
+			xml_printf(&retval, &xml, &pos, &size,
+				"<memory type=\"ram\" start=\"0x%x\" "
+					"length=\"0x%x\"/>\n",
+				ram_start, p->base-ram_start);
+
+		/* If device has uneven sector sizes, eg. str7, lpc
+		 * we pass the smallest sector size to gdb memory map
+		 *
+		 * FIXME Don't lie about flash regions with different
+		 * sector sizes; just tell GDB about each region as
+		 * if it were a separate flash device.
+		 */
+		blocksize = gdb_calc_blocksize(p);
+
+		xml_printf(&retval, &xml, &pos, &size,
+			"<memory type=\"flash\" start=\"0x%x\" "
+				"length=\"0x%x\">\n" \
+			"<property name=\"blocksize\">0x%x</property>\n" \
+			"</memory>\n", \
+			p->base, p->size, blocksize);
+		ram_start = p->base + p->size;
+	}
+
+	if (ram_start != 0)
+		xml_printf(&retval, &xml, &pos, &size,
+			"<memory type=\"ram\" start=\"0x%x\" "
+				"length=\"0x%x\"/>\n",
+			ram_start, 0-ram_start);
+	/* ELSE a flash chip could be at the very end of the 32 bit address
+	 * space, in which case ram_start will be precisely 0
+	 */
+
+	free(banks);
+	banks = NULL;
+
+	xml_printf(&retval, &xml, &pos, &size, "</memory-map>\n");
+
+	if (retval != ERROR_OK) {
+		gdb_send_error(connection, retval);
+		return retval;
+	}
+
+	if (offset + length > pos)
+		length = pos - offset;
+
+	char *t = malloc(length + 1);
+	t[0] = 'l';
+	memcpy(t + 1, xml + offset, length);
+	gdb_put_packet(connection, t, length + 1);
+
+	free(t);
+	free(xml);
+	return ERROR_OK;
+}
+
+static int gdb_query_packet(struct connection *connection,
+	struct target *target, char *packet, int packet_size)
+{
 	struct command_context *cmd_ctx = connection->cmd_ctx;
 	struct gdb_connection *gdb_connection = connection->priv;
 
@@ -1747,112 +1859,9 @@ static int gdb_query_packet(struct connection *connection,
 
 		return ERROR_OK;
 	}
-	else if (strstr(packet, "qXfer:memory-map:read::") && (flash_get_bank_count() > 0))
-	{
-		/* We get away with only specifying flash here. Regions that are not
-		 * specified are treated as if we provided no memory map(if not we
-		 * could detect the holes and mark them as RAM).
-		 * Normally we only execute this code once, but no big deal if we
-		 * have to regenerate it a couple of times. */
-
-		struct flash_bank *p;
-		char *xml = NULL;
-		int size = 0;
-		int pos = 0;
-		int retval = ERROR_OK;
-
-		int offset;
-		int length;
-		char *separator;
-		int blocksize;
-
-		/* skip command character */
-		packet += 23;
-
-		offset = strtoul(packet, &separator, 16);
-		length = strtoul(separator + 1, &separator, 16);
-
-		xml_printf(&retval, &xml, &pos, &size, "<memory-map>\n");
-
-		/*
-		sort banks in ascending order, we need to make non-flash memory be ram(or rather
-		read/write) by default for GDB.
-		GDB does not have a concept of non-cacheable read/write memory.
-		 */
-		struct flash_bank **banks = malloc(sizeof(struct flash_bank *)*flash_get_bank_count());
-		int i;
-
-		for (i = 0; i < flash_get_bank_count(); i++)
-		{
-			p = get_flash_bank_by_num(i);
-			if (p == NULL)
-			{
-				free(banks);
-				retval = ERROR_FAIL;
-				gdb_send_error(connection, retval);
-				return retval;
-			}
-			banks[i]=p;
-		}
-
-		qsort(banks, flash_get_bank_count(), sizeof(struct flash_bank *), compare_bank);
-
-		uint32_t ram_start = 0;
-		for (i = 0; i < flash_get_bank_count(); i++)
-		{
-			p = banks[i];
-
-			if (ram_start < p->base)
-			{
-				xml_printf(&retval, &xml, &pos, &size, "<memory type=\"ram\" start=\"0x%x\" length=\"0x%x\"/>\n",
-					ram_start, p->base-ram_start);
-			}
-
-			/* if device has uneven sector sizes, eg. str7, lpc
-			 * we pass the smallest sector size to gdb memory map */
-			blocksize = gdb_calc_blocksize(p);
-
-			xml_printf(&retval, &xml, &pos, &size, "<memory type=\"flash\" start=\"0x%x\" length=\"0x%x\">\n" \
-				"<property name=\"blocksize\">0x%x</property>\n" \
-				"</memory>\n", \
-				p->base, p->size, blocksize);
-			ram_start = p->base + p->size;
-		}
-		if (ram_start != 0)
-		{
-			xml_printf(&retval, &xml, &pos, &size, "<memory type=\"ram\" start=\"0x%x\" length=\"0x%x\"/>\n",
-				ram_start, 0-ram_start);
-		} else
-		{
-			/* a flash chip could be at the very end of the 32 bit address space, in which case
-			ram_start will be precisely 0 */
-		}
-
-		free(banks);
-		banks = NULL;
-
-		xml_printf(&retval, &xml, &pos, &size, "</memory-map>\n");
-
-		if (retval != ERROR_OK)
-		{
-			gdb_send_error(connection, retval);
-			return retval;
-		}
-
-		if (offset + length > pos)
-		{
-			length = pos - offset;
-		}
-
-		char *t = malloc(length + 1);
-		t[0] = 'l';
-		memcpy(t + 1, xml + offset, length);
-		gdb_put_packet(connection, t, length + 1);
-
-		free(t);
-		free(xml);
-		return ERROR_OK;
-	}
+	else if (strstr(packet, "qXfer:memory-map:read::")
+			&& (flash_get_bank_count() > 0))
+		return gdb_memory_map(connection, target, packet, packet_size);
 	else if (strstr(packet, "qXfer:features:read:"))
 	{
 		char *xml = NULL;

commit bf1e9a83c877f1439fe0e7b170ba897e11d08b1b
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Tue Jan 19 23:30:36 2010 -0800

    gdb_server -- symbol cleanup
    
    Make most methods static; net minor object code shrink.
    Likewise various data symbols; no net change.
    Shrink some overlong lines.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index d656745..b2527d2 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -74,7 +74,7 @@ static struct gdb_connection *current_gdb_connection;
 static int gdb_breakpoint_override;
 static enum breakpoint_type gdb_breakpoint_override_type;
 
-extern int gdb_error(struct connection *connection, int retval);
+static int gdb_error(struct connection *connection, int retval);
 static unsigned short gdb_port = 3333;
 static unsigned short gdb_port_next = 0;
 static const char DIGITS[16] = "0123456789abcdef";
@@ -89,15 +89,17 @@ int gdb_actual_connections;
 /* set if we are sending a memory map to gdb
  * via qXfer:memory-map:read packet */
 /* enabled by default*/
-int gdb_use_memory_map = 1;
+static int gdb_use_memory_map = 1;
 /* enabled by default*/
-int gdb_flash_program = 1;
+static int gdb_flash_program = 1;
 
 /* if set, data aborts cause an error to be reported in memory read packets
- * see the code in gdb_read_memory_packet() for further explanations */
-int gdb_report_data_abort = 0;
+ * see the code in gdb_read_memory_packet() for further explanations.
+ * Disabled by default.
+ */
+static int gdb_report_data_abort;
 
-int gdb_last_signal(struct target *target)
+static int gdb_last_signal(struct target *target)
 {
 	switch (target->debug_reason)
 	{
@@ -117,7 +119,8 @@ int gdb_last_signal(struct target *target)
 	}
 }
 
-int check_pending(struct connection *connection, int timeout_s, int *got_data)
+static int check_pending(struct connection *connection,
+		int timeout_s, int *got_data)
 {
 	/* a non-blocking socket will block if there is 0 bytes available on the socket,
 	 * but return with as many bytes as are available immediately
@@ -284,14 +287,14 @@ static inline int gdb_get_char_fast(struct connection *connection, int* next_cha
 }
 
 
-int gdb_get_char(struct connection *connection, int* next_char)
+static int gdb_get_char(struct connection *connection, int* next_char)
 {
 	struct gdb_connection *gdb_con = connection->priv;
 	return gdb_get_char_fast(connection, next_char, &gdb_con->buf_p, &gdb_con->buf_cnt);
 }
 
 
-int gdb_putback_char(struct connection *connection, int last_char)
+static int gdb_putback_char(struct connection *connection, int last_char)
 {
 	struct gdb_connection *gdb_con = connection->priv;
 
@@ -311,7 +314,7 @@ int gdb_putback_char(struct connection *connection, int last_char)
 /* The only way we can detect that the socket is closed is the first time
  * we write to it, we will fail. Subsequent write operations will
  * succeed. Shudder! */
-int gdb_write(struct connection *connection, void *data, int len)
+static int gdb_write(struct connection *connection, void *data, int len)
 {
 	struct gdb_connection *gdb_con = connection->priv;
 	if (gdb_con->closed)
@@ -336,7 +339,8 @@ int gdb_write(struct connection *connection, void *data, int len)
 	return ERROR_SERVER_REMOTE_CLOSED;
 }
 
-int gdb_put_packet_inner(struct connection *connection, char *buffer, int len)
+static int gdb_put_packet_inner(struct connection *connection,
+		char *buffer, int len)
 {
 	int i;
 	unsigned char my_checksum = 0;
@@ -359,7 +363,8 @@ int gdb_put_packet_inner(struct connection *connection, char *buffer, int len)
 	int gotdata;
 	for (;;)
 	{
-		if ((retval = check_pending(connection, 0, &gotdata)) != ERROR_OK)
+		retval = check_pending(connection, 0, &gotdata);
+		if (retval != ERROR_OK)
 			return retval;
 		if (!gotdata)
 			break;
@@ -477,7 +482,7 @@ int gdb_put_packet_inner(struct connection *connection, char *buffer, int len)
 	return ERROR_OK;
 }
 
-int gdb_put_packet(struct connection *connection, char *buffer, int len)
+static int gdb_put_packet(struct connection *connection, char *buffer, int len)
 {
 	struct gdb_connection *gdb_con = connection->priv;
 	gdb_con->busy = 1;
@@ -616,7 +621,8 @@ static __inline__ int fetch_packet(struct connection *connection, int *checksum_
 	return ERROR_OK;
 }
 
-int gdb_get_packet_inner(struct connection *connection, char *buffer, int *len)
+static int gdb_get_packet_inner(struct connection *connection,
+		char *buffer, int *len)
 {
 	int character;
 	int retval;
@@ -691,7 +697,7 @@ int gdb_get_packet_inner(struct connection *connection, char *buffer, int *len)
 	return ERROR_OK;
 }
 
-int gdb_get_packet(struct connection *connection, char *buffer, int *len)
+static int gdb_get_packet(struct connection *connection, char *buffer, int *len)
 {
 	struct gdb_connection *gdb_con = connection->priv;
 	gdb_con->busy = 1;
@@ -700,7 +706,7 @@ int gdb_get_packet(struct connection *connection, char *buffer, int *len)
 	return retval;
 }
 
-int gdb_output_con(struct connection *connection, const char* line)
+static int gdb_output_con(struct connection *connection, const char* line)
 {
 	char *hex_buffer;
 	int i, bin_size;
@@ -722,7 +728,7 @@ int gdb_output_con(struct connection *connection, const char* line)
 	return retval;
 }
 
-int gdb_output(struct command_context *context, const char* line)
+static int gdb_output(struct command_context *context, const char* line)
 {
 	/* this will be dumped to the log and also sent as an O packet if possible */
 	LOG_USER_N("%s", line);
@@ -767,7 +773,8 @@ static void gdb_frontend_halted(struct target *target, struct connection *connec
 	}
 }
 
-int gdb_target_callback_event_handler(struct target *target, enum target_event event, void *priv)
+static int gdb_target_callback_event_handler(struct target *target,
+		enum target_event event, void *priv)
 {
 	int retval;
 	struct connection *connection = priv;
@@ -795,7 +802,7 @@ int gdb_target_callback_event_handler(struct target *target, enum target_event e
 	return ERROR_OK;
 }
 
-int gdb_new_connection(struct connection *connection)
+static int gdb_new_connection(struct connection *connection)
 {
 	struct gdb_connection *gdb_connection = malloc(sizeof(struct gdb_connection));
 	struct gdb_service *gdb_service = connection->service->priv;
@@ -851,7 +858,7 @@ int gdb_new_connection(struct connection *connection)
 	return ERROR_OK;
 }
 
-int gdb_connection_closed(struct connection *connection)
+static int gdb_connection_closed(struct connection *connection)
 {
 	struct gdb_service *gdb_service = connection->service->priv;
 	struct gdb_connection *gdb_connection = connection->priv;
@@ -898,14 +905,15 @@ int gdb_connection_closed(struct connection *connection)
 	return ERROR_OK;
 }
 
-void gdb_send_error(struct connection *connection, uint8_t the_error)
+static void gdb_send_error(struct connection *connection, uint8_t the_error)
 {
 	char err[4];
 	snprintf(err, 4, "E%2.2X", the_error);
 	gdb_put_packet(connection, err, 3);
 }
 
-int gdb_last_signal_packet(struct connection *connection, struct target *target, char* packet, int packet_size)
+static int gdb_last_signal_packet(struct connection *connection,
+		struct target *target, char* packet, int packet_size)
 {
 	char sig_reply[4];
 	int signal;
@@ -935,7 +943,8 @@ static int gdb_reg_pos(struct target *target, int pos, int len)
  * The format of reg->value is little endian
  *
  */
-void gdb_str_to_target(struct target *target, char *tstr, struct reg *reg)
+static void gdb_str_to_target(struct target *target,
+		char *tstr, struct reg *reg)
 {
 	int i;
 
@@ -968,7 +977,8 @@ static int hextoint(int c)
 }
 
 /* copy over in register buffer */
-void gdb_target_to_reg(struct target *target, char *tstr, int str_len, uint8_t *bin)
+static void gdb_target_to_reg(struct target *target,
+		char *tstr, int str_len, uint8_t *bin)
 {
 	if (str_len % 2)
 	{
@@ -987,7 +997,8 @@ void gdb_target_to_reg(struct target *target, char *tstr, int str_len, uint8_t *
 	}
 }
 
-int gdb_get_registers_packet(struct connection *connection, struct target *target, char* packet, int packet_size)
+static int gdb_get_registers_packet(struct connection *connection,
+		struct target *target, char* packet, int packet_size)
 {
 	struct reg **reg_list;
 	int reg_list_size;
@@ -1037,7 +1048,8 @@ int gdb_get_registers_packet(struct connection *connection, struct target *targe
 	return ERROR_OK;
 }
 
-int gdb_set_registers_packet(struct connection *connection, struct target *target, char *packet, int packet_size)
+static int gdb_set_registers_packet(struct connection *connection,
+		struct target *target, char *packet, int packet_size)
 {
 	int i;
 	struct reg **reg_list;
@@ -1095,7 +1107,8 @@ int gdb_set_registers_packet(struct connection *connection, struct target *targe
 	return ERROR_OK;
 }
 
-int gdb_get_register_packet(struct connection *connection, struct target *target, char *packet, int packet_size)
+static int gdb_get_register_packet(struct connection *connection,
+		struct target *target, char *packet, int packet_size)
 {
 	char *reg_packet;
 	int reg_num = strtoul(packet + 1, NULL, 16);
@@ -1130,7 +1143,8 @@ int gdb_get_register_packet(struct connection *connection, struct target *target
 	return ERROR_OK;
 }
 
-int gdb_set_register_packet(struct connection *connection, struct target *target, char *packet, int packet_size)
+static int gdb_set_register_packet(struct connection *connection,
+		struct target *target, char *packet, int packet_size)
 {
 	char *separator;
 	uint8_t *bin_buf;
@@ -1176,7 +1190,7 @@ int gdb_set_register_packet(struct connection *connection, struct target *target
 	return ERROR_OK;
 }
 
-int gdb_error(struct connection *connection, int retval)
+static int gdb_error(struct connection *connection, int retval)
 {
 	switch (retval)
 	{
@@ -1207,7 +1221,8 @@ int gdb_error(struct connection *connection, int retval)
  *
  * 8191 bytes by the looks of it. Why 8191 bytes instead of 8192?????
  */
-int gdb_read_memory_packet(struct connection *connection, struct target *target, char *packet, int packet_size)
+static int gdb_read_memory_packet(struct connection *connection,
+		struct target *target, char *packet, int packet_size)
 {
 	char *separator;
 	uint32_t addr = 0;
@@ -1281,7 +1296,8 @@ int gdb_read_memory_packet(struct connection *connection, struct target *target,
 	return retval;
 }
 
-int gdb_write_memory_packet(struct connection *connection, struct target *target, char *packet, int packet_size)
+static int gdb_write_memory_packet(struct connection *connection,
+		struct target *target, char *packet, int packet_size)
 {
 	char *separator;
 	uint32_t addr = 0;
@@ -1338,7 +1354,8 @@ int gdb_write_memory_packet(struct connection *connection, struct target *target
 	return retval;
 }
 
-int gdb_write_memory_binary_packet(struct connection *connection, struct target *target, char *packet, int packet_size)
+static int gdb_write_memory_binary_packet(struct connection *connection,
+		struct target *target, char *packet, int packet_size)
 {
 	char *separator;
 	uint32_t addr = 0;
@@ -1386,7 +1403,8 @@ int gdb_write_memory_binary_packet(struct connection *connection, struct target
 	return ERROR_OK;
 }
 
-int gdb_step_continue_packet(struct connection *connection, struct target *target, char *packet, int packet_size)
+static int gdb_step_continue_packet(struct connection *connection,
+		struct target *target, char *packet, int packet_size)
 {
 	int current = 0;
 	uint32_t address = 0x0;
@@ -1419,7 +1437,8 @@ int gdb_step_continue_packet(struct connection *connection, struct target *targe
 	return retval;
 }
 
-int gdb_breakpoint_watchpoint_packet(struct connection *connection, struct target *target, char *packet, int packet_size)
+static int gdb_breakpoint_watchpoint_packet(struct connection *connection,
+		struct target *target, char *packet, int packet_size)
 {
 	int type;
 	enum breakpoint_type bp_type = BKPT_SOFT /* dummy init to avoid warning */;
@@ -1523,8 +1542,11 @@ int gdb_breakpoint_watchpoint_packet(struct connection *connection, struct targe
 	return ERROR_OK;
 }
 
-/* print out a string and allocate more space as needed, mainly used for XML at this point */
-void xml_printf(int *retval, char **xml, int *pos, int *size, const char *fmt, ...)
+/* print out a string and allocate more space as needed,
+ * mainly used for XML at this point
+ */
+static void xml_printf(int *retval, char **xml, int *pos, int *size,
+		const char *fmt, ...)
 {
 	if (*retval != ERROR_OK)
 	{
@@ -1591,7 +1613,7 @@ static int decode_xfer_read(char *buf, char **annex, int *ofs, unsigned int *len
 	return 0;
 }
 
-int gdb_calc_blocksize(struct flash_bank *bank)
+static int gdb_calc_blocksize(struct flash_bank *bank)
 {
 	uint32_t i;
 	uint32_t block_size = 0xffffffff;
@@ -1625,7 +1647,8 @@ static int compare_bank (const void * a, const void * b)
 	}
 }
 
-int gdb_query_packet(struct connection *connection, struct target *target, char *packet, int packet_size)
+static int gdb_query_packet(struct connection *connection,
+		struct target *target, char *packet, int packet_size)
 {
 	struct command_context *cmd_ctx = connection->cmd_ctx;
 	struct gdb_connection *gdb_connection = connection->priv;
@@ -1881,7 +1904,8 @@ int gdb_query_packet(struct connection *connection, struct target *target, char
 	return ERROR_OK;
 }
 
-int gdb_v_packet(struct connection *connection, struct target *target, char *packet, int packet_size)
+static int gdb_v_packet(struct connection *connection,
+		struct target *target, char *packet, int packet_size)
 {
 	struct gdb_connection *gdb_connection = connection->priv;
 	struct gdb_service *gdb_service = connection->service->priv;
@@ -2028,11 +2052,12 @@ int gdb_v_packet(struct connection *connection, struct target *target, char *pac
 	return ERROR_OK;
 }
 
-int gdb_detach(struct connection *connection, struct target *target)
+static int gdb_detach(struct connection *connection, struct target *target)
 {
 	struct gdb_service *gdb_service = connection->service->priv;
 
-	target_call_event_callbacks(gdb_service->target, TARGET_EVENT_GDB_DETACH);
+	target_call_event_callbacks(gdb_service->target,
+			TARGET_EVENT_GDB_DETACH);
 
 	return gdb_put_packet(connection, "OK", 2);
 }
@@ -2052,9 +2077,6 @@ static void gdb_log_callback(void *priv, const char *file, unsigned line,
 	gdb_output_con(connection, string);
 }
 
-/* Do not allocate this on the stack */
-char gdb_packet_buffer[GDB_BUFFER_SIZE];
-
 static void gdb_sig_halted(struct connection *connection)
 {
 	char sig_reply[4];
@@ -2063,8 +2085,11 @@ static void gdb_sig_halted(struct connection *connection)
 
 }
 
-int gdb_input_inner(struct connection *connection)
+static int gdb_input_inner(struct connection *connection)
 {
+	/* Do not allocate this on the stack */
+	static char gdb_packet_buffer[GDB_BUFFER_SIZE];
+
 	struct gdb_service *gdb_service = connection->service->priv;
 	struct target *target = gdb_service->target;
 	char *packet = gdb_packet_buffer;
@@ -2077,10 +2102,9 @@ int gdb_input_inner(struct connection *connection)
 	do
 	{
 		packet_size = GDB_BUFFER_SIZE-1;
-		if ((retval = gdb_get_packet(connection, packet, &packet_size)) != ERROR_OK)
-		{
+		retval = gdb_get_packet(connection, packet, &packet_size);
+		if (retval != ERROR_OK)
 			return retval;
-		}
 
 		/* terminate with zero */
 		packet[packet_size] = 0;
@@ -2112,32 +2136,48 @@ int gdb_input_inner(struct connection *connection)
 					break;
 				case 'q':
 				case 'Q':
-					retval = gdb_query_packet(connection, target, packet, packet_size);
+					retval = gdb_query_packet(connection,
+							target, packet,
+							packet_size);
 					break;
 				case 'g':
-					retval = gdb_get_registers_packet(connection, target, packet, packet_size);
+					retval = gdb_get_registers_packet(
+							connection, target,
+							packet, packet_size);
 					break;
 				case 'G':
-					retval = gdb_set_registers_packet(connection, target, packet, packet_size);
+					retval = gdb_set_registers_packet(
+							connection, target,
+							packet, packet_size);
 					break;
 				case 'p':
-					retval = gdb_get_register_packet(connection, target, packet, packet_size);
+					retval = gdb_get_register_packet(
+							connection, target,
+							packet, packet_size);
 					break;
 				case 'P':
-					retval = gdb_set_register_packet(connection, target, packet, packet_size);
+					retval = gdb_set_register_packet(
+							connection, target,
+							packet, packet_size);
 					break;
 				case 'm':
-					retval = gdb_read_memory_packet(connection, target, packet, packet_size);
+					retval = gdb_read_memory_packet(
+							connection, target,
+							packet, packet_size);
 					break;
 				case 'M':
-					retval = gdb_write_memory_packet(connection, target, packet, packet_size);
+					retval = gdb_write_memory_packet(
+							connection, target,
+							packet, packet_size);
 					break;
 				case 'z':
 				case 'Z':
 					retval = gdb_breakpoint_watchpoint_packet(connection, target, packet, packet_size);
 					break;
 				case '?':
-					gdb_last_signal_packet(connection, target, packet, packet_size);
+					gdb_last_signal_packet(
+							connection, target,
+							packet, packet_size);
 					break;
 				case 'c':
 				case 's':
@@ -2199,14 +2239,19 @@ int gdb_input_inner(struct connection *connection)
 					}
 					break;
 				case 'v':
-					retval = gdb_v_packet(connection, target, packet, packet_size);
+					retval = gdb_v_packet(
+							connection, target,
+							packet, packet_size);
 					break;
 				case 'D':
 					retval = gdb_detach(connection, target);
 					extended_protocol = 0;
 					break;
 				case 'X':
-					if ((retval = gdb_write_memory_binary_packet(connection, target, packet, packet_size)) != ERROR_OK)
+					retval = gdb_write_memory_binary_packet(
+							connection, target,
+							packet, packet_size);
+					if (retval != ERROR_OK)
 						return retval;
 					break;
 				case 'k':
@@ -2261,7 +2306,7 @@ int gdb_input_inner(struct connection *connection)
 	return ERROR_OK;
 }
 
-int gdb_input(struct connection *connection)
+static int gdb_input(struct connection *connection)
 {
 	int retval = gdb_input_inner(connection);
 	struct gdb_connection *gdb_con = connection->priv;
@@ -2297,8 +2342,7 @@ static int gdb_target_start(struct target *target, uint16_t port)
 	return ERROR_OK;
 }
 
-/* FIXME static */
-int gdb_target_add_one(struct target *target)
+static int gdb_target_add_one(struct target *target)
 {
 	if (gdb_port == 0 && server_use_pipes == 0)
 	{
diff --git a/src/server/gdb_server.h b/src/server/gdb_server.h
index 17e40fe..d7a6ad0 100644
--- a/src/server/gdb_server.h
+++ b/src/server/gdb_server.h
@@ -36,7 +36,6 @@ struct gdb_service
 	struct target *target;
 };
 
-int gdb_target_add_one(struct target *target);
 int gdb_target_add_all(struct target *target);
 int gdb_register_commands(struct command_context *command_context);
 

-----------------------------------------------------------------------

Summary of changes:
 src/server/gdb_server.c |  387 +++++++++++++++++++++++++++--------------------
 src/server/gdb_server.h |    1 -
 2 files changed, 220 insertions(+), 168 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Wed Jan 20 09:05:39 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Wed, 20 Jan 2010 08:05:39 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-127-g20d1ef7
Message-ID: <E1NXVZN-0002hJ-J9@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  20d1ef70e8417da7efc8a032992ee7672a19e296 (commit)
      from  44aaba3d08bebbd809aabbe1c05d5aecb54eff12 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 20d1ef70e8417da7efc8a032992ee7672a19e296
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Wed Jan 20 00:04:17 2010 -0800

    User's guide: mention lpc2000 checksum issue
    
    Folk almost certainly want to have OpenOCD compute the checksum
    when they modify the vector table.  However, that almost guarantees
    that "verify_image" will fail.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index a0fc0fb..05b6f4e 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -4185,13 +4185,19 @@ which must appear in the following order:
 
 @itemize
 @item @var{variant} ... required, may be
- at var{lpc2000_v1} (older LPC21xx and LPC22xx)
- at var{lpc2000_v2} (LPC213x, LPC214x, LPC210[123], LPC23xx and LPC24xx)
-or @var{lpc1700} (LPC175x and LPC176x)
+ at option{lpc2000_v1} (older LPC21xx and LPC22xx)
+ at option{lpc2000_v2} (LPC213x, LPC214x, LPC210[123], LPC23xx and LPC24xx)
+or @option{lpc1700} (LPC175x and LPC176x)
 @item @var{clock_kHz} ... the frequency, in kiloHertz,
 at which the core is running
- at item @var{calc_checksum} ... optional (but you probably want to provide this!),
+ at item @option{calc_checksum} ... optional (but you probably want to provide this!),
 telling the driver to calculate a valid checksum for the exception vector table.
+ at quotation Note
+If you don't provide @option{calc_checksum} when you're writing the vector
+table, the boot ROM will almost certainly ignore your flash image.
+However, if you do provide it,
+with most tool chains @command{verify_image} will fail.
+ at end quotation
 @end itemize
 
 LPC flashes don't require the chip and bus width to be specified.

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi |   14 ++++++++++----
 1 files changed, 10 insertions(+), 4 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Wed Jan 20 10:08:17 2010
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Wed, 20 Jan 2010 09:08:17 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-128-g0c3a4b4
Message-ID: <E1NXWXy-00061V-D6@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  0c3a4b4d818554ea00dc993d31cea9f3e0d1a87d (commit)
      from  20d1ef70e8417da7efc8a032992ee7672a19e296 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 0c3a4b4d818554ea00dc993d31cea9f3e0d1a87d
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Tue Jan 19 21:00:55 2010 +0000

    ARMV7M: handle bkpt instruction on resume/step
    
    Skip over a bkpt instruction if found on resume/step.
    Only software breakpoints known to OpenOCD are currently handled.
    
    So this handles the special case of either a user added bkpt
    or library added, eg. semi-hosting support.
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/src/target/armv7m.c b/src/target/armv7m.c
index 233fb95..c172a27 100644
--- a/src/target/armv7m.c
+++ b/src/target/armv7m.c
@@ -694,6 +694,44 @@ int armv7m_blank_check_memory(struct target *target,
 	return ERROR_OK;
 }
 
+int armv7m_maybe_skip_bkpt_inst(struct target *target, bool *inst_found)
+{
+	struct armv7m_common *armv7m = target_to_armv7m(target);
+	struct reg *r = armv7m->core_cache->reg_list + 15;
+	bool result = false;
+
+
+	/* if we halted last time due to a bkpt instruction
+	 * then we have to manually step over it, otherwise
+	 * the core will break again */
+
+	if (target->debug_reason == DBG_REASON_BREAKPOINT)
+	{
+		uint16_t op;
+		uint32_t pc = buf_get_u32(r->value, 0, 32);
+
+		pc &= ~1;
+		if (target_read_u16(target, pc, &op) == ERROR_OK)
+		{
+			if ((op & 0xFF00) == 0xBE00)
+			{
+				pc = buf_get_u32(r->value, 0, 32) + 2;
+				buf_set_u32(r->value, 0, 32, pc);
+				r->dirty = true;
+				r->valid = true;
+				result = true;
+				LOG_DEBUG("Skipping over BKPT instruction");
+			}
+		}
+	}
+
+	if (inst_found) {
+		*inst_found = result;
+	}
+
+	return ERROR_OK;
+}
+
 /*--------------------------------------------------------------------------*/
 
 /*
diff --git a/src/target/armv7m.h b/src/target/armv7m.h
index 86caae2..9787e30 100644
--- a/src/target/armv7m.h
+++ b/src/target/armv7m.h
@@ -171,6 +171,8 @@ int armv7m_checksum_memory(struct target *target,
 int armv7m_blank_check_memory(struct target *target,
 		uint32_t address, uint32_t count, uint32_t* blank);
 
+int armv7m_maybe_skip_bkpt_inst(struct target *target, bool *inst_found);
+
 extern const struct command_registration armv7m_command_handlers[];
 
 #endif /* ARMV7M_H */
diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index 48f8114..762e318 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -638,6 +638,16 @@ static int cortex_m3_resume(struct target *target, int current,
 		r->valid = true;
 	}
 
+	/* if we halted last time due to a bkpt instruction
+	 * then we have to manually step over it, otherwise
+	 * the core will break again */
+
+	if (!breakpoint_find(target, buf_get_u32(r->value, 0, 32))
+			&& !debug_execution)
+	{
+		armv7m_maybe_skip_bkpt_inst(target, NULL);
+	}
+
 	resume_pc = buf_get_u32(r->value, 0, 32);
 
 	armv7m_restore_context(target);
@@ -690,6 +700,7 @@ static int cortex_m3_step(struct target *target, int current,
 	struct swjdp_common *swjdp = &armv7m->swjdp_info;
 	struct breakpoint *breakpoint = NULL;
 	struct reg *pc = armv7m->core_cache->reg_list + 15;
+	bool bkpt_inst_found = false;
 
 	if (target->state != TARGET_HALTED)
 	{
@@ -709,14 +720,23 @@ static int cortex_m3_step(struct target *target, int current,
 			cortex_m3_unset_breakpoint(target, breakpoint);
 	}
 
+	armv7m_maybe_skip_bkpt_inst(target, &bkpt_inst_found);
+
 	target->debug_reason = DBG_REASON_SINGLESTEP;
 
 	armv7m_restore_context(target);
 
 	target_call_event_callbacks(target, TARGET_EVENT_RESUMED);
 
-	/* set step and clear halt */
-	cortex_m3_write_debug_halt_mask(target, C_STEP, C_HALT);
+	/* if no bkpt instruction is found at pc then we can perform
+	 * a normal step, otherwise we have to manually step over the bkpt
+	 * instruction - as such simulate a step */
+	if (bkpt_inst_found == false)
+	{
+		/* set step and clear halt */
+		cortex_m3_write_debug_halt_mask(target, C_STEP, C_HALT);
+	}
+
 	mem_ap_read_atomic_u32(swjdp, DCB_DHCSR, &cortex_m3->dcb_dhcsr);
 
 	/* registers are now invalid */
@@ -735,6 +755,7 @@ static int cortex_m3_step(struct target *target, int current,
 	LOG_DEBUG("target stepped dcb_dhcsr = 0x%" PRIx32
 			" nvic_icsr = 0x%" PRIx32,
 			cortex_m3->dcb_dhcsr, cortex_m3->nvic_icsr);
+
 	return ERROR_OK;
 }
 

-----------------------------------------------------------------------

Summary of changes:
 src/target/armv7m.c    |   38 ++++++++++++++++++++++++++++++++++++++
 src/target/armv7m.h    |    2 ++
 src/target/cortex_m3.c |   25 +++++++++++++++++++++++--
 3 files changed, 63 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Wed Jan 20 14:52:19 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Wed, 20 Jan 2010 13:52:19 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-129-gff976cd
Message-ID: <E1NXayq-0003VN-Gt@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  ff976cdb29686ae9aa47687c35402c66978956d6 (commit)
      from  0c3a4b4d818554ea00dc993d31cea9f3e0d1a87d (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit ff976cdb29686ae9aa47687c35402c66978956d6
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Wed Jan 20 13:04:56 2010 +0100

    arm7/9: add nags upon reset about options to improve performance
    
    arm7_9 fast_memory_access and working area nags added.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/arm7_9_common.c b/src/target/arm7_9_common.c
index ca1d84f..509e91e 100644
--- a/src/target/arm7_9_common.c
+++ b/src/target/arm7_9_common.c
@@ -2760,6 +2760,16 @@ int arm7_9_check_reset(struct target *target)
 		LOG_WARNING("NOTE! DCC downloads have not been enabled, defaulting to slow memory writes. Type 'help dcc'.");
 	}
 
+	if (get_target_reset_nag() && (target->working_area_size == 0))
+	{
+		LOG_WARNING("NOTE! Severe performance degradation without working memory enabled.");
+	}
+
+	if (get_target_reset_nag() && !arm7_9->fast_memory_access)
+	{
+		LOG_WARNING("NOTE! Severe performance degradation without fast memory access enabled. Type 'help fast'.");
+	}
+
 	return ERROR_OK;
 }
 

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm7_9_common.c |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Wed Jan 20 15:12:50 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Wed, 20 Jan 2010 14:12:50 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-130-g87cb29d
Message-ID: <E1NXbIi-0006ky-7x@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  87cb29dcfe1e6900620319c3f90ed67f8ebefa0e (commit)
      from  ff976cdb29686ae9aa47687c35402c66978956d6 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 87cb29dcfe1e6900620319c3f90ed67f8ebefa0e
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Wed Jan 20 15:11:09 2010 +0100

    testing: fix str710 test case now builds
    
    Make the test case easily adjustable in size. str710
    has very peculiar flash sector layout, nice for testing,
    but a larget test_rom.elf is required.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/testing/examples/STR710Test/.gitignore b/testing/examples/STR710Test/.gitignore
new file mode 100644
index 0000000..a2d3f5a
--- /dev/null
+++ b/testing/examples/STR710Test/.gitignore
@@ -0,0 +1,2 @@
+.dep
+src/main.lst
diff --git a/testing/examples/STR710Test/prj/hitex_str7_ram.ld b/testing/examples/STR710Test/prj/hitex_str7_ram.ld
index 7ea221a..a0b2a3c 100644
--- a/testing/examples/STR710Test/prj/hitex_str7_ram.ld
+++ b/testing/examples/STR710Test/prj/hitex_str7_ram.ld
@@ -82,17 +82,17 @@ SECTIONS
 	{
 		*(.init)
         *(.fini)
-		PROVIDE_HIDDEN (__preinit_array_start = .);
+		PROVIDE (__preinit_array_start = .);
 		KEEP (*(.preinit_array))
-		PROVIDE_HIDDEN (__preinit_array_end = .);
-		PROVIDE_HIDDEN (__init_array_start = .);
+		PROVIDE (__preinit_array_end = .);
+		PROVIDE (__init_array_start = .);
 		KEEP (*(SORT(.init_array.*)))
 		KEEP (*(.init_array))
-		PROVIDE_HIDDEN (__init_array_end = .);
-		PROVIDE_HIDDEN (__fini_array_start = .);
+		PROVIDE (__init_array_end = .);
+		PROVIDE (__fini_array_start = .);
 		KEEP (*(.fini_array))
 		KEEP (*(SORT(.fini_array.*)))
-		PROVIDE_HIDDEN (__fini_array_end = .);
+		PROVIDE (__fini_array_end = .);
 	} >DATA
 
 	. = ALIGN(4);
diff --git a/testing/examples/STR710Test/prj/hitex_str7_rom.ld b/testing/examples/STR710Test/prj/hitex_str7_rom.ld
index c5c4de4..11ac4b6 100644
--- a/testing/examples/STR710Test/prj/hitex_str7_rom.ld
+++ b/testing/examples/STR710Test/prj/hitex_str7_rom.ld
@@ -83,17 +83,17 @@ SECTIONS
 	{
 		*(.init)
         *(.fini)
-		PROVIDE_HIDDEN (__preinit_array_start = .);
+		PROVIDE (__preinit_array_start = .);
 		KEEP (*(.preinit_array))
-		PROVIDE_HIDDEN (__preinit_array_end = .);
-		PROVIDE_HIDDEN (__init_array_start = .);
+		PROVIDE (__preinit_array_end = .);
+		PROVIDE (__init_array_start = .);
 		KEEP (*(SORT(.init_array.*)))
 		KEEP (*(.init_array))
-		PROVIDE_HIDDEN (__init_array_end = .);
-		PROVIDE_HIDDEN (__fini_array_start = .);
+		PROVIDE (__init_array_end = .);
+		PROVIDE (__fini_array_start = .);
 		KEEP (*(.fini_array))
 		KEEP (*(SORT(.fini_array.*)))
-		PROVIDE_HIDDEN (__fini_array_end = .);
+		PROVIDE (__fini_array_end = .);
 	} >CODE
 
 	. = ALIGN(4);
diff --git a/testing/examples/STR710Test/src/main.c b/testing/examples/STR710Test/src/main.c
index 99f2d26..c60b9f6 100644
--- a/testing/examples/STR710Test/src/main.c
+++ b/testing/examples/STR710Test/src/main.c
@@ -41,6 +41,20 @@
  */
 #include "typedefs.h"
 
+/* Increase the size of this dummy global data to create a larger ROM image */
+static const char test[] =
+		"ljasdfljkasdfljsaflsjadflksjadflksjadfasdfsadfsa"
+		"ljasdfljkasdfljsaflsjadflksjadflksjadfasdfsadfsa"
+		"ljasdfljkasdfljsaflsjadflksjadflksjadfasdfsadfsa"
+		"ljasdfljkasdfljsaflsjadflksjadflksjadfasdfsadfsa"
+		"ljasdfljkasdfljsaflsjadflksjadflksjadfasdfsadfsa"
+		"ljasdfljkasdfljsaflsjadflksjadflksjadfasdfsadfsa"
+		"ljasdfljkasdfljsaflsjadflksjadflksjadfasdfsadfsa"
+		"ljasdfljkasdfljsaflsjadflksjadflksjadfasdfsadfsa"
+		"ljasdfljkasdfljsaflsjadflksjadflksjadfasdfsadfsa";
+
+
+
 /*=========================================================================*/
 /*  DEFINE: All Structures and Common Constants                            */
 /*=========================================================================*/

-----------------------------------------------------------------------

Summary of changes:
 testing/examples/STR710Test/.gitignore            |    2 ++
 testing/examples/STR710Test/prj/hitex_str7_ram.ld |   12 ++++++------
 testing/examples/STR710Test/prj/hitex_str7_rom.ld |   12 ++++++------
 testing/examples/STR710Test/src/main.c            |   14 ++++++++++++++
 4 files changed, 28 insertions(+), 12 deletions(-)
 create mode 100644 testing/examples/STR710Test/.gitignore


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Wed Jan 20 19:33:11 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Wed, 20 Jan 2010 18:33:11 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-131-gd036f17
Message-ID: <E1NXfMf-0000tW-80@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  d036f1700171e0f8056d616a198f17b9be5719e0 (commit)
      from  87cb29dcfe1e6900620319c3f90ed67f8ebefa0e (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit d036f1700171e0f8056d616a198f17b9be5719e0
Author: Michael Grzeschik <m.grzeschik at pengutronix.de>
Date:   Wed Jan 20 19:06:13 2010 +0100

    tcl/target/at91sam3u4e.cfg: changed case in dependent file
    
    openocd does not start with the target configfile due to the case in the
    dependent config file.
    
    Signed-off-by: Michael Grzeschik <m.grzeschik at pengutronix.de>
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/tcl/target/at91sam3u4e.cfg b/tcl/target/at91sam3u4e.cfg
index 242b53e..e549185 100644
--- a/tcl/target/at91sam3u4e.cfg
+++ b/tcl/target/at91sam3u4e.cfg
@@ -1,5 +1,5 @@
 # common stuff
-source [find target/at91sam3uxx.cfg]
+source [find target/at91sam3uXX.cfg]
 
 # size is automatically "calculated" by probing
 set _FLASHNAME $_CHIPNAME.flash

-----------------------------------------------------------------------

Summary of changes:
 tcl/target/at91sam3u4e.cfg |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Wed Jan 20 19:47:03 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Wed, 20 Jan 2010 18:47:03 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-133-g22d25e6
Message-ID: <E1NXfa4-0001cs-2E@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  22d25e69213c49395ee0d40f6cc1eda935873ed2 (commit)
       via  6f2b88448fff59d00f625d0d361a7b9abf6bd673 (commit)
      from  d036f1700171e0f8056d616a198f17b9be5719e0 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 22d25e69213c49395ee0d40f6cc1eda935873ed2
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Wed Jan 20 10:46:53 2010 -0800

    board configs -- unique names for flash chips
    
    Don't give the same names to both flash chips on two OMAP boards.
    
    For OSK, enable DCC downloads (removing a warning).
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/tcl/board/omap2420_h4.cfg b/tcl/board/omap2420_h4.cfg
index 12efa05..d789e25 100644
--- a/tcl/board/omap2420_h4.cfg
+++ b/tcl/board/omap2420_h4.cfg
@@ -8,7 +8,5 @@ reset_config trst_and_srst separate
 # Board configs can vary a *LOT* ... parts, jumpers, etc.
 # This GP board boots from cs0 using NOR (2x32M), and also
 # has 64M NAND on cs6.
-set _FLASHNAME $_CHIPNAME.flash
-flash bank $_FLASHNAME cfi 0x04000000 0x02000000 2 2 $_TARGETNAME
-set _FLASHNAME $_CHIPNAME.flash
-flash bank $_FLASHNAME cfi 0x06000000 0x02000000 2 2 $_TARGETNAME
+flash bank h4.u10 cfi 0x04000000 0x02000000 2 2 $_TARGETNAME
+flash bank h4.u11 cfi 0x06000000 0x02000000 2 2 $_TARGETNAME
diff --git a/tcl/board/osk5912.cfg b/tcl/board/osk5912.cfg
index c33ae28..f4378f8 100644
--- a/tcl/board/osk5912.cfg
+++ b/tcl/board/osk5912.cfg
@@ -19,10 +19,8 @@ etm_dummy config $_TARGETNAME
 
 # standard boards populate two 16 MB chips, but manufacturing
 # options or an expansion board could change this config.
-set _FLASHNAME $_CHIPNAME.flash
-flash bank $_FLASHNAME cfi 0x00000000 0x01000000 2 2 $_TARGETNAME
-set _FLASHNAME $_CHIPNAME.flash
-flash bank $_FLASHNAME cfi 0x01000000 0x01000000 2 2 $_TARGETNAME
+flash bank osk.u1 cfi 0x00000000 0x01000000 2 2 $_TARGETNAME
+flash bank osk.u2 cfi 0x01000000 0x01000000 2 2 $_TARGETNAME
 
 proc osk5912_init {} {
 	omap5912_reset
@@ -32,3 +30,5 @@ proc osk5912_init {} {
 	flash probe 1
 }
 $_TARGETNAME configure -event reset-init { osk5912_init }
+
+arm7_9 dcc_downloads enable

commit 6f2b88448fff59d00f625d0d361a7b9abf6bd673
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Wed Jan 20 10:43:32 2010 -0800

    gdb_server: correctly report flash sector sizes
    
    Report each region of same-size sectors separately, instead of
    incorrectly reporting that every sector has the same size.
    
    This is a longstanding bug on NOR flash chips with non-uniform
    sector sizes.  It was largely hidden by other bugs in flash
    handling.  When some of those were recently fixed, this one was
    exposed as a regression on str710.
    
    [oyvind.harboe at zylin.com: update the loop to behave on str7 ]
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index 6ed7243..f3e0575 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -1613,22 +1613,6 @@ static int decode_xfer_read(char *buf, char **annex, int *ofs, unsigned int *len
 	return 0;
 }
 
-static int gdb_calc_blocksize(struct flash_bank *bank)
-{
-	uint32_t i;
-	uint32_t block_size = 0xffffffff;
-
-	/* loop through all sectors and return smallest sector size */
-
-	for (i = 0; i < (uint32_t)bank->num_sectors; i++)
-	{
-		if (bank->sectors[i].size < block_size)
-			block_size = bank->sectors[i].size;
-	}
-
-	return block_size;
-}
-
 static int compare_bank (const void * a, const void * b)
 {
 	struct flash_bank *b1, *b2;
@@ -1666,7 +1650,6 @@ static int gdb_memory_map(struct connection *connection,
 	int offset;
 	int length;
 	char *separator;
-	int blocksize;
 	uint32_t ram_start = 0;
 	int i;
 
@@ -1683,6 +1666,7 @@ static int gdb_memory_map(struct connection *connection,
 	 * it has no concept of non-cacheable read/write memory (i/o etc).
 	 *
 	 * FIXME Most non-flash addresses are *NOT* RAM!  Don't lie.
+	 * Current versions of GDB assume unlisted addresses are RAM...
 	 */
 	banks = malloc(sizeof(struct flash_bank *)*flash_get_bank_count());
 
@@ -1701,29 +1685,60 @@ static int gdb_memory_map(struct connection *connection,
 			compare_bank);
 
 	for (i = 0; i < flash_get_bank_count(); i++) {
+		int j;
+		unsigned sector_size = 0;
+		uint32_t start, end;
+
 		p = banks[i];
+		start = p->base;
+		end = p->base + p->size;
 
 		if (ram_start < p->base)
 			xml_printf(&retval, &xml, &pos, &size,
 				"<memory type=\"ram\" start=\"0x%x\" "
 					"length=\"0x%x\"/>\n",
-				ram_start, p->base-ram_start);
+				ram_start, p->base - ram_start);
 
-		/* If device has uneven sector sizes, eg. str7, lpc
-		 * we pass the smallest sector size to gdb memory map
-		 *
-		 * FIXME Don't lie about flash regions with different
-		 * sector sizes; just tell GDB about each region as
-		 * if it were a separate flash device.
+		/* Report adjacent groups of same-size sectors.  So for
+		 * example top boot CFI flash will list an initial region
+		 * with several large sectors (maybe 128KB) and several
+		 * smaller ones at the end (maybe 32KB).  STR7 will have
+		 * regions with 8KB, 32KB, and 64KB sectors; etc.
 		 */
-		blocksize = gdb_calc_blocksize(p);
+		for (j = 0; j < p->num_sectors; j++) {
+			unsigned group_len;
+
+			/* Maybe start a new group of sectors. */
+			if (sector_size == 0) {
+				start = p->base + p->sectors[j].offset;
+				xml_printf(&retval, &xml, &pos, &size,
+					"<memory type=\"flash\" "
+						"start=\"0x%x\" ",
+					start);
+				sector_size = p->sectors[j].size;
+			}
+
+			/* Does this finish a group of sectors?
+			 * If not, continue an already-started group.
+			 */
+			if (j == p->num_sectors -1)
+				group_len = (p->base + p->size) - start;
+			else if (p->sectors[j + 1].size != sector_size)
+				group_len = p->base + p->sectors[j + 1].offset
+						- start;
+			else
+				continue;
+
+			xml_printf(&retval, &xml, &pos, &size,
+				"length=\"0x%x\">\n"
+				"<property name=\"blocksize\">"
+					"0x%x</property>\n"
+				"</memory>\n",
+				group_len,
+				sector_size);
+			sector_size = 0;
+		}
 
-		xml_printf(&retval, &xml, &pos, &size,
-			"<memory type=\"flash\" start=\"0x%x\" "
-				"length=\"0x%x\">\n" \
-			"<property name=\"blocksize\">0x%x</property>\n" \
-			"</memory>\n", \
-			p->base, p->size, blocksize);
 		ram_start = p->base + p->size;
 	}
 

-----------------------------------------------------------------------

Summary of changes:
 src/server/gdb_server.c   |   77 +++++++++++++++++++++++++++------------------
 tcl/board/omap2420_h4.cfg |    6 +--
 tcl/board/osk5912.cfg     |    8 ++--
 3 files changed, 52 insertions(+), 39 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Wed Jan 20 20:07:54 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Wed, 20 Jan 2010 19:07:54 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-134-g2a0c9b0
Message-ID: <E1NXfuG-0002fk-FP@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  2a0c9b08d7ee0c1b0eb5b593d18f68d0c910927d (commit)
      from  22d25e69213c49395ee0d40f6cc1eda935873ed2 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 2a0c9b08d7ee0c1b0eb5b593d18f68d0c910927d
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Wed Jan 20 11:07:42 2010 -0800

    Cortex-M3 vector_catch testing support
    
    The "cm3-ftest.cfg" can be used to verify that OpenOCD handles
    certain faults correctly:
    
     - Test #1: it ignores faults that it wasn't told to catch
     - Test #2: if vector_catch is told to catch, it catches
    
    The "fault.c" generates ASM code to trigger faults, while the
    config script loads and runs pre-compiled code.
    
    This covers most, but not all, of the vector_catch options.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/testing/examples/cortex/cm3-ftest.cfg b/testing/examples/cortex/cm3-ftest.cfg
new file mode 100644
index 0000000..2dae249
--- /dev/null
+++ b/testing/examples/cortex/cm3-ftest.cfg
@@ -0,0 +1,143 @@
+#
+# For each named Cortex-M3 vector_catch flag VECTOR ...
+#		bus_err		state_err
+#		chk_err		nocp_err
+#		mm_err		reset
+#
+# BUT NYET hard_err, int_err (their test cases don't yet work) ...
+#
+# Do the following:
+#
+#  - Test #1:  verify that OpenOCD ignores exceptions by default
+#     + l_VECTOR (loads testcase to RAM)
+#     + fault triggers loop-to-self exception "handler"
+#     + "halt"
+#     + observe fault "handling" -- loop-to-self from load_and_run (below)
+#
+#  - Test #2:  verify that "vector_catch" makes OpenOCD stops ignoring them
+#     + cortex_m3 vector_catch none
+#     + cortex_m3 vector_catch VECTOR
+#     + l_VECTOR (loads testcase to RAM)
+#     + fault triggers vector catch hardware
+#     + observe OpenOCD entering debug state with no assistance
+#
+# NOTE "reset" includes the NVIC, so that test case gets its reset vector
+# from the flash, not from the vector table set up here.  Which means that
+# for that vector_catch option, the Test #1 (above) "observe" step won't
+# use the SRAM address.
+#
+
+# we can fully automate test #2
+proc vector_test {tag} {
+	halt
+	# REVISIT -- annoying, we'd like to scrap vector_catch output
+	cortex_m3 vector_catch none
+	cortex_m3 vector_catch $tag
+	eval "l_$tag"
+}
+
+#
+# Load and start one vector_catch test case.
+#
+# name -- tag for the vector_catch flag being tested
+# halfwords -- array of instructions (some wide, some narrow)
+# n_instr -- how many instructions are in $halfwords
+#
+proc load_and_run { name halfwords n_instr } {
+	reset halt
+
+	# Load code at beginning of SRAM.
+	echo "# code to trigger $name vector"
+	set addr 0x20000000
+
+	# ocd_array2mem should be faster, though we'd need to
+	# compute the resulting $addr ourselves
+	foreach opcode $halfwords {
+		mwh $addr $opcode
+		incr addr 2
+	}
+
+	# create default loop-to-self at $addr ... it serves as
+	# (a) "main loop" on error
+	# (b) handler for all exceptions that get triggered
+	mwh $addr 0xe7fe
+
+	# disassemble, as sanity check and what's-happening trace
+	cortex_m3 disassemble 0x20000000 [expr 1 + $n_instr ]
+
+	# Assume that block of code is at most 16 halfwords long.
+	# Create a basic table of loop-to-self exception handlers.
+	mww 0x20000020 $addr 16
+	# Store its address in VTOR
+	mww 0xe000ed08 0x20000020
+	# Use SHCSR to ensure nothing escalates to a HardFault
+	mww 0xe000ed24 0x00070000
+
+	# now start, trigering the $name vector catch logic
+	resume 0x20000000
+}
+
+#proc l_hard_err {} {
+#	IMPLEMENT ME
+#	FORCED -- escalate something to HardFault
+#}
+
+#proc l_int_err {} {
+#	IMPLEMENT ME
+#	STKERR -- exception stack BusFault
+#}
+
+# BusFault, escalates to HardFault
+proc l_bus_err {} {
+	# PRECISERR -- assume less than 512 MBytes of SRAM
+	load_and_run bus_err {
+		0xf06f 0x4040
+		0x7800
+	} 2
+}
+
+# UsageFault, escalates to HardFault
+proc l_state_err {} {
+	# UNDEFINSTR -- issue architecturally undefined instruction
+	load_and_run state_err {
+		0xde00
+	} 1
+}
+
+# UsageFault, escalates to HardFault
+proc l_chk_err {} {
+	# UNALIGNED -- LDM through unaligned pointer
+	load_and_run chk_err {
+		0xf04f 0x0001
+		0xe890 0x0006
+	} 2
+}
+
+# UsageFault, escalates to HardFault
+proc l_nocp_err {} {
+	# NOCP -- issue cp14 DCC instruction
+	load_and_run nocp_err {
+		0xee10 0x0e15
+	} 1
+}
+
+# MemManage, escalates to HardFault
+proc l_mm_err {} {
+	# IACCVIOL -- instruction fetch from an XN region
+	load_and_run mm_err {
+		0xf04f 0x4060
+		0x4687
+	} 2
+}
+
+proc l_reset {} {
+	# issue SYSRESETREQ via AIRCR
+	load_and_run reset {
+		0xf04f 0x0104
+		0xf2c0 0x51fa
+		0xf44f 0x406d
+		0xf100 0x000c
+		0xf2ce 0x0000
+		0x6001
+	} 6
+}
diff --git a/testing/examples/cortex/fault.c b/testing/examples/cortex/fault.c
new file mode 100644
index 0000000..9a5fe19
--- /dev/null
+++ b/testing/examples/cortex/fault.c
@@ -0,0 +1,152 @@
+/*
+ * COMPILE:  arm-none-eabi-gcc -mthumb -march=armv7-m ...
+ *	... plus, provide at least a default exception vector table.
+ *
+ * RUN:  this is best run from SRAM.  It starts at main() then triggers
+ * a fault before more than a handful of instructions have executed.
+ * Run each test case in two modes:
+ *
+ * (1)	Faults caught on the Cortex-M3.  Default handlers are usually
+ *	loop-to-self NOPs, so a debugger won't notice faults until they
+ *	halt the core and examine xSPR and other registers.
+ *
+ *	To verify the fault triggered, issue "halt" from OpenOCD; you
+ *	should be told about the fault and (some of) its details.
+ *	Then it's time to run the next test.
+ *
+ *	NOTE however that "reset" will restart everything; verify that
+ *	case by observing your reset handler doing its normal work.
+ *
+ * (2)	Faults intercepted by OpenOCD "vector_catch ..." commands.
+ *
+ *	OpenOCD should tell you about the fault, and show the same
+ *	details, without your "halt" command.
+ *
+ * Someday, a fancy version of this code could provide a vector table and
+ * fault handlers which use semihosting (when that works on Cortex-M3) to
+ * report what happened, again without needing a "halt" command.
+ */
+
+
+/* These symbols match the OpenOCD "cortex_m3 vector_catch" bit names. */
+enum vc_case {
+	hard_err,
+	int_err,
+	bus_err,
+	state_err,
+	chk_err,
+	nocp_err,
+	mm_err,
+	reset,
+};
+
+/* REVISIT come up with a way to avoid recompiling, maybe:
+ *  - write it in RAM before starting
+ *  - compiled-in BKPT, manual patch of r0, then resume
+ *  - ...
+ */
+
+#ifndef VC_ID
+#warning "no VC_ID ... using reset"
+#define VC_ID reset
+#endif
+
+int main(void) __attribute__ ((externally_visible, noreturn));
+
+/*
+ * Trigger various Cortex-M3 faults to verify that OpenOCD behaves OK
+ * in terms of its vector_catch handling.
+ *
+ * Fault handling should be left entirely up to the application code
+ * UNLESS a "vector_catch" command tells OpenOCD to intercept a fault.
+ *
+ * See ARMv7-M architecure spec table B1-9 for the list of faults and
+ * their mappings to the vector catch bits.
+ */
+int main(void)
+{
+	/* One test case for each vector catch bit.  We're not doing
+	 * hardware testing; so it doesn't matter when some DEMCR bits
+	 * could apply in multiple ways.
+	 */
+	switch (VC_ID) {
+
+	/* "cortex_m3 vector_catch hard_err" */
+	case hard_err:
+		/* FORCED - Fault escalation */
+
+		/* FIXME code this */
+		break;
+
+	/* "cortex_m3 vector_catch int_err" */
+	case int_err:
+		/* STKERR -- Exception stack BusFault */
+
+		/* FIXME code this */
+		break;
+
+	/* "cortex_m3 vector_catch bus_err" */
+	case bus_err:
+		/* PRECISERR -- precise data bus read
+		 * Here we assume a Cortex-M3 with 512 MBytes SRAM is very
+		 * unlikely, so the last SRAM byte isn't a valid address.
+		 */
+		__asm__ volatile(
+			"mov r0, #0x3fffffff\n"
+			"ldrb r0, [r0]\n"
+			);
+		break;
+
+	/* "cortex_m3 vector_catch state_err" */
+	case state_err:
+		/* UNDEFINSTR -- architectural undefined instruction */
+		__asm__ volatile(".hword 0xde00");
+		break;
+
+	/* "cortex_m3 vector_catch chk_err" */
+	case chk_err:
+		/* UNALIGNED ldm */
+		__asm__ volatile(
+			"mov r0, #1\n"
+			"ldm r0, {r1, r2}\n"
+			);
+		break;
+
+	/* "cortex_m3 vector_catch nocp_err" */
+	case nocp_err:
+		/* NOCP ... Cortex-M3 has no coprocessors (like CP14 DCC),
+		 * but these instructions are allowed by ARMv7-M.
+		 */
+		__asm__ volatile("mrc p14, 0, r0, c0, c5, 0");
+		break;
+
+	/* "cortex_m3 vector_catch mm_err" */
+	case mm_err:
+		/* IACCVIOL -- instruction fetch from an XN region */
+		__asm__ volatile(
+			"mov r0, #0xe0000000\n"
+			"mov pc, r0\n"
+			);
+		break;
+
+	/* "cortex_m3 vector_catch reset" */
+	case reset:
+		__asm__ volatile(
+			/* r1 = SYSRESETREQ */
+			"mov r1, #0x0004\n"
+			/* r1 |= VECTKEY */
+			"movt r1, #0x05fa\n"
+			/* r0 = &AIRCR */
+			"mov r0, #0xed00\n"
+			"add r0, #0xc\n"
+			"movt r0, #0xe000\n"
+			/* AIRCR = ... */
+			"str r1, [r0, #0]\n"
+			);
+		break;
+	}
+
+	/* don't return */
+	while (1)
+		continue;
+}

-----------------------------------------------------------------------

Summary of changes:
 testing/examples/cortex/cm3-ftest.cfg |  143 +++++++++++++++++++++++++++++++
 testing/examples/cortex/fault.c       |  152 +++++++++++++++++++++++++++++++++
 2 files changed, 295 insertions(+), 0 deletions(-)
 create mode 100644 testing/examples/cortex/cm3-ftest.cfg
 create mode 100644 testing/examples/cortex/fault.c


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Thu Jan 21 00:11:51 2010
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Wed, 20 Jan 2010 23:11:51 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-135-gdbecb13
Message-ID: <E1NXjiL-0002DU-Dn@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  dbecb13b240867e12e43dba032a45891000bffe9 (commit)
      from  2a0c9b08d7ee0c1b0eb5b593d18f68d0c910927d (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit dbecb13b240867e12e43dba032a45891000bffe9
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Wed Jan 20 23:09:20 2010 +0000

    BUILD: remove cygwin gcc 3.4.4 build warnings
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index 762e318..adce4d9 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -1675,8 +1675,8 @@ static int cortex_m3_examine(struct target *target)
 			return retval;
 
 		if (((cpuid >> 4) & 0xc3f) == 0xc23)
-			LOG_DEBUG("Cortex-M3 r%dp%d processor detected",
-				(cpuid >> 20) & 0xf, (cpuid >> 0) & 0xf);
+			LOG_DEBUG("Cortex-M3 r%" PRId8 "p%" PRId8 " processor detected",
+				(uint8_t)((cpuid >> 20) & 0xf), (uint8_t)((cpuid >> 0) & 0xf));
 		LOG_DEBUG("cpuid: 0x%8.8" PRIx32 "", cpuid);
 
 		/* NOTE: FPB and DWT are both optional. */
diff --git a/src/target/mips32_pracc.c b/src/target/mips32_pracc.c
index 11d5a43..7d91d42 100644
--- a/src/target/mips32_pracc.c
+++ b/src/target/mips32_pracc.c
@@ -968,7 +968,7 @@ int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_are
 	/* write program into RAM */
 	mips32_pracc_write_mem32(ejtag_info, source->address, ARRAY_SIZE(handler_code), handler_code);
 
-	LOG_DEBUG("%s using 0x%.8x for write handler\n", __func__, source->address);
+	LOG_DEBUG("%s using 0x%.8" PRIx32 " for write handler\n", __func__, source->address);
 
 	jmp_code[1] |= UPPER16(source->address);
 	jmp_code[2] |= LOWER16(source->address);
diff --git a/src/target/mips_m4k.c b/src/target/mips_m4k.c
index 1a65c50..5f5aa72 100644
--- a/src/target/mips_m4k.c
+++ b/src/target/mips_m4k.c
@@ -981,7 +981,7 @@ int mips_m4k_bulk_write_memory(struct target *target, uint32_t address, uint32_t
 	int retval;
 	int write = 1;
 
-	LOG_DEBUG("address: 0x%8.8x, count: 0x%8.8x", address, count);
+	LOG_DEBUG("address: 0x%8.8" PRIx32 ", count: 0x%8.8" PRIx32 "", address, count);
 
 	if (target->state != TARGET_HALTED)
 	{

-----------------------------------------------------------------------

Summary of changes:
 src/target/cortex_m3.c    |    4 ++--
 src/target/mips32_pracc.c |    2 +-
 src/target/mips_m4k.c     |    2 +-
 3 files changed, 4 insertions(+), 4 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Thu Jan 21 08:22:21 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Thu, 21 Jan 2010 07:22:21 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-136-g60cb5bd
Message-ID: <E1NXrN2-0006qr-4a@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  60cb5bdd30ec3265cbb5c1c667f5c98cbbb84aab (commit)
      from  dbecb13b240867e12e43dba032a45891000bffe9 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 60cb5bdd30ec3265cbb5c1c667f5c98cbbb84aab
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Thu Jan 21 08:11:39 2010 +0100

    ecos: add missing PRId8 definition
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/helper/types.h b/src/helper/types.h
index 03ab5f0..1010dcd 100644
--- a/src/helper/types.h
+++ b/src/helper/types.h
@@ -172,6 +172,7 @@ static inline void h_u16_to_be(uint8_t* buf, int val)
 #define SCNx32 "x"
 #define PRIi32 "i"
 #define PRIu32 "u"
+#define PRId8 PRId32
 
 typedef CYG_ADDRWORD intptr_t;
 typedef int64_t intmax_t;

-----------------------------------------------------------------------

Summary of changes:
 src/helper/types.h |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Thu Jan 21 15:57:41 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Thu, 21 Jan 2010 14:57:41 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-137-g1350b6a
Message-ID: <E1NXyTf-0006Ve-TF@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  1350b6aad074c1556604c5969dee43f294371461 (commit)
      from  60cb5bdd30ec3265cbb5c1c667f5c98cbbb84aab (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 1350b6aad074c1556604c5969dee43f294371461
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Wed Jan 20 23:36:57 2010 +0100

    gdb_server: handle stepi/continue packet while target is running with more grace
    
    Rather than issuing a halt and then stepi/resume, just
    wait for target to halt.
    
    Issue a sterner warning via gdb console that any gdb
    register changes will be ignored in this case.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index f3e0575..17ca439 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -2212,12 +2212,13 @@ static int gdb_input_inner(struct connection *connection)
 						log_add_callback(gdb_log_callback, connection);
 
 						bool nostep = false;
+						bool already_running = false;
 						if (target->state == TARGET_RUNNING)
 						{
-							LOG_WARNING("The target is already running. Halt target before stepi/continue.");
-							retval = target_halt(target);
-							if (retval == ERROR_OK)
-								retval = target_wait_state(target, TARGET_HALTED, 100);
+							LOG_WARNING("WARNING! The target is already running. "
+									"All changes GDB did to registers will be discarded! "
+									"Waiting for target to halt.");
+							already_running = true;
 						} else if (target->state != TARGET_HALTED)
 						{
 							LOG_WARNING("The target is not in the halted nor running stated, stepi/continue ignored.");
@@ -2233,7 +2234,7 @@ static int gdb_input_inner(struct connection *connection)
 						}
 						gdb_con->sync = false;
 
-						if ((retval!=ERROR_OK) || nostep)
+						if ((retval!=ERROR_OK) || (!already_running && nostep))
 						{
 							/* Either the target isn't in the halted state, then we can't
 							 * step/continue. This might be early setup, etc.
@@ -2253,11 +2254,15 @@ static int gdb_input_inner(struct connection *connection)
 							 */
 							gdb_con->frontend_state = TARGET_RUNNING;
 							target_call_event_callbacks(target, TARGET_EVENT_GDB_START);
-							int retval = gdb_step_continue_packet(connection, target, packet, packet_size);
-							if (retval != ERROR_OK)
+
+							if (!already_running)
 							{
-								/* we'll never receive a halted condition... issue a false one.. */
-								gdb_frontend_halted(target, connection);
+								int retval = gdb_step_continue_packet(connection, target, packet, packet_size);
+								if (retval != ERROR_OK)
+								{
+									/* we'll never receive a halted condition... issue a false one.. */
+									gdb_frontend_halted(target, connection);
+								}
 							}
 						}
 					}

-----------------------------------------------------------------------

Summary of changes:
 src/server/gdb_server.c |   23 ++++++++++++++---------
 1 files changed, 14 insertions(+), 9 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Thu Jan 21 15:59:17 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Thu, 21 Jan 2010 14:59:17 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-139-gdfba7fa
Message-ID: <E1NXyVD-0005u7-27@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  dfba7fa949ae12089aa02dab557a46520c816d28 (commit)
       via  bc088b302bd0bb43cc9097a9f0b2e7369b0e04e2 (commit)
      from  1350b6aad074c1556604c5969dee43f294371461 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit dfba7fa949ae12089aa02dab557a46520c816d28
Author: Edgar Grimberg <edgar.grimberg at zylin.com>
Date:   Thu Jan 21 12:08:19 2010 +0100

    interface: Changed parport address to LPT1
    
    Changed the parport address to LPT1, since it's the most obvious default value.
    
    Signed-off-by: Edgar Grimberg <edgar.grimberg at zylin.com>

diff --git a/tcl/interface/parport.cfg b/tcl/interface/parport.cfg
index 22be8f3..0f18ce9 100644
--- a/tcl/interface/parport.cfg
+++ b/tcl/interface/parport.cfg
@@ -1,10 +1,8 @@
 #
-# Parallel port wiggler (many clones available) on port 0xc8b8
+# Parallel port wiggler (many clones available) on port 0x378
 #
-# REVISIT this address seems very wrong.
-# Surely 0x378/LPT1 or 0x278/LPT2 ...
+# Addresses: 0x378/LPT1 or 0x278/LPT2 ...
 
 interface parport
-parport_port 0xc8b8
+parport_port 0x378
 parport_cable wiggler
-

commit bc088b302bd0bb43cc9097a9f0b2e7369b0e04e2
Author: Edgar Grimberg <edgar.grimberg at zylin.com>
Date:   Thu Jan 21 13:42:25 2010 +0100

    target: Fixed format problem for mdh
    
    Fixed format problem for mdh. It needs to display 4 chars.
    
    Signed-off-by: Edgar Grimberg <edgar.grimberg at zylin.com>

diff --git a/src/target/target.c b/src/target/target.c
index c56265c..ff5aef3 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -2170,7 +2170,7 @@ static void handle_md_output(struct command_context *cmd_ctx,
 	const char *value_fmt;
 	switch (size) {
 	case 4: value_fmt = "%8.8x "; break;
-	case 2: value_fmt = "%4.2x "; break;
+	case 2: value_fmt = "%4.4x "; break;
 	case 1: value_fmt = "%2.2x "; break;
 	default:
 		/* "can't happen", caller checked */

-----------------------------------------------------------------------

Summary of changes:
 src/target/target.c       |    2 +-
 tcl/interface/parport.cfg |    8 +++-----
 2 files changed, 4 insertions(+), 6 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Thu Jan 21 16:22:30 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Thu, 21 Jan 2010 15:22:30 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-140-g98f7c21
Message-ID: <E1NXyrf-0005LB-3X@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  98f7c2127b8800e2597493eea2c7ba5c88940b86 (commit)
      from  dfba7fa949ae12089aa02dab557a46520c816d28 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 98f7c2127b8800e2597493eea2c7ba5c88940b86
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Thu Jan 21 10:16:42 2010 +0100

    target: print reason why GDB halts
    
    If GDB halts unexpectedly, print reason: srst assert or power
    out detected.
    
    If polling fails, then things are a bit trickier. We do not
    want to spam telnet or the log with polling failed messages.
    Leave that case be w/a comment in a code for now.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/target.c b/src/target/target.c
index ff5aef3..1eb65a6 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -1767,6 +1767,7 @@ static int handle_target(void *priv)
 		int did_something = 0;
 		if (runSrstAsserted)
 		{
+			LOG_INFO("Waking up GDB, srst asserted detected.");
 			target_call_event_callbacks_all(TARGET_EVENT_GDB_HALT);
 			Jim_Eval(interp, "srst_asserted");
 			did_something = 1;
@@ -1778,6 +1779,7 @@ static int handle_target(void *priv)
 		}
 		if (runPowerDropout)
 		{
+			LOG_INFO("Waking up GDB, power dropout detected.");
 			target_call_event_callbacks_all(TARGET_EVENT_GDB_HALT);
 			Jim_Eval(interp, "power_dropout");
 			did_something = 1;
@@ -1820,6 +1822,14 @@ static int handle_target(void *priv)
 			/* polling may fail silently until the target has been examined */
 			if ((retval = target_poll(target)) != ERROR_OK)
 			{
+				/* FIX!!!!! If we add a LOG_INFO() here to output a line in GDB
+				 * *why* we are aborting GDB, then we'll spam telnet when the
+				 * poll is failing persistently.
+				 *
+				 * If we could implement an event that detected the
+				 * target going from non-pollable to pollable, we could issue
+				 * an error only upon the transition.
+				 */
 				target_call_event_callbacks(target, TARGET_EVENT_GDB_HALT);
 				return retval;
 			}

-----------------------------------------------------------------------

Summary of changes:
 src/target/target.c |   10 ++++++++++
 1 files changed, 10 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Fri Jan 22 02:03:56 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Fri, 22 Jan 2010 01:03:56 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-143-g4960c90
Message-ID: <E1NY7wL-0003wx-EL@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  4960c9018f2560b11ede91cde8a68dc56c690159 (commit)
       via  08b0be94b5fd13a8afe4f070bc7b471cc5c3423d (commit)
       via  f06148612be714f74174bb86fe95f49df07c32fa (commit)
      from  98f7c2127b8800e2597493eea2c7ba5c88940b86 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 4960c9018f2560b11ede91cde8a68dc56c690159
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 21 16:45:00 2010 -0800

    Various doc/comment updates
    
    Doxygen: don't be needlessly verbose; alphabetically sort members
    TODO: add random bits; clarify which manuals are referenced
    ARM disassembler: mention a few opcodes that still aren't handled
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/Doxyfile.in b/Doxyfile.in
index f6e3ced..658f667 100644
--- a/Doxyfile.in
+++ b/Doxyfile.in
@@ -384,7 +384,7 @@ HIDE_SCOPE_NAMES       = NO
 # will put a list of the files that are included by a file in the documentation
 # of that file.
 
-SHOW_INCLUDE_FILES     = YES
+SHOW_INCLUDE_FILES     = NO
 
 # If the INLINE_INFO tag is set to YES (the default) then a tag [inline]
 # is inserted in the documentation for inline members.
@@ -403,7 +403,7 @@ SORT_MEMBER_DOCS       = YES
 # by member name. If set to NO (the default) the members will appear in
 # declaration order.
 
-SORT_BRIEF_DOCS        = NO
+SORT_BRIEF_DOCS        = YES
 
 # If the SORT_GROUP_NAMES tag is set to YES then doxygen will sort the
 # hierarchy of group names into alphabetical order. If set to NO (the default)
@@ -692,13 +692,13 @@ SOURCE_BROWSER         = YES
 # Setting the INLINE_SOURCES tag to YES will include the body
 # of functions and classes directly in the documentation.
 
-INLINE_SOURCES         = YES
+INLINE_SOURCES         = NO
 
 # Setting the STRIP_CODE_COMMENTS tag to YES (the default) will instruct
 # doxygen to hide any special comment blocks from generated source code
 # fragments. Normal C and C++ comments will always remain visible.
 
-STRIP_CODE_COMMENTS    = NO
+STRIP_CODE_COMMENTS    = YES
 
 # If the REFERENCED_BY_RELATION tag is set to YES 
 # then for each documented function all documented
diff --git a/TODO b/TODO
index 41d3457..aa2277c 100644
--- a/TODO
+++ b/TODO
@@ -142,6 +142,8 @@ Once the above are completed:
   https://lists.berlios.de/pipermail/openocd-development/2009-May/006590.html
 - regression: "reset halt" between 729(works) and 788(fails): @par
 https://lists.berlios.de/pipermail/openocd-development/2009-July/009206.html
+- registers
+  - add flush-value operation, call them all on resume/reset
 - mcr/mrc target->type support
   - missing from ARM920t, ARM966e, XScale.
   It's possible that the current syntax is unable to support read-modify-write
@@ -170,10 +172,18 @@ https://lists.berlios.de/pipermail/openocd-development/2009-October/011506.html
 - Thumb2 single stepping: ARM1156T2 needs simulator support
 - Cortex A8 support (ML)
   - add target implementation (ML)
+- Cortex M3 support
+  - when stepping, only write dirtied registers (be faster)
+  - when connecting to halted core, fetch registers (startup is quirky)
 - Generic ARM run_algorithm() interface
   - tagged struct wrapping ARM instructions and metadata
   - not revision-specific (current: ARMv4+ARMv5 -or- ARMv6 -or- ARMv7)
   - usable with at least arm_nandwrite() and generic CFI drivers
+- ETM
+  - don't show FIFOFULL registers if they're not supported
+  - use comparators to get more breakpoints and watchpoints
+  - add "etm drivers" command
+  - trace driver init() via examine() paths only, not setup()/reset
 - MC1322x support (JW/DE?)
   - integrate and test support from JW (and DE?)
   - get working with a known good interface (i.e. not today's jlink)
@@ -356,9 +366,11 @@ to complete:
 - Develop milestone and release guidelines, processes, and scripts.
 - Develop "style" guidelines (and scripts) for maintainers:
   - reviewing patches
-  - committing to Subversion
-- Review The Guide for OpenOCD Users for documentation errors or omissions
-- Update The Manual for OpenOCD Developers:
+  - committing to git
+- Review Users' Guide for documentation errors or omissions
+  - "capture" and "ocd_find" commands
+  - "ocd_" prefix on various stuff
+- Update Developer's Manual (doxygen output)
   - Add documentation describing the architecture of each module
   - Provide more Technical Primers to bootstrap contributor knowledge
 
diff --git a/src/target/arm_disassembler.c b/src/target/arm_disassembler.c
index 587131b..f02053f 100644
--- a/src/target/arm_disassembler.c
+++ b/src/target/arm_disassembler.c
@@ -50,6 +50,7 @@
  *       except as coprocessor 10/11 operations
  *     * Most ARM instructions through ARMv6 are decoded, but some
  *       of the post-ARMv4 opcodes may not be handled yet
+ *		CPS, SDIV, UDIV, LDREX*, STREX*, QASX, ...
  *     * NEON instructions are not understood (ARMv7-A)
  *
  *  - Thumb/Thumb2 decoding

commit 08b0be94b5fd13a8afe4f070bc7b471cc5c3423d
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 21 16:15:41 2010 -0800

    User's Guide secton on target hardware setup
    
    Highlight the needs to properly jumper development boards; to
    make the OpenOCD configuration match the jumpering; and to have
    a usable "reset-init" method when debugging early boot code.
    
    Specific mention of the "ATX Mode" that seems useful on
    many i.MX boards, forcing NAND boot.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 05b6f4e..ee5c723 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -23,7 +23,7 @@ of the Open On-Chip Debugger (OpenOCD).
 @item Copyright @copyright{} 2007-2008 Spencer Oliver @email{spen@@spen-soft.co.uk}
 @item Copyright @copyright{} 2008 Oyvind Harboe @email{oyvind.harboe@@zylin.com}
 @item Copyright @copyright{} 2008 Duane Ellis @email{openocd@@duaneellis.com}
- at item Copyright @copyright{} 2009 David Brownell
+ at item Copyright @copyright{} 2009-2010 David Brownell
 @end itemize
 
 @quotation
@@ -1027,6 +1027,86 @@ various kinds of message.
 
 @end itemize
 
+ at section Target Hardware Setup
+
+Chip vendors often provide software development boards which
+are highly configurable, so that they can support all options
+that product boards may require.  @emph{Make sure that any
+jumpers or switches match the system configuration you are
+working with.}
+
+Common issues include:
+
+ at itemize @bullet
+
+ at item @b{JTAG setup} ...
+Boards may support more than one JTAG configuration.
+Examples include jumpers controlling pullups versus pulldowns
+on the nTRST and/or nSRST signals, and choice of connectors
+(e.g. which of two headers on the base board,
+or one from a daughtercard).
+For some Texas Instruments boards, you may need to jumper the
+EMU0 and EMU1 signals (which OpenOCD won't currently control).
+
+ at item @b{Boot Modes} ...
+Complex chips often support multiple boot modes, controlled
+by external jumpers.  Make sure this is set up correctly.
+For example many i.MX boards from NXP need to be jumpered
+to "ATX mode" to start booting using the on-chip ROM, when
+using second stage bootloader code stored in a NAND flash chip.
+
+Such explicit configuration is common, and not limited to
+booting from NAND.  You might also need to set jumpers to
+start booting using code loaded from an MMC/SD card; external
+SPI flash; Ethernet, UART, or USB links; NOR flash; OneNAND
+flash; some external host; or various other sources.
+
+
+ at item @b{Memory Addressing} ...
+Boards which support multiple boot modes may also have jumpers
+to configure memory addressing.  One board, for example, jumpers
+external chipselect 0 (used for booting) to address either
+a large SRAM (which must be pre-loaded via JTAG), NOR flash,
+or NAND flash.  When it's jumpered to address NAND flash, that
+board must also be told to start booting from on-chip ROM.
+
+Your @file{board.cfg} file may also need to be told this jumper
+configuration, so that it can know whether to declare NOR flash
+using @command{flash bank} or instead declare NAND flash with
+ at command{nand device}; and likewise which probe to perform in
+its @code{reset-init} handler.
+
+A closely related issue is bus width.  Jumpers might need to
+distinguish between 8 bit or 16 bit bus access for the flash
+used to start booting.
+
+ at item @b{Peripheral Access} ...
+Development boards generally provide access to every peripheral
+on the chip, sometimes in multiple modes (such as by providing
+multiple audio codec chips).
+This interacts with software
+configuration of pin multiplexing, where for example a
+given pin may be routed either to the MMC/SD controller
+or the GPIO controller.  It also often interacts with
+configuration jumpers.  One jumper may be used to route
+signals to an MMC/SD card slot or an expansion bus (which
+might in turn affect booting); others might control which
+audio or video codecs are used.
+
+ at end itemize
+
+Plus you should of course have @code{reset-init} event handlers
+which set up the hardware to match that jumper configuration.
+That includes in particular any oscillator or PLL used to clock
+the CPU, and any memory controllers needed to access external
+memory and peripherals.  Without such handlers, you won't be
+able to access those resources without working target firmware
+which can do that setup ... this can be awkward when you're
+trying to debug that target firmware.  Even if there's a ROM
+bootloader which handles a few issues, it rarely provides full
+access to all board-specific capabilities.
+
+
 @node Config File Guidelines
 @chapter Config File Guidelines
 

commit f06148612be714f74174bb86fe95f49df07c32fa
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 21 13:39:22 2010 -0800

    ADIv5 header cleanup (+ #defines)
    
    Update the comments about DP registers and some of the bitfields.
    Remove inappropriate (and unused) DP_ZERO declaration.
    
    Add some (currently unused) #defines needed for SWD protocol support,
    based on previous patches from Andreas Fritiofson and Simon Qian.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_adi_v5.h b/src/target/arm_adi_v5.h
index 675a173..861a13d 100644
--- a/src/target/arm_adi_v5.h
+++ b/src/target/arm_adi_v5.h
@@ -42,22 +42,42 @@
 #define JTAG_ACK_OK_FAULT	0x2
 #define JTAG_ACK_WAIT		0x1
 
+/* three-bit ACK values for SWD access (sent LSB first) */
+#define SWD_ACK_OK		0x4
+#define SWD_ACK_WAIT		0x2
+#define SWD_ACK_FAULT		0x1
+
 #define DPAP_WRITE		0
 #define DPAP_READ		1
 
-/* A[3:0] for DP registers (for JTAG, stored in DPACC) */
-#define DP_ZERO			0
-#define DP_CTRL_STAT	0x4
-#define DP_SELECT		0x8
-#define DP_RDBUFF		0xC
+/* A[3:0] for DP registers; A[1:0] are always zero.
+ * - JTAG accesses all of these via JTAG_DP_DPACC, except for
+ *   IDCODE (JTAG_DP_IDCODE) and ABORT (JTAG_DP_ABORT).
+ * - SWD accesses these directly, sometimes needing SELECT.CTRLSEL
+ */
+#define DP_IDCODE		0		/* SWD: read */
+#define DP_ABORT		0		/* SWD: write */
+#define DP_CTRL_STAT		0x4		/* r/w */
+#define DP_WCR			0x4		/* SWD: r/w (mux CTRLSEL) */
+#define DP_RESEND		0x8		/* SWD: read */
+#define DP_SELECT		0x8		/* JTAG: r/w; SWD: write */
+#define DP_RDBUFF		0xC		/* read-only */
+
+/* Fields of the DP's AP ABORT register */
+#define DAPABORT		(1 << 0)
+#define STKCMPCLR		(1 << 1)	/* SWD-only */
+#define STKERRCLR		(1 << 2)	/* SWD-only */
+#define WDERRCLR		(1 << 3)	/* SWD-only */
+#define ORUNERRCLR		(1 << 4)	/* SWD-only */
 
 /* Fields of the DP's CTRL/STAT register */
 #define CORUNDETECT		(1 << 0)
 #define SSTICKYORUN		(1 << 1)
 /* 3:2 - transaction mode (e.g. pushed compare) */
+#define SSTICKYCMP		(1 << 4)
 #define SSTICKYERR		(1 << 5)
-#define READOK			(1 << 6)
-#define WDATAERR		(1 << 7)
+#define READOK			(1 << 6)	/* SWD-only */
+#define WDATAERR		(1 << 7)	/* SWD-only */
 /* 11:8 - mask lanes for pushed compare or verify ops */
 /* 21:12 - transaction counter */
 #define CDBGRSTREQ		(1 << 26)

-----------------------------------------------------------------------

Summary of changes:
 Doxyfile.in                   |    8 ++--
 TODO                          |   18 +++++++-
 doc/openocd.texi              |   82 ++++++++++++++++++++++++++++++++++++++++-
 src/target/arm_adi_v5.h       |   34 +++++++++++++---
 src/target/arm_disassembler.c |    1 +
 5 files changed, 128 insertions(+), 15 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sat Jan 23 07:37:24 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sat, 23 Jan 2010 06:37:24 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-144-gb7fa16e
Message-ID: <E1NYZcb-0004hH-Js@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  b7fa16eeacb368dca8862168088bc6c491f0ffb1 (commit)
      from  4960c9018f2560b11ede91cde8a68dc56c690159 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit b7fa16eeacb368dca8862168088bc6c491f0ffb1
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 22 22:37:15 2010 -0800

    ARM11: fix breakpoints with GDB
    
    This fixes a bug whereby GDB's breakpoints weren't activated.
    The root cause is a confused interface to resume().  Fix by
    almost ignoring the "handle breakpoints" parameter; it only
    seems related to the case of skipping breakpoint-at-PC.
    
    Update a few coments to clarify what's happening.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm11.c b/src/target/arm11.c
index 082930a..8b7b69c 100644
--- a/src/target/arm11.c
+++ b/src/target/arm11.c
@@ -498,12 +498,9 @@ static int arm11_resume(struct target *target, int current,
 	if (!debug_execution)
 		target_free_all_working_areas(target);
 
-	/* Set up breakpoints */
-	if (handle_breakpoints)
-	{
-		/* check if one matches PC and step over it if necessary */
-
-		struct breakpoint *	bp;
+	/* Should we skip over breakpoints matching the PC? */
+	if (handle_breakpoints) {
+		struct breakpoint *bp;
 
 		for (bp = target->breakpoints; bp; bp = bp->next)
 		{
@@ -514,9 +511,11 @@ static int arm11_resume(struct target *target, int current,
 				break;
 			}
 		}
+	}
 
-		/* set all breakpoints */
-
+	/* activate all breakpoints */
+	if (true) {
+		struct breakpoint *bp;
 		unsigned brp_num = 0;
 
 		for (bp = target->breakpoints; bp; bp = bp->next)
@@ -542,7 +541,8 @@ static int arm11_resume(struct target *target, int current,
 			arm11_sc7_set_vcr(arm11, arm11_vcr);
 	}
 
-	arm11_leave_debug_state(arm11, handle_breakpoints);
+	/* activate all watchpoints and breakpoints */
+	arm11_leave_debug_state(arm11, true);
 
 	arm11_add_IR(arm11, ARM11_RESTART, TAP_IDLE);
 
@@ -953,6 +953,7 @@ static int arm11_write_memory_inner(struct target *target,
 	if (retval != ERROR_OK)
 		return retval;
 
+	/* load r0 with buffer address */
 	/* MRC p14,0,r0,c0,c5,0 */
 	retval = arm11_run_instr_data_to_core1(arm11, 0xee100e15, address);
 	if (retval != ERROR_OK)
@@ -975,11 +976,13 @@ static int arm11_write_memory_inner(struct target *target,
 
 			for (size_t i = 0; i < count; i++)
 			{
+				/* load r1 from DCC with byte data */
 				/* MRC p14,0,r1,c0,c5,0 */
 				retval = arm11_run_instr_data_to_core1(arm11, 0xee101e15, *buffer++);
 				if (retval != ERROR_OK)
 					return retval;
 
+				/* write r1 to memory */
 				/* strb    r1, [r0], #1 */
 				/* strb    r1, [r0] */
 				retval = arm11_run_instr_no_data1(arm11,
@@ -1002,11 +1005,13 @@ static int arm11_write_memory_inner(struct target *target,
 				uint16_t value;
 				memcpy(&value, buffer + i * sizeof(uint16_t), sizeof(uint16_t));
 
+				/* load r1 from DCC with halfword data */
 				/* MRC p14,0,r1,c0,c5,0 */
 				retval = arm11_run_instr_data_to_core1(arm11, 0xee101e15, value);
 				if (retval != ERROR_OK)
 					return retval;
 
+				/* write r1 to memory */
 				/* strh    r1, [r0], #2 */
 				/* strh    r1, [r0] */
 				retval = arm11_run_instr_no_data1(arm11,
@@ -1021,6 +1026,7 @@ static int arm11_write_memory_inner(struct target *target,
 		}
 
 	case 4: {
+		/* stream word data through DCC directly to memory */
 		/* increment:		STC p14,c5,[R0],#4 */
 		/* no increment:	STC p14,c5,[R0]*/
 		uint32_t instr = !no_increment ? 0xeca05e01 : 0xed805e00;

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm11.c |   24 +++++++++++++++---------
 1 files changed, 15 insertions(+), 9 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sat Jan 23 07:52:32 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sat, 23 Jan 2010 06:52:32 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-145-g82c3c47
Message-ID: <E1NYZrG-0003UP-Nc@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  82c3c47825b25012fef60df0a8a89110337cd40d (commit)
      from  b7fa16eeacb368dca8862168088bc6c491f0ffb1 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 82c3c47825b25012fef60df0a8a89110337cd40d
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 22 22:49:42 2010 -0800

    NEWS updates
    
    Summarize most ARM11 and Cortex-A8 updates as "acting much more
    like other ARMs", and mention code sharing.
    
    Clarify a few other points, including support for "reset-assert"
    on all ARMs except Cortex-M (which doesn't exactly need it).
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/NEWS b/NEWS
index c4abd13..f7bf1d3 100644
--- a/NEWS
+++ b/NEWS
@@ -13,25 +13,29 @@ Target Layer:
 	General
 		- new "reset-assert" event, for systems without SRST
 	ARM
+		- supports "reset-assert" event (except on Cortex-M3)
 		- renamed "armv4_5" command prefix as "arm"
 		- recognize TrustZone "Secure Monitor" mode
 		- "arm regs" command output changed
 		- register names use "sp" not "r13"
 		- add top-level "mcr" and "mrc" commands, replacing
 		  various core-specific operations
-		- basic semihosting support
+		- basic semihosting support (ARM7/ARM9 only, for now)
 	ARM11
-		- Preliminary ETM and ETB hookup
-		- accelerated "flash erase_check"
-		- accelerated GDB memory checksum
-		- support "arm regs" command
-		- can access all core modes and registers
-		- watchpoint support
+		- Should act much more like other ARM cores:
+		   * Preliminary ETM and ETB hookup
+		   * accelerated "flash erase_check"
+		   * accelerated GDB memory checksum
+		   * support "arm regs" command
+		   * can access all core modes and registers
+		   * watchpoint support
+		- Shares some core debug code with Cortex-A8
 	Cortex-A8
-		- support "arm regs" command
-		- can access all core modes and registers
-		- supports "reset-assert" event (used on OMAP3530)
-		- watchpoint support
+		- Should act much more like other ARM cores:
+		   * support "arm regs" command
+		   * can access all core modes and registers
+		   * watchpoint support
+		- Shares some core debug code with ARM11
 	Cortex-M3
 		- Exposed DWT registers like cycle counter
 		- vector_catch settings not clobbered by resets

-----------------------------------------------------------------------

Summary of changes:
 NEWS |   26 +++++++++++++++-----------
 1 files changed, 15 insertions(+), 11 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sat Jan 23 07:57:18 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sat, 23 Jan 2010 06:57:18 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-146-g718ee76
Message-ID: <E1NYZvr-0005hB-Gy@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  718ee762e7d6a81037670612a2f3d21da4784f56 (commit)
      from  82c3c47825b25012fef60df0a8a89110337cd40d (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 718ee762e7d6a81037670612a2f3d21da4784f56
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 22 22:54:39 2010 -0800

    EmbeddedICE - fix Feroceon/Dragonite message
    
    The breakpoint/watchpoint message was wrong for Feroceon and
    Dragonite, which have only one working watchpoint unit.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/embeddedice.c b/src/target/embeddedice.c
index a705d7d..bf22036 100644
--- a/src/target/embeddedice.c
+++ b/src/target/embeddedice.c
@@ -192,6 +192,11 @@ embeddedice_build_reg_cache(struct target *target, struct arm7_9_common *arm7_9)
 	reg_cache->reg_list = reg_list;
 	reg_cache->num_regs = num_regs;
 
+	/* FIXME the second watchpoint unit on Feroceon and Dragonite
+	 * seems not to work ... we should have a way to not set up
+	 * its four registers here!
+	 */
+
 	/* set up registers */
 	for (i = 0; i < num_regs; i++)
 	{
@@ -290,8 +295,10 @@ embeddedice_build_reg_cache(struct target *target, struct arm7_9_common *arm7_9)
 				buf_get_u32(reg_list[EICE_COMMS_CTRL].value, 0, 32));
 	}
 
-	LOG_INFO("%s: hardware has 2 breakpoints or watchpoints",
-			target_name(target));
+	/* On Feroceon and Dragonite the second unit is seemingly missing. */
+	LOG_INFO("%s: hardware has %d breakpoint/watchpoint unit%s",
+			target_name(target), arm7_9->wp_available_max,
+			(arm7_9->wp_available_max != 1) ? "s" : "");
 
 	return reg_cache;
 }

-----------------------------------------------------------------------

Summary of changes:
 src/target/embeddedice.c |   11 +++++++++--
 1 files changed, 9 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sat Jan 23 23:24:22 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sat, 23 Jan 2010 22:24:22 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-147-g9ff1657
Message-ID: <E1NYoP1-0003pC-FR@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  9ff16575d2838527afa635058c4cb95d641533ba (commit)
      from  718ee762e7d6a81037670612a2f3d21da4784f56 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 9ff16575d2838527afa635058c4cb95d641533ba
Author: simon qian <simonqian.openocd at gmail.com>
Date:   Mon Jan 18 04:56:08 2010 +0800

    SVF: insert space before '(' and after ')'
    
    See http://forum.sparkfun.com/viewtopic.php?p=90983#90983 for discussion;
    basically, the SVF parser wrongly expects "TDI (123)" but the space is
    optional and it should accept "TDI(123)" too.
    
    In the same way, "TDI(123)TDO(456)" should work too.
    
    Rather than update the command parsing, this just makes sure the expected
    spaces are present.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/svf/svf.c b/src/svf/svf.c
index 7cb2200..275bced 100644
--- a/src/svf/svf.c
+++ b/src/svf/svf.c
@@ -504,27 +504,49 @@ static int svf_read_command_from_file(int fd)
 		default:
 			if (!comment)
 			{
-				if (cmd_pos >= svf_command_buffer_size - 1)
+				/* The parsing code currently expects a space
+				 * before parentheses -- "TDI (123)".  Also a
+				 * space afterwards -- "TDI (123) TDO(456)".
+				 * But such spaces are optional... instead of
+				 * parser updates, cope with that by adding the
+				 * spaces as needed.
+				 *
+				 * Ensure there are 3 bytes available, for:
+				 *  - current character
+				 *  - added space.
+				 *  - terminating NUL ('\0')
+				 */
+				if ((cmd_pos + 2) >= svf_command_buffer_size)
 				{
-					tmp_buffer = (char*)malloc(svf_command_buffer_size + SVFP_CMD_INC_CNT);		// 1 more byte for '\0'
+					/* REVISIT use realloc(); simpler */
+					tmp_buffer = malloc(
+							svf_command_buffer_size
+							+ SVFP_CMD_INC_CNT);
 					if (NULL == tmp_buffer)
 					{
 						LOG_ERROR("not enough memory");
 						return ERROR_FAIL;
 					}
 					if (svf_command_buffer_size > 0)
-					{
-						memcpy(tmp_buffer, svf_command_buffer, svf_command_buffer_size);
-					}
+						memcpy(tmp_buffer,
+							svf_command_buffer,
+							svf_command_buffer_size);
 					if (svf_command_buffer != NULL)
-					{
 						free(svf_command_buffer);
-					}
 					svf_command_buffer = tmp_buffer;
 					svf_command_buffer_size += SVFP_CMD_INC_CNT;
 					tmp_buffer = NULL;
 				}
+
+				/* insert a space before '(' */
+				if ('(' == ch)
+					svf_command_buffer[cmd_pos++] = ' ';
+
 				svf_command_buffer[cmd_pos++] = (char)toupper(ch);
+
+				/* insert a space after ')' */
+				if (')' == ch)
+					svf_command_buffer[cmd_pos++] = ' ';
 			}
 			break;
 		}

-----------------------------------------------------------------------

Summary of changes:
 src/svf/svf.c |   36 +++++++++++++++++++++++++++++-------
 1 files changed, 29 insertions(+), 7 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Mon Jan 25 21:20:26 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Mon, 25 Jan 2010 20:20:26 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-148-g1dad2ee
Message-ID: <E1NZVQC-0002be-Mx@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  1dad2ee602674de1b97548913dba2d53267d35a3 (commit)
      from  9ff16575d2838527afa635058c4cb95d641533ba (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 1dad2ee602674de1b97548913dba2d53267d35a3
Author: Edgar Grimberg <edgar.grimberg at zylin.com>
Date:   Mon Jan 25 16:34:27 2010 +0100

    core arm11: Silence logs at level 3 if there is no activity
    
    If the target and openocd are idling, the log should normally
    be silent at level 3.  (Given no verbose logging options.)
    
    Signed-off-by: Edgar Grimberg <edgar.grimberg at zylin.com>
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/jtag/core.c b/src/jtag/core.c
index e311bfb..8a580e9 100644
--- a/src/jtag/core.c
+++ b/src/jtag/core.c
@@ -530,10 +530,12 @@ int jtag_add_statemove(tap_state_t goal_state)
 {
 	tap_state_t cur_state = cmd_queue_cur_state;
 
-	LOG_DEBUG("cur_state=%s goal_state=%s",
-		tap_state_name(cur_state),
-		tap_state_name(goal_state));
-
+	if (goal_state != cur_state)
+	{
+		LOG_DEBUG("cur_state=%s goal_state=%s",
+			tap_state_name(cur_state),
+			tap_state_name(goal_state));
+	}
 
 	/* If goal is RESET, be paranoid and force that that transition
 	 * (e.g. five TCK cycles, TMS high).  Else trust "cur_state".
diff --git a/src/target/arm11.c b/src/target/arm11.c
index 8b7b69c..671943f 100644
--- a/src/target/arm11.c
+++ b/src/target/arm11.c
@@ -64,10 +64,10 @@ static int arm11_step(struct target *target, int current,
 static int arm11_check_init(struct arm11_common *arm11)
 {
 	CHECK_RETVAL(arm11_read_DSCR(arm11));
-	LOG_DEBUG("DSCR %08x", (unsigned) arm11->dscr);
 
 	if (!(arm11->dscr & DSCR_HALT_DBG_MODE))
 	{
+		LOG_DEBUG("DSCR %08x", (unsigned) arm11->dscr);
 		LOG_DEBUG("Bringing target into debug mode");
 
 		arm11->dscr |= DSCR_HALT_DBG_MODE;

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/core.c    |   10 ++++++----
 src/target/arm11.c |    2 +-
 2 files changed, 7 insertions(+), 5 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Mon Jan 25 22:06:58 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Mon, 25 Jan 2010 21:06:58 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-149-g33fc60b
Message-ID: <E1NZW9D-0006Kr-Cy@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  33fc60befc808b83ab4ef6b1c7a7130c7ccedfc8 (commit)
      from  1dad2ee602674de1b97548913dba2d53267d35a3 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 33fc60befc808b83ab4ef6b1c7a7130c7ccedfc8
Author: simon qian <simonqian.openocd at gmail.com>
Date:   Sun Jan 24 04:08:47 2010 +0800

    SVF: all content between parentheses is one parameter
    
    More SVF fixes:
    
     * Treat all content between parentheses as part of the same
       parameter; don't (wrongly) treat whitespace as a delimiter.
    
     * Use isspace() to catch that whitespace; it's not all single
       spaces, newlines etc are also valid.
    
     * When parsing bitstrings, strip leading whitespace too.
    
    So for example, these are equivalent and should (now) be OK:
    
      "TDI( 1234 )"
      "TDI( 1 2 3 4 )"
      "TDI(00 12 34 )"
      "TDI(
      	00 12
    	34)"
    
    [dbrownell at users.sourceforge.net: comment updates; trivial cleanup]
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/svf/svf.c b/src/svf/svf.c
index 275bced..ea56a88 100644
--- a/src/svf/svf.c
+++ b/src/svf/svf.c
@@ -500,7 +500,9 @@ static int svf_read_command_from_file(int fd)
 		case '\r':
 			slash = 0;
 			comment = 0;
-			break;
+			/* Don't save '\r' and '\n' if no data is parsed */
+			if (!cmd_pos)
+				break;
 		default:
 			if (!comment)
 			{
@@ -565,25 +567,30 @@ static int svf_read_command_from_file(int fd)
 
 static int svf_parse_cmd_string(char *str, int len, char **argus, int *num_of_argu)
 {
-	int pos = 0, num = 0, space_found = 1;
+	int pos = 0, num = 0, space_found = 1, in_bracket = 0;
 
 	while (pos < len)
 	{
 		switch (str[pos])
 		{
-		case '\n':
-		case '\r':
 		case '!':
 		case '/':
 			LOG_ERROR("fail to parse svf command");
 			return ERROR_FAIL;
-			break;
-		case ' ':
-			space_found = 1;
-			str[pos] = '\0';
-			break;
+		case '(':
+			in_bracket = 1;
+			goto parse_char;
+		case ')':
+			in_bracket = 0;
+			goto parse_char;
 		default:
-			if (space_found)
+parse_char:
+			if (!in_bracket && isspace(str[pos]))
+			{
+				space_found = 1;
+				str[pos] = '\0';
+			}
+			else if (space_found)
 			{
 				argus[num++] = &str[pos];
 				space_found = 0;
@@ -651,6 +658,7 @@ static int svf_copy_hexstring_to_binary(char *str, uint8_t **bin, int orig_bit_l
 		return ERROR_FAIL;
 	}
 
+	/* fill from LSB (end of str) to MSB (beginning of str) */
 	for (i = 0; i < str_hbyte_len; i++)
 	{
 		ch = 0;
@@ -658,7 +666,13 @@ static int svf_copy_hexstring_to_binary(char *str, uint8_t **bin, int orig_bit_l
 		{
 			ch = str[--str_len];
 
-			if (!isblank(ch))
+			/* Skip whitespace.  The SVF specification (rev E) is
+			 * deficient in terms of basic lexical issues like
+			 * where whitespace is allowed.  Long bitstrings may
+			 * require line ends for correctness, since there is
+			 * a hard limit on line length.
+			 */
+			if (!isspace(ch))
 			{
 				if ((ch >= '0') && (ch <= '9'))
 				{
@@ -694,11 +708,12 @@ static int svf_copy_hexstring_to_binary(char *str, uint8_t **bin, int orig_bit_l
 		}
 	}
 
-	// consume optional leading '0' characters
-	while (str_len > 0 && str[str_len - 1] == '0')
+	/* consume optional leading '0' MSBs or whitespace */
+	while (str_len > 0 && ((str[str_len - 1] == '0')
+				|| isspace(str[str_len - 1])))
 		str_len--;
 
-	// check valid
+	/* check validity: we must have consumed everything */
 	if (str_len > 0 || (ch & ~((2 << ((bit_len - 1) % 4)) - 1)) != 0)
 	{
 		LOG_ERROR("value execeeds length");

-----------------------------------------------------------------------

Summary of changes:
 src/svf/svf.c |   43 +++++++++++++++++++++++++++++--------------
 1 files changed, 29 insertions(+), 14 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Wed Jan 27 03:14:29 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Wed, 27 Jan 2010 02:14:29 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-151-g3036588
Message-ID: <E1NZxQN-0004n4-UD@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  30365886dab87f20c014d9ad1500c70edef48b00 (commit)
      from  9e52957efc93734f70295a489481f4f9f3944242 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 30365886dab87f20c014d9ad1500c70edef48b00
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Tue Jan 26 18:09:27 2010 -0800

    various: don't mention wiki
    
    The openfacts.berlios wiki isn't particularly current, and isn't
    publicly editable.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.1 b/doc/openocd.1
index d9f8a7c..68b6957 100644
--- a/doc/openocd.1
+++ b/doc/openocd.1
@@ -88,9 +88,6 @@ and
 programs are properly installed at your site, the command
 .B info openocd
 should give you access to the complete manual.
-.PP
-Also, the OpenOCD wiki contains some more information and examples:
-.B http://openfacts.berlios.de/index-en.phtml?title=Open_On-Chip_Debugger
 .SH "AUTHORS"
 Please see the file AUTHORS.
 .PP
diff --git a/testing/examples/AT91R40008Test/prj/at91r40008_turtle.cfg b/testing/examples/AT91R40008Test/prj/at91r40008_turtle.cfg
index bf760b2..d72980e 100644
--- a/testing/examples/AT91R40008Test/prj/at91r40008_turtle.cfg
+++ b/testing/examples/AT91R40008Test/prj/at91r40008_turtle.cfg
@@ -30,8 +30,8 @@ target_script 0 reset .\prj\at91r40008_reset.script
 
 flash bank cfi 0x10000000 0x400000 2 2 0
 
-# For more information about the configuration files, take a look at:
-# http://openfacts.berlios.de/index-en.phtml?title=Open+On-Chip+Debugger
+# For more information about the configuration files,
+# look at the OpenOCD User's Guide.
 
 init
 reset halt
diff --git a/testing/examples/LPC2148Test/prj/lpc2148_jtagkey.cfg b/testing/examples/LPC2148Test/prj/lpc2148_jtagkey.cfg
index d491d7d..e6b1e9e 100644
--- a/testing/examples/LPC2148Test/prj/lpc2148_jtagkey.cfg
+++ b/testing/examples/LPC2148Test/prj/lpc2148_jtagkey.cfg
@@ -27,8 +27,8 @@ target create target0 arm7tdmi -endian little -chain-position 0 -variant arm7tdm
 #flash bank lpc2000 <base> <size> 0 0 <target#> <variant>
 flash bank lpc2000 0x0 0x7d000 0 0 0 lpc2000_v2 14765 calc_checksum
 
-# For more information about the configuration files, take a look at:
-# http://openfacts.berlios.de/index-en.phtml?title=Open+On-Chip+Debugger
+# For more information about the configuration files,
+# look at the OpenOCD User's Guide.
 
 init
 reset halt
diff --git a/testing/examples/LPC2294Test/prj/lpc2294_jtagkey.cfg b/testing/examples/LPC2294Test/prj/lpc2294_jtagkey.cfg
index e8d3051..958b8a5 100644
--- a/testing/examples/LPC2294Test/prj/lpc2294_jtagkey.cfg
+++ b/testing/examples/LPC2294Test/prj/lpc2294_jtagkey.cfg
@@ -28,8 +28,8 @@ target create target0 arm7tdmi -endian little -chain-position 0 -variant arm7tdm
 #flash bank lpc2000 <base> <size> 0 0 <target#> <variant>
 flash bank lpc2000 0x0 0x40000 0 0 0 lpc2000_v1 14765 calc_checksum
 
-# For more information about the configuration files, take a look at:
-# http://openfacts.berlios.de/index-en.phtml?title=Open+On-Chip+Debugger
+# For more information about the configuration files,
+# look at the OpenOCD User's Guide.
 
 init
 reset halt
diff --git a/testing/examples/SAM7S256Test/prj/sam7s256_jtagkey.cfg b/testing/examples/SAM7S256Test/prj/sam7s256_jtagkey.cfg
index 4fd729e..92c1e30 100644
--- a/testing/examples/SAM7S256Test/prj/sam7s256_jtagkey.cfg
+++ b/testing/examples/SAM7S256Test/prj/sam7s256_jtagkey.cfg
@@ -32,8 +32,8 @@ target_script 0 reset .\prj\sam7s256_reset.script
 #flash bank <driver> <base> <size> <chip_width> <bus_width>
 flash bank at91sam7 0 0 0 0 0
 
-# For more information about the configuration files, take a look at:
-# http://openfacts.berlios.de/index-en.phtml?title=Open+On-Chip+Debugger
+# For more information about the configuration files,
+# look at the OpenOCD User's Guide.
 
 init
 reset halt
diff --git a/testing/examples/SAM7X256Test/prj/sam7x256_jtagkey.cfg b/testing/examples/SAM7X256Test/prj/sam7x256_jtagkey.cfg
index 930a1b6..32a5254 100644
--- a/testing/examples/SAM7X256Test/prj/sam7x256_jtagkey.cfg
+++ b/testing/examples/SAM7X256Test/prj/sam7x256_jtagkey.cfg
@@ -32,8 +32,8 @@ target_script 0 reset .\prj\sam7x256_reset.script
 #flash bank <driver> <base> <size> <chip_width> <bus_width>
 flash bank at91sam7 0 0 0 0 0
 
-# For more information about the configuration files, take a look at:
-# http://openfacts.berlios.de/index-en.phtml?title=Open+On-Chip+Debugger
+# For more information about the configuration files,
+# look at the OpenOCD User's Guide.
 
 init
 reset halt
diff --git a/testing/examples/STR710JtagSpeed/prj/str710_jtagkey.cfg b/testing/examples/STR710JtagSpeed/prj/str710_jtagkey.cfg
index 0e0cff5..f2e50dc 100644
--- a/testing/examples/STR710JtagSpeed/prj/str710_jtagkey.cfg
+++ b/testing/examples/STR710JtagSpeed/prj/str710_jtagkey.cfg
@@ -27,8 +27,8 @@ target create target0 arm7tdmi -endian little -chain-position 0 -variant arm7tdm
 #flash bank str7x <base> <size> 0 0 <target#> <variant>
 flash bank str7x 0x40000000 0x00040000 0 0 0 STR71x
 
-# For more information about the configuration files, take a look at:
-# http://openfacts.berlios.de/index-en.phtml?title=Open+On-Chip+Debugger
+# For more information about the configuration files,
+# look at the OpenOCD User's Guide.
 
 init
 reset halt
diff --git a/testing/examples/STR710Test/prj/str710_jtagkey.cfg b/testing/examples/STR710Test/prj/str710_jtagkey.cfg
index 31240cc..14ec3f1 100644
--- a/testing/examples/STR710Test/prj/str710_jtagkey.cfg
+++ b/testing/examples/STR710Test/prj/str710_jtagkey.cfg
@@ -29,8 +29,8 @@ target_script 0 gdb_program_config .\prj\str710_program.script
 #flash bank str7x <base> <size> 0 0 <target#> <variant>
 flash bank str7x 0x40000000 0x00040000 0 0 0 STR71x
 
-# For more information about the configuration files, take a look at:
-# http://openfacts.berlios.de/index-en.phtml?title=Open+On-Chip+Debugger
+# For more information about the configuration files,
+# look at the OpenOCD User's Guide.
 
 init
 reset halt
diff --git a/testing/examples/STR912Test/prj/str912_jtagkey.cfg b/testing/examples/STR912Test/prj/str912_jtagkey.cfg
index d4577f3..8a3f281 100644
--- a/testing/examples/STR912Test/prj/str912_jtagkey.cfg
+++ b/testing/examples/STR912Test/prj/str912_jtagkey.cfg
@@ -34,8 +34,8 @@ target_script 0 gdb_program_config .\prj\str912_program.script
 #flash bank str7x <base> <size> 0 0 <target#> <variant>
 flash bank str9x 0x00000000 0x00080000 0 0 0
 
-# For more information about the configuration files, take a look at:
-# http://openfacts.berlios.de/index-en.phtml?title=Open+On-Chip+Debugger
+# For more information about the configuration files,
+# look at the OpenOCD User's Guide.
 
 init
 reset halt

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.1                                      |    3 ---
 .../AT91R40008Test/prj/at91r40008_turtle.cfg       |    4 ++--
 .../examples/LPC2148Test/prj/lpc2148_jtagkey.cfg   |    4 ++--
 .../examples/LPC2294Test/prj/lpc2294_jtagkey.cfg   |    4 ++--
 .../examples/SAM7S256Test/prj/sam7s256_jtagkey.cfg |    4 ++--
 .../examples/SAM7X256Test/prj/sam7x256_jtagkey.cfg |    4 ++--
 .../STR710JtagSpeed/prj/str710_jtagkey.cfg         |    4 ++--
 testing/examples/STR710Test/prj/str710_jtagkey.cfg |    4 ++--
 testing/examples/STR912Test/prj/str912_jtagkey.cfg |    4 ++--
 9 files changed, 16 insertions(+), 19 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Wed Jan 27 02:55:53 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Wed, 27 Jan 2010 01:55:53 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-150-g9e52957
Message-ID: <E1NZx8N-0001h3-Sd@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  9e52957efc93734f70295a489481f4f9f3944242 (commit)
      from  33fc60befc808b83ab4ef6b1c7a7130c7ccedfc8 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 9e52957efc93734f70295a489481f4f9f3944242
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Tue Jan 26 17:54:49 2010 -0800

    cygwin buildfix
    
    isspace() parameter must be an integer, else a 'char' gets
    used as an array index (sigh).
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/svf/svf.c b/src/svf/svf.c
index ea56a88..f46d698 100644
--- a/src/svf/svf.c
+++ b/src/svf/svf.c
@@ -585,7 +585,7 @@ static int svf_parse_cmd_string(char *str, int len, char **argus, int *num_of_ar
 			goto parse_char;
 		default:
 parse_char:
-			if (!in_bracket && isspace(str[pos]))
+			if (!in_bracket && isspace((int) str[pos]))
 			{
 				space_found = 1;
 				str[pos] = '\0';
@@ -710,7 +710,7 @@ static int svf_copy_hexstring_to_binary(char *str, uint8_t **bin, int orig_bit_l
 
 	/* consume optional leading '0' MSBs or whitespace */
 	while (str_len > 0 && ((str[str_len - 1] == '0')
-				|| isspace(str[str_len - 1])))
+				|| isspace((int) str[str_len - 1])))
 		str_len--;
 
 	/* check validity: we must have consumed everything */

-----------------------------------------------------------------------

Summary of changes:
 src/svf/svf.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Wed Jan 27 22:51:26 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Wed, 27 Jan 2010 21:51:26 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-154-g3172be8
Message-ID: <E1NaFnM-0007Bh-KH@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  3172be80a3e14f4c8c3628a37db348c04fd60fc4 (commit)
       via  d44f1aaeff45d26348826bdff07caf3d097eca15 (commit)
       via  2b5c444a32725dd75833348e04620bd7b1bda2ad (commit)
      from  30365886dab87f20c014d9ad1500c70edef48b00 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 3172be80a3e14f4c8c3628a37db348c04fd60fc4
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Wed Jan 27 13:47:48 2010 -0800

    Cortex-M3: report lockup, and recover
    
    ARMv7-M defines a "lockup" state that's entered in certain double
    fault sequences which can't be recovered from without external help.
    OpenOCD has previously ignored this.
    
    Issue a diagnostic saying the chip has locked up, and force exit
    from this state by halting the core.  It's not clear this is the
    best way to handle lockup; but there should now be less confusion.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index adce4d9..3bbe42c 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -416,6 +416,21 @@ static int cortex_m3_poll(struct target *target)
 		return retval;
 	}
 
+	/* Recover from lockup.  See ARMv7-M architecture spec,
+	 * section B1.5.15 "Unrecoverable exception cases".
+	 *
+	 * REVISIT Is there a better way to report and handle this?
+	 */
+	if (cortex_m3->dcb_dhcsr & S_LOCKUP) {
+		LOG_WARNING("%s -- clearing lockup after double fault",
+				target_name(target));
+		cortex_m3_write_debug_halt_mask(target, C_HALT, 0);
+		target->debug_reason = DBG_REASON_DBGRQ;
+
+		/* refresh status bits */
+		mem_ap_read_atomic_u32(swjdp, DCB_DHCSR, &cortex_m3->dcb_dhcsr);
+	}
+
 	if (cortex_m3->dcb_dhcsr & S_RESET_ST)
 	{
 		/* check if still in reset */

commit d44f1aaeff45d26348826bdff07caf3d097eca15
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Wed Jan 27 13:40:05 2010 -0800

    ARM ADIv5: messaging tweaks
    
    Add space missing after the invalid ACK value.  On init, say
    which AP is being used, and don't assume it's an AHP-AP.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index ba5db3b..2ba89e5 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -305,7 +305,7 @@ int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
 			}
 			else
 			{
-				LOG_WARNING("Invalid ACK %#x"
+				LOG_WARNING("Invalid ACK %#x "
 						"in JTAG-DP transaction",
 						swjdp->ack);
 				return ERROR_JTAG_DEVICE_ERROR;
@@ -1058,6 +1058,7 @@ int mem_ap_read_buf_u8(struct swjdp_common *swjdp, uint8_t *buffer, int count, u
  * @todo Rename this.  We also need an initialization scheme which account
  * for SWD transports not just JTAG; that will need to address differences
  * in layering.  (JTAG is useful without any debug target; but not SWD.)
+ * And this may not even use an AHB-AP ... e.g. DAP-Lite uses an APB-AP.
  */
 int ahbap_debugport_init(struct swjdp_common *swjdp)
 {
@@ -1125,7 +1126,9 @@ int ahbap_debugport_init(struct swjdp_common *swjdp)
 	dap_ap_read_reg_u32(swjdp, AP_REG_IDR, &idreg);
 	dap_ap_read_reg_u32(swjdp, AP_REG_BASE, &romaddr);
 
-	LOG_DEBUG("AHB-AP ID Register 0x%" PRIx32 ", Debug ROM Address 0x%" PRIx32 "", idreg, romaddr);
+	LOG_DEBUG("MEM-AP #%d ID Register 0x%" PRIx32
+		", Debug ROM Address 0x%" PRIx32,
+		swjdp->apsel, idreg, romaddr);
 
 	return ERROR_OK;
 }

commit 2b5c444a32725dd75833348e04620bd7b1bda2ad
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Wed Jan 27 13:24:21 2010 -0800

    Cortex-A8: debug messaging tweaks
    
    Make that "TODO" message say what needs to be done.
    Say what part of examining failed.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/cortex_a8.c b/src/target/cortex_a8.c
index 18edd95..bcdb526 100644
--- a/src/target/cortex_a8.c
+++ b/src/target/cortex_a8.c
@@ -1461,7 +1461,8 @@ static int cortex_a8_examine_first(struct target *target)
 	int retval = ERROR_OK;
 	uint32_t didr, ctypr, ttypr, cpuid;
 
-	LOG_DEBUG("TODO");
+	/* stop assuming this is an OMAP! */
+	LOG_DEBUG("TODO - autoconfigure");
 
 	/* Here we shall insert a proper ROM Table scan */
 	armv7a->debug_base = OMAP3530_DEBUG_BASE;
@@ -1474,28 +1475,28 @@ static int cortex_a8_examine_first(struct target *target)
 	if ((retval = mem_ap_read_atomic_u32(swjdp,
 			armv7a->debug_base + CPUDBG_CPUID, &cpuid)) != ERROR_OK)
 	{
-		LOG_DEBUG("Examine failed");
+		LOG_DEBUG("Examine %s failed", "CPUID");
 		return retval;
 	}
 
 	if ((retval = mem_ap_read_atomic_u32(swjdp,
 			armv7a->debug_base + CPUDBG_CTYPR, &ctypr)) != ERROR_OK)
 	{
-		LOG_DEBUG("Examine failed");
+		LOG_DEBUG("Examine %s failed", "CTYPR");
 		return retval;
 	}
 
 	if ((retval = mem_ap_read_atomic_u32(swjdp,
 			armv7a->debug_base + CPUDBG_TTYPR, &ttypr)) != ERROR_OK)
 	{
-		LOG_DEBUG("Examine failed");
+		LOG_DEBUG("Examine %s failed", "TTYPR");
 		return retval;
 	}
 
 	if ((retval = mem_ap_read_atomic_u32(swjdp,
 			armv7a->debug_base + CPUDBG_DIDR, &didr)) != ERROR_OK)
 	{
-		LOG_DEBUG("Examine failed");
+		LOG_DEBUG("Examine %s failed", "DIDR");
 		return retval;
 	}
 

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm_adi_v5.c |    7 +++++--
 src/target/cortex_a8.c  |   11 ++++++-----
 src/target/cortex_m3.c  |   15 +++++++++++++++
 3 files changed, 26 insertions(+), 7 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Thu Jan 28 22:07:25 2010
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Thu, 28 Jan 2010 21:07:25 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-156-g75cfda4
Message-ID: <E1NabaJ-0003A3-JF@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  75cfda4cd1fe057f0557bd86963a71e530edd584 (commit)
       via  465a06dfdc6c5d4af377dac7b9d71845cb0dc034 (commit)
      from  3172be80a3e14f4c8c3628a37db348c04fd60fc4 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 75cfda4cd1fe057f0557bd86963a71e530edd584
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Thu Jan 28 21:05:09 2010 +0000

    ARM semihosting: win32 and cygwin fixes
    
    Cygwin would fail to reopen a previously written file if the mode is
    not given.
    
    Simplified converting the open flags and made sure the win32 O_BINARY
    bit is set.
    
    Added define for systems that do not support O_BINARY.
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/src/helper/replacements.h b/src/helper/replacements.h
index 2b3ea73..3598dd9 100644
--- a/src/helper/replacements.h
+++ b/src/helper/replacements.h
@@ -40,6 +40,12 @@
 #define ENOTSUP 134		/* Not supported */
 #endif
 
+/* for systems that do not support O_BINARY
+ * linux being one of them */
+#ifndef O_BINARY
+#define O_BINARY 0
+#endif
+
 #ifndef HAVE_SYS_TIME_H
 
 #ifndef _TIMEVAL_DEFINED
diff --git a/src/target/arm_semihosting.c b/src/target/arm_semihosting.c
index 1d0acd6..8db60a5 100644
--- a/src/target/arm_semihosting.c
+++ b/src/target/arm_semihosting.c
@@ -2,6 +2,9 @@
  *   Copyright (C) 2009 by Marvell Technology Group Ltd.                   *
  *   Written by Nicolas Pitre <nico at marvell.com>                           *
  *                                                                         *
+ *   Copyright (C) 2010 by Spencer Oliver                                  *
+ *   spen at spen-soft.co.uk                                                  *
+ *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
  *   it under the terms of the GNU General Public License as published by  *
  *   the Free Software Foundation; either version 2 of the License, or     *
@@ -41,6 +44,20 @@
 #include <helper/binarybuffer.h>
 #include <helper/log.h>
 
+static int open_modeflags[12] = {
+	O_RDONLY,
+	O_RDONLY | O_BINARY,
+	O_RDWR,
+	O_RDWR | O_BINARY,
+	O_WRONLY | O_CREAT | O_TRUNC,
+	O_WRONLY | O_CREAT | O_TRUNC | O_BINARY,
+	O_RDWR | O_CREAT | O_TRUNC,
+	O_RDWR | O_CREAT | O_TRUNC | O_BINARY,
+	O_WRONLY | O_CREAT | O_APPEND,
+	O_WRONLY | O_CREAT | O_APPEND | O_BINARY,
+	O_RDWR | O_CREAT | O_APPEND,
+	O_RDWR | O_CREAT | O_APPEND | O_BINARY
+};
 
 static int do_semihosting(struct target *target)
 {
@@ -72,28 +89,21 @@ static int do_semihosting(struct target *target)
 			uint32_t l = target_buffer_get_u32(target, params+8);
 			if (l <= 255 && m <= 11) {
 				uint8_t fn[256];
-				int mode;
 				retval = target_read_memory(target, a, 1, l, fn);
 				if (retval != ERROR_OK)
 					return retval;
 				fn[l] = 0;
-				if (m & 0x2)
-					mode = O_RDWR;
-				else if (m & 0xc)
-					mode = O_WRONLY;
-				else
-					mode = O_RDONLY;
-				if (m >= 8)
-					mode |= O_CREAT|O_APPEND;
-				else if (m >= 4)
-					mode |= O_CREAT|O_TRUNC;
 				if (strcmp((char *)fn, ":tt") == 0) {
-					if ((mode & 3) == 0)
-						result = dup(0);
+					if (m < 4)
+						result = dup(STDIN_FILENO);
 					else
-						result = dup(1);
-				} else
-					result = open((char *)fn, mode);
+						result = dup(STDOUT_FILENO);
+				} else {
+					/* cygwin requires the permission setting
+					 * otherwise it will fail to reopen a previously
+					 * written file */
+					result = open((char *)fn, open_modeflags[m], 0644);
+				}
 				armv4_5->semihosting_errno =  errno;
 			} else {
 				result = -1;

commit 465a06dfdc6c5d4af377dac7b9d71845cb0dc034
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Wed Jan 27 21:20:18 2010 +0000

    ARM semihosting: fix writing to stdout
    
    SYS_FLEN would be called before a write on a descriptor to check its size.
    Currently lseek would fail with -1 when given the stdout/stderr descriptor.
    Changing to use fstat seems to be the standard way of handling this.
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/src/helper/system.h b/src/helper/system.h
index 169df1c..af19d01 100644
--- a/src/helper/system.h
+++ b/src/helper/system.h
@@ -50,6 +50,8 @@
 #ifdef _WIN32
 #include <winsock2.h>
 #include <ws2tcpip.h>
+#include <sys/types.h>
+#include <sys/stat.h>
 #endif
 // --- platform specific headers ---
 
diff --git a/src/target/arm_semihosting.c b/src/target/arm_semihosting.c
index f4244c8..1d0acd6 100644
--- a/src/target/arm_semihosting.c
+++ b/src/target/arm_semihosting.c
@@ -230,18 +230,14 @@ static int do_semihosting(struct target *target)
 			return retval;
 		else {
 			int fd = target_buffer_get_u32(target, params+0);
-			off_t cur = lseek(fd, 0, SEEK_CUR);
-			if (cur == (off_t)-1) {
+			struct stat buf;
+			result = fstat(fd, &buf);
+			if (result == -1) {
 				armv4_5->semihosting_errno = errno;
 				result = -1;
 				break;
 			}
-			result = lseek(fd, 0, SEEK_END);
-			armv4_5->semihosting_errno = errno;
-			if (lseek(fd, cur, SEEK_SET) == (off_t)-1) {
-				armv4_5->semihosting_errno = errno;
-				result = -1;
-			}
+			result = buf.st_size;
 		}
 		break;
 

-----------------------------------------------------------------------

Summary of changes:
 src/helper/replacements.h    |    6 ++++
 src/helper/system.h          |    2 +
 src/target/arm_semihosting.c |   54 +++++++++++++++++++++++------------------
 3 files changed, 38 insertions(+), 24 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Thu Jan 28 23:04:19 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Thu, 28 Jan 2010 22:04:19 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-158-g804c0b2
Message-ID: <E1NacTO-0003xm-BN@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  804c0b2ad321247e50910511f691d987d8141081 (commit)
       via  5dcf7898f6144266c814306003c1e0a5ee067011 (commit)
      from  75cfda4cd1fe057f0557bd86963a71e530edd584 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 804c0b2ad321247e50910511f691d987d8141081
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 28 14:03:29 2010 -0800

    doc clarifications for server flags
    
    The "-f" is a shortcut for "-c" ... and providing any "-c" options
    means the "openocd.cfg" file isn't implicitly used.  Both the User's
    Guide and the manual page were weak on these points, which has led
    to some confusion.
    
    Also update the manual page to include highlights of the search path
    mechanism, including the facts that it exists and that "-s" adds to it.
    Stop saying only the current directory is involved; the OpenOCD
    script library is quite significant.
    
    (Missing: complete manpage coverage of the search path, including a
    FILES section listing all components and saying where the script
    library is found.)
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/doc/openocd.1 b/doc/openocd.1
index 68b6957..3720d42 100644
--- a/doc/openocd.1
+++ b/doc/openocd.1
@@ -22,19 +22,23 @@ please check the \fIopenocd\fR info page for the complete list.
 .SH "OPTIONS"
 .TP
 .B "\-f, \-\-file <filename>"
-Use configuration file
-.BR <filename> .
+This is a shortcut for a \fB\-c "[script \fI<filename>\fB]"\fR
+command, using a search path to load the configuration file
+.IR <filename> .
 In order to specify multiple config files, you can use multiple
 .B \-\-file
-arguments. If this option is omitted, the config file
+arguments. If no such \fB\-c\fR
+options are included, the first config file
 .B openocd.cfg
-in the current working directory will be used.
+in the search path will be used.
 .TP
 .B "\-s, \-\-search <dirname>"
-Search for config files and scripts in the directory
-.BR <dirname> .
-If this option is omitted, OpenOCD searches for config files and scripts
-in the current directory.
+Add
+.I <dirname>
+to the search path used for config files and scripts.
+The search path begins with the current directory,
+then includes these additional directories before other
+components such as the standard OpenOCD script libraries.
 .TP
 .B "\-d, \-\-debug <debuglevel>"
 Set debug level. Possible values are:
@@ -52,13 +56,17 @@ The default level is
 .TP
 .B "\-l, \-\-log_output <filename>"
 Redirect log output to the file
-.BR <filename> .
+.IR <filename> .
 Per default the log output is printed on
 .BR stderr .
 .TP
 .B "\-c, \-\-command <cmd>"
-Run the command
-.BR <cmd> .
+Add the command
+.I <cmd>
+to a list of commands executed on server startup.
+Note that you will need to explicitly invoke
+.I init
+if the command requires access to a target or flash.
 .TP
 .B "\-p, \-\-pipe"
 Use pipes when talking to gdb.
diff --git a/doc/openocd.texi b/doc/openocd.texi
index ee5c723..38fa92f 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -513,9 +513,10 @@ bash$ openocd --help
 --pipe       | -p       use pipes when talking to gdb
 @end verbatim
 
-By default OpenOCD reads the configuration file @file{openocd.cfg}.
-To specify a different (or multiple)
-configuration file, you can use the @option{-f} option. For example:
+If you don't give any @option{-f} or @option{-c} options,
+OpenOCD tries to read the configuration file @file{openocd.cfg}.
+To specify one or more different
+configuration files, use @option{-f} options. For example:
 
 @example
 openocd -f config1.cfg -f config2.cfg -f config3.cfg

commit 5dcf7898f6144266c814306003c1e0a5ee067011
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Thu Jan 28 13:58:20 2010 -0800

    ARM: reference DPM defn from v6/v7 arch spec
    
    The term "DPM" is probably not well known ("Device Power Management"?),
    so identify its source in the current ARM architecture specification.
    It's relevant to ARMv6, ARMv7-A, and ARMv7-R ... but not "M" profiles.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_dpm.c b/src/target/arm_dpm.c
index 4bd22ff..3c18e63 100644
--- a/src/target/arm_dpm.c
+++ b/src/target/arm_dpm.c
@@ -35,6 +35,12 @@
  * Implements various ARM DPM operations using architectural debug registers.
  * These routines layer over core-specific communication methods to cope with
  * implementation differences between cores like ARM1136 and Cortex-A8.
+ *
+ * The "Debug Programmers' Model" (DPM) for ARMv6 and ARMv7 is defined by
+ * Part C (Debug Architecture) of the ARM Architecture Reference Manual,
+ * ARMv7-A and ARMv7-R edition (ARM DDI 0406B).  In OpenOCD, DPM operations
+ * are abstracted through internal programming interfaces to share code and
+ * to minimize needless differences in debug behavior between cores.
  */
 
 /*----------------------------------------------------------------------*/

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.1        |   30 +++++++++++++++++++-----------
 doc/openocd.texi     |    7 ++++---
 src/target/arm_dpm.c |    6 ++++++
 3 files changed, 29 insertions(+), 14 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Fri Jan 29 09:02:20 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Fri, 29 Jan 2010 08:02:20 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-159-gcd3017c
Message-ID: <E1Nalo7-0006CW-0w@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  cd3017cffa68e6f56419177e66332f86ab45675b (commit)
      from  804c0b2ad321247e50910511f691d987d8141081 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit cd3017cffa68e6f56419177e66332f86ab45675b
Author: Alex Austin <alex.austin at spectrumdsi.com>
Date:   Fri Jan 29 00:41:44 2010 -0600

    Clang buildfixes
    
    Building with clang took a few very small changes. The change to
    helper/log.h is because clang doesn't like an expression where the
    result is unused. In helper/system.h, I just defined true and false
    since clang doesn't have them builtin.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/helper/log.h b/src/helper/log.h
index ebcb8a1..b936fee 100644
--- a/src/helper/log.h
+++ b/src/helper/log.h
@@ -111,7 +111,12 @@ extern int debug_level;
 #define LOG_LEVEL_IS(FOO)  ((debug_level) >= (FOO))
 
 #define LOG_DEBUG(expr ...) \
-		((debug_level >= LOG_LVL_DEBUG) ? log_printf_lf (LOG_LVL_DEBUG, __FILE__, __LINE__, __FUNCTION__, expr) , 0 : 0)
+		do { \
+			if (debug_level >= LOG_LVL_DEBUG) \
+				log_printf_lf(LOG_LVL_DEBUG, \
+					__FILE__, __LINE__, __func__, \
+					expr); \
+		} while (0)
 
 #define LOG_INFO(expr ...) \
 		log_printf_lf (LOG_LVL_INFO, __FILE__, __LINE__, __FUNCTION__, expr)
diff --git a/src/helper/system.h b/src/helper/system.h
index af19d01..8ff3532 100644
--- a/src/helper/system.h
+++ b/src/helper/system.h
@@ -85,4 +85,9 @@
 #include <fcntl.h>
 #endif
 
+#ifndef true
+#define true	1
+#define false	0
+#endif
+
 #endif // SYSTEM_H

-----------------------------------------------------------------------

Summary of changes:
 src/helper/log.h    |    7 ++++++-
 src/helper/system.h |    5 +++++
 2 files changed, 11 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sat Jan 30 00:25:12 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Fri, 29 Jan 2010 23:25:12 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-162-g3d3128a
Message-ID: <E1Nb0DB-0001dQ-M7@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  3d3128a8f5bb15f1d05ac5eb7ecc5e692ae290ce (commit)
       via  2248c387f2c413c89d0f175b464a6e60ea20e75b (commit)
       via  303b493c229475df26d69d102bbaf5ae5e5e7a3f (commit)
      from  cd3017cffa68e6f56419177e66332f86ab45675b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 3d3128a8f5bb15f1d05ac5eb7ecc5e692ae290ce
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 29 14:31:19 2010 -0800

    ADIv5: cleanup, rename swjdp_transaction_endcheck()
    
    Make messages reference "DAP" if they're actually transport-agnostic, or
    "JTAG-DP" when they're JTAG-specific.  Saying SWJ-DP is often wrong (on
    most Cortex-A8 chips) and is confusing even if correct (since we don't
    yet support SWD).
    
    Rename a JTAG-specific routine to jtagdp_transaction_endcheck() to highlight
    that it's JTAG-specific, and that identify DAP clients undesirably depending
    on JTAG.  (They will all need to change for SWD support.)
    
    Shrink a few overlong lines of code.  Copy a comment from code removed
    in a previous patch (for the ARMv7-M "dap baseaddr" command).
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 2ba89e5..b8744d5 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -220,7 +220,7 @@ static int scan_inout_check(struct swjdp_common *swjdp,
 	 */
 	if ((instr == JTAG_DP_APACC)
 			&& (swjdp->trans_mode == TRANS_MODE_ATOMIC))
-		return swjdp_transaction_endcheck(swjdp);
+		return jtagdp_transaction_endcheck(swjdp);
 
 	return ERROR_OK;
 }
@@ -244,12 +244,12 @@ static int scan_inout_check_u32(struct swjdp_common *swjdp,
 	 */
 	if ((instr == JTAG_DP_APACC)
 			&& (swjdp->trans_mode == TRANS_MODE_ATOMIC))
-		return swjdp_transaction_endcheck(swjdp);
+		return jtagdp_transaction_endcheck(swjdp);
 
 	return ERROR_OK;
 }
 
-int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
+int jtagdp_transaction_endcheck(struct swjdp_common *swjdp)
 {
 	int retval;
 	uint32_t ctrlstat;
@@ -322,7 +322,7 @@ int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
 	/* Check for STICKYERR and STICKYORUN */
 	if (ctrlstat & (SSTICKYORUN | SSTICKYERR))
 	{
-		LOG_DEBUG("swjdp: CTRL/STAT error 0x%" PRIx32 "", ctrlstat);
+		LOG_DEBUG("jtag-dp: CTRL/STAT error, 0x%" PRIx32, ctrlstat);
 		/* Check power to debug regions */
 		if ((ctrlstat & 0xf0000000) != 0xf0000000)
 		{
@@ -333,7 +333,10 @@ int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
 			uint32_t mem_ap_csw, mem_ap_tar;
 
 			/* Print information about last AHBAP access */
-			LOG_ERROR("AHBAP Cached values: dp_select 0x%" PRIx32 ", ap_csw 0x%" PRIx32 ", ap_tar 0x%" PRIx32 "", swjdp->dp_select_value, swjdp->ap_csw_value, swjdp->ap_tar_value);
+			LOG_ERROR("AHBAP Cached values: dp_select 0x%" PRIx32
+				", ap_csw 0x%" PRIx32 ", ap_tar 0x%" PRIx32,
+				swjdp->dp_select_value, swjdp->ap_csw_value,
+				swjdp->ap_tar_value);
 			if (ctrlstat & SSTICKYORUN)
 				LOG_ERROR("JTAG-DP OVERRUN - "
 					"check clock or reduce jtag speed");
@@ -351,13 +354,14 @@ int swjdp_transaction_endcheck(struct swjdp_common *swjdp)
 			if ((retval = jtag_execute_queue()) != ERROR_OK)
 				return retval;
 
-			LOG_DEBUG("swjdp: status 0x%" PRIx32 "", ctrlstat);
+			LOG_DEBUG("jtag-dp: CTRL/STAT 0x%" PRIx32, ctrlstat);
 
 			dap_ap_read_reg_u32(swjdp, AP_REG_CSW, &mem_ap_csw);
 			dap_ap_read_reg_u32(swjdp, AP_REG_TAR, &mem_ap_tar);
 			if ((retval = jtag_execute_queue()) != ERROR_OK)
 				return retval;
-			LOG_ERROR("Read MEM_AP_CSW 0x%" PRIx32 ", MEM_AP_TAR 0x%" PRIx32 "", mem_ap_csw, mem_ap_tar);
+			LOG_ERROR("MEM_AP_CSW 0x%" PRIx32 ", MEM_AP_TAR 0x%"
+					PRIx32, mem_ap_csw, mem_ap_tar);
 
 		}
 		if ((retval = jtag_execute_queue()) != ERROR_OK)
@@ -461,13 +465,13 @@ int dap_setup_accessport(struct swjdp_common *swjdp, uint32_t csw, uint32_t tar)
 	csw = csw | CSW_DBGSWENABLE | CSW_MASTER_DEBUG | CSW_HPROT;
 	if (csw != swjdp->ap_csw_value)
 	{
-		/* LOG_DEBUG("swjdp : Set CSW %x",csw); */
+		/* LOG_DEBUG("DAP: Set CSW %x",csw); */
 		dap_ap_write_reg_u32(swjdp, AP_REG_CSW, csw);
 		swjdp->ap_csw_value = csw;
 	}
 	if (tar != swjdp->ap_tar_value)
 	{
-		/* LOG_DEBUG("swjdp : Set TAR %x",tar); */
+		/* LOG_DEBUG("DAP: Set TAR %x",tar); */
 		dap_ap_write_reg_u32(swjdp, AP_REG_TAR, tar);
 		swjdp->ap_tar_value = tar;
 	}
@@ -501,7 +505,7 @@ int mem_ap_read_atomic_u32(struct swjdp_common *swjdp, uint32_t address, uint32_
 {
 	mem_ap_read_u32(swjdp, address, value);
 
-	return swjdp_transaction_endcheck(swjdp);
+	return jtagdp_transaction_endcheck(swjdp);
 }
 
 /*****************************************************************************
@@ -525,7 +529,7 @@ int mem_ap_write_atomic_u32(struct swjdp_common *swjdp, uint32_t address, uint32
 {
 	mem_ap_write_u32(swjdp, address, value);
 
-	return swjdp_transaction_endcheck(swjdp);
+	return jtagdp_transaction_endcheck(swjdp);
 }
 
 /*****************************************************************************
@@ -583,7 +587,7 @@ int mem_ap_write_buf_u32(struct swjdp_common *swjdp, uint8_t *buffer, int count,
 			dap_ap_write_reg(swjdp, AP_REG_DRW, buffer + 4 * writecount);
 		}
 
-		if (swjdp_transaction_endcheck(swjdp) == ERROR_OK)
+		if (jtagdp_transaction_endcheck(swjdp) == ERROR_OK)
 		{
 			wcount = wcount - blocksize;
 			address = address + 4 * blocksize;
@@ -659,7 +663,7 @@ static int mem_ap_write_buf_packed_u16(struct swjdp_common *swjdp,
 
 				memcpy(&outvalue, buffer, sizeof(uint32_t));
 				dap_ap_write_reg_u32(swjdp, AP_REG_DRW, outvalue);
-				if (swjdp_transaction_endcheck(swjdp) != ERROR_OK)
+				if (jtagdp_transaction_endcheck(swjdp) != ERROR_OK)
 				{
 					LOG_WARNING("Block read error address 0x%" PRIx32 ", count 0x%x", address, count);
 					return ERROR_JTAG_DEVICE_ERROR;
@@ -692,7 +696,7 @@ int mem_ap_write_buf_u16(struct swjdp_common *swjdp, uint8_t *buffer, int count,
 		memcpy(&svalue, buffer, sizeof(uint16_t));
 		uint32_t outvalue = (uint32_t)svalue << 8 * (address & 0x3);
 		dap_ap_write_reg_u32(swjdp, AP_REG_DRW, outvalue);
-		retval = swjdp_transaction_endcheck(swjdp);
+		retval = jtagdp_transaction_endcheck(swjdp);
 		count -= 2;
 		address += 2;
 		buffer += 2;
@@ -752,7 +756,7 @@ static int mem_ap_write_buf_packed_u8(struct swjdp_common *swjdp,
 
 				memcpy(&outvalue, buffer, sizeof(uint32_t));
 				dap_ap_write_reg_u32(swjdp, AP_REG_DRW, outvalue);
-				if (swjdp_transaction_endcheck(swjdp) != ERROR_OK)
+				if (jtagdp_transaction_endcheck(swjdp) != ERROR_OK)
 				{
 					LOG_WARNING("Block read error address 0x%" PRIx32 ", count 0x%x", address, count);
 					return ERROR_JTAG_DEVICE_ERROR;
@@ -783,7 +787,7 @@ int mem_ap_write_buf_u8(struct swjdp_common *swjdp, uint8_t *buffer, int count,
 		dap_setup_accessport(swjdp, CSW_8BIT | CSW_ADDRINC_SINGLE, address);
 		uint32_t outvalue = (uint32_t)*buffer << 8 * (address & 0x3);
 		dap_ap_write_reg_u32(swjdp, AP_REG_DRW, outvalue);
-		retval = swjdp_transaction_endcheck(swjdp);
+		retval = jtagdp_transaction_endcheck(swjdp);
 		count--;
 		address++;
 		buffer++;
@@ -843,7 +847,7 @@ int mem_ap_read_buf_u32(struct swjdp_common *swjdp, uint8_t *buffer, int count,
 		adi_jtag_dp_scan(swjdp, JTAG_DP_DPACC, DP_RDBUFF,
 				DPAP_READ, 0, buffer + 4 * readcount,
 				&swjdp->ack);
-		if (swjdp_transaction_endcheck(swjdp) == ERROR_OK)
+		if (jtagdp_transaction_endcheck(swjdp) == ERROR_OK)
 		{
 			wcount = wcount - blocksize;
 			address += 4 * blocksize;
@@ -912,7 +916,7 @@ static int mem_ap_read_buf_packed_u16(struct swjdp_common *swjdp,
 		do
 		{
 			dap_ap_read_reg_u32(swjdp, AP_REG_DRW, &invalue);
-			if (swjdp_transaction_endcheck(swjdp) != ERROR_OK)
+			if (jtagdp_transaction_endcheck(swjdp) != ERROR_OK)
 			{
 				LOG_WARNING("Block read error address 0x%" PRIx32 ", count 0x%x", address, count);
 				return ERROR_JTAG_DEVICE_ERROR;
@@ -949,7 +953,7 @@ int mem_ap_read_buf_u16(struct swjdp_common *swjdp, uint8_t *buffer, int count,
 	{
 		dap_setup_accessport(swjdp, CSW_16BIT | CSW_ADDRINC_SINGLE, address);
 		dap_ap_read_reg_u32(swjdp, AP_REG_DRW, &invalue);
-		retval = swjdp_transaction_endcheck(swjdp);
+		retval = jtagdp_transaction_endcheck(swjdp);
 		if (address & 0x1)
 		{
 			for (i = 0; i < 2; i++)
@@ -1005,7 +1009,7 @@ static int mem_ap_read_buf_packed_u8(struct swjdp_common *swjdp,
 		do
 		{
 			dap_ap_read_reg_u32(swjdp, AP_REG_DRW, &invalue);
-			if (swjdp_transaction_endcheck(swjdp) != ERROR_OK)
+			if (jtagdp_transaction_endcheck(swjdp) != ERROR_OK)
 			{
 				LOG_WARNING("Block read error address 0x%" PRIx32 ", count 0x%x", address, count);
 				return ERROR_JTAG_DEVICE_ERROR;
@@ -1042,7 +1046,7 @@ int mem_ap_read_buf_u8(struct swjdp_common *swjdp, uint8_t *buffer, int count, u
 	{
 		dap_setup_accessport(swjdp, CSW_8BIT | CSW_ADDRINC_SINGLE, address);
 		dap_ap_read_reg_u32(swjdp, AP_REG_DRW, &invalue);
-		retval = swjdp_transaction_endcheck(swjdp);
+		retval = jtagdp_transaction_endcheck(swjdp);
 		*((uint8_t*)buffer) = (invalue >> 8 * (address & 0x3));
 		count--;
 		address++;
@@ -1095,7 +1099,7 @@ int ahbap_debugport_init(struct swjdp_common *swjdp)
 	/* Check that we have debug power domains activated */
 	while (!(ctrlstat & CDBGPWRUPACK) && (cnt++ < 10))
 	{
-		LOG_DEBUG("swjdp: wait CDBGPWRUPACK");
+		LOG_DEBUG("DAP: wait CDBGPWRUPACK");
 		dap_dp_read_reg(swjdp, &ctrlstat, DP_CTRL_STAT);
 		if ((retval = jtag_execute_queue()) != ERROR_OK)
 			return retval;
@@ -1104,7 +1108,7 @@ int ahbap_debugport_init(struct swjdp_common *swjdp)
 
 	while (!(ctrlstat & CSYSPWRUPACK) && (cnt++ < 10))
 	{
-		LOG_DEBUG("swjdp: wait CSYSPWRUPACK");
+		LOG_DEBUG("DAP: wait CSYSPWRUPACK");
 		dap_dp_read_reg(swjdp, &ctrlstat, DP_CTRL_STAT);
 		if ((retval = jtag_execute_queue()) != ERROR_OK)
 			return retval;
@@ -1163,7 +1167,7 @@ int dap_info_command(struct command_context *cmd_ctx, struct swjdp_common *swjdp
 	dap_ap_select(swjdp, apsel);
 	dap_ap_read_reg_u32(swjdp, AP_REG_BASE, &dbgbase);
 	dap_ap_read_reg_u32(swjdp, AP_REG_IDR, &apid);
-	swjdp_transaction_endcheck(swjdp);
+	jtagdp_transaction_endcheck(swjdp);
 	/* Now we read ROM table ID registers, ref. ARM IHI 0029B sec  */
 	mem_ap = ((apid&0x10000) && ((apid&0x0F) != 0));
 	command_print(cmd_ctx, "AP ID register 0x%8.8" PRIx32, apid);
@@ -1215,7 +1219,7 @@ int dap_info_command(struct command_context *cmd_ctx, struct swjdp_common *swjdp
 		mem_ap_read_u32(swjdp, (dbgbase&0xFFFFF000) | 0xFF8, &cid2);
 		mem_ap_read_u32(swjdp, (dbgbase&0xFFFFF000) | 0xFFC, &cid3);
 		mem_ap_read_u32(swjdp, (dbgbase&0xFFFFF000) | 0xFCC, &memtype);
-		swjdp_transaction_endcheck(swjdp);
+		jtagdp_transaction_endcheck(swjdp);
 		if (!is_dap_cid_ok(cid3, cid2, cid1, cid0))
 			command_print(cmd_ctx, "\tCID3 0x%2.2" PRIx32
 					", CID2 0x%2.2" PRIx32
@@ -1519,8 +1523,13 @@ DAP_COMMAND_HANDLER(dap_baseaddr_command)
 	if (apselsave != apsel)
 		dap_ap_select(swjdp, apsel);
 
+	/* NOTE:  assumes we're talking to a MEM-AP, which
+	 * has a base address.  There are other kinds of AP,
+	 * though they're not common for now.  This should
+	 * use the ID register to verify it's a MEM-AP.
+	 */
 	dap_ap_read_reg_u32(swjdp, AP_REG_BASE, &baseaddr);
-	retval = swjdp_transaction_endcheck(swjdp);
+	retval = jtagdp_transaction_endcheck(swjdp);
 	command_print(CMD_CTX, "0x%8.8" PRIx32, baseaddr);
 
 	if (apselsave != apsel)
@@ -1569,7 +1578,7 @@ DAP_COMMAND_HANDLER(dap_apsel_command)
 
 	dap_ap_select(swjdp, apsel);
 	dap_ap_read_reg_u32(swjdp, AP_REG_IDR, &apid);
-	retval = swjdp_transaction_endcheck(swjdp);
+	retval = jtagdp_transaction_endcheck(swjdp);
 	command_print(CMD_CTX, "ap %" PRIi32 " selected, identification register 0x%8.8" PRIx32,
 			apsel, apid);
 
@@ -1597,7 +1606,7 @@ DAP_COMMAND_HANDLER(dap_apid_command)
 		dap_ap_select(swjdp, apsel);
 
 	dap_ap_read_reg_u32(swjdp, AP_REG_IDR, &apid);
-	retval = swjdp_transaction_endcheck(swjdp);
+	retval = jtagdp_transaction_endcheck(swjdp);
 	command_print(CMD_CTX, "0x%8.8" PRIx32, apid);
 	if (apselsave != apsel)
 		dap_ap_select(swjdp, apselsave);
diff --git a/src/target/arm_adi_v5.h b/src/target/arm_adi_v5.h
index 861a13d..a807027 100644
--- a/src/target/arm_adi_v5.h
+++ b/src/target/arm_adi_v5.h
@@ -170,8 +170,8 @@ int dap_ap_write_reg_u32(struct swjdp_common *swjdp,
 int dap_ap_read_reg_u32(struct swjdp_common *swjdp,
 		uint32_t addr, uint32_t *value);
 
-/* Queued transactions must be completed with swjdp_transaction_endcheck() */
-int swjdp_transaction_endcheck(struct swjdp_common *swjdp);
+/* Queued JTAG ops must be completed with jtagdp_transaction_endcheck() */
+int jtagdp_transaction_endcheck(struct swjdp_common *swjdp);
 
 /* MEM-AP memory mapped bus single uint32_t register transfers, without endcheck */
 int mem_ap_read_u32(struct swjdp_common *swjdp, uint32_t address, uint32_t *value);
diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index 3bbe42c..3f34769 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -80,7 +80,7 @@ static int cortexm3_dap_read_coreregister_u32(struct swjdp_common *swjdp,
 	dap_setup_accessport(swjdp, CSW_32BIT | CSW_ADDRINC_OFF, DCB_DCRDR & 0xFFFFFFF0);
 	dap_ap_read_reg_u32(swjdp, AP_REG_BD0 | (DCB_DCRDR & 0xC), value);
 
-	retval = swjdp_transaction_endcheck(swjdp);
+	retval = jtagdp_transaction_endcheck(swjdp);
 
 	/* restore DCB_DCRDR - this needs to be in a seperate
 	 * transaction otherwise the emulated DCC channel breaks */
@@ -111,7 +111,7 @@ static int cortexm3_dap_write_coreregister_u32(struct swjdp_common *swjdp,
 	dap_setup_accessport(swjdp, CSW_32BIT | CSW_ADDRINC_OFF, DCB_DCRSR & 0xFFFFFFF0);
 	dap_ap_write_reg_u32(swjdp, AP_REG_BD0 | (DCB_DCRSR & 0xC), regnum | DCRSR_WnR);
 
-	retval = swjdp_transaction_endcheck(swjdp);
+	retval = jtagdp_transaction_endcheck(swjdp);
 
 	/* restore DCB_DCRDR - this needs to be in a seperate
 	 * transaction otherwise the emulated DCC channel breaks */
@@ -238,7 +238,7 @@ static int cortex_m3_endreset_event(struct target *target)
 		target_write_u32(target, dwt_list[i].dwt_comparator_address + 8,
 				dwt_list[i].function);
 	}
-	swjdp_transaction_endcheck(swjdp);
+	jtagdp_transaction_endcheck(swjdp);
 
 	register_cache_invalidate(cortex_m3->armv7m.core_cache);
 
@@ -317,7 +317,7 @@ static int cortex_m3_examine_exception_reason(struct target *target)
 			except_sr = 0;
 			break;
 	}
-	swjdp_transaction_endcheck(swjdp);
+	jtagdp_transaction_endcheck(swjdp);
 	LOG_DEBUG("%s SHCSR 0x%" PRIx32 ", SR 0x%" PRIx32 ", CFSR 0x%" PRIx32 ", AR 0x%" PRIx32 "", armv7m_exception_string(armv7m->exception_number), \
 		shcsr, except_sr, cfsr, except_ar);
 	return ERROR_OK;

commit 2248c387f2c413c89d0f175b464a6e60ea20e75b
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 29 14:16:14 2010 -0800

    ARMv7-M: use command handler for "dap baseaddr".
    
    Make the ARMv7-M DAP code reuse the command handler for "dap baseaddr".
    For some reason, this DAP command wasn't converted earlier.
    
    This is a code shrink and simplification; it also removes a needless
    transport dependency on JTAG.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/armv7m.c b/src/target/armv7m.c
index c172a27..edfcdf9 100644
--- a/src/target/armv7m.c
+++ b/src/target/armv7m.c
@@ -751,37 +751,8 @@ COMMAND_HANDLER(handle_dap_baseaddr_command)
 	struct target *target = get_current_target(CMD_CTX);
 	struct armv7m_common *armv7m = target_to_armv7m(target);
 	struct swjdp_common *swjdp = &armv7m->swjdp_info;
-	uint32_t apsel, apselsave, baseaddr;
-	int retval;
 
-	apselsave = swjdp->apsel;
-	switch (CMD_ARGC) {
-	case 0:
-		apsel = swjdp->apsel;
-		break;
-	case 1:
-		COMMAND_PARSE_NUMBER(u32, CMD_ARGV[0], apsel);
-		break;
-	default:
-		return ERROR_COMMAND_SYNTAX_ERROR;
-	}
-
-	if (apselsave != apsel)
-		dap_ap_select(swjdp, apsel);
-
-	/* NOTE:  assumes we're talking to a MEM-AP, which
-	 * has a base address.  There are other kinds of AP,
-	 * though they're not common for now.  This should
-	 * use the ID register to verify it's a MEM-AP.
-	 */
-	dap_ap_read_reg_u32(swjdp, AP_REG_BASE, &baseaddr);
-	retval = swjdp_transaction_endcheck(swjdp);
-	command_print(CMD_CTX, "0x%8.8" PRIx32 "", baseaddr);
-
-	if (apselsave != apsel)
-		dap_ap_select(swjdp, apselsave);
-
-	return retval;
+	return CALL_COMMAND_HANDLER(dap_baseaddr_command, swjdp);
 }
 
 /*

commit 303b493c229475df26d69d102bbaf5ae5e5e7a3f
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Fri Jan 29 13:52:08 2010 -0800

    NOR: cleanup driver decls
    
    Fix goofy struct indents.  Function names *are* their addresses.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/flash/nor/aduc702x.c b/src/flash/nor/aduc702x.c
index 211b54e..7e81b32 100644
--- a/src/flash/nor/aduc702x.c
+++ b/src/flash/nor/aduc702x.c
@@ -412,14 +412,14 @@ static int aduc702x_check_flash_completion(struct target* target, unsigned int t
 }
 
 struct flash_driver aduc702x_flash = {
-		.name = "aduc702x",
-		.flash_bank_command = &aduc702x_flash_bank_command,
-		.erase = &aduc702x_erase,
-		.protect = &aduc702x_protect,
-		.write = &aduc702x_write,
-		.probe = &aduc702x_probe,
-		.auto_probe = &aduc702x_probe,
-		.erase_check = &default_flash_blank_check,
-		.protect_check = &aduc702x_protect_check,
-		.info = &aduc702x_info
-	};
+	.name = "aduc702x",
+	.flash_bank_command = aduc702x_flash_bank_command,
+	.erase = aduc702x_erase,
+	.protect = aduc702x_protect,
+	.write = aduc702x_write,
+	.probe = aduc702x_probe,
+	.auto_probe = aduc702x_probe,
+	.erase_check = default_flash_blank_check,
+	.protect_check = aduc702x_protect_check,
+	.info = aduc702x_info
+};
diff --git a/src/flash/nor/at91sam3.c b/src/flash/nor/at91sam3.c
index 5dacf6f..1b2f27c 100644
--- a/src/flash/nor/at91sam3.c
+++ b/src/flash/nor/at91sam3.c
@@ -2501,15 +2501,15 @@ static const struct command_registration at91sam3_command_handlers[] = {
 };
 
 struct flash_driver at91sam3_flash = {
-		.name = "at91sam3",
-		.commands = at91sam3_command_handlers,
-		.flash_bank_command = &sam3_flash_bank_command,
-		.erase = &sam3_erase,
-		.protect = &sam3_protect,
-		.write = &sam3_write,
-		.probe = &sam3_probe,
-		.auto_probe = &sam3_auto_probe,
-		.erase_check = &sam3_erase_check,
-		.protect_check = &sam3_protect_check,
-		.info = &sam3_info,
-	};
+	.name = "at91sam3",
+	.commands = at91sam3_command_handlers,
+	.flash_bank_command = sam3_flash_bank_command,
+	.erase = sam3_erase,
+	.protect = sam3_protect,
+	.write = sam3_write,
+	.probe = sam3_probe,
+	.auto_probe = sam3_auto_probe,
+	.erase_check = sam3_erase_check,
+	.protect_check = sam3_protect_check,
+	.info = sam3_info,
+};
diff --git a/src/flash/nor/avrf.c b/src/flash/nor/avrf.c
index 6c2d17f..c072419 100644
--- a/src/flash/nor/avrf.c
+++ b/src/flash/nor/avrf.c
@@ -452,7 +452,7 @@ COMMAND_HANDLER(avrf_handle_mass_erase_command)
 static const struct command_registration avrf_exec_command_handlers[] = {
 	{
 		.name = "mass_erase",
-		.handler = &avrf_handle_mass_erase_command,
+		.handler = avrf_handle_mass_erase_command,
 		.mode = COMMAND_EXEC,
 		.help = "erase entire device",
 	},
@@ -469,15 +469,15 @@ static const struct command_registration avrf_command_handlers[] = {
 };
 
 struct flash_driver avr_flash = {
-		.name = "avr",
-		.commands = avrf_command_handlers,
-		.flash_bank_command = &avrf_flash_bank_command,
-		.erase = &avrf_erase,
-		.protect = &avrf_protect,
-		.write = &avrf_write,
-		.probe = &avrf_probe,
-		.auto_probe = &avrf_auto_probe,
-		.erase_check = &default_flash_mem_blank_check,
-		.protect_check = &avrf_protect_check,
-		.info = &avrf_info,
-	};
+	.name = "avr",
+	.commands = avrf_command_handlers,
+	.flash_bank_command = avrf_flash_bank_command,
+	.erase = avrf_erase,
+	.protect = avrf_protect,
+	.write = avrf_write,
+	.probe = avrf_probe,
+	.auto_probe = avrf_auto_probe,
+	.erase_check = default_flash_mem_blank_check,
+	.protect_check = avrf_protect_check,
+	.info = avrf_info,
+};
diff --git a/src/flash/nor/cfi.c b/src/flash/nor/cfi.c
index 71270b9..42aa294 100644
--- a/src/flash/nor/cfi.c
+++ b/src/flash/nor/cfi.c
@@ -2618,14 +2618,14 @@ static int cfi_info(struct flash_bank *bank, char *buf, int buf_size)
 }
 
 struct flash_driver cfi_flash = {
-		.name = "cfi",
-		.flash_bank_command = &cfi_flash_bank_command,
-		.erase = &cfi_erase,
-		.protect = &cfi_protect,
-		.write = &cfi_write,
-		.probe = &cfi_probe,
-		.auto_probe = &cfi_auto_probe,
-		.erase_check = &default_flash_blank_check,
-		.protect_check = &cfi_protect_check,
-		.info = &cfi_info,
-	};
+	.name = "cfi",
+	.flash_bank_command = cfi_flash_bank_command,
+	.erase = cfi_erase,
+	.protect = cfi_protect,
+	.write = cfi_write,
+	.probe = cfi_probe,
+	.auto_probe = cfi_auto_probe,
+	.erase_check = default_flash_blank_check,
+	.protect_check = cfi_protect_check,
+	.info = cfi_info,
+};
diff --git a/src/flash/nor/ecos.c b/src/flash/nor/ecos.c
index b51e0a0..783a40c 100644
--- a/src/flash/nor/ecos.c
+++ b/src/flash/nor/ecos.c
@@ -431,14 +431,14 @@ static int ecosflash_handle_gpnvm_command(struct command_context *cmd_ctx, char
 #endif
 
 struct flash_driver ecosflash_flash = {
-		.name = "ecosflash",
-		.flash_bank_command = &ecosflash_flash_bank_command,
-		.erase = &ecosflash_erase,
-		.protect = &ecosflash_protect,
-		.write = &ecosflash_write,
-		.probe = &ecosflash_probe,
-		.auto_probe = &ecosflash_probe,
-		.erase_check = &default_flash_blank_check,
-		.protect_check = &ecosflash_protect_check,
-		.info = &ecosflash_info
-	};
+	.name = "ecosflash",
+	.flash_bank_command = ecosflash_flash_bank_command,
+	.erase = ecosflash_erase,
+	.protect = ecosflash_protect,
+	.write = ecosflash_write,
+	.probe = ecosflash_probe,
+	.auto_probe = ecosflash_probe,
+	.erase_check = default_flash_blank_check,
+	.protect_check = ecosflash_protect_check,
+	.info = ecosflash_info
+};
diff --git a/src/flash/nor/faux.c b/src/flash/nor/faux.c
index 948f305..e1e77ea 100644
--- a/src/flash/nor/faux.c
+++ b/src/flash/nor/faux.c
@@ -135,15 +135,15 @@ static const struct command_registration faux_command_handlers[] = {
 };
 
 struct flash_driver faux_flash = {
-		.name = "faux",
-		.commands = faux_command_handlers,
-		.flash_bank_command = &faux_flash_bank_command,
-		.erase = &faux_erase,
-		.protect = &faux_protect,
-		.write = &faux_write,
-		.probe = &faux_probe,
-		.auto_probe = &faux_probe,
-		.erase_check = &default_flash_blank_check,
-		.protect_check = &faux_protect_check,
-		.info = &faux_info
-	};
+	.name = "faux",
+	.commands = faux_command_handlers,
+	.flash_bank_command = faux_flash_bank_command,
+	.erase = faux_erase,
+	.protect = faux_protect,
+	.write = faux_write,
+	.probe = faux_probe,
+	.auto_probe = faux_probe,
+	.erase_check = default_flash_blank_check,
+	.protect_check = faux_protect_check,
+	.info = faux_info
+};
diff --git a/src/flash/nor/lpc2000.c b/src/flash/nor/lpc2000.c
index ae0a384..fc2b1cf 100644
--- a/src/flash/nor/lpc2000.c
+++ b/src/flash/nor/lpc2000.c
@@ -783,7 +783,7 @@ COMMAND_HANDLER(lpc2000_handle_part_id_command)
 static const struct command_registration lpc2000_exec_command_handlers[] = {
 	{
 		.name = "part_id",
-		.handler = &lpc2000_handle_part_id_command,
+		.handler = lpc2000_handle_part_id_command,
 		.mode = COMMAND_EXEC,
 		.help = "print part id of lpc2000 flash bank <num>",
 	},
@@ -800,17 +800,15 @@ static const struct command_registration lpc2000_command_handlers[] = {
 };
 
 struct flash_driver lpc2000_flash = {
-		.name = "lpc2000",
-		.commands = lpc2000_command_handlers,
-		.flash_bank_command = &lpc2000_flash_bank_command,
-		.erase = &lpc2000_erase,
-		.protect = &lpc2000_protect,
-		.write = &lpc2000_write,
-		.probe = &lpc2000_probe,
-		.auto_probe = &lpc2000_probe,
-		.erase_check = &lpc2000_erase_check,
-		.protect_check = &lpc2000_protect_check,
-		.info = &lpc2000_info,
-	};
-
-
+	.name = "lpc2000",
+	.commands = lpc2000_command_handlers,
+	.flash_bank_command = lpc2000_flash_bank_command,
+	.erase = lpc2000_erase,
+	.protect = lpc2000_protect,
+	.write = lpc2000_write,
+	.probe = lpc2000_probe,
+	.auto_probe = lpc2000_probe,
+	.erase_check = lpc2000_erase_check,
+	.protect_check = lpc2000_protect_check,
+	.info = lpc2000_info,
+};
diff --git a/src/flash/nor/lpc288x.c b/src/flash/nor/lpc288x.c
index 5cb36d0..5ab4e9c 100644
--- a/src/flash/nor/lpc288x.c
+++ b/src/flash/nor/lpc288x.c
@@ -473,14 +473,14 @@ static int lpc288x_protect(struct flash_bank *bank, int set, int first, int last
 }
 
 struct flash_driver lpc288x_flash = {
-		.name = "lpc288x",
-		.flash_bank_command = &lpc288x_flash_bank_command,
-		.erase = &lpc288x_erase,
-		.protect = &lpc288x_protect,
-		.write = &lpc288x_write,
-		.probe = &lpc288x_probe,
-		.auto_probe = &lpc288x_probe,
-		.erase_check = &lpc288x_erase_check,
-		.protect_check = &lpc288x_protect_check,
-		.info = &lpc288x_info,
-	};
+	.name = "lpc288x",
+	.flash_bank_command = lpc288x_flash_bank_command,
+	.erase = lpc288x_erase,
+	.protect = lpc288x_protect,
+	.write = lpc288x_write,
+	.probe = lpc288x_probe,
+	.auto_probe = lpc288x_probe,
+	.erase_check = lpc288x_erase_check,
+	.protect_check = lpc288x_protect_check,
+	.info = lpc288x_info,
+};
diff --git a/src/flash/nor/lpc2900.c b/src/flash/nor/lpc2900.c
index d39b2dd..360c14d 100644
--- a/src/flash/nor/lpc2900.c
+++ b/src/flash/nor/lpc2900.c
@@ -951,14 +951,14 @@ COMMAND_HANDLER(lpc2900_handle_secure_jtag_command)
 static const struct command_registration lpc2900_exec_command_handlers[] = {
 	{
 		.name = "signature",
-		.handler = &lpc2900_handle_signature_command,
+		.handler = lpc2900_handle_signature_command,
 		.mode = COMMAND_EXEC,
 		.usage = "bank_id",
 		.help = "Calculate and display signature of flash bank.",
 	},
 	{
 		.name = "read_custom",
-		.handler = &lpc2900_handle_read_custom_command,
+		.handler = lpc2900_handle_read_custom_command,
 		.mode = COMMAND_EXEC,
 		.usage = "bank_id filename",
 		.help = "Copies 912 bytes of customer information "
@@ -966,14 +966,14 @@ static const struct command_registration lpc2900_exec_command_handlers[] = {
 	},
 	{
 		.name = "password",
-		.handler = &lpc2900_handle_password_command,
+		.handler = lpc2900_handle_password_command,
 		.mode = COMMAND_EXEC,
 		.usage = "bank_id password",
 		.help = "Enter fixed password to enable 'dangerous' options.",
 	},
 	{
 		.name = "write_custom",
-		.handler = &lpc2900_handle_write_custom_command,
+		.handler = lpc2900_handle_write_custom_command,
 		.mode = COMMAND_EXEC,
 		.usage = "bank_id filename ('bin'|'ihex'|'elf'|'s19')",
 		.help = "Copies 912 bytes of customer info from file "
@@ -981,7 +981,7 @@ static const struct command_registration lpc2900_exec_command_handlers[] = {
 	},
 	{
 		.name = "secure_sector",
-		.handler = &lpc2900_handle_secure_sector_command,
+		.handler = lpc2900_handle_secure_sector_command,
 		.mode = COMMAND_EXEC,
 		.usage = "bank_id first_sector last_sector",
 		.help = "Activate sector security for a range of sectors.  "
@@ -989,7 +989,7 @@ static const struct command_registration lpc2900_exec_command_handlers[] = {
 	},
 	{
 		.name = "secure_jtag",
-		.handler = &lpc2900_handle_secure_jtag_command,
+		.handler = lpc2900_handle_secure_jtag_command,
 		.mode = COMMAND_EXEC,
 		.usage = "bank_id",
 		.help = "Disable the JTAG port.  "
diff --git a/src/flash/nor/ocl.c b/src/flash/nor/ocl.c
index 961537e..5d93724 100644
--- a/src/flash/nor/ocl.c
+++ b/src/flash/nor/ocl.c
@@ -348,14 +348,14 @@ static int ocl_auto_probe(struct flash_bank *bank)
 }
 
 struct flash_driver ocl_flash = {
-		.name = "ocl",
-		.flash_bank_command = &ocl_flash_bank_command,
-		.erase = &ocl_erase,
-		.protect = &ocl_protect,
-		.write = &ocl_write,
-		.probe = &ocl_probe,
-		.erase_check = &ocl_erase_check,
-		.protect_check = &ocl_protect_check,
-		.info = &ocl_info,
-		.auto_probe = &ocl_auto_probe,
-	};
+	.name = "ocl",
+	.flash_bank_command = ocl_flash_bank_command,
+	.erase = ocl_erase,
+	.protect = ocl_protect,
+	.write = ocl_write,
+	.probe = ocl_probe,
+	.erase_check = ocl_erase_check,
+	.protect_check = ocl_protect_check,
+	.info = ocl_info,
+	.auto_probe = ocl_auto_probe,
+};
diff --git a/src/flash/nor/pic32mx.c b/src/flash/nor/pic32mx.c
index 7d98af3..1f66346 100644
--- a/src/flash/nor/pic32mx.c
+++ b/src/flash/nor/pic32mx.c
@@ -886,13 +886,13 @@ COMMAND_HANDLER(pic32mx_handle_pgm_word_command)
 static const struct command_registration pic32mx_exec_command_handlers[] = {
 	{
 		.name = "chip_erase",
-		.handler = &pic32mx_handle_chip_erase_command,
+		.handler = pic32mx_handle_chip_erase_command,
 		.mode = COMMAND_EXEC,
 		.help = "erase device",
 	},
 	{
 		.name = "pgm_word",
-		.handler = &pic32mx_handle_pgm_word_command,
+		.handler = pic32mx_handle_pgm_word_command,
 		.mode = COMMAND_EXEC,
 		.help = "program a word",
 	},
@@ -909,15 +909,15 @@ static const struct command_registration pic32mx_command_handlers[] = {
 };
 
 struct flash_driver pic32mx_flash = {
-		.name = "pic32mx",
-		.commands = pic32mx_command_handlers,
-		.flash_bank_command = &pic32mx_flash_bank_command,
-		.erase = &pic32mx_erase,
-		.protect = &pic32mx_protect,
-		.write = &pic32mx_write,
-		.probe = &pic32mx_probe,
-		.auto_probe = &pic32mx_auto_probe,
-		.erase_check = &default_flash_mem_blank_check,
-		.protect_check = &pic32mx_protect_check,
-		.info = &pic32mx_info,
-	};
+	.name = "pic32mx",
+	.commands = pic32mx_command_handlers,
+	.flash_bank_command = pic32mx_flash_bank_command,
+	.erase = pic32mx_erase,
+	.protect = pic32mx_protect,
+	.write = pic32mx_write,
+	.probe = pic32mx_probe,
+	.auto_probe = pic32mx_auto_probe,
+	.erase_check = default_flash_mem_blank_check,
+	.protect_check = pic32mx_protect_check,
+	.info = pic32mx_info,
+};
diff --git a/src/flash/nor/stellaris.c b/src/flash/nor/stellaris.c
index 8d35f9b..107b1c6 100644
--- a/src/flash/nor/stellaris.c
+++ b/src/flash/nor/stellaris.c
@@ -1173,7 +1173,7 @@ COMMAND_HANDLER(stellaris_handle_mass_erase_command)
 static const struct command_registration stellaris_exec_command_handlers[] = {
 	{
 		.name = "mass_erase",
-		.handler = &stellaris_handle_mass_erase_command,
+		.handler = stellaris_handle_mass_erase_command,
 		.mode = COMMAND_EXEC,
 		.help = "erase entire device",
 	},
diff --git a/src/flash/nor/stm32x.c b/src/flash/nor/stm32x.c
index 75dcf3b..eaa3a0e 100644
--- a/src/flash/nor/stm32x.c
+++ b/src/flash/nor/stm32x.c
@@ -1193,35 +1193,35 @@ COMMAND_HANDLER(stm32x_handle_mass_erase_command)
 static const struct command_registration stm32x_exec_command_handlers[] = {
 	{
 		.name = "lock",
-		.handler = &stm32x_handle_lock_command,
+		.handler = stm32x_handle_lock_command,
 		.mode = COMMAND_EXEC,
 		.usage = "bank_id",
 		.help = "Lock entire flash device.",
 	},
 	{
 		.name = "unlock",
-		.handler = &stm32x_handle_unlock_command,
+		.handler = stm32x_handle_unlock_command,
 		.mode = COMMAND_EXEC,
 		.usage = "bank_id",
 		.help = "Unlock entire protected flash device.",
 	},
 	{
 		.name = "mass_erase",
-		.handler = &stm32x_handle_mass_erase_command,
+		.handler = stm32x_handle_mass_erase_command,
 		.mode = COMMAND_EXEC,
 		.usage = "bank_id",
 		.help = "Erase entire flash device.",
 	},
 	{
 		.name = "options_read",
-		.handler = &stm32x_handle_options_read_command,
+		.handler = stm32x_handle_options_read_command,
 		.mode = COMMAND_EXEC,
 		.usage = "bank_id",
 		.help = "Read and display device option byte.",
 	},
 	{
 		.name = "options_write",
-		.handler = &stm32x_handle_options_write_command,
+		.handler = stm32x_handle_options_write_command,
 		.mode = COMMAND_EXEC,
 		.usage = "bank_id ('SWWDG'|'HWWDG') "
 			"('RSTSTNDBY'|'NORSTSTNDBY') "
@@ -1241,15 +1241,15 @@ static const struct command_registration stm32x_command_handlers[] = {
 };
 
 struct flash_driver stm32x_flash = {
-		.name = "stm32x",
-		.commands = stm32x_command_handlers,
-		.flash_bank_command = &stm32x_flash_bank_command,
-		.erase = &stm32x_erase,
-		.protect = &stm32x_protect,
-		.write = &stm32x_write,
-		.probe = &stm32x_probe,
-		.auto_probe = &stm32x_auto_probe,
-		.erase_check = &default_flash_mem_blank_check,
-		.protect_check = &stm32x_protect_check,
-		.info = &stm32x_info,
-	};
+	.name = "stm32x",
+	.commands = stm32x_command_handlers,
+	.flash_bank_command = stm32x_flash_bank_command,
+	.erase = stm32x_erase,
+	.protect = stm32x_protect,
+	.write = stm32x_write,
+	.probe = stm32x_probe,
+	.auto_probe = stm32x_auto_probe,
+	.erase_check = default_flash_mem_blank_check,
+	.protect_check = stm32x_protect_check,
+	.info = stm32x_info,
+};
diff --git a/src/flash/nor/str7x.c b/src/flash/nor/str7x.c
index 040097a..a2e27da 100644
--- a/src/flash/nor/str7x.c
+++ b/src/flash/nor/str7x.c
@@ -676,7 +676,7 @@ COMMAND_HANDLER(str7x_handle_disable_jtag_command)
 static const struct command_registration str7x_exec_command_handlers[] = {
 	{
 		.name = "disable_jtag",
-		.handler = &str7x_handle_disable_jtag_command,
+		.handler = str7x_handle_disable_jtag_command,
 		.mode = COMMAND_EXEC,
 		.help = "disable jtag access",
 	},
@@ -693,15 +693,15 @@ static const struct command_registration str7x_command_handlers[] = {
 };
 
 struct flash_driver str7x_flash = {
-		.name = "str7x",
-		.commands = str7x_command_handlers,
-		.flash_bank_command = &str7x_flash_bank_command,
-		.erase = &str7x_erase,
-		.protect = &str7x_protect,
-		.write = &str7x_write,
-		.probe = &str7x_probe,
-		.auto_probe = &str7x_probe,
-		.erase_check = &default_flash_blank_check,
-		.protect_check = &str7x_protect_check,
-		.info = &str7x_info,
-	};
+	.name = "str7x",
+	.commands = str7x_command_handlers,
+	.flash_bank_command = str7x_flash_bank_command,
+	.erase = str7x_erase,
+	.protect = str7x_protect,
+	.write = str7x_write,
+	.probe = str7x_probe,
+	.auto_probe = str7x_probe,
+	.erase_check = default_flash_blank_check,
+	.protect_check = str7x_protect_check,
+	.info = str7x_info,
+};
diff --git a/src/flash/nor/str9x.c b/src/flash/nor/str9x.c
index d0c1278..0875851 100644
--- a/src/flash/nor/str9x.c
+++ b/src/flash/nor/str9x.c
@@ -668,7 +668,7 @@ COMMAND_HANDLER(str9x_handle_flash_config_command)
 static const struct command_registration str9x_config_command_handlers[] = {
 	{
 		.name = "flash_config",
-		.handler = &str9x_handle_flash_config_command,
+		.handler = str9x_handle_flash_config_command,
 		.mode = COMMAND_EXEC,
 		.help = "Configure str9x flash controller, prior to "
 			"programming the flash.",
@@ -687,15 +687,15 @@ static const struct command_registration str9x_command_handlers[] = {
 };
 
 struct flash_driver str9x_flash = {
-		.name = "str9x",
-		.commands = str9x_command_handlers,
-		.flash_bank_command = &str9x_flash_bank_command,
-		.erase = &str9x_erase,
-		.protect = &str9x_protect,
-		.write = &str9x_write,
-		.probe = &str9x_probe,
-		.auto_probe = &str9x_probe,
-		.erase_check = &default_flash_blank_check,
-		.protect_check = &str9x_protect_check,
-		.info = &str9x_info,
-	};
+	.name = "str9x",
+	.commands = str9x_command_handlers,
+	.flash_bank_command = str9x_flash_bank_command,
+	.erase = str9x_erase,
+	.protect = str9x_protect,
+	.write = str9x_write,
+	.probe = str9x_probe,
+	.auto_probe = str9x_probe,
+	.erase_check = default_flash_blank_check,
+	.protect_check = str9x_protect_check,
+	.info = str9x_info,
+};
diff --git a/src/flash/nor/str9xpec.c b/src/flash/nor/str9xpec.c
index 734f2d1..f0e11a5 100644
--- a/src/flash/nor/str9xpec.c
+++ b/src/flash/nor/str9xpec.c
@@ -1244,15 +1244,15 @@ static const struct command_registration str9xpec_command_handlers[] = {
 };
 
 struct flash_driver str9xpec_flash = {
-		.name = "str9xpec",
-		.commands = str9xpec_command_handlers,
-		.flash_bank_command = &str9xpec_flash_bank_command,
-		.erase = &str9xpec_erase,
-		.protect = &str9xpec_protect,
-		.write = &str9xpec_write,
-		.probe = &str9xpec_probe,
-		.auto_probe = &str9xpec_probe,
-		.erase_check = &str9xpec_erase_check,
-		.protect_check = &str9xpec_protect_check,
-		.info = &str9xpec_info,
-	};
+	.name = "str9xpec",
+	.commands = str9xpec_command_handlers,
+	.flash_bank_command = str9xpec_flash_bank_command,
+	.erase = str9xpec_erase,
+	.protect = str9xpec_protect,
+	.write = str9xpec_write,
+	.probe = str9xpec_probe,
+	.auto_probe = str9xpec_probe,
+	.erase_check = str9xpec_erase_check,
+	.protect_check = str9xpec_protect_check,
+	.info = str9xpec_info,
+};
diff --git a/src/flash/nor/tcl.c b/src/flash/nor/tcl.c
index cf40a81..a40230b 100644
--- a/src/flash/nor/tcl.c
+++ b/src/flash/nor/tcl.c
@@ -924,7 +924,7 @@ COMMAND_HANDLER(handle_flash_init_command)
 static const struct command_registration flash_config_command_handlers[] = {
 	{
 		.name = "bank",
-		.handler = &handle_flash_bank_command,
+		.handler = handle_flash_bank_command,
 		.mode = COMMAND_CONFIG,
 		.usage = "bank_id driver_name base_address size_bytes "
 			"chip_width_bytes bus_width_bytes target "
@@ -935,19 +935,19 @@ static const struct command_registration flash_config_command_handlers[] = {
 	{
 		.name = "init",
 		.mode = COMMAND_CONFIG,
-		.handler = &handle_flash_init_command,
+		.handler = handle_flash_init_command,
 		.help = "Initialize flash devices.",
 	},
 	{
 		.name = "banks",
 		.mode = COMMAND_ANY,
-		.handler = &handle_flash_banks_command,
+		.handler = handle_flash_banks_command,
 		.help = "Display table with information about flash banks.",
 	},
 	{
 		.name = "list",
 		.mode = COMMAND_ANY,
-		.jim_handler = &jim_flash_list,
+		.jim_handler = jim_flash_list,
 		.help = "Returns a list of details about the flash banks.",
 	},
 	COMMAND_REGISTRATION_DONE
diff --git a/src/flash/nor/tms470.c b/src/flash/nor/tms470.c
index 7efcbd4..af635d4 100644
--- a/src/flash/nor/tms470.c
+++ b/src/flash/nor/tms470.c
@@ -821,19 +821,19 @@ static int tms470_erase_sector(struct flash_bank *bank, int sector)
 static const struct command_registration tms470_any_command_handlers[] = {
 	{
 		.name = "flash_keyset",
-		.handler = &tms470_handle_flash_keyset_command,
+		.handler = tms470_handle_flash_keyset_command,
 		.mode = COMMAND_ANY,
 		.help = "tms470 flash_keyset <key0> <key1> <key2> <key3>",
 	},
 	{
 		.name = "osc_megahertz",
-		.handler = &tms470_handle_osc_megahertz_command,
+		.handler = tms470_handle_osc_megahertz_command,
 		.mode = COMMAND_ANY,
 		.help = "tms470 osc_megahertz <MHz>",
 	},
 	{
 		.name = "plldis",
-		.handler = &tms470_handle_plldis_command,
+		.handler = tms470_handle_plldis_command,
 		.mode = COMMAND_ANY,
 		.help = "tms470 plldis <0/1>",
 	},
@@ -1258,15 +1258,15 @@ FLASH_BANK_COMMAND_HANDLER(tms470_flash_bank_command)
 }
 
 struct flash_driver tms470_flash = {
-		.name = "tms470",
-		.commands = tms470_command_handlers,
-		.flash_bank_command = &tms470_flash_bank_command,
-		.erase = &tms470_erase,
-		.protect = &tms470_protect,
-		.write = &tms470_write,
-		.probe = &tms470_probe,
-		.auto_probe = &tms470_auto_probe,
-		.erase_check = &tms470_erase_check,
-		.protect_check = &tms470_protect_check,
-		.info = &tms470_info,
-	};
+	.name = "tms470",
+	.commands = tms470_command_handlers,
+	.flash_bank_command = tms470_flash_bank_command,
+	.erase = tms470_erase,
+	.protect = tms470_protect,
+	.write = tms470_write,
+	.probe = tms470_probe,
+	.auto_probe = tms470_auto_probe,
+	.erase_check = tms470_erase_check,
+	.protect_check = tms470_protect_check,
+	.info = tms470_info,
+};

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/aduc702x.c  |   22 +++++++-------
 src/flash/nor/at91sam3.c  |   24 ++++++++--------
 src/flash/nor/avrf.c      |   26 +++++++++---------
 src/flash/nor/cfi.c       |   22 +++++++-------
 src/flash/nor/ecos.c      |   22 +++++++-------
 src/flash/nor/faux.c      |   24 ++++++++--------
 src/flash/nor/lpc2000.c   |   28 +++++++++----------
 src/flash/nor/lpc288x.c   |   22 +++++++-------
 src/flash/nor/lpc2900.c   |   12 ++++----
 src/flash/nor/ocl.c       |   22 +++++++-------
 src/flash/nor/pic32mx.c   |   28 +++++++++---------
 src/flash/nor/stellaris.c |    2 +-
 src/flash/nor/stm32x.c    |   34 ++++++++++++------------
 src/flash/nor/str7x.c     |   26 +++++++++---------
 src/flash/nor/str9x.c     |   26 +++++++++---------
 src/flash/nor/str9xpec.c  |   24 ++++++++--------
 src/flash/nor/tcl.c       |    8 +++---
 src/flash/nor/tms470.c    |   30 ++++++++++----------
 src/target/arm_adi_v5.c   |   65 +++++++++++++++++++++++++-------------------
 src/target/arm_adi_v5.h   |    4 +-
 src/target/armv7m.c       |   31 +--------------------
 src/target/cortex_m3.c    |    8 +++---
 22 files changed, 244 insertions(+), 266 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From dbrownell at users.sourceforge.net  Sun Jan 31 09:59:32 2010
From: dbrownell at users.sourceforge.net (David Brownell)
Date: Sun, 31 Jan 2010 08:59:32 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-165-ge11ce3e
Message-ID: <E1NbVeZ-0007Y6-A4@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  e11ce3e6b00f02eba9a15673a54f5345eba8398b (commit)
       via  695666d294e7d572bc5799e0cef4fc384b28c733 (commit)
       via  46b6d5bfe644b5f6a1fe50930c850f09a78b5bad (commit)
      from  3d3128a8f5bb15f1d05ac5eb7ecc5e692ae290ce (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit e11ce3e6b00f02eba9a15673a54f5345eba8398b
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sun Jan 31 00:26:21 2010 -0800

    Subject: ADIv5: fix more diagnostics
    
    If the MEM-AP cache is invalid, don't display it; just report that
    invalidity as an error.  (This bug has been observed with "mdw 0 32"
    after just a "reset halt".  Some code is being wrongly bypassed...)
    
    If it's valid, display that cache at DEBUG level, not ERROR.  Also,
    don't assume it's an AHB-AP; it could be another flavor of MEM-AP.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 0e3b349..bfa5cb4 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -321,27 +321,34 @@ int jtagdp_transaction_endcheck(struct swjdp_common *swjdp)
 		}
 	}
 
+	/* REVISIT also STICKYCMP, for pushed comparisons (nyet used) */
+
 	/* Check for STICKYERR and STICKYORUN */
 	if (ctrlstat & (SSTICKYORUN | SSTICKYERR))
 	{
 		LOG_DEBUG("jtag-dp: CTRL/STAT error, 0x%" PRIx32, ctrlstat);
 		/* Check power to debug regions */
 		if ((ctrlstat & 0xf0000000) != 0xf0000000)
-		{
 			 ahbap_debugport_init(swjdp);
-		}
 		else
 		{
 			uint32_t mem_ap_csw, mem_ap_tar;
 
-			/* Print information about last AHBAP access */
-			LOG_ERROR("AHBAP Cached values: dp_select 0x%" PRIx32
-				", ap_csw 0x%" PRIx32 ", ap_tar 0x%" PRIx32,
-				swjdp->dp_select_value, swjdp->ap_csw_value,
-				swjdp->ap_tar_value);
+			/* Maybe print information about last MEM-AP access */
+			if (swjdp->ap_tar_value != (uint32_t) -1)
+				LOG_DEBUG("MEM-AP Cached values: "
+					"ap_bank 0x%" PRIx32
+					", ap_csw 0x%" PRIx32
+					", ap_tar 0x%" PRIx32,
+					swjdp->dp_select_value,
+					swjdp->ap_csw_value,
+					swjdp->ap_tar_value);
+			else
+				LOG_ERROR("Invalid MEM-AP TAR cache!");
+
 			if (ctrlstat & SSTICKYORUN)
-				LOG_ERROR("JTAG-DP OVERRUN - "
-					"check clock or reduce jtag speed");
+				LOG_ERROR("JTAG-DP OVERRUN - check clock, "
+					"memaccess, or reduce jtag speed");
 
 			if (ctrlstat & SSTICKYERR)
 				LOG_ERROR("JTAG-DP STICKY ERROR");

commit 695666d294e7d572bc5799e0cef4fc384b28c733
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 30 22:40:50 2010 -0800

    ADIv5 error checking for Tcl commands
    
    Reject invalid AP numbers (256+) as Tcl operation parameters.
    Shrink one of the overlong lines.
    
    Add my copyright to the ADIv5 code (multiple contributions).
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 0a6a7ef..0e3b349 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -8,6 +8,8 @@
  *   Copyright (C) 2009 by Oyvind Harboe                                   *
  *   oyvind.harboe at zylin.com                                               *
  *                                                                         *
+ *   Copyright (C) 2009-2010 by David Brownell                             *
+ *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
  *   it under the terms of the GNU General Public License as published by  *
  *   the Free Software Foundation; either version 2 of the License, or     *
@@ -1164,7 +1166,8 @@ is_dap_cid_ok(uint32_t cid3, uint32_t cid2, uint32_t cid1, uint32_t cid0)
 			&& ((cid1 & 0x0f) == 0) && cid0 == 0x0d;
 }
 
-int dap_info_command(struct command_context *cmd_ctx, struct swjdp_common *swjdp, int apsel)
+int dap_info_command(struct command_context *cmd_ctx,
+		struct swjdp_common *swjdp, int apsel)
 {
 
 	uint32_t dbgbase, apid;
@@ -1172,6 +1175,10 @@ int dap_info_command(struct command_context *cmd_ctx, struct swjdp_common *swjdp
 	uint8_t mem_ap;
 	uint32_t apselold;
 
+	/* AP address is in bits 31:24 of DP_SELECT */
+	if (apsel >= 256)
+		return ERROR_INVALID_ARGUMENTS;
+
 	apselold = swjdp->apsel;
 	dap_ap_select(swjdp, apsel);
 	dap_ap_read_reg_u32(swjdp, AP_REG_BASE, &dbgbase);
@@ -1524,6 +1531,9 @@ DAP_COMMAND_HANDLER(dap_baseaddr_command)
 		break;
 	case 1:
 		COMMAND_PARSE_NUMBER(u32, CMD_ARGV[0], apsel);
+		/* AP address is in bits 31:24 of DP_SELECT */
+		if (apsel >= 256)
+			return ERROR_INVALID_ARGUMENTS;
 		break;
 	default:
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -1580,6 +1590,9 @@ DAP_COMMAND_HANDLER(dap_apsel_command)
 		break;
 	case 1:
 		COMMAND_PARSE_NUMBER(u32, CMD_ARGV[0], apsel);
+		/* AP address is in bits 31:24 of DP_SELECT */
+		if (apsel >= 256)
+			return ERROR_INVALID_ARGUMENTS;
 		break;
 	default:
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -1606,6 +1619,9 @@ DAP_COMMAND_HANDLER(dap_apid_command)
 		break;
 	case 1:
 		COMMAND_PARSE_NUMBER(u32, CMD_ARGV[0], apsel);
+		/* AP address is in bits 31:24 of DP_SELECT */
+		if (apsel >= 256)
+			return ERROR_INVALID_ARGUMENTS;
 		break;
 	default:
 		return ERROR_COMMAND_SYNTAX_ERROR;

commit 46b6d5bfe644b5f6a1fe50930c850f09a78b5bad
Author: David Brownell <dbrownell at users.sourceforge.net>
Date:   Sat Jan 30 18:08:19 2010 -0800

    ARM ADIv5: fix diagnostics for block writes
    
    They were reporting "read" errors, not "write" errors.
    
    Signed-off-by: David Brownell <dbrownell at users.sourceforge.net>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index b8744d5..0a6a7ef 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -641,9 +641,12 @@ static int mem_ap_write_buf_packed_u16(struct swjdp_common *swjdp,
 
 			if (nbytes < 4)
 			{
-				if (mem_ap_write_buf_u16(swjdp, buffer, nbytes, address) != ERROR_OK)
+				if (mem_ap_write_buf_u16(swjdp, buffer,
+						nbytes, address) != ERROR_OK)
 				{
-					LOG_WARNING("Block read error address 0x%" PRIx32 ", count 0x%x", address, count);
+					LOG_WARNING("Block write error address "
+						"0x%" PRIx32 ", count 0x%x",
+						address, count);
 					return ERROR_JTAG_DEVICE_ERROR;
 				}
 
@@ -665,7 +668,9 @@ static int mem_ap_write_buf_packed_u16(struct swjdp_common *swjdp,
 				dap_ap_write_reg_u32(swjdp, AP_REG_DRW, outvalue);
 				if (jtagdp_transaction_endcheck(swjdp) != ERROR_OK)
 				{
-					LOG_WARNING("Block read error address 0x%" PRIx32 ", count 0x%x", address, count);
+					LOG_WARNING("Block write error address "
+						"0x%" PRIx32 ", count 0x%x",
+						address, count);
 					return ERROR_JTAG_DEVICE_ERROR;
 				}
 			}
@@ -736,7 +741,9 @@ static int mem_ap_write_buf_packed_u8(struct swjdp_common *swjdp,
 			{
 				if (mem_ap_write_buf_u8(swjdp, buffer, nbytes, address) != ERROR_OK)
 				{
-					LOG_WARNING("Block read error address 0x%" PRIx32 ", count 0x%x", address, count);
+					LOG_WARNING("Block write error address "
+						"0x%" PRIx32 ", count 0x%x",
+						address, count);
 					return ERROR_JTAG_DEVICE_ERROR;
 				}
 
@@ -758,7 +765,9 @@ static int mem_ap_write_buf_packed_u8(struct swjdp_common *swjdp,
 				dap_ap_write_reg_u32(swjdp, AP_REG_DRW, outvalue);
 				if (jtagdp_transaction_endcheck(swjdp) != ERROR_OK)
 				{
-					LOG_WARNING("Block read error address 0x%" PRIx32 ", count 0x%x", address, count);
+					LOG_WARNING("Block write error address "
+						"0x%" PRIx32 ", count 0x%x",
+						address, count);
 					return ERROR_JTAG_DEVICE_ERROR;
 				}
 			}

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm_adi_v5.c |   62 +++++++++++++++++++++++++++++++++++-----------
 1 files changed, 47 insertions(+), 15 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Sun Jan 31 15:18:04 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Sun, 31 Jan 2010 14:18:04 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-166-gf68dff6
Message-ID: <E1Nbaco-0003ox-AO@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  f68dff66904321392c3137db7eb40e8633c2e507 (commit)
      from  e11ce3e6b00f02eba9a15673a54f5345eba8398b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit f68dff66904321392c3137db7eb40e8633c2e507
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Thu Jan 21 16:41:54 2010 +0100

    telnet: fix strage blank spaces at beginning of telnet lines
    
    Sometimes we saw two strange blank spaces at the beginning
    of the telnet lines.
    
    progress
      ogress
    >
    
    This patch fixes this problem:
    
    progress
    progress
    >
    
    The code changes are *reasonably* clean, but perhaps it could be
    made a bit more elegant, but I didn't want to change things after
    I finished diagnosis/testing & submitting the patch.
    
    The problem was that logging can send the text and the newline
    separately in two different requests and the telnet code would
    incorrectly remove the prompt from the end of a line.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/server/telnet_server.c b/src/server/telnet_server.c
index 6f26f0a..94c8943 100644
--- a/src/server/telnet_server.c
+++ b/src/server/telnet_server.c
@@ -62,7 +62,6 @@ int telnet_prompt(struct connection *connection)
 {
 	struct telnet_connection *t_con = connection->priv;
 
-	telnet_write(connection, "\r", 1); /* the prompt is always placed at the line beginning */
 	return telnet_write(connection, t_con->prompt, strlen(t_con->prompt));
 }
 
@@ -116,10 +115,12 @@ void telnet_log_callback(void *priv, const char *file, unsigned line,
 	}
 
 	/* clear the command line */
-	telnet_write(connection, "\r", 1);
+	for (i = strlen(t_con->prompt) + t_con->line_size; i > 0; i -= 16)
+		telnet_write(connection, "\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b", i > 16 ? 16 : i);
 	for (i = strlen(t_con->prompt) + t_con->line_size; i > 0; i -= 16)
 		telnet_write(connection, "                ", i > 16 ? 16 : i);
-	telnet_write(connection, "\r", 1);
+	for (i = strlen(t_con->prompt) + t_con->line_size; i > 0; i -= 16)
+		telnet_write(connection, "\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b", i > 16 ? 16 : i);
 
 	/* output the message */
 	telnet_outputline(connection, string);
@@ -160,6 +161,7 @@ int telnet_new_connection(struct connection *connection)
 		telnet_write(connection, "\r\n", 2);
 	}
 
+	telnet_write(connection, "\r", 1); /* the prompt is always placed at the line beginning */
 	telnet_prompt(connection);
 
 	/* initialize history */
@@ -331,6 +333,7 @@ int telnet_input(struct connection *connection)
 							if (retval == ERROR_COMMAND_CLOSE_CONNECTION)
 								return ERROR_SERVER_REMOTE_CLOSED;
 
+							telnet_write(connection, "\r", 1); /* the prompt is always placed at the line beginning */
 							retval = telnet_prompt(connection);
 							if (retval == ERROR_SERVER_REMOTE_CLOSED)
 								return ERROR_SERVER_REMOTE_CLOSED;

-----------------------------------------------------------------------

Summary of changes:
 src/server/telnet_server.c |    9 ++++++---
 1 files changed, 6 insertions(+), 3 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Sun Jan 31 19:31:19 2010
From: gowinex at users.sourceforge.net (yvind Harboe)
Date: Sun, 31 Jan 2010 18:31:19 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-rc1-167-g02731cf
Message-ID: <E1NbeZt-0003Gj-6F@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  02731cf78b3663739e3755295a4239f2658a3fdc (commit)
      from  f68dff66904321392c3137db7eb40e8633c2e507 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 02731cf78b3663739e3755295a4239f2658a3fdc
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sun Jan 31 15:48:14 2010 +0100

    build: fix problems with "struct stat" not being defined under eCos
    
    Include <sys/stat.h> according to
    http://www.opengroup.org/onlinepubs/000095399/functions/stat.html
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/arm_semihosting.c b/src/target/arm_semihosting.c
index 8db60a5..c41c5a0 100644
--- a/src/target/arm_semihosting.c
+++ b/src/target/arm_semihosting.c
@@ -43,6 +43,7 @@
 #include "arm_semihosting.h"
 #include <helper/binarybuffer.h>
 #include <helper/log.h>
+#include <sys/stat.h>
 
 static int open_modeflags[12] = {
 	O_RDONLY,

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm_semihosting.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From david-b at pacbell.net  Mon Jan 18 09:09:28 2010
From: david-b at pacbell.net (David Brownell)
Date: Mon, 18 Jan 2010 08:09:28 -0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated.  v0.4.0-rc1-117-g0b641da
In-Reply-To: <c09652431001172343v1e01fd0cxcd173cd11f9cc4f5@mail.gmail.com>
References: <E1NWmCc-0006VU-W2@sfp-scmshell-1.v30.ch3.sourceforge.com>
	<c09652431001172343v1e01fd0cxcd173cd11f9cc4f5@mail.gmail.com>
Message-ID: <201001180009.25402.david-b@pacbell.net>

On Sunday 17 January 2010, ?yvind Harboe wrote:
> I would have like to see this comment in the *code* rather than
> the commit message though....

-ENOPATCH.  :)


> An interesting feature of an IDE would be to be able to display/hide
> commit messages for code...

Easily done with gitweb.  I think at least one "git blame" cousin
supports that too.





