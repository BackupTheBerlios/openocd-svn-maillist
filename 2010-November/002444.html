<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-620-g1892a2b
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openocd-svn/2010-November/index.html" >
   <LINK REL="made" HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.4.0-620-g1892a2b&In-Reply-To=%3CE1PKnTa-00016z-Bm%40sfp-scmshell-1.v30.ch3.sourceforge.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002443.html">
   <LINK REL="Next"  HREF="002445.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-620-g1892a2b</H1>
    <B>&#216;yvind Harboe</B> 
    <A HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.4.0-620-g1892a2b&In-Reply-To=%3CE1PKnTa-00016z-Bm%40sfp-scmshell-1.v30.ch3.sourceforge.com%3E"
       TITLE="[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-620-g1892a2b">gowinex at users.sourceforge.net
       </A><BR>
    <I>Tue Nov 23 08:39:41 CET 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002443.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-616-g06b4903
</A></li>
        <LI>Next message: <A HREF="002445.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-621-gc606d85
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2444">[ date ]</a>
              <a href="thread.html#2444">[ thread ]</a>
              <a href="subject.html#2444">[ subject ]</a>
              <a href="author.html#2444">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Main OpenOCD repository&quot;.

The branch, master has been updated
       via  1892a2b51009fb15bb1c2c7b10c125d671a5c3bf (commit)
       via  42082f7c23ded282489e8ac6ec52fe94fa097cde (commit)
       via  4bbdf966d4afbf279550c7115c64e60d94ca3fe8 (commit)
       via  e6fc371e2e86a00c7e84004b94c4b8374634953d (commit)
      from  06b4903e3e932a5d21d20adba551c36c296496ce (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 1892a2b51009fb15bb1c2c7b10c125d671a5c3bf
Author: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;
Date:   Mon Nov 22 12:25:09 2010 +0800

    FLASH/NOR: Rename spearsmi.c to stmsmi.c
    
    Signed-off-by: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index e281c22..e1028ff 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -21,7 +21,7 @@ NOR_DRIVERS = \
 	non_cfi.c \
 	ocl.c \
 	pic32mx.c \
-	spearsmi.c \
+	stmsmi.c \
 	stellaris.c \
 	stm32x.c \
 	str7x.c \
diff --git a/src/flash/nor/spearsmi.c b/src/flash/nor/stmsmi.c
similarity index 100%
rename from src/flash/nor/spearsmi.c
rename to src/flash/nor/stmsmi.c

commit 42082f7c23ded282489e8ac6ec52fe94fa097cde
Author: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;
Date:   Mon Nov 22 12:21:31 2010 +0800

    FLASH/NOR: rename from spearsmi to stmsmi
    
    STMicroelectronics controller SMI is not SPEAr specific.
    Rename it and change name to every symbol in the code.
    
    Signed-off-by: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 2727a0b..70d789a 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -4252,14 +4252,15 @@ flash bank $_FLASHNAME cfi 0x00000000 0x02000000 2 4 $_TARGETNAME
 @c &quot;cfi part_id&quot; disabled
 @end deffn
 
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">- at deffn</A> {Flash Driver} spearsmi
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">- at cindex</A> SPEAr Serial Memory Interface
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at deffn</A> {Flash Driver} stmsmi
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at cindex</A> STMicroelectronics Serial Memory Interface
 @cindex SMI
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">- at cindex</A> spearsmi
-All members of SPEAr MPU family from STMicroelectronics include a
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at cindex</A> stmsmi
+Some devices form STMicroelectronics (e.g. STR75x MCU family,
+SPEAr MPU family) include a proprietary
 ``Serial Memory Interface'' (SMI) controller able to drive external
 SPI flash devices.
-Depending on specific MPU and board configuration, up to 4 external
+Depending on specific device and board configuration, up to 4 external
 flash devices can be connected.
 
 SMI makes the flash content directly accessible in the CPU address
@@ -4274,7 +4275,7 @@ All other parameters are ignored. Additional information, like
 flash size, are detected automatically.
 
 @example
-flash bank $_FLASHNAME spearsmi 0xf8000000 0 0 0 $_TARGETNAME
+flash bank $_FLASHNAME stmsmi 0xf8000000 0 0 0 $_TARGETNAME
 @end example
 
 @end deffn
diff --git a/src/flash/nor/drivers.c b/src/flash/nor/drivers.c
index f89e3f0..a1a60b1 100644
--- a/src/flash/nor/drivers.c
+++ b/src/flash/nor/drivers.c
@@ -40,7 +40,7 @@ extern struct flash_driver pic32mx_flash;
 extern struct flash_driver avr_flash;
 extern struct flash_driver faux_flash;
 extern struct flash_driver virtual_flash;
-extern struct flash_driver spearsmi_flash;
+extern struct flash_driver stmsmi_flash;
 
 /**
  * The list of built-in flash drivers.
@@ -66,7 +66,7 @@ static struct flash_driver *flash_drivers[] = {
 	&amp;avr_flash,
 	&amp;faux_flash,
 	&amp;virtual_flash,
-	&amp;spearsmi_flash,
+	&amp;stmsmi_flash,
 	NULL,
 };
 
diff --git a/src/flash/nor/spearsmi.c b/src/flash/nor/spearsmi.c
index 10b5403..c9a1672 100644
--- a/src/flash/nor/spearsmi.c
+++ b/src/flash/nor/spearsmi.c
@@ -17,7 +17,7 @@
  *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
  ***************************************************************************/
 
-/* SPEAr Serial Memory Interface (SMI) controller is a SPI bus controller
+/* STM Serial Memory Interface (SMI) controller is a SPI bus controller
  * specifically designed for SPI memories.
  * Only SPI &quot;mode 3&quot; (CPOL=1 and CPHA=1) is supported.
  * Two working modes are available:
@@ -117,7 +117,7 @@
 #define SMI_PROBE_TIMEOUT (100)
 #define SMI_MAX_TIMEOUT  (3000)
 
-struct spearsmi_flash_bank
+struct stmsmi_flash_bank
 {
 	int probed;
 	uint32_t io_base;
@@ -184,41 +184,41 @@ static struct flash_device flash_devices[] = {
 	FLASH_ID(NULL,             0,    0,          0,     0,       0)
 };
 
-struct spearsmi_target {
+struct stmsmi_target {
 	char *name;
 	uint32_t tap_idcode;
 	uint32_t smi_base;
 	uint32_t io_base;
 };
 
-static struct spearsmi_target target_devices[] = {
+static struct stmsmi_target target_devices[] = {
 	/* name,          tap_idcode, smi_base,   io_base */
 	{ &quot;SPEAr3xx/6xx&quot;, 0x07926041, 0xf8000000, 0xfc000000 },
 	{ &quot;STR75x&quot;,       0x4f1f0041, 0x80000000, 0x90000000 },
 	{ NULL,           0,          0,          0 }
 };
 
-FLASH_BANK_COMMAND_HANDLER(spearsmi_flash_bank_command)
+FLASH_BANK_COMMAND_HANDLER(stmsmi_flash_bank_command)
 {
-	struct spearsmi_flash_bank *spearsmi_info;
+	struct stmsmi_flash_bank *stmsmi_info;
 
 	LOG_DEBUG(__FUNCTION__);
 
 	if (CMD_ARGC &lt; 6)
 	{
-		LOG_WARNING(&quot;incomplete flash_bank spearsmi configuration&quot;);
+		LOG_WARNING(&quot;incomplete flash_bank stmsmi configuration&quot;);
 		return ERROR_FLASH_BANK_INVALID;
 	}
 
-	spearsmi_info = malloc(sizeof(struct spearsmi_flash_bank));
-	if (spearsmi_info == NULL)
+	stmsmi_info = malloc(sizeof(struct stmsmi_flash_bank));
+	if (stmsmi_info == NULL)
 	{
 		LOG_ERROR(&quot;not enough memory&quot;);
 		return ERROR_FAIL;
 	}
 
-	bank-&gt;driver_priv = spearsmi_info;
-	spearsmi_info-&gt;probed = 0;
+	bank-&gt;driver_priv = stmsmi_info;
+	stmsmi_info-&gt;probed = 0;
 
 	return ERROR_OK;
 }
@@ -249,14 +249,14 @@ static int poll_tff(struct target *target, uint32_t io_base, int timeout)
 static int read_status_reg(struct flash_bank *bank, uint32_t *status)
 {
 	struct target *target = bank-&gt;target;
-	struct spearsmi_flash_bank *spearsmi_info = bank-&gt;driver_priv;
-	uint32_t io_base = spearsmi_info-&gt;io_base;
+	struct stmsmi_flash_bank *stmsmi_info = bank-&gt;driver_priv;
+	uint32_t io_base = stmsmi_info-&gt;io_base;
 
 	/* clear transmit finished flag */
 	SMI_CLEAR_TFF();
 
 	/* Read status */
-	SMI_WRITE_REG(SMI_CR2, spearsmi_info-&gt;bank_num | SMI_RSR);
+	SMI_WRITE_REG(SMI_CR2, stmsmi_info-&gt;bank_num | SMI_RSR);
 
 	/* Poll transmit finished flag */
 	SMI_POLL_TFF(SMI_CMD_TIMEOUT);
@@ -302,8 +302,8 @@ static int wait_till_ready(struct flash_bank *bank, int timeout)
 static int smi_write_enable(struct flash_bank *bank)
 {
 	struct target *target = bank-&gt;target;
-	struct spearsmi_flash_bank *spearsmi_info = bank-&gt;driver_priv;
-	uint32_t io_base = spearsmi_info-&gt;io_base;
+	struct stmsmi_flash_bank *stmsmi_info = bank-&gt;driver_priv;
+	uint32_t io_base = stmsmi_info-&gt;io_base;
 	uint32_t status;
 	int retval;
 
@@ -314,7 +314,7 @@ static int smi_write_enable(struct flash_bank *bank)
 	SMI_CLEAR_TFF();
 
 	/* Send write enable command */
-	SMI_WRITE_REG(SMI_CR2, spearsmi_info-&gt;bank_num | SMI_WE);
+	SMI_WRITE_REG(SMI_CR2, stmsmi_info-&gt;bank_num | SMI_WE);
 
 	/* Poll transmit finished flag */
 	SMI_POLL_TFF(SMI_CMD_TIMEOUT);
@@ -334,7 +334,7 @@ static int smi_write_enable(struct flash_bank *bank)
 	return ERROR_OK;
 }
 
-static uint32_t erase_command(struct spearsmi_flash_bank *spearsmi_info,
+static uint32_t erase_command(struct stmsmi_flash_bank *stmsmi_info,
 	uint32_t offset)
 {
 	union {
@@ -342,7 +342,7 @@ static uint32_t erase_command(struct spearsmi_flash_bank *spearsmi_info,
 		uint8_t x[4];
 	} cmd;
 
-	cmd.x[0] = spearsmi_info-&gt;dev-&gt;erase_cmd;
+	cmd.x[0] = stmsmi_info-&gt;dev-&gt;erase_cmd;
 	cmd.x[1] = offset &gt;&gt; 16;
 	cmd.x[2] = offset &gt;&gt; 8;
 	cmd.x[3] = offset;
@@ -353,8 +353,8 @@ static uint32_t erase_command(struct spearsmi_flash_bank *spearsmi_info,
 static int smi_erase_sector(struct flash_bank *bank, int sector)
 {
 	struct target *target = bank-&gt;target;
-	struct spearsmi_flash_bank *spearsmi_info = bank-&gt;driver_priv;
-	uint32_t io_base = spearsmi_info-&gt;io_base;
+	struct stmsmi_flash_bank *stmsmi_info = bank-&gt;driver_priv;
+	uint32_t io_base = stmsmi_info-&gt;io_base;
 	uint32_t cmd;
 	int retval;
 
@@ -369,9 +369,9 @@ static int smi_erase_sector(struct flash_bank *bank, int sector)
 	SMI_CLEAR_TFF();
 
 	/* send SPI command &quot;block erase&quot; */
-	cmd = erase_command(spearsmi_info, bank-&gt;sectors[sector].offset);
+	cmd = erase_command(stmsmi_info, bank-&gt;sectors[sector].offset);
 	SMI_WRITE_REG(SMI_TR, cmd);
-	SMI_WRITE_REG(SMI_CR2, spearsmi_info-&gt;bank_num | SMI_SEND | SMI_TX_LEN_4);
+	SMI_WRITE_REG(SMI_CR2, stmsmi_info-&gt;bank_num | SMI_SEND | SMI_TX_LEN_4);
 
 	/* Poll transmit finished flag */
 	SMI_POLL_TFF(SMI_CMD_TIMEOUT);
@@ -384,11 +384,11 @@ static int smi_erase_sector(struct flash_bank *bank, int sector)
 	return ERROR_OK;
 }
 
-static int spearsmi_erase(struct flash_bank *bank, int first, int last)
+static int stmsmi_erase(struct flash_bank *bank, int first, int last)
 {
 	struct target *target = bank-&gt;target;
-	struct spearsmi_flash_bank *spearsmi_info = bank-&gt;driver_priv;
-	uint32_t io_base = spearsmi_info-&gt;io_base;
+	struct stmsmi_flash_bank *stmsmi_info = bank-&gt;driver_priv;
+	uint32_t io_base = stmsmi_info-&gt;io_base;
 	int retval = ERROR_OK;
 	int sector;
 
@@ -406,7 +406,7 @@ static int spearsmi_erase(struct flash_bank *bank, int first, int last)
 		return ERROR_FLASH_SECTOR_INVALID;
 	}
 
-	if (!(spearsmi_info-&gt;probed))
+	if (!(stmsmi_info-&gt;probed))
 	{
 		LOG_ERROR(&quot;Flash bank not probed&quot;);
 		return ERROR_FLASH_BANK_NOT_PROBED;
@@ -434,7 +434,7 @@ static int spearsmi_erase(struct flash_bank *bank, int first, int last)
 	return retval;
 }
 
-static int spearsmi_protect(struct flash_bank *bank, int set,
+static int stmsmi_protect(struct flash_bank *bank, int set,
 	int first, int last)
 {
 	int sector;
@@ -448,8 +448,8 @@ static int smi_write_buffer(struct flash_bank *bank, uint8_t *buffer,
 	uint32_t address, uint32_t len)
 {
 	struct target *target = bank-&gt;target;
-	struct spearsmi_flash_bank *spearsmi_info = bank-&gt;driver_priv;
-	uint32_t io_base = spearsmi_info-&gt;io_base;
+	struct stmsmi_flash_bank *stmsmi_info = bank-&gt;driver_priv;
+	uint32_t io_base = stmsmi_info-&gt;io_base;
 	int retval;
 
 	LOG_DEBUG(&quot;%s: address=0x%08&quot; PRIx32 &quot; len=0x%08&quot; PRIx32,
@@ -469,12 +469,12 @@ static int smi_write_buffer(struct flash_bank *bank, uint8_t *buffer,
 	return ERROR_OK;
 }
 
-static int spearsmi_write(struct flash_bank *bank, uint8_t *buffer,
+static int stmsmi_write(struct flash_bank *bank, uint8_t *buffer,
 	uint32_t offset, uint32_t count)
 {
 	struct target *target = bank-&gt;target;
-	struct spearsmi_flash_bank *spearsmi_info = bank-&gt;driver_priv;
-	uint32_t io_base = spearsmi_info-&gt;io_base;
+	struct stmsmi_flash_bank *stmsmi_info = bank-&gt;driver_priv;
+	uint32_t io_base = stmsmi_info-&gt;io_base;
 	uint32_t cur_count, page_size, page_offset;
 	int sector;
 	int retval = ERROR_OK;
@@ -488,10 +488,10 @@ static int spearsmi_write(struct flash_bank *bank, uint8_t *buffer,
 		return ERROR_TARGET_NOT_HALTED;
 	}
 
-	if (offset + count &gt; spearsmi_info-&gt;dev-&gt;size_in_bytes)
+	if (offset + count &gt; stmsmi_info-&gt;dev-&gt;size_in_bytes)
 	{
 		LOG_WARNING(&quot;Write pasts end of flash. Extra data discarded.&quot;);
-		count = spearsmi_info-&gt;dev-&gt;size_in_bytes - offset;
+		count = stmsmi_info-&gt;dev-&gt;size_in_bytes - offset;
 	}
 
 	/* Check sector protection */
@@ -509,7 +509,7 @@ static int spearsmi_write(struct flash_bank *bank, uint8_t *buffer,
 		}
 	}
 
-	page_size = spearsmi_info-&gt;dev-&gt;pagesize;
+	page_size = stmsmi_info-&gt;dev-&gt;pagesize;
 
 	/* unaligned buffer head */
 	if (count &gt; 0 &amp;&amp; (offset &amp; 3) != 0)
@@ -564,8 +564,8 @@ err:
 static int read_flash_id(struct flash_bank *bank, uint32_t *id)
 {
 	struct target *target = bank-&gt;target;
-	struct spearsmi_flash_bank *spearsmi_info = bank-&gt;driver_priv;
-	uint32_t io_base = spearsmi_info-&gt;io_base;
+	struct stmsmi_flash_bank *stmsmi_info = bank-&gt;driver_priv;
+	uint32_t io_base = stmsmi_info-&gt;io_base;
 	int retval;
 
 	if (target-&gt;state != TARGET_HALTED)
@@ -588,7 +588,7 @@ static int read_flash_id(struct flash_bank *bank, uint32_t *id)
 	/* Send SPI command &quot;read ID&quot; */
 	SMI_WRITE_REG(SMI_TR, SMI_READ_ID);
 	SMI_WRITE_REG(SMI_CR2,
-		spearsmi_info-&gt;bank_num | SMI_SEND | SMI_RX_LEN_3 | SMI_TX_LEN_1);
+		stmsmi_info-&gt;bank_num | SMI_SEND | SMI_RX_LEN_3 | SMI_TX_LEN_1);
 
 	/* Poll transmit finished flag */
 	SMI_POLL_TFF(SMI_CMD_TIMEOUT);
@@ -601,19 +601,19 @@ static int read_flash_id(struct flash_bank *bank, uint32_t *id)
 	return ERROR_OK;
 }
 
-static int spearsmi_probe(struct flash_bank *bank)
+static int stmsmi_probe(struct flash_bank *bank)
 {
 	struct target *target = bank-&gt;target;
-	struct spearsmi_flash_bank *spearsmi_info = bank-&gt;driver_priv;
+	struct stmsmi_flash_bank *stmsmi_info = bank-&gt;driver_priv;
 	uint32_t io_base;
 	struct flash_sector *sectors;
 	uint32_t id = 0; /* silence uninitialized warning */
-	struct spearsmi_target *target_device;
+	struct stmsmi_target *target_device;
 	int retval;
 
-	if (spearsmi_info-&gt;probed)
+	if (stmsmi_info-&gt;probed)
 		free(bank-&gt;sectors);
-	spearsmi_info-&gt;probed = 0;
+	stmsmi_info-&gt;probed = 0;
 
 	for (target_device=target_devices ; target_device-&gt;name ; ++target_device)
 		if (target_device-&gt;tap_idcode == target-&gt;tap-&gt;idcode)
@@ -628,23 +628,23 @@ static int spearsmi_probe(struct flash_bank *bank)
 	switch (bank-&gt;base - target_device-&gt;smi_base)
 	{
 		case 0:
-			spearsmi_info-&gt;bank_num = SMI_SEL_BANK0;
+			stmsmi_info-&gt;bank_num = SMI_SEL_BANK0;
 			break;
 		case SMI_BANK_SIZE:
-			spearsmi_info-&gt;bank_num = SMI_SEL_BANK1;
+			stmsmi_info-&gt;bank_num = SMI_SEL_BANK1;
 			break;
 		case 2*SMI_BANK_SIZE:
-			spearsmi_info-&gt;bank_num = SMI_SEL_BANK2;
+			stmsmi_info-&gt;bank_num = SMI_SEL_BANK2;
 			break;
 		case 3*SMI_BANK_SIZE:
-			spearsmi_info-&gt;bank_num = SMI_SEL_BANK3;
+			stmsmi_info-&gt;bank_num = SMI_SEL_BANK3;
 			break;
 		default:
 			LOG_ERROR(&quot;Invalid SMI base address 0x%&quot; PRIx32, bank-&gt;base);
 			return ERROR_FAIL;
 	}
 	io_base = target_device-&gt;io_base;
-	spearsmi_info-&gt;io_base = io_base;
+	stmsmi_info-&gt;io_base = io_base;
 
 	LOG_DEBUG(&quot;Valid SMI on device %s at address 0x%&quot; PRIx32,
 		target_device-&gt;name, bank-&gt;base);
@@ -655,28 +655,28 @@ static int spearsmi_probe(struct flash_bank *bank)
 	if (retval != ERROR_OK)
 		return retval;
 
-	spearsmi_info-&gt;dev = NULL;
+	stmsmi_info-&gt;dev = NULL;
 	for (struct flash_device *p = flash_devices; p-&gt;name ; p++)
 		if (p-&gt;device_id == id) {
-			spearsmi_info-&gt;dev = p;
+			stmsmi_info-&gt;dev = p;
 			break;
 		}
 
-	if (!spearsmi_info-&gt;dev)
+	if (!stmsmi_info-&gt;dev)
 	{
 		LOG_ERROR(&quot;Unknown flash device (ID 0x%08&quot; PRIx32 &quot;)&quot;, id);
 		return ERROR_FAIL;
 	}
 
 	LOG_INFO(&quot;Found flash device \'%s\' (ID 0x%08&quot; PRIx32 &quot;)&quot;,
-		spearsmi_info-&gt;dev-&gt;name, spearsmi_info-&gt;dev-&gt;device_id);
+		stmsmi_info-&gt;dev-&gt;name, stmsmi_info-&gt;dev-&gt;device_id);
 
 	/* Set correct size value */
-	bank-&gt;size = spearsmi_info-&gt;dev-&gt;size_in_bytes;
+	bank-&gt;size = stmsmi_info-&gt;dev-&gt;size_in_bytes;
 
 	/* create and fill sectors array */
 	bank-&gt;num_sectors =
-		spearsmi_info-&gt;dev-&gt;size_in_bytes / spearsmi_info-&gt;dev-&gt;sectorsize;
+		stmsmi_info-&gt;dev-&gt;size_in_bytes / stmsmi_info-&gt;dev-&gt;sectorsize;
 	sectors = malloc(sizeof(struct flash_sector) * bank-&gt;num_sectors);
 	if (sectors == NULL)
 	{
@@ -686,62 +686,62 @@ static int spearsmi_probe(struct flash_bank *bank)
 
 	for (int sector = 0; sector &lt; bank-&gt;num_sectors; sector++)
 	{
-		sectors[sector].offset = sector * spearsmi_info-&gt;dev-&gt;sectorsize;
-		sectors[sector].size = spearsmi_info-&gt;dev-&gt;sectorsize;
+		sectors[sector].offset = sector * stmsmi_info-&gt;dev-&gt;sectorsize;
+		sectors[sector].size = stmsmi_info-&gt;dev-&gt;sectorsize;
 		sectors[sector].is_erased = -1;
 		sectors[sector].is_protected = 1;
 	}
 
 	bank-&gt;sectors = sectors;
-	spearsmi_info-&gt;probed = 1;
+	stmsmi_info-&gt;probed = 1;
 	return ERROR_OK;
 }
 
-static int spearsmi_auto_probe(struct flash_bank *bank)
+static int stmsmi_auto_probe(struct flash_bank *bank)
 {
-	struct spearsmi_flash_bank *spearsmi_info = bank-&gt;driver_priv;
-	if (spearsmi_info-&gt;probed)
+	struct stmsmi_flash_bank *stmsmi_info = bank-&gt;driver_priv;
+	if (stmsmi_info-&gt;probed)
 		return ERROR_OK;
-	return spearsmi_probe(bank);
+	return stmsmi_probe(bank);
 }
 
-static int spearsmi_protect_check(struct flash_bank *bank)
+static int stmsmi_protect_check(struct flash_bank *bank)
 {
 	/* Nothing to do. Protection is only handled in SW. */
 	return ERROR_OK;
 }
 
-static int get_spearsmi_info(struct flash_bank *bank, char *buf, int buf_size)
+static int get_stmsmi_info(struct flash_bank *bank, char *buf, int buf_size)
 {
-	struct spearsmi_flash_bank *spearsmi_info = bank-&gt;driver_priv;
+	struct stmsmi_flash_bank *stmsmi_info = bank-&gt;driver_priv;
 	int printed;
 
-	if (!(spearsmi_info-&gt;probed))
+	if (!(stmsmi_info-&gt;probed))
 	{
 		printed = snprintf(buf, buf_size,
-			&quot;\nSPEAr SMI flash bank not probed yet\n&quot;);
+			&quot;\nSMI flash bank not probed yet\n&quot;);
 		return ERROR_OK;
 	}
 
-	printed = snprintf(buf, buf_size, &quot;\nSPEAr SMI flash information:\n&quot;
+	printed = snprintf(buf, buf_size, &quot;\nSMI flash information:\n&quot;
 		&quot;  Device \'%s\' (ID 0x%08x)\n&quot;,
-		spearsmi_info-&gt;dev-&gt;name, spearsmi_info-&gt;dev-&gt;device_id);
+		stmsmi_info-&gt;dev-&gt;name, stmsmi_info-&gt;dev-&gt;device_id);
 	buf += printed;
 	buf_size -= printed;
 
 	return ERROR_OK;
 }
 
-struct flash_driver spearsmi_flash = {
-	.name = &quot;spearsmi&quot;,
-	.flash_bank_command = spearsmi_flash_bank_command,
-	.erase = spearsmi_erase,
-	.protect = spearsmi_protect,
-	.write = spearsmi_write,
+struct flash_driver stmsmi_flash = {
+	.name = &quot;stmsmi&quot;,
+	.flash_bank_command = stmsmi_flash_bank_command,
+	.erase = stmsmi_erase,
+	.protect = stmsmi_protect,
+	.write = stmsmi_write,
 	.read = default_flash_read,
-	.probe = spearsmi_probe,
-	.auto_probe = spearsmi_auto_probe,
+	.probe = stmsmi_probe,
+	.auto_probe = stmsmi_auto_probe,
 	.erase_check = default_flash_blank_check,
-	.protect_check = spearsmi_protect_check,
-	.info = get_spearsmi_info,
+	.protect_check = stmsmi_protect_check,
+	.info = get_stmsmi_info,
 };
diff --git a/tcl/board/spear310evb20.cfg b/tcl/board/spear310evb20.cfg
index 70783f5..b546eb6 100644
--- a/tcl/board/spear310evb20.cfg
+++ b/tcl/board/spear310evb20.cfg
@@ -27,7 +27,7 @@ flash bank $_FLASHNAME0 cfi 0x50000000 0x01000000 2 4 $_TARGETNAME
 
 # Serial NOR on SMI CS0. 8Mbyte.
 set _FLASHNAME1 $_CHIPNAME.snor
-flash bank $_FLASHNAME1 spearsmi 0xf8000000 0 0 0 $_TARGETNAME
+flash bank $_FLASHNAME1 stmsmi 0xf8000000 0 0 0 $_TARGETNAME
 
 if { [info exists BOARD_HAS_SRST] } {
 	# Modified board has SRST on JTAG connector
diff --git a/tcl/target/str750.cfg b/tcl/target/str750.cfg
index 2fabc12..686aede 100644
--- a/tcl/target/str750.cfg
+++ b/tcl/target/str750.cfg
@@ -61,7 +61,7 @@ flash bank $_FLASHNAME str7x 0x200C0000 0x00004000 0 0 $_TARGETNAME STR75x
 
 # Serial NOR on SMI CS0.
 set _FLASHNAME $_CHIPNAME.snor
-flash bank $_FLASHNAME spearsmi 0x80000000 0 0 0 $_TARGETNAME
+flash bank $_FLASHNAME stmsmi 0x80000000 0 0 0 $_TARGETNAME
 
 source [find mem_helper.tcl]
 

commit 4bbdf966d4afbf279550c7115c64e60d94ca3fe8
Author: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;
Date:   Wed Nov 17 11:28:46 2010 +0800

    STR750: Add SMI interface support
    
    Modified spearsmi driver to include support for STR75x
    Added missing initialization in tcl file for STR750
    
    Signed-off-by: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;

diff --git a/src/flash/nor/spearsmi.c b/src/flash/nor/spearsmi.c
index 5e6a2c4..10b5403 100644
--- a/src/flash/nor/spearsmi.c
+++ b/src/flash/nor/spearsmi.c
@@ -42,8 +42,6 @@
 #include &lt;jtag/jtag.h&gt;
 #include &lt;helper/time_support.h&gt;
 
-#define JTAG_ID_3XX_6XX  (0x07926041)
-
 #define SMI_READ_REG(a) (_SMI_READ_REG(a))
 #define _SMI_READ_REG(a)        	\
 {	                                \
@@ -84,12 +82,6 @@
 
 #define SMI_BANK_SIZE      (0x01000000)
 
-#define SMI_BASE_3XX_6XX   (0xf8000000)
-#define SMI_CFGREG_3XX_6XX (0xfc000000)
-
-/* #define SMI_BASE_13XX      (0xe6000000) */
-/* #define SMI_CFGREG_13XX    (0xea000000) */
-
 #define SMI_CR1 (0x00) /* Control register 1 */
 #define SMI_CR2 (0x04) /* Control register 2 */
 #define SMI_SR  (0x08) /* Status register */
@@ -192,6 +184,20 @@ static struct flash_device flash_devices[] = {
 	FLASH_ID(NULL,             0,    0,          0,     0,       0)
 };
 
+struct spearsmi_target {
+	char *name;
+	uint32_t tap_idcode;
+	uint32_t smi_base;
+	uint32_t io_base;
+};
+
+static struct spearsmi_target target_devices[] = {
+	/* name,          tap_idcode, smi_base,   io_base */
+	{ &quot;SPEAr3xx/6xx&quot;, 0x07926041, 0xf8000000, 0xfc000000 },
+	{ &quot;STR75x&quot;,       0x4f1f0041, 0x80000000, 0x90000000 },
+	{ NULL,           0,          0,          0 }
+};
+
 FLASH_BANK_COMMAND_HANDLER(spearsmi_flash_bank_command)
 {
 	struct spearsmi_flash_bank *spearsmi_info;
@@ -602,44 +608,46 @@ static int spearsmi_probe(struct flash_bank *bank)
 	uint32_t io_base;
 	struct flash_sector *sectors;
 	uint32_t id = 0; /* silence uninitialized warning */
+	struct spearsmi_target *target_device;
 	int retval;
 
 	if (spearsmi_info-&gt;probed)
 		free(bank-&gt;sectors);
 	spearsmi_info-&gt;probed = 0;
 
-	/* check for SPEAr device */
-	switch (target-&gt;tap-&gt;idcode)
-	{
-		case JTAG_ID_3XX_6XX:
-			/* SPEAr3xx/6xx */
-			spearsmi_info-&gt;io_base = SMI_CFGREG_3XX_6XX;
-			switch (bank-&gt;base)
-			{
-				case SMI_BASE_3XX_6XX:
-					spearsmi_info-&gt;bank_num = SMI_SEL_BANK0;
-					break;
-				case SMI_BASE_3XX_6XX + SMI_BANK_SIZE:
-					spearsmi_info-&gt;bank_num = SMI_SEL_BANK1;
-					break;
-				case SMI_BASE_3XX_6XX + 2*SMI_BANK_SIZE:
-					spearsmi_info-&gt;bank_num = SMI_SEL_BANK2;
-					break;
-				case SMI_BASE_3XX_6XX + 3*SMI_BANK_SIZE:
-					spearsmi_info-&gt;bank_num = SMI_SEL_BANK3;
-					break;
-				default:
-					LOG_ERROR(&quot;Invalid base address 0x%&quot; PRIx32, bank-&gt;base);
-					return ERROR_FAIL;
-			}
+	for (target_device=target_devices ; target_device-&gt;name ; ++target_device)
+		if (target_device-&gt;tap_idcode == target-&gt;tap-&gt;idcode)
 			break;
+	if (!target_device-&gt;name)
+	{
+		LOG_ERROR(&quot;Device ID 0x%&quot; PRIx32 &quot; is not known as SMI capable&quot;,
+				target-&gt;tap-&gt;idcode);
+		return ERROR_FAIL;
+	}
 
+	switch (bank-&gt;base - target_device-&gt;smi_base)
+	{
+		case 0:
+			spearsmi_info-&gt;bank_num = SMI_SEL_BANK0;
+			break;
+		case SMI_BANK_SIZE:
+			spearsmi_info-&gt;bank_num = SMI_SEL_BANK1;
+			break;
+		case 2*SMI_BANK_SIZE:
+			spearsmi_info-&gt;bank_num = SMI_SEL_BANK2;
+			break;
+		case 3*SMI_BANK_SIZE:
+			spearsmi_info-&gt;bank_num = SMI_SEL_BANK3;
+			break;
 		default:
-			LOG_ERROR(&quot;0x%&quot; PRIx32 &quot; is invalid id for SPEAr device&quot;,
-				target-&gt;tap-&gt;idcode);
+			LOG_ERROR(&quot;Invalid SMI base address 0x%&quot; PRIx32, bank-&gt;base);
 			return ERROR_FAIL;
 	}
-	io_base = spearsmi_info-&gt;io_base;
+	io_base = target_device-&gt;io_base;
+	spearsmi_info-&gt;io_base = io_base;
+
+	LOG_DEBUG(&quot;Valid SMI on device %s at address 0x%&quot; PRIx32,
+		target_device-&gt;name, bank-&gt;base);
 
 	/* read and decode flash ID; returns in SW mode */
 	retval = read_flash_id(bank, &amp;id);
diff --git a/tcl/target/str750.cfg b/tcl/target/str750.cfg
index 7d9f034..2fabc12 100644
--- a/tcl/target/str750.cfg
+++ b/tcl/target/str750.cfg
@@ -39,6 +39,7 @@ $_TARGETNAME configure -event reset-start  { adapter_khz 10 }
 $_TARGETNAME configure -event reset-init {
 	adapter_khz 3000
 
+	init_smi
 # Because the hardware cannot be interrogated for the protection state
 # of sectors, initialize all the sectors to be unprotected. The initial
 # state is reflected by the driver, too.
@@ -58,3 +59,14 @@ flash bank $_FLASHNAME str7x 0x20000000 0x00040000 0 0 $_TARGETNAME STR75x
 set _FLASHNAME $_CHIPNAME.flash1
 flash bank $_FLASHNAME str7x 0x200C0000 0x00004000 0 0 $_TARGETNAME STR75x
 
+# Serial NOR on SMI CS0.
+set _FLASHNAME $_CHIPNAME.snor
+flash bank $_FLASHNAME spearsmi 0x80000000 0 0 0 $_TARGETNAME
+
+source [find mem_helper.tcl]
+
+proc init_smi {} {
+	mmw 0x60000030 0x01000000 0x00000000; # enable clock for GPIO regs
+	mmw 0xffffe420 0x00000001 0x00000000; # set SMI_EN bit
+	mmw 0x90000000 0x00000001 0x00000000; # set BLOCK_EN_1
+}

commit e6fc371e2e86a00c7e84004b94c4b8374634953d
Author: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;
Date:   Thu Nov 18 15:01:03 2010 +0800

    NOR/SPEARSMI: fix segfault
    
    If flash chip is not listed in the table, or if no flash is
    connected, pointer must be properly initialized.
    
    Signed-off-by: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;

diff --git a/src/flash/nor/spearsmi.c b/src/flash/nor/spearsmi.c
index c3bc2ec..5e6a2c4 100644
--- a/src/flash/nor/spearsmi.c
+++ b/src/flash/nor/spearsmi.c
@@ -647,6 +647,7 @@ static int spearsmi_probe(struct flash_bank *bank)
 	if (retval != ERROR_OK)
 		return retval;
 
+	spearsmi_info-&gt;dev = NULL;
 	for (struct flash_device *p = flash_devices; p-&gt;name ; p++)
 		if (p-&gt;device_id == id) {
 			spearsmi_info-&gt;dev = p;

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi                       |   13 +-
 src/flash/nor/Makefile.am              |    2 +-
 src/flash/nor/drivers.c                |    4 +-
 src/flash/nor/{spearsmi.c =&gt; stmsmi.c} |  219 +++++++++++++++++---------------
 tcl/board/spear310evb20.cfg            |    2 +-
 tcl/target/str750.cfg                  |   12 ++
 6 files changed, 137 insertions(+), 115 deletions(-)
 rename src/flash/nor/{spearsmi.c =&gt; stmsmi.c} (79%)


hooks/post-receive
-- 
Main OpenOCD repository

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002443.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-616-g06b4903
</A></li>
	<LI>Next message: <A HREF="002445.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-621-gc606d85
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2444">[ date ]</a>
              <a href="thread.html#2444">[ thread ]</a>
              <a href="subject.html#2444">[ subject ]</a>
              <a href="author.html#2444">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openocd-svn">More information about the openocd-svn
mailing list</a><br>
</body></html>
