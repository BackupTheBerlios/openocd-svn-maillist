<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Openocd-svn] r1632 - trunk/src/flash
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openocd-svn/2009-May/index.html" >
   <LINK REL="made" HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5BOpenocd-svn%5D%20r1632%20-%20trunk/src/flash&In-Reply-To=%3C200905070658.n476wr9m004738%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000415.html">
   <LINK REL="Next"  HREF="000417.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Openocd-svn] r1632 - trunk/src/flash</H1>
    <B>oharboe at BerliOS</B> 
    <A HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5BOpenocd-svn%5D%20r1632%20-%20trunk/src/flash&In-Reply-To=%3C200905070658.n476wr9m004738%40sheep.berlios.de%3E"
       TITLE="[Openocd-svn] r1632 - trunk/src/flash">oharboe at mail.berlios.de
       </A><BR>
    <I>Thu May  7 08:58:53 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000415.html">[Openocd-svn] r1631 - trunk/src/target
</A></li>
        <LI>Next message: <A HREF="000417.html">[Openocd-svn] r1633 - trunk/src/target/target
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#416">[ date ]</a>
              <a href="thread.html#416">[ thread ]</a>
              <a href="subject.html#416">[ subject ]</a>
              <a href="author.html#416">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: oharboe
Date: 2009-05-07 08:58:52 +0200 (Thu, 07 May 2009)
New Revision: 1632

Removed:
   trunk/src/flash/at91sam7_old.c
   trunk/src/flash/at91sam7_old.h
Modified:
   trunk/src/flash/Makefile.am
   trunk/src/flash/flash.c
Log:
Deleted at9sam7_old driver. Nobody has complained about the new one yet.

Modified: trunk/src/flash/Makefile.am
===================================================================
--- trunk/src/flash/Makefile.am	2009-05-07 06:51:27 UTC (rev 1631)
+++ trunk/src/flash/Makefile.am	2009-05-07 06:58:52 UTC (rev 1632)
@@ -6,13 +6,13 @@
 METASOURCES = AUTO
 noinst_LIBRARIES = libflash.a
 libflash_a_SOURCES = \
-	flash.c lpc2000.c cfi.c non_cfi.c at91sam7.c at91sam7_old.c \
+	flash.c lpc2000.c cfi.c non_cfi.c at91sam7.c \
 	str7x.c str9x.c aduc702x.c nand.c nand_ecc.c \
 	lpc3180_nand_controller.c stellaris.c str9xpec.c stm32x.c tms470.c \
 	ecos.c orion_nand.c s3c24xx_nand.c s3c2410_nand.c s3c2412_nand.c \
 	s3c2440_nand.c s3c2443_nand.c lpc288x.c ocl.c mflash.c pic32mx.c avrf.c
 noinst_HEADERS = \
-	flash.h lpc2000.h cfi.h non_cfi.h at91sam7.h at91sam7_old.h str7x.h \
+	flash.h lpc2000.h cfi.h non_cfi.h at91sam7.h str7x.h \
 	str9x.h nand.h lpc3180_nand_controller.h stellaris.h str9xpec.h \
 	stm32x.h tms470.h s3c24xx_nand.h s3c24xx_regs_nand.h lpc288x.h \
 	mflash.h ocl.h pic32mx.h avrf.h

Deleted: trunk/src/flash/at91sam7_old.c
===================================================================
--- trunk/src/flash/at91sam7_old.c	2009-05-07 06:51:27 UTC (rev 1631)
+++ trunk/src/flash/at91sam7_old.c	2009-05-07 06:58:52 UTC (rev 1632)
@@ -1,956 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2006 by Magnus Lundin                                   *
- *   <A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">lundin at mlu.mine.nu</A>                                                    *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-
-/***************************************************************************
-There are some things to notice
-
-* AT91SAM7S64 is tested
-* All AT91SAM7Sxx  and  AT91SAM7Xxx should work but is not tested
-* All parameters are identified from onchip configuartion registers 
-*
-* The flash controller handles erases automatically on a page (128/265 byte) basis
-* Only an EraseAll command is supported by the controller
-* Partial erases can be implemented in software by writing one 0xFFFFFFFF word to 
-* some location in every page in the region to be erased
-*  
-* Lock regions (sectors) are 32 or 64 pages
-*
- ***************************************************************************/
-#ifdef HAVE_CONFIG_H
-#include &quot;config.h&quot;
-#endif
-
-#include &quot;replacements.h&quot;
-
-#include &quot;at91sam7_old.h&quot;
-
-#include &quot;flash.h&quot;
-#include &quot;target.h&quot;
-#include &quot;log.h&quot;
-#include &quot;binarybuffer.h&quot;
-#include &quot;types.h&quot;
-
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
-#include &lt;unistd.h&gt;
-
-static int at91sam7_old_register_commands(struct command_context_s *cmd_ctx);
-static int at91sam7_old_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank);
-static int at91sam7_old_erase(struct flash_bank_s *bank, int first, int last);
-static int at91sam7_old_protect(struct flash_bank_s *bank, int set, int first, int last);
-static int at91sam7_old_write(struct flash_bank_s *bank, u8 *buffer, u32 offset, u32 count);
-static int at91sam7_old_probe(struct flash_bank_s *bank);
-//static int at91sam7_old_auto_probe(struct flash_bank_s *bank);
-static int at91sam7_old_erase_check(struct flash_bank_s *bank);
-static int at91sam7_old_protect_check(struct flash_bank_s *bank);
-static int at91sam7_old_info(struct flash_bank_s *bank, char *buf, int buf_size);
-
-static u32 at91sam7_old_get_flash_status(flash_bank_t *bank, u8 flashplane);
-static void at91sam7_old_set_flash_mode(flash_bank_t *bank, u8 flashplane, int mode);
-static u32 at91sam7_old_wait_status_busy(flash_bank_t *bank, u8 flashplane, u32 waitbits, int timeout);
-static int at91sam7_old_flash_command(struct flash_bank_s *bank, u8 flashplane, u8 cmd, u16 pagen); 
-static int at91sam7_old_handle_gpnvm_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc);
-
-flash_driver_t at91sam7_old_flash =
-{
-	.name = &quot;at91sam7&quot;,
-	.register_commands = at91sam7_old_register_commands,
-	.flash_bank_command = at91sam7_old_flash_bank_command,
-	.erase = at91sam7_old_erase,
-	.protect = at91sam7_old_protect,
-	.write = at91sam7_old_write,
-	.probe = at91sam7_old_probe,
-	.auto_probe = at91sam7_old_probe,
-	.erase_check = at91sam7_old_erase_check,
-	.protect_check = at91sam7_old_protect_check,
-	.info = at91sam7_old_info
-};
-
-static u32 MC_FMR_old[4] =	{ 0xFFFFFF60, 0xFFFFFF70, 0xFFFFFF80, 0xFFFFFF90 };
-static u32 MC_FCR_old[4] =	{ 0xFFFFFF64, 0xFFFFFF74, 0xFFFFFF84, 0xFFFFFF94 };
-static u32 MC_FSR_old[4] =	{ 0xFFFFFF68, 0xFFFFFF78, 0xFFFFFF88, 0xFFFFFF98 };
-
-static char * EPROC_old[8]= {&quot;Unknown&quot;,&quot;ARM946-E&quot;,&quot;ARM7TDMI&quot;,&quot;Unknown&quot;,&quot;ARM920T&quot;,&quot;ARM926EJ-S&quot;,&quot;Unknown&quot;,&quot;Unknown&quot;};
-static long NVPSIZ_old[16] = {
-   0,
-   0x2000, /*  8K */
-   0x4000, /* 16K */ 
-   0x8000, /* 32K */
-   -1,
-   0x10000, /* 64K */
-   -1,
-   0x20000, /* 128K */
-   -1,
-   0x40000, /* 256K */
-   0x80000, /* 512K */
-   -1,
-   0x100000, /* 1024K */
-   -1,
-   0x200000, /* 2048K */
-   -1
-};
-
-#if 0
-static long SRAMSIZ_old[16] = {
-   -1,
-   0x0400, /*  1K */
-   0x0800, /*  2K */ 
-   -1, 
-   0x1c000,  /* 112K */
-   0x1000,  /*   4K */
-   0x14000, /*  80K */
-   0x28000, /* 160K */
-   0x2000,  /*   8K */
-   0x4000,  /*  16K */
-   0x8000,  /*  32K */
-   0x10000, /*  64K */
-   0x20000, /* 128K */
-   0x40000, /* 256K */
-   0x18000, /* 96K */
-   0x80000, /* 512K */
-};
-#endif
-
-static int at91sam7_old_register_commands(struct command_context_s *cmd_ctx)
-{
-	command_t *at91sam7_old_cmd = register_command(cmd_ctx, NULL, &quot;at91sam7&quot;, NULL, COMMAND_ANY, NULL);
-	register_command(cmd_ctx, at91sam7_old_cmd, &quot;gpnvm&quot;, at91sam7_old_handle_gpnvm_command, COMMAND_EXEC,
-			&quot;at91sam7 gpnvm &lt;num&gt; &lt;bit&gt; set|clear, set or clear at91sam7 gpnvm bit&quot;);
-
-	return ERROR_OK;
-}
-
-static u32 at91sam7_old_get_flash_status(flash_bank_t *bank, u8 flashplane)
-{
-	target_t *target = bank-&gt;target;
-	u32 fsr;
-	
-	target_read_u32(target, MC_FSR_old[flashplane], &amp;fsr);
-	
-	return fsr;
-}
-
-/* Read clock configuration and set at91sam7_old_info-&gt;usec_clocks*/
-static void at91sam7_old_read_clock_info(flash_bank_t *bank)
-{
-	at91sam7_old_flash_bank_t *at91sam7_old_info = bank-&gt;driver_priv;
-	target_t *target = bank-&gt;target;
-	u32 mckr, mcfr, pllr;
-	unsigned long tmp = 0, mainfreq;
-	int flashplane;
-
-	/* Read main clock freqency register */
-	target_read_u32(target, CKGR_MCFR_old, &amp;mcfr);
-	/* Read master clock register */
-	target_read_u32(target, PMC_MCKR_old, &amp;mckr);
-	/* Read Clock Generator PLL Register  */
-	target_read_u32(target, CKGR_PLLR_old, &amp;pllr);
-
-	at91sam7_old_info-&gt;mck_valid = 0;
-	switch (mckr &amp; PMC_MCKR_CSS_old) 
-	{
-		case 0:			/* Slow Clock */
-			at91sam7_old_info-&gt;mck_valid = 1;
-			mainfreq = RC_FREQ_old / 16ul * (mcfr &amp; 0xffff);
-			tmp = mainfreq;
-			break;
-		case 1:			/* Main Clock */
-			if (mcfr &amp; CKGR_MCFR_MAINRDY_old) 
-			{
-				at91sam7_old_info-&gt;mck_valid = 1;
-				mainfreq = RC_FREQ_old / 16ul * (mcfr &amp; 0xffff);
-				tmp = mainfreq;
-			}
-			break;
-
-		case 2:			/* Reserved */
-			break;
-		case 3:			/* PLL Clock */
-			if (mcfr &amp; CKGR_MCFR_MAINRDY_old) 
-			{
-				target_read_u32(target, CKGR_PLLR_old, &amp;pllr);
-				if (!(pllr &amp; CKGR_PLLR_DIV_old))
-					break; /* 0 Hz */
-				at91sam7_old_info-&gt;mck_valid = 1;
-				mainfreq = RC_FREQ_old / 16ul * (mcfr &amp; 0xffff);
-				/* Integer arithmetic should have sufficient precision
-				   as long as PLL is properly configured. */
-				tmp = mainfreq / (pllr &amp; CKGR_PLLR_DIV_old) *
-				  (((pllr &amp; CKGR_PLLR_MUL_old) &gt;&gt; 16) + 1);
-			}
-			break;
-	}
-	
-	/* Prescaler adjust */
-	if (((mckr &amp; PMC_MCKR_PRES_old) &gt;&gt; 2) == 7)
-		at91sam7_old_info-&gt;mck_valid = 0;
-	else
-		at91sam7_old_info-&gt;mck_freq = tmp &gt;&gt; ((mckr &amp; PMC_MCKR_PRES_old) &gt;&gt; 2);
-
-	/* Forget old flash timing */
-	for (flashplane = 0; flashplane&lt;at91sam7_old_info-&gt;num_planes; flashplane++)
-	{
-		at91sam7_old_set_flash_mode(bank, flashplane, FMR_TIMING_NONE_old);
-	}
-}
-
-/* Setup the timimg registers for nvbits or normal flash */
-static void at91sam7_old_set_flash_mode(flash_bank_t *bank, u8 flashplane, int mode)
-{
-	u32 fmr, fmcn = 0, fws = 0;
-	at91sam7_old_flash_bank_t *at91sam7_old_info = bank-&gt;driver_priv;
-	target_t *target = bank-&gt;target;
-	
-	if (mode &amp;&amp; (mode != at91sam7_old_info-&gt;flashmode[flashplane]))
-	{
-		/* Always round up (ceil) */
-		if (mode==FMR_TIMING_NVBITS_old)
-		{
-			if (at91sam7_old_info-&gt;cidr_arch == 0x60)
-			{
-				/* AT91SAM7A3 uses master clocks in 100 ns */
-				fmcn = (at91sam7_old_info-&gt;mck_freq/10000000ul)+1;
-			}
-			else
-			{
-				/* master clocks in 1uS for ARCH 0x7 types */
-				fmcn = (at91sam7_old_info-&gt;mck_freq/1000000ul)+1;
-			}
-		}
-		else if (mode==FMR_TIMING_FLASH_old)
-			/* main clocks in 1.5uS */
-			fmcn = (at91sam7_old_info-&gt;mck_freq/666666ul)+1;
-
-		/* Only allow fmcn=0 if clock period is &gt; 30 us = 33kHz. */
- 		if (at91sam7_old_info-&gt;mck_freq &lt;= 33333ul)
-			fmcn = 0;
-		/* Only allow fws=0 if clock frequency is &lt; 30 MHz. */
-		if (at91sam7_old_info-&gt;mck_freq &gt; 30000000ul)
-			fws = 1;
-
-		LOG_DEBUG(&quot;fmcn[%i]: %i&quot;, flashplane, fmcn); 
-		fmr = fmcn &lt;&lt; 16 | fws &lt;&lt; 8;
-		target_write_u32(target, MC_FMR_old[flashplane], fmr);
-	}
-	
-	at91sam7_old_info-&gt;flashmode[flashplane] = mode;		
-}
-
-static u32 at91sam7_old_wait_status_busy(flash_bank_t *bank, u8 flashplane, u32 waitbits, int timeout)
-{
-	u32 status;
-	
-	while ((!((status = at91sam7_old_get_flash_status(bank,flashplane)) &amp; waitbits)) &amp;&amp; (timeout-- &gt; 0))
-	{
-		LOG_DEBUG(&quot;status[%i]: 0x%x&quot;, flashplane, status);
-		alive_sleep(1);
-	}
-	
-	LOG_DEBUG(&quot;status[%i]: 0x%x&quot;, flashplane, status);
-
-	if (status &amp; 0x0C)
-	{
-		LOG_ERROR(&quot;status register: 0x%x&quot;, status);
-		if (status &amp; 0x4)
-			LOG_ERROR(&quot;Lock Error Bit Detected, Operation Abort&quot;);
-		if (status &amp; 0x8)
-			LOG_ERROR(&quot;Invalid command and/or bad keyword, Operation Abort&quot;);
-		if (status &amp; 0x10)
-			LOG_ERROR(&quot;Security Bit Set, Operation Abort&quot;);
-	}
-	
-	return status;
-}
-
-
-/* Send one command to the AT91SAM flash controller */
-static int at91sam7_old_flash_command(struct flash_bank_s *bank, u8 flashplane, u8 cmd, u16 pagen) 
-{
-	u32 fcr;
-	at91sam7_old_flash_bank_t *at91sam7_old_info = bank-&gt;driver_priv;
-	target_t *target = bank-&gt;target;
-
-	fcr = (0x5A&lt;&lt;24) | ((pagen&amp;0x3FF)&lt;&lt;8) | cmd; 
-	target_write_u32(target, MC_FCR_old[flashplane], fcr);
-	LOG_DEBUG(&quot;Flash command: 0x%x, flashplane: %i, pagenumber:%u&quot;, fcr, flashplane, pagen);
-
-	if ((at91sam7_old_info-&gt;cidr_arch == 0x60)&amp;&amp;((cmd==SLB_old)|(cmd==CLB_old)))
-	{
-		/* Lock bit manipulation on AT91SAM7A3 waits for FC_FSR bit 1, EOL */
-		if (at91sam7_old_wait_status_busy(bank, flashplane, MC_FSR_EOL_old, 10)&amp;0x0C) 
-		{
-			return ERROR_FLASH_OPERATION_FAILED;
-		}
-		return ERROR_OK;
-	}
-
-	if (at91sam7_old_wait_status_busy(bank, flashplane, MC_FSR_FRDY_old, 10)&amp;0x0C) 
-	{
-		return ERROR_FLASH_OPERATION_FAILED;
-	}
-	return ERROR_OK;
-}
-
-/* Read device id register, main clock frequency register and fill in driver info structure */
-static int at91sam7_old_read_part_info(struct flash_bank_s *bank)
-{
-	at91sam7_old_flash_bank_t *at91sam7_old_info = bank-&gt;driver_priv;
-	target_t *target = bank-&gt;target;
-	u32 cidr, status;
-	int sectornum;
-
-	if (at91sam7_old_info-&gt;cidr != 0)
-		return ERROR_OK; /* already probed, multiple probes may cause memory leak, not allowed */
-	
-	/* Read and parse chip identification register */
-	target_read_u32(target, DBGU_CIDR_old, &amp;cidr);
-	
-	if (cidr == 0)
-	{
-		LOG_WARNING(&quot;Cannot identify target as an AT91SAM&quot;);
-		return ERROR_FLASH_OPERATION_FAILED;
-	}
-	
-	at91sam7_old_info-&gt;cidr = cidr;
-	at91sam7_old_info-&gt;cidr_ext = (cidr&gt;&gt;31)&amp;0x0001;
-	at91sam7_old_info-&gt;cidr_nvptyp = (cidr&gt;&gt;28)&amp;0x0007;
-	at91sam7_old_info-&gt;cidr_arch = (cidr&gt;&gt;20)&amp;0x00FF;
-	at91sam7_old_info-&gt;cidr_sramsiz = (cidr&gt;&gt;16)&amp;0x000F;
-	at91sam7_old_info-&gt;cidr_nvpsiz2 = (cidr&gt;&gt;12)&amp;0x000F;
-	at91sam7_old_info-&gt;cidr_nvpsiz = (cidr&gt;&gt;8)&amp;0x000F;
-	at91sam7_old_info-&gt;cidr_eproc = (cidr&gt;&gt;5)&amp;0x0007;
-	at91sam7_old_info-&gt;cidr_version = cidr&amp;0x001F;
-	bank-&gt;size = NVPSIZ_old[at91sam7_old_info-&gt;cidr_nvpsiz];
-	at91sam7_old_info-&gt;target_name = &quot;Unknown&quot;;
-
-	/* Support just for bulk erase of a single flash plane, whole device if flash size &lt;= 256k */
-	if (NVPSIZ_old[at91sam7_old_info-&gt;cidr_nvpsiz]&lt;0x80000)  /* Flash size less than 512K, one flash plane */
-	{
-		bank-&gt;num_sectors = 1;
-		bank-&gt;sectors = malloc(sizeof(flash_sector_t));
-		bank-&gt;sectors[0].offset = 0;
-		bank-&gt;sectors[0].size = bank-&gt;size;
-		bank-&gt;sectors[0].is_erased = -1;
-		bank-&gt;sectors[0].is_protected = -1;
-	}
-	else	/* Flash size 512K or larger, several flash planes */
-	{
-		bank-&gt;num_sectors = NVPSIZ_old[at91sam7_old_info-&gt;cidr_nvpsiz]/0x40000;
-		bank-&gt;sectors = malloc(bank-&gt;num_sectors*sizeof(flash_sector_t));
-		for (sectornum=0; sectornum&lt;bank-&gt;num_sectors; sectornum++)
-		{
-			bank-&gt;sectors[sectornum].offset = sectornum*0x40000;
-			bank-&gt;sectors[sectornum].size = 0x40000;
-			bank-&gt;sectors[sectornum].is_erased = -1;
-			bank-&gt;sectors[sectornum].is_protected = -1;
-		}
-	}
-		
-	
-
-	LOG_DEBUG(&quot;nvptyp: 0x%3.3x, arch: 0x%4.4x&quot;, at91sam7_old_info-&gt;cidr_nvptyp, at91sam7_old_info-&gt;cidr_arch );
-
-	/* Read main and master clock freqency register */
-	at91sam7_old_read_clock_info(bank);
-	
-	at91sam7_old_info-&gt;num_planes = 1;
-	status = at91sam7_old_get_flash_status(bank, 0);
-	at91sam7_old_info-&gt;securitybit = (status&gt;&gt;4)&amp;0x01;
-	at91sam7_old_protect_check(bank);   /* TODO Check the protect check */
-	
-	if (at91sam7_old_info-&gt;cidr_arch == 0x70 )
-	{
-		at91sam7_old_info-&gt;num_nvmbits = 2;
-		at91sam7_old_info-&gt;nvmbits = (status&gt;&gt;8)&amp;0x03;
-		bank-&gt;base = 0x100000;
-		bank-&gt;bus_width = 4;
-		if (bank-&gt;size==0x80000)  /* AT91SAM7S512 */
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7S512&quot;;
-			at91sam7_old_info-&gt;num_planes = 2;
-			if (at91sam7_old_info-&gt;num_planes != bank-&gt;num_sectors)
-				LOG_WARNING(&quot;Internal error: Number of flash planes and erase sectors does not match, please report&quot;);;
-			at91sam7_old_info-&gt;num_lockbits = 2*16;
-			at91sam7_old_info-&gt;pagesize = 256;
-			at91sam7_old_info-&gt;pages_in_lockregion = 64;
-			at91sam7_old_info-&gt;num_pages = 2*16*64;
-		}
-		if (bank-&gt;size==0x40000)  /* AT91SAM7S256 */
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7S256&quot;;
-			at91sam7_old_info-&gt;num_lockbits = 16;
-			at91sam7_old_info-&gt;pagesize = 256;
-			at91sam7_old_info-&gt;pages_in_lockregion = 64;
-			at91sam7_old_info-&gt;num_pages = 16*64;
-		}
-		if (bank-&gt;size==0x20000)  /* AT91SAM7S128 */
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7S128&quot;;
-			at91sam7_old_info-&gt;num_lockbits = 8;
-			at91sam7_old_info-&gt;pagesize = 256;
-			at91sam7_old_info-&gt;pages_in_lockregion = 64;
-			at91sam7_old_info-&gt;num_pages = 8*64;
-		}
-		if (bank-&gt;size==0x10000)  /* AT91SAM7S64 */
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7S64&quot;;
-			at91sam7_old_info-&gt;num_lockbits = 16;
-			at91sam7_old_info-&gt;pagesize = 128;
-			at91sam7_old_info-&gt;pages_in_lockregion = 32;
-			at91sam7_old_info-&gt;num_pages = 16*32;
-		}
-		if (bank-&gt;size==0x08000)  /* AT91SAM7S321/32 */
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7S321/32&quot;;
-			at91sam7_old_info-&gt;num_lockbits = 8;
-			at91sam7_old_info-&gt;pagesize = 128;
-			at91sam7_old_info-&gt;pages_in_lockregion = 32;
-			at91sam7_old_info-&gt;num_pages = 8*32;
-		}
-		
-		return ERROR_OK;
-	}
-
-	if (at91sam7_old_info-&gt;cidr_arch == 0x71 )
-	{
-		at91sam7_old_info-&gt;num_nvmbits = 3;
-		at91sam7_old_info-&gt;nvmbits = (status&gt;&gt;8)&amp;0x07;
-		bank-&gt;base = 0x100000;
-		bank-&gt;bus_width = 4;
-		if (bank-&gt;size==0x80000)  /* AT91SAM7XC512 */
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7XC512&quot;;
-			at91sam7_old_info-&gt;num_planes = 2;
-			if (at91sam7_old_info-&gt;num_planes != bank-&gt;num_sectors)
-				LOG_WARNING(&quot;Internal error: Number of flash planes and erase sectors does not match, please report&quot;);;
-			at91sam7_old_info-&gt;num_lockbits = 2*16;
-			at91sam7_old_info-&gt;pagesize = 256;
-			at91sam7_old_info-&gt;pages_in_lockregion = 64;
-			at91sam7_old_info-&gt;num_pages = 2*16*64;
-		}
-		if (bank-&gt;size==0x40000)  /* AT91SAM7XC256 */
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7XC256&quot;;
-			at91sam7_old_info-&gt;num_lockbits = 16;
-			at91sam7_old_info-&gt;pagesize = 256;
-			at91sam7_old_info-&gt;pages_in_lockregion = 64;
-			at91sam7_old_info-&gt;num_pages = 16*64;
-		}
-		if (bank-&gt;size==0x20000)  /* AT91SAM7XC128 */
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7XC128&quot;;
-			at91sam7_old_info-&gt;num_lockbits = 8;
-			at91sam7_old_info-&gt;pagesize = 256;
-			at91sam7_old_info-&gt;pages_in_lockregion = 64;
-			at91sam7_old_info-&gt;num_pages = 8*64;
-		}
-		
-		return ERROR_OK;
-	}
-	
-	if (at91sam7_old_info-&gt;cidr_arch == 0x72 )
-	{
-		at91sam7_old_info-&gt;num_nvmbits = 3;
-		at91sam7_old_info-&gt;nvmbits = (status&gt;&gt;8)&amp;0x07;
-		bank-&gt;base = 0x100000;
-		bank-&gt;bus_width = 4;
-		if (bank-&gt;size==0x80000) /* AT91SAM7SE512 */
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7SE512&quot;;
-			at91sam7_old_info-&gt;num_planes = 2;
-			if (at91sam7_old_info-&gt;num_planes != bank-&gt;num_sectors)
-				LOG_WARNING(&quot;Internal error: Number of flash planes and erase sectors does not match, please report&quot;);;
-			at91sam7_old_info-&gt;num_lockbits = 32;
-			at91sam7_old_info-&gt;pagesize = 256;
-			at91sam7_old_info-&gt;pages_in_lockregion = 64;
-			at91sam7_old_info-&gt;num_pages = 32*64;
-		}
-		if (bank-&gt;size==0x40000)
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7SE256&quot;;
-			at91sam7_old_info-&gt;num_lockbits = 16;
-			at91sam7_old_info-&gt;pagesize = 256;
-			at91sam7_old_info-&gt;pages_in_lockregion = 64;
-			at91sam7_old_info-&gt;num_pages = 16*64;
-		}
-		if (bank-&gt;size==0x08000)
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7SE32&quot;;
-			at91sam7_old_info-&gt;num_lockbits = 8;
-			at91sam7_old_info-&gt;pagesize = 128;
-			at91sam7_old_info-&gt;pages_in_lockregion = 32;
-			at91sam7_old_info-&gt;num_pages = 8*32;
-		}
-		
-		return ERROR_OK;
-	}
-	
-	if (at91sam7_old_info-&gt;cidr_arch == 0x75 )
-	{
-		at91sam7_old_info-&gt;num_nvmbits = 3;
-		at91sam7_old_info-&gt;nvmbits = (status&gt;&gt;8)&amp;0x07;
-		bank-&gt;base = 0x100000;
-		bank-&gt;bus_width = 4;
-		if (bank-&gt;size==0x80000)  /* AT91SAM7X512 */
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7X512&quot;;
-			at91sam7_old_info-&gt;num_planes = 2;
-			if (at91sam7_old_info-&gt;num_planes != bank-&gt;num_sectors)
-				LOG_WARNING(&quot;Internal error: Number of flash planes and erase sectors does not match, please report&quot;);;
-			at91sam7_old_info-&gt;num_lockbits = 32;
-			at91sam7_old_info-&gt;pagesize = 256;
-			at91sam7_old_info-&gt;pages_in_lockregion = 64;
-			at91sam7_old_info-&gt;num_pages = 2*16*64;
-			LOG_DEBUG(&quot;Support for AT91SAM7X512 is experimental in this version!&quot;);
-		}
-		if (bank-&gt;size==0x40000)  /* AT91SAM7X256 */
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7X256&quot;;
-			at91sam7_old_info-&gt;num_lockbits = 16;
-			at91sam7_old_info-&gt;pagesize = 256;
-			at91sam7_old_info-&gt;pages_in_lockregion = 64;
-			at91sam7_old_info-&gt;num_pages = 16*64;
-		}
-		if (bank-&gt;size==0x20000)  /* AT91SAM7X128 */
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7X128&quot;;
-			at91sam7_old_info-&gt;num_lockbits = 8;
-			at91sam7_old_info-&gt;pagesize = 256;
-			at91sam7_old_info-&gt;pages_in_lockregion = 64;
-			at91sam7_old_info-&gt;num_pages = 8*64;
-		}
-	
-		return ERROR_OK;
-	}
-	
-	if (at91sam7_old_info-&gt;cidr_arch == 0x60 )
-	{
-		at91sam7_old_info-&gt;num_nvmbits = 3;
-		at91sam7_old_info-&gt;nvmbits = (status&gt;&gt;8)&amp;0x07;
-		bank-&gt;base = 0x100000;
-		bank-&gt;bus_width = 4;
-		
-		if (bank-&gt;size == 0x40000)  /* AT91SAM7A3 */
-		{
-			at91sam7_old_info-&gt;target_name = &quot;AT91SAM7A3&quot;;
-			at91sam7_old_info-&gt;num_lockbits = 16;
-			at91sam7_old_info-&gt;pagesize = 256;
-			at91sam7_old_info-&gt;pages_in_lockregion = 16;
-			at91sam7_old_info-&gt;num_pages = 16*64;
-		}
-		return ERROR_OK;
-	}
-	
-	LOG_WARNING(&quot;at91sam7_old flash only tested for AT91SAM7Sxx series&quot;);
-	return ERROR_OK;
-}
-
-int at91sam7_old_erase_check(struct flash_bank_s *bank)
-{
-	at91sam7_old_flash_bank_t *at91sam7_old_info = bank-&gt;driver_priv;
-	
-	if (!at91sam7_old_info-&gt;working_area_size)
-	{
-	}
-	else
-	{	
-	}
-	
-	return ERROR_OK;
-}
-
-static int at91sam7_old_protect_check(struct flash_bank_s *bank)
-{
-	u32 status;
-	int flashplane;
-	
-	at91sam7_old_flash_bank_t *at91sam7_old_info = bank-&gt;driver_priv;
-
-	if (at91sam7_old_info-&gt;cidr == 0)
-	{
-		return ERROR_FLASH_BANK_NOT_PROBED;
-	}
-
-	if (bank-&gt;target-&gt;state != TARGET_HALTED)
-	{
-		LOG_ERROR(&quot;Target not halted&quot;);
-		return ERROR_TARGET_NOT_HALTED;
-	}
-
-	for (flashplane=0;flashplane&lt;at91sam7_old_info-&gt;num_planes;flashplane++)
-	{
-		status = at91sam7_old_get_flash_status(bank, flashplane);
-		at91sam7_old_info-&gt;lockbits[flashplane] = (status &gt;&gt; 16);
-	}
-	
-	return ERROR_OK;
-}
-
-/* flash_bank at91sam7_old 0 0 0 0 &lt;target#&gt;
- */
-int at91sam7_old_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
-{
-	at91sam7_old_flash_bank_t *at91sam7_old_info;
-	int i;
-	
-	if (argc &lt; 6)
-	{
-		LOG_WARNING(&quot;incomplete flash_bank at91sam7_old configuration&quot;);
-		return ERROR_FLASH_BANK_INVALID;
-	}
-	
-	at91sam7_old_info = malloc(sizeof(at91sam7_old_flash_bank_t));
-	bank-&gt;driver_priv = at91sam7_old_info;
-	
-	/* part wasn't probed for info yet */
-	at91sam7_old_info-&gt;cidr = 0;
-	for (i=0;i&lt;4;i++)
-		at91sam7_old_info-&gt;flashmode[i]=0;
-	
-	return ERROR_OK;
-}
-
-static int at91sam7_old_erase(struct flash_bank_s *bank, int first, int last)
-{
-	at91sam7_old_flash_bank_t *at91sam7_old_info = bank-&gt;driver_priv;
-	u8 flashplane;
-
-	if (at91sam7_old_info-&gt;cidr == 0)
-	{
-		return ERROR_FLASH_BANK_NOT_PROBED;
-	}
-
-	if (bank-&gt;target-&gt;state != TARGET_HALTED)
-	{
-		LOG_ERROR(&quot;Target not halted&quot;);
-		return ERROR_TARGET_NOT_HALTED;
-	}
-	
-	if ((first &lt; 0) || (last &lt; first) || (last &gt;= bank-&gt;num_sectors))
-	{
-		if ((first == 0) &amp;&amp; (last == (at91sam7_old_info-&gt;num_lockbits-1)))
-		{
-			LOG_WARNING(&quot;Sector numbers based on lockbit count, probably a deprecated script&quot;);
-			last = bank-&gt;num_sectors-1;
-		}
-		else return ERROR_FLASH_SECTOR_INVALID;
-	}
-
-	/* Configure the flash controller timing */
-	at91sam7_old_read_clock_info(bank);	
-	for (flashplane = first; flashplane&lt;=last; flashplane++)
-	{
-		/* Configure the flash controller timing */
-		at91sam7_old_set_flash_mode(bank, flashplane, FMR_TIMING_FLASH_old);
-		if (at91sam7_old_flash_command(bank, flashplane, EA_old, 0) != ERROR_OK) 
-		{
-			return ERROR_FLASH_OPERATION_FAILED;
-		}	
-	}
-	return ERROR_OK;
-
-}
-
-int at91sam7_old_protect(struct flash_bank_s *bank, int set, int first, int last)
-{
-	u32 cmd, pagen;
-	u8 flashplane;
-	int lockregion;
-	
-	at91sam7_old_flash_bank_t *at91sam7_old_info = bank-&gt;driver_priv;
-	
-	if (at91sam7_old_info-&gt;cidr == 0)
-	{
-		return ERROR_FLASH_BANK_NOT_PROBED;
-	}
-
-	if (bank-&gt;target-&gt;state != TARGET_HALTED)
-	{
-		LOG_ERROR(&quot;Target not halted&quot;);
-		return ERROR_TARGET_NOT_HALTED;
-	}
-	
-	if ((first &lt; 0) || (last &lt; first) || (last &gt;= at91sam7_old_info-&gt;num_lockbits))
-	{
-		return ERROR_FLASH_SECTOR_INVALID;
-	}
-	
-	at91sam7_old_read_clock_info(bank);	
-	
-	for (lockregion=first;lockregion&lt;=last;lockregion++) 
-	{
-		pagen = lockregion*at91sam7_old_info-&gt;pages_in_lockregion;
-		flashplane = (pagen&gt;&gt;10)&amp;0x03;
-		/* Configure the flash controller timing */
-		at91sam7_old_set_flash_mode(bank, flashplane, FMR_TIMING_NVBITS_old);
-		
-		if (set)
-			 cmd = SLB_old; 
-		else
-			 cmd = CLB_old; 		
-
-		if (at91sam7_old_flash_command(bank, flashplane, cmd, pagen) != ERROR_OK) 
-		{
-			return ERROR_FLASH_OPERATION_FAILED;
-		}	
-	}
-	
-	at91sam7_old_protect_check(bank);
-		
-	return ERROR_OK;
-}
-
-
-static int at91sam7_old_write(struct flash_bank_s *bank, u8 *buffer, u32 offset, u32 count)
-{
-	at91sam7_old_flash_bank_t *at91sam7_old_info = bank-&gt;driver_priv;
-	target_t *target = bank-&gt;target;
-	u32 dst_min_alignment, wcount, bytes_remaining = count;
-	u32 first_page, last_page, pagen, buffer_pos;
-	u8 flashplane;
-	
-	if (at91sam7_old_info-&gt;cidr == 0)
-	{
-		return ERROR_FLASH_BANK_NOT_PROBED;
-	}
-
-	if (bank-&gt;target-&gt;state != TARGET_HALTED)
-	{
-		LOG_ERROR(&quot;Target not halted&quot;);
-		return ERROR_TARGET_NOT_HALTED;
-	}
-
-	if (offset + count &gt; bank-&gt;size)
-		return ERROR_FLASH_DST_OUT_OF_BANK;
-	
-	dst_min_alignment = at91sam7_old_info-&gt;pagesize;
-
-	if (offset % dst_min_alignment)
-	{
-		LOG_WARNING(&quot;offset 0x%x breaks required alignment 0x%x&quot;, offset, dst_min_alignment);
-		return ERROR_FLASH_DST_BREAKS_ALIGNMENT;
-	}
-	
-	if (at91sam7_old_info-&gt;cidr_arch == 0)
-		return ERROR_FLASH_BANK_NOT_PROBED;
-
-	first_page = offset/dst_min_alignment;
-	last_page = CEIL(offset + count, dst_min_alignment);
-	
-	LOG_DEBUG(&quot;first_page: %i, last_page: %i, count %i&quot;, first_page, last_page, count);
-	
-	at91sam7_old_read_clock_info(bank);	
-
-	for (pagen=first_page; pagen&lt;last_page; pagen++) 
-	{
-		if (bytes_remaining&lt;dst_min_alignment)
-			count = bytes_remaining;
-		else
-			count = dst_min_alignment;
-		bytes_remaining -= count;
-		
-		/* Write one block to the PageWriteBuffer */
-		buffer_pos = (pagen-first_page)*dst_min_alignment;
-		wcount = CEIL(count,4);
-		target-&gt;type-&gt;write_memory(target, bank-&gt;base+pagen*dst_min_alignment, 4, wcount, buffer+buffer_pos);
-		flashplane = (pagen&gt;&gt;10)&amp;0x3;
-		
-		/* Configure the flash controller timing */	
-		at91sam7_old_set_flash_mode(bank, flashplane, FMR_TIMING_FLASH_old);
-		/* Send Write Page command to Flash Controller */
-		if (at91sam7_old_flash_command(bank, flashplane, WP_old, pagen) != ERROR_OK) 
-		{
-				return ERROR_FLASH_OPERATION_FAILED;
-		}
-		LOG_DEBUG(&quot;Write flash plane:%i page number:%i&quot;, flashplane, pagen);
-	}
-	
-	return ERROR_OK;
-}
-
-
-static int at91sam7_old_probe(struct flash_bank_s *bank)
-{
-	/* we can't probe on an at91sam7_old
-	 * if this is an at91sam7_old, it has the configured flash
-	 */
-	at91sam7_old_flash_bank_t *at91sam7_old_info = bank-&gt;driver_priv;
-	int retval;
-	
-	if (at91sam7_old_info-&gt;cidr != 0)
-	{
-		return ERROR_OK; /* already probed */
-	}
-
-	if (bank-&gt;target-&gt;state != TARGET_HALTED)
-	{
-		LOG_ERROR(&quot;Target not halted&quot;);
-		return ERROR_TARGET_NOT_HALTED;
-	}
-
-	retval = at91sam7_old_read_part_info(bank);
-	if (retval != ERROR_OK)
-		return retval;
-	
-	return ERROR_OK;
-}
-
-
-static int at91sam7_old_info(struct flash_bank_s *bank, char *buf, int buf_size)
-{
-	int printed, flashplane;
-	at91sam7_old_flash_bank_t *at91sam7_old_info = bank-&gt;driver_priv;
-	
-	if (at91sam7_old_info-&gt;cidr == 0)
-	{
-		return ERROR_FLASH_BANK_NOT_PROBED;
-	}
-	
-	printed = snprintf(buf, buf_size, &quot;\nat91sam7_old information: Chip is %s\n&quot;,at91sam7_old_info-&gt;target_name);
-	buf += printed;
-	buf_size -= printed;
-	
-	printed = snprintf(buf, buf_size, &quot;cidr: 0x%8.8x, arch: 0x%4.4x, eproc: %s, version:0x%3.3x,  flashsize: 0x%8.8x\n&quot;,
-		  at91sam7_old_info-&gt;cidr, at91sam7_old_info-&gt;cidr_arch, EPROC_old[at91sam7_old_info-&gt;cidr_eproc], at91sam7_old_info-&gt;cidr_version, bank-&gt;size);
-	buf += printed;
-	buf_size -= printed;
-			
-	printed = snprintf(buf, buf_size, &quot;master clock(estimated): %ikHz \n&quot;, at91sam7_old_info-&gt;mck_freq / 1000);
-	buf += printed;
-	buf_size -= printed;
-	
-	if (at91sam7_old_info-&gt;num_planes&gt;1) {		
-		printed = snprintf(buf, buf_size, &quot;flashplanes: %i, pagesize: %i, lock regions: %i, pages in lock region: %i \n&quot;, 
-			   at91sam7_old_info-&gt;num_planes, at91sam7_old_info-&gt;pagesize, at91sam7_old_info-&gt;num_lockbits, at91sam7_old_info-&gt;num_pages/at91sam7_old_info-&gt;num_lockbits);
-		buf += printed;
-		buf_size -= printed;
-		for (flashplane=0; flashplane&lt;at91sam7_old_info-&gt;num_planes; flashplane++)
-		{
-			printed = snprintf(buf, buf_size, &quot;lockbits[%i]: 0x%4.4x,  &quot;, flashplane, at91sam7_old_info-&gt;lockbits[flashplane]);
-			buf += printed;
-			buf_size -= printed;
-		}
-	}
-	else
-	if (at91sam7_old_info-&gt;num_lockbits&gt;0) {		
-		printed = snprintf(buf, buf_size, &quot;pagesize: %i, lockbits: %i 0x%4.4x, pages in lock region: %i \n&quot;, 
-			   at91sam7_old_info-&gt;pagesize, at91sam7_old_info-&gt;num_lockbits, at91sam7_old_info-&gt;lockbits[0], at91sam7_old_info-&gt;num_pages/at91sam7_old_info-&gt;num_lockbits);
-		buf += printed;
-		buf_size -= printed;
-	}
-			
-	printed = snprintf(buf, buf_size, &quot;securitybit: %i,  nvmbits(%i): 0x%1.1x\n&quot;, at91sam7_old_info-&gt;securitybit, at91sam7_old_info-&gt;num_nvmbits, at91sam7_old_info-&gt;nvmbits);
-	buf += printed;
-	buf_size -= printed;
-
-	return ERROR_OK;
-}
-
-/* 
-* On AT91SAM7S: When the gpnvm bits are set with 
-* &gt; at91sam7_old gpnvm 0 bitnr set
-* the changes are not visible in the flash controller status register MC_FSR_old 
-* until the processor has been reset.
-* On the Olimex board this requires a power cycle.
-* Note that the AT91SAM7S has the following errata (doc6175.pdf sec 14.1.3):
-* 	The maximum number of write/erase cycles for Non Volatile Memory bits is 100. This includes
-*	Lock Bits (LOCKx), General Purpose NVM bits (GPNVMx) and the Security Bit.
-*/
-static int at91sam7_old_handle_gpnvm_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
-{
-	flash_bank_t *bank;
-	int bit;
-	u8  flashcmd;
-	u32 status;
-	char *value;
-	at91sam7_old_flash_bank_t *at91sam7_old_info;
-	int retval;
-
-	if (argc &lt; 3)
-	{
-		command_print(cmd_ctx, &quot;at91sam7_old gpnvm &lt;num&gt; &lt;bit&gt; &lt;set|clear&gt;&quot;);
-		return ERROR_OK;
-	}
-	
-	bank = get_flash_bank_by_num_noprobe(strtoul(args[0], NULL, 0));
-	bit = atoi(args[1]);
-	value = args[2];
-
-	if (bank ==  NULL)
-	{
-		return ERROR_FLASH_BANK_INVALID;
-	}
-
-	if (bank-&gt;driver != &amp;at91sam7_old_flash)
-	{
-		command_print(cmd_ctx, &quot;not an at91sam7_old flash bank '%s'&quot;, args[0]);
-		return ERROR_FLASH_BANK_INVALID;
-	}
-
-	if (strcmp(value, &quot;set&quot;) == 0)
-	{
-		flashcmd = SGPB_old;
-	}
-	else if (strcmp(value, &quot;clear&quot;) == 0)
-	{
-		flashcmd = CGPB_old;
-	}
-	else
-	{
-		return ERROR_COMMAND_SYNTAX_ERROR;
-	}
-
-	at91sam7_old_info = bank-&gt;driver_priv;
-
-	if (bank-&gt;target-&gt;state != TARGET_HALTED)
-	{
-		LOG_ERROR(&quot;target has to be halted to perform flash operation&quot;);
-		return ERROR_TARGET_NOT_HALTED;
-	}
-	
-	if (at91sam7_old_info-&gt;cidr == 0)
-	{
-		retval = at91sam7_old_read_part_info(bank);
-		if (retval != ERROR_OK) {
-			return retval;
-		}
-	}
-
-	if ((bit&lt;0) || (at91sam7_old_info-&gt;num_nvmbits &lt;= bit))
-	{ 
-		command_print(cmd_ctx, &quot;gpnvm bit '#%s' is out of bounds for target %s&quot;, args[1],at91sam7_old_info-&gt;target_name);
-		return ERROR_OK;
-	}
-
-	/* Configure the flash controller timing */
-	at91sam7_old_read_clock_info(bank);	
-	at91sam7_old_set_flash_mode(bank, 0, FMR_TIMING_NVBITS_old);
-	
-	if (at91sam7_old_flash_command(bank, 0, flashcmd, (u16)(bit)) != ERROR_OK) 
-	{
-		return ERROR_FLASH_OPERATION_FAILED;
-	}	
-
-	status = at91sam7_old_get_flash_status(bank, 0);
-	LOG_DEBUG(&quot;at91sam7_handle_gpnvm_command: cmd 0x%x, value 0x%x, status 0x%x \n&quot;,flashcmd,bit,status);
-	at91sam7_old_info-&gt;nvmbits = (status&gt;&gt;8)&amp;((1&lt;&lt;at91sam7_old_info-&gt;num_nvmbits)-1);
-
-	return ERROR_OK;
-}

Deleted: trunk/src/flash/at91sam7_old.h
===================================================================
--- trunk/src/flash/at91sam7_old.h	2009-05-07 06:51:27 UTC (rev 1631)
+++ trunk/src/flash/at91sam7_old.h	2009-05-07 06:58:52 UTC (rev 1632)
@@ -1,98 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2006 by Magnus Lundin                                   *
- *   <A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">lundin at mlu.mine.nu</A>                                                    *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-#ifndef AT91SAM7_OLD_H
-#define AT91SAM7_OLD_H
-
-#include &quot;flash.h&quot;
-#include &quot;target.h&quot;
-
-typedef struct at91sam7_old_flash_bank_s
-{
-	u32 working_area;
-	u32 working_area_size;
-
-	/* chip id register */
-	u32 cidr;
-	u16 cidr_ext;
-	u16 cidr_nvptyp;
-	u16 cidr_arch;
-	u16 cidr_sramsiz;
-	u16 cidr_nvpsiz;
-	u16 cidr_nvpsiz2;
-	u16 cidr_eproc;
-	u16 cidr_version;
-	char * target_name;
-
-	/* flash geometry */
-	u16 num_pages;
-	u16 pagesize;
-	u16 pages_in_lockregion;
-	u8 num_erase_regions;
-	u8 num_planes;
-	u32 *erase_region_info;
-
-	/* nv memory bits */
-	u16 num_lockbits;
-	u16 lockbits[4];
-	u16 num_nvmbits;
-	u16 nvmbits;
-	u8  securitybit;
-	u8  flashmode[4];         /* 0: not init, 1: fmcn for nvbits (1uS), 2: fmcn for flash (1.5uS) */
-
-	/* main clock status */
-	u8  mck_valid;
-	u32 mck_freq;
-
-} at91sam7_old_flash_bank_t;
-
-/* AT91SAM7 control registers */
-#define DBGU_CIDR_old 0xFFFFF240
-#define CKGR_MCFR_old 0xFFFFFC24
-#define CKGR_MCFR_MAINRDY_old  0x10000
-#define CKGR_PLLR_old 0xFFFFFC2c
-#define CKGR_PLLR_DIV_old 0xff
-#define CKGR_PLLR_MUL_old 0x07ff0000
-#define PMC_MCKR_old  0xFFFFFC30
-#define PMC_MCKR_CSS_old  0x03
-#define PMC_MCKR_PRES_old 0x1c
-
-/* Flash Controller Commands */
-#define  WP_old   0x01
-#define  SLB_old  0x02
-#define  WPL_old  0x03
-#define  CLB_old  0x04
-#define  EA_old   0x08
-#define  SGPB_old 0x0B
-#define  CGPB_old 0x0D
-#define  SSB_old  0x0F
-
-/* MC_FSR bit definitions */
-#define        MC_FSR_FRDY_old 1
-#define        MC_FSR_EOL_old 2
-
-/* AT91SAM7 constants */
-#define RC_FREQ_old  32000
-
-/*  FLASH_TIMING_MODES */
-#define  FMR_TIMING_NONE_old    0
-#define  FMR_TIMING_NVBITS_old  1
-#define  FMR_TIMING_FLASH_old   2
-
-#endif /* AT91SAM7_OLD_H */

Modified: trunk/src/flash/flash.c
===================================================================
--- trunk/src/flash/flash.c	2009-05-07 06:51:27 UTC (rev 1631)
+++ trunk/src/flash/flash.c	2009-05-07 06:58:52 UTC (rev 1632)
@@ -65,7 +65,6 @@
 extern flash_driver_t lpc2000_flash;
 extern flash_driver_t cfi_flash;
 extern flash_driver_t at91sam7_flash;
-extern flash_driver_t at91sam7_old_flash;
 extern flash_driver_t str7x_flash;
 extern flash_driver_t str9x_flash;
 extern flash_driver_t aduc702x_flash;
@@ -83,7 +82,6 @@
 	&amp;lpc2000_flash,
 	&amp;cfi_flash,
 	&amp;at91sam7_flash,
-	&amp;at91sam7_old_flash,
 	&amp;str7x_flash,
 	&amp;str9x_flash,
 	&amp;aduc702x_flash,


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000415.html">[Openocd-svn] r1631 - trunk/src/target
</A></li>
	<LI>Next message: <A HREF="000417.html">[Openocd-svn] r1633 - trunk/src/target/target
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#416">[ date ]</a>
              <a href="thread.html#416">[ thread ]</a>
              <a href="subject.html#416">[ subject ]</a>
              <a href="author.html#416">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openocd-svn">More information about the openocd-svn
mailing list</a><br>
</body></html>
