From gowinex at users.sourceforge.net  Thu Nov  4 14:54:42 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Thu,  4 Nov 2010 13:54:42 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-569-g9e3d43c
Message-ID: <E1PE0H5-0001LM-K4@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  9e3d43cfe75df7c4f6797d630576f1a02428b218 (commit)
      from  70b15389962637f13f5f3f10a6beebabed419c69 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 9e3d43cfe75df7c4f6797d630576f1a02428b218
Author: ddraskovic <ddraskovic at sequans.com>
Date:   Thu Nov 4 14:33:10 2010 +0100

    arm964e: Add support for ARM946E target.
    
    So far most of the people have been using existing ARM966E in the
    place of ARM946E, because they have practically the same scan chains.
    
    However, ARM946E has caches, which further complicates JATG handling
    via scan-chain. this was preventing single-stepping for ARM946E when
    SW breakpoints are used.
    
    This patch thus introduces :
    1) Correct cache handling on memory write
    2) Possibility to flush whole cache and turn it off during debug, or
    just to flush affected lines (faster and better)
    3) Correct SW breakpoint handling and correct single-stepping
    4) Corrects the bug on CP15 read and write, so CP15 values
    are now correctly R/W

diff --git a/src/target/Makefile.am b/src/target/Makefile.am
index e01e077..1e29ae7 100644
--- a/src/target/Makefile.am
+++ b/src/target/Makefile.am
@@ -60,6 +60,7 @@ ARM7_9_SRC = \
 	arm9tdmi.c \
 	arm920t.c \
 	arm966e.c \
+	arm946e.c \
 	arm926ejs.c \
 	feroceon.c
 
@@ -124,6 +125,7 @@ noinst_HEADERS = \
 	arm920t.h \
 	arm926ejs.h \
 	arm966e.h \
+	arm946e.h \
 	arm11.h \
 	arm11_dbgtap.h \
 	armv4_5.h \
diff --git a/src/target/arm946e.c b/src/target/arm946e.c
new file mode 100644
index 0000000..b9b9cef
--- /dev/null
+++ b/src/target/arm946e.c
@@ -0,0 +1,712 @@
+/***************************************************************************
+ *   Copyright (C) 2005 by Dominic Rath                                    *
+ *   Dominic.Rath at gmx.de                                                   *
+ *                                                                         *
+ *   Copyright (C) 2008 by Spencer Oliver                                  *
+ *   spen at spen-soft.co.uk                                                  *
+ *                                                                         *
+ *   Copyright (C) 2010 by Drasko DRASKOVIC                                *
+ *   drasko.draskovic at gmail.com                                            *
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ *   This program is distributed in the hope that it will be useful,       *
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
+ *   GNU General Public License for more details.                          *
+ *                                                                         *
+ *   You should have received a copy of the GNU General Public License     *
+ *   along with this program; if not, write to the                         *
+ *   Free Software Foundation, Inc.,                                       *
+ *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
+ ***************************************************************************/
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
+#include "arm946e.h"
+#include "target_type.h"
+#include "arm_opcodes.h"
+
+#include "breakpoints.h"
+
+#if 0
+#define _DEBUG_INSTRUCTION_EXECUTION_
+#endif
+
+#define NB_CACHE_WAYS 4
+
+static uint32_t dc = 0x0;
+static uint32_t ic = 0x0;
+
+/**
+ * flag to give info about cache manipulation during debug :
+ * "0"	-	cache lines are invalidated "on the fly", for affected addresses.
+ *			This is prefered from performance point of view.
+ * "1"	-	cache is invalidated and switched off on debug_entry, and switched back on on restore.
+ *			It is kept off during debugging.
+ */
+static uint8_t arm946e_preserve_cache;
+
+int arm946e_post_debug_entry(struct target *target);
+void arm946e_pre_restore_context(struct target *target);
+static int arm946e_read_cp15(struct target *target, int reg_addr, uint32_t *value);
+
+
+int arm946e_init_arch_info(struct target *target, struct arm946e_common *arm946e, struct jtag_tap *tap)
+{
+	struct arm7_9_common *arm7_9 = &arm946e->arm7_9_common;
+
+	/* initialize arm7/arm9 specific info (including armv4_5) */
+	arm9tdmi_init_arch_info(target, arm7_9, tap);
+
+	arm946e->common_magic = ARM946E_COMMON_MAGIC;
+
+	/**
+	 * The ARM946E-S implements the ARMv5TE architecture which
+	 * has the BKPT instruction, so we don't have to use a watchpoint comparator
+	 */
+	arm7_9->arm_bkpt = ARMV5_BKPT(0x0);
+	arm7_9->thumb_bkpt = ARMV5_T_BKPT(0x0) & 0xffff;
+
+
+	arm7_9->post_debug_entry = arm946e_post_debug_entry;
+	arm7_9->pre_restore_context = arm946e_pre_restore_context;
+
+	/**
+	 * disabling linefills leads to lockups, so keep them enabled for now
+	 * this doesn't affect correctness, but might affect timing issues, if
+	 * important data is evicted from the cache during the debug session
+	 */
+	arm946e_preserve_cache = 0;
+
+	/* override hw single-step capability from ARM9TDMI */
+	//arm7_9->has_single_step = 1;
+
+	return ERROR_OK;
+}
+
+static int arm946e_target_create(struct target *target, Jim_Interp *interp)
+{
+	struct arm946e_common *arm946e = calloc(1,sizeof(struct arm946e_common));
+
+	arm946e_init_arch_info(target, arm946e, target->tap);
+
+	return ERROR_OK;
+}
+
+static int arm946e_verify_pointer(struct command_context *cmd_ctx,
+		struct arm946e_common *arm946e)
+{
+	if (arm946e->common_magic != ARM946E_COMMON_MAGIC) {
+		command_print(cmd_ctx, "target is not an ARM946");
+		return ERROR_TARGET_INVALID;
+	}
+	return ERROR_OK;
+}
+
+/*
+ * REVISIT:  The "read_cp15" and "write_cp15" commands could hook up
+ * to eventual mrc() and mcr() routines ... the reg_addr values being
+ * constructed (for CP15 only) from Opcode_1, Opcode_2, and CRn values.
+ * See section 7.3 of the ARM946E-S TRM.
+ */
+static int arm946e_read_cp15(struct target *target, int reg_addr, uint32_t *value)
+{
+	int retval = ERROR_OK;
+	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
+	struct arm_jtag *jtag_info = &arm7_9->jtag_info;
+	struct scan_field fields[3];
+	uint8_t reg_addr_buf = reg_addr & 0x3f;
+	uint8_t nr_w_buf = 0;
+
+	if ((retval = arm_jtag_scann(jtag_info, 0xf, TAP_IDLE)) != ERROR_OK)
+	{
+		return retval;
+	}
+	retval = arm_jtag_set_instr(jtag_info, jtag_info->intest_instr, NULL, TAP_IDLE);
+	if (retval != ERROR_OK)
+		return retval;
+
+	fields[0].num_bits = 32;
+	/* REVISIT: table 7-2 shows that bits 31-31 need to be
+	 * specified for accessing BIST registers ...
+	 */
+	fields[0].out_value = NULL;
+	fields[0].in_value = NULL;
+
+	fields[1].num_bits = 6;
+	fields[1].out_value = &reg_addr_buf;
+	fields[1].in_value = NULL;
+
+	fields[2].num_bits = 1;
+	fields[2].out_value = &nr_w_buf;
+	fields[2].in_value = NULL;
+
+	jtag_add_dr_scan(jtag_info->tap, 3, fields, TAP_IDLE);
+
+	fields[0].in_value = (uint8_t *)value;
+	jtag_add_dr_scan(jtag_info->tap, 3, fields, TAP_IDLE);
+
+	jtag_add_callback(arm_le_to_h_u32, (jtag_callback_data_t)value);
+
+#ifdef _DEBUG_INSTRUCTION_EXECUTION_
+	LOG_DEBUG("addr: 0x%x value: %8.8x", reg_addr, *value);
+#endif
+
+	if ((retval = jtag_execute_queue()) != ERROR_OK)
+	{
+		return retval;
+	}
+
+	return ERROR_OK;
+}
+
+int arm946e_write_cp15(struct target *target, int reg_addr, uint32_t value)
+{
+	int retval = ERROR_OK;
+	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
+	struct arm_jtag *jtag_info = &arm7_9->jtag_info;
+	struct scan_field fields[3];
+	uint8_t reg_addr_buf = reg_addr & 0x3f;
+	uint8_t nr_w_buf = 1;
+	uint8_t value_buf[4];
+
+	buf_set_u32(value_buf, 0, 32, value);
+
+	if ((retval = arm_jtag_scann(jtag_info, 0xf, TAP_IDLE)) != ERROR_OK)
+	{
+		return retval;
+	}
+	retval = arm_jtag_set_instr(jtag_info, jtag_info->intest_instr, NULL, TAP_IDLE);
+	if (retval != ERROR_OK)
+		return retval;
+
+	fields[0].num_bits = 32;
+	fields[0].out_value = value_buf;
+	fields[0].in_value = NULL;
+
+	fields[1].num_bits = 6;
+	fields[1].out_value = &reg_addr_buf;
+	fields[1].in_value = NULL;
+
+	fields[2].num_bits = 1;
+	fields[2].out_value = &nr_w_buf;
+	fields[2].in_value = NULL;
+
+	jtag_add_dr_scan(jtag_info->tap, 3, fields, TAP_IDLE);
+
+#ifdef _DEBUG_INSTRUCTION_EXECUTION_
+	LOG_DEBUG("addr: 0x%x value: %8.8x", reg_addr, value);
+#endif
+
+	if ((retval = jtag_execute_queue()) != ERROR_OK)
+	{
+		return retval;
+	}
+
+	return ERROR_OK;
+}
+
+uint32_t arm946e_invalidate_whole_dcache(struct target *target)
+{
+
+   uint32_t csize = 0;
+   uint32_t shift = 0;
+   uint32_t cp15_idx, seg, dtag;
+   int nb_idx, idx = 0;
+   int retval;
+
+   /* Get cache type */
+   arm946e_read_cp15(target, 0x01, (uint32_t *) &csize);
+
+   csize = (csize >> 18) & 0x0F;
+
+	if (csize == 0)
+		shift = 0;
+	else
+		shift = csize - 0x3; /* Now 0 = 4KB, 1 = 8KB, ... */
+
+	/* Cache size, given in bytes */
+	csize = 1 << (12 + shift);
+	/* One line (index) is 32 bytes (8 words) long */
+	nb_idx = (csize / 32);	/* gives nb of lines (indexes) in the cache */
+
+	/* Loop for all segmentde (i.e. ways) */
+	for( seg=0; seg < NB_CACHE_WAYS; seg++)
+	{
+		/* Loop for all indexes */
+		for(idx=0; idx < nb_idx; idx++)
+		{
+			/* Form and write cp15 index (segment + line idx) */
+			cp15_idx = seg << 30 | idx << 5;
+			retval = arm946e_write_cp15(target, 0x3a, cp15_idx);
+			if (retval != ERROR_OK)
+			{
+				LOG_DEBUG("ERROR writing index\n");
+				return retval;
+			}
+
+			/* Read dtag */
+			arm946e_read_cp15(target, 0x16, (uint32_t *) &dtag);
+
+			/* Check cache line VALID bit */
+			if ( !(dtag >> 4 & 0x1) )
+				continue;
+
+			/* Clean data cache line */
+			retval = arm946e_write_cp15(target, 0x35, 0x1);
+			if (retval != ERROR_OK)
+			{
+				LOG_DEBUG("ERROR cleaning cache line\n");
+				return retval;
+			}
+
+			/* Flush data cache line */
+			retval = arm946e_write_cp15(target, 0x1a, 0x1);
+			if (retval != ERROR_OK)
+			{
+				LOG_DEBUG("ERROR flushing cache line\n");
+				return retval;
+			}
+		}
+	}
+
+	return ERROR_OK;
+}
+
+uint32_t arm946e_invalidate_whole_icache(struct target *target)
+{
+	int retval;
+
+	LOG_DEBUG("FLUSHING I$");
+
+	/**
+	 *  Invalidate (flush) I$
+	 *  mcr	15, 0, r0, cr7, cr5, {0}
+	 */
+	retval = arm946e_write_cp15(target, 0x0f, 0x1);
+	if (retval != ERROR_OK)
+	{
+		LOG_DEBUG("ERROR flushing I$\n");
+		return retval;
+	}
+
+	return ERROR_OK;
+}
+
+int arm946e_post_debug_entry(struct target *target)
+{
+	uint32_t ctr_reg = 0x0;
+	uint32_t retval = ERROR_OK;
+
+	/* See if CACHES are enabled, and save that info
+	 * in the global vars, so that arm946e_pre_restore_context() can use them */
+	arm946e_read_cp15(target, 0x02, (uint32_t *) &ctr_reg);
+	dc = (ctr_reg >> 2) & 0x01;
+	ic = (ctr_reg >> 12) & 0x01;
+
+	if (arm946e_preserve_cache)
+	{
+		if (dc == 1)
+		{
+			/* Clean and flush D$ */
+			arm946e_invalidate_whole_dcache(target);
+
+			/* Disable D$ */
+			ctr_reg &= ~(1 << 2);
+		}
+
+		if (ic == 1)
+		{
+			/* Flush I$ */
+			arm946e_invalidate_whole_icache(target);
+
+			/* Disable I$ */
+			ctr_reg &= ~(1 << 12);
+		}
+
+		/* Write the new configuration */
+		retval = arm946e_write_cp15(target, 0x02, ctr_reg);
+		if (retval != ERROR_OK)
+		{
+			LOG_DEBUG("ERROR disabling cache");
+			return retval;
+		}
+	} /* if preserve_cache */
+
+	return ERROR_OK;
+}
+
+void arm946e_pre_restore_context(struct target *target)
+{
+	uint32_t ctr_reg = 0x0;
+	uint32_t retval;
+
+	if (arm946e_preserve_cache)
+	{
+		/* Get the contents of the CTR reg */
+		arm946e_read_cp15(target, 0x02, (uint32_t *) &ctr_reg);
+
+		/**
+		 * Read-modify-write CP15 test state register
+		 * to reenable I/D-cache linefills
+		 */
+		if (dc == 1)
+		{
+			/* Enable D$ */
+			ctr_reg |= 1 << 2;
+		}
+
+		if (ic == 1)
+		{
+			/* Enable I$ */
+			ctr_reg |= 1 << 12;
+		}
+
+		/* Write the new configuration */
+		retval = arm946e_write_cp15(target, 0x02, ctr_reg);
+		if (retval != ERROR_OK)
+		{
+			LOG_DEBUG("ERROR enabling cache\n");
+		}
+	} /* if preserve_cache */
+}
+
+uint32_t arm946e_invalidate_dcache(struct target *target, uint32_t address,
+		uint32_t size, uint32_t count)
+{
+	uint32_t csize = 0x0;
+	uint32_t shift = 0;
+	uint32_t cur_addr = 0x0;
+	uint32_t cp15_idx, set, way, dtag;
+	int nb_idx;
+	uint32_t i = 0;
+	int retval;
+
+	for(i = 0; i < count*size; i++)
+	{
+		cur_addr = address + i;
+
+		/* Get cache type */
+		arm946e_read_cp15(target, 0x01, (uint32_t *) &csize);
+
+		/* Conclude cache size to find number of lines */
+		csize = (csize >> 18) & 0x0F;
+
+		if (csize == 0)
+			shift = 0;
+		else
+			shift = csize - 0x3; /* Now 0 = 4KB, 1 = 8KB, ... */
+
+		csize = 1 << (12 + shift);
+		nb_idx = (csize / 32);
+
+		set = (cur_addr >> 5) & 0xff;	/* set field is 8 bits long */
+
+		for (way = 0; way < NB_CACHE_WAYS; way++)
+		{
+			/**
+			 * Find if the affected address is kept in the cache.
+			 * Because JTAG Scan Chain 15 offers limited approach,
+			 * we have to loop through all cache ways (segments) and
+			 * read cache tags, then compare them with with address.
+			 */
+
+			/* Form and write cp15 index (segment + line idx) */
+			cp15_idx = way << 30 | set << 5;
+			retval = arm946e_write_cp15(target, 0x3a, cp15_idx);
+			if (retval != ERROR_OK)
+			{
+				LOG_DEBUG("ERROR writing index\n");
+				return retval;
+			}
+
+			/* Read dtag */
+			arm946e_read_cp15(target, 0x16, (uint32_t *) &dtag);
+
+			/* Check cache line VALID bit */
+			if ( !(dtag >> 4 & 0x1) )
+				continue;
+
+			/* If line is valid and corresponds to affected address - invalidate it */
+			if (dtag >> 5 == cur_addr >> 5)
+			{
+				/* Clean data cache line */
+				retval = arm946e_write_cp15(target, 0x35, 0x1);
+				if (retval != ERROR_OK)
+				{
+					LOG_DEBUG("ERROR cleaning cache line\n");
+					return retval;
+				}
+
+				/* Flush data cache line */
+				retval = arm946e_write_cp15(target, 0x1c, 0x1);
+				if (retval != ERROR_OK)
+				{
+					LOG_DEBUG("ERROR flushing cache line\n");
+					return retval;
+				}
+
+				break;
+			}
+		} /* loop through all 4 ways */
+	} /* loop through all addresses */
+
+	return ERROR_OK;
+}
+
+uint32_t arm946e_invalidate_icache(struct target *target, uint32_t address,
+		uint32_t size, uint32_t count)
+{
+	uint32_t cur_addr = 0x0;
+	uint32_t cp15_idx, set, way, itag;
+	uint32_t i = 0;
+	int retval;
+
+	for(i = 0; i < count*size; i++)
+	{
+		cur_addr = address + i;
+
+		set = (cur_addr >> 5) & 0xff;	/* set field is 8 bits long */
+
+		for (way = 0; way < NB_CACHE_WAYS; way++)
+		{
+			/* Form and write cp15 index (segment + line idx) */
+			cp15_idx = way << 30 | set << 5;
+			retval = arm946e_write_cp15(target, 0x3a, cp15_idx);
+			if (retval != ERROR_OK)
+			{
+				LOG_DEBUG("ERROR writing index\n");
+				return retval;
+			}
+
+			/* Read itag */
+			arm946e_read_cp15(target, 0x17, (uint32_t *) &itag);
+
+			/* Check cache line VALID bit */
+			if ( !(itag >> 4 & 0x1) )
+				continue;
+
+			/* If line is valid and corresponds to affected address - invalidate it */
+			if (itag >> 5 == cur_addr >> 5)
+			{
+				/* Flush I$ line */
+				retval = arm946e_write_cp15(target, 0x1d, 0x0);
+				if (retval != ERROR_OK)
+				{
+					LOG_DEBUG("ERROR flushing cache line\n");
+					return retval;
+				}
+
+				break;
+			}
+		} /* way loop */
+	} /* addr loop */
+
+	return ERROR_OK;
+}
+
+/** Writes a buffer, in the specified word size, with current MMU settings. */
+int arm946e_write_memory(struct target *target, uint32_t address,
+		uint32_t size, uint32_t count, uint8_t *buffer)
+{
+	int retval;
+
+	LOG_DEBUG("-");
+
+	/* Invalidate D$ if it is ON */
+	if (!arm946e_preserve_cache && dc == 1)
+	{
+		arm946e_invalidate_dcache(target, address, size, count);
+	}
+
+	/**
+	 * Write memory
+	 */
+	if ( ( retval = arm7_9_write_memory(target, address,
+			size, count, buffer) ) != ERROR_OK )
+	{
+		return retval;
+	}
+
+	/* *
+	 * Invalidate I$ if it is ON.
+	 *
+	 * D$ has been cleaned and flushed before mem write thus forcing it to behave like write-through,
+	 * because arm7_9_write_memory() has seen non-valid bit in D$
+	 * and wrote data into physical RAM (without touching or allocating the cache line).
+	 * From ARM946ES Technical Reference Manual we can see that it uses "allocate on read-miss"
+	 * policy for both I$ and D$ (Chapter 3.2 and 3.3)
+	 *
+	 * Explanation :
+	 * "ARM system developer's guide: designing and optimizing system software" by
+	 * Andrew N. Sloss, Dominic Symes and Chris Wright,
+	 * Chapter 12.3.3 Allocating Policy on a Cache Miss :
+	 * A read allocate on cache miss policy allocates a cache line only during a read from main memory.
+	 * If the victim cache line contains valid data, then it is written to main memory before the cache line
+	 * is filled with new data.
+	 * Under this strategy, a write of new data to memory does not update the contents of the cache memory
+	 * unless a cache line was allocated on a previous read from main memory.
+	 * If the cache line contains valid data, then the write updates the cache and may update the main memory if
+	 * the cache write policy is write-through.
+	 * If the data is not in the cache, the controller writes to main memory only.
+	 */
+	if (!arm946e_preserve_cache && ic == 1)
+	{
+		arm946e_invalidate_icache(target, address, size, count);
+	}
+
+	return ERROR_OK;
+
+}
+
+int arm946e_read_memory(struct target *target, uint32_t address,
+		uint32_t size, uint32_t count, uint8_t *buffer)
+{
+	int retval;
+
+	LOG_DEBUG("-");
+
+	if ( ( retval = arm7_9_read_memory(target, address,
+			size, count, buffer) ) != ERROR_OK )
+	{
+		return retval;
+	}
+
+	return ERROR_OK;
+}
+
+
+COMMAND_HANDLER(arm946e_handle_cp15_command)
+{
+	int retval;
+	struct target *target = get_current_target(CMD_CTX);
+	struct arm946e_common *arm946e = target_to_arm946(target);
+
+	retval = arm946e_verify_pointer(CMD_CTX, arm946e);
+	if (retval != ERROR_OK)
+		return retval;
+
+	if (target->state != TARGET_HALTED)
+	{
+		command_print(CMD_CTX, "target must be stopped for \"%s\" command", CMD_NAME);
+		return ERROR_OK;
+	}
+
+	/* one or more argument, access a single register (write if second argument is given */
+	if (CMD_ARGC >= 1)
+	{
+		uint32_t address;
+		COMMAND_PARSE_NUMBER(u32, CMD_ARGV[0], address);
+
+		if (CMD_ARGC == 1)
+		{
+			uint32_t value;
+			if ((retval = arm946e_read_cp15(target, address, &value)) != ERROR_OK)
+			{
+				command_print(CMD_CTX,
+						"couldn't access reg %" PRIi32,
+						address);
+				return ERROR_OK;
+			}
+			if ((retval = jtag_execute_queue()) != ERROR_OK)
+			{
+				return retval;
+			}
+
+			command_print(CMD_CTX, "%" PRIi32 ": %8.8" PRIx32,
+					address, value);
+		}
+		else if (CMD_ARGC == 2)
+		{
+			uint32_t value;
+			COMMAND_PARSE_NUMBER(u32, CMD_ARGV[1], value);
+			if ((retval = arm946e_write_cp15(target, address, value)) != ERROR_OK)
+			{
+				command_print(CMD_CTX,
+						"couldn't access reg %" PRIi32,
+						address);
+				return ERROR_OK;
+			}
+			command_print(CMD_CTX, "%" PRIi32 ": %8.8" PRIx32,
+					address, value);
+		}
+	}
+
+	return ERROR_OK;
+}
+
+static const struct command_registration arm946e_exec_command_handlers[] = {
+	{
+		.name = "cp15",
+		.handler = arm946e_handle_cp15_command,
+		.mode = COMMAND_EXEC,
+		.usage = "regnum [value]",
+		.help = "display/modify cp15 register",
+	},
+	COMMAND_REGISTRATION_DONE
+};
+
+const struct command_registration arm946e_command_handlers[] = {
+	{
+		.chain = arm9tdmi_command_handlers,
+	},
+	{
+		.name = "arm946e",
+		.mode = COMMAND_ANY,
+		.help = "arm946e command group",
+		.chain = arm946e_exec_command_handlers,
+	},
+	COMMAND_REGISTRATION_DONE
+};
+
+/** Holds methods for ARM946 targets. */
+struct target_type arm946e_target =
+{
+	.name = "arm946e",
+
+	.poll = arm7_9_poll,
+	.arch_state = arm_arch_state,
+
+	.target_request_data = arm7_9_target_request_data,
+
+	.halt = arm7_9_halt,
+	.resume = arm7_9_resume,
+	.step = arm7_9_step,
+
+	.assert_reset = arm7_9_assert_reset,
+	.deassert_reset = arm7_9_deassert_reset,
+	.soft_reset_halt = arm7_9_soft_reset_halt,
+
+	.get_gdb_reg_list = arm_get_gdb_reg_list,
+
+	//.read_memory = arm7_9_read_memory,
+	//.write_memory = arm7_9_write_memory,
+	.read_memory = arm946e_read_memory,
+	.write_memory = arm946e_write_memory,
+
+	.bulk_write_memory = arm7_9_bulk_write_memory,
+
+	.checksum_memory = arm_checksum_memory,
+	.blank_check_memory = arm_blank_check_memory,
+
+	.run_algorithm = armv4_5_run_algorithm,
+
+	.add_breakpoint = arm7_9_add_breakpoint,
+	.remove_breakpoint = arm7_9_remove_breakpoint,
+	//.add_breakpoint = arm946e_add_breakpoint,
+	//.remove_breakpoint = arm946e_remove_breakpoint,
+
+	.add_watchpoint = arm7_9_add_watchpoint,
+	.remove_watchpoint = arm7_9_remove_watchpoint,
+
+	.commands = arm946e_command_handlers,
+	.target_create = arm946e_target_create,
+	.init_target = arm9tdmi_init_target,
+	.examine = arm7_9_examine,
+	.check_reset = arm7_9_check_reset,
+};
diff --git a/src/target/arm946e.h b/src/target/arm946e.h
new file mode 100644
index 0000000..557674e
--- /dev/null
+++ b/src/target/arm946e.h
@@ -0,0 +1,53 @@
+/***************************************************************************
+ *   Copyright (C) 2005 by Dominic Rath                                    *
+ *   Dominic.Rath at gmx.de                                                   *
+ *                                                                         *
+ *   Copyright (C) 2008 by Spencer Oliver                                  *
+ *   spen at spen-soft.co.uk                                                  *
+ *                                                                         *
+ *   Copyright (C) 2010 by Drasko DRASKOVIC                                *
+ *   drasko.draskovic at gmail.com                                            *
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ *   This program is distributed in the hope that it will be useful,       *
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
+ *   GNU General Public License for more details.                          *
+ *                                                                         *
+ *   You should have received a copy of the GNU General Public License     *
+ *   along with this program; if not, write to the                         *
+ *   Free Software Foundation, Inc.,                                       *
+ *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
+ ***************************************************************************/
+#ifndef ARM946E_H
+#define ARM946E_H
+
+#include "arm9tdmi.h"
+
+#define	ARM946E_COMMON_MAGIC 0x20f920f9
+
+struct arm946e_common
+{
+	struct arm7_9_common arm7_9_common;
+	int common_magic;
+	uint32_t cp15_control_reg;
+};
+
+static inline struct arm946e_common *
+target_to_arm946(struct target *target)
+{
+	return container_of(target->arch_info, struct arm946e_common,
+			arm7_9_common.armv4_5_common);
+}
+
+int arm946e_init_arch_info(struct target *target,
+		struct arm946e_common *arm946e, struct jtag_tap *tap);
+int arm946e_write_cp15(struct target *target, int reg_addr, uint32_t value);
+
+extern const struct command_registration arm946e_command_handlers[];
+
+#endif /* ARM946E_H */
diff --git a/src/target/target.c b/src/target/target.c
index d200ebc..a282aab 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -58,6 +58,7 @@ extern struct target_type arm720t_target;
 extern struct target_type arm9tdmi_target;
 extern struct target_type arm920t_target;
 extern struct target_type arm966e_target;
+extern struct target_type arm946e_target;
 extern struct target_type arm926ejs_target;
 extern struct target_type fa526_target;
 extern struct target_type feroceon_target;
@@ -79,6 +80,7 @@ static struct target_type *target_types[] =
 	&arm920t_target,
 	&arm720t_target,
 	&arm966e_target,
+	&arm946e_target,
 	&arm926ejs_target,
 	&fa526_target,
 	&feroceon_target,

-----------------------------------------------------------------------

Summary of changes:
 src/target/Makefile.am              |    2 +
 src/target/arm946e.c                |  712 +++++++++++++++++++++++++++++++++++
 src/target/{arm966e.h => arm946e.h} |   27 +-
 src/target/target.c                 |    2 +
 4 files changed, 731 insertions(+), 12 deletions(-)
 create mode 100644 src/target/arm946e.c
 copy src/target/{arm966e.h => arm946e.h} (71%)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Sat Nov  6 15:39:58 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Sat,  6 Nov 2010 14:39:58 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-574-g8f1f8e7
Message-ID: <E1PEjvz-0001dv-Ne@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  8f1f8e7b96d4dfdca867cfcf69e0efab9f6e3731 (commit)
       via  d5b9c7998c43ee783c224035002cf32f062b0e2b (commit)
       via  1fa91f336ae35a0b7b127c81c46ff9b5041e088e (commit)
       via  887cac65b0672910bda4fec34ed05d72ce7208aa (commit)
       via  0649fb2f6c7e1bea138769ecc2ec8dc17ae98044 (commit)
      from  9e3d43cfe75df7c4f6797d630576f1a02428b218 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 8f1f8e7b96d4dfdca867cfcf69e0efab9f6e3731
Author: Marek Vasut <marek.vasut at gmail.com>
Date:   Fri Oct 29 03:06:16 2010 +0200

    Add EfikaMX smarttop board support
    
    This patch finally adds support for i.MX51 based Genesi USA EfikaMX smarttop
    board.
    
    Signed-off-by: Marek Vasut <marek.vasut at gmail.com>

diff --git a/tcl/board/efikamx.cfg b/tcl/board/efikamx.cfg
new file mode 100644
index 0000000..f8ae25d
--- /dev/null
+++ b/tcl/board/efikamx.cfg
@@ -0,0 +1,9 @@
+# Genesi USA EfikaMX
+#  http://www.genesi-usa.com/products/efika
+
+# Fall back to 6MHz if RTCK is not supported
+jtag_rclk 6000
+
+source [find target/imx51.cfg]
+
+reset_config trst_only

commit d5b9c7998c43ee783c224035002cf32f062b0e2b
Author: Marek Vasut <marek.vasut at gmail.com>
Date:   Fri Oct 29 02:57:32 2010 +0200

    CortexA8: Introduce Freescale i.MX51 variant
    
    This patch introduces support for Cortex A8 based Freescale i.MX51 CPU. This CPU
    has the Debug Access Port located at a different address (0x60008000) than TI
    OMAP3 series of CPUs.
    
    i.MX51 configuration file based on OMAP3 configuration file and an email from
    Alan Carvalho de Assis <acassis at gmail.com>.
    
    Signed-off-by: Marek Vasut <marek.vasut at gmail.com>

diff --git a/tcl/target/imx51.cfg b/tcl/target/imx51.cfg
new file mode 100644
index 0000000..b1390ec
--- /dev/null
+++ b/tcl/target/imx51.cfg
@@ -0,0 +1,51 @@
+# Freescale i.MX51
+
+if { [info exists CHIPNAME] } {
+   set  _CHIPNAME $CHIPNAME
+} else {
+   set  _CHIPNAME imx51
+}
+
+# CoreSight Debug Access Port
+if { [info exists DAP_TAPID ] } {
+   set _DAP_TAPID $DAP_TAPID
+} else {
+   set _DAP_TAPID 0x1ba00477
+}
+
+jtag newtap $_CHIPNAME DAP -irlen 4 -ircapture 0x1 -irmask 0xf \
+        -expected-id $_DAP_TAPID
+
+# SDMA / no IDCODE
+jtag newtap $_CHIPNAME SDMA -irlen 4 -ircapture 0x0 -irmask 0xf
+
+# SJC
+if { [info exists SJC_TAPID ] } {
+   set _SJC_TAPID SJC_TAPID
+} else {
+   set _SJC_TAPID 0x0190c01d
+}
+
+jtag newtap $_CHIPNAME SJC -irlen 5 -ircapture 0x1 -irmask 0x1f \
+        -expected-id $_SJC_TAPID -ignore-version
+
+# GDB target:  Cortex-A8, using DAP
+set _TARGETNAME $_CHIPNAME.cpu
+target create $_TARGETNAME cortex_a8 -chain-position $_CHIPNAME.DAP
+
+# some TCK tycles are required to activate the DEBUG power domain
+jtag configure $_CHIPNAME.SJC -event post-reset "runtest 100"
+
+# have the DAP "always" be active
+jtag configure $_CHIPNAME.SJC -event setup "jtag tapenable $_CHIPNAME.DAP"
+
+proc imx51_dbginit {target} {
+     # General Cortex A8 debug initialisation
+     cortex_a8 dbginit
+}
+
+# Slow speed to be sure it will work
+jtag_rclk 1000
+$_TARGETNAME configure -event "reset-start" { jtag_rclk 1000 }
+
+$_TARGETNAME configure -event reset-assert-post "imx51_dbginit $_TARGETNAME"

commit 1fa91f336ae35a0b7b127c81c46ff9b5041e088e
Author: Marek Vasut <marek.vasut at gmail.com>
Date:   Fri Oct 29 02:57:32 2010 +0200

    CortexA8: Implement debug base autodetection
    
    Implement autodetection of debug base. Also, implement a function solving
    various hardware quirks (like iMX51 ROM Table location bug).
    
    Signed-off-by: Marek Vasut <marek.vasut at gmail.com>

diff --git a/src/target/cortex_a8.c b/src/target/cortex_a8.c
index 8b4ced5..3c80923 100644
--- a/src/target/cortex_a8.c
+++ b/src/target/cortex_a8.c
@@ -73,7 +73,6 @@ static int cortex_a8_get_ttb(struct target *target, uint32_t *result);
  */
 #define swjdp_memoryap 0
 #define swjdp_debugap 1
-#define OMAP3530_DEBUG_BASE 0x54011000
 
 /*
  * Cortex-A8 Basic debug access, very low level assumes state is saved
@@ -1714,12 +1713,7 @@ static int cortex_a8_examine_first(struct target *target)
 	int i;
 	int retval = ERROR_OK;
 	uint32_t didr, ctypr, ttypr, cpuid;
-
-	/* stop assuming this is an OMAP! */
-	LOG_DEBUG("TODO - autoconfigure");
-
-	/* Here we shall insert a proper ROM Table scan */
-	armv7a->debug_base = OMAP3530_DEBUG_BASE;
+	uint32_t dbgbase, apid;
 
 	/* We do one extra read to ensure DAP is configured,
 	 * we call ahbap_debugport_init(swjdp) instead
@@ -1728,6 +1722,17 @@ static int cortex_a8_examine_first(struct target *target)
 	if (retval != ERROR_OK)
 		return retval;
 
+	/* Get ROM Table base */
+	retval = dap_get_debugbase(swjdp, 1, &dbgbase, &apid);
+	if (retval != ERROR_OK)
+		return retval;
+
+	/* Lookup 0x15 -- Processor DAP */
+	retval = dap_lookup_cs_component(swjdp, 1, dbgbase, 0x15,
+					&armv7a->debug_base);
+	if (retval != ERROR_OK)
+		return retval;
+
 	retval = mem_ap_read_atomic_u32(swjdp, armv7a->debug_base + CPUDBG_CPUID, &cpuid);
 	if (retval != ERROR_OK)
 		return retval;

commit 887cac65b0672910bda4fec34ed05d72ce7208aa
Author: Marek Vasut <marek.vasut at gmail.com>
Date:   Sun Oct 31 07:11:47 2010 +0100

    ADIv5: Implement function to lookup CoreSight component
    
    This patch implements "dap_lookup_cs_component()", which allows to lookup CS
    component by it's identification.
    
    Signed-off-by: Marek Vasut <marek.vasut at gmail.com>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 4950121..81edba4 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -1062,6 +1062,47 @@ int dap_get_debugbase(struct adiv5_dap *dap, int apsel,
 	return ERROR_OK;
 }
 
+int dap_lookup_cs_component(struct adiv5_dap *dap, int apsel,
+			uint32_t dbgbase, uint8_t type, uint32_t *addr)
+{
+	uint32_t apselold;
+	uint32_t romentry, entry_offset = 0, component_base, devtype;
+	int retval = ERROR_FAIL;
+
+	if (apsel >= 256)
+		return ERROR_INVALID_ARGUMENTS;
+
+	apselold = dap->apsel;
+	dap_ap_select(dap, apsel);
+
+	do
+	{
+		retval = mem_ap_read_atomic_u32(dap, (dbgbase&0xFFFFF000) |
+						entry_offset, &romentry);
+		if (retval != ERROR_OK)
+			return retval;
+
+		component_base = (dbgbase & 0xFFFFF000)
+			+ (romentry & 0xFFFFF000);
+
+		if (romentry & 0x1) {
+			retval = mem_ap_read_atomic_u32(dap,
+					(component_base & 0xfffff000) | 0xfcc,
+					&devtype);
+			if ((devtype & 0xff) == type) {
+				*addr = component_base;
+				retval = ERROR_OK;
+				break;
+			}
+		}
+		entry_offset += 4;
+	} while (romentry > 0);
+
+	dap_ap_select(dap, apselold);
+
+	return retval;
+}
+
 static int dap_info_command(struct command_context *cmd_ctx,
 		struct adiv5_dap *dap, int apsel)
 {
diff --git a/src/target/arm_adi_v5.h b/src/target/arm_adi_v5.h
index 27a2f2f..6c1808a 100644
--- a/src/target/arm_adi_v5.h
+++ b/src/target/arm_adi_v5.h
@@ -383,6 +383,10 @@ int ahbap_debugport_init(struct adiv5_dap *swjdp);
 int dap_get_debugbase(struct adiv5_dap *dap, int apsel,
 			uint32_t *dbgbase, uint32_t *apid);
 
+/* Lookup CoreSight component */
+int dap_lookup_cs_component(struct adiv5_dap *dap, int apsel,
+			uint32_t dbgbase, uint8_t type, uint32_t *addr);
+
 struct target;
 
 /* Put debug link into SWD mode */

commit 0649fb2f6c7e1bea138769ecc2ec8dc17ae98044
Author: Marek Vasut <marek.vasut at gmail.com>
Date:   Sun Oct 31 05:24:36 2010 +0100

    ADIv5: Introduce function to detect ROM Table location
    
    This patch adds function called "dap_detect_debug_base()", which should be
    called to get location of the ROM Table. By walking ROM Table, it's possible to
    discover the location of DAP.
    
    Sadly, some CPUs misreport this value, therefore I had to introduce an fixup
    table, which will be used in case such CPU is detected.
    
    Signed-off-by: Marek Vasut <marek.vasut at gmail.com>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 3414796..4950121 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -906,7 +906,7 @@ extern const struct dap_ops jtag_dp_ops;
  */
 int ahbap_debugport_init(struct adiv5_dap *dap)
 {
-	uint32_t idreg, romaddr, dummy;
+	uint32_t dummy;
 	uint32_t ctrlstat;
 	int cnt = 0;
 	int retval;
@@ -985,26 +985,6 @@ int ahbap_debugport_init(struct adiv5_dap *dap)
 	if (retval != ERROR_OK)
 		return retval;
 
-	/*
-	 * REVISIT this isn't actually *initializing* anything in an AP,
-	 * and doesn't care if it's a MEM-AP at all (much less AHB-AP).
-	 * Should it?  If the ROM address is valid, is this the right
-	 * place to scan the table and do any topology detection?
-	 */
-	retval = dap_queue_ap_read(dap, AP_REG_IDR, &idreg);
-	if (retval != ERROR_OK)
-		return retval;
-	retval = dap_queue_ap_read(dap, AP_REG_BASE, &romaddr);
-	if (retval != ERROR_OK)
-		return retval;
-
-	if ((retval = dap_run(dap)) != ERROR_OK)
-		return retval;
-
-	LOG_DEBUG("MEM-AP #%" PRId32 " ID Register 0x%" PRIx32
-		", Debug ROM Address 0x%" PRIx32,
-		dap->apsel, idreg, romaddr);
-
 	return ERROR_OK;
 }
 
@@ -1026,14 +1006,22 @@ is_dap_cid_ok(uint32_t cid3, uint32_t cid2, uint32_t cid1, uint32_t cid0)
 			&& ((cid1 & 0x0f) == 0) && cid0 == 0x0d;
 }
 
-static int dap_info_command(struct command_context *cmd_ctx,
-		struct adiv5_dap *dap, int apsel)
+struct broken_cpu {
+	uint32_t	dbgbase;
+	uint32_t	apid;
+	uint32_t	correct_dbgbase;
+	char		*model;
+} broken_cpus[] = {
+	{ 0x80000000, 0x04770002, 0x60000000, "imx51" },
+};
+
+int dap_get_debugbase(struct adiv5_dap *dap, int apsel,
+			uint32_t *out_dbgbase, uint32_t *out_apid)
 {
+	uint32_t apselold;
 	int retval;
+	unsigned int i;
 	uint32_t dbgbase, apid;
-	int romtable_present = 0;
-	uint8_t mem_ap;
-	uint32_t apselold;
 
 	/* AP address is in bits 31:24 of DP_SELECT */
 	if (apsel >= 256)
@@ -1041,6 +1029,7 @@ static int dap_info_command(struct command_context *cmd_ctx,
 
 	apselold = dap->apsel;
 	dap_ap_select(dap, apsel);
+
 	retval = dap_queue_ap_read(dap, AP_REG_BASE, &dbgbase);
 	if (retval != ERROR_OK)
 		return retval;
@@ -1051,6 +1040,44 @@ static int dap_info_command(struct command_context *cmd_ctx,
 	if (retval != ERROR_OK)
 		return retval;
 
+	/* Some CPUs are messed up, so fixup if needed. */
+	for (i = 0; i < sizeof(broken_cpus)/sizeof(struct broken_cpu); i++)
+		if (broken_cpus[i].dbgbase == dbgbase &&
+			broken_cpus[i].apid == apid) {
+			LOG_WARNING("Found broken CPU (%s), trying to fixup "
+				"ROM Table location from 0x%08x to 0x%08x",
+				broken_cpus[i].model, dbgbase,
+				broken_cpus[i].correct_dbgbase);
+			dbgbase = broken_cpus[i].correct_dbgbase;
+			break;
+		}
+
+	dap_ap_select(dap, apselold);
+
+	/* The asignment happens only here to prevent modification of these
+	 * values before they are certain. */
+	*out_dbgbase = dbgbase;
+	*out_apid = apid;
+
+	return ERROR_OK;
+}
+
+static int dap_info_command(struct command_context *cmd_ctx,
+		struct adiv5_dap *dap, int apsel)
+{
+	int retval;
+	uint32_t dbgbase, apid;
+	int romtable_present = 0;
+	uint8_t mem_ap;
+	uint32_t apselold;
+
+	retval = dap_get_debugbase(dap, apsel, &dbgbase, &apid);
+	if (retval != ERROR_OK)
+		return retval;
+
+	apselold = dap->apsel;
+	dap_ap_select(dap, apsel);
+
 	/* Now we read ROM table ID registers, ref. ARM IHI 0029B sec  */
 	mem_ap = ((apid&0x10000) && ((apid&0x0F) != 0));
 	command_print(cmd_ctx, "AP ID register 0x%8.8" PRIx32, apid);
diff --git a/src/target/arm_adi_v5.h b/src/target/arm_adi_v5.h
index 92469eb..27a2f2f 100644
--- a/src/target/arm_adi_v5.h
+++ b/src/target/arm_adi_v5.h
@@ -178,7 +178,6 @@ struct adiv5_dap
 	uint32_t	memaccess_tck;
 	/* Size of TAR autoincrement block, ARM ADI Specification requires at least 10 bits */
 	uint32_t tar_autoincr_block;
-
 };
 
 /**
@@ -380,6 +379,9 @@ int mem_ap_write_buf_u32(struct adiv5_dap *swjdp,
 /* Initialisation of the debug system, power domains and registers */
 int ahbap_debugport_init(struct adiv5_dap *swjdp);
 
+/* Probe the AP for ROM Table location */
+int dap_get_debugbase(struct adiv5_dap *dap, int apsel,
+			uint32_t *dbgbase, uint32_t *apid);
 
 struct target;
 

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm_adi_v5.c |  120 ++++++++++++++++++++++++++++++++++++----------
 src/target/arm_adi_v5.h |    8 +++-
 src/target/cortex_a8.c  |   19 +++++---
 tcl/board/efikamx.cfg   |    9 ++++
 tcl/target/imx51.cfg    |   51 ++++++++++++++++++++
 5 files changed, 173 insertions(+), 34 deletions(-)
 create mode 100644 tcl/board/efikamx.cfg
 create mode 100644 tcl/target/imx51.cfg


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Sat Nov  6 15:44:15 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Sat,  6 Nov 2010 14:44:15 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-575-g074498f
Message-ID: <E1PEk08-000802-LZ@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  074498f836db2879d73c39615fa5dced8a6555c9 (commit)
      from  8f1f8e7b96d4dfdca867cfcf69e0efab9f6e3731 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 074498f836db2879d73c39615fa5dced8a6555c9
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Thu Nov 4 16:53:28 2010 +0800

    TCL scripts: add support for ST SPEAr310
    
    Initial support for ST SPEAr310 and for the evaluation
    board EVALSPEAr310 Rev. 2.0.
    Scripts are split in generic for SPEAr3xx family and
    specific for SPEAr310. This should easily allow adding
    new members of the family.
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/tcl/board/spear310evb20.cfg b/tcl/board/spear310evb20.cfg
new file mode 100644
index 0000000..887e799
--- /dev/null
+++ b/tcl/board/spear310evb20.cfg
@@ -0,0 +1,48 @@
+# Configuration for the ST SPEAr310 Evaluation board
+# EVALSPEAr310 Rev. 2.0
+# http://www.st.com/spear
+#
+# Date:      2010-08-17
+# Author:    Antonio Borneo <borneo.antonio at gmail.com>
+
+# The standard board has JTAG SRST not connected.
+# This script targets such boards using quirky code to bypass the issue.
+#
+# Check ST Application Note (FIXME: put reference) on how to fix SRST on
+# the board, then use the script board/spear310evb20_mod.cfg
+
+
+source [find mem_helper.tcl]
+source [find target/spear3xx.cfg]
+source [find chip/st/spear/spear310.tcl]
+source [find chip/st/spear/spear3xx_ddr.tcl]
+source [find chip/st/spear/spear3xx.tcl]
+
+arm7_9 dcc_downloads enable
+arm7_9 fast_memory_access enable
+
+# CFI parallel NOR on EMI CS0. 2x 16bit 8M devices = 16Mbyte.
+set _FLASHNAME0 $_CHIPNAME.pnor
+flash bank $_FLASHNAME0 cfi 0x50000000 0x01000000 2 4 $_TARGETNAME
+
+if { [info exists BOARD_HAS_SRST] } {
+	# Modified board has SRST on JTAG connector
+	reset_config trst_and_srst separate srst_gates_jtag \
+		trst_push_pull srst_open_drain
+} else {
+	# Standard board has no SRST on JTAG connector
+	reset_config trst_only separate srst_gates_jtag trst_push_pull
+	source [find chip/st/spear/quirk_no_srst.tcl]
+}
+
+$_TARGETNAME configure -event reset-init { spear310evb20_init }
+
+proc spear310evb20_init {} {
+	reg pc 0xffff0020	# loop forever
+
+	sp3xx_clock_default
+	sp3xx_common_init
+	sp3xx_ddr_init "mt47h64m16_3_333_cl5_async"
+	sp310_init
+	sp310_emi_init
+}
diff --git a/tcl/board/spear310evb20_mod.cfg b/tcl/board/spear310evb20_mod.cfg
new file mode 100644
index 0000000..bf62915
--- /dev/null
+++ b/tcl/board/spear310evb20_mod.cfg
@@ -0,0 +1,25 @@
+# Configuration for the ST SPEAr310 Evaluation board
+# EVALSPEAr310 Rev. 2.0, modified to enable SRST on JTAG connector
+# http://www.st.com/spear
+#
+# List of board modifications to enable SRST, as per ST Application Note
+# (FIXME: put reference to AN)
+# - Modifications on the top layer:
+#    1. remove R137 and C57, located near the SMII PHY U18;
+#    2. remove R172 and C75, located near the SMII PHY U19;
+#    3. remove R207 and C90, located near the SMII PHY U20;
+#    4. remove C236, located near the SMII PHY U21;
+#    5. remove U12, located near the JTAG connector;
+#    6. solder together pins 7, 8 and 9 of U12;
+#    7. solder together pins 11, 12, 13, 14, 15, 16, 17 and 18 of U12.
+# - Modifications on the bottom layer:
+#    8. replace reset chip U11 with a STM6315SDW13F;
+#    9. add 0 ohm resistor R329. It is located close to JTAG connector.
+#
+# Date:      2009-10-31
+# Author:    Antonio Borneo <borneo.antonio at gmail.com>
+
+
+# Modified boards has SRST on JTAG connector
+set BOARD_HAS_SRST 1
+source [find board/spear310evb20.cfg]
diff --git a/tcl/chip/st/spear/quirk_no_srst.tcl b/tcl/chip/st/spear/quirk_no_srst.tcl
new file mode 100644
index 0000000..df22764
--- /dev/null
+++ b/tcl/chip/st/spear/quirk_no_srst.tcl
@@ -0,0 +1,75 @@
+# Quirks to bypass missing SRST on JTAG connector
+# EVALSPEAr310 Rev. 2.0
+# http://www.st.com/spear
+#
+# Date:      2010-08-17
+# Author:    Antonio Borneo <borneo.antonio at gmail.com>
+
+# For boards that have JTAG SRST not connected.
+# We use "arm9 vector_catch reset" to catch button reset event.
+
+
+$_TARGETNAME configure -event reset-assert sp_reset_assert
+$_TARGETNAME configure -event reset-deassert-post sp_reset_deassert_post
+
+# keeps the name of the SPEAr target
+global sp_target_name
+set sp_target_name $_TARGETNAME
+
+# Keeps the argument of "reset" command (run, init, halt).
+global sp_reset_mode
+set sp_reset_mode ""
+
+# Helper procedure. Returns 0 is target is halted.
+proc sp_is_halted {} {
+	global sp_target_name
+
+	return [expr [string compare [$sp_target_name curstate] "halted" ] == 0]
+}
+
+# wait for reset button to be pressed, causing CPU to get halted
+proc sp_reset_deassert_post {} {
+	global sp_reset_mode
+
+	set bar(0) |
+	set bar(1) /
+	set bar(2) -
+	set bar(3) \\
+
+	poll on
+	puts "====> Press reset button on the board <===="
+	for {set i 0} { [sp_is_halted] == 0 } { set i [expr $i + 1]} {
+		puts -nonewline "$bar([expr $i & 3])\r"
+		sleep 200
+	}
+
+	# Remove catch reset event
+	arm9 vector_catch none
+
+	# CPU is halted, but we typed "reset run" ...
+	if { [string compare $sp_reset_mode "run"] == 0 } {
+		resume
+	}
+}
+
+# Override reset-assert, since no SRST available
+# Catch reset event
+proc sp_reset_assert {} {
+	arm9 vector_catch reset
+}
+
+# Override default init_reset{mode} to catch parameter "mode"
+proc init_reset {mode} {
+	global sp_reset_mode
+
+	set sp_reset_mode $mode
+
+	# We need to detect CPU get halted, so exit from halt
+	if { [sp_is_halted] } {
+		echo "Resuming CPU to detect reset"
+		resume
+	}
+
+	# Execute default init_reset{mode}
+	jtag arp_init-reset
+}
diff --git a/tcl/chip/st/spear/spear310.tcl b/tcl/chip/st/spear/spear310.tcl
new file mode 100644
index 0000000..b2c3676
--- /dev/null
+++ b/tcl/chip/st/spear/spear310.tcl
@@ -0,0 +1,40 @@
+# Specific init scripts for ST SPEAr310 system on chip
+# http://www.st.com/spear
+#
+# Date:      2010-09-23
+# Author:    Antonio Borneo <borneo.antonio at gmail.com>
+
+
+proc sp310_init {} {
+	mww 0xfca80034 0x0000ffff	# enable all RAS clocks
+	mww 0xfca80040 0x00000000	# remove all RAS resets
+	mww 0xb4000008 0x00002ff4	# RAS function enable
+
+	mww 0xfca8013c 0x2f7bc210	# plgpio_pad_drv
+	mww 0xfca80140 0x017bdef6
+}
+
+proc sp310_emi_init {} {
+	# set EMI pad strength
+	mmw 0xfca80134 0x0e000000 0x00000000
+	mmw 0xfca80138 0x0e739ce7 0x00000000
+	mmw 0xfca8013c 0x00039ce7 0x00000000
+
+	# set safe EMI timing as in BootROM
+	#mww 0x4f000000 0x0000000f	# tAP_0_reg
+	#mww 0x4f000004 0x00000000	# tSDP_0_reg
+	#mww 0x4f000008 0x000000ff	# tDPw_0_reg
+	#mww 0x4f00000c 0x00000111	# tDPr_0_reg
+	#mww 0x4f000010 0x00000002	# tDCS_0_reg
+
+	# set fast EMI timing as in Linux
+	mww 0x4f000000 0x00000010	# tAP_0_reg
+	mww 0x4f000004 0x00000005	# tSDP_0_reg
+	mww 0x4f000008 0x0000000a	# tDPw_0_reg
+	mww 0x4f00000c 0x0000000a	# tDPr_0_reg
+	mww 0x4f000010 0x00000005	# tDCS_0_re
+
+	# 32bit wide, 8/16/32bit access
+	mww 0x4f000014 0x0000000e	# control_0_reg
+	mww 0x4f000094 0x0000003f	# ack_reg
+}
diff --git a/tcl/chip/st/spear/spear3xx.tcl b/tcl/chip/st/spear/spear3xx.tcl
new file mode 100644
index 0000000..ea85d29
--- /dev/null
+++ b/tcl/chip/st/spear/spear3xx.tcl
@@ -0,0 +1,79 @@
+# Generic init scripts for all ST SPEAr3xx family
+# http://www.st.com/spear
+#
+# Date:      2010-09-23
+# Author:    Antonio Borneo <borneo.antonio at gmail.com>
+
+
+# Initialize internal clock
+# Default:
+# - Crystal =  24 MHz
+# - PLL1    = 332 MHz
+# - PLL2    = 332 MHz
+# - CPU_CLK = 332 MHz
+# - DDR_CLK = 332 MHz async
+# - HCLK    = 166 MHz
+# - PCLK    =  83 MHz
+proc sp3xx_clock_default {} {
+	mww 0xfca00000 0x00000002	# set sysclk slow
+	mww 0xfca00014 0x0ffffff8	# set pll timeout to minimum (100us ?!?)
+
+	# DDRCORE disable to change frequency
+	set val [expr ([mrw 0xfca8002c] & ~0x20000000) | 0x40000000]
+	mww 0xfca8002c $val
+	mww 0xfca8002c $val # Yes, write twice!
+
+	# programming PLL1
+	mww 0xfca8000c 0xa600010c	# M=166 P=1 N=12
+	mww 0xfca80008 0x00001c0a	# power down
+	mww 0xfca80008 0x00001c0e	# enable
+	mww 0xfca80008 0x00001c06	# strobe
+	mww 0xfca80008 0x00001c0e
+	while { [expr [mrw 0xfca80008] & 0x01] == 0x00 } { sleep 1 }
+
+	# programming PLL2
+	mww 0xfca80018 0xa600010c	# M=166, P=1, N=12
+	mww 0xfca80014 0x00001c0a	# power down
+	mww 0xfca80014 0x00001c0e	# enable
+	mww 0xfca80014 0x00001c06	# strobe
+	mww 0xfca80014 0x00001c0e
+	while { [expr [mrw 0xfca80014] & 0x01] == 0x00 } { sleep 1 }
+
+	mww 0xfca80028 0x00000082	# enable plltimeen
+	mww 0xfca80024 0x00000511	# set hclkdiv="/2" & pclkdiv="/2"
+
+	mww 0xfca00000 0x00000004	# setting SYSCTL to NORMAL mode
+	while { [expr [mrw 0xfca00000] & 0x20] != 0x20 } { sleep 1 }
+
+	# Select source of DDR clock
+	#mmw 0xfca80020 0x10000000 0x70000000 ;# PLL1
+	mmw 0xfca80020 0x30000000 0x70000000 ;# PLL2
+
+	# DDRCORE enable after change frequency
+	mmw 0xfca8002c 0x20000000 0x00000000
+}
+
+proc sp3xx_common_init {} {
+	mww 0xfca8002c 0xfffffff8	# enable clock of all peripherals
+	mww 0xfca80038 0x00000000	# remove reset of all peripherals
+
+	mww 0xfca800e4 0x78000008	# COMP1V8_REG
+	mww 0xfca800ec 0x78000008	# COMP3V3_REG
+
+	mww 0xfca80050 0x00000001	# Enable clk mem port 1
+
+	mww 0xfc000000 0x10000f5f	# init SMI and set HW mode
+	mww 0xfc000000 0x00000f5f
+
+	# Initialize Bus Interconnection Matrix
+	# All ports Round-Robin and lowest priority
+	mww 0xfca8007c 0x80000007
+	mww 0xfca80080 0x80000007
+	mww 0xfca80084 0x80000007
+	mww 0xfca80088 0x80000007
+	mww 0xfca8008c 0x80000007
+	mww 0xfca80090 0x80000007
+	mww 0xfca80094 0x80000007
+	mww 0xfca80098 0x80000007
+	mww 0xfca8009c 0x80000007
+}
diff --git a/tcl/chip/st/spear/spear3xx_ddr.tcl b/tcl/chip/st/spear/spear3xx_ddr.tcl
new file mode 100644
index 0000000..eb1c4b0
--- /dev/null
+++ b/tcl/chip/st/spear/spear3xx_ddr.tcl
@@ -0,0 +1,120 @@
+# Init scripts to configure DDR controller of SPEAr3xx
+# http://www.st.com/spear
+# Original values taken from XLoader source code
+#
+# Date:      2010-09-23
+# Author:    Antonio Borneo <borneo.antonio at gmail.com>
+
+
+proc sp3xx_ddr_init {ddr_type} {
+	if { $ddr_type == "mt47h64m16_3_333_cl5_async" } {
+		ddr_spr3xx_mt47h64m16_3_333_cl5_async
+		set ddr_size 0x08000000
+	## add here new DDR chip definition. Prototype:
+	#} elseif { $ddr_type == "?????" } {
+	#	?????
+	#	set ddr_size 0x?????
+	} else {
+		error "sp3xx_ddr_init: unrecognized DDR type "$ddr_type
+	}
+
+	# Check for single/double memory chip
+	# DDR starts at address 0x00000000
+	mww $ddr_size 0x87654321
+	mww 0x00000000 0x12345678
+	if {[expr [mrw 0x00000000] == 0x12345678 && [mrw $ddr_size] == 0x87654321]} {
+		puts [format \
+			"Double chip DDR memory. Total memory size 0x%08x byte" \
+			[expr 2 * $ddr_size]]
+	} else {
+		puts [format \
+			"Single chip DDR memory. Memory size 0x%08x byte" \
+			$ddr_size]
+	}
+}
+
+
+# from Xloader file ddr/spr300_mt47h64m16_3_333_cl5_async.S
+proc ddr_spr3xx_mt47h64m16_3_333_cl5_async {} {
+	# DDR_PAD_REG
+	mww 0xfca800f0 0x00003aa5
+
+	# Use "1:2 sync" only when DDR clock source is PLL1 and
+	# HCLK is half of PLL1
+	mww 0xfc600000 0x00000001	# MEMCTL_AHB_SET_00 # This is async
+	mww 0xfc600004 0x00000000	# MEMCTL_AHB_SET_01
+#	mww 0xfc600000 0x02020201	# MEMCTL_AHB_SET_00 # This is 1:2 sync
+#	mww 0xfc600004 0x02020202	# MEMCTL_AHB_SET_01
+
+	mww 0xfc600008 0x01000000	# MEMCTL_RFSH_SET_00
+	mww 0xfc60000c 0x00000101	# MEMCTL_DLL_SET_00
+	mww 0xfc600010 0x00000101	# MEMCTL_GP_00
+	mww 0xfc600014 0x01000000	# MEMCTL_GP_01
+	mww 0xfc600018 0x00010001	# MEMCTL_GP_02
+	mww 0xfc60001c 0x00000100	# MEMCTL_GP_03
+	mww 0xfc600020 0x00010001	# MEMCTL_GP_04
+	mww 0xfc600024 0x01020203	# MEMCTL_GP_05
+	mww 0xfc600028 0x01000102	# MEMCTL_GP_06
+	mww 0xfc60002c 0x02000202	# MEMCTL_AHB_SET_02
+	mww 0xfc600030 0x04040105	# MEMCTL_AHB_SET_03
+	mww 0xfc600034 0x03030302	# MEMCTL_AHB_SET_04
+	mww 0xfc600038 0x02040101	# MEMCTL_AHB_SET_05
+	mww 0xfc60003c 0x00000002	# MEMCTL_AHB_SET_06
+	mww 0xfc600044 0x03000405	# MEMCTL_DQS_SET_0
+	mww 0xfc600048 0x03040002	# MEMCTL_TIME_SET_01
+	mww 0xfc60004c 0x04000305	# MEMCTL_TIME_SET_02
+	mww 0xfc600050 0x0505053f	# MEMCTL_AHB_RELPR_00
+	mww 0xfc600054 0x05050505	# MEMCTL_AHB_RELPR_01
+	mww 0xfc600058 0x04040405	# MEMCTL_AHB_RELPR_02
+	mww 0xfc60005c 0x04040404	# MEMCTL_AHB_RELPR_03
+	mww 0xfc600060 0x03030304	# MEMCTL_AHB_RELPR_04
+	mww 0xfc600064 0x03030303	# MEMCTL_AHB_RELPR_05
+	mww 0xfc600068 0x02020203	# MEMCTL_AHB_RELPR_06
+	mww 0xfc60006c 0x02020202	# MEMCTL_AHB_RELPR_07
+	mww 0xfc600070 0x01010102	# MEMCTL_AHB_RELPR_08
+	mww 0xfc600074 0x01010101	# MEMCTL_AHB_RELPR_09
+	mww 0xfc600078 0x00000001	# MEMCTL_AHB_RELPR_10
+	mww 0xfc600088 0x0a0c0a00	# MEMCTL_DQS_SET_1
+	mww 0xfc60008c 0x0000023f	# MEMCTL_GP_07
+	mww 0xfc600090 0x00050a00	# MEMCTL_GP_08
+	mww 0xfc600094 0x11000000	# MEMCTL_GP_09
+	mww 0xfc600098 0x00001302	# MEMCTL_GP_10
+	mww 0xfc60009c 0x00001c1c	# MEMCTL_DLL_SET_01
+	mww 0xfc6000a0 0x7c000000	# MEMCTL_DQS_OUT_SHIFT
+	mww 0xfc6000a4 0x005c0000	# MEMCTL_WR_DQS_SHIFT
+	mww 0xfc6000a8 0x2b050e00	# MEMCTL_TIME_SET_03
+	mww 0xfc6000ac 0x00640064	# MEMCTL_AHB_PRRLX_00
+	mww 0xfc6000b0 0x00640064	# MEMCTL_AHB_PRRLX_01
+	mww 0xfc6000b4 0x00000064	# MEMCTL_AHB_PRRLX_02
+	mww 0xfc6000b8 0x00000000	# MEMCTL_OUTRANGE_LGTH
+	mww 0xfc6000bc 0x00200020	# MEMCTL_AHB_RW_SET_00
+	mww 0xfc6000c0 0x00200020	# MEMCTL_AHB_RW_SET_01
+	mww 0xfc6000c4 0x00200020	# MEMCTL_AHB_RW_SET_02
+	mww 0xfc6000c8 0x00200020	# MEMCTL_AHB_RW_SET_03
+	mww 0xfc6000cc 0x00200020	# MEMCTL_AHB_RW_SET_04
+	mww 0xfc6000d8 0x00000a24	# MEMCTL_TREF
+	mww 0xfc6000dc 0x00000000	# MEMCTL_EMRS3_DATA
+	mww 0xfc6000e0 0x5b1c00c8	# MEMCTL_TIME_SET_04
+	mww 0xfc6000e4 0x00c8002e	# MEMCTL_TIME_SET_05
+	mww 0xfc6000e8 0x00000000	# MEMCTL_VERSION
+	mww 0xfc6000ec 0x0001046b	# MEMCTL_TINIT
+	mww 0xfc6000f0 0x00000000	# MEMCTL_OUTRANGE_ADDR_01
+	mww 0xfc6000f4 0x00000000	# MEMCTL_OUTRANGE_ADDR_02
+	mww 0xfc600104 0x001c0000	# MEMCTL_DLL_DQS_DELAY_BYPASS_0
+	mww 0xfc600108 0x0019001c	# MEMCTL_DLL_SET_02
+	mww 0xfc60010c 0x00100000	# MEMCTL_DLL_SET_03
+	mww 0xfc600110 0x001e007a	# MEMCTL_DQS_SET_2
+	mww 0xfc600188 0x00000000	# MEMCTL_USER_DEF_REG_0
+	mww 0xfc60018c 0x00000000	# MEMCTL_USER_DEF_REG_1
+	mww 0xfc600190 0x01010001	# MEMCTL_GP_11
+	mww 0xfc600194 0x01000000	# MEMCTL_GP_12
+	mww 0xfc600198 0x00000001	# MEMCTL_GP_13
+	mww 0xfc60019c 0x00400000	# MEMCTL_GP_14
+	mww 0xfc6001a0 0x00000000	# MEMCTL_EMRS2_DATA_X
+	mww 0xfc6001a4 0x00000000	# MEMCTL_LWPWR_CNT
+	mww 0xfc6001a8 0x00000000	# MEMCTL_LWPWR_REG
+	mww 0xfc6001ac 0x00860000	# MEMCTL_GP_15
+	mww 0xfc6001b0 0x00000002	# MEMCTL_TPDEX
+	# MPMC START
+	mww 0xfc60001c 0x01000100
+}
diff --git a/tcl/target/spear3xx.cfg b/tcl/target/spear3xx.cfg
new file mode 100644
index 0000000..ef289e3
--- /dev/null
+++ b/tcl/target/spear3xx.cfg
@@ -0,0 +1,41 @@
+# Target configuration for the ST SPEAr3xx family of system on chip
+# Supported SPEAr300, SPEAr310, SPEAr320
+# http://www.st.com/spear
+#
+# Processor: ARM926ejs
+# Info:      JTAG tap: spear3xx.cpu tap/device found: 0x07926041
+# Date:      2009-10-31
+# Author:    Antonio Borneo <borneo.antonio at gmail.com>
+
+if { [info exists CHIPNAME] } {
+	set _CHIPNAME $CHIPNAME
+} else {
+	set _CHIPNAME spear3xx
+}
+
+if { [info exists ENDIAN] } {
+	set _ENDIAN $ENDIAN
+} else {
+	set _ENDIAN little
+}
+
+if { [info exists CPUTAPID ] } {
+	set _CPUTAPID $CPUTAPID
+} else {
+	set _CPUTAPID 0x07926041
+}
+
+jtag newtap $_CHIPNAME cpu -irlen 4 -ircapture 0x01 -irmask 0x03 \
+	-expected-id $_CPUTAPID
+
+set _TARGETNAME $_CHIPNAME.cpu
+target create $_TARGETNAME arm926ejs -endian $_ENDIAN \
+	-chain-position $_TARGETNAME
+
+# SPEAr3xx has a 8K block of sram @ 0xd280.0000
+# REVISIT: what OS puts virtual address equal to phys?
+$_TARGETNAME configure \
+	-work-area-virt 0xd2800000 \
+	-work-area-phys 0xd2800000 \
+	-work-area-size 0x2000 \
+	-work-area-backup 0

-----------------------------------------------------------------------

Summary of changes:
 tcl/board/spear310evb20.cfg         |   48 ++++++++++++++
 tcl/board/spear310evb20_mod.cfg     |   25 +++++++
 tcl/chip/st/spear/quirk_no_srst.tcl |   75 ++++++++++++++++++++++
 tcl/chip/st/spear/spear310.tcl      |   40 ++++++++++++
 tcl/chip/st/spear/spear3xx.tcl      |   79 +++++++++++++++++++++++
 tcl/chip/st/spear/spear3xx_ddr.tcl  |  120 +++++++++++++++++++++++++++++++++++
 tcl/target/spear3xx.cfg             |   41 ++++++++++++
 7 files changed, 428 insertions(+), 0 deletions(-)
 create mode 100644 tcl/board/spear310evb20.cfg
 create mode 100644 tcl/board/spear310evb20_mod.cfg
 create mode 100644 tcl/chip/st/spear/quirk_no_srst.tcl
 create mode 100644 tcl/chip/st/spear/spear310.tcl
 create mode 100644 tcl/chip/st/spear/spear3xx.tcl
 create mode 100644 tcl/chip/st/spear/spear3xx_ddr.tcl
 create mode 100644 tcl/target/spear3xx.cfg


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Nov  9 08:06:16 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue,  9 Nov 2010 07:06:16 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-576-gfc4cbc0
Message-ID: <E1PFiHZ-0007Uc-51@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  fc4cbc0f988c347be298518b32643fc2fc4e692d (commit)
      from  074498f836db2879d73c39615fa5dced8a6555c9 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit fc4cbc0f988c347be298518b32643fc2fc4e692d
Author: Andrew Leech <coronasensei at gmail.com>
Date:   Tue Nov 9 08:05:02 2010 +0100

    lpc3131: target definition

diff --git a/tcl/target/lpc3131.cfg b/tcl/target/lpc3131.cfg
new file mode 100644
index 0000000..5c6aa3c
--- /dev/null
+++ b/tcl/target/lpc3131.cfg
@@ -0,0 +1,76 @@
+######################################
+# Target:    NXP lpc3131
+######################################
+
+if { [info exists CHIPNAME] } {
+   set  _CHIPNAME $CHIPNAME
+} else {
+   set  _CHIPNAME lpc3131
+}
+
+if { [info exists ENDIAN] } {
+   set  _ENDIAN $ENDIAN
+} else {
+   set  _ENDIAN little
+}
+
+# ARM926EJS core
+if { [info exists CPUTAPID ] } {
+   set _CPUTAPID $CPUTAPID
+} else {
+   set _CPUTAPID 0x07926f0f
+}
+
+# Scan Tap
+# Wired to seperate STDO pin on the lpc3131, externally muxed to TDO on ea3131 module 
+# JTAGSEL pin must be 0 to activate, which reassigns arm tdo to a pass through.
+if { [info exists SJCTAPID ] } {
+   set _SJCTAPID $SJCTAPID
+} else {
+   set _SJCTAPID 0x1541E02B
+}
+
+jtag newtap $_CHIPNAME cpu -irlen 4 -expected-id $_CPUTAPID
+
+##################################################################
+# various symbol definitions, to avoid hard-wiring addresses
+##################################################################
+
+global lpc313x
+set lpc313x [ dict create ]
+
+# Physical addresses for controllers and memory
+dict set lpc313x sram0			0x11028000
+dict set lpc313x sram1			0x11040000
+dict set lpc313x uart			0x15001000
+dict set lpc313x cgu			0x13004000
+dict set lpc313x ioconfig		0x13003000
+dict set lpc313x sysconfig		0x13002800
+dict set lpc313x wdt			0x13002400
+
+##################################################################
+# Target configuration
+##################################################################
+
+jtag_nsrst_delay 1000
+jtag_ntrst_delay 0
+
+set _TARGETNAME $_CHIPNAME.cpu
+target create $_TARGETNAME arm926ejs -endian $_ENDIAN -chain-position $_TARGETNAME 
+
+$_TARGETNAME invoke-event halted
+
+$_TARGETNAME configure -work-area-phys [dict get $lpc313x sram0] -work-area-size 0x30000 -work-area-backup 0
+
+$_TARGETNAME configure -event reset-init {
+	echo "\nRunning reset init script for LPC3131\n"
+	halt
+	wait_halt
+	reg cpsr 0xa00000d3	#Supervisor mode
+	reg pc 0x11029000
+	poll
+	sleep 500
+}
+
+arm7_9 fast_memory_access enable
+arm7_9 dcc_downloads enable

-----------------------------------------------------------------------

Summary of changes:
 tcl/target/lpc3131.cfg |   76 ++++++++++++++++++++++++++++++++++++++++++++++++
 1 files changed, 76 insertions(+), 0 deletions(-)
 create mode 100644 tcl/target/lpc3131.cfg


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Nov  9 09:26:27 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue,  9 Nov 2010 08:26:27 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-580-gfc4e001
Message-ID: <E1PFjXA-0006Od-Oo@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  fc4e001de34029ca6451038a351b433677d4f388 (commit)
       via  6ef3d4ccfe2ac017c26072101059628baf99f318 (commit)
       via  49a231f38dd97c4565868e7b47b51196c19d3d99 (commit)
       via  e774df7f69568c63388a041c1ce5bf0cf95172e1 (commit)
      from  fc4cbc0f988c347be298518b32643fc2fc4e692d (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit fc4e001de34029ca6451038a351b433677d4f388
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Nov 8 16:53:24 2010 +0100

    stm32: return early upon block write failure
    
    only if we do not have enough ram do we continue.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nor/stm32x.c b/src/flash/nor/stm32x.c
index 63a137c..6b46afc 100644
--- a/src/flash/nor/stm32x.c
+++ b/src/flash/nor/stm32x.c
@@ -668,6 +668,9 @@ static int stm32x_write(struct flash_bank *bank, uint8_t *buffer,
 		}
 	}
 
+	if ((retval != ERROR_OK) && (retval != ERROR_TARGET_RESOURCE_NOT_AVAILABLE))
+		return retval;
+
 	while (words_remaining > 0)
 	{
 		uint16_t value;

commit 6ef3d4ccfe2ac017c26072101059628baf99f318
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Nov 8 16:26:58 2010 +0100

    stm32: return error when failing to read
    
    add missing error handling.
    
    Output warning when assuming maximum flash size in the
    family when failing to read.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nor/stm32x.c b/src/flash/nor/stm32x.c
index ae4f02b..63a137c 100644
--- a/src/flash/nor/stm32x.c
+++ b/src/flash/nor/stm32x.c
@@ -115,7 +115,9 @@ static int stm32x_read_options(struct flash_bank *bank)
 	stm32x_info = bank->driver_priv;
 
 	/* read current option bytes */
-	target_read_u32(target, STM32_FLASH_OBR, &optiondata);
+	int retval = target_read_u32(target, STM32_FLASH_OBR, &optiondata);
+	if (retval != ERROR_OK)
+		return retval;
 
 	stm32x_info->option_bytes.user_options = (uint16_t)0xFFF8 | ((optiondata >> 2) & 0x07);
 	stm32x_info->option_bytes.RDP = (optiondata & (1 << OPT_READOUT)) ? 0xFFFF : 0x5AA5;
@@ -124,7 +126,9 @@ static int stm32x_read_options(struct flash_bank *bank)
 		LOG_INFO("Device Security Bit Set");
 
 	/* each bit refers to a 4bank protection */
-	target_read_u32(target, STM32_FLASH_WRPR, &optiondata);
+	retval = target_read_u32(target, STM32_FLASH_WRPR, &optiondata);
+	if (retval != ERROR_OK)
+		return retval;
 
 	stm32x_info->option_bytes.protection[0] = (uint16_t)optiondata;
 	stm32x_info->option_bytes.protection[1] = (uint16_t)(optiondata >> 8);
@@ -287,7 +291,9 @@ static int stm32x_protect_check(struct flash_bank *bank)
 
 	/* medium density - each bit refers to a 4bank protection
 	 * high density - each bit refers to a 2bank protection */
-	target_read_u32(target, STM32_FLASH_WRPR, &protection);
+	int retval = target_read_u32(target, STM32_FLASH_WRPR, &protection);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* medium density - each protection bit is for 4 * 1K pages
 	 * high density - each protection bit is for 2 * 2K pages */
@@ -418,7 +424,9 @@ static int stm32x_protect(struct flash_bank *bank, int set, int first, int last)
 
 	/* medium density - each bit refers to a 4bank protection
 	 * high density - each bit refers to a 2bank protection */
-	target_read_u32(target, STM32_FLASH_WRPR, &protection);
+	int retval = target_read_u32(target, STM32_FLASH_WRPR, &protection);
+	if (retval != ERROR_OK)
+		return retval;
 
 	prot_reg[0] = (uint16_t)protection;
 	prot_reg[1] = (uint16_t)(protection >> 8);
@@ -713,12 +721,16 @@ static int stm32x_probe(struct flash_bank *bank)
 	stm32x_info->probed = 0;
 
 	/* read stm32 device id register */
-	target_read_u32(target, 0xE0042000, &device_id);
+	int retval = target_read_u32(target, 0xE0042000, &device_id);
+	if (retval != ERROR_OK)
+		return retval;
 	LOG_INFO("device id = 0x%08" PRIx32 "", device_id);
 
-	/* get flash size from target */
-	if (target_read_u16(target, 0x1FFFF7E0, &num_pages) != ERROR_OK)
+	/* get flash size from target. */
+	retval = target_read_u16(target, 0x1FFFF7E0, &num_pages);
+	if (retval != ERROR_OK)
 	{
+		LOG_WARNING("failed reading flash size, default to max target family");
 		/* failed reading flash size, default to max target family */
 		num_pages = 0xffff;
 	}
@@ -855,7 +867,9 @@ static int get_stm32x_info(struct flash_bank *bank, char *buf, int buf_size)
 	int printed;
 
 	/* read stm32 device id register */
-	target_read_u32(target, 0xE0042000, &device_id);
+	int retval = target_read_u32(target, 0xE0042000, &device_id);
+	if (retval != ERROR_OK)
+		return retval;
 
 	if ((device_id & 0x7ff) == 0x410)
 	{
@@ -1093,7 +1107,9 @@ COMMAND_HANDLER(stm32x_handle_options_read_command)
 		return ERROR_TARGET_NOT_HALTED;
 	}
 
-	target_read_u32(target, STM32_FLASH_OBR, &optionbyte);
+	retval = target_read_u32(target, STM32_FLASH_OBR, &optionbyte);
+	if (retval != ERROR_OK)
+		return retval;
 	command_print(CMD_CTX, "Option Byte: 0x%" PRIx32 "", optionbyte);
 
 	if (buf_get_u32((uint8_t*)&optionbyte, OPT_ERROR, 1))

commit 49a231f38dd97c4565868e7b47b51196c19d3d99
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Nov 8 16:22:22 2010 +0100

    stm32: add error propagation on writes
    
    catch problems earlier.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nor/stm32x.c b/src/flash/nor/stm32x.c
index 9decac2..ae4f02b 100644
--- a/src/flash/nor/stm32x.c
+++ b/src/flash/nor/stm32x.c
@@ -145,18 +145,31 @@ static int stm32x_erase_options(struct flash_bank *bank)
 	stm32x_read_options(bank);
 
 	/* unlock flash registers */
-	target_write_u32(target, STM32_FLASH_KEYR, KEY1);
-	target_write_u32(target, STM32_FLASH_KEYR, KEY2);
+	int retval = target_write_u32(target, STM32_FLASH_KEYR, KEY1);
+	if (retval != ERROR_OK)
+		return retval;
+
+	retval = target_write_u32(target, STM32_FLASH_KEYR, KEY2);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* unlock option flash registers */
-	target_write_u32(target, STM32_FLASH_OPTKEYR, KEY1);
-	target_write_u32(target, STM32_FLASH_OPTKEYR, KEY2);
+	retval = target_write_u32(target, STM32_FLASH_OPTKEYR, KEY1);
+	if (retval != ERROR_OK)
+		return retval;
+	retval = target_write_u32(target, STM32_FLASH_OPTKEYR, KEY2);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* erase option bytes */
-	target_write_u32(target, STM32_FLASH_CR, FLASH_OPTER | FLASH_OPTWRE);
-	target_write_u32(target, STM32_FLASH_CR, FLASH_OPTER | FLASH_STRT | FLASH_OPTWRE);
+	retval = target_write_u32(target, STM32_FLASH_CR, FLASH_OPTER | FLASH_OPTWRE);
+	if (retval != ERROR_OK)
+		return retval;
+	retval = target_write_u32(target, STM32_FLASH_CR, FLASH_OPTER | FLASH_STRT | FLASH_OPTWRE);
+	if (retval != ERROR_OK)
+		return retval;
 
-	int retval = stm32x_wait_status_busy(bank, 10);
+	retval = stm32x_wait_status_busy(bank, 10);
 	if (retval != ERROR_OK)
 		return retval;
 
@@ -175,59 +188,83 @@ static int stm32x_write_options(struct flash_bank *bank)
 	stm32x_info = bank->driver_priv;
 
 	/* unlock flash registers */
-	target_write_u32(target, STM32_FLASH_KEYR, KEY1);
-	target_write_u32(target, STM32_FLASH_KEYR, KEY2);
+	int retval = target_write_u32(target, STM32_FLASH_KEYR, KEY1);
+	if (retval != ERROR_OK)
+		return retval;
+	retval = target_write_u32(target, STM32_FLASH_KEYR, KEY2);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* unlock option flash registers */
-	target_write_u32(target, STM32_FLASH_OPTKEYR, KEY1);
-	target_write_u32(target, STM32_FLASH_OPTKEYR, KEY2);
+	retval = target_write_u32(target, STM32_FLASH_OPTKEYR, KEY1);
+	if (retval != ERROR_OK)
+		return retval;
+	retval = target_write_u32(target, STM32_FLASH_OPTKEYR, KEY2);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* program option bytes */
-	target_write_u32(target, STM32_FLASH_CR, FLASH_OPTPG | FLASH_OPTWRE);
+	retval = target_write_u32(target, STM32_FLASH_CR, FLASH_OPTPG | FLASH_OPTWRE);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* write user option byte */
-	target_write_u16(target, STM32_OB_USER, stm32x_info->option_bytes.user_options);
+	retval = target_write_u16(target, STM32_OB_USER, stm32x_info->option_bytes.user_options);
+	if (retval != ERROR_OK)
+		return retval;
 
-	int retval = stm32x_wait_status_busy(bank, 10);
+	retval = stm32x_wait_status_busy(bank, 10);
 	if (retval != ERROR_OK)
 		return retval;
 
 	/* write protection byte 1 */
-	target_write_u16(target, STM32_OB_WRP0, stm32x_info->option_bytes.protection[0]);
+	retval = target_write_u16(target, STM32_OB_WRP0, stm32x_info->option_bytes.protection[0]);
+	if (retval != ERROR_OK)
+		return retval;
 
 	retval = stm32x_wait_status_busy(bank, 10);
 	if (retval != ERROR_OK)
 		return retval;
 
 	/* write protection byte 2 */
-	target_write_u16(target, STM32_OB_WRP1, stm32x_info->option_bytes.protection[1]);
+	retval = target_write_u16(target, STM32_OB_WRP1, stm32x_info->option_bytes.protection[1]);
+	if (retval != ERROR_OK)
+		return retval;
 
 	retval = stm32x_wait_status_busy(bank, 10);
 	if (retval != ERROR_OK)
 		return retval;
 
 	/* write protection byte 3 */
-	target_write_u16(target, STM32_OB_WRP2, stm32x_info->option_bytes.protection[2]);
+	retval = target_write_u16(target, STM32_OB_WRP2, stm32x_info->option_bytes.protection[2]);
+	if (retval != ERROR_OK)
+		return retval;
 
 	retval = stm32x_wait_status_busy(bank, 10);
 	if (retval != ERROR_OK)
 		return retval;
 
 	/* write protection byte 4 */
-	target_write_u16(target, STM32_OB_WRP3, stm32x_info->option_bytes.protection[3]);
+	retval = target_write_u16(target, STM32_OB_WRP3, stm32x_info->option_bytes.protection[3]);
+	if (retval != ERROR_OK)
+		return retval;
 
 	retval = stm32x_wait_status_busy(bank, 10);
 	if (retval != ERROR_OK)
 		return retval;
 
 	/* write readout protection bit */
-	target_write_u16(target, STM32_OB_RDP, stm32x_info->option_bytes.RDP);
+	retval = target_write_u16(target, STM32_OB_RDP, stm32x_info->option_bytes.RDP);
+	if (retval != ERROR_OK)
+		return retval;
 
 	retval = stm32x_wait_status_busy(bank, 10);
 	if (retval != ERROR_OK)
 		return retval;
 
-	target_write_u32(target, STM32_FLASH_CR, FLASH_LOCK);
+	retval = target_write_u32(target, STM32_FLASH_CR, FLASH_LOCK);
+	if (retval != ERROR_OK)
+		return retval;
 
 	return ERROR_OK;
 }
@@ -321,23 +358,35 @@ static int stm32x_erase(struct flash_bank *bank, int first, int last)
 	}
 
 	/* unlock flash registers */
-	target_write_u32(target, STM32_FLASH_KEYR, KEY1);
-	target_write_u32(target, STM32_FLASH_KEYR, KEY2);
+	int retval = target_write_u32(target, STM32_FLASH_KEYR, KEY1);
+	if (retval != ERROR_OK)
+		return retval;
+	retval = target_write_u32(target, STM32_FLASH_KEYR, KEY2);
+	if (retval != ERROR_OK)
+		return retval;
 
 	for (i = first; i <= last; i++)
 	{
-		target_write_u32(target, STM32_FLASH_CR, FLASH_PER);
-		target_write_u32(target, STM32_FLASH_AR, bank->base + bank->sectors[i].offset);
-		target_write_u32(target, STM32_FLASH_CR, FLASH_PER | FLASH_STRT);
+		retval = target_write_u32(target, STM32_FLASH_CR, FLASH_PER);
+		if (retval != ERROR_OK)
+			return retval;
+		retval = target_write_u32(target, STM32_FLASH_AR, bank->base + bank->sectors[i].offset);
+		if (retval != ERROR_OK)
+			return retval;
+		retval = target_write_u32(target, STM32_FLASH_CR, FLASH_PER | FLASH_STRT);
+		if (retval != ERROR_OK)
+			return retval;
 
-		int retval = stm32x_wait_status_busy(bank, 100);
+		retval = stm32x_wait_status_busy(bank, 100);
 		if (retval != ERROR_OK)
 			return retval;
 
 		bank->sectors[i].is_erased = 1;
 	}
 
-	target_write_u32(target, STM32_FLASH_CR, FLASH_LOCK);
+	retval = target_write_u32(target, STM32_FLASH_CR, FLASH_LOCK);
+	if (retval != ERROR_OK)
+		return retval;
 
 	return ERROR_OK;
 }
@@ -583,8 +632,12 @@ static int stm32x_write(struct flash_bank *bank, uint8_t *buffer,
 	}
 
 	/* unlock flash registers */
-	target_write_u32(target, STM32_FLASH_KEYR, KEY1);
-	target_write_u32(target, STM32_FLASH_KEYR, KEY2);
+	retval = target_write_u32(target, STM32_FLASH_KEYR, KEY1);
+	if (retval != ERROR_OK)
+		return retval;
+	retval = target_write_u32(target, STM32_FLASH_KEYR, KEY2);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* multiple half words (2-byte) to be programmed? */
 	if (words_remaining > 0)
@@ -612,8 +665,12 @@ static int stm32x_write(struct flash_bank *bank, uint8_t *buffer,
 		uint16_t value;
 		memcpy(&value, buffer + bytes_written, sizeof(uint16_t));
 
-		target_write_u32(target, STM32_FLASH_CR, FLASH_PG);
-		target_write_u16(target, address, value);
+		retval = target_write_u32(target, STM32_FLASH_CR, FLASH_PG);
+		if (retval != ERROR_OK)
+			return retval;
+		retval = target_write_u16(target, address, value);
+		if (retval != ERROR_OK)
+			return retval;
 
 		retval = stm32x_wait_status_busy(bank, 5);
 		if (retval != ERROR_OK)
@@ -629,17 +686,19 @@ static int stm32x_write(struct flash_bank *bank, uint8_t *buffer,
 		uint16_t value = 0xffff;
 		memcpy(&value, buffer + bytes_written, bytes_remaining);
 
-		target_write_u32(target, STM32_FLASH_CR, FLASH_PG);
-		target_write_u16(target, address, value);
+		retval = target_write_u32(target, STM32_FLASH_CR, FLASH_PG);
+		if (retval != ERROR_OK)
+			return retval;
+		retval = target_write_u16(target, address, value);
+		if (retval != ERROR_OK)
+			return retval;
 
 		retval = stm32x_wait_status_busy(bank, 5);
 		if (retval != ERROR_OK)
 			return retval;
 	}
 
-	target_write_u32(target, STM32_FLASH_CR, FLASH_LOCK);
-
-	return ERROR_OK;
+	return target_write_u32(target, STM32_FLASH_CR, FLASH_LOCK);
 }
 
 static int stm32x_probe(struct flash_bank *bank)
@@ -1156,18 +1215,28 @@ static int stm32x_mass_erase(struct flash_bank *bank)
 	}
 
 	/* unlock option flash registers */
-	target_write_u32(target, STM32_FLASH_KEYR, KEY1);
-	target_write_u32(target, STM32_FLASH_KEYR, KEY2);
+	int retval = target_write_u32(target, STM32_FLASH_KEYR, KEY1);
+	if (retval != ERROR_OK)
+		return retval;
+	retval = target_write_u32(target, STM32_FLASH_KEYR, KEY2);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* mass erase flash memory */
-	target_write_u32(target, STM32_FLASH_CR, FLASH_MER);
-	target_write_u32(target, STM32_FLASH_CR, FLASH_MER | FLASH_STRT);
+	retval = target_write_u32(target, STM32_FLASH_CR, FLASH_MER);
+	if (retval != ERROR_OK)
+		return retval;
+	retval = target_write_u32(target, STM32_FLASH_CR, FLASH_MER | FLASH_STRT);
+	if (retval != ERROR_OK)
+		return retval;
 
-	int retval = stm32x_wait_status_busy(bank, 100);
+	retval = stm32x_wait_status_busy(bank, 100);
 	if (retval != ERROR_OK)
 		return retval;
 
-	target_write_u32(target, STM32_FLASH_CR, FLASH_LOCK);
+	retval = target_write_u32(target, STM32_FLASH_CR, FLASH_LOCK);
+	if (retval != ERROR_OK)
+		return retval;
 
 	return ERROR_OK;
 }

commit e774df7f69568c63388a041c1ce5bf0cf95172e1
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Nov 8 16:02:07 2010 +0100

    stm32: sharpen error handling for timeouts
    
    delete lots of crud by handling this all in one spot.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nor/stm32x.c b/src/flash/nor/stm32x.c
index 5b31b04..9decac2 100644
--- a/src/flash/nor/stm32x.c
+++ b/src/flash/nor/stm32x.c
@@ -54,33 +54,56 @@ FLASH_BANK_COMMAND_HANDLER(stm32x_flash_bank_command)
 	return ERROR_OK;
 }
 
-static uint32_t stm32x_get_flash_status(struct flash_bank *bank)
+static int stm32x_get_flash_status(struct flash_bank *bank, uint32_t *status)
 {
 	struct target *target = bank->target;
-	uint32_t status;
-
-	target_read_u32(target, STM32_FLASH_SR, &status);
-
-	return status;
+	return target_read_u32(target, STM32_FLASH_SR, status);
 }
 
-static uint32_t stm32x_wait_status_busy(struct flash_bank *bank, int timeout)
+static int stm32x_wait_status_busy(struct flash_bank *bank, int timeout)
 {
 	struct target *target = bank->target;
 	uint32_t status;
+	int retval = ERROR_OK;
 
 	/* wait for busy to clear */
-	while (((status = stm32x_get_flash_status(bank)) & FLASH_BSY) && (timeout-- > 0))
+	for (;;)
 	{
+		retval = stm32x_get_flash_status(bank, &status);
+		if (retval != ERROR_OK)
+			return retval;
 		LOG_DEBUG("status: 0x%" PRIx32 "", status);
+		if ((status & FLASH_BSY) == 0)
+			break;
+		if (timeout-- <= 0)
+		{
+			LOG_ERROR("timed out waiting for flash");
+			return ERROR_FAIL;
+		}
 		alive_sleep(1);
 	}
+
+	if (status & FLASH_WRPRTERR)
+	{
+		LOG_ERROR("stm32x device protected");
+		retval = ERROR_FAIL;
+	}
+
+	if (status & FLASH_PGERR)
+	{
+		LOG_ERROR("stm32x device programming failed");
+		retval = ERROR_FAIL;
+	}
+
 	/* Clear but report errors */
 	if (status & (FLASH_WRPRTERR | FLASH_PGERR))
 	{
+		/* If this operation fails, we ignore it and report the original
+		 * retval
+		 */
 		target_write_u32(target, STM32_FLASH_SR, FLASH_WRPRTERR | FLASH_PGERR);
 	}
-	return status;
+	return retval;
 }
 
 static int stm32x_read_options(struct flash_bank *bank)
@@ -115,7 +138,6 @@ static int stm32x_erase_options(struct flash_bank *bank)
 {
 	struct stm32x_flash_bank *stm32x_info = NULL;
 	struct target *target = bank->target;
-	uint32_t status;
 
 	stm32x_info = bank->driver_priv;
 
@@ -134,12 +156,9 @@ static int stm32x_erase_options(struct flash_bank *bank)
 	target_write_u32(target, STM32_FLASH_CR, FLASH_OPTER | FLASH_OPTWRE);
 	target_write_u32(target, STM32_FLASH_CR, FLASH_OPTER | FLASH_STRT | FLASH_OPTWRE);
 
-	status = stm32x_wait_status_busy(bank, 10);
-
-	if (status & FLASH_WRPRTERR)
-		return ERROR_FLASH_OPERATION_FAILED;
-	if (status & FLASH_PGERR)
-		return ERROR_FLASH_OPERATION_FAILED;
+	int retval = stm32x_wait_status_busy(bank, 10);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* clear readout protection and complementary option bytes
 	 * this will also force a device unlock if set */
@@ -152,7 +171,6 @@ static int stm32x_write_options(struct flash_bank *bank)
 {
 	struct stm32x_flash_bank *stm32x_info = NULL;
 	struct target *target = bank->target;
-	uint32_t status;
 
 	stm32x_info = bank->driver_priv;
 
@@ -170,62 +188,44 @@ static int stm32x_write_options(struct flash_bank *bank)
 	/* write user option byte */
 	target_write_u16(target, STM32_OB_USER, stm32x_info->option_bytes.user_options);
 
-	status = stm32x_wait_status_busy(bank, 10);
-
-	if (status & FLASH_WRPRTERR)
-		return ERROR_FLASH_OPERATION_FAILED;
-	if (status & FLASH_PGERR)
-		return ERROR_FLASH_OPERATION_FAILED;
+	int retval = stm32x_wait_status_busy(bank, 10);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* write protection byte 1 */
 	target_write_u16(target, STM32_OB_WRP0, stm32x_info->option_bytes.protection[0]);
 
-	status = stm32x_wait_status_busy(bank, 10);
-
-	if (status & FLASH_WRPRTERR)
-		return ERROR_FLASH_OPERATION_FAILED;
-	if (status & FLASH_PGERR)
-		return ERROR_FLASH_OPERATION_FAILED;
+	retval = stm32x_wait_status_busy(bank, 10);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* write protection byte 2 */
 	target_write_u16(target, STM32_OB_WRP1, stm32x_info->option_bytes.protection[1]);
 
-	status = stm32x_wait_status_busy(bank, 10);
-
-	if (status & FLASH_WRPRTERR)
-		return ERROR_FLASH_OPERATION_FAILED;
-	if (status & FLASH_PGERR)
-		return ERROR_FLASH_OPERATION_FAILED;
+	retval = stm32x_wait_status_busy(bank, 10);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* write protection byte 3 */
 	target_write_u16(target, STM32_OB_WRP2, stm32x_info->option_bytes.protection[2]);
 
-	status = stm32x_wait_status_busy(bank, 10);
-
-	if (status & FLASH_WRPRTERR)
-		return ERROR_FLASH_OPERATION_FAILED;
-	if (status & FLASH_PGERR)
-		return ERROR_FLASH_OPERATION_FAILED;
+	retval = stm32x_wait_status_busy(bank, 10);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* write protection byte 4 */
 	target_write_u16(target, STM32_OB_WRP3, stm32x_info->option_bytes.protection[3]);
 
-	status = stm32x_wait_status_busy(bank, 10);
-
-	if (status & FLASH_WRPRTERR)
-		return ERROR_FLASH_OPERATION_FAILED;
-	if (status & FLASH_PGERR)
-		return ERROR_FLASH_OPERATION_FAILED;
+	retval = stm32x_wait_status_busy(bank, 10);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* write readout protection bit */
 	target_write_u16(target, STM32_OB_RDP, stm32x_info->option_bytes.RDP);
 
-	status = stm32x_wait_status_busy(bank, 10);
-
-	if (status & FLASH_WRPRTERR)
-		return ERROR_FLASH_OPERATION_FAILED;
-	if (status & FLASH_PGERR)
-		return ERROR_FLASH_OPERATION_FAILED;
+	retval = stm32x_wait_status_busy(bank, 10);
+	if (retval != ERROR_OK)
+		return retval;
 
 	target_write_u32(target, STM32_FLASH_CR, FLASH_LOCK);
 
@@ -308,7 +308,6 @@ static int stm32x_erase(struct flash_bank *bank, int first, int last)
 {
 	struct target *target = bank->target;
 	int i;
-	uint32_t status;
 
 	if (bank->target->state != TARGET_HALTED)
 	{
@@ -331,12 +330,10 @@ static int stm32x_erase(struct flash_bank *bank, int first, int last)
 		target_write_u32(target, STM32_FLASH_AR, bank->base + bank->sectors[i].offset);
 		target_write_u32(target, STM32_FLASH_CR, FLASH_PER | FLASH_STRT);
 
-		status = stm32x_wait_status_busy(bank, 100);
+		int retval = stm32x_wait_status_busy(bank, 100);
+		if (retval != ERROR_OK)
+			return retval;
 
-		if (status & FLASH_WRPRTERR)
-			return ERROR_FLASH_OPERATION_FAILED;
-		if (status & FLASH_PGERR)
-			return ERROR_FLASH_OPERATION_FAILED;
 		bank->sectors[i].is_erased = 1;
 	}
 
@@ -526,7 +523,6 @@ static int stm32x_write_block(struct flash_bank *bank, uint8_t *buffer,
 				10000, &armv7m_info)) != ERROR_OK)
 		{
 			LOG_ERROR("error executing stm32x flash write algorithm");
-			retval = ERROR_FLASH_OPERATION_FAILED;
 			break;
 		}
 
@@ -535,7 +531,7 @@ static int stm32x_write_block(struct flash_bank *bank, uint8_t *buffer,
 			LOG_ERROR("flash memory not erased before writing");
 			/* Clear but report errors */
 			target_write_u32(target, STM32_FLASH_SR, FLASH_PGERR);
-			retval = ERROR_FLASH_OPERATION_FAILED;
+			retval = ERROR_FAIL;
 			break;
 		}
 
@@ -544,7 +540,7 @@ static int stm32x_write_block(struct flash_bank *bank, uint8_t *buffer,
 			LOG_ERROR("flash memory write protected");
 			/* Clear but report errors */
 			target_write_u32(target, STM32_FLASH_SR, FLASH_WRPRTERR);
-			retval = ERROR_FLASH_OPERATION_FAILED;
+			retval = ERROR_FAIL;
 			break;
 		}
 
@@ -572,7 +568,6 @@ static int stm32x_write(struct flash_bank *bank, uint8_t *buffer,
 	uint32_t bytes_remaining = (count & 0x00000001);
 	uint32_t address = bank->base + offset;
 	uint32_t bytes_written = 0;
-	uint8_t status;
 	int retval;
 
 	if (bank->target->state != TARGET_HALTED)
@@ -603,11 +598,6 @@ static int stm32x_write(struct flash_bank *bank, uint8_t *buffer,
 				 * we use normal (slow) single dword accesses */
 				LOG_WARNING("couldn't use block writes, falling back to single memory accesses");
 			}
-			else if (retval == ERROR_FLASH_OPERATION_FAILED)
-			{
-				LOG_ERROR("flash writing failed with error code: 0x%x", retval);
-				return ERROR_FLASH_OPERATION_FAILED;
-			}
 		}
 		else
 		{
@@ -625,18 +615,9 @@ static int stm32x_write(struct flash_bank *bank, uint8_t *buffer,
 		target_write_u32(target, STM32_FLASH_CR, FLASH_PG);
 		target_write_u16(target, address, value);
 
-		status = stm32x_wait_status_busy(bank, 5);
-
-		if (status & FLASH_WRPRTERR)
-		{
-			LOG_ERROR("flash memory not erased before writing");
-			return ERROR_FLASH_OPERATION_FAILED;
-		}
-		if (status & FLASH_PGERR)
-		{
-			LOG_ERROR("flash memory write protected");
-			return ERROR_FLASH_OPERATION_FAILED;
-		}
+		retval = stm32x_wait_status_busy(bank, 5);
+		if (retval != ERROR_OK)
+			return retval;
 
 		bytes_written += 2;
 		words_remaining--;
@@ -651,18 +632,9 @@ static int stm32x_write(struct flash_bank *bank, uint8_t *buffer,
 		target_write_u32(target, STM32_FLASH_CR, FLASH_PG);
 		target_write_u16(target, address, value);
 
-		status = stm32x_wait_status_busy(bank, 5);
-
-		if (status & FLASH_WRPRTERR)
-		{
-			LOG_ERROR("flash memory not erased before writing");
-			return ERROR_FLASH_OPERATION_FAILED;
-		}
-		if (status & FLASH_PGERR)
-		{
-			LOG_ERROR("flash memory write protected");
-			return ERROR_FLASH_OPERATION_FAILED;
-		}
+		retval = stm32x_wait_status_busy(bank, 5);
+		if (retval != ERROR_OK)
+			return retval;
 	}
 
 	target_write_u32(target, STM32_FLASH_CR, FLASH_LOCK);
@@ -770,7 +742,7 @@ static int stm32x_probe(struct flash_bank *bank)
 	else
 	{
 		LOG_WARNING("Cannot identify target as a STM32 family.");
-		return ERROR_FLASH_OPERATION_FAILED;
+		return ERROR_FAIL;
 	}
 
 	LOG_INFO("flash size = %dkbytes", num_pages);
@@ -938,7 +910,7 @@ static int get_stm32x_info(struct flash_bank *bank, char *buf, int buf_size)
 	else
 	{
 		snprintf(buf, buf_size, "Cannot identify target as a stm32x\n");
-		return ERROR_FLASH_OPERATION_FAILED;
+		return ERROR_FAIL;
 	}
 
 	return ERROR_OK;
@@ -1176,7 +1148,6 @@ COMMAND_HANDLER(stm32x_handle_options_write_command)
 static int stm32x_mass_erase(struct flash_bank *bank)
 {
 	struct target *target = bank->target;
-	uint32_t status;
 
 	if (target->state != TARGET_HALTED)
 	{
@@ -1192,22 +1163,12 @@ static int stm32x_mass_erase(struct flash_bank *bank)
 	target_write_u32(target, STM32_FLASH_CR, FLASH_MER);
 	target_write_u32(target, STM32_FLASH_CR, FLASH_MER | FLASH_STRT);
 
-	status = stm32x_wait_status_busy(bank, 100);
+	int retval = stm32x_wait_status_busy(bank, 100);
+	if (retval != ERROR_OK)
+		return retval;
 
 	target_write_u32(target, STM32_FLASH_CR, FLASH_LOCK);
 
-	if (status & FLASH_WRPRTERR)
-	{
-		LOG_ERROR("stm32x device protected");
-		return ERROR_FLASH_OPERATION_FAILED;
-	}
-
-	if (status & FLASH_PGERR)
-	{
-		LOG_ERROR("stm32x device programming failed");
-		return ERROR_FLASH_OPERATION_FAILED;
-	}
-
 	return ERROR_OK;
 }
 

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/stm32x.c |  361 +++++++++++++++++++++++++++---------------------
 1 files changed, 205 insertions(+), 156 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Nov  9 09:27:09 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue,  9 Nov 2010 08:27:09 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-583-ge7b2958
Message-ID: <E1PFjXr-0006SQ-18@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  e7b2958229c7e0d7e98e130764aa50d1ca9017d3 (commit)
       via  4747af362de04b508c91df4004d2aed5579c8a1c (commit)
       via  d220e22e6376fa67d85c9731a4165f86609390d8 (commit)
      from  fc4e001de34029ca6451038a351b433677d4f388 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit e7b2958229c7e0d7e98e130764aa50d1ca9017d3
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Mon Nov 8 17:23:49 2010 +0800

    TCL scripts: replace "puts" with "echo"
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/jtag/startup.tcl b/src/jtag/startup.tcl
index fdd3078..1779df5 100644
--- a/src/jtag/startup.tcl
+++ b/src/jtag/startup.tcl
@@ -30,7 +30,7 @@ proc init_reset { mode } {
 # documented nor supported except on ZY1000.
 
 proc power_restore {} {
-	puts "Sensed power restore, running reset init and halting GDB."
+	echo "Sensed power restore, running reset init and halting GDB."
 	reset init
 	
 	# Halt GDB so user can deal with a detected power restore.
@@ -47,7 +47,7 @@ proc power_restore {} {
 add_help_text power_restore "Overridable procedure run when power restore is detected. Runs 'reset init' by default."
 
 proc power_dropout {} {
-	puts "Sensed power dropout."
+	echo "Sensed power dropout."
 }
 
 #########
@@ -56,7 +56,7 @@ proc power_dropout {} {
 # documented nor supported except on ZY1000.
 
 proc srst_deasserted {} {
-	puts "Sensed nSRST deasserted, running reset init and halting GDB."
+	echo "Sensed nSRST deasserted, running reset init and halting GDB."
 	reset init
 
 	# Halt GDB so user can deal with a detected reset.
@@ -73,7 +73,7 @@ proc srst_deasserted {} {
 add_help_text srst_deasserted "Overridable procedure run when srst deassert is detected. Runs 'reset init' by default."
 
 proc srst_asserted {} {
-	puts "Sensed nSRST asserted."
+	echo "Sensed nSRST asserted."
 }
 
 # measure actual JTAG clock
diff --git a/tcl/bitsbytes.tcl b/tcl/bitsbytes.tcl
index 3f65c20..2c4fd29 100644
--- a/tcl/bitsbytes.tcl
+++ b/tcl/bitsbytes.tcl
@@ -54,7 +54,7 @@ proc show_normalize_bitfield { VALUE MSB LSB } {
     set m [create_mask $MSB $LSB]
     set mr [expr $VALUE & $m]
     set sr [expr $mr >> $LSB]
-    puts [format "((0x%08x & 0x%08x) -> 0x%08x) >> %2d => (0x%x) %5d " $VALUE $m $mr $LSB $sr $sr]
+    echo [format "((0x%08x & 0x%08x) -> 0x%08x) >> %2d => (0x%x) %5d " $VALUE $m $mr $LSB $sr $sr]
    return $sr
 }
 
diff --git a/tcl/board/at91eb40a.cfg b/tcl/board/at91eb40a.cfg
index 14f21a1..dc5aacb 100644
--- a/tcl/board/at91eb40a.cfg
+++ b/tcl/board/at91eb40a.cfg
@@ -53,7 +53,7 @@ flash bank $_FLASHNAME ecosflash 0x01000000 0x200000 2 2 $_TARGETNAME ecos/at91e
 $_TARGETNAME configure -work-area-phys 0x00030000 -work-area-size 0x10000 -work-area-backup 0
 
 $_TARGETNAME configure -event reset-init {
-	puts "Running reset init script for AT91EB40A"
+	echo "Running reset init script for AT91EB40A"
 	# Reset script for AT91EB40a
 	reg cpsr 0x000000D3
 	mww 0xFFE00020 0x1
diff --git a/tcl/board/dm355evm.cfg b/tcl/board/dm355evm.cfg
index 02c4c86..0c971e9 100644
--- a/tcl/board/dm355evm.cfg
+++ b/tcl/board/dm355evm.cfg
@@ -18,7 +18,7 @@ $_TARGETNAME configure -event reset-init { dm355evm_init }
 proc dm355evm_init {} {
 	global dm355
 
-	puts "Initialize DM355 EVM board"
+	echo "Initialize DM355 EVM board"
 
 	# CLKIN	= 24 MHz ... can't talk quickly to ARM yet
 	jtag_rclk 1500
diff --git a/tcl/board/dm6446evm.cfg b/tcl/board/dm6446evm.cfg
index dcd1c4e..0d2f6a4 100644
--- a/tcl/board/dm6446evm.cfg
+++ b/tcl/board/dm6446evm.cfg
@@ -59,7 +59,7 @@ $_TARGETNAME configure -event reset-init { dm6446evm_init }
 #
 proc dm6446evm_init {} {
 
-	puts "Initialize DM6446 EVM board"
+	echo "Initialize DM6446 EVM board"
 
 	# FIXME initialize everything:
 	#  - PLL1
diff --git a/tcl/board/ethernut3.cfg b/tcl/board/ethernut3.cfg
index 34e9b72..ad45527 100644
--- a/tcl/board/ethernut3.cfg
+++ b/tcl/board/ethernut3.cfg
@@ -77,10 +77,10 @@ proc board_remap {{VERBOSE 0}} {
 	mww 0xffe00020 0x00000001
 
 	if {$VERBOSE != 0} {
-		puts "0x00000000 RAM"
-		puts "0x10000000 Flash"
-		puts "0x20000000 Ethernet"
-		puts "0x21000000 CPLD"
-		puts "0x22000000 Expansion"
+		echo "0x00000000 RAM"
+		echo "0x10000000 Flash"
+		echo "0x20000000 Ethernet"
+		echo "0x21000000 CPLD"
+		echo "0x22000000 Expansion"
 	}
 }
diff --git a/tcl/board/lubbock.cfg b/tcl/board/lubbock.cfg
index b58ad5a..298954c 100644
--- a/tcl/board/lubbock.cfg
+++ b/tcl/board/lubbock.cfg
@@ -38,7 +38,7 @@ proc hexled {u32} {
 
 proc lubbock_init {target} {
 
-	puts "Initialize PXA255 Lubbock board"
+	echo "Initialize PXA255 Lubbock board"
 
 	# (1) pinmux
 
diff --git a/tcl/board/olimex_sam9_l9260.cfg b/tcl/board/olimex_sam9_l9260.cfg
index 7c4b2cc..5c16ed2 100644
--- a/tcl/board/olimex_sam9_l9260.cfg
+++ b/tcl/board/olimex_sam9_l9260.cfg
@@ -35,7 +35,7 @@ $_TARGETNAME configure -event reset-init {
 	##
 	# Clock configuration for 99.328 MHz main clock.
 	##
-    puts "Setting up clock"
+    echo "Setting up clock"
 	mww 0xfffffc20 0x00004001 # CKGR_MOR : enable main oscillator, 512 slow clock startup
 	sleep 20                  # wait 20 ms (need 15.6 ms for startup)
 	mww 0xfffffc30 0x00000001 # PMC_MCKR : switch to main oscillator (18.432 MHz)
@@ -54,7 +54,7 @@ $_TARGETNAME configure -event reset-init {
 	##
 	# SDRAM configuration for 2 x Samsung K4S561632J-UC75, 4M x 16Bit x 4 Banks.
 	##
-    puts "Configuring SDRAM"
+    echo "Configuring SDRAM"
 	mww 0xfffff870 0xffff0000 # PIOC_ASR : select peripheral function for D15..D31
 	mww 0xfffff804 0xffff0000 # PIOC_PDR : disable PIO function for D15..D31
 	
@@ -92,7 +92,7 @@ $_TARGETNAME configure -event reset-init {
     ##
     # NAND Flash Configuration for 1 x Samsung K9F4G08U0M, 512M x 8Bit.
     ##
-    puts "Configuring NAND flash"
+    echo "Configuring NAND flash"
     mww 0xfffffc10 0x00000010 ;# PMC_PCER : enable PIOC clock
     mww 0xfffff800 0x00006000 ;# PIOC_PER : enable PIO function for 13(RDY/~BSY) and 14(~CS)
     mww 0xfffff810 0x00004000 ;# PIOC_OER : enable output on 14
@@ -116,7 +116,7 @@ $_TARGETNAME configure -event reset-init {
     ##
     # Dataflash configuration for 1 x Atmel AT45DB161D, 16Mbit
     ##
-    puts "Setting up dataflash"
+    echo "Setting up dataflash"
     mww 0xfffff404 0x00000807 ;# PIOA_PDR : disable PIO function for 0(SPI0_MISO), 1(SPI0_MOSI), 
                                #            2(SPI0_SPCK), and 11(SPI0_NPCS1)
     mww 0xfffff470 0x00000007 ;# PIOA_ASR : select peripheral A function for 0, 1, and 2
diff --git a/tcl/board/telo.cfg b/tcl/board/telo.cfg
index 1c0ad76..119373c 100644
--- a/tcl/board/telo.cfg
+++ b/tcl/board/telo.cfg
@@ -31,24 +31,24 @@ $_TARGETNAME configure -event reset-init {
 	setupTelo
 	#turn up the JTAG speed
 	adapter_khz 3000
-	puts "JTAG speek now 3MHz"
-	puts "type helpC100 to get help on C100"
+	echo "JTAG speek now 3MHz"
+	echo "type helpC100 to get help on C100"
 }
 
 $_TARGETNAME configure -event reset-deassert-post {
 	# Force target into ARM state.
 #	soft_reset_halt # not implemented on ARM11
-	puts "Detected SRSRT asserted on C100.CPU"
+	echo "Detected SRSRT asserted on C100.CPU"
 
 }
 
 $_TARGETNAME configure -event reset-assert-post {
-  puts "Assering reset"
+  echo "Assering reset"
   #sleep 10
 }
 
-proc power_restore {} { puts "Sensed power restore. No action." }
-proc srst_deasserted {} { puts "Sensed nSRST deasserted. No action." }
+proc power_restore {} { echo "Sensed power restore. No action." }
+proc srst_deasserted {} { echo "Sensed nSRST deasserted. No action." }
 
 
 # boots from NOR on CS0:  8 MBytes CFI flash, 16-bit bus
diff --git a/tcl/board/zy1000.cfg b/tcl/board/zy1000.cfg
index d2561e9..63334ee 100644
--- a/tcl/board/zy1000.cfg
+++ b/tcl/board/zy1000.cfg
@@ -85,11 +85,11 @@ proc production_info {} {
 # Progress messages are output via puts
 proc production {firmwarefile serialnumber} {
 	if {[string length $serialnumber]!=12} {
-		puts "Invalid serial number"
+		echo "Invalid serial number"
 		return
 	}
 
-	puts "Power cycling target"
+	echo "Power cycling target"
 	power off
 	sleep 3000
 	power on
@@ -99,10 +99,10 @@ proc production {firmwarefile serialnumber} {
 	verify_image $firmwarefile 0x1000000 bin
 
 	# Big endian... weee!!!!
-	puts "Setting MAC number to $serialnumber"
+	echo "Setting MAC number to $serialnumber"
 	flash fillw [expr 0x1030000-0x8] "0x[string range $serialnumber 2 3][string range $serialnumber 0 1]0000" 1
 	flash fillw [expr 0x1030000-0x4] "0x[string range $serialnumber 10 11][string range $serialnumber 8 9][string range $serialnumber 6 7][string range $serialnumber 4 5]" 1
-	puts "Production successful"
+	echo "Production successful"
 }
 
 
diff --git a/tcl/chip/atmel/at91/aic.tcl b/tcl/chip/atmel/at91/aic.tcl
index 366be6d..6dae36a 100644
--- a/tcl/chip/atmel/at91/aic.tcl
+++ b/tcl/chip/atmel/at91/aic.tcl
@@ -57,33 +57,33 @@ proc show_AIC { } {
     if [catch { mem2array aaa 32 $AIC_SMR [expr 32 * 4] } msg ] {
 	error [format "%s (%s)" $msg AIC_SMR]
     }
-    puts "AIC_SMR: Mode & Type"
+    echo "AIC_SMR: Mode & Type"
     global AT91C_ID
     for { set x 0 } { $x < 32 } {  } {
-	puts -nonewline "   "
-	puts -nonewline [format "%2d: %5s 0x%08x | " $x $AT91C_ID($x) $aaa($x)]
+	echo -n "   "
+	echo -n [format "%2d: %5s 0x%08x | " $x $AT91C_ID($x) $aaa($x)]
 	incr x
-	puts -nonewline [format "%2d: %5s 0x%08x | " $x $AT91C_ID($x) $aaa($x)]
+	echo -n [format "%2d: %5s 0x%08x | " $x $AT91C_ID($x) $aaa($x)]
 	incr x
-	puts -nonewline [format "%2d: %5s 0x%08x | " $x $AT91C_ID($x) $aaa($x)]
+	echo -n [format "%2d: %5s 0x%08x | " $x $AT91C_ID($x) $aaa($x)]
 	incr x
-	puts  [format "%2d: %5s 0x%08x"  $x $AT91C_ID($x) $aaa($x)]
+	echo  [format "%2d: %5s 0x%08x"  $x $AT91C_ID($x) $aaa($x)]
 	incr x
     }
     global AIC_SVR
     if [catch { mem2array aaa 32 $AIC_SVR [expr 32 * 4] } msg ] {
 	error [format "%s (%s)" $msg AIC_SVR]
     }
-    puts "AIC_SVR: Vectors"
+    echo "AIC_SVR: Vectors"
     for { set x 0 } { $x < 32 } {  } {
-	puts -nonewline "   "
-	puts -nonewline [format "%2d: %5s 0x%08x | " $x $AT91C_ID($x) $aaa($x)]
+	echo -n "   "
+	echo -n [format "%2d: %5s 0x%08x | " $x $AT91C_ID($x) $aaa($x)]
 	incr x
-	puts -nonewline [format "%2d: %5s 0x%08x | " $x $AT91C_ID($x) $aaa($x)]
+	echo -n [format "%2d: %5s 0x%08x | " $x $AT91C_ID($x) $aaa($x)]
 	incr x
-	puts -nonewline [format "%2d: %5s 0x%08x | " $x $AT91C_ID($x) $aaa($x)]
+	echo -n [format "%2d: %5s 0x%08x | " $x $AT91C_ID($x) $aaa($x)]
 	incr x
-	puts [format "%2d: %5s 0x%08x" $x $AT91C_ID($x) $aaa($x)]
+	echo [format "%2d: %5s 0x%08x" $x $AT91C_ID($x) $aaa($x)]
 	incr x
     }
 
diff --git a/tcl/chip/atmel/at91/rtt.tcl b/tcl/chip/atmel/at91/rtt.tcl
index 433cfe3..8be6a56 100644
--- a/tcl/chip/atmel/at91/rtt.tcl
+++ b/tcl/chip/atmel/at91/rtt.tcl
@@ -18,16 +18,16 @@ proc show_RTTC_RTMR_helper { NAME ADDR VAL } {
     # Nasty hack, make this a float by tacking a .0 on the end
     # otherwise, jim makes the value an integer
     set f [expr $AT91C_SLOWOSC_FREQ.0 / $rtpres.0]
-    puts [format "\tPrescale value: 0x%04x (%5d) => %f Hz" $rtpres $rtpres $f]
+    echo [format "\tPrescale value: 0x%04x (%5d) => %f Hz" $rtpres $rtpres $f]
     if { $VAL & $BIT16 } {
-	puts "\tBit16 -> Alarm IRQ Enabled"
+	echo "\tBit16 -> Alarm IRQ Enabled"
     } else {
-	puts "\tBit16 -> Alarm IRQ Disabled"
+	echo "\tBit16 -> Alarm IRQ Disabled"
     }
     if { $VAL & $BIT17 } {
-	puts "\tBit17 -> RTC Inc IRQ Enabled"
+	echo "\tBit17 -> RTC Inc IRQ Enabled"
     } else {
-	puts "\tBit17 -> RTC Inc IRQ Disabled"
+	echo "\tBit17 -> RTC Inc IRQ Disabled"
     }
     # Bit 18 is write only.
 }
@@ -35,14 +35,14 @@ proc show_RTTC_RTMR_helper { NAME ADDR VAL } {
 proc show_RTTC_RTSR_helper { NAME ADDR VAL } {
     global BIT0 BIT1
     if { $VAL & $BIT0 } {
-	puts "\tBit0 -> ALARM PENDING"
+	echo "\tBit0 -> ALARM PENDING"
     } else {
-	puts "\tBit0 -> alarm not pending"
+	echo "\tBit0 -> alarm not pending"
     }
     if { $VAL & $BIT1 } {
-	puts "\tBit0 -> RTINC PENDING"
+	echo "\tBit0 -> RTINC PENDING"
     } else {
-	puts "\tBit0 -> rtinc not pending"
+	echo "\tBit0 -> rtinc not pending"
     }
 }
 
diff --git a/tcl/chip/atmel/at91/usarts.tcl b/tcl/chip/atmel/at91/usarts.tcl
index f798fc4..6842029 100644
--- a/tcl/chip/atmel/at91/usarts.tcl
+++ b/tcl/chip/atmel/at91/usarts.tcl
@@ -41,9 +41,9 @@ proc show_mmr_USx_MR_helper { NAME ADDR VAL } {
 
     set x [show_normalize_bitfield $VAL 3 0]
     if { $x == 0 } {
-	puts "\tNormal operation"
+	echo "\tNormal operation"
     } else {
-	puts [format "\tNon Normal operation mode: 0x%02x" $x]
+	echo [format "\tNon Normal operation mode: 0x%02x" $x]
     }
 
     set x [show_normalize_bitfield $VAL 11 9]
@@ -61,17 +61,17 @@ proc show_mmr_USx_MR_helper { NAME ADDR VAL } {
 	    }
 	}
     }
-    puts [format "\tParity: %s " $s]
+    echo [format "\tParity: %s " $s]
 
     set x [expr 5 + [show_normalize_bitfield $VAL 7 6]]
-    puts [format "\tDatabits: %d" $x]
+    echo [format "\tDatabits: %d" $x]
 
     set x [show_normalize_bitfield $VAL 13 12]
     switch -exact $x {
-	0 { puts "\tStop bits: 1" }
-	1 { puts "\tStop bits: 1.5" }
-	2 { puts "\tStop bits: 2" }
-	3 { puts "\tStop bits: Illegal/Reserved" }
+	0 { echo "\tStop bits: 1" }
+	1 { echo "\tStop bits: 1.5" }
+	2 { echo "\tStop bits: 2" }
+	3 { echo "\tStop bits: Illegal/Reserved" }
     }
 }
 
diff --git a/tcl/chip/st/spear/quirk_no_srst.tcl b/tcl/chip/st/spear/quirk_no_srst.tcl
index df22764..fd02d07 100644
--- a/tcl/chip/st/spear/quirk_no_srst.tcl
+++ b/tcl/chip/st/spear/quirk_no_srst.tcl
@@ -37,9 +37,9 @@ proc sp_reset_deassert_post {} {
 	set bar(3) \\
 
 	poll on
-	puts "====> Press reset button on the board <===="
+	echo "====> Press reset button on the board <===="
 	for {set i 0} { [sp_is_halted] == 0 } { set i [expr $i + 1]} {
-		puts -nonewline "$bar([expr $i & 3])\r"
+		echo -n "$bar([expr $i & 3])\r"
 		sleep 200
 	}
 
diff --git a/tcl/chip/st/spear/spear3xx_ddr.tcl b/tcl/chip/st/spear/spear3xx_ddr.tcl
index eb1c4b0..a804cdc 100644
--- a/tcl/chip/st/spear/spear3xx_ddr.tcl
+++ b/tcl/chip/st/spear/spear3xx_ddr.tcl
@@ -23,11 +23,11 @@ proc sp3xx_ddr_init {ddr_type} {
 	mww $ddr_size 0x87654321
 	mww 0x00000000 0x12345678
 	if {[expr [mrw 0x00000000] == 0x12345678 && [mrw $ddr_size] == 0x87654321]} {
-		puts [format \
+		echo [format \
 			"Double chip DDR memory. Total memory size 0x%08x byte" \
 			[expr 2 * $ddr_size]]
 	} else {
-		puts [format \
+		echo [format \
 			"Single chip DDR memory. Memory size 0x%08x byte" \
 			$ddr_size]
 	}
diff --git a/tcl/mmr_helpers.tcl b/tcl/mmr_helpers.tcl
index 9029911..ce116e4 100644
--- a/tcl/mmr_helpers.tcl
+++ b/tcl/mmr_helpers.tcl
@@ -13,7 +13,7 @@ proc show_mmr32_reg { NAME } {
     set a [set [set NAME]]
 
     if ![catch { set v [memread32 $a] } msg ] {
-	puts [format "%15s: (0x%08x): 0x%08x" $NAME $a $v]
+	echo [format "%15s: (0x%08x): 0x%08x" $NAME $a $v]
 
 	# Was a helper defined?
 	set fn show_${NAME}_helper
@@ -43,18 +43,18 @@ proc show_mmr32_bits { NAMES VAL } {
     }
 
     for { set x 24 } { $x >= 0 } { incr x -8 } {
-	puts -nonewline "  "
+	echo -n "  "
 	for { set y 7 } { $y >= 0 } { incr y -1 } {
 	    set s $MYNAMES([expr $x + $y])
-	    puts -nonewline [format "%2d: %-*s | " [expr $x + $y] $w $s ]
+	    echo -n [format "%2d: %-*s | " [expr $x + $y] $w $s ]
 	}
-	puts ""
+	echo ""
 
-	puts -nonewline "  "
+	echo -n "  "
 	for { set y 7 } { $y >= 0 } { incr y -1 } {
-	    puts -nonewline [format "    %d%*s | " [expr !!($VAL & (1 << ($x + $y)))] [expr $w -1] ""]
+	    echo -n [format "    %d%*s | " [expr !!($VAL & (1 << ($x + $y)))] [expr $w -1] ""]
 	}
-	puts ""
+	echo ""
     }
 }
 
@@ -68,5 +68,5 @@ proc show_mmr_bitfield { MSB LSB VAL FIELDNAME FIELDVALUES } {
     } else {
 	set sval ""
     }
-    puts [format "%-15s: %d (0x%0*x) %s" $FIELDNAME $nval $width $nval $sval ]
+    echo [format "%-15s: %d (0x%0*x) %s" $FIELDNAME $nval $width $nval $sval ]
 }
diff --git a/tcl/target/aduc702x.cfg b/tcl/target/aduc702x.cfg
index d58b723..dcb9c12 100644
--- a/tcl/target/aduc702x.cfg
+++ b/tcl/target/aduc702x.cfg
@@ -45,7 +45,7 @@ flash bank $_FLASHNAME aduc702x 0 0 0 0 $_TARGETNAME
 proc watchdog_service {} {
     global watchdog_hdl
     mww 0xffff036c 0
-#    puts "watchdog!!"
+#    echo "watchdog!!"
     set watchdog_hdl [after 500 watchdog_service]
 }
 
diff --git a/tcl/target/c100config.tcl b/tcl/target/c100config.tcl
index 17a9476..52efa83 100644
--- a/tcl/target/c100config.tcl
+++ b/tcl/target/c100config.tcl
@@ -8,7 +8,7 @@ proc config {label} {
 
 # show the value for the param. with label
 proc showconfig {label} {
-    puts [format "0x%x" [dict get [configC100] $label ]]
+    echo [format "0x%x" [dict get [configC100] $label ]]
 }
 
 # Telo board config
@@ -53,7 +53,7 @@ proc setupTelo {} {
 
 
 proc setupNOR {} {
-    puts "Setting up NOR: 16MB, 16-bit wide bus, CS0"
+    echo "Setting up NOR: 16MB, 16-bit wide bus, CS0"
     # this is taken from u-boot/boards/mindspeed/ooma-darwin/board.c:nor_hw_init()
     set EX_CSEN_REG	    [regs EX_CSEN_REG ]
     set EX_CS0_SEG_REG	    [regs EX_CS0_SEG_REG ]
@@ -99,7 +99,7 @@ proc bootNOR {} {
     resume
 }
 proc setupGPIO {} {
-    puts "Setting up GPIO block for Telo"
+    echo "Setting up GPIO block for Telo"
     # This is current setup for Telo (see sch. for details):
     #GPIO0 reset for FXS-FXO IC, leave as input, the IC has internal pullup
     #GPIO1 irq line for FXS-FXO
@@ -117,14 +117,14 @@ proc setupGPIO {} {
 }
 
 proc highGPIO5 {} {
-    puts "GPIO5 high"
+    echo "GPIO5 high"
     set GPIO_OUTPUT_REG		    [regs GPIO_OUTPUT_REG]
     # set GPIO5=1
     mmw $GPIO_OUTPUT_REG [expr 1 << 5] 0x0
 }
 
 proc lowGPIO5 {} {
-    puts "GPIO5 low"
+    echo "GPIO5 low"
     set GPIO_OUTPUT_REG		    [regs GPIO_OUTPUT_REG]
     # set GPIO5=0
     mmw $GPIO_OUTPUT_REG 0x0 [expr 1 << 5]
@@ -161,12 +161,12 @@ proc ooma_board_detect {} {
 
     # read the current value of the BOOTSRAP pins
     set tmp [mrw $GPIO_BOOTSTRAP_REG]
-    puts [format "GPIO_BOOTSTRAP_REG  (0x%x): 0x%x" $GPIO_BOOTSTRAP_REG $tmp]
+    echo [format "GPIO_BOOTSTRAP_REG  (0x%x): 0x%x" $GPIO_BOOTSTRAP_REG $tmp]
     # extract the GPBP bits
     set gpbt [expr ($tmp &0x1C00) >> 10 | ($tmp & 0x40) >>3]
 
     # display board ID
-    puts [format "This is %s (0x%x)" [dict get [boardID $gpbt] $gpbt name] $gpbt]
+    echo [format "This is %s (0x%x)" [dict get [boardID $gpbt] $gpbt name] $gpbt]
     # show it on serial console
     putsUART0 [format "This is %s (0x%x)\n" [dict get [boardID $gpbt] $gpbt name] $gpbt]
     # return the ddr2 size, used to configure DDR2 on a given board.
@@ -228,13 +228,13 @@ proc configureDDR2regs_256M {} {
     # start DDRC
     mw64bit $DENALI_CTL_02_DATA [expr $DENALI_CTL_02_VAL | (1 << 32)]
     # wait int_status[2] (DRAM init complete)
-    puts -nonewline "Waiting for DDR2 controller to init..."
+    echo -n "Waiting for DDR2 controller to init..."
     set tmp [mrw [expr $DENALI_CTL_08_DATA + 4]]
     while { [expr $tmp & 0x040000] == 0 } {
 	sleep 1
 	set tmp [mrw [expr $DENALI_CTL_08_DATA + 4]]
     }
-    puts "done."
+    echo "done."
 
     # do ddr2 training sequence
     # TBD (for now, if you need it, run trainDDR command)
@@ -296,7 +296,7 @@ proc configureDDR2regs_128M {} {
     # start DDRC
     mw64bit $DENALI_CTL_02_DATA [expr $DENALI_CTL_02_VAL | (1 << 32)]
     # wait int_status[2] (DRAM init complete)
-    puts -nonewline "Waiting for DDR2 controller to init..."
+    echo -n "Waiting for DDR2 controller to init..."
     set tmp [mrw [expr $DENALI_CTL_08_DATA + 4]]
     while { [expr $tmp & 0x040000] == 0 } {
 	sleep 1
@@ -304,7 +304,7 @@ proc configureDDR2regs_128M {} {
     }
     # This is not necessary
     #mw64bit $DENALI_CTL_11_DATA [expr ($DENALI_CTL_11_VAL  & ~0x00007F0000000000) | ($wr_dqs_shift << 40) ]
-    puts "done."
+    echo "done."
 
     # do ddr2 training sequence
     # TBD (for now, if you need it, run trainDDR command)
@@ -398,10 +398,10 @@ proc flashUBOOT {file} {
     # make sure we are accessing the lower part of NOR
     lowGPIO5
     flash probe 0
-    puts "Erasing sectors 0-3 for uboot"
+    echo "Erasing sectors 0-3 for uboot"
     putsUART0 "Erasing sectors 0-3 for uboot\n"
     flash erase_sector 0 0 3
-    puts "Programming u-boot"
+    echo "Programming u-boot"
     putsUART0 "Programming u-boot..."
     arm11 memwrite burst enable
     flash write_image $file $EXP_CS0_BASEADDR
diff --git a/tcl/target/c100helper.tcl b/tcl/target/c100helper.tcl
index 3251066..c9124cb 100644
--- a/tcl/target/c100helper.tcl
+++ b/tcl/target/c100helper.tcl
@@ -1,28 +1,28 @@
 
 proc helpC100 {} {
-    puts "List of useful functions for C100 processor:"
-    puts "1)  reset init:        will set up your Telo board"
-    puts "2)  setupNOR:          will setup NOR access"
-    puts "3)  showNOR:           will show current NOR config registers for 16-bit, 16MB NOR"
-    puts "4)  setupGPIO:         will setup GPIOs for Telo board"
-    puts "5)  showGPIO:          will show current GPIO config registers"
-    puts "6)  highGPIO5:         will set GPIO5=NOR_addr22=1 to access upper 8MB"
-    puts "7)  lowGPIO5:          will set GPIO5=NOR_addr22=0 to access lower 8MB"
-    puts "8)  showAmbaClk:       will show current config registers for Amba Bus Clock"
-    puts "9)  setupAmbaClk:      will setup Amba Bus Clock=165MHz"
-    puts "10) showArmClk:        will show current config registers for Arm Bus Clock"
-    puts "11) setupArmClk:       will setup Amba Bus Clock=450MHz"
-    puts "12) ooma_board_detect: will show which version of Telo you have"
-    puts "13) setupDDR2:         will configure DDR2 controller, you must have PLLs configureg"
-    puts "14) showDDR2:          will show DDR2 config registers"
-    puts "15) showWatchdog:      will show current regster config for watchdog"
-    puts "16) reboot:            will trigger watchdog and reboot Telo (hw reset)"
-    puts "17) bootNOR:           will boot Telo from NOR"
-    puts "18) setupUART0:        will configure UART0 for 115200 8N1, PLLs have to be confiured"
-    puts "19) putcUART0:         will print a character on UART0"
-    puts "20) putsUART0:         will print a string on UART0"
-    puts "21) trainDDR2:          will run DDR2 training program"
-    puts "22) flashUBOOT:        will prgram NOR sectors 0-3 with u-boot.bin"
+    echo "List of useful functions for C100 processor:"
+    echo "1)  reset init:        will set up your Telo board"
+    echo "2)  setupNOR:          will setup NOR access"
+    echo "3)  showNOR:           will show current NOR config registers for 16-bit, 16MB NOR"
+    echo "4)  setupGPIO:         will setup GPIOs for Telo board"
+    echo "5)  showGPIO:          will show current GPIO config registers"
+    echo "6)  highGPIO5:         will set GPIO5=NOR_addr22=1 to access upper 8MB"
+    echo "7)  lowGPIO5:          will set GPIO5=NOR_addr22=0 to access lower 8MB"
+    echo "8)  showAmbaClk:       will show current config registers for Amba Bus Clock"
+    echo "9)  setupAmbaClk:      will setup Amba Bus Clock=165MHz"
+    echo "10) showArmClk:        will show current config registers for Arm Bus Clock"
+    echo "11) setupArmClk:       will setup Amba Bus Clock=450MHz"
+    echo "12) ooma_board_detect: will show which version of Telo you have"
+    echo "13) setupDDR2:         will configure DDR2 controller, you must have PLLs configureg"
+    echo "14) showDDR2:          will show DDR2 config registers"
+    echo "15) showWatchdog:      will show current regster config for watchdog"
+    echo "16) reboot:            will trigger watchdog and reboot Telo (hw reset)"
+    echo "17) bootNOR:           will boot Telo from NOR"
+    echo "18) setupUART0:        will configure UART0 for 115200 8N1, PLLs have to be confiured"
+    echo "19) putcUART0:         will print a character on UART0"
+    echo "20) putsUART0:         will print a string on UART0"
+    echo "21) trainDDR2:          will run DDR2 training program"
+    echo "22) flashUBOOT:        will prgram NOR sectors 0-3 with u-boot.bin"
 }
 
 source [find mem_helper.tcl]
@@ -39,14 +39,14 @@ proc mr64bit {reg} {
 proc mw64bit {reg value} {
     set high [expr $value >> 32]
     set low  [expr $value & 0xffffffff]
-    #puts [format "mw64bit(0x%x): 0x%08x%08x" $reg $high $low]
+    #echo [format "mw64bit(0x%x): 0x%08x%08x" $reg $high $low]
     mww $reg $low
     mww [expr $reg+4] $high
 }
 
 
 proc showNOR {} {
-    puts "This is the current NOR setup"
+    echo "This is the current NOR setup"
     set EX_CSEN_REG	    [regs EX_CSEN_REG ]
     set EX_CS0_SEG_REG	    [regs EX_CS0_SEG_REG ]
     set EX_CS0_CFG_REG	    [regs EX_CS0_CFG_REG ]
@@ -59,23 +59,23 @@ proc showNOR {} {
     set EX_WRFSM_REG	    [regs EX_WRFSM_REG ]
     set EX_RDFSM_REG	    [regs EX_RDFSM_REG ]
 
-    puts [format "EX_CSEN_REG      (0x%x): 0x%x" $EX_CSEN_REG [mrw $EX_CSEN_REG]]
-    puts [format "EX_CS0_SEG_REG   (0x%x): 0x%x" $EX_CS0_SEG_REG [mrw $EX_CS0_SEG_REG]]
-    puts [format "EX_CS0_CFG_REG   (0x%x): 0x%x" $EX_CS0_CFG_REG [mrw $EX_CS0_CFG_REG]]
-    puts [format "EX_CS0_TMG1_REG  (0x%x): 0x%x" $EX_CS0_TMG1_REG [mrw $EX_CS0_TMG1_REG]]
-    puts [format "EX_CS0_TMG2_REG  (0x%x): 0x%x" $EX_CS0_TMG2_REG [mrw $EX_CS0_TMG2_REG]]
-    puts [format "EX_CS0_TMG3_REG  (0x%x): 0x%x" $EX_CS0_TMG3_REG [mrw $EX_CS0_TMG3_REG]]
-    puts [format "EX_CLOCK_DIV_REG (0x%x): 0x%x" $EX_CLOCK_DIV_REG [mrw $EX_CLOCK_DIV_REG]]
-    puts [format "EX_MFSM_REG      (0x%x): 0x%x" $EX_MFSM_REG [mrw $EX_MFSM_REG]]
-    puts [format "EX_CSFSM_REG     (0x%x): 0x%x" $EX_CSFSM_REG [mrw $EX_CSFSM_REG]]
-    puts [format "EX_WRFSM_REG     (0x%x): 0x%x" $EX_WRFSM_REG [mrw $EX_WRFSM_REG]]
-    puts [format "EX_RDFSM_REG     (0x%x): 0x%x" $EX_RDFSM_REG [mrw $EX_RDFSM_REG]]
+    echo [format "EX_CSEN_REG      (0x%x): 0x%x" $EX_CSEN_REG [mrw $EX_CSEN_REG]]
+    echo [format "EX_CS0_SEG_REG   (0x%x): 0x%x" $EX_CS0_SEG_REG [mrw $EX_CS0_SEG_REG]]
+    echo [format "EX_CS0_CFG_REG   (0x%x): 0x%x" $EX_CS0_CFG_REG [mrw $EX_CS0_CFG_REG]]
+    echo [format "EX_CS0_TMG1_REG  (0x%x): 0x%x" $EX_CS0_TMG1_REG [mrw $EX_CS0_TMG1_REG]]
+    echo [format "EX_CS0_TMG2_REG  (0x%x): 0x%x" $EX_CS0_TMG2_REG [mrw $EX_CS0_TMG2_REG]]
+    echo [format "EX_CS0_TMG3_REG  (0x%x): 0x%x" $EX_CS0_TMG3_REG [mrw $EX_CS0_TMG3_REG]]
+    echo [format "EX_CLOCK_DIV_REG (0x%x): 0x%x" $EX_CLOCK_DIV_REG [mrw $EX_CLOCK_DIV_REG]]
+    echo [format "EX_MFSM_REG      (0x%x): 0x%x" $EX_MFSM_REG [mrw $EX_MFSM_REG]]
+    echo [format "EX_CSFSM_REG     (0x%x): 0x%x" $EX_CSFSM_REG [mrw $EX_CSFSM_REG]]
+    echo [format "EX_WRFSM_REG     (0x%x): 0x%x" $EX_WRFSM_REG [mrw $EX_WRFSM_REG]]
+    echo [format "EX_RDFSM_REG     (0x%x): 0x%x" $EX_RDFSM_REG [mrw $EX_RDFSM_REG]]
 }
 
 
 
 proc showGPIO {} {
-    puts "This is the current GPIO register setup"
+    echo "This is the current GPIO register setup"
     # GPIO outputs register
     set GPIO_OUTPUT_REG		    [regs GPIO_OUTPUT_REG]
     # GPIO Output Enable register
@@ -93,19 +93,19 @@ proc showGPIO {} {
     set GPIO_IOCTRL_REG		    [regs GPIO_IOCTRL_REG]
     set GPIO_DEVID_REG		    [regs GPIO_DEVID_REG]
 
-    puts [format "GPIO_OUTPUT_REG       (0x%x): 0x%x" $GPIO_OUTPUT_REG [mrw $GPIO_OUTPUT_REG]]
-    puts [format "GPIO_OE_REG           (0x%x): 0x%x" $GPIO_OE_REG [mrw $GPIO_OE_REG]]
-    puts [format "GPIO_HI_INT_ENABLE_REG(0x%x): 0x%x" $GPIO_HI_INT_ENABLE_REG [mrw $GPIO_HI_INT_ENABLE_REG]]
-    puts [format "GPIO_LO_INT_ENABLE_REG(0x%x): 0x%x" $GPIO_LO_INT_ENABLE_REG [mrw $GPIO_LO_INT_ENABLE_REG]]
-    puts [format "GPIO_INPUT_REG        (0x%x): 0x%x" $GPIO_INPUT_REG [mrw $GPIO_INPUT_REG]]
-    puts [format "APB_ACCESS_WS_REG     (0x%x): 0x%x" $APB_ACCESS_WS_REG [mrw $APB_ACCESS_WS_REG]]
-    puts [format "MUX_CONF_REG          (0x%x): 0x%x" $MUX_CONF_REG [mrw $MUX_CONF_REG]]
-    puts [format "SYSCONF_REG           (0x%x): 0x%x" $SYSCONF_REG [mrw $SYSCONF_REG]]
-    puts [format "GPIO_ARM_ID_REG       (0x%x): 0x%x" $GPIO_ARM_ID_REG [mrw $GPIO_ARM_ID_REG]]
-    puts [format "GPIO_BOOTSTRAP_REG    (0x%x): 0x%x" $GPIO_BOOTSTRAP_REG [mrw $GPIO_BOOTSTRAP_REG]]
-    puts [format "GPIO_LOCK_REG         (0x%x): 0x%x" $GPIO_LOCK_REG [mrw $GPIO_LOCK_REG]]
-    puts [format "GPIO_IOCTRL_REG       (0x%x): 0x%x" $GPIO_IOCTRL_REG [mrw $GPIO_IOCTRL_REG]]
-    puts [format "GPIO_DEVID_REG        (0x%x): 0x%x" $GPIO_DEVID_REG [mrw $GPIO_DEVID_REG]]
+    echo [format "GPIO_OUTPUT_REG       (0x%x): 0x%x" $GPIO_OUTPUT_REG [mrw $GPIO_OUTPUT_REG]]
+    echo [format "GPIO_OE_REG           (0x%x): 0x%x" $GPIO_OE_REG [mrw $GPIO_OE_REG]]
+    echo [format "GPIO_HI_INT_ENABLE_REG(0x%x): 0x%x" $GPIO_HI_INT_ENABLE_REG [mrw $GPIO_HI_INT_ENABLE_REG]]
+    echo [format "GPIO_LO_INT_ENABLE_REG(0x%x): 0x%x" $GPIO_LO_INT_ENABLE_REG [mrw $GPIO_LO_INT_ENABLE_REG]]
+    echo [format "GPIO_INPUT_REG        (0x%x): 0x%x" $GPIO_INPUT_REG [mrw $GPIO_INPUT_REG]]
+    echo [format "APB_ACCESS_WS_REG     (0x%x): 0x%x" $APB_ACCESS_WS_REG [mrw $APB_ACCESS_WS_REG]]
+    echo [format "MUX_CONF_REG          (0x%x): 0x%x" $MUX_CONF_REG [mrw $MUX_CONF_REG]]
+    echo [format "SYSCONF_REG           (0x%x): 0x%x" $SYSCONF_REG [mrw $SYSCONF_REG]]
+    echo [format "GPIO_ARM_ID_REG       (0x%x): 0x%x" $GPIO_ARM_ID_REG [mrw $GPIO_ARM_ID_REG]]
+    echo [format "GPIO_BOOTSTRAP_REG    (0x%x): 0x%x" $GPIO_BOOTSTRAP_REG [mrw $GPIO_BOOTSTRAP_REG]]
+    echo [format "GPIO_LOCK_REG         (0x%x): 0x%x" $GPIO_LOCK_REG [mrw $GPIO_LOCK_REG]]
+    echo [format "GPIO_IOCTRL_REG       (0x%x): 0x%x" $GPIO_IOCTRL_REG [mrw $GPIO_IOCTRL_REG]]
+    echo [format "GPIO_DEVID_REG        (0x%x): 0x%x" $GPIO_DEVID_REG [mrw $GPIO_DEVID_REG]]
 }
 
 
@@ -116,22 +116,22 @@ proc showAmbaClk {} {
     set CLKCORE_AHB_CLK_CNTRL	     [regs CLKCORE_AHB_CLK_CNTRL]
     set PLL_CLK_BYPASS	             [regs PLL_CLK_BYPASS]
 
-    puts [format "CLKCORE_AHB_CLK_CNTRL       (0x%x): 0x%x" $CLKCORE_AHB_CLK_CNTRL [mrw $CLKCORE_AHB_CLK_CNTRL]]
+    echo [format "CLKCORE_AHB_CLK_CNTRL       (0x%x): 0x%x" $CLKCORE_AHB_CLK_CNTRL [mrw $CLKCORE_AHB_CLK_CNTRL]]
     mem2array value 32 $CLKCORE_AHB_CLK_CNTRL 1
     # see if the PLL is in bypass mode
     set bypass [expr ($value(0) & $PLL_CLK_BYPASS) >> 24 ]
-    puts [format "PLL bypass bit: %d" $bypass]
+    echo [format "PLL bypass bit: %d" $bypass]
     if {$bypass == 1} {
-	puts [format "Amba Clk is set to REFCLK: %d (MHz)" [expr $CFG_REFCLKFREQ/1000000]]
+	echo [format "Amba Clk is set to REFCLK: %d (MHz)" [expr $CFG_REFCLKFREQ/1000000]]
     } else {
 	# nope, extract x,y,w and compute the PLL output freq.
 	set x [expr ($value(0) & 0x0001F0000) >> 16]
-	puts [format "x: %d" $x]
+	echo [format "x: %d" $x]
 	set y [expr ($value(0) & 0x00000007F)]
-	puts [format "y: %d" $y]
+	echo [format "y: %d" $y]
 	set w [expr ($value(0) & 0x000000300) >> 8]
-	puts [format "w: %d" $w]
-	puts [format "Amba PLL Clk: %d (MHz)" [expr ($CFG_REFCLKFREQ * $y / (($w + 1) * ($x + 1) * 2))/1000000]]
+	echo [format "w: %d" $w]
+	echo [format "Amba PLL Clk: %d (MHz)" [expr ($CFG_REFCLKFREQ * $y / (($w + 1) * ($x + 1) * 2))/1000000]]
     }
 }
 
@@ -154,10 +154,10 @@ proc setupAmbaClk {} {
     set x    [config x_amba]
     set y    [config y_amba]
 
-    puts [format "Setting Amba PLL to lock to %d MHz" [expr $CONFIG_SYS_HZ_CLOCK/1000000]]
-    #puts [format "setupAmbaClk: w= %d" $w]
-    #puts [format "setupAmbaClk: x= %d" $x]
-    #puts [format "setupAmbaClk: y= %d" $y]
+    echo [format "Setting Amba PLL to lock to %d MHz" [expr $CONFIG_SYS_HZ_CLOCK/1000000]]
+    #echo [format "setupAmbaClk: w= %d" $w]
+    #echo [format "setupAmbaClk: x= %d" $x]
+    #echo [format "setupAmbaClk: y= %d" $y]
     # set PLL into BYPASS mode using MUX
     mmw $CLKCORE_AHB_CLK_CNTRL $PLL_CLK_BYPASS 0x0
     # do an internal PLL bypass
@@ -176,7 +176,7 @@ proc setupAmbaClk {} {
     mmw $CLKCORE_AHB_CLK_CNTRL 0x0 0xFFFFFF
     mmw $CLKCORE_AHB_CLK_CNTRL [expr (($x << 16) + ($w << 8) + $y)] 0x0
     # wait for PLL to lock
-    puts "Wating for Amba PLL to lock"
+    echo "Wating for Amba PLL to lock"
     while {[expr [mrw $CLKCORE_PLL_STATUS] & $AHBCLK_PLL_LOCK] == 0} { sleep 1 }
     # remove the internal PLL bypass
     mmw $CLKCORE_AHB_CLK_CNTRL 0x0 $AHB_PLL_BY_CTRL
@@ -191,22 +191,22 @@ proc showArmClk {} {
     set CLKCORE_ARM_CLK_CNTRL	[regs CLKCORE_ARM_CLK_CNTRL]
     set PLL_CLK_BYPASS	        [regs PLL_CLK_BYPASS]
 
-    puts [format "CLKCORE_ARM_CLK_CNTRL       (0x%x): 0x%x" $CLKCORE_ARM_CLK_CNTRL [mrw $CLKCORE_ARM_CLK_CNTRL]]
+    echo [format "CLKCORE_ARM_CLK_CNTRL       (0x%x): 0x%x" $CLKCORE_ARM_CLK_CNTRL [mrw $CLKCORE_ARM_CLK_CNTRL]]
     mem2array value 32 $CLKCORE_ARM_CLK_CNTRL 1
     # see if the PLL is in bypass mode
     set bypass [expr ($value(0) & $PLL_CLK_BYPASS) >> 24 ]
-    puts [format "PLL bypass bit: %d" $bypass]
+    echo [format "PLL bypass bit: %d" $bypass]
     if {$bypass == 1} {
-	puts [format "Amba Clk is set to REFCLK: %d (MHz)" [expr $CFG_REFCLKFREQ/1000000]]
+	echo [format "Amba Clk is set to REFCLK: %d (MHz)" [expr $CFG_REFCLKFREQ/1000000]]
     } else {
 	# nope, extract x,y,w and compute the PLL output freq.
 	set x [expr ($value(0) & 0x0001F0000) >> 16]
-	puts [format "x: %d" $x]
+	echo [format "x: %d" $x]
 	set y [expr ($value(0) & 0x00000007F)]
-	puts [format "y: %d" $y]
+	echo [format "y: %d" $y]
 	set w [expr ($value(0) & 0x000000300) >> 8]
-	puts [format "w: %d" $w]
-	puts [format "Arm PLL Clk: %d (MHz)" [expr ($CFG_REFCLKFREQ * $y / (($w + 1) * ($x + 1) * 2))/1000000]]
+	echo [format "w: %d" $w]
+	echo [format "Arm PLL Clk: %d (MHz)" [expr ($CFG_REFCLKFREQ * $y / (($w + 1) * ($x + 1) * 2))/1000000]]
     }
 }
 
@@ -228,10 +228,10 @@ proc setupArmClk {} {
     set x    [config x_arm]
     set y    [config y_arm]
 
-    puts [format "Setting Arm PLL to lock to %d MHz" [expr $CFG_ARM_CLOCK/1000000]]
-    #puts [format "setupArmClk: w= %d" $w]
-    #puts [format "setupArmaClk: x= %d" $x]
-    #puts [format "setupArmaClk: y= %d" $y]
+    echo [format "Setting Arm PLL to lock to %d MHz" [expr $CFG_ARM_CLOCK/1000000]]
+    #echo [format "setupArmClk: w= %d" $w]
+    #echo [format "setupArmaClk: x= %d" $x]
+    #echo [format "setupArmaClk: y= %d" $y]
     # set PLL into BYPASS mode using MUX
     mmw $CLKCORE_ARM_CLK_CNTRL $PLL_CLK_BYPASS 0x0
     # do an internal PLL bypass
@@ -250,7 +250,7 @@ proc setupArmClk {} {
     mmw $CLKCORE_ARM_CLK_CNTRL 0x0 0xFFFFFF
     mmw $CLKCORE_ARM_CLK_CNTRL [expr (($x << 16) + ($w << 8) + $y)] 0x0
     # wait for PLL to lock
-    puts "Wating for Amba PLL to lock"
+    echo "Wating for Amba PLL to lock"
     while {[expr [mrw $CLKCORE_PLL_STATUS] & $FCLK_PLL_LOCK] == 0} { sleep 1 }
     # remove the internal PLL bypass
     mmw $CLKCORE_ARM_CLK_CNTRL 0x0 $ARM_PLL_BY_CTRL
@@ -261,14 +261,14 @@ proc setupArmClk {} {
 
 
 proc setupPLL {} {
-    puts "PLLs setup"
+    echo "PLLs setup"
     setupAmbaClk
     setupArmClk
 }
 
 # converted from u-boot/cpu/arm1136/bsp100.c:SoC_mem_init()
 proc setupDDR2 {} {
-    puts "Configuring DDR2"
+    echo "Configuring DDR2"
 
     set MEMORY_BASE_ADDR	    [regs  MEMORY_BASE_ADDR]
     set MEMORY_MAX_ADDR	            [regs  MEMORY_MAX_ADDR]
@@ -289,13 +289,13 @@ proc setupDDR2 {} {
     # ooma_board_detect returns DDR2 memory size
     set tmp [ooma_board_detect]
     if {$tmp == "128M"} {
-	puts "DDR2 size 128MB"
+	echo "DDR2 size 128MB"
 	set ddr_size $DDR_SZ_128M
     } elseif {$tmp == "256M"} {
-	puts "DDR2 size 256MB"
+	echo "DDR2 size 256MB"
 	set ddr_size $DDR_SZ_256M
     } else {
-	puts "Don't know how to handle this DDR2 size?"
+	echo "Don't know how to handle this DDR2 size?"
     }
 
     # Memory setup register
@@ -313,7 +313,7 @@ proc setupDDR2 {} {
     } elseif {$tmp == "256M"} {
 	configureDDR2regs_256M
     } else {
-	puts "Don't know how to configure DDR2 setup?"
+	echo "Don't know how to configure DDR2 setup?"
     }
 }
 
@@ -344,47 +344,47 @@ proc showDDR2 {} {
     set DENALI_CTL_20_DATA    [regs DENALI_CTL_20_DATA]
 
     set tmp [mr64bit $DENALI_CTL_00_DATA]
-    puts [format "DENALI_CTL_00_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_00_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_00_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_00_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_01_DATA]
-    puts [format "DENALI_CTL_01_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_01_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_01_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_01_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_02_DATA]
-    puts [format "DENALI_CTL_02_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_02_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_02_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_02_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_03_DATA]
-    puts [format "DENALI_CTL_03_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_03_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_03_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_03_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_04_DATA]
-    puts [format "DENALI_CTL_04_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_04_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_04_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_04_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_05_DATA]
-    puts [format "DENALI_CTL_05_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_05_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_05_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_05_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_06_DATA]
-    puts [format "DENALI_CTL_06_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_06_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_06_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_06_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_07_DATA]
-    puts [format "DENALI_CTL_07_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_07_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_07_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_07_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_08_DATA]
-    puts [format "DENALI_CTL_08_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_08_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_08_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_08_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_09_DATA]
-    puts [format "DENALI_CTL_09_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_09_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_09_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_09_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_10_DATA]
-    puts [format "DENALI_CTL_10_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_10_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_10_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_10_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_11_DATA]
-    puts [format "DENALI_CTL_11_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_11_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_11_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_11_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_12_DATA]
-    puts [format "DENALI_CTL_12_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_12_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_12_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_12_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_13_DATA]
-    puts [format "DENALI_CTL_13_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_13_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_13_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_13_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_14_DATA]
-    puts [format "DENALI_CTL_14_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_14_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_14_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_14_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_15_DATA]
-    puts [format "DENALI_CTL_15_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_15_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_15_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_15_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_16_DATA]
-    puts [format "DENALI_CTL_16_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_16_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_16_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_16_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_17_DATA]
-    puts [format "DENALI_CTL_17_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_17_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_17_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_17_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_18_DATA]
-    puts [format "DENALI_CTL_18_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_18_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_18_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_18_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_19_DATA]
-    puts [format "DENALI_CTL_19_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_19_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_19_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_19_DATA $tmp(1) $tmp(0)]
     set tmp [mr64bit $DENALI_CTL_20_DATA]
-    puts [format "DENALI_CTL_20_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_20_DATA $tmp(1) $tmp(0)]
+    echo [format "DENALI_CTL_20_DATA   (0x%x): 0x%08x%08x" $DENALI_CTL_20_DATA $tmp(1) $tmp(0)]
 
 }
 
@@ -462,7 +462,7 @@ proc initC100 {} {
     # DDR2 memory init
     setupDDR2
     putsUART0 "C100 initialization complete.\n"
-    puts "C100 initialization complete."
+    echo "C100 initialization complete."
 }
 
 # show current state of watchdog timer
@@ -471,9 +471,9 @@ proc showWatchdog {} {
     set TIMER_WDT_CONTROL	[regs TIMER_WDT_CONTROL]
     set TIMER_WDT_CURRENT_COUNT	[regs TIMER_WDT_CURRENT_COUNT]
 
-    puts [format "TIMER_WDT_HIGH_BOUND    (0x%x): 0x%x" $TIMER_WDT_HIGH_BOUND [mrw $TIMER_WDT_HIGH_BOUND]]
-    puts [format "TIMER_WDT_CONTROL       (0x%x): 0x%x" $TIMER_WDT_CONTROL [mrw $TIMER_WDT_CONTROL]]
-    puts [format "TIMER_WDT_CURRENT_COUNT (0x%x): 0x%x" $TIMER_WDT_CURRENT_COUNT [mrw $TIMER_WDT_CURRENT_COUNT]]
+    echo [format "TIMER_WDT_HIGH_BOUND    (0x%x): 0x%x" $TIMER_WDT_HIGH_BOUND [mrw $TIMER_WDT_HIGH_BOUND]]
+    echo [format "TIMER_WDT_CONTROL       (0x%x): 0x%x" $TIMER_WDT_CONTROL [mrw $TIMER_WDT_CONTROL]]
+    echo [format "TIMER_WDT_CURRENT_COUNT (0x%x): 0x%x" $TIMER_WDT_CURRENT_COUNT [mrw $TIMER_WDT_CURRENT_COUNT]]
 }
 
 # converted from u-boot/cpu/arm1136/comcerto/intrrupts.c:void reset_cpu (ulong ignored)
@@ -490,17 +490,17 @@ proc reboot {} {
     # I don't want to miss the high_bound==curr_count condition
     mww $TIMER_WDT_HIGH_BOUND  0xffffff
     mww $TIMER_WDT_CURRENT_COUNT 0x0
-    puts "JTAG speed lowered to 100kHz"
+    echo "JTAG speed lowered to 100kHz"
     adapter_khz 100
     mww $TIMER_WDT_CONTROL 0x1
     # wait until the reset
-    puts -nonewline "Wating for watchdog to trigger..."
+    echo -n "Wating for watchdog to trigger..."
     #while {[mrw $TIMER_WDT_CONTROL] == 1} {
-    #    puts [format "TIMER_WDT_CURRENT_COUNT (0x%x): 0x%x" $TIMER_WDT_CURRENT_COUNT [mrw $TIMER_WDT_CURRENT_COUNT]]
+    #    echo [format "TIMER_WDT_CURRENT_COUNT (0x%x): 0x%x" $TIMER_WDT_CURRENT_COUNT [mrw $TIMER_WDT_CURRENT_COUNT]]
     #    sleep 1
     #
     #}
     while {[c100.cpu curstate] != "running"} { sleep 1}
-    puts "done."
-    puts [format "Note that C100 is in %s state, type halt to stop" [c100.cpu curstate]]
+    echo "done."
+    echo [format "Note that C100 is in %s state, type halt to stop" [c100.cpu curstate]]
 }
diff --git a/tcl/target/c100regs.tcl b/tcl/target/c100regs.tcl
index 56f0771..a2c7a60 100644
--- a/tcl/target/c100regs.tcl
+++ b/tcl/target/c100regs.tcl
@@ -11,7 +11,7 @@ proc regs {reg} {
 }
 
 proc showreg {reg} {
-    puts [format "0x%x" [dict get [regsC100] $reg ]]
+    echo [format "0x%x" [dict get [regsC100] $reg ]]
 }
 
 proc regsC100 {} {
diff --git a/tcl/target/imx31.cfg b/tcl/target/imx31.cfg
index 3af6383..b9eddd0 100644
--- a/tcl/target/imx31.cfg
+++ b/tcl/target/imx31.cfg
@@ -60,8 +60,8 @@ set _TARGETNAME $_CHIPNAME.cpu
 target create $_TARGETNAME arm11 -endian $_ENDIAN -chain-position $_TARGETNAME
 
 
-proc power_restore {} { puts "Sensed power restore. No action." }
-proc srst_deasserted {} { puts "Sensed nSRST deasserted. No action." }
+proc power_restore {} { echo "Sensed power restore. No action." }
+proc srst_deasserted {} { echo "Sensed nSRST deasserted. No action." }
 
 # trace setup ... NOTE, "normal full" mode fudges the real ETMv3.1 mode
 etm config $_TARGETNAME 16 normal full etb
diff --git a/tcl/target/imx35.cfg b/tcl/target/imx35.cfg
index 30cb386..8a6aa87 100644
--- a/tcl/target/imx35.cfg
+++ b/tcl/target/imx35.cfg
@@ -47,8 +47,8 @@ jtag newtap $_CHIPNAME smda -irlen 5 -ircapture 0x1 -irmask 0x1f -expected-id $_
 set _TARGETNAME $_CHIPNAME.cpu
 target create $_TARGETNAME arm11 -endian $_ENDIAN -chain-position $_TARGETNAME
 
-proc power_restore {} { puts "Sensed power restore. No action." }
-proc srst_deasserted {} { puts "Sensed nSRST deasserted. No action." }
+proc power_restore {} { echo "Sensed power restore. No action." }
+proc srst_deasserted {} { echo "Sensed nSRST deasserted. No action." }
 
 # trace setup ... NOTE, "normal full" mode fudges the real ETMv3.1 mode
 etm config $_TARGETNAME 16 normal full etb
diff --git a/tcl/target/lpc3250.cfg b/tcl/target/lpc3250.cfg
index e902fb4..d64e15f 100644
--- a/tcl/target/lpc3250.cfg
+++ b/tcl/target/lpc3250.cfg
@@ -32,5 +32,5 @@ jtag newtap $_CHIPNAME cpu -irlen 4 -ircapture 0x1 -irmask 0xf -expected-id $_CP
 set _TARGETNAME $_CHIPNAME.cpu
 target create $_TARGETNAME arm926ejs -endian little -chain-position $_TARGETNAME -work-area-phys 0x00000000 -work-area-size 0x7d0000 -work-area-backup 0
 
-proc power_restore {} { puts "Sensed power restore. No action." }
-proc srst_deasserted {} { puts "Sensed nSRST deasserted. No action." }
+proc power_restore {} { echo "Sensed power restore. No action." }
+proc srst_deasserted {} { echo "Sensed nSRST deasserted. No action." }
diff --git a/tcl/test/selftest.cfg b/tcl/test/selftest.cfg
index 912d1c0..be420ca 100755
--- a/tcl/test/selftest.cfg
+++ b/tcl/test/selftest.cfg
@@ -8,7 +8,7 @@ proc selftest {tmpfile address size} {
    }
 
    for {set i 0} {$i < 10 } {set i [expr $i+1]} {
-    puts "Test iteration $i"
+    echo "Test iteration $i"
     dump_image $tmpfile $address $size
 	verify_image $tmpfile $address bin
 	load_image $tmpfile $address bin

commit 4747af362de04b508c91df4004d2aed5579c8a1c
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Mon Nov 8 15:13:28 2010 +0800

    JIM: document "echo" command
    
    Document "-n" option in manual;
    Modify "echo" command definition as COMMAND_HANDLER to
    easily add help message
    Add help message aligned with manual.
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 5387082..f946bdf 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -5446,9 +5446,10 @@ file (which is normally the server's standard output).
 @xref{Running}.
 @end deffn
 
- at deffn Command echo message
+ at deffn Command echo [-n] message
 Logs a message at "user" priority.
 Output @var{message} to stdout.
+Option "-n" suppresses trailing newline.
 @example
 echo "Downloading kernel -- please wait"
 @end example
diff --git a/src/helper/command.c b/src/helper/command.c
index 6c408ee..af1d66f 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -777,19 +777,16 @@ static int jim_find(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 	return JIM_OK;
 }
 
-static int jim_echo(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
+COMMAND_HANDLER(jim_echo)
 {
-	const char *str;
-	str = Jim_GetString(argv[1], NULL);
-	if (argc == 3 && !strcmp(str, "-n"))
+	if (CMD_ARGC == 2 && !strcmp(CMD_ARGV[0], "-n"))
 	{
-		str = Jim_GetString(argv[2], NULL);
-		LOG_USER_N("%s", str);
+		LOG_USER_N("%s", CMD_ARGV[1]);
 		return JIM_OK;
 	}
-	if (argc != 2)
+	if (CMD_ARGC != 1)
 		return JIM_ERR;
-	LOG_USER("%s", str);
+	LOG_USER("%s", CMD_ARGV[0]);
 	return JIM_OK;
 }
 
@@ -1262,6 +1259,15 @@ static const struct command_registration command_subcommand_handlers[] = {
 
 static const struct command_registration command_builtin_handlers[] = {
 	{
+		.name = "echo",
+		.handler = jim_echo,
+		.mode = COMMAND_ANY,
+		.help = "Logs a message at \"user\" priority. "
+			"Output message to stdout. "
+			"Option \"-n\" suppresses trailing newline",
+		.usage = "[-n] string",
+	},
+	{
 		.name = "add_help_text",
 		.handler = handle_help_add_command,
 		.mode = COMMAND_ANY,
@@ -1364,7 +1370,6 @@ struct command_context* command_init(const char *startup_tcl, Jim_Interp *interp
 			Jim_NewStringObj(interp, HostOs , strlen(HostOs)));
 
 	Jim_CreateCommand(interp, "ocd_find", jim_find, NULL, NULL);
-	Jim_CreateCommand(interp, "echo", jim_echo, NULL, NULL);
 	Jim_CreateCommand(interp, "capture", jim_capture, NULL, NULL);
 
 	register_commands(context, NULL, command_builtin_handlers);

commit d220e22e6376fa67d85c9731a4165f86609390d8
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Mon Nov 8 12:08:56 2010 +0800

    JIM: Add "-n" option to "echo"
    
    With the new JIMTCL, "puts" only writes to stdout.
    To write on telnet port too, "echo" must be used.
    This patch gives to "echo" similar commandline option of "puts".
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/helper/command.c b/src/helper/command.c
index 5a68208..6c408ee 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -779,9 +779,16 @@ static int jim_find(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 
 static int jim_echo(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 {
+	const char *str;
+	str = Jim_GetString(argv[1], NULL);
+	if (argc == 3 && !strcmp(str, "-n"))
+	{
+		str = Jim_GetString(argv[2], NULL);
+		LOG_USER_N("%s", str);
+		return JIM_OK;
+	}
 	if (argc != 2)
 		return JIM_ERR;
-	const char *str = Jim_GetString(argv[1], NULL);
 	LOG_USER("%s", str);
 	return JIM_OK;
 }

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi                    |    3 +-
 src/helper/command.c                |   22 +++-
 src/jtag/startup.tcl                |    8 +-
 tcl/bitsbytes.tcl                   |    2 +-
 tcl/board/at91eb40a.cfg             |    2 +-
 tcl/board/dm355evm.cfg              |    2 +-
 tcl/board/dm6446evm.cfg             |    2 +-
 tcl/board/ethernut3.cfg             |   10 +-
 tcl/board/lubbock.cfg               |    2 +-
 tcl/board/olimex_sam9_l9260.cfg     |    8 +-
 tcl/board/telo.cfg                  |   12 +-
 tcl/board/zy1000.cfg                |    8 +-
 tcl/chip/atmel/at91/aic.tcl         |   24 ++--
 tcl/chip/atmel/at91/rtt.tcl         |   18 ++--
 tcl/chip/atmel/at91/usarts.tcl      |   16 ++--
 tcl/chip/st/spear/quirk_no_srst.tcl |    4 +-
 tcl/chip/st/spear/spear3xx_ddr.tcl  |    4 +-
 tcl/mmr_helpers.tcl                 |   16 ++--
 tcl/target/aduc702x.cfg             |    2 +-
 tcl/target/c100config.tcl           |   26 ++--
 tcl/target/c100helper.tcl           |  220 +++++++++++++++++-----------------
 tcl/target/c100regs.tcl             |    2 +-
 tcl/target/imx31.cfg                |    4 +-
 tcl/target/imx35.cfg                |    4 +-
 tcl/target/lpc3250.cfg              |    4 +-
 tcl/test/selftest.cfg               |    2 +-
 26 files changed, 220 insertions(+), 207 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Thu Nov 11 08:09:49 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Thu, 11 Nov 2010 07:09:49 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-585-gaa4c140
Message-ID: <E1PGRI7-0002bk-3Z@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  aa4c140a1214f2b75e43d8d3580a5d06083f46a2 (commit)
       via  6c04f1e440be1451b1d7599910e377b90b7dc569 (commit)
      from  e7b2958229c7e0d7e98e130764aa50d1ca9017d3 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit aa4c140a1214f2b75e43d8d3580a5d06083f46a2
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Tue Nov 9 09:14:21 2010 +0100

    cortex_m3: report detected error condition in poll
    
    If the CPU crashed at some point, poll will discover this.
    
    Previously the poll fn would clear the error and print a warning,
    rather than propagating the error.
    
    The new behavior is to report the error back up, but still
    clear the error.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index 3f080f1..f2947ad 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -520,7 +520,8 @@ static int cortex_m3_debug_entry(struct target *target)
 
 static int cortex_m3_poll(struct target *target)
 {
-	int retval;
+	int detected_failure = ERROR_OK;
+	int retval = ERROR_OK;
 	enum target_state prev_target_state = target->state;
 	struct cortex_m3_common *cortex_m3 = target_to_cm3(target);
 	struct adiv5_dap *swjdp = &cortex_m3->armv7m.dap;
@@ -535,15 +536,18 @@ static int cortex_m3_poll(struct target *target)
 
 	/* Recover from lockup.  See ARMv7-M architecture spec,
 	 * section B1.5.15 "Unrecoverable exception cases".
-	 *
-	 * REVISIT Is there a better way to report and handle this?
 	 */
 	if (cortex_m3->dcb_dhcsr & S_LOCKUP) {
-		LOG_WARNING("%s -- clearing lockup after double fault",
+		LOG_ERROR("%s -- clearing lockup after double fault",
 				target_name(target));
 		cortex_m3_write_debug_halt_mask(target, C_HALT, 0);
 		target->debug_reason = DBG_REASON_DBGRQ;
 
+		/* We have to execute the rest (the "finally" equivalent, but
+		 * still throw this exception again).
+		 */
+		detected_failure = ERROR_FAIL;
+
 		/* refresh status bits */
 		retval = mem_ap_read_atomic_u32(swjdp, DCB_DHCSR, &cortex_m3->dcb_dhcsr);
 		if (retval != ERROR_OK)
@@ -610,11 +614,14 @@ static int cortex_m3_poll(struct target *target)
 		if (cortex_m3->dcb_dhcsr & S_RETIRE_ST)
 		{
 			target->state = TARGET_RUNNING;
-			return ERROR_OK;
+			retval = ERROR_OK;
 		}
 	}
 
-	return ERROR_OK;
+	/* Did we detect a failure condition that we cleared? */
+	if (detected_failure != ERROR_OK)
+		retval = detected_failure;
+	return retval;
 }
 
 static int cortex_m3_halt(struct target *target)

commit 6c04f1e440be1451b1d7599910e377b90b7dc569
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Tue Nov 9 09:17:49 2010 +0100

    target: document that target_poll() will report and clear sticky errors
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/target.h b/src/target/target.h
index 4a48e5a..ef05e75 100644
--- a/src/target/target.h
+++ b/src/target/target.h
@@ -257,6 +257,18 @@ int target_unregister_event_callback(
 		int (*callback)(struct target *target,
 				enum target_event event, void *priv),
 		void *priv);
+/* Poll the status of the target, detect any error conditions and report them.
+ *
+ * Also note that this fn will clear such error conditions, so a subsequent
+ * invocation will then succeed.
+ *
+ * These error conditions can be "sticky" error conditions. E.g. writing
+ * to memory could be implemented as an open loop and if memory writes
+ * fails, then a note is made of it, the error is sticky, but the memory
+ * write loop still runs to completion. This improves performance in the
+ * normal case as there is no need to verify that every single write succeed,
+ * yet it is possible to detect error condtions.
+ */
 int target_poll(struct target *target);
 int target_resume(struct target *target, int current, uint32_t address,
 		int handle_breakpoints, int debug_execution);

-----------------------------------------------------------------------

Summary of changes:
 src/target/cortex_m3.c |   19 +++++++++++++------
 src/target/target.h    |   12 ++++++++++++
 2 files changed, 25 insertions(+), 6 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Thu Nov 11 08:52:10 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Thu, 11 Nov 2010 07:52:10 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-586-gc62fb3f
Message-ID: <E1PGRx6-00077n-57@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  c62fb3fa81efa46f073db46a7eb7f2a91b16909a (commit)
      from  aa4c140a1214f2b75e43d8d3580a5d06083f46a2 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit c62fb3fa81efa46f073db46a7eb7f2a91b16909a
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Thu Nov 11 08:50:22 2010 +0100

    gdb: improve error message when gdb connect fails
    
    gdb connect can fail when the flash has not been probed.
    
    During gdb connect, the flash layout is reported, but this
    can not be automatically detected for a target that is
    powered up and OpenOCD supports connecting to gdb server
    even if the target is powered down.
    
    The solution is to turn of the gdb_memory_map feature.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index 222af47..9503a13 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -861,7 +861,7 @@ static int gdb_new_connection(struct connection *connection)
 			retval = get_flash_bank_by_num(i, &p);
 			if (retval != ERROR_OK)
 			{
-				LOG_ERROR("Connect failed. Consider setting up a gdb-attach event for the target to prepare target for GDB connect.");
+				LOG_ERROR("Connect failed. Consider setting up a gdb-attach event for the target to prepare target for GDB connect, or use 'gdb_memory_map disable'.");
 				return retval;
 			}
 		}

-----------------------------------------------------------------------

Summary of changes:
 src/server/gdb_server.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Nov 15 09:16:18 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 15 Nov 2010 08:16:18 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-587-g6287c23
Message-ID: <E1PHuEe-0003Ak-Kk@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  6287c23b326cdebf20283b5c4eb8da4fae3eb821 (commit)
      from  c62fb3fa81efa46f073db46a7eb7f2a91b16909a (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 6287c23b326cdebf20283b5c4eb8da4fae3eb821
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sat Nov 13 13:03:29 2010 +0100

    gdb: fix occasional crash when flash probe failed
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index 9503a13..77142df 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -833,9 +833,6 @@ static int gdb_new_connection(struct connection *connection)
 	breakpoint_clear_target(gdb_service->target);
 	watchpoint_clear_target(gdb_service->target);
 
-	/* register callback to be informed about target events */
-	target_register_event_callback(gdb_target_callback_event_handler, connection);
-
 	/* remove the initial ACK from the incoming buffer */
 	if ((retval = gdb_get_char(connection, &initial_ack)) != ERROR_OK)
 		return retval;
@@ -873,6 +870,13 @@ static int gdb_new_connection(struct connection *connection)
 		  target_name(gdb_service->target),
 		  target_state_name(gdb_service->target));
 
+	/* DANGER! If we fail subsequently, we must remove this handler,
+	 * otherwise we occasionally see crashes as the timer can invoke the
+	 * callback fn.
+	 *
+	 * register callback to be informed about target events */
+	target_register_event_callback(gdb_target_callback_event_handler, connection);
+
 	return ERROR_OK;
 }
 

-----------------------------------------------------------------------

Summary of changes:
 src/server/gdb_server.c |   10 +++++++---
 1 files changed, 7 insertions(+), 3 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Nov 15 09:17:29 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 15 Nov 2010 08:17:29 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-588-g015bf55
Message-ID: <E1PHuFm-0002GF-UK@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  015bf559444edd9e7c524e951aad183fdaab9156 (commit)
      from  6287c23b326cdebf20283b5c4eb8da4fae3eb821 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 015bf559444edd9e7c524e951aad183fdaab9156
Author: Freddie Chopin <freddie_chopin at op.pl>
Date:   Sat Nov 13 15:42:00 2010 +0100

    Add comments and tiny improvements to STM32 flash loader algorithm
    
    Add comments to assembly flash loader for STM32. Add tiny improvement in
    size of the algorithm (40 vs 48 bytes) and tiny speed improvement (~1.5%,
    as time is wasted on waiting for end of operation anyway).
    
    Signed-off-by: Freddie Chopin <freddie_chopin at op.pl>

diff --git a/contrib/loaders/flash/stm32x.s b/contrib/loaders/flash/stm32x.s
index dcf2b83..6cf9f57 100644
--- a/contrib/loaders/flash/stm32x.s
+++ b/contrib/loaders/flash/stm32x.s
@@ -19,7 +19,10 @@
  ***************************************************************************/
 
 	.text
-	.arm
+	.syntax unified
+	.thumb
+	.thumb_func
+	.global write
 
 /*
 	r0 - source address
@@ -27,26 +30,27 @@
 	r2 - count (halfword-16bit)
 	r3 - result
 	r4 - temp
-	r5 - temp
 */
 
+#define STM32_FLASH_CR_OFFSET	0x10			/* offset of CR register in FLASH struct */
+#define STM32_FLASH_SR_OFFSET	0x0c			/* offset of CR register in FLASH struct */
+
 write:
-	ldr		r4, STM32_FLASH_CR
-	ldr		r5, STM32_FLASH_SR
-	mov		r3, #1
-	str		r3, [r4, #0]
-	ldrh 	r3, [r0], #2
-	strh 	r3, [r1], #2
+	ldr		r4, STM32_FLASH_BASE
+write_half_word:
+	movs	r3, #0x01
+	str		r3, [r4, #STM32_FLASH_CR_OFFSET]	/* PG (bit0) == 1 => flash programming enabled */
+	ldrh 	r3, [r0], #0x02						/* read one half-word from src, increment ptr */
+	strh 	r3, [r1], #0x02						/* write one half-word from src, increment ptr */
 busy:
-	ldr 	r3, [r5, #0]
-	tst 	r3, #0x01
-	beq 	busy
-	tst		r3, #0x14
-	bne		exit
-	subs	r2, r2, #1
-	bne		write
+	ldr 	r3, [r4, #STM32_FLASH_SR_OFFSET]
+	tst 	r3, #0x01							/* BSY (bit0) == 1 => operation in progress */
+	beq 	busy								/* wait more... */
+	tst		r3, #0x14							/* PGERR (bit2) == 1 or WRPRTERR (bit4) == 1 => error */
+	bne		exit								/* fail... */
+	subs	r2, r2, #0x01						/* decrement counter */
+	bne		write_half_word						/* write next half-word if anything left */
 exit:
-	bkpt	#0
+	bkpt	#0x00
 
-STM32_FLASH_CR: .word 0x40022010
-STM32_FLASH_SR:	.word 0x4002200C
+STM32_FLASH_BASE: .word 0x40022000				/* base address of FLASH struct */
diff --git a/src/flash/nor/stm32x.c b/src/flash/nor/stm32x.c
index 6b46afc..7779ea3 100644
--- a/src/flash/nor/stm32x.c
+++ b/src/flash/nor/stm32x.c
@@ -503,25 +503,26 @@ static int stm32x_write_block(struct flash_bank *bank, uint8_t *buffer,
 	/* see contib/loaders/flash/stm32x.s for src */
 
 	static const uint8_t stm32x_flash_write_code[] = {
+									/* #define STM32_FLASH_CR_OFFSET	0x10 */
+									/* #define STM32_FLASH_SR_OFFSET	0x0C */
 									/* write: */
-		0xDF, 0xF8, 0x24, 0x40,		/* ldr	r4, STM32_FLASH_CR */
-		0x09, 0x4D,					/* ldr	r5, STM32_FLASH_SR */
-		0x4F, 0xF0, 0x01, 0x03,		/* mov	r3, #1 */
-		0x23, 0x60,					/* str	r3, [r4, #0] */
-		0x30, 0xF8, 0x02, 0x3B,		/* ldrh r3, [r0], #2 */
-		0x21, 0xF8, 0x02, 0x3B,		/* strh r3, [r1], #2 */
+		0xdf, 0xf8, 0x20, 0x40,		/* ldr	r4, STM32_FLASH_BASE */
+									/* write_half_word: */
+		0x01, 0x23,					/* movs	r3, #0x01 */
+		0x23, 0x61,					/* str	r3, [r4, #STM32_FLASH_CR_OFFSET] */
+		0x30, 0xf8, 0x02, 0x3b,		/* ldrh	r3, [r0], #0x02 */
+		0x21, 0xf8, 0x02, 0x3b,		/* strh	r3, [r1], #0x02 */
 									/* busy: */
-		0x2B, 0x68,					/* ldr 	r3, [r5, #0] */
-		0x13, 0xF0, 0x01, 0x0F,		/* tst 	r3, #0x01 */
-		0xFB, 0xD0,					/* beq 	busy */
-		0x13, 0xF0, 0x14, 0x0F,		/* tst	r3, #0x14 */
-		0x01, 0xD1,					/* bne	exit */
-		0x01, 0x3A,					/* subs	r2, r2, #1 */
-		0xED, 0xD1,					/* bne	write */
+		0xe3, 0x68,					/* ldr	r3, [r4, #STM32_FLASH_SR_OFFSET] */
+		0x13, 0xf0, 0x01, 0x0f,		/* tst	r3, #0x01 */
+		0xfb, 0xd0,					/* beq	busy */
+		0x13, 0xf0, 0x14, 0x0f,		/* tst	r3, #0x14 */
+		0x01, 0xd1,					/* bne	exit */
+		0x01, 0x3a,					/* subs	r2, r2, #0x01 */
+		0xf0, 0xd1,					/* bne	write_half_word */
 									/* exit: */
-		0x00, 0xBE,     			/* bkpt #0 */
-		0x10, 0x20, 0x02, 0x40,		/* STM32_FLASH_CR:	.word 0x40022010 */
-		0x0C, 0x20, 0x02, 0x40		/* STM32_FLASH_SR:	.word 0x4002200C */
+		0x00, 0xbe,					/* bkpt	#0x00 */
+		0x00, 0x20, 0x02, 0x40,		/* STM32_FLASH_BASE: .word 0x40022000 */
 	};
 
 	/* flash write code */

-----------------------------------------------------------------------

Summary of changes:
 contrib/loaders/flash/stm32x.s |   40 ++++++++++++++++++++++------------------
 src/flash/nor/stm32x.c         |   33 +++++++++++++++++----------------
 2 files changed, 39 insertions(+), 34 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Nov 15 09:19:04 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 15 Nov 2010 08:19:04 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-589-gfdae512
Message-ID: <E1PHuHK-0008D4-2l@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  fdae51287cf55a039f3401ed92151dbf518e4e7f (commit)
      from  015bf559444edd9e7c524e951aad183fdaab9156 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit fdae51287cf55a039f3401ed92151dbf518e4e7f
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Thu Nov 11 08:15:49 2010 +0100

    httpd: retire this server
    
    this never panned out and there are enough mistakes in
    the code that probably nobody used this.
    
    Use the tcl server and implement a standalone http
    app instead works fine.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/README b/README
index a683476..fd0bd33 100644
--- a/README
+++ b/README
@@ -255,8 +255,6 @@ options may be available there:
 
   --enable-ioutil         Enable ioutil functions - useful for standalone
                           OpenOCD implementations
-  --enable-httpd          Enable builtin httpd server - useful for standalone
-                          OpenOCD implementations
 
   --disable-doxygen-html Disable building Doxygen manual as HTML.
   --enable-doxygen-pdf   Enable building Doxygen manual as PDF.
diff --git a/configure.in b/configure.in
index a15b80a..70dddb9 100644
--- a/configure.in
+++ b/configure.in
@@ -420,10 +420,6 @@ AC_ARG_ENABLE(ioutil,
   AS_HELP_STRING([--enable-ioutil], [Enable ioutil functions - useful for standalone OpenOCD implementations]),
   [build_ioutil=$enableval], [build_ioutil=no])
 
-AC_ARG_ENABLE(httpd,
-  AS_HELP_STRING([--enable-httpd], [Enable builtin httpd server - useful for standalone OpenOCD implementations]),
-  [build_httpd=$enableval], [build_httpd=no])
-
 case "${host_cpu}" in
   arm*)
     AC_ARG_ENABLE(ep93xx,
@@ -1039,7 +1035,6 @@ AM_CONDITIONAL(ECOSBOARD, test $build_ecosboard = yes)
 AM_CONDITIONAL(ZY1000, test $build_zy1000 = yes)
 AM_CONDITIONAL(ZY1000_MASTER, test $build_zy1000_master = yes)
 AM_CONDITIONAL(IOUTIL, test $build_ioutil = yes)
-AM_CONDITIONAL(HTTPD, test $build_httpd = yes)
 AM_CONDITIONAL(AT91RM9200, test $build_at91rm9200 = yes)
 AM_CONDITIONAL(BITBANG, test $build_bitbang = yes)
 AM_CONDITIONAL(FT2232_LIBFTDI, test $build_ft2232_libftdi = yes)
diff --git a/doc/manual/server.txt b/doc/manual/server.txt
index f75f1d1..f6a0670 100644
--- a/doc/manual/server.txt
+++ b/doc/manual/server.txt
@@ -309,17 +309,3 @@ This section needs to be expanded.
 
  */
 
-/** @page serverhttp OpenOCD HTTP Server API
-
-
-Smoketest:
-
-configure --enable-httpd --enable-dummy --enable-ioutil
-
-openocd -s /usr/local/share/openocd -f httpd/httpd.tcl -f interface/dummy.cfg -f target/lpc2148.cfg
-
-Navigate to: http://localhost:8888/
-
-
-
- */
diff --git a/src/Makefile.am b/src/Makefile.am
index b54161c..19a0ba9 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -101,10 +101,6 @@ libopenocd_la_LIBADD = \
 	$(top_builddir)/src/helper/libhelper.la \
 	$(FTDI2232LIB) $(MINGWLDADD) $(LIBUSB)
 
-if HTTPD
-libopenocd_la_LIBADD += -lmicrohttpd
-endif
-
 STARTUP_TCL_SRCS = \
 	$(srcdir)/helper/startup.tcl \
 	$(srcdir)/jtag/startup.tcl \
diff --git a/src/openocd.c b/src/openocd.c
index 7347cad..5ce01e8 100644
--- a/src/openocd.c
+++ b/src/openocd.c
@@ -42,7 +42,6 @@
 
 #include <server/server.h>
 #include <server/gdb_server.h>
-#include <server/httpd.h>
 
 #ifdef HAVE_STRINGS_H
 #include <strings.h>
@@ -337,9 +336,6 @@ int openocd_main(int argc, char *argv[])
 	if (ret != ERROR_OK)
 		return EXIT_FAILURE;
 
-	if (httpd_start(cmd_ctx) != ERROR_OK)
-		return EXIT_FAILURE;
-
 	ret = server_init(cmd_ctx);
 	if (ERROR_OK != ret)
 		return EXIT_FAILURE;
@@ -357,8 +353,6 @@ int openocd_main(int argc, char *argv[])
 
 	server_quit();
 
-	httpd_stop();
-
 	unregister_all_commands(cmd_ctx, NULL);
 
 	/* free commandline interface */
diff --git a/src/server/Makefile.am b/src/server/Makefile.am
index c6c946f..ac24ebb 100644
--- a/src/server/Makefile.am
+++ b/src/server/Makefile.am
@@ -8,15 +8,9 @@ noinst_LTLIBRARIES = libserver.la
 noinst_HEADERS = server.h telnet_server.h gdb_server.h
 libserver_la_SOURCES = server.c telnet_server.c gdb_server.c
 
-if HTTPD
-libserver_la_SOURCES += httpd.c
-else
-libserver_la_SOURCES += httpd_stubs.c
 if !ECOSBOARD
 libserver_la_SOURCES += server_stubs.c
 endif
-endif
-noinst_HEADERS += httpd.h
 
 libserver_la_CFLAGS =
 if IS_MINGW
@@ -28,23 +22,7 @@ endif
 noinst_HEADERS += tcl_server.h
 libserver_la_SOURCES += tcl_server.c
 
-if HTTPD
-nobase_dist_pkgdata_DATA = \
-	$(wildcard \
-		$(srcdir)/httpd/*.tcl \
-		$(srcdir)/httpd/*.css \
-		$(srcdir)/httpd/menu_cuts/*.png \
-	)
-endif
-
 EXTRA_DIST = \
-	startup.tcl \
-	httpd/readme.txt \
-	httpd/menu.xml \
-	httpd/menu.xsl \
-	httpd/build.sh \
-	httpd/html2tcl.sh \
-	httpd/Stylizer.java \
-	httpd/Stylizer.class
+	startup.tcl
 
 MAINTAINERCLEANFILES = $(srcdir)/Makefile.in
diff --git a/src/server/httpd.c b/src/server/httpd.c
deleted file mode 100644
index af8c3c8..0000000
--- a/src/server/httpd.c
+++ /dev/null
@@ -1,506 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2007,2008,2009 ??yvind Harboe                            *
- *   oyvind.harboe at zylin.com                                               *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-
-/* some bits were copied from ahttpd which is under eCos license and
- * copyright to FSF
- */
-#ifdef HAVE_CONFIG_H
-#include "config.h"
-#endif
-
-#include "telnet_server.h"
-#include <target/target.h>
-
-#include <microhttpd.h>
-#include <pthread.h>
-#include <signal.h>
-
-#define PAGE_NOT_FOUND "<html><head><title > File not found</title></head><body > File not found</body></html>"
-
-static pthread_mutex_t mutex;
-
-void openocd_sleep_prelude(void)
-{
-	pthread_mutex_unlock(&mutex);
-}
-
-void openocd_sleep_postlude(void)
-{
-	pthread_mutex_lock(&mutex);
-}
-
-
-
-int loadFile(const char *name, void **data, size_t *len);
-
-static const char *appendf(const char *prev, const char *format, ...)
-{
-	va_list ap;
-	va_start(ap, format);
-	char *string = alloc_vprintf(format, ap);
-	va_end(ap);
-	char *string2 = NULL;
-
-	if (string != NULL)
-	{
-		string2 = alloc_printf("%s%s", (prev == NULL) ? "" : prev, string);
-	}
-
-	if (prev != NULL)
-	{
-		free((void *)prev);
-	}
-
-	if (string == NULL)
-		free(string);
-
-	return string2;
-}
-
-static const char *httpd_exec_cgi_tcl_error(Jim_Interp *interp)
-{
-	int len, i;
-
-	const char *t = NULL;
-	t = appendf(t, "<html><body>\n");
-
-	t = appendf(t, "Runtime error, file \"%s\", line %d:<br>",
-			interp->errorFileName, interp->errorLine);
-	t = appendf(t, "    %s < br>", Jim_GetString(interp->result, NULL));
-	Jim_ListLength(interp, interp->stackTrace, &len);
-	for (i = 0; i < len; i += 3)
-	{
-		Jim_Obj *objPtr;
-		const char *proc, *file, *line;
-
-		Jim_ListIndex(interp, interp->stackTrace, i, &objPtr, JIM_NONE);
-		proc = Jim_GetString(objPtr, NULL);
-		Jim_ListIndex(interp, interp->stackTrace, i + 1, &objPtr, JIM_NONE);
-		file = Jim_GetString(objPtr, NULL);
-		Jim_ListIndex(interp, interp->stackTrace, i + 2, &objPtr, JIM_NONE);
-		line = Jim_GetString(objPtr, NULL);
-		t = appendf(t, "In procedure '%s' called at file \"%s\", line %s < br>",
-				proc, file, line);
-	}
-	t = appendf(t, "</html></body>\n");
-
-	return t;
-}
-
-static int httpd_Jim_Command_writeform(Jim_Interp *interp, int argc,
-		Jim_Obj * const *argv)
-{
-	if (argc != 3)
-	{
-		Jim_WrongNumArgs(interp, 1, argv, "method ?CMD_ARGV ...?");
-		return JIM_ERR;
-	}
-	char *name = (char*) Jim_GetString(argv[1], NULL);
-	char *file = (char*) Jim_GetString(argv[2], NULL);
-
-	// Find length
-	const char *data;
-	int actual;
-	int retcode;
-	const char *script = alloc_printf(
-			"set dummy_val $httppostdata(%s); set dummy_val",
-			name);
-
-	retcode = Jim_Eval_Named(interp, script, __FILE__, __LINE__);
-	free((void *) script);
-	if (retcode != JIM_OK)
-		return retcode;
-
-	data = Jim_GetString(Jim_GetResult(interp), &actual);
-
-	FILE *f = fopen(file, "wb");
-	if (NULL == f)
-	{
-		Jim_SetResultString(interp, "Could not create file", -1);
-		return JIM_ERR;
-	}
-
-	int result = fwrite(data, 1, actual, f);
-	fclose(f);
-
-	if (result != actual)
-	{
-		Jim_SetResultString(interp, "Could not write to file", -1);
-		return JIM_ERR;
-	}
-	return JIM_OK;
-}
-
-
-int
-httpd_Jim_Command_formfetch(Jim_Interp *interp,
-                                   int argc,
-                                   Jim_Obj *const *argv)
-{
-	if (argc != 2)
-	{
-		Jim_WrongNumArgs(interp, 1, argv, "method ?CMD_ARGV ...?");
-		return JIM_ERR;
-	}
-
-	char *name = (char*)Jim_GetString(argv[1], NULL);
-	const char *script = alloc_printf(
-		"set dummy_val $httppostdata(%s); set dummy_val",
-		name);
-	int retcode = Jim_Eval_Named(interp, script, __FILE__, __LINE__);
-
-	free((void *) script);
-	if (retcode != JIM_OK)
-		Jim_SetResult(interp, Jim_NewEmptyStringObj(interp));
-	else
-		Jim_SetResult(interp, Jim_GetResult(interp));
-
-	return JIM_OK;
-}
-
-struct httpd_request
-{
-	int post;
-	Jim_Interp *interp;
-	struct MHD_PostProcessor *postprocessor;
-
-	//Jim_Obj *dict;
-
-	int complete; /* did we receive the entire post ? */
-
-};
-
-static void request_completed(void *cls, struct MHD_Connection *connection,
-		void **con_cls, enum MHD_RequestTerminationCode toe)
-{
-	struct httpd_request *r = (struct httpd_request*) *con_cls;
-
-	if (NULL == r)
-		return;
-
-	if (r->postprocessor)
-	{
-		openocd_sleep_postlude();
-		MHD_destroy_post_processor(r->postprocessor);
-		openocd_sleep_prelude();
-	}
-
-	free(r);
-	*con_cls = NULL;
-}
-
-/* append to said key in dictionary */
-static void append_key(Jim_Interp *interp,
-		struct httpd_request *r, const char *key,
-		const char *data, size_t off, size_t size)
-{
-	Jim_Obj *keyObj = Jim_NewStringObj(interp, key, -1);
-	Jim_IncrRefCount(keyObj);
-	Jim_Obj *value = NULL;
-
-	Jim_Obj *dict = Jim_GetVariableStr(interp, "httppostdata", 0);
-
-	if (dict != NULL)
-	{
-		if (Jim_DictKey(interp, dict, keyObj, &value, 0) != JIM_OK)
-		{
-			 value = NULL;
-		}
-		else
-		{
-			Jim_IncrRefCount(value);
-		}
-	}
-
-	if (value == NULL)
-	{
-		value = Jim_NewStringObj(interp, "", -1);
-		Jim_IncrRefCount(value);
-
-	}
-
-	/* create a new object we append to and insert into this location */
-	Jim_Obj *newObj = Jim_NewStringObj(interp, "", -1);
-	Jim_IncrRefCount(newObj);
-	Jim_AppendObj(interp, newObj, value);
-	Jim_AppendString(interp, newObj, data, size);
-	/* uhh... use name here of dictionary */
-	dict = Jim_NewStringObj(interp, "httppostdata", -1);
-	Jim_IncrRefCount(dict);
-	Jim_SetDictKeysVector(interp, dict, &keyObj, 1, newObj);
-	Jim_DecrRefCount(interp, dict);
-	Jim_DecrRefCount(interp, value);
-	Jim_DecrRefCount(interp, newObj);
-	Jim_DecrRefCount(interp, keyObj);
-}
-
-/* append data to each key */
-static int iterate_post(void *con_cls, enum MHD_ValueKind kind,
-		const char *key, const char *filename, const char *content_type,
-		const char *transfer_encoding, const char *data, uint64_t off,
-		size_t size)
-{
-	struct httpd_request *r = (struct httpd_request*) con_cls;
-
-	append_key(r->interp, r, key, data, off, size);
-
-	return MHD_YES;
-}
-
-static int record_arg(void *cls, enum MHD_ValueKind kind, const char *key,
-		const char *value)
-{
-	struct httpd_request *r = (struct httpd_request*) cls;
-	append_key(r->interp, r, key, value, 0, strlen(value));
-	return MHD_YES;
-}
-
-
-static int handle_request(Jim_Interp *interp,
-		struct MHD_Connection * connection, const char * url)
-{
-	struct MHD_Response * response;
-
-	int ret;
-	const char *suffix;
-	suffix = strrchr(url, '.');
-	if ((suffix != NULL) && (strcmp(suffix, ".tcl") == 0))
-	{
-		printf("Run tcl %s\n", url);
-
-		int retcode;
-
-		const char *script = alloc_printf(
-				"global httpdata; source {%s}; set httpdata", url);
-		retcode = Jim_Eval_Named(interp, script, __FILE__, __LINE__);
-		free((void *) script);
-
-		if (retcode != JIM_OK)
-		{
-			printf("Tcl failed\n");
-			const char *t = httpd_exec_cgi_tcl_error(interp);
-			if (t == NULL)
-				return MHD_NO;
-
-			response = MHD_create_response_from_data(strlen(t), (void *) t,
-					MHD_YES, MHD_NO);
-			ret = MHD_queue_response(connection,
-					MHD_HTTP_INTERNAL_SERVER_ERROR, response);
-			MHD_destroy_response(response);
-			return ret;
-		}
-		else
-		{
-			LOG_DEBUG("Tcl OK");
-			/* FIX!!! how to handle mime types??? */
-			const char *result;
-			int reslen;
-			result = Jim_GetString(Jim_GetResult(interp), &reslen);
-
-			response = MHD_create_response_from_data(reslen, (void *) result,
-					MHD_NO, MHD_YES);
-			ret = MHD_queue_response(connection,
-					MHD_HTTP_INTERNAL_SERVER_ERROR, response);
-			MHD_destroy_response(response);
-			return ret;
-		}
-	}
-	else
-	{
-		void *data;
-		size_t len;
-
-		int retval = loadFile(url, &data, &len);
-		if (retval != ERROR_OK)
-		{
-			printf("Did not find %s\n", url);
-
-			response = MHD_create_response_from_data(strlen(PAGE_NOT_FOUND),
-					(void *) PAGE_NOT_FOUND, MHD_NO, MHD_NO);
-			ret = MHD_queue_response(connection, MHD_HTTP_NOT_FOUND, response);
-			MHD_destroy_response(response);
-			return ret;
-		}
-
-		LOG_DEBUG("Serving %s length=%zu", url, len);
-		/* serve file directly */
-		response = MHD_create_response_from_data(len, data, MHD_YES, MHD_NO);
-		/* Should we expose mimetype via tcl here or just let the browser
-		   guess?
-		MHD_add_response_header(response, "Content-Type", "image/png");
-		*/
-
-		ret = MHD_queue_response(connection, MHD_HTTP_OK, response);
-		MHD_destroy_response(response);
-
-		//free(data);
-		return ret;
-	}
-}
-
-static int ahc_echo_inner(void * cls, struct MHD_Connection * connection,
-		const char * url, const char * method, const char * version,
-		const char * upload_data, size_t * upload_data_size, void ** ptr)
-{
-	Jim_Interp *interp = (Jim_Interp *)cls;
-	int post = 0;
-
-	if (0 == strcmp(method, "POST"))
-	{
-		post = 1;
-	}
-	else if (0 == strcmp(method, "GET"))
-	{
-	}
-	else
-	{
-		return MHD_NO; /* unexpected method */
-	}
-
-	struct httpd_request *r;
-	if (*ptr == NULL)
-	{
-		/* The first time only the headers are valid,
-		 do not respond in the first round... */
-
-		*ptr = malloc(sizeof(struct httpd_request));
-		if (*ptr == NULL)
-			return MHD_NO;
-		memset(*ptr, 0, sizeof(struct httpd_request));
-
-		r = (struct httpd_request *) *ptr;
-		r->interp = interp;
-		r->post = post;
-		Jim_SetVariableStr(interp, "httppostdata", Jim_NewDictObj(interp, NULL, 0));
-
-		/* fill in url query strings in dictionary */
-		MHD_get_connection_values(connection, MHD_GET_ARGUMENT_KIND,
-				record_arg, r);
-
-		if (r->post)
-		{
-			r->postprocessor = MHD_create_post_processor(connection, 2048
-					* 1024, &iterate_post, r);
-		}
-
-		return MHD_YES;
-	}
-
-	r = (struct httpd_request *) *ptr;
-
-	if (r->post)
-	{
-		/* consume post data */
-		if (*upload_data_size)
-		{
-			MHD_post_process(r->postprocessor, upload_data, *upload_data_size);
-			*upload_data_size = 0;
-			return MHD_YES;
-		}
-		else
-		{
-		}
-	} else
-	{
-	}
-
-	/* hand over to request who will be using it. */
-	//	r->dict = NULL;
-
-
-	/* FIX!!!! we need more advanced handling of url's to avoid them
-	 * being subverted to evil purposes
-	 */
-
-	const char *httpd_dir = PKGDATADIR "/httpd";
-
-	if (*url=='/')
-	{
-		url++; /* skip '/' */
-	}
-	if (!*url)
-		url="index.tcl";
-
-	const char *file_name = alloc_printf("%s/%s", httpd_dir, url);
-	int result = handle_request(interp, connection, file_name);
-	free((void *)file_name);
-	return result;
-}
-
-
-static int ahc_echo(void * cls, struct MHD_Connection * connection,
-		const char * url, const char * method, const char * version,
-		const char * upload_data, size_t * upload_data_size, void ** ptr)
-{
-	int result;
-
-	openocd_sleep_postlude();
-
-	result = ahc_echo_inner(cls, connection, url, method, version, upload_data, upload_data_size, ptr);
-
-	openocd_sleep_prelude();
-
-	return result;
-}
-
-static struct MHD_Daemon * d;
-
-static const struct command_registration httpd_command_handlers[] = {
-	{
-		.name = "formfetch",
-		.jim_handler = httpd_Jim_Command_formfetch,
-		.mode = COMMAND_EXEC,
-		.usage = "parameter_name",
-		.help = "Reads a posted form value.",
-	},
-	{
-		.name = "writeform",
-		.jim_handler = httpd_Jim_Command_writeform,
-		.mode = COMMAND_EXEC,
-		.usage = "parameter_name filename",
-		.help = "Writes a form value to a file.",
-	},
-	COMMAND_REGISTRATION_DONE
-};
-
-int httpd_start(struct command_context *cmd_ctx)
-{
-	pthread_mutexattr_t attr;
-	pthread_mutexattr_init(&attr);
-	pthread_mutex_init(&mutex, &attr);
-
-	int port = 8888;
-	LOG_USER("Launching httpd server on port %d", port);
-	d = MHD_start_daemon(MHD_USE_SELECT_INTERNALLY, port, NULL, NULL,
-			&ahc_echo, cmd_ctx->interp,
-			MHD_OPTION_NOTIFY_COMPLETED, request_completed, NULL, /* Closure... what's that??? */
-			MHD_OPTION_END);
-	if (d == NULL)
-		return ERROR_FAIL;
-
-	return register_commands(cmd_ctx, NULL, httpd_command_handlers);
-}
-
-void httpd_stop(void)
-{
-	MHD_stop_daemon(d);
-	pthread_mutex_destroy(&mutex);
-}
-
diff --git a/src/server/httpd.h b/src/server/httpd.h
deleted file mode 100644
index 0502deb..0000000
--- a/src/server/httpd.h
+++ /dev/null
@@ -1,28 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2009 Zachary T Welch <zw at superlucidity.net>             *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-
-#ifndef OPENOCD_SERVER_HTTPD_H
-#define OPENOCD_SERVER_HTTPD_H
-
-struct command_context;
-
-int httpd_start(struct command_context *cmd_ctx);
-void httpd_stop(void);
-
-#endif // OPENOCD_SERVER_HTTPD_H
diff --git a/src/server/httpd/Stylizer.class b/src/server/httpd/Stylizer.class
deleted file mode 100755
index ffa08ce..0000000
Binary files a/src/server/httpd/Stylizer.class and /dev/null differ
diff --git a/src/server/httpd/Stylizer.java b/src/server/httpd/Stylizer.java
deleted file mode 100755
index 721e84c..0000000
--- a/src/server/httpd/Stylizer.java
+++ /dev/null
@@ -1,114 +0,0 @@
-import java.io.File;
-import java.io.FileOutputStream;
-import java.io.IOException;
-import java.io.OutputStream;
-
-import javax.xml.parsers.DocumentBuilder;
-import javax.xml.parsers.DocumentBuilderFactory;
-import javax.xml.parsers.ParserConfigurationException;
-import javax.xml.transform.Transformer;
-import javax.xml.transform.TransformerConfigurationException;
-import javax.xml.transform.TransformerException;
-import javax.xml.transform.TransformerFactory;
-import javax.xml.transform.dom.DOMSource;
-import javax.xml.transform.stream.StreamResult;
-import javax.xml.transform.stream.StreamSource;
-
-import org.apache.xpath.XPathAPI;
-import org.w3c.dom.Document;
-import org.w3c.dom.Node;
-import org.w3c.dom.NodeList;
-import org.xml.sax.SAXException;
-
-/** used to generate .tcl files from */
-public class Stylizer
-{
-	// Global value so it can be ref'd by the tree-adapter
-	static Document document;
-	public static void main(String argv[])
-	{
-		if (argv.length != 3)
-		{
-			System.err.println("Usage: java Stylizer stylesheet xmlfile outputdir");
-			System.exit(1);
-		}
-		DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
-		try
-		{
-			System.err.println("Starting conversion...");
-			
-			File stylesheet = new File(argv[0]);
-			File datafile = new File(argv[1]);
-			DocumentBuilder builder = factory.newDocumentBuilder();
-			document = builder.parse(datafile);
-			
-			NodeList list = XPathAPI.selectNodeList(document, "website/language/page");
-
-			for (int i=0; i<list.getLength(); i++)
-			{
-				Node node=list.item(i);
-				
-				// Use a Transformer for output
-				TransformerFactory tFactory = TransformerFactory.newInstance();
-				StreamSource stylesource = new StreamSource(stylesheet);
-				Transformer transformer = tFactory.newTransformer(stylesource);
-				
-				Node fileName = XPathAPI.selectSingleNode(node, "outfile/text()");
-				
-				System.err.println("Converting " + fileName.getNodeValue());
-				DOMSource source = new DOMSource(document);
-				
-				OutputStream output=new FileOutputStream(new File(argv[2], fileName.getNodeValue()));
-				
-				
-				try
-				{
-					StreamResult result = new StreamResult(output);
-					
-					transformer.setParameter("pagetogenerate", fileName.getNodeValue());
-					transformer.transform(source, result);
-				} 
-				finally
-				{
-					output.close();
-				}
-			}
-		} catch (TransformerConfigurationException tce)
-		{
-			// Error generated by the parser
-			System.out.println("\n** Transformer Factory error");
-			System.out.println("   " + tce.getMessage());
-			// Use the contained exception, if any
-			Throwable x = tce;
-			if (tce.getException() != null)
-				x = tce.getException();
-			x.printStackTrace();
-		} catch (TransformerException te)
-		{
-			// Error generated by the parser
-			System.out.println("\n** Transformation error");
-			System.out.println("   " + te.getMessage());
-			// Use the contained exception, if any
-			Throwable x = te;
-			if (te.getException() != null)
-				x = te.getException();
-			x.printStackTrace();
-		} catch (SAXException sxe)
-		{
-			// Error generated by this application
-			// (or a parser-initialization error)
-			Exception x = sxe;
-			if (sxe.getException() != null)
-				x = sxe.getException();
-			x.printStackTrace();
-		} catch (ParserConfigurationException pce)
-		{
-			// Parser with specified options can't be built
-			pce.printStackTrace();
-		} catch (IOException ioe)
-		{
-			// I/O error
-			ioe.printStackTrace();
-		}
-	} // main
-}
diff --git a/src/server/httpd/browsemem.tcl b/src/server/httpd/browsemem.tcl
deleted file mode 100644
index cef8408..0000000
--- a/src/server/httpd/browsemem.tcl
+++ /dev/null
@@ -1,454 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-
-
-		
-
-
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>OpenOCD debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-							OpenOCD
-						</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="browsemem.tcl" style="font-weight: bold;">Browse / Edit</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="downloadmem.tcl" style="">Download</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl" style="font-weight: bold;">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Browse / Edit Memory</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-
-
-			
-			}
-
-			
-			set form_address [formfetch form_address]
-			set form_length [formfetch form_length]
-			set form_type [formfetch form_type]
-			set form_action [formfetch form_action]
-			set form_value [formfetch form_value]
-			
-			if {[string compare $form_length ""]==0} {
-				set form_length 0
-			}  
-			if {$form_length<=0} {
-				set form_length 0x80
-			} 
-			if {$form_length>0x1000} {
-				set form_length 0x1000
-			} 
-			
-			if {[string compare $form_type ""]==0} {
-				set form_type mdw
-			}
-			
-			if {[string compare $form_type "mdw"]==0} {
-				set wordsize 4
-				set modify_cmd mww 
-			}
-			if {[string compare $form_type "mdh"]==0} {
-				set wordsize 2
-				set modify_cmd mwh 
-			}
-			if {[string compare $form_type "mdb"]==0} {
-				set wordsize 1
-				set modify_cmd mwb 
-			}
-			
-			
-			
-			
-			if {[string compare $form_address ""]!=0} {
-				if {[string compare $form_action "Previous"]==0} {
-					# Kludge! Work around problems parsing hex in Jim Tcl expressions
-					incr form_address ; set form_address [expr $form_address-1]
-					if {$form_address-$form_length>0} {
-						set form_address "0x[tohex [expr $form_address-$form_length]]"
-					} else {
-						set form_address "0x0"
-					}
-				}  
-				if {[string compare $form_action "Next"]==0} {
-					# Kludge! Work around problems parsing hex in Jim Tcl expressions
-					incr form_address ; set form_address [expr $form_address-1]
-					set form_address "0x[tohex [expr $form_address+$form_length]]"
-				}  
-				if {[string compare $form_action "Modify"]==0} {
-					append console [capture_catch "$modify_cmd $form_address $form_value"]
-				}  
-				if {[string compare $form_action "Fill"]==0} {
-					append console [capture_catch "$modify_cmd $form_address $form_value $form_length"]
-				}  
-			}
-			
-			
-			
-append buffer {
-			
-			<form action="browsemem.tcl" method="post"> 
-				<table>
-				<tr><td class="formtext">Address</td><td><input type="text" name="form_address" value="}
-append buffer $form_address
-append buffer {"></td></tr>
-				<tr><td class="formtext">Length</td><td><input type="text" name="form_length" value="}
-append buffer "0x[tohex $form_length]"
-append buffer {"></td></tr>
-				<tr><td class="formtext">Value</td><td><input type="text" name="form_value" value="}
-append buffer $form_value
-append buffer {"></td>
-					<td class="buttonspacesmall">&nbsp</td><td><input type="submit" name="form_action" value="Modify"></td>
-					<td class="buttonspacesmall">&nbsp</td><td><input type="submit" name="form_action" value="Fill"></td></tr>
-				<tr><td class="formtext">Type</td><td style="padding-top:1px;">
-				<select name="form_type">
-				  <option 
-				    }
-if {[string compare $form_type "mdb"]==0} { append buffer {selected="selected"} }  
-append buffer { value ="mdb">8 bit
-				  </option>
-				  <option 
-				   }
-if {[string compare $form_type "mdh"]==0} { append buffer {selected="selected"} }  
-append buffer { value ="mdh">16 bit
-				  </option>
-			  		<option
-					   }
-if {[string compare $form_type "mdw"]==0} { append buffer {selected="selected"} }  
-append buffer {value ="mdw">32 bit
-				  	</option>
-				</select>
-				
-				</td></tr>
-				</table>
-				<table>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-					<tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-				</table>
-			
-				<table><tr>
-					<td><input type="submit" name="form_action" value="Refresh"></td>
-					<td class="buttonspacesmall">&nbsp</td><td><input type="submit" name="form_action" value="Previous" ></td>
-					<td class="buttonspacesmall">&nbsp</td><td><input type="submit" name="form_action" value="Next" ></td>
-				</tr></table>
-				<br>
-				
-			</form>
-			<p>
-			<div class="fontbigger">Memory:</div><p>
-			<code style="white-space: nowrap; font-size:11px;font:courier new;">
-				}
-
-				if {[string compare $form_address ""]!=0} {
-					append console [encode [capture_catch halt]]
-					append buffer [encode [capture_catch "$form_type $form_address [expr $form_length]"]]
-				} 
-				
-append buffer {
-			</code>
-
-
-			
-
-			
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="browsemem.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://openocd.berlios.de/doc/openocd.pdf">OpenOCD Manual</a>
-<br/>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-				
-				<p>Browse and edit target memory.<br>
-				   Length is in bytes, maximum 4096 bytes.</p> 
-				<p>An error message is shown when trying to browse or edit memory which cases a CPU fault.</p>
-				<p>CPU will be halted if required.</p>
-				<p><b>Modify</b> - Will modify only one byte, half-word or word starting at Address.</p>
-				<p><b>Fill</b> - Will fill the specified region with the specified value.</p>
-				<p><b>Refresh</b> - Display the content of the specified memory area.</p>
-					
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/build.sh b/src/server/httpd/build.sh
deleted file mode 100755
index 8824deb..0000000
--- a/src/server/httpd/build.sh
+++ /dev/null
@@ -1,5 +0,0 @@
-set e
-java -classpath ../../../../zy1000/build/xalan.jar\;. Stylizer menu.xsl menu.xml .
-find . -regex ".*\.tcl" -type f -exec sh html2tcl.sh {} {} \;
-echo "Copy .tcl files to /usr/local/lib/openocd/httpd/"
-cp *.tcl /usr/local/lib/openocd/httpd/
\ No newline at end of file
diff --git a/src/server/httpd/downloadmem.tcl b/src/server/httpd/downloadmem.tcl
deleted file mode 100644
index e6127ae..0000000
--- a/src/server/httpd/downloadmem.tcl
+++ /dev/null
@@ -1,366 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-
-
-		
-
-
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>OpenOCD debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-							OpenOCD
-						</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="browsemem.tcl" style="">Browse / Edit</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="downloadmem.tcl" style="font-weight: bold;">Download</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl" style="font-weight: bold;">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Download Memory Range</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-			}
-
-				set form_address [formfetch form_address]
-				set form_length [formfetch form_length]
-				set form_action [formfetch form_action]
-			
-append buffer {			
-			<form action="downloadmem.tcl" method="post"> 
-				<table>
-				<tr><td class="formtext">Address</td><td><input type="text" name="form_address" value="}
-append buffer $form_address
-append buffer {"></td></tr>
-				<tr><td class="formtext">Length</td><td><input type="text" name="form_length" value="}
-append buffer $form_length
-append buffer {"></td></tr>
-				</td></tr>
-				</table>
-
-				<table>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-					<tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-				</table>
-			
-				<input type="submit" value="Download" name="form_action">
-				
-				
-			</form>
-			}
-
-				if {[string compare $form_action "Download"]==0} {
-					append console [encode [capture_catch "reset init"]]
-					append console [encode [capture_catch "dump_image /tmp/dump.bin $form_address $form_length"]]
-					
-append buffer {
-					<form action="../dump.bin" target="_blank"> 
-						<input type="submit" name="form_action" value="Save downloaded memory">
-					</form>
-					}
- 
-				}
-				
-			
-append buffer {
-
-
-			
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="downloadmem.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://openocd.berlios.de/doc/openocd.pdf">OpenOCD Manual</a>
-<br/>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-					
-				Download memory from target. <br>
-				<b>Note</b> that download memory can take
-				a long time(potentially minutes for megabytes at low JTAG clk speeds).
-				<p/>
-				Once the memory is downloaded a link is available on the page to download
-				the file to your PC.
-				
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-
-
-		
-
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/editconfigs.tcl b/src/server/httpd/editconfigs.tcl
deleted file mode 100644
index e27bc05..0000000
--- a/src/server/httpd/editconfigs.tcl
+++ /dev/null
@@ -1,462 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-		
-
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>Zylin ZY1000 JTAG debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-<img src="menu_cuts/logo_top.png" style="border:0px;"/>
-</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="index.tcl" style="">Target Status</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="preconfig.tcl" style="">Select Target Config</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="editconfigs.tcl" style="font-weight: bold;">Edit Configurations</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="reload.tcl" style="">Reload Config Scripts</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl" style="font-weight: bold;">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Edit Target Configurations</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-			<form action="editconfigs.tcl" method="post">
-			}
-
-				set form_edittext [formfetch form_edittext]
-				set form_action [formfetch form_action]
-				set form_filename [formfetch form_filename]
-				set form_selected [formfetch form_selected] 
-				
-				if {[string compare $form_action "Load"]==0} {
-					set form_filename $form_selected
-				}
-				
-				if {[string compare $form_action "Delete"]==0} {
-					capture_catch "rm /config/settings/$form_selected"
-				}
-				
-				if {[string compare $form_action "Save"]==0} {
-					save_var $form_filename [from_textarea $form_edittext] 
-					append buffer "Wrote file $form_filename<br>"
-				}
-			
-				set form_edittext ""
-				
-				# load original or script saved on disk.
-				if {[string compare $form_action "Show default"]==0} {
-					set form_edittext [load_file "/rom/$form_selected"]
-					set form_filename $form_selected
-				} else {
-				    set form_edittext [load_config $form_filename]
-				}
-			
-				set form_edittext_subst [to_textarea $form_edittext]
-			
-				
-				proc prepend { val list } {
-					set res ""				
-			        foreach value $list {
-			        	set t $val
-			        	append t $value
-			            lappend res $t
-			        }
-			        return $res
-				 }				
-				
-				set files [prepend target/ [ls /rom/target]]
-				set files [lunion $files [prepend event/ [ls /config/settings/event]]]
-				set files [lunion $files [prepend target/ [ls /config/settings/target]]]
-				set files [lsort $files]
-				
-				
-append buffer {
-				<table style="padding:0px;border-collapse:collapse;"><tr>
-					<td style="padding-top:1px;"><select name="form_selected">
-						}
-
-							set foundTarget 0
-							foreach i $files {
-								
-append buffer {
-							  		<option 
-							  		}
-
-								  		if {[string compare $form_filename $i]==0} { 
-											set foundTarget 1
-									  		append buffer {selected="selected"} 
-								  		}
-								  	
-append buffer {
-						  		value="}
-append buffer $i
-append buffer {">}
-append buffer $i
-append buffer {</option>
-								}
-
-							}
-							if {$foundTarget==0} {
-								
-append buffer {
-							  		<option selected="selected" value="">Select target config</option>
-								}
-
-							}
-						
-append buffer {
-					</select></td>
-					<td class="buttonspacesmall">&nbsp</td>
-					<td><input type="submit" value="Load" name="form_action"></td>
-					<td class="buttonspacesmall">&nbsp</td>
-					<td><input type="submit" value="Show default" name="form_action"></td>
-					<td class="buttonspacesmall">&nbsp</td>
-					<td><input type="submit" value="Delete" name="form_action"></td>
-				</tr></table>
-				<textarea  style="overflow:auto;"  rows="21" cols="65" name="form_edittext" wrap="off">}
-append buffer $form_edittext_subst
-append buffer {</textarea>
-				<table style="padding:0px;border-collapse:collapse;"><tr>
-				}
-
-					append buffer {<td class="formtext">File</td><td><input type="text" name="form_filename" } "\n"
-					append buffer "value=\"$form_filename\" ></td>\n"
-					append buffer {<td class="buttonspacesmall">&nbsp</td><td><input type="submit" value="Save" name="form_action"></td><br>} "\n"
-					append buffer {</tr></table>} "\n"
-				
-append buffer {
-			</form>			
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="editconfigs.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://www.zylin.com/zy1000/ZY1000_Quick_Start_Guide.pdf">Quick Start Manual</a>
-<br/>
-<a target="_blank" href="http://www.zylin.com/zy1000/openocd.pdf">OpenOCD Manual</a>
-<br/>
-<a target="_blank" href="http://www.zylin.com/zy1000_contact.html">Contact Zylin AS</a>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-				
-				<p>Here you can edit predefined target configurations, restore predefined configurations to
-				default state and create new target configurations.<p/>
-				<p>Typically when creating a new target configuration, you would take an existing
-				configuration that resembles the most your needs and modify it for your
-				purposes and save it under a different name.</p>
-				<p><b>Load</b> - Loads a configuration file into the editor.</p>
-				<p><b>Show default</b> - Loads the firmware included version of the
-				configuration file (if any), into the editor.<br>
-				<b>Note</b> that the editor content is not saved.</p>
-				<p><b>Delete</b> - Deletes a custom created configuration file.<br>
-				<b>Note</b> that firmware included configuration files can not be deleted.</p>
-				<p><b>Save</b> - Save the edited file under the a new or the same name.</p>
-				
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td/>
-<td>
-<img border="0" src="menu_cuts/logo_bottom.png"/>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-
-		
-
-
-
-		
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/editfile.tcl b/src/server/httpd/editfile.tcl
deleted file mode 100644
index 6a39326..0000000
--- a/src/server/httpd/editfile.tcl
+++ /dev/null
@@ -1,436 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-		
-		
-
-		
-		
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>Zylin ZY1000 JTAG debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-<img src="menu_cuts/logo_top.png" style="border:0px;"/>
-</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="zy1000.tcl" style="">Set IP Address</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="upgrade.tcl" style="">ZY1000 Firmware</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="editfile.tcl" style="font-weight: bold;">Edit File</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="support.tcl" style="">Support Request</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="log.tcl#tail" style="">View Tail of Log</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/openocd.tcl">OpenOCD</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/zy1000.tcl" style="font-weight: bold;">Setup ZY1000</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Edit File</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-}
-
-			
-
-#Read a text file, edit it and write it back. Useful for interactive debugging
-#of tcl scripts
-
-set data ""
-append buffer {<form action="editfile.tcl" method="post">} "\n"
-
-set err "";
-
-set form_edittext [formfetch form_edittext];
-set form_action [formfetch form_action];
-set form_filename [formfetch form_filename];
-
-puts Action $form_action
-
-if {[string compare $form_action "Load"]==0} {
-
-	set form_edittext ""
-	catch {
-		set fp [aio.open $form_filename r];
-		set form_edittext [$fp read];
-		$fp close;
-	} err
-}
-if {[string compare $form_action "Delete"]==0} {
-	capture "rm $form_filename"
-}
-
-set form_edittext_subst [to_textarea $form_edittext]
-
-
-if {[string compare $form_action "Save"]==0} {
-	if {[catch {
-		set fp [aio.open $form_filename w];
-		$fp puts [from_textarea $form_edittext]
-		$fp close
-		append buffer "Wrote file $form_filename<br>"
-	} err]} {
-		append buffer "Could not write $form_filename<br>"
-	} 
-}
-
-
-
-
-append buffer {<table><tr><td class="formtext">File</td><td style="padding-top:1px;"><input type="text" name="form_filename" } "\n"
-append buffer "value=\"$form_filename\" ></td>\n"
-append buffer {<td class="buttonspacesmall">&nbsp</td><td><input type="submit" value="Load" name="form_action" ></td><td class="buttonspacesmall">&nbsp</td><td><input type="submit" value="Save" name="form_action"></td><td class="buttonspacesmall">&nbsp</td><td><input type="submit" value="Delete" name="form_action"></td>} "\n"
-append buffer {</tr></table>} "\n"
-append buffer {<br>}	
-
-append buffer {<textarea  style="overflow:auto;"  rows="18" cols="65" name="form_edittext" wrap="off">}
-append buffer $form_edittext_subst
-append buffer {</textarea><br>}
-
-append buffer {</html> } "\n"
-
-
-	
-append buffer {
-			
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="/ram/cgi/editfile.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://www.zylin.com/zy1000/ZY1000_Quick_Start_Guide.pdf">Quick Start Manual</a>
-<br/>
-<a target="_blank" href="http://www.zylin.com/zy1000/openocd.pdf">OpenOCD Manual</a>
-<br/>
-<a target="_blank" href="http://www.zylin.com/zy1000_contact.html">Contact Zylin AS</a>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-				
-				Edit any file on the ZY1000 by typing in the
-				filename and pressing Load.
-				</p>
-				<table style="line-height:17px;"><tr>
-					<td><a href="/ram" target="_blank">Browse files on /ram</a><br>
-					<a href="/config" target="_blank">Browse files on /config</a><br>
-					<a href="/rom" target="_blank">Browse files on /rom</a></td>
-				</tr></table>
-				
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td/>
-<td>
-<img border="0" src="menu_cuts/logo_bottom.png"/>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-
-		
-
-
-
-		
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/erase.tcl b/src/server/httpd/erase.tcl
deleted file mode 100644
index a63ef37..0000000
--- a/src/server/httpd/erase.tcl
+++ /dev/null
@@ -1,387 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-
-
-		
-
-
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>OpenOCD debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-							OpenOCD
-						</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="flashinfo.tcl" style="">Info</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="erase.tcl" style="font-weight: bold;">Erase</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="flash.tcl" style="">Program / Verify</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="production.tcl" style="">Production</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl" style="font-weight: bold;">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Erase Flash</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-
-
-			
-			}
-
-			
-			set form_address [formfetch form_address]
-			set form_length [formfetch form_length]
-			set form_action [formfetch form_action]
-			
-			if {[string compare $form_length ""]==0} {
-				set form_length 0x10000
-			}  
-			if {[string compare $form_address ""]==0} {
-				if {[catch {[first_flash_base]} result]==0} {
-						set form_address "0x[tohex $result]"
-					}			
-			}  
-			
-			
-			if {[string compare $form_address ""]!=0} {
-				if {[string compare $form_action "Erase"]==0} {
-						append buffer "<code style=\"white-space: nowrap;\">"
-						append console [encode [capture_catch {
-						reset init
-						flash erase_address $form_address $form_length}]]
-						append buffer </code>
-				}  
-			}
-			
-			
-			
-append buffer {
-			
-			<form action="erase.tcl" method="post"> 
-				<table>
-				<tr><td class="formtext" style="padding-right:10px;">Address</td><td><input type="text" name="form_address" value="}
-append buffer $form_address
-append buffer {"></td></tr>
-				<tr><td class="formtext">Length</td><td><input type="text" name="form_length" value="}
-append buffer $form_length
-append buffer {"></td></tr>
-				</td></tr>
-				</table>
-				<table>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-					<tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-				</table>
-			
-				<input type="submit" name="form_action" value="Erase"><br>
-				
-				
-			</form>
-			
-
-			
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="erase.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://openocd.berlios.de/doc/openocd.pdf">OpenOCD Manual</a>
-<br/>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-				
-				<p>Note that flash programming will erase flash if required.<p/>
-				<p>Reset and init CPU, then erase address range.</p>
-				<p>The length field is specified in number of bytes.</p>
-					
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/flash.tcl b/src/server/httpd/flash.tcl
deleted file mode 100644
index 3ad9772..0000000
--- a/src/server/httpd/flash.tcl
+++ /dev/null
@@ -1,459 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-
-
-		
-
-
-
-		
-		
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>OpenOCD debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-							OpenOCD
-						</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="flashinfo.tcl" style="">Info</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="erase.tcl" style="">Erase</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="flash.tcl" style="font-weight: bold;">Program / Verify</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="production.tcl" style="">Production</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl" style="font-weight: bold;">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Program / Verify Flash</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-			
-			}
-
-			
-			set form_offset [formfetch form_offset]
-			set form_action [formfetch form_action]
-			set form_type [formfetch form_type]
-			
-			
-			set post ""
-			catch {set post $post_data} err
-			
-			if {[string compare $form_offset ""]==0} {
-				set form_offset 0
-			}
-			if {[string compare $form_type ""]==0} {
-				set form_type ""
-			}
-			
-			
-append buffer {<code style="white-space: nowrap;">}
-
-			
-			set data ""
-			append buffer {<form enctype="multipart/form-data" action="flash.tcl" method="post">}
-			
-			set action_reset [expr {[string length $form_action]!=0}] 
-			set action_flash [expr {[string compare $form_action "Flash"]==0 || [string compare $form_action "Flash and verify"]==0}] 
-			set action_verify [expr {[string compare $form_action "Verify"]==0 || [string compare $form_action "Flash and verify"]==0}]
-			
-			if {$action_reset} {
-				append console [encode [capture_catch "reset init"]]
-			}
-			
-append buffer {
-			</code>}
-
-				
-			append buffer {<table>}
-			append buffer {<tr><td class="formtext">File</td><td><input type="file" name="form_filecontent"></td></tr>}
-			append buffer "<tr><td class=\"formtext\" >Offset</td><td><input type=\"text\" name=\"form_offset\" value=\"$form_offset\"></td></tr>"
-			
-			
-append buffer {
-			<tr><td class="formtext" style="padding-top:1px;">Type</td><td>
-			<select name="form_type">
-			  		<option
-			   }
-if {[string compare $form_type ""]==0} { append buffer {selected="selected"} }  
-append buffer {
-			  		value ="">auto</option>
-			  <option 
-			   }
-if {[string compare $form_type "elf"]==0} { append buffer {selected="selected"} }  
-append buffer {
-			  value ="elf">elf</option>
-			  <option 
-			   }
-if {[string compare $form_type "bin"]==0} { append buffer {selected="selected"} }  
-append buffer {
-			  value ="bin">binary</option>
-			  <option 
-			   }
-if {[string compare $form_type "ihex"]==0} { append buffer {selected="selected"} }  
-append buffer {
-			  value ="ihex">ihex</option>
-			  <!-- broken <option value ="s19">s19</option> -->
-			</select>
-			</td>
-			
-			</tr>
-			
-			
-			</table>
-			
-				<table>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-					<tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-				</table>
-			
-			<table><tr>
-				<td><input type="submit" name="form_action" value="Flash" ></td>
-				<td class="buttonspacesmall"></td><td><input type="submit" name="form_action" value="Flash and verify" ></td>
-				<td class="buttonspacesmall"></td><td><input type="submit" name="form_action" value="Verify" ></td>
-			</tr></table>
-		
-			<p>
-			}
-
-			
-			if {$action_flash||$action_verify} {
-				catch {writeform form_filecontent $upload_filename} result
-				append console [encode $result]
-			}
-			append buffer "<br>"
-			if {$action_flash} {
-				append console [encode [capture_catch "halt"]]
-				append buffer "<b>"
-				if {[catch {capture_catch {eval "flash write_image erase $upload_filename $form_offset $form_type"}} result]} {
-					append buffer "Flash write failed<br>"
-					append console [encode $result]
-				} else {
-					append buffer [encode $result]
-					append buffer "Flash write succeed<br>"
-				}
-				append buffer "</b>"
-			}
-			if {$action_verify} {
-				append console [encode [capture_catch "halt"]]
-				append buffer "<b>"
-				if {[catch {capture_catch {eval "verify_image $upload_filename $form_offset $form_type"}} result]} {
-					append buffer "Verify failed<br>"
-					append console [encode $result]
-				} else {
-					append buffer [encode $result]
-					append buffer "Verify succeed<br>"
-				}
-				append buffer "</b>"
-			}
-			
-append buffer {		
-				
-			</form>
-			
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="flash.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://openocd.berlios.de/doc/openocd.pdf">OpenOCD Manual</a>
-<br/>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-				
-				<p>Program and/or verify the flash on your target.</p>
-				<p><b>Flash</b> - Halt CPU, automatically erase flash if required and program flash with image.</p>
-				<p><b>Flash and verify</b> - Programs the flash and verifies the programmed flash content is correct.</p>
-				<p><b>Verify</b> - Halt CPU and verify image in flash or RAM.</p>
-				<p><b>Offset</b> - This value is added to the address of the image.<br> 
-					Binary images start at address 0 by default, whereas elf and ihex have addresses encoded into the image.<br> 
-					Typically 0 for elf/ihex and the address to	write the image to for binary files.</p>
-					 
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/flashinfo.tcl b/src/server/httpd/flashinfo.tcl
deleted file mode 100644
index 8e9f3e2..0000000
--- a/src/server/httpd/flashinfo.tcl
+++ /dev/null
@@ -1,382 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-
-
-		
-
-
-
-		
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>OpenOCD debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-							OpenOCD
-						</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="flashinfo.tcl" style="font-weight: bold;">Info</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="erase.tcl" style="">Erase</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="flash.tcl" style="">Program / Verify</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="production.tcl" style="">Production</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl" style="font-weight: bold;">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Flash Information</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-
-			<div style="font-size:14px;">Configured flash banks:</div>
-			<p>			
-			<code style="white-space: nowrap;">
-				}
-
-					set flash_return [ocd_flash_banks]
-					if {[llength $flash_return]!=0} {
-						append buffer [encode [flash banks]]
-					
-						set form_action [formfetch form_action]
-						if {[string compare $form_action "Reset CPU and probe flash"]==0} {
-							append console [encode [capture_catch "reset init"]]
-							append buffer [encode [capture_catch "flash probe 0"]]
-							append buffer [encode [capture_catch "flash info 0"]]
-						}
-					} else {
-						append buffer "No flash bank configured."
-					}
-				
-append buffer {
-				<p>
-				<form action="flashinfo.tcl" method="post"> 
-					<input type="submit" name="form_action" value="Reset CPU and probe flash">
-				</form>
-				}
-
-					foreach a [ocd_flash_banks] {
-						append buffer "Flash bank at [format "0x%08x size 0x%08x" $a(base) $a(size)]: "
-						
-append buffer {
-							<form action="downloadmem.tcl" method="post"> 
-								<input type="hidden" name="form_address" value="}
-append buffer [format "0x%08x" $a(base)]
-append buffer {">
-								<input type="hidden" name="form_length" value="}
-append buffer [format "0x%08x" $a(size)]
-append buffer {">
-		
-								<input type="submit" value="Download" name="form_action">
-								<br>
-							</form>
-						}
-
-					}
-				
-append buffer {
-			</code>
-			
-
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="flashinfo.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://openocd.berlios.de/doc/openocd.pdf">OpenOCD Manual</a>
-<br/>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-				
-				<p>Here you will find information about the flash chips that you have
-				in your configuration.<p/>
-				<p><b>Reset CPU and probe flash</b> - This will reset the CPU and show
-				you more detailed information about your flash. This includes information about
-				the different sectors in the flash, and the flash driver used.</p>
-				
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/guiupload.tcl b/src/server/httpd/guiupload.tcl
deleted file mode 100644
index 804bfe4..0000000
--- a/src/server/httpd/guiupload.tcl
+++ /dev/null
@@ -1,336 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-
-
-		
-
-
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>OpenOCD debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-							OpenOCD
-						</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="openocd.tcl" style="">Run Command</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="guiupload.tcl" style="font-weight: bold;">Upload File</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl" style="font-weight: bold;">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Upload File</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-			
-			}
-
-				set form_filename [formfetch form_filename];
-				set form_action [formfetch form_action];
-				#set form_filecontent [formfetch form_filecontent];
-				
-				append buffer {<form enctype="multipart/form-data" action="guiupload.tcl" method="post">}
-				append buffer <br> 
-				if {[string compare $form_action "Upload"]==0} {
-					if {[catch {writeform form_filecontent $form_filename} result]==0} {
-						append buffer [encode $result]
-					} else {
-						append buffer Wrote $form_filename
-					}
-				}
-				
-				append buffer {<table style="padding:0px;border-collapse:collapse;"><tr><td class="formtext">Filename on OpenOCD machine</td><td><input type="text" name="form_filename"></td></tr>}
-				append buffer {<td class="formtext">File to upload</td><td><input type="file" name="form_filecontent"></td></tr></table>}
-				append buffer {<table><tr><td style="height:15px;width:535px;">&nbsp</td></tr><tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr><tr><td style="height:15px;width:535px;">&nbsp</td></tr></table>}
-				append buffer {<input type="submit" name="form_action" value="Upload" ><br> }
-				append buffer {</form>}
-			
-			
-append buffer {
-			
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="guiupload.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://openocd.berlios.de/doc/openocd.pdf">OpenOCD Manual</a>
-<br/>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray"/>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</body>
-</html>
-		
-
-
-		
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/html2tcl.sh b/src/server/httpd/html2tcl.sh
deleted file mode 100755
index 3eb5c39..0000000
--- a/src/server/httpd/html2tcl.sh
+++ /dev/null
@@ -1,128 +0,0 @@
-#!/bin/bash
-# restart using a Tcl shell \
-	exec sh -c 'for tclshell in tclsh tclsh83 cygtclsh80 ; do \
-			( echo | $tclshell ) 2> /dev/null && exec $tclshell "`( cygpath -w \"$0\" ) 2> /dev/null || echo $0`" "$@" ; \
-		done ; \
-		echo "file2c.tcl: cannot find Tcl shell" ; exit 1' "$0" "$@"
-
-#===============================================================================
-#
-#    file2c.tcl
-#
-#    Convert a file into a header that can be #included from C.
-#
-#===============================================================================
-#####ECOSGPLCOPYRIGHTBEGIN####
-## -------------------------------------------
-## This file is part of eCos, the Embedded Configurable Operating System.
-## Copyright (C) 1998, 1999, 2000, 2001, 2002 Red Hat, Inc.
-##
-## eCos is free software; you can redistribute it and/or modify it under
-## the terms of the GNU General Public License as published by the Free
-## Software Foundation; either version 2 or (at your option) any later version.
-##
-## eCos is distributed in the hope that it will be useful, but WITHOUT ANY
-## WARRANTY; without even the implied warranty of MERCHANTABILITY or
-## FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
-## for more details.
-##
-## You should have received a copy of the GNU General Public License along
-## with eCos; if not, write to the Free Software Foundation, Inc.,
-## 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.
-##
-## As a special exception, if other files instantiate templates or use macros
-## or inline functions from this file, or you compile this file and link it
-## with other works to produce a work based on this file, this file does not
-## by itself cause the resulting work to be covered by the GNU General Public
-## License. However the source code for this file must still be made available
-## in accordance with section (3) of the GNU General Public License.
-##
-## This exception does not invalidate any other reasons why a work based on
-## this file might be covered by the GNU General Public License.
-##
-## Alternative licenses for eCos may be arranged by contacting Red Hat, Inc.
-## at http://sources.redhat.com/ecos/ecos-license/
-## -------------------------------------------
-#####ECOSGPLCOPYRIGHTEND####
-#===============================================================================
-######DESCRIPTIONBEGIN####
-#
-# Author(s):	jlarmour,bartv
-# Contact(s):	
-# Date:		2001-07-20
-# Purpose:      
-# Description:
-# Usage:        file2c.tcl <file to encode> <output C header file>
-#
-#####DESCRIPTIONEND####
-#===============================================================================
-
-if { $argc != 2 } {
-	puts "Usage: html2tcl.tcl <infile> <outfile>"
-	exit 1
-}
-set infile [lindex $argv 0]
-set outfile [lindex $argv 1]
-				
-set infilefd [open $infile "r"]
-set data [read $infilefd]
-close $infilefd
-
-
-
-
-if [string match *\.tcl $infile]==0 {
-	puts "Not .tcl file, skipping $infile"
-	exit 0
-}
-
-set outfilefd [ open $outfile "w" ]
-if [regexp -start 0 {^\s*<html.*} $data]==0 {
-	puts "copy $infile"
-	puts -nonewline $outfilefd $data
-	close $outfilefd
-	exit 0
-}
-
-puts "converting $infile"
-
-set result ""
-append result "# converted to .tcl by html2tcl.tcl\n"
-append result "set buffer \"\"\n"
-
-set pos 0
-set done 0
-while {$done==0} {
-	set start [string first <tcl> $data $pos]
-	if $start==-1 {
-		# We're done...
-		set done 1
-		set start [string length $data]
-		set end $start
-	} else {
-		set end [string first </tcl> $data $start]
-		if $end==-1 {
-			# uh-oh, not closed
-			puts "<tcl> not closed!"
-			exit 1
-		}
-	}
-	#puts "done $done start $start end $end"
-	# Dump HTML into resulting file.
-	append result "append buffer {"
-	append result [string range $data $pos [expr $start-1]]
-	#puts [string range $data $pos $start]
-	append result "}\n"
-	
-	# Dump TCL into resulting file.
-	append result "[string range $data [expr $start+5] [expr $end-1]]\n"
-	
-	set pos [expr $end+6]
-}
-
-append result "start_chunked \"html\"\n"
-append result {write_chunked $buffer} "\n"
-append result "end_chunked\n"
-
-puts $outfilefd $result
-close $outfilefd
diff --git a/src/server/httpd/httpd.tcl b/src/server/httpd/httpd.tcl
deleted file mode 100644
index dfa9e33..0000000
--- a/src/server/httpd/httpd.tcl
+++ /dev/null
@@ -1,100 +0,0 @@
-# some dummy proc's to get things going for test purposes
-
-
-
-proc ip {} {
-return 10.0.0.55
-}
-
-proc start_chunked {a} {
-	global httpdata
-	global httpmime
-	set httpmime $a
-	set httpdata ""
-}
-
-proc write_chunked {a} {
-	global httpdata
-	append httpdata $a
-}
-
-proc end_chunked {} {
-}
-
-
-
-#proc formfetch {a} {
-#	global httppostdata
-	#catch { 
-#	echo "$a=$httppostdata($a)"
-	#return $httppostdata($a) 
-	#}
-#	
-	#return ""  
-#}
-
-
-
-
-proc tohex {a} {
-   set r ""
-   while 1 {
-
-      set rem [expr $a%16]
-      set a [expr $a/16]
-      set r [string index "0123456789abcdef" $rem]$r
-      if ($a==0) then break
-   }  
-   return $r 
-}
-
-# encode text
-proc encode {a} {
-	return [string map {\n <br/> { } {&nbsp;} \t {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} > &gt; < &lt; / &#47;} $a]
-}
-
-#stubs that can be overriden to save between sessions
-proc load_var {a} {
-	global glob_var
-	catch {
-		return $glob_var($a)
-	}
-	return ""
-}
-#stubs that can be overriden to save between sessions
-proc save_var {a b} {
-	catch { 
-	set glob_var($a) $b
-	return ""
-	} err
-	set glob_var($a) ""
-	return ""
-}
-
-
-
-proc to_textarea {a} {
-	return [string map {& &#38; > &gt; < &lt; / &#47;} $a]
-}	
-
-proc from_textarea {a} {
-	return [string map {&gt; > &lt; < &#38; & &#47; /} $a]
-}
-	
-proc lunion {a b} {
-	foreach e $a {
-		set x($e) {}
-	}
- 	foreach e $b {
-		if {![info exists x($e)]} {
-    		lappend a $e
-		}
-	}
- 	return $a
-}
- 
-
-proc first_flash_base {} {
-	set t [lindex 0 [ocd_flash_banks]]
-	return $t(base)
-}
diff --git a/src/server/httpd/index.tcl b/src/server/httpd/index.tcl
deleted file mode 100644
index 35c5cc7..0000000
--- a/src/server/httpd/index.tcl
+++ /dev/null
@@ -1,376 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>OpenOCD debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-							OpenOCD
-						</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="index.tcl" style="font-weight: bold;">Target Status</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl" style="font-weight: bold;">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>OpenOCD debugger</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-
-			
-			<table>
-				<tr><td style="height:10px;width:535px;">&nbsp</td></tr>
-				<tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr>
-				<tr><td style="height:5px;width:535px;">&nbsp</td></tr>
-			</table>
-
-			<H1>Target Status</H1>
-
-			<table>
-				<tr>
-					<td class="fontbigger">
-						}
-
-							set form_address [formfetch form_address]
-							set form_action [formfetch form_action]
-							
-							if {[string compare $form_action "Halt"]==0} {
-								append console [encode [capture_catch "halt"]]
-							}
-							if {[string compare $form_action "Resume"]==0} {
-								append console [encode [capture_catch "resume"]]
-							}
-							  
-							if {[string compare $form_action "Reset and run"]==0} {
-								append console [encode [capture_catch "reset run"]]
-							}
-							
-							if {[string compare $form_action "Power on"]==0} {
-								append console [encode [capture_catch "power on"]]
-							}
-							if {[string compare $form_action "Power off"]==0} {
-								append console [encode [capture_catch "power off"]]
-							}
-						
-append buffer {
-					
-						}
-append console [encode [capture_catch poll]]
-append buffer {
-					</td>
-				</tr>
-			</table>
-
-			<form action="index.tcl" method="post"> 
-				<table><tr>
-					<td><input type="submit" name="form_action" value="Reset and run"></td>
-					<td class="buttonspacesmall"></td><td><input type="submit" name="form_action" value="Halt"></td>
-					<td class="buttonspacesmall"></td><td><input type="submit" name="form_action" value="Resume"></td>
-					<td style="width:50px;"></td><td><input type="submit" name="form_action" value="Power on"></td>
-					<td class="buttonspacesmall"></td><td><input type="submit" name="form_action" value="Power off"></td>
-				</tr></table>
-
-				<br>						
-				<br>						
-										
-				<p>
-			</form>
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="index.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://openocd.berlios.de/doc/openocd.pdf">OpenOCD Manual</a>
-<br/>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-				
-					<p>Target status shows that status of the connected target. </p> 
-					<p><b>Current target</b> - selected target configuration. <br>
-					<p><b>Startup</b> - whether or not the target script ran to completion. Note
-					that even if the target is disconnected, powered down or unresponsive, the
-					startup script will still run to completion. Startup - OK does not mean
-					that the target is fully operational, simply that the configuration script
-					did not contain syntax errors for instance. 
-					See log for details. <br>
-					<p><b>Target power</b> - Detects power on target. <br>
-					If the JTAG cable is not connected, or the target has no power, then no target power will be detected.</p>
-					<p>Type "help power" in telnet for command to control power relay.</p>
-				
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</body>
-</html>
-		
-		
-
-
-		
-
-
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/log.tcl b/src/server/httpd/log.tcl
deleted file mode 100644
index 703a06d..0000000
--- a/src/server/httpd/log.tcl
+++ /dev/null
@@ -1,343 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-
-
-		
-
-
-
-		
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>Zylin ZY1000 JTAG debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-<img src="menu_cuts/logo_top.png" style="border:0px;"/>
-</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="openocd.tcl" style="">Run Command</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="guiupload.tcl" style="">Upload File to ZY1000</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="log.tcl#tail" style="">View Tail of Log</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl" style="font-weight: bold;">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>View Tail of Log</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-			}
-
-				append buffer "<code style=\"white-space: nowrap;\">"
-				append buffer [encode [log]]
-				append buffer {<p><p><p><a name="tail"/>} 
-				append buffer {<a href="log.tcl}
-				append buffer "?rnd=[rand]"
-				append buffer {#tail">Refresh</a>} 
-				append buffer {<p>} 
-				append buffer "</code>";
-			
-append buffer {
-			
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="log.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://www.zylin.com/zy1000/ZY1000_Quick_Start_Guide.pdf">Quick Start Manual</a>
-<br/>
-<a target="_blank" href="http://www.zylin.com/zy1000/openocd.pdf">OpenOCD Manual</a>
-<br/>
-<a target="_blank" href="http://www.zylin.com/zy1000_contact.html">Contact Zylin AS</a>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray"/>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td/>
-<td>
-<img border="0" src="menu_cuts/logo_bottom.png"/>
-</td>
-</tr>
-</table>
-</body>
-</html>
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/menu.xml b/src/server/httpd/menu.xml
deleted file mode 100644
index be14464..0000000
--- a/src/server/httpd/menu.xml
+++ /dev/null
@@ -1,973 +0,0 @@
-<?xml version = "1.0" encoding="iso-8859-1" standalone="yes"?>
-<?xml-stylesheet type="text/xsl" href="plaintext.xsl"?>
-<website>
-
-	<language lang="Norsk">
-
-		<page lang="eng">
-			<outfile>index.tcl</outfile>
-			<menutext>Config Target</menutext>
-			<menulink>index.tcl</menulink>
-			<pageheading>OpenOCD debugger</pageheading>
-			<level2parent>index.tcl</level2parent>
-			<level2menu href="index.tcl" title="Target Status" titlestyle="color:#4e6627;">
-			</level2menu>
-			<!--
-			<level2menu href="terminal.tcl" title="UART forwarding" titlestyle="color:#4e6627;">
-			</level2menu>
-			 -->
-
-			<pagetext>
-			<markup_code><![CDATA[
-
-
-			<table>
-				<tr><td style="height:10px;width:535px;">&nbsp</td></tr>
-				<tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr>
-				<tr><td style="height:5px;width:535px;">&nbsp</td></tr>
-			</table>
-
-			<H1>Target Status</H1>
-
-			<table>
-				<tr>
-					<td class="fontbigger">
-						<tcl>
-							set form_address [formfetch form_address]
-							set form_action [formfetch form_action]
-
-							if {[string compare $form_action "Halt"]==0} {
-								append console [encode [capture_catch "halt"]]
-							}
-							if {[string compare $form_action "Resume"]==0} {
-								append console [encode [capture_catch "resume"]]
-							}
-
-							if {[string compare $form_action "Reset and run"]==0} {
-								append console [encode [capture_catch "reset run"]]
-							}
-
-							if {[string compare $form_action "Power on"]==0} {
-								append console [encode [capture_catch "power on"]]
-							}
-							if {[string compare $form_action "Power off"]==0} {
-								append console [encode [capture_catch "power off"]]
-							}
-						</tcl>
-
-						<tcl>append console [encode [capture_catch poll]]</tcl>
-					</td>
-				</tr>
-			</table>
-
-			<form action="index.tcl" method="post">
-				<table><tr>
-					<td><input type="submit" name="form_action" value="Reset and run"></td>
-					<td class="buttonspacesmall"></td><td><input type="submit" name="form_action" value="Halt"></td>
-					<td class="buttonspacesmall"></td><td><input type="submit" name="form_action" value="Resume"></td>
-					<td style="width:50px;"></td><td><input type="submit" name="form_action" value="Power on"></td>
-					<td class="buttonspacesmall"></td><td><input type="submit" name="form_action" value="Power off"></td>
-				</tr></table>
-
-				<br>
-				<br>
-
-				<p>
-			</form>
-			]]></markup_code>
-			<right_column>
-				<markup_code><![CDATA[
-					<p>Target status shows that status of the connected target. </p>
-					<p><b>Current target</b> - selected target configuration. <br>
-					<p><b>Startup</b> - whether or not the target script ran to completion. Note
-					that even if the target is disconnected, powered down or unresponsive, the
-					startup script will still run to completion. Startup - OK does not mean
-					that the target is fully operational, simply that the configuration script
-					did not contain syntax errors for instance.
-					See log for details. <br>
-					<p><b>Target power</b> - Detects power on target. <br>
-					If the JTAG cable is not connected, or the target has no power, then no target power will be detected.</p>
-					<p>Type "help power" in telnet for command to control power relay.</p>
-				]]></markup_code>
-			</right_column>
-
-			</pagetext>
-		</page>
-
-
-
-
-		<page lang="eng">
-			<outfile>targets.tcl</outfile>
-			<level2parent>documentation.tcl</level2parent>
-			<pageheading>Target config quick start guide</pageheading>
-			<pagetext>
-				<markup_code><![CDATA[
-
-				A target needs an openocd.cfg file. This config file sets up
-				the CPU, flash and reset init script. Either OpenOCD ships with an
-				openocd.cfg file for your target or you need to take an existing
-				config file and modify it for your needs.
-				<p>
-				The reset init script is crucial. It will set up e.g. MMU, chip
-				select registers, etc. after a reset. The init.cfg (reset init script)
-				is embedded into the openocd.cfg file in the sampls OpenOCD provides.
-				<p>
-				Writing an openocd.cfg from scratch is a non-trivial exercise, but
-				fortunally it only has to be done once for a target and afterwards it
-				rarely if ever needs to be changed.
-
-
-				]]></markup_code>
-				<right_column>
-
-					Quick start guide on how to configure a target.
-				</right_column>
-			</pagetext>
-
-
-		</page>
-
-
-
-
-		<page lang="eng">
-			<outfile>flashinfo.tcl</outfile>
-			<menutext>Flash</menutext>
-			<menulink>flashinfo.tcl</menulink>
-			<pageheading>Flash Information</pageheading>
-			<level2parent>flashinfo.tcl</level2parent>
-			<level2menu href="flashinfo.tcl" title="Info" titlestyle="color:#4e6627;">
-			</level2menu>
-			<level2menu href="erase.tcl" title="Erase" titlestyle="color:#4e6627;">
-			</level2menu>
-			<level2menu href="flash.tcl" title="Program / Verify" titlestyle="color:#4e6627;">
-			</level2menu>
-			<level2menu href="production.tcl" title="Production" titlestyle="color:#4e6627;">
-			</level2menu>
-
-			<pagetext>
-			<markup_code><![CDATA[
-
-			<div style="font-size:14px;">Configured flash banks:</div>
-			<p>
-			<code style="white-space: nowrap;">
-				<tcl>
-					set flash_return [ocd_flash_banks]
-					if {[llength $flash_return]!=0} {
-						append buffer [encode [flash banks]]
-
-						set form_action [formfetch form_action]
-						if {[string compare $form_action "Reset CPU and probe flash"]==0} {
-							append console [encode [capture_catch "reset init"]]
-							append buffer [encode [capture_catch "flash probe 0"]]
-							append buffer [encode [capture_catch "flash info 0"]]
-						}
-					} else {
-						append buffer "No flash bank configured."
-					}
-				</tcl>
-				<p>
-				<form action="flashinfo.tcl" method="post">
-					<input type="submit" name="form_action" value="Reset CPU and probe flash">
-				</form>
-				<tcl>
-					foreach a [ocd_flash_banks] {
-						append buffer "Flash bank at [format "0x%08x size 0x%08x" $a(base) $a(size)]: "
-						</tcl>
-							<form action="downloadmem.tcl" method="post">
-								<input type="hidden" name="form_address" value="<tcl>append buffer [format "0x%08x" $a(base)]</tcl>">
-								<input type="hidden" name="form_length" value="<tcl>append buffer [format "0x%08x" $a(size)]</tcl>">
-
-								<input type="submit" value="Download" name="form_action">
-								<br>
-							</form>
-						<tcl>
-					}
-				</tcl>
-			</code>
-
-
-			]]></markup_code>
-			<right_column>
-				<![CDATA[
-				<p>Here you will find information about the flash chips that you have
-				in your configuration.<p/>
-				<p><b>Reset CPU and probe flash</b> - This will reset the CPU and show
-				you more detailed information about your flash. This includes information about
-				the different sectors in the flash, and the flash driver used.</p>
-				]]>
-			</right_column>
-
-			</pagetext>
-		</page>
-
-		<page lang="eng">
-			<outfile>flash.tcl</outfile>
-			<level2parent>flashinfo.tcl</level2parent>
-			<pageheading>Program / Verify Flash</pageheading>
-			<pagetext>
-			<markup_code><![CDATA[
-
-			<tcl>
-
-			set form_offset [formfetch form_offset]
-			set form_action [formfetch form_action]
-			set form_type [formfetch form_type]
-
-
-			set post ""
-			catch {set post $post_data} err
-
-			if {[string compare $form_offset ""]==0} {
-				set form_offset 0
-			}
-			if {[string compare $form_type ""]==0} {
-				set form_type ""
-			}
-
-			</tcl><code style="white-space: nowrap;"><tcl>
-
-			set data ""
-			append buffer {<form enctype="multipart/form-data" action="flash.tcl" method="post">}
-
-			set action_reset [expr {[string length $form_action]!=0}]
-			set action_flash [expr {[string compare $form_action "Flash"]==0 || [string compare $form_action "Flash and verify"]==0}]
-			set action_verify [expr {[string compare $form_action "Verify"]==0 || [string compare $form_action "Flash and verify"]==0}]
-
-			if {$action_reset} {
-				append console [encode [capture_catch "reset init"]]
-			}
-			</tcl>
-			</code><tcl>
-
-			append buffer {<table>}
-			append buffer {<tr><td class="formtext">File</td><td><input type="file" name="form_filecontent"></td></tr>}
-			append buffer "<tr><td class=\"formtext\" >Offset</td><td><input type=\"text\" name=\"form_offset\" value=\"$form_offset\"></td></tr>"
-
-			</tcl>
-			<tr><td class="formtext" style="padding-top:1px;">Type</td><td>
-			<select name="form_type">
-				<option
-					<tcl>if {[string compare $form_type ""]==0} { append buffer {selected="selected"} } </tcl>
-					value ="">auto</option>
-				<option
-					<tcl>if {[string compare $form_type "elf"]==0} { append buffer {selected="selected"} } </tcl>
-					value ="elf">elf</option>
-				<option
-					<tcl>if {[string compare $form_type "bin"]==0} { append buffer {selected="selected"} } </tcl>
-					value ="bin">binary</option>
-				<option
-					<tcl>if {[string compare $form_type "ihex"]==0} { append buffer {selected="selected"} } </tcl>
-					value ="ihex">ihex</option>
-				<!-- broken <option value ="s19">s19</option> -->
-			</select>
-			</td>
-
-			</tr>
-
-
-			</table>
-
-				<table>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-					<tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-				</table>
-
-			<table><tr>
-				<td><input type="submit" name="form_action" value="Flash" ></td>
-				<td class="buttonspacesmall"></td><td><input type="submit" name="form_action" value="Flash and verify" ></td>
-				<td class="buttonspacesmall"></td><td><input type="submit" name="form_action" value="Verify" ></td>
-			</tr></table>
-
-			<p>
-			<tcl>
-
-			if {$action_flash||$action_verify} {
-				catch {writeform form_filecontent $upload_filename} result
-				append console [encode $result]
-			}
-			append buffer "<br>"
-			if {$action_flash} {
-				append console [encode [capture_catch "halt"]]
-				append buffer "<b>"
-				if {[catch {capture_catch {eval "flash write_image erase $upload_filename $form_offset $form_type"}} result]} {
-					append buffer "Flash write failed<br>"
-					append console [encode $result]
-				} else {
-					append buffer [encode $result]
-					append buffer "Flash write succeed<br>"
-				}
-				append buffer "</b>"
-			}
-			if {$action_verify} {
-				append console [encode [capture_catch "halt"]]
-				append buffer "<b>"
-				if {[catch {capture_catch {eval "verify_image $upload_filename $form_offset $form_type"}} result]} {
-					append buffer "Verify failed<br>"
-					append console [encode $result]
-				} else {
-					append buffer [encode $result]
-					append buffer "Verify succeed<br>"
-				}
-				append buffer "</b>"
-			}
-			</tcl>
-
-			</form>
-
-			]]></markup_code>
-
-			<right_column>
-				<![CDATA[
-				<p>Program and/or verify the flash on your target.</p>
-				<p><b>Flash</b> - Halt CPU, automatically erase flash if required and program flash with image.</p>
-				<p><b>Flash and verify</b> - Programs the flash and verifies the programmed flash content is correct.</p>
-				<p><b>Verify</b> - Halt CPU and verify image in flash or RAM.</p>
-				<p><b>Offset</b> - This value is added to the address of the image.<br>
-					Binary images start at address 0 by default, whereas elf and ihex have addresses encoded into the image.<br>
-					Typically 0 for elf/ihex and the address to	write the image to for binary files.</p>
-					]]>
-			</right_column>
-
-
-			</pagetext>
-
-		</page>
-
-
-
-
-		<page lang="eng">
-			<outfile>production.tcl</outfile>
-			<level2parent>flashinfo.tcl</level2parent>
-			<pageheading>Production</pageheading>
-			<pagetext>
-			<markup_code><![CDATA[
-			<tcl>
-				set form_action [formfetch form_action]
-				set form_serialnumber [formfetch form_serialnumber]
-				append buffer [production_info]
-			</tcl>
-
-			<form enctype="multipart/form-data" action="production.tcl" method="post">
-				<code style="white-space: nowrap;">
-					<tcl>
-						if {[string compare $form_action "Upload firmware"]==0} {
-							set wrotedata [catch {writeform form_filecontent $upload_filename} result]
-							append buffer [encode $result]
-							if {$wrotedata==0} {
-								append buffer "<br>Running production procedure<p>"
-								append buffer "<br>Reset and init: <br>"
-
-								append console [encode [capture_catch {catch "production $upload_filename $form_serialnumber"}]]
-							}
-						}
-						if {[string compare $form_action "Test"]==0} {
-							append buffer "<br>Running production test. Output from first 10 seconds printed below. <p>"
-
-							append console [encode [capture_catch {catch production_test}]]
-						}
-						if {[string compare $form_action "Power on"]==0} {
-							append console [encode [capture_catch "power on"]]
-						}
-						if {[string compare $form_action "Power off"]==0} {
-							append console [encode [capture_catch "power off"]]
-						}
-					</tcl>
-				</code>
-				<tcl>
-					append buffer {<p class="formtext">Firmware file(raw binary) <input type="file" name="form_filecontent"><p>}
-					append buffer {<p class="formtext">Serial number <input type="text" name="form_serialnumber"><p>}
-				</tcl>
-
-				<table>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-					<tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-				</table>
-
-				<table><tr>
-					<td><input type="submit" name="form_action" value="Upload firmware" ></td>
-					<td class="buttonspacesmall">&nbsp</td><td><input type="submit" name="form_action" value="Test"></td>
-					<td class="buttonspacesmall">&nbsp</td><td><input type="submit" name="form_action" value="Power on"></td>
-					<td class="buttonspacesmall">&nbsp</td><td><input type="submit" name="form_action" value="Power off">
-				</tr></table>
-			</form>
-
-			]]></markup_code>
-
-			<right_column>
-				<![CDATA[
-				The target script can implement the "production", "production_info" and "production_test" tcl proc's. These procedures
-				are used on this page. There are default implementations that do nothing.
-
-				<p><b>Upload firmware</b> - Power cycle target, reset target and program raw binary file to flash bank 0, offset 0 and verify flash programming. Leave target powered on.</p>
-				<p><b>Test</b> - Power up target, run 10 second target test. Output is provided via the DCC output channel. </p>
-				<p><b>Power on</b> - Power on target.</p>
-				<p><b>Power off</b> - Power off target.</p>
-				<p><b>Serial number</b> - A target script can use this string in the production procedure. Type "help production" for more info.</p>
-					]]>
-			</right_column>
-
-
-			</pagetext>
-
-		</page>
-
-
-
-		<page lang="eng">
-			<outfile>erase.tcl</outfile>
-			<menulink>erase.tcl</menulink>
-			<pageheading>Erase Flash</pageheading>
-			<level2parent>flashinfo.tcl</level2parent>
-			<pagetext>
-			<markup_code><![CDATA[
-
-
-
-			<tcl>
-
-			set form_address [formfetch form_address]
-			set form_length [formfetch form_length]
-			set form_action [formfetch form_action]
-
-			if {[string compare $form_length ""]==0} {
-				set form_length 0x10000
-			}
-			if {[string compare $form_address ""]==0} {
-				if {[catch {[first_flash_base]} result]==0} {
-						set form_address "0x[tohex $result]"
-					}
-			}
-
-
-			if {[string compare $form_address ""]!=0} {
-				if {[string compare $form_action "Erase"]==0} {
-						append buffer "<code style=\"white-space: nowrap;\">"
-						append console [encode [capture_catch {
-						reset init
-						flash erase_address $form_address $form_length}]]
-						append buffer </code>
-				}
-			}
-
-
-			</tcl>
-
-			<form action="erase.tcl" method="post">
-				<table>
-				<tr><td class="formtext" style="padding-right:10px;">Address</td><td><input type="text" name="form_address" value="<tcl>append buffer $form_address</tcl>"></td></tr>
-				<tr><td class="formtext">Length</td><td><input type="text" name="form_length" value="<tcl>append buffer $form_length</tcl>"></td></tr>
-				</td></tr>
-				</table>
-				<table>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-					<tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-				</table>
-
-				<input type="submit" name="form_action" value="Erase"><br>
-
-
-			</form>
-
-
-
-			]]></markup_code>
-			<right_column>
-				<![CDATA[
-				<p>Note that flash programming will erase flash if required.<p/>
-				<p>Reset and init CPU, then erase address range.</p>
-				<p>The length field is specified in number of bytes.</p>
-					]]>
-			</right_column>
-
-			</pagetext>
-		</page>
-
-
-		<page lang="eng">
-			<outfile>run.tcl</outfile>
-			<menulink>run.tcl</menulink>
-			<pageheading>Run program</pageheading>
-			<level2parent>flashinfo.tcl</level2parent>
-			<pagetext>
-			<markup_code><![CDATA[
-
-
-
-<tcl>
-
-set form_address [formfetch form_address]
-set form_action [formfetch form_action]
-
-if {[string compare $form_action "Run from address"]==0} {
-	append console [encode [capture_catch "halt"]]
-	append console [encode [capture_catch "wait_halt"]]
-	append console [encode [capture_catch "resume $form_address"]]
-}
-
-if {[string compare $form_action "Halt"]==0} {
-	append console [encode [capture_catch "halt"]]
-	append console [encode [capture_catch "wait_halt"]]
-}
-
-if {[string compare $form_action "Reset and run"]==0} {
-	append console [encode [capture_catch "reset run"]]
-}
-
-if {[string compare $form_action "Reset and init"]==0} {
-	append console [encode [capture_catch "reset init"]]
-}
-
-append console [encode [capture_catch poll]]
-
-</tcl>
-
-<form action="run.tcl" method="post">
-	<table>
-	<tr><td class="formtext" style="padding-right:10px;">Address</td><td><input type="text" name="form_address" value="<tcl>append buffer $form_address</tcl>"></td></tr>
-	</td></tr>
-	</table>
-	<table>
-		<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-		<tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr>
-		<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-	</table>
-
-	<input type="submit" name="form_action" value="Reset and run"> <input type="submit" name="form_action" value="Run from address"> <input type="submit" name="form_action" value="Halt"><input type="submit" name="form_action" value="Reset and init"><br>
-</form>
-
-
-
-			]]></markup_code>
-			<right_column>
-				<![CDATA[
-				<p>Reset and run - reset CPU and let it run.</p>
-				<p>Halt - halt CPU.</p>
-				<p>Run from address - halt CPU and resume from address. Default is resume from current address.</p>
-				<p>Reset and init - reset CPU and run init script.</p>
-				]]>
-			</right_column>
-
-			</pagetext>
-		</page>
-
-
-		<page lang="eng">
-			<outfile>browsemem.tcl</outfile>
-			<menutext>Memory</menutext>
-			<menulink>browsemem.tcl</menulink>
-			<pageheading>Browse / Edit Memory</pageheading>
-			<level2parent>browsemem.tcl</level2parent>
-			<level2menu href="browsemem.tcl" title="Browse / Edit" titlestyle="color:#4e6627;">
-			<![CDATA[
-				Browse and edit memory.
-			]]>
-			</level2menu>
-			<level2menu href="downloadmem.tcl" title="Download" titlestyle="color:#4e6627;">
-			<![CDATA[
-				Copy memory range to developer machine
-			]]>
-			</level2menu>
-
-			<pagetext>
-			<markup_code><![CDATA[
-
-
-
-			<tcl>
-
-			set form_address [formfetch form_address]
-			set form_length [formfetch form_length]
-			set form_type [formfetch form_type]
-			set form_action [formfetch form_action]
-			set form_value [formfetch form_value]
-
-			if {[string compare $form_length ""]==0} {
-				set form_length 0
-			}
-			if {$form_length<=0} {
-				set form_length 0x80
-			}
-			if {$form_length>0x1000} {
-				set form_length 0x1000
-			}
-
-			if {[string compare $form_type ""]==0} {
-				set form_type mdw
-			}
-
-			if {[string compare $form_type "mdw"]==0} {
-				set wordsize 4
-				set modify_cmd mww
-			}
-			if {[string compare $form_type "mdh"]==0} {
-				set wordsize 2
-				set modify_cmd mwh
-			}
-			if {[string compare $form_type "mdb"]==0} {
-				set wordsize 1
-				set modify_cmd mwb
-			}
-
-
-
-
-			if {[string compare $form_address ""]!=0} {
-				if {[string compare $form_action "Previous"]==0} {
-					# Kludge! Work around problems parsing hex in Jim Tcl expressions
-					incr form_address ; set form_address [expr $form_address-1]
-					if {$form_address-$form_length>0} {
-						set form_address "0x[tohex [expr $form_address-$form_length]]"
-					} else {
-						set form_address "0x0"
-					}
-				}
-				if {[string compare $form_action "Next"]==0} {
-					# Kludge! Work around problems parsing hex in Jim Tcl expressions
-					incr form_address ; set form_address [expr $form_address-1]
-					set form_address "0x[tohex [expr $form_address+$form_length]]"
-				}
-				if {[string compare $form_action "Modify"]==0} {
-					append console [capture_catch "$modify_cmd $form_address $form_value"]
-				}
-				if {[string compare $form_action "Fill"]==0} {
-					append console [capture_catch "$modify_cmd $form_address $form_value $form_length"]
-				}
-			}
-
-
-			</tcl>
-
-			<form action="browsemem.tcl" method="post">
-				<table>
-				<tr><td class="formtext">Address</td><td><input type="text" name="form_address" value="<tcl>append buffer $form_address</tcl>"></td></tr>
-				<tr><td class="formtext">Length</td><td><input type="text" name="form_length" value="<tcl>append buffer "0x[tohex $form_length]"</tcl>"></td></tr>
-				<tr><td class="formtext">Value</td><td><input type="text" name="form_value" value="<tcl>append buffer $form_value</tcl>"></td>
-					<td class="buttonspacesmall">&nbsp</td><td><input type="submit" name="form_action" value="Modify"></td>
-					<td class="buttonspacesmall">&nbsp</td><td><input type="submit" name="form_action" value="Fill"></td></tr>
-				<tr><td class="formtext">Type</td><td style="padding-top:1px;">
-				<select name="form_type">
-					<option
-						<tcl>if {[string compare $form_type "mdb"]==0} { append buffer {selected="selected"} } </tcl> value ="mdb">8 bit
-					</option>
-					<option
-						<tcl>if {[string compare $form_type "mdh"]==0} { append buffer {selected="selected"} } </tcl> value ="mdh">16 bit
-					</option>
-					<option
-						<tcl>if {[string compare $form_type "mdw"]==0} { append buffer {selected="selected"} } </tcl>value ="mdw">32 bit
-					</option>
-				</select>
-
-				</td></tr>
-				</table>
-				<table>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-					<tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-				</table>
-
-				<table><tr>
-					<td><input type="submit" name="form_action" value="Refresh"></td>
-					<td class="buttonspacesmall">&nbsp</td><td><input type="submit" name="form_action" value="Previous" ></td>
-					<td class="buttonspacesmall">&nbsp</td><td><input type="submit" name="form_action" value="Next" ></td>
-				</tr></table>
-				<br>
-
-			</form>
-			<p>
-			<div class="fontbigger">Memory:</div><p>
-			<code style="white-space: nowrap; font-size:11px;font:courier new;">
-				<tcl>
-				if {[string compare $form_address ""]!=0} {
-					append console [encode [capture_catch halt]]
-					append buffer [encode [capture_catch "$form_type $form_address [expr $form_length]"]]
-				}
-				</tcl>
-			</code>
-
-
-
-
-
-			]]></markup_code>
-			<right_column>
-				<![CDATA[
-				<p>Browse and edit target memory.<br>
-					Length is in bytes, maximum 4096 bytes.</p>
-				<p>An error message is shown when trying to browse or edit memory which cases a CPU fault.</p>
-				<p>CPU will be halted if required.</p>
-				<p><b>Modify</b> - Will modify only one byte, half-word or word starting at Address.</p>
-				<p><b>Fill</b> - Will fill the specified region with the specified value.</p>
-				<p><b>Refresh</b> - Display the content of the specified memory area.</p>
-					]]>
-			</right_column>
-
-			</pagetext>
-		</page>
-
-
-
-
-		<page lang="eng">
-			<outfile>downloadmem.tcl</outfile>
-			<level2parent>browsemem.tcl</level2parent>
-			<pageheading>Download Memory Range</pageheading>
-			<pagetext>
-			<markup_code><![CDATA[
-			<tcl>
-				set form_address [formfetch form_address]
-				set form_length [formfetch form_length]
-				set form_action [formfetch form_action]
-			</tcl>
-			<form action="downloadmem.tcl" method="post">
-				<table>
-				<tr><td class="formtext">Address</td><td><input type="text" name="form_address" value="<tcl>append buffer $form_address</tcl>"></td></tr>
-				<tr><td class="formtext">Length</td><td><input type="text" name="form_length" value="<tcl>append buffer $form_length</tcl>"></td></tr>
-				</td></tr>
-				</table>
-
-				<table>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-					<tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-				</table>
-
-				<input type="submit" value="Download" name="form_action">
-
-
-			</form>
-			<tcl>
-				if {[string compare $form_action "Download"]==0} {
-					append console [encode [capture_catch "reset init"]]
-					append console [encode [capture_catch "dump_image /tmp/dump.bin $form_address $form_length"]]
-					</tcl>
-					<form action="../dump.bin" target="_blank">
-						<input type="submit" name="form_action" value="Save downloaded memory">
-					</form>
-					<tcl>
-				}
-
-			</tcl>
-
-
-
-			]]></markup_code>
-			<right_column>
-				<![CDATA[
-				Download memory from target. <br>
-				<b>Note</b> that download memory can take
-				a long time(potentially minutes for megabytes at low JTAG clk speeds).
-				<p/>
-				Once the memory is downloaded a link is available on the page to download
-				the file to your PC.
-				]]>
-			</right_column>
-			</pagetext>
-
-		</page>
-
-
-
-		<page lang="eng">
-			<outfile>openocd.tcl</outfile>
-			<menutext>OpenOCD</menutext>
-			<menulink>openocd.tcl</menulink>
-			<pageheading>Run Command</pageheading>
-			<level2parent>openocd.tcl</level2parent>
-			<level2menu href="openocd.tcl" title="Run Command" titlestyle="color:#4e6627;">
-			</level2menu>
-			<level2menu href="guiupload.tcl" title="Upload File" titlestyle="color:#4e6627;">
-			<![CDATA[
-				Upload file
-			]]>
-			</level2menu>
-
-			<pagetext>
-			<markup_code><![CDATA[
-
-			<tcl>
-				set form_command [formfetch form_command]
-
-				set form_edittext ""
-				if {[string length $form_command]>0} {
-					set form_edittext [capture_catch {eval $form_command}]
-				}
-
-				append buffer {<form action="openocd.tcl" method="post">} "\n"
-				append buffer {Command<br>}
-				append buffer {<textarea style="overflow:auto;" rows="5" cols="65" name="form_command" wrap="off">}
-				append buffer [to_textarea $form_command]
-				append buffer {</textarea><br>}
-				append buffer {<input type="submit" value="Run" name="form_action" ><br>}
-				append buffer {<textarea style="overflow:auto;" rows="21" cols="65" name="form_edittext" readonly=1 wrap="off">}
-				append buffer [to_textarea $form_edittext]
-				append buffer {</textarea><br>}
-
-				append buffer {</form>} "\n"
-
-			</tcl>
-
-			]]></markup_code>
-
-			<right_column>
-				<![CDATA[
-				<p>Run tcl statement(s). Add "ocd_" prefix to OpenOCD commands otherwise
-				there will be no output, e.g. "reset init" use "ocd_reset init".
-				<p/>
-				<p><a href="/ram/log">Click here to download log</a>.</p>
-				<p>To download log you can also use commands like "wget http://<tcl>append buffer [ip]</tcl>/ram/log", or
-				point your web browser to said address.</p>
-				<p>
-				You can also execute tcl commands using curl from your developer PC:
-				</p>
-				<code>
-				curl --form form_command=ocd_version <tcl>append buffer [ip]</tcl>runtcl.tcl
-				</code>
-
-				]]>
-			</right_column>
-			</pagetext>
-		</page>
-
-
-
-		<page lang="eng">
-			<outfile>guiupload.tcl</outfile>
-			<level2parent>openocd.tcl</level2parent>
-			<pageheading>Upload File</pageheading>
-			<pagetext>
-			<markup_code><![CDATA[
-
-			<tcl>
-				set form_filename [formfetch form_filename];
-				set form_action [formfetch form_action];
-				#set form_filecontent [formfetch form_filecontent];
-
-				append buffer {<form enctype="multipart/form-data" action="guiupload.tcl" method="post">}
-				append buffer <br>
-				if {[string compare $form_action "Upload"]==0} {
-					if {[catch {writeform form_filecontent $form_filename} result]==0} {
-						append buffer [encode $result]
-					} else {
-						append buffer Wrote $form_filename
-					}
-				}
-
-				append buffer {<table style="padding:0px;border-collapse:collapse;"><tr><td class="formtext">Filename on OpenOCD machine</td><td><input type="text" name="form_filename"></td></tr>}
-				append buffer {<td class="formtext">File to upload</td><td><input type="file" name="form_filecontent"></td></tr></table>}
-				append buffer {<table><tr><td style="height:15px;width:535px;">&nbsp</td></tr><tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr><tr><td style="height:15px;width:535px;">&nbsp</td></tr></table>}
-				append buffer {<input type="submit" name="form_action" value="Upload" ><br> }
-				append buffer {</form>}
-
-			</tcl>
-
-			]]></markup_code>
-			</pagetext>
-
-		</page>
-
-
-
-		<page lang="eng">
-			<outfile>targets.tcl</outfile>
-			<level2parent>documentation.tcl</level2parent>
-			<pageheading>Target config quick start guide</pageheading>
-			<pagetext>
-				<markup_code><![CDATA[
-
-				A target needs an openocd.cfg file. This config file sets up
-				the CPU, flash and reset init script. Either OpenOCD ships with an
-				openocd.cfg file for your target or you need to take an existing
-				config file and modify it for your needs.
-				<p>
-				The reset init script is crucial. It will set up e.g. MMU, chip
-				select registers, etc. after a reset. The init.cfg (reset init script)
-				is embedded into the openocd.cfg file in the sampls OpenOCD provides.
-				<p>
-				Writing an openocd.cfg from scratch is a non-trivial exercise, but
-				fortunally it only has to be done once for a target and afterwards it
-				rarely if ever needs to be changed.
-
-
-				]]></markup_code>
-				<right_column>
-
-					Quick start guide on how to configure a target.
-				</right_column>
-			</pagetext>
-
-
-		</page>
-
-
-
-
-
-		<page lang="eng">
-			<menulink>index.tcl</menulink>
-			<level2parent>index.tcl</level2parent>
-			<outfile>terminal.tcl</outfile>
-			<pageheading>UART forwarding</pageheading>
-			<pagetext>
-			<markup_code><![CDATA[
-			<tcl>
-				set form_baudrate [formfetch form_baudrate]
-				if {[string length $form_baudrate]==0} {
-					set form_baudrate [ocd_uart]
-					set form_baudrate [string range $form_baudrate 0 [expr [string length $form_baudrate]-2]]
-				}
-				set form_action [formfetch form_action]
-			</tcl>
-			<form action="terminal.tcl" method="post">
-				Target baudrate:
-					<select name="form_baudrate">
-						<tcl>
-							foreach i {9600 19200 38400 57600 115200} {
-							</tcl>
-								<option <tcl>if {[string compare $form_baudrate $i]==0} { append buffer {selected="selected"} } </tcl>
-								value ="<tcl>append buffer $i</tcl>"><tcl>append buffer $i</tcl></option>
-							<tcl>
-							}
-							</tcl>
-						</select>
-
-					<p>
-					<input type="submit" name="form_action" value="Set baudrate" >
-				</form>
-			<tcl>
-				if {[string compare $form_action "Set baudrate"]==0} {
-					append console [encode [ocd_uart $form_baudrate]]
-				}
-			</tcl>
-
-			<h2>Simple UART</h2>
-			This terminal window is purely for illustrative purposes. Use telnet or a terminal program
-			to talk to the target over TCP/IP for anything but trivial case of reading/writing a few
-			lines of texts in simple tests.
-			<p>
-			]]></markup_code>
-			<right_column>
-				<![CDATA[
-				Serial port data to target is forwarded(both directions) in the simple terminal window
-				to the left. Alternatively you can <b>telnet <tcl>append buffer [ip]</tcl> 5555</b>
-				or connect via TCP/IP from e.g. HyperTerminal.
-				<p>
-				Type "help uart" in telnet for information on how to set uart speed for target. Normally
-				the uart speed is set from the target configuration script by adding an "uart N", where
-				N is the baudrate.
-				]]>
-			</right_column>
-			</pagetext>
-
-		</page>
-
-
-
-	</language>
-
-</website>
diff --git a/src/server/httpd/menu.xsl b/src/server/httpd/menu.xsl
deleted file mode 100644
index b54f16c..0000000
--- a/src/server/httpd/menu.xsl
+++ /dev/null
@@ -1,298 +0,0 @@
-<?xml version="1.0"?>
-<!DOCTYPE xsl:stylesheet [<!ENTITY nbsp "&#160;">]>
-<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns="http://www.w3.org/TR/REC-html40" version="1.0">
-	<xsl:output method="html" version="4.0" indent="yes" encoding="UTF-8"
-
-	 media-type="text/plain; charset=UTF-8"/>
-
-	<xsl:param name="pagetogenerate" select="UNDEFINED"/>
-	<xsl:template match="page[outfile!=$pagetogenerate]">
-	</xsl:template>
-
-	<xsl:template match="page[outfile=$pagetogenerate]">
-		<xsl:variable name="Xlevel2parent" select="level2parent"/>
-		<xsl:variable name="Xlevel3parent" select="level3parent"/>
-
-		<html>
-			<head>
-				<title>OpenOCD debugger</title>
-				<meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
-				<link href="menuweb.css" rel="stylesheet" type="text/css"/>
-
-			</head>
-
-
-			<tcl>
-				set console ""
-				set upload_filename /ram/upload
-			</tcl>
-
-			<body style="margin:0px;">
-				<div style="width:974px;height:85px;">
-					<div style="float:left;position:relative;left:32px;width:478px;">
-						<a href="/">
-							OpenOCD
-						</a>
-					</div>
-					<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-						<div class="textlight" style="position:relative;left:15px;top:4px;">
-							<tcl>append buffer [capture version]</tcl>
-						</div>
-					</div>
-				</div>
-				<table style="padding:0px;border-collapse:collapse;">
-					<tr>
-						<td style="width:33px;">
-							<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-						</td>
-						<!-- level 2 menu bar on left -->
-						<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-							<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-								<tr style="height:59px;">
-									<td></td>
-								</tr>
-								<xsl:for-each select="parent::language/page[outfile = $Xlevel2parent]/level2menu">
-									<tr>
-										<td>
-											<xsl:choose>
-												<xsl:when test="contains(@href, $pagetogenerate)">
-													<xsl:attribute name="style">width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;</xsl:attribute>
-												</xsl:when>
-												<xsl:otherwise>
-													<xsl:attribute name="style">width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;</xsl:attribute>
-												</xsl:otherwise>
-											</xsl:choose>
-											<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-												<a>
-													<xsl:attribute name="href">
-														<xsl:value-of select="@href"/>
-													</xsl:attribute>
-													<xsl:choose>
-														<xsl:when test="(@href = $pagetogenerate)">
-															<xsl:attribute name="style">font-weight: bold;</xsl:attribute>
-														</xsl:when>
-														<xsl:otherwise>
-															<xsl:choose>
-																<xsl:when test="(@href = $Xlevel3parent)">
-																	<xsl:attribute name="style">font-weight: bold;</xsl:attribute>
-																</xsl:when>
-																<xsl:otherwise>
-																	<xsl:attribute name="style"></xsl:attribute>
-																</xsl:otherwise>
-															</xsl:choose>
-														</xsl:otherwise>
-													</xsl:choose>
-													<xsl:value-of select="@title"/>
-												</a>
-											</div>
-										</td>
-									</tr>
-								</xsl:for-each>
-								<tr>
-									<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')">
-
-									</td>
-								</tr>
-								<tr>
-									<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')">
-
-									</td>
-								</tr>
-								<tr>
-									<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')">
-
-									</td>
-								</tr>
-							</table>
-						</td>
-						<!-- top level menu -->
-						<td style="vertical-align:top;padding:0px;height:100%">
-							<table style="padding:0px;border-collapse:collapse;height:100%;">
-								<tr>
-									<td>
-										<table style="padding:0px;border-collapse:collapse;">
-											<tr>
-												<xsl:for-each select="parent::language/page">
-													<xsl:if test="menutext">
-														<td>
-															<xsl:choose>
-																<xsl:when test="(outfile = $pagetogenerate) or (outfile = $Xlevel2parent)">
-																	<xsl:attribute name="style">width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;</xsl:attribute>
-																</xsl:when>
-																<xsl:otherwise>
-																	<xsl:attribute name="style">width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;</xsl:attribute>
-																</xsl:otherwise>
-															</xsl:choose>
-															<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-																<a>
-																	<xsl:attribute name="href"><xsl:value-of select="menulink"/></xsl:attribute>
-																	<xsl:if test="(outfile = $pagetogenerate)">
-																		<xsl:attribute name="style">font-weight: bold;</xsl:attribute>
-																	</xsl:if>
-																	<xsl:if test="(outfile = $Xlevel2parent)">
-																		<xsl:attribute name="style">font-weight: bold;</xsl:attribute>
-																	</xsl:if>
-																	<xsl:value-of select="menutext"/>
-																</a>
-															 </div>
-														 </td>
-													</xsl:if>
-												</xsl:for-each>
-											</tr>
-										</table>
-									</td>
-								</tr>
-								<tr>
-									<td colspan="6" style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;">
-										<div style="width:500px;background-color:#ffffff;height:100%;">
-											&nbsp;
-										</div>
-									</td>
-								</tr>
-								<tr>
-									<td colspan="6" style="background-color:#ffffff;text-indent:30px;height:40px;">
-										<H1><xsl:value-of select="pageheading"/></H1>
-									</td>
-								</tr>
-								<tr style="height:100%;">
-									<td colspan="6" style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;">
-										<xsl:value-of disable-output-escaping="yes" select="pagetext/markup_code"/>
-									</td>
-								</tr>
-								<tcl>
-									<!-- This is the output from any OpenOCD commands -->
-									set toggle_details [formfetch toggle_details]
-									if {[string length $toggle_details]==0} {
-										set toggle_details 0
-									}
-									set show_details [load_var show_details]
-									if {[string length $show_details]==0} {
-										set show_details 0
-									}
-									if {$toggle_details==1} {
-										set show_details [expr 1-$show_details]
-										save_var show_details $show_details
-									}
-
-									if {[string length $console]!=0} {
-										</tcl>
-										<tr style="height:100%;">
-											<td colspan="6" style="height:100%;background-color:red;">
-												<table class="textgray" style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%">
-													<td style="width:25px;">&nbsp;</td>
-													<tcl>
-														if {$show_details==1} {
-															append buffer <xsl:text disable-output-escaping="yes"><![CDATA[<]]></xsl:text>
-															append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-															append buffer <xsl:text disable-output-escaping="yes"><![CDATA[>]]></xsl:text>
-														} else {
-															append buffer <xsl:text disable-output-escaping="yes"><![CDATA[<]]></xsl:text>
-															append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-															append buffer <xsl:text disable-output-escaping="yes"><![CDATA[>]]></xsl:text>
-														}
-													</tcl>
-														<a class="openocd">
-															<xsl:attribute name="href"><xsl:value-of select="$pagetogenerate"/>?toggle_details=1</xsl:attribute>
-															<tcl>
-															if {$show_details==1} {
-																append buffer "Hide details"
-																append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															</tcl>
-														</a>
-														<tcl>
-															if {$show_details==1} {
-																append buffer $console
-															}
-														</tcl>
-													 <xsl:text disable-output-escaping="yes"><![CDATA[<]]></xsl:text>/td<xsl:text disable-output-escaping="yes"><![CDATA[>]]></xsl:text>
-													 <tcl>
-														if {$show_details!=1} {
-															append buffer {<td>&nbsp;</td>}
-														}
-													 </tcl>
-													<td style="width:25px;">&nbsp;</td>
-												</table>
-											</td>
-										 </tr>
-										<tcl>
-									 }
-								</tcl>
-								<tr>
-									<td colspan="6" style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;">
-										<div style="width:500px;background-color:#ffffff;height:100%;">
-											&nbsp;
-										</div>
-									</td>
-								</tr>
-							</table>
-						</td>
-						<td style="width:6px;">
-						</td>
-						<td style="width:245px;height:100%">
-							<table style="padding:0px;border-collapse:collapse;height:100%;">
-								<tr>
-									<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-										<div class="textgray" style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;">
-											Documentation
-										 </div>
-									</td>
-									<td width="40px">
-										&nbsp;
-									</td>
-									<td>
-									</td>
-								</tr>
-								<tr>
-									<td colspan="3" style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');"></td>
-								</tr>
-								<tr>
-									<td colspan="3" style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;">
-										<a href="http://openocd.berlios.de/doc/openocd.pdf" target="_blank">OpenOCD Manual</a><br/>
-									</td>
-								</tr>
-								<tr><td colspan="3" style="background-color:#d8d7d7;height:15px;"></td></tr>
-								<tr>
-									<td colspan="3">
-										<table style="padding:0px;border-collapse:collapse;">
-											<td style="background-color:#d8d7d7;width:10px;height:1px"></td>
-											<td style="background-color:#999999;width:225px; height:1px;"></td>
-											<td style="background-color:#d8d7d7;width:10px;height:1px"></td>
-										</table>
-									</td>
-								</tr>
-								<tr><td colspan="3" style="background-color:#d8d7d7;height:15px;"></td></tr>
-								<tr style="height:100%;">
-									<td class="textgray" colspan="3" style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;">
-										<xsl:choose>
-											<xsl:when test="(pagetext/right_column)">
-												<xsl:value-of disable-output-escaping="yes" select="pagetext/right_column"/>
-											</xsl:when>
-											<xsl:otherwise>
-
-											</xsl:otherwise>
-										</xsl:choose>
-									</td>
-								</tr>
-								<tr>
-									<td colspan="3" style="height:30px;background-image:url('menu_cuts/right_bottom.png');">
-										&nbsp;
-									</td>
-								</tr>
-							 </table>
-
-						</td>
-					</tr>
-
-				</table>
-			</body>
-		</html>
-
-	</xsl:template>
-</xsl:stylesheet>
diff --git a/src/server/httpd/menu_cuts/center_bottom.png b/src/server/httpd/menu_cuts/center_bottom.png
deleted file mode 100644
index cfa5839..0000000
Binary files a/src/server/httpd/menu_cuts/center_bottom.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/center_top.png b/src/server/httpd/menu_cuts/center_top.png
deleted file mode 100644
index 6e5a213..0000000
Binary files a/src/server/httpd/menu_cuts/center_top.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/h_tab1.png b/src/server/httpd/menu_cuts/h_tab1.png
deleted file mode 100644
index b6983bf..0000000
Binary files a/src/server/httpd/menu_cuts/h_tab1.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/h_tab1_selected.png b/src/server/httpd/menu_cuts/h_tab1_selected.png
deleted file mode 100644
index 0485a2b..0000000
Binary files a/src/server/httpd/menu_cuts/h_tab1_selected.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/h_tab2.png b/src/server/httpd/menu_cuts/h_tab2.png
deleted file mode 100644
index c0fb6df..0000000
Binary files a/src/server/httpd/menu_cuts/h_tab2.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/h_tab2_selected.png b/src/server/httpd/menu_cuts/h_tab2_selected.png
deleted file mode 100644
index 4a26124..0000000
Binary files a/src/server/httpd/menu_cuts/h_tab2_selected.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/h_tab_free.png b/src/server/httpd/menu_cuts/h_tab_free.png
deleted file mode 100644
index 18682b5..0000000
Binary files a/src/server/httpd/menu_cuts/h_tab_free.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/logo_bottom.png b/src/server/httpd/menu_cuts/logo_bottom.png
deleted file mode 100644
index 8e0bf3e..0000000
Binary files a/src/server/httpd/menu_cuts/logo_bottom.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/logo_top.png b/src/server/httpd/menu_cuts/logo_top.png
deleted file mode 100644
index 6c3a6db..0000000
Binary files a/src/server/httpd/menu_cuts/logo_top.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/right_bottom.png b/src/server/httpd/menu_cuts/right_bottom.png
deleted file mode 100644
index c6011ef..0000000
Binary files a/src/server/httpd/menu_cuts/right_bottom.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/right_top.png b/src/server/httpd/menu_cuts/right_top.png
deleted file mode 100644
index aaeed10..0000000
Binary files a/src/server/httpd/menu_cuts/right_top.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/right_top_small.png b/src/server/httpd/menu_cuts/right_top_small.png
deleted file mode 100644
index 095ddf8..0000000
Binary files a/src/server/httpd/menu_cuts/right_top_small.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/top_right.png b/src/server/httpd/menu_cuts/top_right.png
deleted file mode 100644
index d1ed656..0000000
Binary files a/src/server/httpd/menu_cuts/top_right.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/v_1.png b/src/server/httpd/menu_cuts/v_1.png
deleted file mode 100644
index 2f23cfc..0000000
Binary files a/src/server/httpd/menu_cuts/v_1.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/v_2_tile.png b/src/server/httpd/menu_cuts/v_2_tile.png
deleted file mode 100644
index 3f36453..0000000
Binary files a/src/server/httpd/menu_cuts/v_2_tile.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/v_3.png b/src/server/httpd/menu_cuts/v_3.png
deleted file mode 100644
index cf8fa37..0000000
Binary files a/src/server/httpd/menu_cuts/v_3.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/v_tab.png b/src/server/httpd/menu_cuts/v_tab.png
deleted file mode 100644
index ad39319..0000000
Binary files a/src/server/httpd/menu_cuts/v_tab.png and /dev/null differ
diff --git a/src/server/httpd/menu_cuts/v_tab_selected.png b/src/server/httpd/menu_cuts/v_tab_selected.png
deleted file mode 100644
index fc7397a..0000000
Binary files a/src/server/httpd/menu_cuts/v_tab_selected.png and /dev/null differ
diff --git a/src/server/httpd/menuweb.css b/src/server/httpd/menuweb.css
deleted file mode 100644
index 60c6239..0000000
--- a/src/server/httpd/menuweb.css
+++ /dev/null
@@ -1,132 +0,0 @@
-a:link
-{
-	font-size: 12px;
-	color : #024d67;
-	font-weight:bold;
-	text-decoration : none;
-}
-
-a:visited
-{
-	font-size: 12px;
-	color : #024d67;
-	font-weight:bold;
-	text-decoration : none;
-}
-
-a:active
-{
-	font-size: 12px;
-	color : #024d67;
-	font-weight:bold;
-	text-decoration : none;
-}
-
-a:hover
-{
-	font-size: 12px;
-	color : #555555;
-	font-weight:bold;
-	text-decoration : none;
-}
-
-a.openocd:link
-{
-	font-size: 12px;
-	color : #555555;
-	font-weight:bold;
-	text-decoration : none;
-}
-
-a.openocd:visited
-{
-	font-size: 12px;
-	color : #555555;
-	font-weight:bold;
-	text-decoration : none;
-}
-
-a.openocd:active
-{
-	font-size: 12px;
-	color : #555555;
-	font-weight:bold;
-	text-decoration : none;
-}
-
-a.openocd:hover
-{
-	font-size: 12px;
-	color : #024d67;
-	font-weight:bold;
-	text-decoration : none;
-}
-
-body
-{
-	background-color : green;
-	background-color : #176e8c;
-	font-family : Arial;
-	font-size: 12px;
-	line-height: 15px;
-	color : #024d67;
-
-}
-
-h1
-{
-	padding: 0px;
-	font-size: 18px;
-	font-weight:bold;
-	text-decoration : none;
-	margin-bottom: 8px;
-}
-
-td
-{
-	padding: 0px;
-	font-size: 12px;
-	vertical-align:top;
-
-}
-
-.textlight
-{
-	color: #cccccc;
-	padding: 0px;
-	font-size: 12px;
-	vertical-align:top;
-
-}
-
-.fontbigger
-{
-	font-size:14px;
-}
-
-.textgray
-{
-	color: #555555;
-}
-
-.formtext
-{
-	padding-top: 4px;
-	font-size: 14px;
-	padding-right:10px;
-}
-
-input
-{
-	font-size: 14px;
-}
-
-.buttonspacelarge
-{
-	width:20px;
-}
-
-.buttonspacesmall
-{
-	width:8px;
-}
diff --git a/src/server/httpd/openocd.tcl b/src/server/httpd/openocd.tcl
deleted file mode 100644
index 8607f18..0000000
--- a/src/server/httpd/openocd.tcl
+++ /dev/null
@@ -1,355 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-
-
-		
-
-
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>OpenOCD debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-							OpenOCD
-						</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="openocd.tcl" style="font-weight: bold;">Run Command</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="guiupload.tcl" style="">Upload File</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl" style="font-weight: bold;">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Run Command</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-
-			}
-
-				set form_command [formfetch form_command]
-
-				set form_edittext ""
-				if {[string length $form_command]>0} {
-					set form_edittext [capture_catch {eval $form_command}]
-				}
-				
-				append buffer {<form action="openocd.tcl" method="post">} "\n"
-				append buffer {Command<br>}
-				append buffer {<textarea  style="overflow:auto;"  rows="5" cols="65" name="form_command" wrap="off">}
-				append buffer [to_textarea $form_command]
-				append buffer {</textarea><br>}
-				append buffer {<input type="submit" value="Run" name="form_action" ><br>}
-				append buffer {<textarea  style="overflow:auto;"  rows="21" cols="65" name="form_edittext" readonly=1 wrap="off">}
-				append buffer [to_textarea $form_edittext]
-				append buffer {</textarea><br>}
-				
-				append buffer {</form>} "\n"
-			
-			
-append buffer {
-
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="openocd.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://openocd.berlios.de/doc/openocd.pdf">OpenOCD Manual</a>
-<br/>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-				
-				<p>Run tcl statement(s). Add "ocd_" prefix to OpenOCD commands otherwise
-				there will be no output, e.g. "reset init" use "ocd_reset init".
-				<p/>
-				<p><a href="/ram/log">Click here to download log</a>.</p>
-				<p>To download log you can also use commands like "wget http://}
-append buffer [ip]
-append buffer {/ram/log", or
-				point your web browser to said address.</p>
-				<p>
-				You can also execute tcl commands using curl from your developer PC:
-				</p>
-				<code>
-				curl --form form_command=ocd_version }
-append buffer [ip]
-append buffer {runtcl.tcl
-				</code>
-				
-				
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/preconfig.tcl b/src/server/httpd/preconfig.tcl
deleted file mode 100644
index 8308deb..0000000
--- a/src/server/httpd/preconfig.tcl
+++ /dev/null
@@ -1,429 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>Zylin ZY1000 JTAG debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-<img src="menu_cuts/logo_top.png" style="border:0px;"/>
-</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="index.tcl" style="">Target Status</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="preconfig.tcl" style="font-weight: bold;">Select Target Config</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="editconfigs.tcl" style="">Edit Configurations</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="reload.tcl" style="">Reload Config Scripts</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl" style="font-weight: bold;">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Select Preconfigured Target</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-			
-			}
-
-			
-			set form_target [formfetch form_target]
-			set form_action [formfetch form_action]
-			
-			append buffer {<form enctype="multipart/form-data" action="preconfig.tcl" method="post">}
-			if {[string compare $form_action "Select and reload"]==0} {
-				capture_catch "trunc /config/settings/openocd.cfg"
-				capture_catch "append_file /config/settings/openocd.cfg script target/$form_target"
-				reboot 
-			}
-			
-			set form_target [load_target] 
-			
-			set files [ls /rom/target]
-			set files [lunion $files [ls /config/settings/target]]
-			set files [lsort $files]
-			 
-			if {[string compare $form_action "Select and reload"]!=0} {
-				
-append buffer {
-				<table><tr>
-				<td style="padding-top:1px;">
-					<select name="form_target">
-						}
-
-							set foundTarget 0
-							foreach i $files {
-								if {[string match *.cfg $i]} {
-									
-append buffer {
-								  		<option 
-								  		}
-
-									  		if {[string compare $form_target $i]==0} { 
-											set foundTarget 1
-									  		append buffer {selected="selected"} 
-							  		}
-append buffer {
-							  		value="}
-append buffer $i
-append buffer {">}
-append buffer $i
-append buffer {</option>
-									}
-
-								}
-							}
-							
-							if {$foundTarget==0} {
-								
-append buffer {
-							  		<option selected="selected" value="">Preconfigured target not active</option>
-								}
-
-							}
-						
-append buffer {
-					</select>
-				</td>
-				<td class="buttonspacesmall">&nbsp</td>
-				<td>
-					<input type="submit" name="form_action" value="Select and reload">
-					
-					&nbsp;&nbsp;&nbsp;&nbsp;
-					<a href="editconfigs.tcl?form_action=Load&form_selected=}
-append buffer "target/$form_target"
-append buffer {">Edit target configuration</a>
-				</td>
-				</tr></table>
-			}
-
-			} else {
-			    append buffer "Reloading setting(ca. 30 seconds)..."
-			}
-			
-append buffer {
-				
-			</form>
-			
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="preconfig.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://www.zylin.com/zy1000/ZY1000_Quick_Start_Guide.pdf">Quick Start Manual</a>
-<br/>
-<a target="_blank" href="http://www.zylin.com/zy1000/openocd.pdf">OpenOCD Manual</a>
-<br/>
-<a target="_blank" href="http://www.zylin.com/zy1000_contact.html">Contact Zylin AS</a>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-							
-				<p>ZY1000 comes with complete configurations for various targets.</p>
-				<p>These predefined configurations include reset init scripts and flash configuration.</p>
-				<p><b>Select and reload</b> - Select configuration and reboot ZY1000 unit.</p>
-				
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td/>
-<td>
-<img border="0" src="menu_cuts/logo_bottom.png"/>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/production.tcl b/src/server/httpd/production.tcl
deleted file mode 100644
index 7c5ba63..0000000
--- a/src/server/httpd/production.tcl
+++ /dev/null
@@ -1,392 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-
-
-		
-
-
-
-		
-		
-
-		
-
-
-
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>OpenOCD debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-							OpenOCD
-						</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="flashinfo.tcl" style="">Info</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="erase.tcl" style="">Erase</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="flash.tcl" style="">Program / Verify</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="production.tcl" style="font-weight: bold;">Production</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl" style="font-weight: bold;">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Production</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-			}
-
-				set form_action [formfetch form_action]
-				set form_serialnumber [formfetch form_serialnumber]
-				append buffer [production_info]
-			
-append buffer {
-				
-			<form enctype="multipart/form-data" action="production.tcl" method="post">
-				<code style="white-space: nowrap;">
-					}
-	
-						if {[string compare $form_action "Upload firmware"]==0} {
-							set wrotedata [catch {writeform form_filecontent $upload_filename} result]  
-							append buffer [encode $result]
-							if {$wrotedata==0} {
-								append buffer "<br>Running production procedure<p>"
-								append buffer "<br>Reset and init: <br>"
-								
-								append console [encode [capture_catch {catch "production $upload_filename $form_serialnumber"}]]
-							}
-						}
-						if {[string compare $form_action "Test"]==0} {
-							append buffer "<br>Running production test. Output from first 10 seconds printed below. <p>"
-							
-							append console [encode [capture_catch {catch production_test}]]
-						}
-						if {[string compare $form_action "Power on"]==0} {
-							append console [encode [capture_catch "power on"]]
-						}
-						if {[string compare $form_action "Power off"]==0} {
-							append console [encode [capture_catch "power off"]]
-						}
-					
-append buffer {
-				</code>
-				}
-
-					append buffer {<p class="formtext">Firmware file(raw binary) <input type="file" name="form_filecontent"><p>}
-					append buffer {<p class="formtext">Serial number <input type="text" name="form_serialnumber"><p>}
-				
-append buffer {
-				
-				<table>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-					<tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr>
-					<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-				</table>
-			
-				<table><tr>
-					<td><input type="submit" name="form_action" value="Upload firmware" ></td>
-					<td class="buttonspacesmall">&nbsp</td><td><input type="submit" name="form_action" value="Test"></td>
-					<td class="buttonspacesmall">&nbsp</td><td><input type="submit" name="form_action" value="Power on"></td>
-					<td class="buttonspacesmall">&nbsp</td><td><input type="submit" name="form_action" value="Power off">
-				</tr></table>
-			</form>
-			
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="production.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://openocd.berlios.de/doc/openocd.pdf">OpenOCD Manual</a>
-<br/>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-				
-				The target script can implement the "production", "production_info" and "production_test" tcl proc's. These procedures
-				are used on this page. There are default implementations that do nothing.
-				
-				<p><b>Upload firmware</b> - Power cycle target, reset target and program raw binary file to flash bank 0, offset 0 and verify flash programming. Leave target powered on.</p>
-				<p><b>Test</b> -  Power up target, run 10 second target test. Output is provided via the DCC output channel. </p>
-				<p><b>Power on</b> - Power on target.</p>
-				<p><b>Power off</b> - Power off target.</p>
-				<p><b>Serial number</b> - A target script can use this string in the production procedure. Type "help production" for more info.</p>
-					 
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/readme.txt b/src/server/httpd/readme.txt
deleted file mode 100644
index 7bc80e6..0000000
--- a/src/server/httpd/readme.txt
+++ /dev/null
@@ -1,24 +0,0 @@
-work in progress... stay tuned....
-
-
-1. To build .tcl pages. This will convert menu.xml and menu.xsl into
-lots of .html pages w/embedded tcl, which are then inverted into
-tcl with embedded html.
-
-sh build.sh
-
-xalan.jar can be gotten from apache.org.
-
-
-2. libmicrohttpd is a bit tricky to build under Cygwin:
-
-https://gnunet.org/mantis/view.php?id=1440
-
-3. To test:
-
-../openocd/configure --enable-httpd --enable-dummy  --enable-ioutil
-make
-make install
-openocd  -f httpd/httpd.tcl -c "interface dummy" -f target/at91eb40a.cfg
-
-4. Point browser to: http://localhost:8888
diff --git a/src/server/httpd/reload.tcl b/src/server/httpd/reload.tcl
deleted file mode 100644
index 5d68ce3..0000000
--- a/src/server/httpd/reload.tcl
+++ /dev/null
@@ -1,322 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-
-
-		
-
-
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>OpenOCD debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-							OpenOCD
-						</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="index.tcl" style="">Target Status</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl" style="font-weight: bold;">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Reload Config Scripts</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-			
-			}
-
-				set form_action [formfetch form_action]
-	
-				if {[string compare $form_action "Reload"]==0} {
-					append buffer "Reloading Config Scripts...<p>"
-					reboot
-				}
-			
-append buffer {
-			<form enctype="multipart/form-data" action="reload.tcl" method="post">
-				<input type="submit" name="form_action" value="Reload">
-			</form>
-			
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="reload.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://openocd.berlios.de/doc/openocd.pdf">OpenOCD Manual</a>
-<br/>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-				Restart ZY1000 to reload selected target config script.				
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/run.tcl b/src/server/httpd/run.tcl
deleted file mode 100644
index 689b160..0000000
--- a/src/server/httpd/run.tcl
+++ /dev/null
@@ -1,382 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-
-
-		
-
-
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>OpenOCD debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-							OpenOCD
-						</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="flashinfo.tcl" style="">Info</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="erase.tcl" style="">Erase</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="flash.tcl" style="">Program / Verify</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="production.tcl" style="">Production</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl" style="font-weight: bold;">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Run program</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-
-
-			
-}
-
-
-set form_address [formfetch form_address]
-set form_action [formfetch form_action]
-
-if {[string compare $form_action "Run from address"]==0} {
-	append console [encode [capture_catch "halt"]]
-	append console [encode [capture_catch "wait_halt"]]
-	append console [encode [capture_catch "resume $form_address"]]
-}  
-
-if {[string compare $form_action "Halt"]==0} {
-	append console [encode [capture_catch "halt"]]
-	append console [encode [capture_catch "wait_halt"]]
-}
-  
-if {[string compare $form_action "Reset and run"]==0} {
-	append console [encode [capture_catch "reset run"]]
-}
-  
-if {[string compare $form_action "Reset and init"]==0} {
-	append console [encode [capture_catch "reset init"]]
-}  
-
-append console [encode [capture_catch poll]]
-
-
-append buffer {
-
-<form action="run.tcl" method="post"> 
-	<table>
-	<tr><td class="formtext" style="padding-right:10px;">Address</td><td><input type="text" name="form_address" value="}
-append buffer $form_address
-append buffer {"></td></tr>
-	</td></tr>
-	</table>
-	<table>
-		<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-		<tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr>
-		<tr><td style="height:15px;width:535px;">&nbsp</td></tr>
-	</table>
-	
-	<input type="submit" name="form_action" value="Reset and run"> <input type="submit" name="form_action" value="Run from address"> <input type="submit" name="form_action" value="Halt"><input type="submit" name="form_action" value="Reset and init"><br>
-</form>
-			
-
-			
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="run.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://openocd.berlios.de/doc/openocd.pdf">OpenOCD Manual</a>
-<br/>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-				
-				<p>Reset and run - reset CPU and let it run.</p>
-				<p>Halt - halt CPU.</p>
-				<p>Run from address - halt CPU and resume from address. Default is resume from current address.</p>
-				<p>Reset and init - reset CPU and run init script.</p>
-				
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/support.tcl b/src/server/httpd/support.tcl
deleted file mode 100644
index 3150219..0000000
--- a/src/server/httpd/support.tcl
+++ /dev/null
@@ -1,431 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-		
-		
-
-		
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>Zylin ZY1000 JTAG debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="/ram/cgi/zylweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-<img src="/rom/menu_cuts/logo_top.png" style="border:0px;"/>
-</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('/rom/menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture zy1000_version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('/rom/menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="zy1000.tcl" style="">Set IP Address</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('/rom/menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="upgrade.tcl" style="">ZY1000 Firmware</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('/rom/menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="editfile.tcl" style="">Edit File</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('/rom/menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="support.tcl" style="font-weight: bold;">Support Request</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('/rom/menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="log.tcl#tail" style="">View Tail of Log</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('/rom/menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('/rom/menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('/rom/menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('/rom/menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('/rom/menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('/rom/menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('/rom/menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/openocd.tcl">OpenOCD</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('/rom/menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/zy1000.tcl" style="font-weight: bold;">Setup ZY1000</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('/rom/menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Submit Support Request</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-			Before contacting Zylin, please submit a support request with relevant information. 
-			}
-
-			
-			set form_config [load_config "target/[load_target]"]
-			set support_id [string range [rand] 0 7]
-			set form_log ""
-			append form_log "Version: [capture "zy1000_version zy1000"]"
-			append form_log "OpenOCD version: [capture "zy1000_version openocd"]"
-			append form_log "Version date: [capture "zy1000_version date"]"
-			append form_log [log]
-			
-append buffer {
-
-			<form action="supportrequest.tcl" method="POST" target="_blank">
-				<input TYPE="hidden" NAME="id" VALUE="}
-append buffer $support_id
-append buffer {">
-				<input TYPE="hidden" NAME="success" VALUE="http://www.zylin.com/zy1000_support.html">
-				<input size="50" name="subject" type="hidden" value="ZY1000 support request">
-				<table cellspacing="5">
-				<tr><td>Support ID</td><td>}
-append buffer $support_id
-append buffer {</td></tr>
-				<tr><td>Contact person</td><td><input size="50" name="name" type="text"></td></tr>
-				<tr><td>Phone</td><td><input size="50" name="phone" type="text"></td></tr>
-				<tr><td>email</td><td><input size="50" name="email" type="text"></td></tr>
-				<tr><td>MAC address</td><td><input size="50" name="serial" type="text" value="}
-append buffer [mac]
-append buffer {"></td></tr>
-				</td></tr>
-				</table>
-				<p>
-				Summary:
-				<p>
-				<input name="summary" size="50">
-				<p>
-				Description:
-				<p>
-				<textarea  style="overflow:auto;font-size:11px;"  name="description" cols="50" rows="4" type="textarea" wrap="off"></textarea>
-				
-				<p>				
-				Log:<p>
-				<textarea  style="overflow:auto;font-size:11px;"  name="log" cols="50" rows="5" type="textarea" wrap="off">}
-append buffer $form_log
-append buffer {</textarea>
-				<p>				
-				Config:<p>
-				<textarea  style="overflow:auto;font-size:11px;"  name="config" cols="50" rows="5" type="textarea" wrap="off">}
-append buffer $form_config
-append buffer {</textarea>
-				<p>
-			</form>
-			<p>
-			<input value="Creates support request" type="submit"/></td></tr>
-
-			
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('/rom/menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="/ram/cgi/support.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('/rom/menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('/rom/menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('/rom/menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://www.zylin.com/zy1000/ZY1000_Quick_Start_Guide.pdf">Quick Start Manual</a>
-<br/>
-<a target="_blank" href="http://www.zylin.com/zy1000/openocd.pdf">OpenOCD Manual</a>
-<br/>
-<a target="_blank" href="http://www.zylin.com/zy1000_contact.html">Contact Zylin AS</a>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-				
-				Before contacting Zylin with questions, please fill in and submit this form
-				and allow us time to review the information and answer by email if possible.
-				<p/> 
-				Note that you can see precisely what information is submitted to Zylin in the
-				form: the log and your config files.
-				
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('/rom/menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td/>
-<td>
-<img border="0" src="/rom/menu_cuts/logo_bottom.png"/>
-</td>
-<td style="padding-top:10px;padding-left:10px;margin-top:10px;" class="textlight">
-							Zylin AS, Auglendsdalen 78, N-4017 Stavanger, Norway - www.zylin.com
-						</td>
-</tr>
-</table>
-</body>
-</html>
-
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/targets.tcl b/src/server/httpd/targets.tcl
deleted file mode 100644
index 4a12dde..0000000
--- a/src/server/httpd/targets.tcl
+++ /dev/null
@@ -1,560 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>OpenOCD debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-							OpenOCD
-						</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Target config quick start guide</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-				
-				A target needs an openocd.cfg file. This config file sets up
-				the CPU, flash and reset init script. Either OpenOCD ships with an
-				openocd.cfg file for your target or you need to take an existing
-				config file and modify it for your needs.
-				<p> 
-				The reset init script is crucial. It will set up e.g. MMU, chip
-				select registers, etc. after a reset. The init.cfg (reset init script)
-				is embedded into the openocd.cfg file in the sampls OpenOCD provides.
-				<p>
-				Writing an openocd.cfg from scratch is a non-trivial exercise, but
-				fortunally it only has to be done once for a target and afterwards it
-				rarely if ever needs to be changed.
-				
-				
-				</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="targets.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://openocd.berlios.de/doc/openocd.pdf">OpenOCD Manual</a>
-<br/>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-					
-					  Quick start guide on how to configure a target.
-				</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>OpenOCD debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-							OpenOCD
-						</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Target config quick start guide</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-				
-				A target needs an openocd.cfg file. This config file sets up
-				the CPU, flash and reset init script. Either OpenOCD ships with an
-				openocd.cfg file for your target or you need to take an existing
-				config file and modify it for your needs.
-				<p> 
-				The reset init script is crucial. It will set up e.g. MMU, chip
-				select registers, etc. after a reset. The init.cfg (reset init script)
-				is embedded into the openocd.cfg file in the sampls OpenOCD provides.
-				<p>
-				Writing an openocd.cfg from scratch is a non-trivial exercise, but
-				fortunally it only has to be done once for a target and afterwards it
-				rarely if ever needs to be changed.
-				
-				
-				</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="targets.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://openocd.berlios.de/doc/openocd.pdf">OpenOCD Manual</a>
-<br/>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-					
-					  Quick start guide on how to configure a target.
-				</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/terminal.tcl b/src/server/httpd/terminal.tcl
deleted file mode 100644
index c6cc05f..0000000
--- a/src/server/httpd/terminal.tcl
+++ /dev/null
@@ -1,364 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-
-
-		
-
-
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>OpenOCD debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-							OpenOCD
-						</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="index.tcl" style="">Target Status</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="index.tcl" style="font-weight: bold;">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="openocd.tcl">OpenOCD</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>UART forwarding</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-			}
-
-				set form_baudrate [formfetch form_baudrate]
-				if {[string length $form_baudrate]==0} {
-					set form_baudrate [ocd_uart]
-					set form_baudrate [string range $form_baudrate 0 [expr [string length $form_baudrate]-2]]
-				}
-				set form_action [formfetch form_action]
-			
-append buffer {
-			<form action="terminal.tcl" method="post">
-				Target baudrate: 
-					<select name="form_baudrate">
-						}
-
-							foreach i {9600 19200 38400 57600 115200} { 
-							
-append buffer {
-				  				<option }
-if {[string compare $form_baudrate $i]==0} { append buffer {selected="selected"} }  
-append buffer {
-				  				value ="}
-append buffer $i
-append buffer {">}
-append buffer $i
-append buffer {</option>
-				  			}
-
-				  			}
-				  			
-append buffer {
-						</select>
-
-					<p>	
-					<input type="submit" name="form_action" value="Set baudrate" >
-				</form>			
-			}
-
-				if {[string compare $form_action "Set baudrate"]==0} {
-					append console [encode [ocd_uart $form_baudrate]]
-				}
-			
-append buffer {
-			
-			<h2>Simple UART</h2>
-			This terminal window is purely for illustrative purposes. Use telnet or a terminal program
-			to talk to the target over TCP/IP for anything but trivial case of reading/writing a few
-			lines of texts in simple tests.
-			<p>
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="terminal.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://openocd.berlios.de/doc/openocd.pdf">OpenOCD Manual</a>
-<br/>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">
-				
-				Serial port data to target is forwarded(both directions) in the simple terminal window
-				to the left. Alternatively you can <b>telnet }
-append buffer [ip]
-append buffer { 5555</b>
-				or connect via TCP/IP from e.g. HyperTerminal.
-				<p>
-				Type "help uart" in telnet for information on how to set uart speed for target. Normally
-				the uart speed is set from the target configuration script by adding an "uart N", where
-				N is the baudrate.
-				
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-</table>
-</body>
-</html>
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd/upgrade.tcl b/src/server/httpd/upgrade.tcl
deleted file mode 100644
index 11a73d3..0000000
--- a/src/server/httpd/upgrade.tcl
+++ /dev/null
@@ -1,418 +0,0 @@
-# converted to .tcl by html2tcl.tcl
-set buffer ""
-append buffer {
-	
-	
-
-		
-		
-		
-		
-
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-
-		
-
-
-
-
-		
-
-
-
-		
-
-
-		
-
-
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-		
-		
-		
-		
-		
-
-		<html xmlns="http://www.w3.org/TR/REC-html40">
-<head>
-<title>Zylin ZY1000 JTAG debugger</title>
-<meta charset="utf-8" content="text/html" http-equiv="Content-Type"/>
-<link type="text/css" rel="stylesheet" href="menuweb.css"/>
-</head>
-}
-
-				set console ""
-				set upload_filename /ram/upload
-			
-append buffer {
-<body style="margin:0px;">
-<div style="width:974px;height:85px;">
-<div style="float:left;position:relative;left:32px;width:478px;">
-<a href="/">
-<img src="menu_cuts/logo_top.png" style="border:0px;"/>
-</a>
-</div>
-<div style="float:left;position:relative;height:26px; width:278px;left:122px;background-image:url('menu_cuts/top_right.png');">
-<div style="position:relative;left:15px;top:4px;" class="textlight">
-}
-append buffer [capture version]
-append buffer {
-</div>
-</div>
-</div>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:33px;">
-<div style="width:20px;height:510px;">
-								&nbsp;
-							</div>
-</td>
-<td style="vertical-align:top;height:100%;width:140px;padding:0px;">
-<table style="padding:0px;border-collapse:collapse;height:100%;width:140px;">
-<tr style="height:59px;">
-<td/>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="zy1000.tcl" style="">Set IP Address</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="upgrade.tcl" style="font-weight: bold;">ZY1000 Firmware</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="editfile.tcl" style="">Edit File</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="support.tcl" style="">Support Request</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:38px;background-image:url('menu_cuts/v_tab.png');background-repeat: no-repeat;">
-<div style="position:relative;left:10px;top:10px;font-weight:bold;">
-<a href="log.tcl#tail" style="">View Tail of Log</a>
-</div>
-</td>
-</tr>
-<tr>
-<td style="width:140px;height:35px;background-image:url('menu_cuts/v_1.png')"/>
-</tr>
-<tr>
-<td style="width:140px;background-image:url('menu_cuts/v_2_tile.png')"/>
-</tr>
-<tr>
-<td style="width:140px;height:140px;background-image:url('menu_cuts/v_3.png')"/>
-</tr>
-</table>
-</td>
-<td style="vertical-align:top;padding:0px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td>
-<table style="padding:0px;border-collapse:collapse;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/index.tcl">Config Target</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/flashinfo.tcl">Flash</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/browsemem.tcl">Memory</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/openocd.tcl">OpenOCD</a>
-</div>
-</td>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab1_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;font-weight:bold;text-align:center;width:100px;">
-<a href="/ram/cgi/zy1000.tcl" style="font-weight: bold;">Setup ZY1000</a>
-</div>
-</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td style="height:30px;width:535px;background-image:url('menu_cuts/center_top.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-<tr>
-<td style="background-color:#ffffff;text-indent:30px;height:40px;" colspan="6">
-<H1>Upgrade ZY1000 Firmware</H1>
-</td>
-</tr>
-<tr style="height:100%;">
-<td style="background-color:#ffffff;padding-left:30px;padding-right:30px;width=535px;height:100%;" colspan="6">
-			
-			}
-
-				set form_action [formfetch form_action];
-				set form_filecontent [formfetch form_filecontent];
-				
-				append buffer {<form enctype="multipart/form-data" action="upgrade.tcl" method="post">}
-				if {[string compare $form_action "Upload"]==0} {
-					
-					if [string match ZylinPhiFirmware* $form_filecontent]==1 {
-						set form_filename /config/firmware.phi 
-						puts "Writing firmware to $form_filename"
-						set fp [aio.open $form_filename w];
-						$fp puts -nonewline $form_filecontent
-						$fp close
-						puts "Done writing firmware to $form_filename"
-						append buffer "<br><div style='font-size:14px;'>Upgraded Zylin JTAG, rebooting (wait ca. 30 seconds)...</div><br>"
-						reboot
-					} else {
-						append buffer "<br>Not a valid Zylin JTAG firmware file.<br>"
-					}
-				} elseif {[string compare $form_action "Restore factory settings"]==0} {
-					proc rmdir { dir } {
-						set entries {}
-						catch {set entries [ls $dir]} err
-						foreach { entry } $entries {
-							rmdir $dir/$entry
-							rm $dir/$entry
-						}
-					}				
-					rmdir /config/settings
-					reboot
-					append buffer "Restoring factory settings (wait ca. 30 seconds)...<br>"
-				} else {
-					append buffer {<div style="font-size:14px;">Upgrade Zylin JTAG firmware + reboot. </div><p>}
-					append buffer {<input type="file" name="form_filecontent"> <br>}
-					append buffer {<table><tr><td style="height:15px;width:535px;">&nbsp</td></tr><tr><td style="height:1px;width:535px;background-color:#a2c5d1;"></td></tr><tr><td style="height:15px;width:535px;">&nbsp</td></tr></table>}
-					append buffer {<input type="submit" name="form_action" value="Upload" ><br> }
-					append buffer {<input type="submit" name="form_action" value="Restore factory settings" ><br> }
-					append buffer {</form> }
-				}
-			
-append buffer {
-			
-			</td>
-</tr>
-}
-
-							 		
-								 	set toggle_details [formfetch toggle_details]
-								 	if {[string length $toggle_details]==0} {
-								 		set toggle_details 0
-								 	}
-								 	set show_details [load_var show_details]
-								 	if {[string length $show_details]==0} {
-								 		set show_details 0
-								 	}
-								 	if {$toggle_details==1} {
-								 		set show_details [expr 1-$show_details]
-								 		save_var show_details $show_details
-								 	}
-								 	
-							 		if {[string length $console]!=0} {
-							 			
-append buffer {
-<tr style="height:100%;">
-<td style="height:100%;background-color:red;" colspan="6">
-<table style="padding:0px;border-collapse:collapse;background-color:#ffffff;width:100%" class="textgray">
-<td style="width:25px;">&nbsp;</td>
-}
-
-												 		if {$show_details==1} {
-												 			append buffer <
-												 			append buffer {td style="background-color:#dddddd;padding-left:5px;padding-right:5px;padding-top:3px;padding-bottom:3px;"}
-												 			append buffer >
-												 		} else {
-												 			append buffer <
-												 			append buffer {td style="background-image:url('menu_cuts/h_tab_free.png');width:110px;height:29px;background-repeat: no-repeat;background-position:top left;"}
-												 			append buffer >
-												 		}
-												 	
-append buffer {
-<a class="openocd" href="/ram/cgi/upgrade.tcl?toggle_details=1">
-}
-
-															if {$show_details==1} {
-																append buffer "Hide details"
-													 			append buffer <br/>
-															} else {
-																append buffer {<div style="position:relative;top:7px;text-align:center;">}
-																append buffer "Show details"
-																append buffer {</div>}
-															}
-															
-append buffer {
-</a>
-}
-
-													 		if {$show_details==1} {
-													 			append buffer $console
-													 		}
-													 	
-append buffer {</td>}
-
-													 	if {$show_details!=1} {
-													 		append buffer {<td>&nbsp;</td>}
-													 	}
-													 
-append buffer {
-<td style="width:25px;">&nbsp;</td>
-</table>
-</td>
-</tr>
-}
-
-									 }
-								
-append buffer {
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/center_bottom.png');background-repeat: no-repeat;background-position:top right;" colspan="6">
-<div style="width:500px;background-color:#ffffff;height:100%;">
-								 			&nbsp;
-							 			</div>
-</td>
-</tr>
-</table>
-</td>
-<td style="width:6px;"/>
-<td style="width:245px;height:100%">
-<table style="padding:0px;border-collapse:collapse;height:100%;">
-<tr>
-<td style="width:103px;height:29px;background-image:url('menu_cuts/h_tab2_selected.png');background-repeat: no-repeat;">
-<div style="position:relative;top:7px;;font-weight:bold;text-align:center;width:100px;" class="textgray">
-										    Documentation
-										 </div>
-</td>
-<td width="40px">
-								 		&nbsp;
-								 	</td>
-<td/>
-</tr>
-<tr>
-<td style="height:10px;width:245px;background-image:url('menu_cuts/right_top_small.png');" colspan="3"/>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;width:245px;padding-left:10px;padding-buttom:10px;line-height:17px;" colspan="3">
-<a target="_blank" href="http://www.zylin.com/zy1000/ZY1000_Quick_Start_Guide.pdf">Quick Start Manual</a>
-<br/>
-<a target="_blank" href="http://www.zylin.com/zy1000/openocd.pdf">OpenOCD Manual</a>
-<br/>
-<a target="_blank" href="http://www.zylin.com/zy1000_contact.html">Contact Zylin AS</a>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr>
-<td colspan="3">
-<table style="padding:0px;border-collapse:collapse;">
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-<td style="background-color:#999999;width:225px; height:1px;"/>
-<td style="background-color:#d8d7d7;width:10px;height:1px"/>
-</table>
-</td>
-</tr>
-<tr>
-<td style="background-color:#d8d7d7;height:15px;" colspan="3"/>
-</tr>
-<tr style="height:100%;">
-<td style="height:100%;background-color:#d8d7d7;padding-left:10px;padding-right:10px;" colspan="3" class="textgray">	
-				
-					Upload new firmware file to ZY1000, verify that it is a valid ZY1000 firmware
-					file, and upgrade flash.
-					<p/>
-					Restore factory settings restores all factory settings except the TCP/IP settings.
-					<p/>
-					The current version of the firmware is visible at the top of the web page.
-					<p/>
-					ZY1000 firmware can also be upgraded using serial port YModem upload.
-					<p/>
-					Check for new firmware at <a target="_blank" href="http://www.zylin.com/zy1000.html">http://www.zylin.com/zy1000.html<a> 
-				  
-			</td>
-</tr>
-<tr>
-<td style="height:30px;background-image:url('menu_cuts/right_bottom.png');" colspan="3">
-							 			&nbsp;
-							 		</td>
-</tr>
-</table>
-</td>
-</tr>
-<tr>
-<td/>
-<td>
-<img border="0" src="menu_cuts/logo_bottom.png"/>
-</td>
-</tr>
-</table>
-</body>
-</html>
-		
-
-		
-
-
-		
-
-
-
-		
-
-		
-
-
-		
-
-
-		
-	
-	
-}
-
-start_chunked "html"
-write_chunked $buffer
-end_chunked
-
diff --git a/src/server/httpd_stubs.c b/src/server/httpd_stubs.c
deleted file mode 100644
index 0360fe6..0000000
--- a/src/server/httpd_stubs.c
+++ /dev/null
@@ -1,33 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2009 Zachary T Welch <zw at superlucidity.net>             *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-
-#ifdef HAVE_CONFIG_H
-#include <config.h>
-#endif
-#include "httpd.h"
-#include <helper/log.h>
-
-int httpd_start(struct command_context *cmd_ctx)
-{
-	LOG_DEBUG("libocdserver was built without HTTPD support");
-	return ERROR_OK;
-}
-void httpd_stop(void)
-{
-}
diff --git a/src/server/server.h b/src/server/server.h
index face138..2afd712 100644
--- a/src/server/server.h
+++ b/src/server/server.h
@@ -89,11 +89,11 @@ int connection_write(struct connection *connection, const void *data, int len);
 int connection_read(struct connection *connection, void *data, int len);
 
 /**
- * Used by server_loop(), defined in server_stubs.c, httpd.c, or ecosboard.c
+ * Used by server_loop(), defined in server_stubs.c or ecosboard.c
  */
 void openocd_sleep_prelude(void);
 /**
- * Used by server_loop(), defined in server_stubs.c, httpd.c, or ecosboard.c
+ * Used by server_loop(), defined in server_stubs.c or ecosboard.c
  */
 void openocd_sleep_postlude(void);
 

-----------------------------------------------------------------------

Summary of changes:
 README                                         |    2 -
 configure.in                                   |    5 -
 doc/manual/server.txt                          |   14 -
 src/Makefile.am                                |    4 -
 src/openocd.c                                  |    6 -
 src/server/Makefile.am                         |   24 +-
 src/server/httpd.c                             |  506 ------------
 src/server/httpd.h                             |   28 -
 src/server/httpd/Stylizer.class                |  Bin 4493 -> 0 bytes
 src/server/httpd/Stylizer.java                 |  114 ---
 src/server/httpd/browsemem.tcl                 |  454 -----------
 src/server/httpd/build.sh                      |    5 -
 src/server/httpd/downloadmem.tcl               |  366 ---------
 src/server/httpd/editconfigs.tcl               |  462 -----------
 src/server/httpd/editfile.tcl                  |  436 -----------
 src/server/httpd/erase.tcl                     |  387 ----------
 src/server/httpd/flash.tcl                     |  459 -----------
 src/server/httpd/flashinfo.tcl                 |  382 ----------
 src/server/httpd/guiupload.tcl                 |  336 --------
 src/server/httpd/html2tcl.sh                   |  128 ----
 src/server/httpd/httpd.tcl                     |  100 ---
 src/server/httpd/index.tcl                     |  376 ---------
 src/server/httpd/log.tcl                       |  343 ---------
 src/server/httpd/menu.xml                      |  973 ------------------------
 src/server/httpd/menu.xsl                      |  298 --------
 src/server/httpd/menu_cuts/center_bottom.png   |  Bin 309 -> 0 bytes
 src/server/httpd/menu_cuts/center_top.png      |  Bin 307 -> 0 bytes
 src/server/httpd/menu_cuts/h_tab1.png          |  Bin 364 -> 0 bytes
 src/server/httpd/menu_cuts/h_tab1_selected.png |  Bin 310 -> 0 bytes
 src/server/httpd/menu_cuts/h_tab2.png          |  Bin 349 -> 0 bytes
 src/server/httpd/menu_cuts/h_tab2_selected.png |  Bin 330 -> 0 bytes
 src/server/httpd/menu_cuts/h_tab_free.png      |  Bin 454 -> 0 bytes
 src/server/httpd/menu_cuts/logo_bottom.png     |  Bin 960 -> 0 bytes
 src/server/httpd/menu_cuts/logo_top.png        |  Bin 3082 -> 0 bytes
 src/server/httpd/menu_cuts/right_bottom.png    |  Bin 351 -> 0 bytes
 src/server/httpd/menu_cuts/right_top.png       |  Bin 281 -> 0 bytes
 src/server/httpd/menu_cuts/right_top_small.png |  Bin 265 -> 0 bytes
 src/server/httpd/menu_cuts/top_right.png       |  Bin 352 -> 0 bytes
 src/server/httpd/menu_cuts/v_1.png             |  Bin 305 -> 0 bytes
 src/server/httpd/menu_cuts/v_2_tile.png        |  Bin 169 -> 0 bytes
 src/server/httpd/menu_cuts/v_3.png             |  Bin 2289 -> 0 bytes
 src/server/httpd/menu_cuts/v_tab.png           |  Bin 390 -> 0 bytes
 src/server/httpd/menu_cuts/v_tab_selected.png  |  Bin 357 -> 0 bytes
 src/server/httpd/menuweb.css                   |  132 ----
 src/server/httpd/openocd.tcl                   |  355 ---------
 src/server/httpd/preconfig.tcl                 |  429 -----------
 src/server/httpd/production.tcl                |  392 ----------
 src/server/httpd/readme.txt                    |   24 -
 src/server/httpd/reload.tcl                    |  322 --------
 src/server/httpd/run.tcl                       |  382 ----------
 src/server/httpd/support.tcl                   |  431 -----------
 src/server/httpd/targets.tcl                   |  560 --------------
 src/server/httpd/terminal.tcl                  |  364 ---------
 src/server/httpd/upgrade.tcl                   |  418 ----------
 src/server/httpd_stubs.c                       |   33 -
 src/server/server.h                            |    4 +-
 56 files changed, 3 insertions(+), 10051 deletions(-)
 delete mode 100644 src/server/httpd.c
 delete mode 100644 src/server/httpd.h
 delete mode 100755 src/server/httpd/Stylizer.class
 delete mode 100755 src/server/httpd/Stylizer.java
 delete mode 100644 src/server/httpd/browsemem.tcl
 delete mode 100755 src/server/httpd/build.sh
 delete mode 100644 src/server/httpd/downloadmem.tcl
 delete mode 100644 src/server/httpd/editconfigs.tcl
 delete mode 100644 src/server/httpd/editfile.tcl
 delete mode 100644 src/server/httpd/erase.tcl
 delete mode 100644 src/server/httpd/flash.tcl
 delete mode 100644 src/server/httpd/flashinfo.tcl
 delete mode 100644 src/server/httpd/guiupload.tcl
 delete mode 100755 src/server/httpd/html2tcl.sh
 delete mode 100644 src/server/httpd/httpd.tcl
 delete mode 100644 src/server/httpd/index.tcl
 delete mode 100644 src/server/httpd/log.tcl
 delete mode 100644 src/server/httpd/menu.xml
 delete mode 100644 src/server/httpd/menu.xsl
 delete mode 100644 src/server/httpd/menu_cuts/center_bottom.png
 delete mode 100644 src/server/httpd/menu_cuts/center_top.png
 delete mode 100644 src/server/httpd/menu_cuts/h_tab1.png
 delete mode 100644 src/server/httpd/menu_cuts/h_tab1_selected.png
 delete mode 100644 src/server/httpd/menu_cuts/h_tab2.png
 delete mode 100644 src/server/httpd/menu_cuts/h_tab2_selected.png
 delete mode 100644 src/server/httpd/menu_cuts/h_tab_free.png
 delete mode 100644 src/server/httpd/menu_cuts/logo_bottom.png
 delete mode 100644 src/server/httpd/menu_cuts/logo_top.png
 delete mode 100644 src/server/httpd/menu_cuts/right_bottom.png
 delete mode 100644 src/server/httpd/menu_cuts/right_top.png
 delete mode 100644 src/server/httpd/menu_cuts/right_top_small.png
 delete mode 100644 src/server/httpd/menu_cuts/top_right.png
 delete mode 100644 src/server/httpd/menu_cuts/v_1.png
 delete mode 100644 src/server/httpd/menu_cuts/v_2_tile.png
 delete mode 100644 src/server/httpd/menu_cuts/v_3.png
 delete mode 100644 src/server/httpd/menu_cuts/v_tab.png
 delete mode 100644 src/server/httpd/menu_cuts/v_tab_selected.png
 delete mode 100644 src/server/httpd/menuweb.css
 delete mode 100644 src/server/httpd/openocd.tcl
 delete mode 100644 src/server/httpd/preconfig.tcl
 delete mode 100644 src/server/httpd/production.tcl
 delete mode 100644 src/server/httpd/readme.txt
 delete mode 100644 src/server/httpd/reload.tcl
 delete mode 100644 src/server/httpd/run.tcl
 delete mode 100644 src/server/httpd/support.tcl
 delete mode 100644 src/server/httpd/targets.tcl
 delete mode 100644 src/server/httpd/terminal.tcl
 delete mode 100644 src/server/httpd/upgrade.tcl
 delete mode 100644 src/server/httpd_stubs.c


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Nov 16 09:17:05 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue, 16 Nov 2010 08:17:05 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-591-g09c798a
Message-ID: <E1PIGiw-0006Xl-LI@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  09c798a1444e9f416afc829b77ff599777d6d5d9 (commit)
       via  e7a8de17620cd24d0c28388d5851ce093297411c (commit)
      from  fdae51287cf55a039f3401ed92151dbf518e4e7f (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 09c798a1444e9f416afc829b77ff599777d6d5d9
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Thu Nov 11 14:16:52 2010 +0800

    TCL/SPEAr: Added Serial flash in board file
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/tcl/board/spear310evb20.cfg b/tcl/board/spear310evb20.cfg
index 887e799..70783f5 100644
--- a/tcl/board/spear310evb20.cfg
+++ b/tcl/board/spear310evb20.cfg
@@ -25,6 +25,10 @@ arm7_9 fast_memory_access enable
 set _FLASHNAME0 $_CHIPNAME.pnor
 flash bank $_FLASHNAME0 cfi 0x50000000 0x01000000 2 4 $_TARGETNAME
 
+# Serial NOR on SMI CS0. 8Mbyte.
+set _FLASHNAME1 $_CHIPNAME.snor
+flash bank $_FLASHNAME1 spearsmi 0xf8000000 0 0 0 $_TARGETNAME
+
 if { [info exists BOARD_HAS_SRST] } {
 	# Modified board has SRST on JTAG connector
 	reset_config trst_and_srst separate srst_gates_jtag \

commit e7a8de17620cd24d0c28388d5851ce093297411c
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Thu Nov 11 14:12:31 2010 +0800

    NOR/SPEAr: Add support for Serial NOR
    
    Add support and documentation for STMicroelectronics
    SPEAr Serial Memory Interface (SMI).
    Code tested on SPEAr3xx only.
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index f946bdf..0d24dde 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -4252,6 +4252,33 @@ flash bank $_FLASHNAME cfi 0x00000000 0x02000000 2 4 $_TARGETNAME
 @c "cfi part_id" disabled
 @end deffn
 
+ at deffn {Flash Driver} spearsmi
+ at cindex SPEAr Serial Memory Interface
+ at cindex SMI
+ at cindex spearsmi
+All members of SPEAr MPU family from STMicroelectronics include a
+``Serial Memory Interface'' (SMI) controller able to drive external
+SPI flash devices.
+Depending on specific MPU and board configuration, up to 4 external
+flash devices can be connected.
+
+SMI makes the flash content directly accessible in the CPU address
+space; each external device is mapped in a memory bank.
+CPU can directly read data, execute code and boot from SMI banks.
+Normal OpenOCD commands like @command{mdw} can be used to display
+the flash content.
+
+The setup command only requires the @var{base} parameter in order
+to identify the memory bank.
+All other parameters are ignored. Additional information, like
+flash size, are detected automatically.
+
+ at example
+flash bank $_FLASHNAME spearsmi 0xf8000000 0 0 0 $_TARGETNAME
+ at end example
+
+ at end deffn
+
 @subsection Internal Flash (Microcontrollers)
 
 @deffn {Flash Driver} aduc702x
diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index eec6f50..511e899 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -23,6 +23,7 @@ NOR_DRIVERS = \
 	non_cfi.c \
 	ocl.c \
 	pic32mx.c \
+	spearsmi.c \
 	stellaris.c \
 	stm32x.c \
 	str7x.c \
@@ -44,6 +45,7 @@ noinst_HEADERS = \
 	non_cfi.h \
 	ocl.h \
 	pic32mx.h \
+	spearsmi.h \
 	stellaris.h \
 	stm32x.h \
 	str7x.h \
diff --git a/src/flash/nor/drivers.c b/src/flash/nor/drivers.c
index 68f2f88..f89e3f0 100644
--- a/src/flash/nor/drivers.c
+++ b/src/flash/nor/drivers.c
@@ -40,6 +40,7 @@ extern struct flash_driver pic32mx_flash;
 extern struct flash_driver avr_flash;
 extern struct flash_driver faux_flash;
 extern struct flash_driver virtual_flash;
+extern struct flash_driver spearsmi_flash;
 
 /**
  * The list of built-in flash drivers.
@@ -65,6 +66,7 @@ static struct flash_driver *flash_drivers[] = {
 	&avr_flash,
 	&faux_flash,
 	&virtual_flash,
+	&spearsmi_flash,
 	NULL,
 };
 
diff --git a/src/flash/nor/spearsmi.c b/src/flash/nor/spearsmi.c
new file mode 100644
index 0000000..19a4405
--- /dev/null
+++ b/src/flash/nor/spearsmi.c
@@ -0,0 +1,713 @@
+/***************************************************************************
+ *   Copyright (C) 2010 by Antonio Borneo <borneo.antonio at gmail.com>       *
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ *   This program is distributed in the hope that it will be useful,       *
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
+ *   GNU General Public License for more details.                          *
+ *                                                                         *
+ *   You should have received a copy of the GNU General Public License     *
+ *   along with this program; if not, write to the                         *
+ *   Free Software Foundation, Inc.,                                       *
+ *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
+ ***************************************************************************/
+
+/* ATTENTION:
+ * To have flash memory mapped in CPU memory space, the SMI controller
+ * have to be in "HW mode". This requires following constraints:
+ * 1) The command "reset init" have to initialize SMI controller and put
+ *    it in HW mode;
+ * 2) every command in this file have to return to prompt in HW mode. */
+
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
+#include "imp.h"
+#include "spearsmi.h"
+#include <jtag/jtag.h>
+#include <helper/time_support.h>
+
+#define JTAG_ID_3XX_6XX  (0x07926041)
+
+#define SMI_READ_REG(a) (_SMI_READ_REG(a))
+#define _SMI_READ_REG(a)        	\
+{	                                \
+	int __a;                        \
+	uint32_t __v;                   \
+	                                \
+	__a = target_read_u32(target, io_base + (a), &__v); \
+	if (__a != ERROR_OK)            \
+	    return __a;                 \
+	__v;                            \
+}
+
+#define SMI_WRITE_REG(a,v)      	\
+{	                                \
+	int __r;                        \
+	                                \
+	__r = target_write_u32(target, io_base + (a), (v)); \
+	if (__r != ERROR_OK)            \
+	    return __r;                 \
+}
+
+#define SMI_POLL_TFF(timeout)   	\
+{	                                \
+	int __r;                        \
+	                                \
+	__r = poll_tff(target, io_base, timeout); \
+	if (__r != ERROR_OK)            \
+	    return __r;                 \
+}
+
+#define SMI_SET_SW_MODE()	SMI_WRITE_REG(SMI_CR1, \
+	SMI_READ_REG(SMI_CR1) | SMI_SW_MODE)
+#define SMI_SET_HWWB_MODE() SMI_WRITE_REG(SMI_CR1, \
+	(SMI_READ_REG(SMI_CR1) | SMI_WB_MODE) & ~SMI_SW_MODE)
+#define SMI_SET_HW_MODE()	SMI_WRITE_REG(SMI_CR1, \
+	SMI_READ_REG(SMI_CR1) & ~(SMI_SW_MODE | SMI_WB_MODE))
+#define SMI_CLEAR_TFF()		SMI_WRITE_REG(SMI_SR, ~SMI_TFF)
+
+#define SMI_BANK_SIZE      (0x01000000)
+
+#define SMI_BASE_3XX_6XX   (0xf8000000)
+#define SMI_CFGREG_3XX_6XX (0xfc000000)
+
+/* #define SMI_BASE_13XX      (0xe6000000) */
+/* #define SMI_CFGREG_13XX    (0xea000000) */
+
+#define SMI_CR1 (0x00) /* Control register 1 */
+#define SMI_CR2 (0x04) /* Control register 2 */
+#define SMI_SR  (0x08) /* Status register */
+#define SMI_TR  (0x0c) /* TX */
+#define SMI_RR  (0x10) /* RX */
+
+/* fields in SMI_CR1 */
+#define SMI_SW_MODE       0x10000000 /* set to enable SW Mode */
+#define SMI_WB_MODE       0x20000000 /* Write Burst Mode */
+
+/* fields in SMI_CR2 */
+#define SMI_TX_LEN_1      0x00000001 /* data length = 1 byte */
+#define SMI_TX_LEN_4      0x00000004 /* data length = 4 byte */
+#define SMI_RX_LEN_3      0x00000030 /* data length = 3 byte */
+#define SMI_SEND          0x00000080 /* Send data */
+#define SMI_RSR           0x00000400 /* reads status reg */
+#define SMI_WE            0x00000800 /* Write Enable */
+#define SMI_SEL_BANK0     0x00000000 /* Select Bank0 */
+#define SMI_SEL_BANK1     0x00001000 /* Select Bank1 */
+#define SMI_SEL_BANK2     0x00002000 /* Select Bank2 */
+#define SMI_SEL_BANK3     0x00003000 /* Select Bank3 */
+
+/* fields in SMI_SR */
+#define SMI_WIP_BIT       0x00000001 /* WIP Bit of SPI SR on SMI SR */
+#define SMI_WEL_BIT       0x00000002 /* WEL Bit of SPI SR on SMI SR */
+#define SMI_TFF           0x00000100 /* Transfer Finished Flag */
+
+/* Commands */
+#define SMI_READ_ID       0x0000009F /* Read Flash Identification */
+
+/* Timeout in ms */
+#define SMI_CMD_TIMEOUT   (100)
+#define SMI_PROBE_TIMEOUT (100)
+#define SMI_MAX_TIMEOUT  (3000)
+
+/* data structure to maintain flash ids from different vendors */
+struct flash_device {
+	char *name;
+	uint8_t erase_cmd;
+	uint32_t device_id;
+	uint32_t pagesize;
+	unsigned long sectorsize;
+	unsigned long size_in_bytes;
+};
+
+#define FLASH_ID(n, es, id, psize, ssize, size) \
+{	                        \
+	.name = n,              \
+	.erase_cmd = es,        \
+	.device_id = id,        \
+	.pagesize = psize,      \
+	.sectorsize = ssize,    \
+	.size_in_bytes = size   \
+}
+
+static struct flash_device flash_devices[] = {
+	/* name, erase_cmd, device_id, pagesize, sectorsize, size_in_bytes */
+	FLASH_ID("st m25p05",      0xd8, 0x00102020, 0x80,  0x8000,  0x10000),
+	FLASH_ID("st m25p10",      0xd8, 0x00112020, 0x80,  0x8000,  0x20000),
+	FLASH_ID("st m25p20",      0xd8, 0x00122020, 0x100, 0x10000, 0x40000),
+	FLASH_ID("st m25p40",      0xd8, 0x00132020, 0x100, 0x10000, 0x80000),
+	FLASH_ID("st m25p80",      0xd8, 0x00142020, 0x100, 0x10000, 0x100000),
+	FLASH_ID("st m25p16",      0xd8, 0x00152020, 0x100, 0x10000, 0x200000),
+	FLASH_ID("st m25p32",      0xd8, 0x00162020, 0x100, 0x10000, 0x400000),
+	FLASH_ID("st m25p64",      0xd8, 0x00172020, 0x100, 0x10000, 0x800000),
+	FLASH_ID("st m25p128",     0xd8, 0x00182020, 0x100, 0x40000, 0x1000000),
+	FLASH_ID("st m45pe10",     0xd8, 0x00114020, 0x100, 0x10000, 0x20000),
+	FLASH_ID("st m45pe20",     0xd8, 0x00124020, 0x100, 0x10000, 0x40000),
+	FLASH_ID("st m45pe40",     0xd8, 0x00134020, 0x100, 0x10000, 0x80000),
+	FLASH_ID("st m45pe80",     0xd8, 0x00144020, 0x100, 0x10000, 0x100000),
+	FLASH_ID("sp s25fl004",    0xd8, 0x00120201, 0x100, 0x10000, 0x80000),
+	FLASH_ID("sp s25fl008",    0xd8, 0x00130201, 0x100, 0x10000, 0x100000),
+	FLASH_ID("sp s25fl016",    0xd8, 0x00140201, 0x100, 0x10000, 0x200000),
+	FLASH_ID("sp s25fl032",    0xd8, 0x00150201, 0x100, 0x10000, 0x400000),
+	FLASH_ID("sp s25fl064",    0xd8, 0x00160201, 0x100, 0x10000, 0x800000),
+	FLASH_ID("atmel 25f512",   0x52, 0x0065001f, 0x80,  0x8000,  0x10000),
+	FLASH_ID("atmel 25f1024",  0x52, 0x0060001f, 0x100, 0x8000,  0x20000),
+	FLASH_ID("atmel 25f2048",  0x52, 0x0063001f, 0x100, 0x10000, 0x40000),
+	FLASH_ID("atmel 25f4096",  0x52, 0x0064001f, 0x100, 0x10000, 0x80000),
+	FLASH_ID("atmel 25fs040",  0xd7, 0x0004661f, 0x100, 0x10000, 0x80000),
+	FLASH_ID("mac 25l512",     0xd8, 0x001020c2, 0x010, 0x10000, 0x10000),
+	FLASH_ID("mac 25l1005",    0xd8, 0x001120c2, 0x010, 0x10000, 0x20000),
+	FLASH_ID("mac 25l2005",    0xd8, 0x001220c2, 0x010, 0x10000, 0x40000),
+	FLASH_ID("mac 25l4005",    0xd8, 0x001320c2, 0x010, 0x10000, 0x80000),
+	FLASH_ID("mac 25l8005",    0xd8, 0x001420c2, 0x010, 0x10000, 0x100000),
+	FLASH_ID("mac 25l1605",    0xd8, 0x001520c2, 0x100, 0x10000, 0x200000),
+	FLASH_ID("mac 25l3205",    0xd8, 0x001620c2, 0x100, 0x10000, 0x400000),
+	FLASH_ID("mac 25l6405",    0xd8, 0x001720c2, 0x100, 0x10000, 0x800000),
+	FLASH_ID(NULL,             0,    0,          0,     0,       0)
+};
+
+FLASH_BANK_COMMAND_HANDLER(spearsmi_flash_bank_command)
+{
+	struct spearsmi_flash_bank *spearsmi_info;
+
+	LOG_DEBUG(__FUNCTION__);
+
+	if (CMD_ARGC < 6)
+	{
+		LOG_WARNING("incomplete flash_bank spearsmi configuration");
+		return ERROR_FLASH_BANK_INVALID;
+	}
+
+	spearsmi_info = malloc(sizeof(struct spearsmi_flash_bank));
+	if (spearsmi_info == NULL)
+	{
+		LOG_ERROR("not enough memory");
+		return ERROR_FAIL;
+	}
+
+	bank->driver_priv = spearsmi_info;
+	spearsmi_info->probed = 0;
+
+	return ERROR_OK;
+}
+
+/* Poll transmit finished flag */
+/* timeout in ms */
+static int poll_tff(struct target *target, uint32_t io_base, int timeout)
+{
+	long long endtime;
+
+	if (SMI_READ_REG(SMI_SR) & SMI_TFF)
+		return ERROR_OK;
+
+	endtime = timeval_ms() + timeout;
+	do {
+		alive_sleep(1);
+		if (SMI_READ_REG(SMI_SR) & SMI_TFF)
+			return ERROR_OK;
+	} while (timeval_ms() < endtime);
+
+	LOG_ERROR("Timeout while polling TFF");
+	return ERROR_FLASH_OPERATION_FAILED;
+}
+
+static int read_status_reg(struct flash_bank *bank, uint32_t *status)
+{
+	struct target *target = bank->target;
+	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
+	uint32_t io_base = spearsmi_info->io_base;
+
+	/* clear transmit finished flag */
+	SMI_CLEAR_TFF();
+
+	/* Read status */
+	SMI_WRITE_REG(SMI_CR2, spearsmi_info->bank_num | SMI_RSR);
+
+	/* Poll transmit finished flag */
+	SMI_POLL_TFF(SMI_CMD_TIMEOUT);
+
+	/* clear transmit finished flag */
+	SMI_CLEAR_TFF();
+
+	/* Check write enabled */
+	*status = SMI_READ_REG(SMI_SR) & 0x0000ffff;
+
+	/* clean-up SMI_CR2 */
+	SMI_WRITE_REG(SMI_CR2, 0); /* AB: Required ? */
+
+	return ERROR_OK;
+}
+
+/* check for WIP (write in progress) bit in status register */
+/* timeout in ms */
+static int wait_till_ready(struct flash_bank *bank, int timeout)
+{
+	uint32_t status;
+	int retval;
+	long long endtime;
+
+    endtime = timeval_ms() + timeout;
+    do {
+        /* read flash status register */
+        retval = read_status_reg(bank, &status);
+        if (retval != ERROR_OK)
+            return retval;
+
+		if ((status & SMI_WIP_BIT) == 0)
+			return ERROR_OK;
+		alive_sleep(1);
+    } while (timeval_ms() < endtime);
+
+	LOG_ERROR("timeout");
+	return ERROR_FAIL;
+}
+
+static int smi_write_enable(struct flash_bank *bank)
+{
+	struct target *target = bank->target;
+	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
+	uint32_t io_base = spearsmi_info->io_base;
+	uint32_t status;
+	int retval;
+
+	/* Enter in HW mode */
+	SMI_SET_HW_MODE(); /* AB: is this correct ?*/
+
+	/* clear transmit finished flag */
+	SMI_CLEAR_TFF();
+
+	/* Send write enable command */
+	SMI_WRITE_REG(SMI_CR2, spearsmi_info->bank_num | SMI_WE);
+
+	/* Poll transmit finished flag */
+	SMI_POLL_TFF(SMI_CMD_TIMEOUT);
+
+	/* read flash status register */
+	retval = read_status_reg(bank, &status);
+	if (retval != ERROR_OK)
+		return retval;
+
+	/* Check write enabled */
+	if ((status & SMI_WEL_BIT) == 0)
+	{
+		LOG_ERROR("Cannot enable write to flash. Status=0x%08" PRIx32, status);
+		return ERROR_FAIL;
+	}
+
+	return ERROR_OK;
+}
+
+static uint32_t erase_command(struct spearsmi_flash_bank *spearsmi_info,
+	uint32_t offset)
+{
+	union {
+		uint32_t command;
+		uint8_t x[4];
+	} cmd;
+
+	cmd.x[0] = spearsmi_info->dev->erase_cmd;
+	cmd.x[1] = offset >> 16;
+	cmd.x[2] = offset >> 8;
+	cmd.x[3] = offset;
+
+	return cmd.command;
+}
+
+static int smi_erase_sector(struct flash_bank *bank, int sector)
+{
+	struct target *target = bank->target;
+	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
+	uint32_t io_base = spearsmi_info->io_base;
+	uint32_t cmd;
+	int retval;
+
+	retval = smi_write_enable(bank);
+	if (retval != ERROR_OK)
+		return retval;
+
+	/* Switch to SW mode to send sector erase command */
+	SMI_SET_SW_MODE();
+
+	/* clear transmit finished flag */
+	SMI_CLEAR_TFF();
+
+	/* send erase command */
+	cmd = erase_command(spearsmi_info, bank->sectors[sector].offset);
+	SMI_WRITE_REG(SMI_TR, cmd);
+	SMI_WRITE_REG(SMI_CR2, spearsmi_info->bank_num | SMI_SEND | SMI_TX_LEN_4);
+
+	/* Poll transmit finished flag */
+	SMI_POLL_TFF(SMI_CMD_TIMEOUT);
+
+	/* poll WIP for end of self timed Sector Erase cycle */
+	retval = wait_till_ready(bank, SMI_MAX_TIMEOUT);
+	if (retval != ERROR_OK)
+		return retval;
+
+	return ERROR_OK;
+}
+
+static int spearsmi_erase(struct flash_bank *bank, int first, int last)
+{
+	struct target *target = bank->target;
+	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
+	uint32_t io_base = spearsmi_info->io_base;
+	int retval = ERROR_OK;
+	int sector;
+
+	LOG_DEBUG("%s: from sector %d to sector %d", __FUNCTION__, first, last);
+
+	if (target->state != TARGET_HALTED)
+	{
+		LOG_ERROR("Target not halted");
+		return ERROR_TARGET_NOT_HALTED;
+	}
+
+	if ((first < 0) || (last < first) || (last >= bank->num_sectors))
+	{
+		LOG_ERROR("Flash sector invalid");
+		return ERROR_FLASH_SECTOR_INVALID;
+	}
+
+	if (!(spearsmi_info->probed))
+	{
+		LOG_ERROR("Flash bank not probed");
+		return ERROR_FLASH_BANK_NOT_PROBED;
+	}
+
+	for (sector = first; sector <= last; sector++)
+	{
+		if (bank->sectors[sector].is_protected)
+		{
+			LOG_ERROR("Flash sector %d protected", sector);
+			return ERROR_FAIL;
+		}
+	}
+
+	for (sector = first; sector <= last; sector++)
+	{
+		retval = smi_erase_sector(bank, sector);
+		if (retval != ERROR_OK)
+			break;
+		keep_alive();
+	}
+
+	/* Switch to HW mode before return to prompt */
+	SMI_SET_HW_MODE();
+	return retval;
+}
+
+static int spearsmi_protect(struct flash_bank *bank, int set,
+	int first, int last)
+{
+	int sector;
+
+	for (sector = first; sector <= last; sector++)
+		bank->sectors[sector].is_protected = set;
+	return ERROR_OK;
+}
+
+static int smi_write_buffer(struct flash_bank *bank, uint8_t *buffer,
+	uint32_t address, uint32_t len)
+{
+	struct target *target = bank->target;
+	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
+	uint32_t io_base = spearsmi_info->io_base;
+	int retval;
+
+	LOG_DEBUG("%s: address=0x%08" PRIx32 " len=0x%08" PRIx32,
+		__FUNCTION__, address, len);
+
+	retval = smi_write_enable(bank);
+	if (retval != ERROR_OK)
+		return retval;
+
+	/* HW mode, write burst mode */
+	SMI_SET_HWWB_MODE();
+
+	retval = target_write_buffer(target, address, len, buffer);
+	if (retval != ERROR_OK)
+		return retval;
+
+	return ERROR_OK;
+}
+
+static int spearsmi_write(struct flash_bank *bank, uint8_t *buffer,
+	uint32_t offset, uint32_t count)
+{
+	struct target *target = bank->target;
+	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
+	uint32_t io_base = spearsmi_info->io_base;
+	uint32_t cur_count, page_size, page_offset;
+	int sector;
+	int retval = ERROR_OK;
+
+	LOG_DEBUG("%s: offset=0x%08" PRIx32 " count=0x%08" PRIx32,
+		__FUNCTION__, offset, count);
+
+	if (target->state != TARGET_HALTED)
+	{
+		LOG_ERROR("Target not halted");
+		return ERROR_TARGET_NOT_HALTED;
+	}
+
+	if (offset + count > spearsmi_info->dev->size_in_bytes)
+	{
+		LOG_WARNING("Write pasts end of flash. Extra data discarded.");
+		count = spearsmi_info->dev->size_in_bytes - offset;
+	}
+
+	/* Check sector protection */
+	for (sector = 0; sector < bank->num_sectors; sector++)
+	{
+		/* Start offset in or before this sector? */
+		/* End offset in or behind this sector? */
+		if ( (offset <
+				(bank->sectors[sector].offset + bank->sectors[sector].size))
+			&& ((offset + count - 1) >= bank->sectors[sector].offset)
+			&& bank->sectors[sector].is_protected )
+		{
+			LOG_ERROR("Flash sector %d protected", sector);
+			return ERROR_FAIL;
+		}
+	}
+
+	page_size = spearsmi_info->dev->pagesize;
+
+	/* unaligned buffer head */
+	if (count > 0 && (offset & 3) != 0)
+	{
+		cur_count = 4 - (offset & 3);
+		if (cur_count > count)
+			cur_count = count;
+		retval = smi_write_buffer(bank, buffer, bank->base + offset,
+			cur_count);
+		if (retval != ERROR_OK)
+			goto err;
+		offset += cur_count;
+		buffer += cur_count;
+		count -= cur_count;
+	}
+
+	page_offset = offset % page_size;
+	/* central part, aligned words */
+	while (count >= 4)
+	{
+		/* clip block at page boundary */
+		if (page_offset + count > page_size)
+			cur_count = page_size - page_offset;
+		else
+			cur_count = count & ~3;
+
+		retval = smi_write_buffer(bank, buffer, bank->base + offset,
+			cur_count);
+		if (retval != ERROR_OK)
+			goto err;
+
+		page_offset = 0;
+		buffer += cur_count;
+		offset += cur_count;
+		count -= cur_count;
+
+		keep_alive();
+	}
+
+	/* buffer tail */
+	if (count > 0)
+		retval = smi_write_buffer(bank, buffer, bank->base + offset, count);
+
+err:
+	/* Switch to HW mode before return to prompt */
+	SMI_SET_HW_MODE();
+	return retval;
+}
+
+/* Return ID of flash device */
+/* On exit, SW mode is kept */
+static int read_flash_id(struct flash_bank *bank, uint32_t *id)
+{
+	struct target *target = bank->target;
+	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
+	uint32_t io_base = spearsmi_info->io_base;
+	int retval;
+
+	if (target->state != TARGET_HALTED)
+	{
+		LOG_ERROR("Target not halted");
+		return ERROR_TARGET_NOT_HALTED;
+	}
+
+	/* poll WIP */
+	retval = wait_till_ready(bank, SMI_PROBE_TIMEOUT);
+	if (retval != ERROR_OK)
+		return retval;
+
+	/* enter in SW mode */
+	SMI_SET_SW_MODE();
+
+	/* clear transmit finished flag */
+	SMI_CLEAR_TFF();
+
+	/* Require read flash ID */
+	SMI_WRITE_REG(SMI_TR, SMI_READ_ID);
+	SMI_WRITE_REG(SMI_CR2,
+		spearsmi_info->bank_num | SMI_SEND | SMI_RX_LEN_3 | SMI_TX_LEN_1);
+
+	/* Poll transmit finished flag */
+	SMI_POLL_TFF(SMI_CMD_TIMEOUT);
+
+	/* clear transmit finished flag */
+	SMI_CLEAR_TFF();
+
+	/* read ID */
+	*id = SMI_READ_REG(SMI_RR) & 0x00ffffff;
+	return ERROR_OK;
+}
+
+static int spearsmi_probe(struct flash_bank *bank)
+{
+	struct target *target = bank->target;
+	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
+	uint32_t io_base;
+	struct flash_sector *sectors;
+	uint32_t id = 0; /* silence uninitialized warning */
+	int retval;
+
+	if (spearsmi_info->probed)
+		free(bank->sectors);
+	spearsmi_info->probed = 0;
+
+	/* check for SPEAr device */
+	switch (target->tap->idcode)
+	{
+		case JTAG_ID_3XX_6XX:
+			/* SPEAr3xx/6xx */
+			spearsmi_info->io_base = SMI_CFGREG_3XX_6XX;
+			switch (bank->base)
+			{
+				case SMI_BASE_3XX_6XX:
+					spearsmi_info->bank_num = SMI_SEL_BANK0;
+					break;
+				case SMI_BASE_3XX_6XX + SMI_BANK_SIZE:
+					spearsmi_info->bank_num = SMI_SEL_BANK1;
+					break;
+				case SMI_BASE_3XX_6XX + 2*SMI_BANK_SIZE:
+					spearsmi_info->bank_num = SMI_SEL_BANK2;
+					break;
+				case SMI_BASE_3XX_6XX + 3*SMI_BANK_SIZE:
+					spearsmi_info->bank_num = SMI_SEL_BANK3;
+					break;
+				default:
+					LOG_ERROR("Invalid base address 0x%" PRIx32, bank->base);
+					return ERROR_FAIL;
+			}
+			break;
+
+		default:
+			LOG_ERROR("0x%" PRIx32 " is invalid id for SPEAr device",
+				target->tap->idcode);
+			return ERROR_FAIL;
+	}
+	io_base = spearsmi_info->io_base;
+
+	/* read and decode flash ID; returns in SW mode */
+	retval = read_flash_id(bank, &id);
+	SMI_SET_HW_MODE();
+	if (retval != ERROR_OK)
+		return retval;
+
+	for (struct flash_device *p = flash_devices; p->name ; p++)
+		if (p->device_id == id) {
+			spearsmi_info->dev = p;
+			break;
+		}
+
+	if (!spearsmi_info->dev)
+	{
+		LOG_ERROR("Unknown flash device (ID 0x%08" PRIx32 ")", id);
+		return ERROR_FAIL;
+	}
+
+	LOG_INFO("Found flash device \'%s\' (ID 0x%08" PRIx32 ")",
+		spearsmi_info->dev->name, spearsmi_info->dev->device_id);
+
+	/* Set correct size value */
+	bank->size = spearsmi_info->dev->size_in_bytes;
+
+	/* create and fill sectors array */
+	bank->num_sectors =
+		spearsmi_info->dev->size_in_bytes / spearsmi_info->dev->sectorsize;
+	sectors = malloc(sizeof(struct flash_sector) * bank->num_sectors);
+	if (sectors == NULL)
+	{
+		LOG_ERROR("not enough memory");
+		return ERROR_FAIL;
+	}
+
+	for (int sector = 0; sector < bank->num_sectors; sector++)
+	{
+		sectors[sector].offset = sector * spearsmi_info->dev->sectorsize;
+		sectors[sector].size = spearsmi_info->dev->sectorsize;
+		sectors[sector].is_erased = -1;
+		sectors[sector].is_protected = 1;
+	}
+
+	bank->sectors = sectors;
+	spearsmi_info->probed = 1;
+	return ERROR_OK;
+}
+
+static int spearsmi_auto_probe(struct flash_bank *bank)
+{
+	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
+	if (spearsmi_info->probed)
+		return ERROR_OK;
+	return spearsmi_probe(bank);
+}
+
+static int spearsmi_protect_check(struct flash_bank *bank)
+{
+	/* Nothing to do. Protection is only handled in SW. */
+	return ERROR_OK;
+}
+
+static int get_spearsmi_info(struct flash_bank *bank, char *buf, int buf_size)
+{
+	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
+	int printed;
+
+	if (!(spearsmi_info->probed))
+	{
+		printed = snprintf(buf, buf_size,
+			"\nSPEAr SMI flash bank not probed yet\n");
+		return ERROR_OK;
+	}
+
+	printed = snprintf(buf, buf_size, "\nSPEAr SMI flash information:\n"
+		"  Device \'%s\' (ID 0x%08x)\n",
+		spearsmi_info->dev->name, spearsmi_info->dev->device_id);
+	buf += printed;
+	buf_size -= printed;
+
+	return ERROR_OK;
+}
+
+struct flash_driver spearsmi_flash = {
+	.name = "spearsmi",
+	.flash_bank_command = spearsmi_flash_bank_command,
+	.erase = spearsmi_erase,
+	.protect = spearsmi_protect,
+	.write = spearsmi_write,
+	.read = default_flash_read,
+	.probe = spearsmi_probe,
+	.auto_probe = spearsmi_auto_probe,
+	.erase_check = default_flash_blank_check,
+	.protect_check = spearsmi_protect_check,
+	.info = get_spearsmi_info,
+};
diff --git a/src/flash/nor/spearsmi.h b/src/flash/nor/spearsmi.h
new file mode 100644
index 0000000..03fabe3
--- /dev/null
+++ b/src/flash/nor/spearsmi.h
@@ -0,0 +1,30 @@
+/***************************************************************************
+ *   Copyright (C) 2010 by Antonio Borneo <borneo.antonio at gmail.com>       *
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ *   This program is distributed in the hope that it will be useful,       *
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
+ *   GNU General Public License for more details.                          *
+ *                                                                         *
+ *   You should have received a copy of the GNU General Public License     *
+ *   along with this program; if not, write to the                         *
+ *   Free Software Foundation, Inc.,                                       *
+ *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
+ ***************************************************************************/
+#ifndef SPEARSMI_H
+#define SPEARSMI_H
+
+struct spearsmi_flash_bank
+{
+	int probed;
+	uint32_t io_base;
+	uint32_t bank_num;
+	struct flash_device *dev;
+};
+
+#endif /* SPEARSMI_H */

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi                                   |   27 +
 src/flash/nor/Makefile.am                          |    2 +
 src/flash/nor/drivers.c                            |    2 +
 src/flash/nor/spearsmi.c                           |  713 ++++++++++++++++++++
 .../server_stubs.c => flash/nor/spearsmi.h}        |   24 +-
 tcl/board/spear310evb20.cfg                        |    4 +
 6 files changed, 759 insertions(+), 13 deletions(-)
 create mode 100644 src/flash/nor/spearsmi.c
 copy src/{server/server_stubs.c => flash/nor/spearsmi.h} (84%)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Wed Nov 17 08:57:42 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Wed, 17 Nov 2010 07:57:42 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-595-g5255835
Message-ID: <E1PIctj-000799-LD@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  52558354e67e4a2f7884666cf88c899ad9afa05e (commit)
       via  d213e1a12ca9b719c055c07239a2104f00240d56 (commit)
       via  c5414f95b6435231fb3dc5266ddd0b54c95c155e (commit)
       via  49f42ab51d12a35206c6e255f2d45acde6ae5b68 (commit)
      from  09c798a1444e9f416afc829b77ff599777d6d5d9 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 52558354e67e4a2f7884666cf88c899ad9afa05e
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 10:53:30 2010 +0800

    FLASH/NOR: Remove useless file at91sam7.h
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index 242fb79..b008d75 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -33,7 +33,6 @@ NOR_DRIVERS = \
 	virtual.c
 
 noinst_HEADERS = \
-	at91sam7.h \
 	avrf.h \
 	core.h \
 	cfi.h \
diff --git a/src/flash/nor/at91sam7.c b/src/flash/nor/at91sam7.c
index 3a809e2..3fabe47 100644
--- a/src/flash/nor/at91sam7.c
+++ b/src/flash/nor/at91sam7.c
@@ -50,9 +50,55 @@
 #endif
 
 #include "imp.h"
-#include "at91sam7.h"
 #include <helper/binarybuffer.h>
 
+
+/* AT91SAM7 control registers */
+#define DBGU_CIDR			0xFFFFF240
+#define CKGR_MCFR			0xFFFFFC24
+#define CKGR_MOR			0xFFFFFC20
+#define CKGR_MCFR_MAINRDY	0x10000
+#define CKGR_PLLR			0xFFFFFC2c
+#define CKGR_PLLR_DIV		0xff
+#define CKGR_PLLR_MUL		0x07ff0000
+#define PMC_MCKR			0xFFFFFC30
+#define PMC_MCKR_CSS		0x03
+#define PMC_MCKR_PRES		0x1c
+
+/* Flash Controller Commands */
+#define WP		0x01
+#define SLB		0x02
+#define WPL		0x03
+#define CLB		0x04
+#define EA		0x08
+#define SGPB	0x0B
+#define CGPB	0x0D
+#define SSB		0x0F
+
+/* MC_FSR bit definitions */
+#define MC_FSR_FRDY			1
+#define MC_FSR_EOL			2
+
+/* AT91SAM7 constants */
+#define RC_FREQ				32000
+
+/* Flash timing modes */
+#define FMR_TIMING_NONE		0
+#define FMR_TIMING_NVBITS	1
+#define FMR_TIMING_FLASH	2
+
+/* Flash size constants */
+#define FLASH_SIZE_8KB		1
+#define FLASH_SIZE_16KB		2
+#define FLASH_SIZE_32KB		3
+#define FLASH_SIZE_64KB		5
+#define FLASH_SIZE_128KB	7
+#define FLASH_SIZE_256KB	9
+#define FLASH_SIZE_512KB	10
+#define FLASH_SIZE_1024KB	12
+#define FLASH_SIZE_2048KB	14
+
+
 static int at91sam7_protect_check(struct flash_bank *bank);
 static int at91sam7_write(struct flash_bank *bank, uint8_t *buffer, uint32_t offset, uint32_t count);
 
@@ -67,6 +113,50 @@ static uint32_t MC_FSR[4] = { 0xFFFFFF68, 0xFFFFFF78, 0xFFFFFF88, 0xFFFFFF98 };
 
 static char * EPROC[8]= {"Unknown","ARM946-E","ARM7TDMI","Unknown","ARM920T","ARM926EJ-S","Unknown","Unknown"};
 
+struct at91sam7_flash_bank
+{
+	/* chip id register */
+	uint32_t cidr;
+	uint16_t cidr_ext;
+	uint16_t cidr_nvptyp;
+	uint16_t cidr_arch;
+	uint16_t cidr_sramsiz;
+	uint16_t cidr_nvpsiz;
+	uint16_t cidr_nvpsiz2;
+	uint16_t cidr_eproc;
+	uint16_t cidr_version;
+	char *target_name;
+
+	/* flash auto-detection */
+	uint8_t  flash_autodetection;
+
+	/* flash geometry */
+	uint16_t pages_per_sector;
+	uint16_t pagesize;
+	uint16_t pages_in_lockregion;
+
+	/* nv memory bits */
+	uint16_t num_lockbits_on;
+	uint16_t lockbits;
+	uint16_t num_nvmbits;
+	uint16_t num_nvmbits_on;
+	uint16_t nvmbits;
+	uint8_t  securitybit;
+
+	/* 0: not init
+	 * 1: fmcn for nvbits (1uS)
+	 * 2: fmcn for flash (1.5uS) */
+	uint8_t  flashmode;
+
+	/* main clock status */
+	uint8_t  mck_valid;
+	uint32_t mck_freq;
+
+	/* external clock frequency */
+	uint32_t ext_freq;
+
+};
+
 #if 0
 static long SRAMSIZ[16] = {
 	-1,
diff --git a/src/flash/nor/at91sam7.h b/src/flash/nor/at91sam7.h
deleted file mode 100644
index eb35433..0000000
--- a/src/flash/nor/at91sam7.h
+++ /dev/null
@@ -1,116 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2006 by Magnus Lundin                                   *
- *   lundin at mlu.mine.nu                                                    *
- *                                                                         *
- *   Copyright (C) 2006 by Gheorghe Guran (atlas)                          *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-
-#ifndef AT91SAM7_H
-#define AT91SAM7_H
-
-struct at91sam7_flash_bank
-{
-	/* chip id register */
-	uint32_t cidr;
-	uint16_t cidr_ext;
-	uint16_t cidr_nvptyp;
-	uint16_t cidr_arch;
-	uint16_t cidr_sramsiz;
-	uint16_t cidr_nvpsiz;
-	uint16_t cidr_nvpsiz2;
-	uint16_t cidr_eproc;
-	uint16_t cidr_version;
-	char *target_name;
-
-	/* flash auto-detection */
-	uint8_t  flash_autodetection;
-
-	/* flash geometry */
-	uint16_t pages_per_sector;
-	uint16_t pagesize;
-	uint16_t pages_in_lockregion;
-
-	/* nv memory bits */
-	uint16_t num_lockbits_on;
-	uint16_t lockbits;
-	uint16_t num_nvmbits;
-	uint16_t num_nvmbits_on;
-	uint16_t nvmbits;
-	uint8_t  securitybit;
-
-	/* 0: not init
-	 * 1: fmcn for nvbits (1uS)
-	 * 2: fmcn for flash (1.5uS) */
-	uint8_t  flashmode;
-
-	/* main clock status */
-	uint8_t  mck_valid;
-	uint32_t mck_freq;
-
-	/* external clock frequency */
-	uint32_t ext_freq;
-
-};
-
-
-/* AT91SAM7 control registers */
-#define DBGU_CIDR			0xFFFFF240
-#define CKGR_MCFR			0xFFFFFC24
-#define CKGR_MOR			0xFFFFFC20
-#define CKGR_MCFR_MAINRDY	0x10000
-#define CKGR_PLLR			0xFFFFFC2c
-#define CKGR_PLLR_DIV		0xff
-#define CKGR_PLLR_MUL		0x07ff0000
-#define PMC_MCKR			0xFFFFFC30
-#define PMC_MCKR_CSS		0x03
-#define PMC_MCKR_PRES		0x1c
-
-/* Flash Controller Commands */
-#define WP		0x01
-#define SLB		0x02
-#define WPL		0x03
-#define CLB		0x04
-#define EA		0x08
-#define SGPB	0x0B
-#define CGPB	0x0D
-#define SSB		0x0F
-
-/* MC_FSR bit definitions */
-#define MC_FSR_FRDY			1
-#define MC_FSR_EOL			2
-
-/* AT91SAM7 constants */
-#define RC_FREQ				32000
-
-/* Flash timing modes */
-#define FMR_TIMING_NONE		0
-#define FMR_TIMING_NVBITS	1
-#define FMR_TIMING_FLASH	2
-
-/* Flash size constants */
-#define FLASH_SIZE_8KB		1
-#define FLASH_SIZE_16KB		2
-#define FLASH_SIZE_32KB		3
-#define FLASH_SIZE_64KB		5
-#define FLASH_SIZE_128KB	7
-#define FLASH_SIZE_256KB	9
-#define FLASH_SIZE_512KB	10
-#define FLASH_SIZE_1024KB	12
-#define FLASH_SIZE_2048KB	14
-
-#endif /* AT91SAM7_H */

commit d213e1a12ca9b719c055c07239a2104f00240d56
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 10:25:55 2010 +0800

    FLASH/NOR: Remove useless file at91sam3.h
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index 97a2433..242fb79 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -34,7 +34,6 @@ NOR_DRIVERS = \
 
 noinst_HEADERS = \
 	at91sam7.h \
-	at91sam3.h \
 	avrf.h \
 	core.h \
 	cfi.h \
diff --git a/src/flash/nor/at91sam3.c b/src/flash/nor/at91sam3.c
index 8005fe0..8b922f3 100644
--- a/src/flash/nor/at91sam3.c
+++ b/src/flash/nor/at91sam3.c
@@ -62,7 +62,6 @@
 
 
 #include "imp.h"
-#include "at91sam3.h"
 #include <helper/time_support.h>
 
 #define REG_NAME_WIDTH  (12)
@@ -99,6 +98,8 @@
 #define  offset_EFC_FRR   12
 
 
+struct flash_driver at91sam3_flash;
+
 static float
 _tomhz(uint32_t freq_hz)
 {
diff --git a/src/flash/nor/at91sam3.h b/src/flash/nor/at91sam3.h
deleted file mode 100644
index 4fa7f46..0000000
--- a/src/flash/nor/at91sam3.h
+++ /dev/null
@@ -1,23 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2009 by Duane Ellis                                     *
- *   openocd at duaneellis.com                                                *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-
-
-// nothing to do here other then export this.
-extern struct flash_driver at91sam3_flash;

commit c5414f95b6435231fb3dc5266ddd0b54c95c155e
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 08:21:22 2010 +0800

    FLASH/NOR: Remove useless file spearsmi.h
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index 511e899..97a2433 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -45,7 +45,6 @@ noinst_HEADERS = \
 	non_cfi.h \
 	ocl.h \
 	pic32mx.h \
-	spearsmi.h \
 	stellaris.h \
 	stm32x.h \
 	str7x.h \
diff --git a/src/flash/nor/spearsmi.c b/src/flash/nor/spearsmi.c
index 4902a44..c3bc2ec 100644
--- a/src/flash/nor/spearsmi.c
+++ b/src/flash/nor/spearsmi.c
@@ -39,7 +39,6 @@
 #endif
 
 #include "imp.h"
-#include "spearsmi.h"
 #include <jtag/jtag.h>
 #include <helper/time_support.h>
 
@@ -126,6 +125,14 @@
 #define SMI_PROBE_TIMEOUT (100)
 #define SMI_MAX_TIMEOUT  (3000)
 
+struct spearsmi_flash_bank
+{
+	int probed;
+	uint32_t io_base;
+	uint32_t bank_num;
+	struct flash_device *dev;
+};
+
 /* data structure to maintain flash ids from different vendors */
 struct flash_device {
 	char *name;
diff --git a/src/flash/nor/spearsmi.h b/src/flash/nor/spearsmi.h
deleted file mode 100644
index 03fabe3..0000000
--- a/src/flash/nor/spearsmi.h
+++ /dev/null
@@ -1,30 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2010 by Antonio Borneo <borneo.antonio at gmail.com>       *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-#ifndef SPEARSMI_H
-#define SPEARSMI_H
-
-struct spearsmi_flash_bank
-{
-	int probed;
-	uint32_t io_base;
-	uint32_t bank_num;
-	struct flash_device *dev;
-};
-
-#endif /* SPEARSMI_H */

commit 49f42ab51d12a35206c6e255f2d45acde6ae5b68
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 08:12:45 2010 +0800

    NOR/SPEARSMI: Add comments about SPI
    
    SMI interface hides the real SPI bus between SPEAr and
    external flash.
    Added comments to highlight the SPI operation, to help a
    future rework in SPI generic and SPEAr specific drivers.
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/spearsmi.c b/src/flash/nor/spearsmi.c
index 19a4405..4902a44 100644
--- a/src/flash/nor/spearsmi.c
+++ b/src/flash/nor/spearsmi.c
@@ -17,6 +17,16 @@
  *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
  ***************************************************************************/
 
+/* SPEAr Serial Memory Interface (SMI) controller is a SPI bus controller
+ * specifically designed for SPI memories.
+ * Only SPI "mode 3" (CPOL=1 and CPHA=1) is supported.
+ * Two working modes are available:
+ * - SW mode: the SPI is controlled by SW. Any custom commands can be sent
+ *   on the bus.
+ * - HW mode: the SPI but is under SMI control. Memory content is directly
+ *   accessible in CPU memory space. CPU can read, write and execute memory
+ *   content. */
+
 /* ATTENTION:
  * To have flash memory mapped in CPU memory space, the SMI controller
  * have to be in "HW mode". This requires following constraints:
@@ -136,6 +146,9 @@ struct flash_device {
 	.size_in_bytes = size   \
 }
 
+/* List below is taken from Linux driver. It is not exhaustive of all the
+ * possible SPI memories, nor exclusive for SMI. Could be shared with
+ * other SPI drivers. */
 static struct flash_device flash_devices[] = {
 	/* name, erase_cmd, device_id, pagesize, sectorsize, size_in_bytes */
 	FLASH_ID("st m25p05",      0xd8, 0x00102020, 0x80,  0x8000,  0x10000),
@@ -217,6 +230,9 @@ static int poll_tff(struct target *target, uint32_t io_base, int timeout)
 	return ERROR_FLASH_OPERATION_FAILED;
 }
 
+/* Read the status register of the external SPI flash chip.
+ * The operation is triggered by setting SMI_RSR bit.
+ * SMI sends the proper SPI command (0x05) and returns value in SMI_SR */
 static int read_status_reg(struct flash_bank *bank, uint32_t *status)
 {
 	struct target *target = bank->target;
@@ -235,7 +251,6 @@ static int read_status_reg(struct flash_bank *bank, uint32_t *status)
 	/* clear transmit finished flag */
 	SMI_CLEAR_TFF();
 
-	/* Check write enabled */
 	*status = SMI_READ_REG(SMI_SR) & 0x0000ffff;
 
 	/* clean-up SMI_CR2 */
@@ -268,6 +283,9 @@ static int wait_till_ready(struct flash_bank *bank, int timeout)
 	return ERROR_FAIL;
 }
 
+/* Send "write enable" command to SPI flash chip.
+ * The operation is triggered by setting SMI_WE bit, and SMI sends
+ * the proper SPI command (0x06) */
 static int smi_write_enable(struct flash_bank *bank)
 {
 	struct target *target = bank->target;
@@ -337,7 +355,7 @@ static int smi_erase_sector(struct flash_bank *bank, int sector)
 	/* clear transmit finished flag */
 	SMI_CLEAR_TFF();
 
-	/* send erase command */
+	/* send SPI command "block erase" */
 	cmd = erase_command(spearsmi_info, bank->sectors[sector].offset);
 	SMI_WRITE_REG(SMI_TR, cmd);
 	SMI_WRITE_REG(SMI_CR2, spearsmi_info->bank_num | SMI_SEND | SMI_TX_LEN_4);
@@ -554,7 +572,7 @@ static int read_flash_id(struct flash_bank *bank, uint32_t *id)
 	/* clear transmit finished flag */
 	SMI_CLEAR_TFF();
 
-	/* Require read flash ID */
+	/* Send SPI command "read ID" */
 	SMI_WRITE_REG(SMI_TR, SMI_READ_ID);
 	SMI_WRITE_REG(SMI_CR2,
 		spearsmi_info->bank_num | SMI_SEND | SMI_RX_LEN_3 | SMI_TX_LEN_1);
@@ -565,7 +583,7 @@ static int read_flash_id(struct flash_bank *bank, uint32_t *id)
 	/* clear transmit finished flag */
 	SMI_CLEAR_TFF();
 
-	/* read ID */
+	/* read ID from Receive Register */
 	*id = SMI_READ_REG(SMI_RR) & 0x00ffffff;
 	return ERROR_OK;
 }

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/Makefile.am |    3 -
 src/flash/nor/at91sam3.c  |    3 +-
 src/flash/nor/at91sam3.h  |   23 ---------
 src/flash/nor/at91sam7.c  |   92 +++++++++++++++++++++++++++++++++++-
 src/flash/nor/at91sam7.h  |  116 ---------------------------------------------
 src/flash/nor/spearsmi.c  |   35 ++++++++++++--
 src/flash/nor/spearsmi.h  |   30 ------------
 7 files changed, 123 insertions(+), 179 deletions(-)
 delete mode 100644 src/flash/nor/at91sam3.h
 delete mode 100644 src/flash/nor/at91sam7.h
 delete mode 100644 src/flash/nor/spearsmi.h


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Wed Nov 17 17:00:50 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Wed, 17 Nov 2010 16:00:50 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-596-g2b546fd
Message-ID: <E1PIkRI-0007Zs-Dn@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  2b546fdc45d33a7b407f49b3732d1a57afa60b72 (commit)
      from  52558354e67e4a2f7884666cf88c899ad9afa05e (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 2b546fdc45d33a7b407f49b3732d1a57afa60b72
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Nov 15 14:43:16 2010 +0100

    flash: fix bug with multiple back-to-back flash chips
    
    flash programming via flash write_image or gdb load would
    produce a bogus error message that the flash chip was to
    small.
    
    The solution is to limit the current flash programming
    run to the current chip.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nor/core.c b/src/flash/nor/core.c
index 2c1d9de..da73bf6 100644
--- a/src/flash/nor/core.c
+++ b/src/flash/nor/core.c
@@ -654,9 +654,13 @@ int flash_write_unlock(struct target *target, struct image *image,
 
 		if (run_address + run_size - 1 > c->base + c->size - 1)
 		{
-			LOG_ERROR("The image is too big for the flash");
-			retval = ERROR_FAIL;
-			goto done;
+			/* If we have more than one flash chip back to back, then we limit
+			 * the current write operation to the current chip.
+			 */
+			LOG_DEBUG("Truncate flash run size to the current flash chip.");
+
+			run_size = c->base + c->size - run_address;
+			assert(run_size > 0);
 		}
 
 		/* If we're applying any sector automagic, then pad this

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/core.c |   10 +++++++---
 1 files changed, 7 insertions(+), 3 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Wed Nov 17 17:04:35 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Wed, 17 Nov 2010 16:04:35 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-606-gab263fa
Message-ID: <E1PIkUv-0003aB-5P@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  ab263fafbb5ed7c0464e8cfefc2f95095aa3e7cd (commit)
       via  29d7031fe34fa489075c6abe74df232cc070fe6e (commit)
       via  7bbd6c76838ffc639226897328d8ec7069b1769d (commit)
       via  d16dbaa0fc7b8a2f40cf9b283f716d2d7344504b (commit)
       via  5d09972931e55c4d2bba7471df9c725f5bebc18c (commit)
       via  f1f8d9a6c9b1fd35d79627b568faa2409f13311f (commit)
       via  f5ae179519d578169b4123af89eebf667efa1e2c (commit)
       via  4cc359794420dbe0aedba38bde0ee4d871cdb354 (commit)
       via  fb7c70980427e7f91ece27880b411a0489145a4d (commit)
       via  28bbe4e98337948e814e40cebe69f7958a48e560 (commit)
      from  2b546fdc45d33a7b407f49b3732d1a57afa60b72 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit ab263fafbb5ed7c0464e8cfefc2f95095aa3e7cd
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 21:28:34 2010 +0800

    FLASH/NOR: Remove useless file tms470.h
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index d8e6e81..852c0a3 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -38,7 +38,6 @@ noinst_HEADERS = \
 	driver.h \
 	imp.h \
 	non_cfi.h \
-	ocl.h \
-	tms470.h
+	ocl.h
 
 MAINTAINERCLEANFILES = $(srcdir)/Makefile.in
diff --git a/src/flash/nor/tms470.c b/src/flash/nor/tms470.c
index 2f02e5d..4ca6cd8 100644
--- a/src/flash/nor/tms470.c
+++ b/src/flash/nor/tms470.c
@@ -21,7 +21,6 @@
 #include "config.h"
 #endif
 
-#include "tms470.h"
 #include "imp.h"
 
 
@@ -29,6 +28,20 @@
                       Internal Support, Helpers
    ---------------------------------------------------------------------- */
 
+struct tms470_flash_bank
+{
+	unsigned ordinal;
+
+	/* device identification register */
+	uint32_t device_ident_reg;
+	uint32_t silicon_version;
+	uint32_t technology_family;
+	uint32_t rom_flash;
+	uint32_t part_number;
+	char * part_name;
+
+};
+
 static const struct flash_sector TMS470R1A256_SECTORS[] = {
 	{0x00000000, 0x00002000, -1, -1},
 	{0x00002000, 0x00002000, -1, -1},
diff --git a/src/flash/nor/tms470.h b/src/flash/nor/tms470.h
deleted file mode 100644
index ecbfad8..0000000
--- a/src/flash/nor/tms470.h
+++ /dev/null
@@ -1,37 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2007,2008 by Christopher Kilgour                        *
- *   techie |_at_| whiterocker |_dot_| com                                 *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-#ifndef TMS470_DOT_H
-#define TMS470_DOT_H
-
-struct tms470_flash_bank
-{
-	unsigned ordinal;
-
-	/* device identification register */
-	uint32_t device_ident_reg;
-	uint32_t silicon_version;
-	uint32_t technology_family;
-	uint32_t rom_flash;
-	uint32_t part_number;
-	char * part_name;
-
-};
-
-#endif /* TMS470_DOT_H */

commit 29d7031fe34fa489075c6abe74df232cc070fe6e
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 21:25:57 2010 +0800

    FLASH/NOR: Remove useless file str9xpec.h
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index 0976099..d8e6e81 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -39,7 +39,6 @@ noinst_HEADERS = \
 	imp.h \
 	non_cfi.h \
 	ocl.h \
-	str9xpec.h \
 	tms470.h
 
 MAINTAINERCLEANFILES = $(srcdir)/Makefile.in
diff --git a/src/flash/nor/str9xpec.c b/src/flash/nor/str9xpec.c
index f8b705e..18761c2 100644
--- a/src/flash/nor/str9xpec.c
+++ b/src/flash/nor/str9xpec.c
@@ -25,10 +25,59 @@
 #endif
 
 #include "imp.h"
-#include "str9xpec.h"
 #include <target/arm7_9_common.h>
 
 
+/* ISC commands */
+
+#define ISC_IDCODE				0xFE
+#define ISC_MFG_READ			0x4C
+#define ISC_CONFIGURATION		0x07
+#define ISC_ENABLE				0x0C
+#define ISC_DISABLE				0x0F
+#define ISC_NOOP				0x10
+#define ISC_ADDRESS_SHIFT		0x11
+#define ISC_CLR_STATUS			0x13
+#define ISC_PROGRAM				0x20
+#define ISC_PROGRAM_SECURITY	0x22
+#define ISC_PROGRAM_UC			0x23
+#define ISC_ERASE				0x30
+#define ISC_READ				0x50
+#define ISC_BLANK_CHECK			0x60
+
+/* ISC_DEFAULT bit definitions */
+
+#define ISC_STATUS_SECURITY		0x40
+#define ISC_STATUS_INT_ERROR	0x30
+#define ISC_STATUS_MODE			0x08
+#define ISC_STATUS_BUSY			0x04
+#define ISC_STATUS_ERROR		0x03
+
+/* Option bytes definitions */
+
+#define STR9XPEC_OPT_CSMAPBIT		48
+#define STR9XPEC_OPT_LVDTHRESBIT	49
+#define STR9XPEC_OPT_LVDSELBIT		50
+#define STR9XPEC_OPT_LVDWARNBIT		51
+#define STR9XPEC_OPT_OTPBIT			63
+
+enum str9xpec_status_codes
+{
+	STR9XPEC_INVALID_COMMAND = 1,
+	STR9XPEC_ISC_SUCCESS = 2,
+	STR9XPEC_ISC_DISABLED = 3,
+	STR9XPEC_ISC_INTFAIL = 32,
+};
+
+struct str9xpec_flash_controller
+{
+	struct jtag_tap *tap;
+	uint32_t *sector_bits;
+	int chain_pos;
+	int isc_enable;
+	uint8_t options[8];
+};
+
 static int str9xpec_erase_area(struct flash_bank *bank, int first, int last);
 static int str9xpec_set_address(struct flash_bank *bank, uint8_t sector);
 static int str9xpec_write_options(struct flash_bank *bank);
diff --git a/src/flash/nor/str9xpec.h b/src/flash/nor/str9xpec.h
deleted file mode 100644
index 6eecd8a..0000000
--- a/src/flash/nor/str9xpec.h
+++ /dev/null
@@ -1,77 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2005 by Dominic Rath                                    *
- *   Dominic.Rath at gmx.de                                                   *
- *                                                                         *
- *   Copyright (C) 2008 by Spencer Oliver                                  *
- *   spen at spen-soft.co.uk                                                  *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-#ifndef STR9XPEC_H
-#define STR9XPEC_H
-
-
-struct str9xpec_flash_controller
-{
-	struct jtag_tap *tap;
-	uint32_t *sector_bits;
-	int chain_pos;
-	int isc_enable;
-	uint8_t options[8];
-};
-
-enum str9xpec_status_codes
-{
-	STR9XPEC_INVALID_COMMAND = 1,
-	STR9XPEC_ISC_SUCCESS = 2,
-	STR9XPEC_ISC_DISABLED = 3,
-	STR9XPEC_ISC_INTFAIL = 32,
-};
-
-/* ISC commands */
-
-#define ISC_IDCODE				0xFE
-#define ISC_MFG_READ			0x4C
-#define ISC_CONFIGURATION		0x07
-#define ISC_ENABLE				0x0C
-#define ISC_DISABLE				0x0F
-#define ISC_NOOP				0x10
-#define ISC_ADDRESS_SHIFT		0x11
-#define ISC_CLR_STATUS			0x13
-#define ISC_PROGRAM				0x20
-#define ISC_PROGRAM_SECURITY	0x22
-#define ISC_PROGRAM_UC			0x23
-#define ISC_ERASE				0x30
-#define ISC_READ				0x50
-#define ISC_BLANK_CHECK			0x60
-
-/* ISC_DEFAULT bit definitions */
-
-#define ISC_STATUS_SECURITY		0x40
-#define ISC_STATUS_INT_ERROR	0x30
-#define ISC_STATUS_MODE			0x08
-#define ISC_STATUS_BUSY			0x04
-#define ISC_STATUS_ERROR		0x03
-
-/* Option bytes definitions */
-
-#define STR9XPEC_OPT_CSMAPBIT		48
-#define STR9XPEC_OPT_LVDTHRESBIT	49
-#define STR9XPEC_OPT_LVDSELBIT		50
-#define STR9XPEC_OPT_LVDWARNBIT		51
-#define STR9XPEC_OPT_OTPBIT			63
-
-#endif /* STR9XPEC_H */

commit 7bbd6c76838ffc639226897328d8ec7069b1769d
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 21:23:04 2010 +0800

    FLASH/NOR: Remove useless file str9x.h
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index 272b536..0976099 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -39,7 +39,6 @@ noinst_HEADERS = \
 	imp.h \
 	non_cfi.h \
 	ocl.h \
-	str9x.h \
 	str9xpec.h \
 	tms470.h
 
diff --git a/src/flash/nor/str9x.c b/src/flash/nor/str9x.c
index 1e71753..8f8e83c 100644
--- a/src/flash/nor/str9x.c
+++ b/src/flash/nor/str9x.c
@@ -28,11 +28,45 @@
 #endif
 
 #include "imp.h"
-#include "str9x.h"
 #include <target/arm966e.h>
 #include <target/algorithm.h>
 
 
+/* Flash registers */
+
+#define FLASH_BBSR		0x54000000		/* Boot Bank Size Register                */
+#define FLASH_NBBSR		0x54000004		/* Non-Boot Bank Size Register            */
+#define FLASH_BBADR		0x5400000C		/* Boot Bank Base Address Register        */
+#define FLASH_NBBADR	0x54000010		/* Non-Boot Bank Base Address Register    */
+#define FLASH_CR		0x54000018		/* Control Register                       */
+#define FLASH_SR		0x5400001C		/* Status Register                        */
+#define FLASH_BCE5ADDR	0x54000020		/* BC Fifth Entry Target Address Register */
+
+
+struct str9x_flash_bank
+{
+	uint32_t *sector_bits;
+	int variant;
+	int bank1;
+	struct working_area *write_algorithm;
+};
+
+enum str9x_status_codes
+{
+	STR9X_CMD_SUCCESS = 0,
+	STR9X_INVALID_COMMAND = 1,
+	STR9X_SRC_ADDR_ERROR = 2,
+	STR9X_DST_ADDR_ERROR = 3,
+	STR9X_SRC_ADDR_NOT_MAPPED = 4,
+	STR9X_DST_ADDR_NOT_MAPPED = 5,
+	STR9X_COUNT_ERROR = 6,
+	STR9X_INVALID_SECTOR = 7,
+	STR9X_SECTOR_NOT_BLANK = 8,
+	STR9X_SECTOR_NOT_PREPARED = 9,
+	STR9X_COMPARE_ERROR = 10,
+	STR9X_BUSY = 11
+};
+
 static uint32_t bank1start = 0x00080000;
 
 static int str9x_build_block_list(struct flash_bank *bank)
diff --git a/src/flash/nor/str9x.h b/src/flash/nor/str9x.h
deleted file mode 100644
index ba5386f..0000000
--- a/src/flash/nor/str9x.h
+++ /dev/null
@@ -1,60 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2005 by Dominic Rath                                    *
- *   Dominic.Rath at gmx.de                                                   *
- *                                                                         *
- *   Copyright (C) 2008 by Spencer Oliver                                  *
- *   spen at spen-soft.co.uk                                                  *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-#ifndef STR9X_H
-#define STR9X_H
-
-struct str9x_flash_bank
-{
-	uint32_t *sector_bits;
-	int variant;
-	int bank1;
-	struct working_area *write_algorithm;
-};
-
-enum str9x_status_codes
-{
-	STR9X_CMD_SUCCESS = 0,
-	STR9X_INVALID_COMMAND = 1,
-	STR9X_SRC_ADDR_ERROR = 2,
-	STR9X_DST_ADDR_ERROR = 3,
-	STR9X_SRC_ADDR_NOT_MAPPED = 4,
-	STR9X_DST_ADDR_NOT_MAPPED = 5,
-	STR9X_COUNT_ERROR = 6,
-	STR9X_INVALID_SECTOR = 7,
-	STR9X_SECTOR_NOT_BLANK = 8,
-	STR9X_SECTOR_NOT_PREPARED = 9,
-	STR9X_COMPARE_ERROR = 10,
-	STR9X_BUSY = 11
-};
-
-/* Flash registers */
-
-#define FLASH_BBSR		0x54000000		/* Boot Bank Size Register                */
-#define FLASH_NBBSR		0x54000004		/* Non-Boot Bank Size Register            */
-#define FLASH_BBADR		0x5400000C		/* Boot Bank Base Address Register        */
-#define FLASH_NBBADR	0x54000010		/* Non-Boot Bank Base Address Register    */
-#define FLASH_CR		0x54000018		/* Control Register                       */
-#define FLASH_SR		0x5400001C		/* Status Register                        */
-#define FLASH_BCE5ADDR	0x54000020		/* BC Fifth Entry Target Address Register */
-
-#endif /* STR9X_H */

commit d16dbaa0fc7b8a2f40cf9b283f716d2d7344504b
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 21:20:02 2010 +0800

    FLASH/NOR: Remove useless file str7x.h
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index 4170bd0..272b536 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -39,7 +39,6 @@ noinst_HEADERS = \
 	imp.h \
 	non_cfi.h \
 	ocl.h \
-	str7x.h \
 	str9x.h \
 	str9xpec.h \
 	tms470.h
diff --git a/src/flash/nor/str7x.c b/src/flash/nor/str7x.c
index 3a74d35..6136f31 100644
--- a/src/flash/nor/str7x.c
+++ b/src/flash/nor/str7x.c
@@ -28,12 +28,94 @@
 #endif
 
 #include "imp.h"
-#include "str7x.h"
 #include <target/arm.h>
 #include <helper/binarybuffer.h>
 #include <target/algorithm.h>
 
 
+/*  Flash registers */
+
+#define FLASH_CR0		0x00000000
+#define FLASH_CR1		0x00000004
+#define FLASH_DR0		0x00000008
+#define FLASH_DR1		0x0000000C
+#define FLASH_AR		0x00000010
+#define FLASH_ER		0x00000014
+#define FLASH_NVWPAR	0x0000DFB0
+#define FLASH_NVAPR0	0x0000DFB8
+#define FLASH_NVAPR1	0x0000DFBC
+
+/* FLASH_CR0 register bits */
+
+#define FLASH_WMS		0x80000000
+#define FLASH_SUSP		0x40000000
+#define FLASH_WPG		0x20000000
+#define FLASH_DWPG		0x10000000
+#define FLASH_SER		0x08000000
+#define FLASH_SPR		0x01000000
+#define FLASH_BER		0x04000000
+#define FLASH_MER		0x02000000
+#define FLASH_LOCK		0x00000010
+#define FLASH_BSYA1		0x00000004
+#define FLASH_BSYA0		0x00000002
+
+/* FLASH_CR1 register bits */
+
+#define FLASH_B1S		0x02000000
+#define FLASH_B0S		0x01000000
+#define FLASH_B1F1		0x00020000
+#define FLASH_B1F0		0x00010000
+#define FLASH_B0F7		0x00000080
+#define FLASH_B0F6		0x00000040
+#define FLASH_B0F5		0x00000020
+#define FLASH_B0F4		0x00000010
+#define FLASH_B0F3		0x00000008
+#define FLASH_B0F2		0x00000004
+#define FLASH_B0F1		0x00000002
+#define FLASH_B0F0		0x00000001
+
+/* FLASH_ER register bits */
+
+#define FLASH_WPF		0x00000100
+#define FLASH_RESER		0x00000080
+#define FLASH_SEQER		0x00000040
+#define FLASH_10ER		0x00000008
+#define FLASH_PGER		0x00000004
+#define FLASH_ERER		0x00000002
+#define FLASH_ERR		0x00000001
+
+
+struct str7x_flash_bank
+{
+	uint32_t *sector_bits;
+	uint32_t disable_bit;
+	uint32_t busy_bits;
+	uint32_t register_base;
+	struct working_area *write_algorithm;
+};
+
+struct str7x_mem_layout {
+	uint32_t sector_start;
+	uint32_t sector_size;
+	uint32_t sector_bit;
+};
+
+enum str7x_status_codes
+{
+	STR7X_CMD_SUCCESS = 0,
+	STR7X_INVALID_COMMAND = 1,
+	STR7X_SRC_ADDR_ERROR = 2,
+	STR7X_DST_ADDR_ERROR = 3,
+	STR7X_SRC_ADDR_NOT_MAPPED = 4,
+	STR7X_DST_ADDR_NOT_MAPPED = 5,
+	STR7X_COUNT_ERROR = 6,
+	STR7X_INVALID_SECTOR = 7,
+	STR7X_SECTOR_NOT_BLANK = 8,
+	STR7X_SECTOR_NOT_PREPARED = 9,
+	STR7X_COMPARE_ERROR = 10,
+	STR7X_BUSY = 11
+};
+
 static struct str7x_mem_layout mem_layout_str7bank0[] = {
 	{0x00000000, 0x02000, 0x01},
 	{0x00002000, 0x02000, 0x02},
diff --git a/src/flash/nor/str7x.h b/src/flash/nor/str7x.h
deleted file mode 100644
index 77dfee6..0000000
--- a/src/flash/nor/str7x.h
+++ /dev/null
@@ -1,108 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2005 by Dominic Rath                                    *
- *   Dominic.Rath at gmx.de                                                   *
- *                                                                         *
- *   Copyright (C) 2008 by Spencer Oliver                                  *
- *   spen at spen-soft.co.uk                                                  *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-#ifndef STR7X_H
-#define STR7X_H
-
-struct str7x_flash_bank
-{
-	uint32_t *sector_bits;
-	uint32_t disable_bit;
-	uint32_t busy_bits;
-	uint32_t register_base;
-	struct working_area *write_algorithm;
-};
-
-enum str7x_status_codes
-{
-	STR7X_CMD_SUCCESS = 0,
-	STR7X_INVALID_COMMAND = 1,
-	STR7X_SRC_ADDR_ERROR = 2,
-	STR7X_DST_ADDR_ERROR = 3,
-	STR7X_SRC_ADDR_NOT_MAPPED = 4,
-	STR7X_DST_ADDR_NOT_MAPPED = 5,
-	STR7X_COUNT_ERROR = 6,
-	STR7X_INVALID_SECTOR = 7,
-	STR7X_SECTOR_NOT_BLANK = 8,
-	STR7X_SECTOR_NOT_PREPARED = 9,
-	STR7X_COMPARE_ERROR = 10,
-	STR7X_BUSY = 11
-};
-
-/*  Flash registers */
-
-#define FLASH_CR0		0x00000000
-#define FLASH_CR1		0x00000004
-#define FLASH_DR0		0x00000008
-#define FLASH_DR1		0x0000000C
-#define FLASH_AR		0x00000010
-#define FLASH_ER		0x00000014
-#define FLASH_NVWPAR	0x0000DFB0
-#define FLASH_NVAPR0	0x0000DFB8
-#define FLASH_NVAPR1	0x0000DFBC
-
-/* FLASH_CR0 register bits */
-
-#define FLASH_WMS		0x80000000
-#define FLASH_SUSP		0x40000000
-#define FLASH_WPG		0x20000000
-#define FLASH_DWPG		0x10000000
-#define FLASH_SER		0x08000000
-#define FLASH_SPR		0x01000000
-#define FLASH_BER		0x04000000
-#define FLASH_MER		0x02000000
-#define FLASH_LOCK		0x00000010
-#define FLASH_BSYA1		0x00000004
-#define FLASH_BSYA0		0x00000002
-
-/* FLASH_CR1 register bits */
-
-#define FLASH_B1S		0x02000000
-#define FLASH_B0S		0x01000000
-#define FLASH_B1F1		0x00020000
-#define FLASH_B1F0		0x00010000
-#define FLASH_B0F7		0x00000080
-#define FLASH_B0F6		0x00000040
-#define FLASH_B0F5		0x00000020
-#define FLASH_B0F4		0x00000010
-#define FLASH_B0F3		0x00000008
-#define FLASH_B0F2		0x00000004
-#define FLASH_B0F1		0x00000002
-#define FLASH_B0F0		0x00000001
-
-/* FLASH_ER register bits */
-
-#define FLASH_WPF		0x00000100
-#define FLASH_RESER		0x00000080
-#define FLASH_SEQER		0x00000040
-#define FLASH_10ER		0x00000008
-#define FLASH_PGER		0x00000004
-#define FLASH_ERER		0x00000002
-#define FLASH_ERR		0x00000001
-
-struct str7x_mem_layout {
-	uint32_t sector_start;
-	uint32_t sector_size;
-	uint32_t sector_bit;
-};
-
-#endif /* STR7X_H */

commit 5d09972931e55c4d2bba7471df9c725f5bebc18c
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 21:16:23 2010 +0800

    FLASH/NOR: Remove useless file stm32x.h
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index e7a8424..4170bd0 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -39,7 +39,6 @@ noinst_HEADERS = \
 	imp.h \
 	non_cfi.h \
 	ocl.h \
-	stm32x.h \
 	str7x.h \
 	str9x.h \
 	str9xpec.h \
diff --git a/src/flash/nor/stm32x.c b/src/flash/nor/stm32x.c
index 7779ea3..0edadfd 100644
--- a/src/flash/nor/stm32x.c
+++ b/src/flash/nor/stm32x.c
@@ -25,12 +25,85 @@
 #endif
 
 #include "imp.h"
-#include "stm32x.h"
 #include <helper/binarybuffer.h>
 #include <target/algorithm.h>
 #include <target/armv7m.h>
 
 
+/* stm32x register locations */
+
+#define STM32_FLASH_ACR		0x40022000
+#define STM32_FLASH_KEYR	0x40022004
+#define STM32_FLASH_OPTKEYR	0x40022008
+#define STM32_FLASH_SR		0x4002200C
+#define STM32_FLASH_CR		0x40022010
+#define STM32_FLASH_AR		0x40022014
+#define STM32_FLASH_OBR		0x4002201C
+#define STM32_FLASH_WRPR	0x40022020
+
+/* option byte location */
+
+#define STM32_OB_RDP		0x1FFFF800
+#define STM32_OB_USER		0x1FFFF802
+#define STM32_OB_DATA0		0x1FFFF804
+#define STM32_OB_DATA1		0x1FFFF806
+#define STM32_OB_WRP0		0x1FFFF808
+#define STM32_OB_WRP1		0x1FFFF80A
+#define STM32_OB_WRP2		0x1FFFF80C
+#define STM32_OB_WRP3		0x1FFFF80E
+
+/* FLASH_CR register bits */
+
+#define FLASH_PG		(1 << 0)
+#define FLASH_PER		(1 << 1)
+#define FLASH_MER		(1 << 2)
+#define FLASH_OPTPG		(1 << 4)
+#define FLASH_OPTER		(1 << 5)
+#define FLASH_STRT		(1 << 6)
+#define FLASH_LOCK		(1 << 7)
+#define FLASH_OPTWRE	(1 << 9)
+
+/* FLASH_SR register bits */
+
+#define FLASH_BSY		(1 << 0)
+#define FLASH_PGERR		(1 << 2)
+#define FLASH_WRPRTERR	(1 << 4)
+#define FLASH_EOP		(1 << 5)
+
+/* STM32_FLASH_OBR bit definitions (reading) */
+
+#define OPT_ERROR		0
+#define OPT_READOUT		1
+#define OPT_RDWDGSW		2
+#define OPT_RDRSTSTOP	3
+#define OPT_RDRSTSTDBY	4
+
+/* register unlock keys */
+
+#define KEY1			0x45670123
+#define KEY2			0xCDEF89AB
+
+
+struct stm32x_options
+{
+	uint16_t RDP;
+	uint16_t user_options;
+	uint16_t protection[4];
+};
+
+struct stm32x_flash_bank
+{
+	struct stm32x_options option_bytes;
+	struct working_area *write_algorithm;
+	int ppage_size;
+	int probed;
+};
+
+struct stm32x_mem_layout {
+	uint32_t sector_start;
+	uint32_t sector_size;
+};
+
 static int stm32x_mass_erase(struct flash_bank *bank);
 
 /* flash bank stm32x <base> <size> 0 0 <target#>
diff --git a/src/flash/nor/stm32x.h b/src/flash/nor/stm32x.h
deleted file mode 100644
index fcf895c..0000000
--- a/src/flash/nor/stm32x.h
+++ /dev/null
@@ -1,99 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2005 by Dominic Rath                                    *
- *   Dominic.Rath at gmx.de                                                   *
- *                                                                         *
- *   Copyright (C) 2008 by Spencer Oliver                                  *
- *   spen at spen-soft.co.uk                                                  *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-#ifndef STM32X_H
-#define STM32X_H
-
-struct stm32x_options
-{
-	uint16_t RDP;
-	uint16_t user_options;
-	uint16_t protection[4];
-};
-
-struct stm32x_flash_bank
-{
-	struct stm32x_options option_bytes;
-	struct working_area *write_algorithm;
-	int ppage_size;
-	int probed;
-};
-
-/* stm32x register locations */
-
-#define STM32_FLASH_ACR		0x40022000
-#define STM32_FLASH_KEYR	0x40022004
-#define STM32_FLASH_OPTKEYR	0x40022008
-#define STM32_FLASH_SR		0x4002200C
-#define STM32_FLASH_CR		0x40022010
-#define STM32_FLASH_AR		0x40022014
-#define STM32_FLASH_OBR		0x4002201C
-#define STM32_FLASH_WRPR	0x40022020
-
-/* option byte location */
-
-#define STM32_OB_RDP		0x1FFFF800
-#define STM32_OB_USER		0x1FFFF802
-#define STM32_OB_DATA0		0x1FFFF804
-#define STM32_OB_DATA1		0x1FFFF806
-#define STM32_OB_WRP0		0x1FFFF808
-#define STM32_OB_WRP1		0x1FFFF80A
-#define STM32_OB_WRP2		0x1FFFF80C
-#define STM32_OB_WRP3		0x1FFFF80E
-
-/* FLASH_CR register bits */
-
-#define FLASH_PG		(1 << 0)
-#define FLASH_PER		(1 << 1)
-#define FLASH_MER		(1 << 2)
-#define FLASH_OPTPG		(1 << 4)
-#define FLASH_OPTER		(1 << 5)
-#define FLASH_STRT		(1 << 6)
-#define FLASH_LOCK		(1 << 7)
-#define FLASH_OPTWRE	(1 << 9)
-
-/* FLASH_SR register bits */
-
-#define FLASH_BSY		(1 << 0)
-#define FLASH_PGERR		(1 << 2)
-#define FLASH_WRPRTERR	(1 << 4)
-#define FLASH_EOP		(1 << 5)
-
-/* STM32_FLASH_OBR bit definitions (reading) */
-
-#define OPT_ERROR		0
-#define OPT_READOUT		1
-#define OPT_RDWDGSW		2
-#define OPT_RDRSTSTOP	3
-#define OPT_RDRSTSTDBY	4
-
-/* register unlock keys */
-
-#define KEY1			0x45670123
-#define KEY2			0xCDEF89AB
-
-struct stm32x_mem_layout {
-	uint32_t sector_start;
-	uint32_t sector_size;
-};
-
-#endif /* STM32X_H */

commit f1f8d9a6c9b1fd35d79627b568faa2409f13311f
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 21:12:37 2010 +0800

    FLASH/NOR: Remove useless file stellaris.h
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index ee8d993..e7a8424 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -39,7 +39,6 @@ noinst_HEADERS = \
 	imp.h \
 	non_cfi.h \
 	ocl.h \
-	stellaris.h \
 	stm32x.h \
 	str7x.h \
 	str9x.h \
diff --git a/src/flash/nor/stellaris.c b/src/flash/nor/stellaris.c
index 069ee8c..12ea15b 100644
--- a/src/flash/nor/stellaris.c
+++ b/src/flash/nor/stellaris.c
@@ -29,16 +29,100 @@
 #endif
 
 #include "imp.h"
-#include "stellaris.h"
 #include <target/algorithm.h>
 #include <target/armv7m.h>
 
 
 #define DID0_VER(did0) ((did0 >> 28)&0x07)
 
+/* STELLARIS control registers */
+#define SCB_BASE	0x400FE000
+#define DID0		0x000
+#define DID1		0x004
+#define DC0			0x008
+#define DC1			0x010
+#define DC2			0x014
+#define DC3			0x018
+#define DC4			0x01C
+
+#define RIS			0x050
+#define RCC			0x060
+#define PLLCFG		0x064
+#define RCC2		0x070
+#define NVMSTAT		0x1a0
+
+/* "legacy" flash memory protection registers (64KB max) */
+#define FMPRE		0x130
+#define FMPPE		0x134
+
+/* new flash memory protection registers (for more than 64KB) */
+#define FMPRE0		0x200		/* PRE1 = PRE0 + 4, etc */
+#define FMPPE0		0x400		/* PPE1 = PPE0 + 4, etc */
+
+#define USECRL		0x140
+
+#define FLASH_CONTROL_BASE	0x400FD000
+#define FLASH_FMA	(FLASH_CONTROL_BASE | 0x000)
+#define FLASH_FMD	(FLASH_CONTROL_BASE | 0x004)
+#define FLASH_FMC	(FLASH_CONTROL_BASE | 0x008)
+#define FLASH_CRIS	(FLASH_CONTROL_BASE | 0x00C)
+#define FLASH_CIM	(FLASH_CONTROL_BASE | 0x010)
+#define FLASH_MISC	(FLASH_CONTROL_BASE | 0x014)
+
+#define AMISC	1
+#define PMISC	2
+
+#define AMASK	1
+#define PMASK	2
+
+/* Flash Controller Command bits */
+#define FMC_WRKEY	(0xA442 << 16)
+#define FMC_COMT	(1 << 3)
+#define FMC_MERASE	(1 << 2)
+#define FMC_ERASE	(1 << 1)
+#define FMC_WRITE	(1 << 0)
+
+/* STELLARIS constants */
+
+/* values to write in FMA to commit write-"once" values */
+#define FLASH_FMA_PRE(x)	(2 * (x))	/* for FMPPREx */
+#define FLASH_FMA_PPE(x)	(2 * (x) + 1)	/* for FMPPPEx */
+
+
 static void stellaris_read_clock_info(struct flash_bank *bank);
 static int stellaris_mass_erase(struct flash_bank *bank);
 
+struct stellaris_flash_bank
+{
+	/* chip id register */
+	uint32_t did0;
+	uint32_t did1;
+	uint32_t dc0;
+	uint32_t dc1;
+
+	char * target_name;
+
+	uint32_t sramsiz;
+	uint32_t flshsz;
+	/* flash geometry */
+	uint32_t num_pages;
+	uint32_t pagesize;
+	uint32_t pages_in_lockregion;
+
+	/* nv memory bits */
+	uint16_t num_lockbits;
+
+	/* main clock status */
+	uint32_t rcc;
+	uint32_t rcc2;
+	uint8_t  mck_valid;
+	uint8_t  xtal_mask;
+	uint32_t iosc_freq;
+	uint32_t mck_freq;
+	const char *iosc_desc;
+	const char *mck_desc;
+};
+
 static struct {
 	uint32_t partno;
 	char *partname;
diff --git a/src/flash/nor/stellaris.h b/src/flash/nor/stellaris.h
deleted file mode 100644
index a469323..0000000
--- a/src/flash/nor/stellaris.h
+++ /dev/null
@@ -1,107 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2006 by Magnus Lundin                                   *
- *   lundin at mlu.mine.nu                                                    *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-#ifndef STELLARIS_FLASH_H
-#define STELLARIS_FLASH_H
-
-struct stellaris_flash_bank
-{
-	/* chip id register */
-	uint32_t did0;
-	uint32_t did1;
-	uint32_t dc0;
-	uint32_t dc1;
-
-	char * target_name;
-
-	uint32_t sramsiz;
-	uint32_t flshsz;
-	/* flash geometry */
-	uint32_t num_pages;
-	uint32_t pagesize;
-	uint32_t pages_in_lockregion;
-
-	/* nv memory bits */
-	uint16_t num_lockbits;
-
-	/* main clock status */
-	uint32_t rcc;
-	uint32_t rcc2;
-	uint8_t  mck_valid;
-	uint8_t  xtal_mask;
-	uint32_t iosc_freq;
-	uint32_t mck_freq;
-	const char *iosc_desc;
-	const char *mck_desc;
-};
-
-/* STELLARIS control registers */
-#define SCB_BASE	0x400FE000
-#define DID0		0x000
-#define DID1		0x004
-#define DC0			0x008
-#define DC1			0x010
-#define DC2			0x014
-#define DC3			0x018
-#define DC4			0x01C
-
-#define RIS			0x050
-#define RCC			0x060
-#define PLLCFG		0x064
-#define RCC2		0x070
-#define NVMSTAT		0x1a0
-
-/* "legacy" flash memory protection registers (64KB max) */
-#define FMPRE		0x130
-#define FMPPE		0x134
-
-/* new flash memory protection registers (for more than 64KB) */
-#define FMPRE0		0x200		/* PRE1 = PRE0 + 4, etc */
-#define FMPPE0		0x400		/* PPE1 = PPE0 + 4, etc */
-
-#define USECRL		0x140
-
-#define FLASH_CONTROL_BASE	0x400FD000
-#define FLASH_FMA	(FLASH_CONTROL_BASE | 0x000)
-#define FLASH_FMD	(FLASH_CONTROL_BASE | 0x004)
-#define FLASH_FMC	(FLASH_CONTROL_BASE | 0x008)
-#define FLASH_CRIS	(FLASH_CONTROL_BASE | 0x00C)
-#define FLASH_CIM	(FLASH_CONTROL_BASE | 0x010)
-#define FLASH_MISC	(FLASH_CONTROL_BASE | 0x014)
-
-#define AMISC	1
-#define PMISC	2
-
-#define AMASK	1
-#define PMASK	2
-
-/* Flash Controller Command bits */
-#define FMC_WRKEY	(0xA442 << 16)
-#define FMC_COMT	(1 << 3)
-#define FMC_MERASE	(1 << 2)
-#define FMC_ERASE	(1 << 1)
-#define FMC_WRITE	(1 << 0)
-
-/* STELLARIS constants */
-
-/* values to write in FMA to commit write-"once" values */
-#define FLASH_FMA_PRE(x)	(2 * (x))	/* for FMPPREx */
-#define FLASH_FMA_PPE(x)	(2 * (x) + 1)	/* for FMPPPEx */
-
-#endif /* STELLARIS_H */

commit f5ae179519d578169b4123af89eebf667efa1e2c
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 21:04:37 2010 +0800

    FLASH/NOR: Remove useless file pic32mx.h
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index 8042886..ee8d993 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -39,7 +39,6 @@ noinst_HEADERS = \
 	imp.h \
 	non_cfi.h \
 	ocl.h \
-	pic32mx.h \
 	stellaris.h \
 	stm32x.h \
 	str7x.h \
diff --git a/src/flash/nor/pic32mx.c b/src/flash/nor/pic32mx.c
index 6e51f1a..4b8d027 100644
--- a/src/flash/nor/pic32mx.c
+++ b/src/flash/nor/pic32mx.c
@@ -28,11 +28,75 @@
 #endif
 
 #include "imp.h"
-#include "pic32mx.h"
 #include <target/algorithm.h>
 #include <target/mips32.h>
 #include <target/mips_m4k.h>
 
+
+#define PIC32MX_MANUF_ID	0x029
+
+/* pic32mx memory locations */
+
+#define PIC32MX_PHYS_RAM			0x00000000
+#define PIC32MX_PHYS_PGM_FLASH		0x1D000000
+#define PIC32MX_PHYS_PERIPHERALS	0x1F800000
+#define PIC32MX_PHYS_BOOT_FLASH		0x1FC00000
+
+/*
+ * Translate Virtual and Physical addresses.
+ * Note: These macros only work for KSEG0/KSEG1 addresses.
+ */
+
+#define Virt2Phys(v) 	((v) & 0x1FFFFFFF)
+
+/* pic32mx configuration register locations */
+
+#define PIC32MX_DEVCFG0		0xBFC02FFC
+#define PIC32MX_DEVCFG1		0xBFC02FF8
+#define PIC32MX_DEVCFG2		0xBFC02FF4
+#define PIC32MX_DEVCFG3		0xBFC02FF0
+#define PIC32MX_DEVID		0xBF80F220
+
+#define PIC32MX_BMXPFMSZ	0xBF882060
+#define PIC32MX_BMXBOOTSZ	0xBF882070
+#define PIC32MX_BMXDRMSZ	0xBF882040
+
+/* pic32mx flash controller register locations */
+
+#define PIC32MX_NVMCON		0xBF80F400
+#define PIC32MX_NVMCONCLR	0xBF80F404
+#define PIC32MX_NVMCONSET	0xBF80F408
+#define PIC32MX_NVMCONINV	0xBF80F40C
+#define NVMCON_NVMWR		(1 << 15)
+#define NVMCON_NVMWREN		(1 << 14)
+#define NVMCON_NVMERR		(1 << 13)
+#define NVMCON_LVDERR		(1 << 12)
+#define NVMCON_LVDSTAT		(1 << 11)
+#define NVMCON_OP_PFM_ERASE		0x5
+#define NVMCON_OP_PAGE_ERASE	0x4
+#define NVMCON_OP_ROW_PROG		0x3
+#define NVMCON_OP_WORD_PROG		0x1
+#define NVMCON_OP_NOP			0x0
+
+#define PIC32MX_NVMKEY		0xBF80F410
+#define PIC32MX_NVMADDR		0xBF80F420
+#define PIC32MX_NVMADDRCLR	0xBF80F424
+#define PIC32MX_NVMADDRSET	0xBF80F428
+#define PIC32MX_NVMADDRINV	0xBF80F42C
+#define PIC32MX_NVMDATA		0xBF80F430
+#define PIC32MX_NVMSRCADDR	0xBF80F440
+
+/* flash unlock keys */
+
+#define NVMKEY1			0xAA996655
+#define NVMKEY2			0x556699AA
+
+struct pic32mx_flash_bank
+{
+	struct working_area *write_algorithm;
+	int probed;
+};
+
 static const struct pic32mx_devs_s {
 	uint8_t	devid;
 	char *name;
diff --git a/src/flash/nor/pic32mx.h b/src/flash/nor/pic32mx.h
deleted file mode 100644
index 79fa40e..0000000
--- a/src/flash/nor/pic32mx.h
+++ /dev/null
@@ -1,94 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2005 by Dominic Rath                                    *
- *   Dominic.Rath at gmx.de                                                   *
- *                                                                         *
- *   Copyright (C) 2008 by Spencer Oliver                                  *
- *   spen at spen-soft.co.uk                                                  *
- *                                                                         *
- *   Copyright (C) 2008 by John McCarthy                                   *
- *   jgmcc at magma.ca                                                        *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-#ifndef PIC32MX_H
-#define PIC32MX_H
-
-struct pic32mx_flash_bank
-{
-	struct working_area *write_algorithm;
-	int probed;
-};
-
-#define PIC32MX_MANUF_ID	0x029
-
-/* pic32mx memory locations */
-
-#define PIC32MX_PHYS_RAM			0x00000000
-#define PIC32MX_PHYS_PGM_FLASH		0x1D000000
-#define PIC32MX_PHYS_PERIPHERALS	0x1F800000
-#define PIC32MX_PHYS_BOOT_FLASH		0x1FC00000
-
-/*
- * Translate Virtual and Physical addresses.
- * Note: These macros only work for KSEG0/KSEG1 addresses.
- */
-
-#define Virt2Phys(v) 	((v) & 0x1FFFFFFF)
-
-/* pic32mx configuration register locations */
-
-#define PIC32MX_DEVCFG0		0xBFC02FFC
-#define PIC32MX_DEVCFG1		0xBFC02FF8
-#define PIC32MX_DEVCFG2		0xBFC02FF4
-#define PIC32MX_DEVCFG3		0xBFC02FF0
-#define PIC32MX_DEVID		0xBF80F220
-
-#define PIC32MX_BMXPFMSZ	0xBF882060
-#define PIC32MX_BMXBOOTSZ	0xBF882070
-#define PIC32MX_BMXDRMSZ	0xBF882040
-
-/* pic32mx flash controller register locations */
-
-#define PIC32MX_NVMCON		0xBF80F400
-#define PIC32MX_NVMCONCLR	0xBF80F404
-#define PIC32MX_NVMCONSET	0xBF80F408
-#define PIC32MX_NVMCONINV	0xBF80F40C
-#define NVMCON_NVMWR		(1 << 15)
-#define NVMCON_NVMWREN		(1 << 14)
-#define NVMCON_NVMERR		(1 << 13)
-#define NVMCON_LVDERR		(1 << 12)
-#define NVMCON_LVDSTAT		(1 << 11)
-#define NVMCON_OP_PFM_ERASE		0x5
-#define NVMCON_OP_PAGE_ERASE	0x4
-#define NVMCON_OP_ROW_PROG		0x3
-#define NVMCON_OP_WORD_PROG		0x1
-#define NVMCON_OP_NOP			0x0
-
-#define PIC32MX_NVMKEY		0xBF80F410
-#define PIC32MX_NVMADDR		0xBF80F420
-#define PIC32MX_NVMADDRCLR	0xBF80F424
-#define PIC32MX_NVMADDRSET	0xBF80F428
-#define PIC32MX_NVMADDRINV	0xBF80F42C
-#define PIC32MX_NVMDATA		0xBF80F430
-#define PIC32MX_NVMSRCADDR	0xBF80F440
-
-/* flash unlock keys */
-
-#define NVMKEY1			0xAA996655
-#define NVMKEY2			0x556699AA
-
-#endif /* PIC32MX_H */
-

commit 4cc359794420dbe0aedba38bde0ee4d871cdb354
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 21:00:25 2010 +0800

    FLASH/NOR: Remove useless file lpc288x.h
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index 7d11bcd..8042886 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -37,7 +37,6 @@ noinst_HEADERS = \
 	cfi.h \
 	driver.h \
 	imp.h \
-	lpc288x.h \
 	non_cfi.h \
 	ocl.h \
 	pic32mx.h \
diff --git a/src/flash/nor/lpc288x.c b/src/flash/nor/lpc288x.c
index b6d207e..d8cecc0 100644
--- a/src/flash/nor/lpc288x.c
+++ b/src/flash/nor/lpc288x.c
@@ -32,7 +32,6 @@
 #endif
 
 #include "imp.h"
-#include "lpc288x.h"
 #include <helper/binarybuffer.h>
 
 
@@ -85,6 +84,19 @@
 /* F_CLK_TIME */
 #define FCT_CLK_DIV_MASK    0x0FFF
 
+struct lpc288x_flash_bank
+{
+	uint32_t working_area;
+	uint32_t working_area_size;
+
+	/* chip id register */
+	uint32_t cidr;
+	char * target_name;
+	uint32_t cclk;
+
+	uint32_t sector_size_break;
+};
+
 static uint32_t lpc288x_wait_status_busy(struct flash_bank *bank, int timeout);
 static void lpc288x_load_timer(int erase, struct target *target);
 static void lpc288x_set_flash_clk(struct flash_bank *bank);
diff --git a/src/flash/nor/lpc288x.h b/src/flash/nor/lpc288x.h
deleted file mode 100644
index cd5fb73..0000000
--- a/src/flash/nor/lpc288x.h
+++ /dev/null
@@ -1,37 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2008 by			                                       *
- *   Karl RobinSod <karl.robinsod at gmail.com>                               *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-
-#ifndef lpc288x_H
-#define lpc288x_H
-
-struct lpc288x_flash_bank
-{
-	uint32_t working_area;
-	uint32_t working_area_size;
-
-	/* chip id register */
-	uint32_t cidr;
-	char * target_name;
-	uint32_t cclk;
-
-	uint32_t sector_size_break;
-};
-
-#endif /* lpc288x_H */

commit fb7c70980427e7f91ece27880b411a0489145a4d
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 20:55:40 2010 +0800

    FLASH/NOR: Remove useless file lpc2000.h
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index 2964d64..7d11bcd 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -37,7 +37,6 @@ noinst_HEADERS = \
 	cfi.h \
 	driver.h \
 	imp.h \
-	lpc2000.h \
 	lpc288x.h \
 	non_cfi.h \
 	ocl.h \
diff --git a/src/flash/nor/lpc2000.c b/src/flash/nor/lpc2000.c
index 0930d62..14d0e44 100644
--- a/src/flash/nor/lpc2000.c
+++ b/src/flash/nor/lpc2000.c
@@ -26,7 +26,6 @@
 #endif
 
 #include "imp.h"
-#include "lpc2000.h"
 #include <helper/binarybuffer.h>
 #include <target/algorithm.h>
 #include <target/arm_opcodes.h>
@@ -63,6 +62,51 @@
  * - 176x (tested with LPC1768)
  */
 
+typedef enum
+{
+	lpc2000_v1,
+	lpc2000_v2,
+	lpc1700
+} lpc2000_variant;
+
+struct lpc2000_flash_bank
+{
+	lpc2000_variant variant;
+	struct working_area *iap_working_area;
+	uint32_t cclk;
+	int cmd51_dst_boundary;
+	int cmd51_can_256b;
+	int cmd51_can_8192b;
+	int calc_checksum;
+	uint32_t cmd51_max_buffer;
+	int checksum_vector;
+};
+
+enum lpc2000_status_codes
+{
+	LPC2000_CMD_SUCCESS = 0,
+	LPC2000_INVALID_COMMAND = 1,
+	LPC2000_SRC_ADDR_ERROR = 2,
+	LPC2000_DST_ADDR_ERROR = 3,
+	LPC2000_SRC_ADDR_NOT_MAPPED = 4,
+	LPC2000_DST_ADDR_NOT_MAPPED = 5,
+	LPC2000_COUNT_ERROR = 6,
+	LPC2000_INVALID_SECTOR = 7,
+	LPC2000_SECTOR_NOT_BLANK = 8,
+	LPC2000_SECTOR_NOT_PREPARED = 9,
+	LPC2000_COMPARE_ERROR = 10,
+	LPC2000_BUSY = 11,
+	LPC2000_PARAM_ERROR = 12,
+	LPC2000_ADDR_ERROR = 13,
+	LPC2000_ADDR_NOT_MAPPED = 14,
+	LPC2000_CMD_NOT_LOCKED = 15,
+	LPC2000_INVALID_CODE = 16,
+	LPC2000_INVALID_BAUD_RATE = 17,
+	LPC2000_INVALID_STOP_BIT = 18,
+	LPC2000_CRP_ENABLED = 19
+
+};
+
 static int lpc2000_build_sector_list(struct flash_bank *bank)
 {
 	struct lpc2000_flash_bank *lpc2000_info = bank->driver_priv;
diff --git a/src/flash/nor/lpc2000.h b/src/flash/nor/lpc2000.h
deleted file mode 100644
index f1f90e7..0000000
--- a/src/flash/nor/lpc2000.h
+++ /dev/null
@@ -1,71 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2005 by Dominic Rath                                    *
- *   Dominic.Rath at gmx.de                                                   *
- *                                                                         *
- *   LPC1700 support Copyright (C) 2009 by Audrius Urmanavicius            *
- *   didele.deze at gmail.com                                                 *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-#ifndef LPC2000_H
-#define LPC2000_H
-
-typedef enum
-{
-	lpc2000_v1,
-	lpc2000_v2,
-	lpc1700
-} lpc2000_variant;
-
-struct lpc2000_flash_bank
-{
-	lpc2000_variant variant;
-	struct working_area *iap_working_area;
-	uint32_t cclk;
-	int cmd51_dst_boundary;
-	int cmd51_can_256b;
-	int cmd51_can_8192b;
-	int calc_checksum;
-	uint32_t cmd51_max_buffer;
-	int checksum_vector;
-};
-
-enum lpc2000_status_codes
-{
-	LPC2000_CMD_SUCCESS = 0,
-	LPC2000_INVALID_COMMAND = 1,
-	LPC2000_SRC_ADDR_ERROR = 2,
-	LPC2000_DST_ADDR_ERROR = 3,
-	LPC2000_SRC_ADDR_NOT_MAPPED = 4,
-	LPC2000_DST_ADDR_NOT_MAPPED = 5,
-	LPC2000_COUNT_ERROR = 6,
-	LPC2000_INVALID_SECTOR = 7,
-	LPC2000_SECTOR_NOT_BLANK = 8,
-	LPC2000_SECTOR_NOT_PREPARED = 9,
-	LPC2000_COMPARE_ERROR = 10,
-	LPC2000_BUSY = 11,
-	LPC2000_PARAM_ERROR = 12,
-	LPC2000_ADDR_ERROR = 13,
-	LPC2000_ADDR_NOT_MAPPED = 14,
-	LPC2000_CMD_NOT_LOCKED = 15,
-	LPC2000_INVALID_CODE = 16,
-	LPC2000_INVALID_BAUD_RATE = 17,
-	LPC2000_INVALID_STOP_BIT = 18,
-	LPC2000_CRP_ENABLED = 19
-
-};
-
-#endif /* LPC2000_H */

commit 28bbe4e98337948e814e40cebe69f7958a48e560
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 18:01:07 2010 +0800

    FLASH/NOR: Remove useless file avrf.h
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index b008d75..2964d64 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -33,7 +33,6 @@ NOR_DRIVERS = \
 	virtual.c
 
 noinst_HEADERS = \
-	avrf.h \
 	core.h \
 	cfi.h \
 	driver.h \
diff --git a/src/flash/nor/avrf.c b/src/flash/nor/avrf.c
index 4dc7c23..5a2482e 100644
--- a/src/flash/nor/avrf.c
+++ b/src/flash/nor/avrf.c
@@ -22,7 +22,6 @@
 #endif
 
 #include "imp.h"
-#include "avrf.h"
 #include <target/avrt.h>
 
 
@@ -50,6 +49,22 @@
 #define AVR_JTAG_REG_ProgrammingCommand_Len			15
 #define AVR_JTAG_REG_FlashDataByte_Len				16
 
+struct avrf_type
+{
+	char name[15];
+	uint16_t chip_id;
+	int flash_page_size;
+	int flash_page_num;
+	int eeprom_page_size;
+	int eeprom_page_num;
+};
+
+struct avrf_flash_bank
+{
+	int ppage_size;
+	int probed;
+};
+
 static struct avrf_type avft_chips_info[] =
 {
 /*	name, chip_id,	flash_page_size, flash_page_num,
diff --git a/src/flash/nor/avrf.h b/src/flash/nor/avrf.h
deleted file mode 100644
index 1a69e86..0000000
--- a/src/flash/nor/avrf.h
+++ /dev/null
@@ -1,39 +0,0 @@
-/***************************************************************************
- *   Copyright (C) 2009 by Simon Qian                                      *
- *   SimonQian at SimonQian.com                                               *
- *                                                                         *
- *   This program is free software; you can redistribute it and/or modify  *
- *   it under the terms of the GNU General Public License as published by  *
- *   the Free Software Foundation; either version 2 of the License, or     *
- *   (at your option) any later version.                                   *
- *                                                                         *
- *   This program is distributed in the hope that it will be useful,       *
- *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
- *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
- *   GNU General Public License for more details.                          *
- *                                                                         *
- *   You should have received a copy of the GNU General Public License     *
- *   along with this program; if not, write to the                         *
- *   Free Software Foundation, Inc.,                                       *
- *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
- ***************************************************************************/
-#ifndef AVRF_H
-#define AVRF_H
-
-struct avrf_type
-{
-	char name[15];
-	uint16_t chip_id;
-	int flash_page_size;
-	int flash_page_num;
-	int eeprom_page_size;
-	int eeprom_page_num;
-};
-
-struct avrf_flash_bank
-{
-	int ppage_size;
-	int probed;
-};
-
-#endif /* AVRF_H */

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/Makefile.am |   12 +-----
 src/flash/nor/avrf.c      |   17 +++++++-
 src/flash/nor/avrf.h      |   39 ----------------
 src/flash/nor/lpc2000.c   |   46 +++++++++++++++++++-
 src/flash/nor/lpc2000.h   |   71 -----------------------------
 src/flash/nor/lpc288x.c   |   14 +++++-
 src/flash/nor/lpc288x.h   |   37 ---------------
 src/flash/nor/pic32mx.c   |   66 +++++++++++++++++++++++++++-
 src/flash/nor/pic32mx.h   |   94 ---------------------------------------
 src/flash/nor/stellaris.c |   86 +++++++++++++++++++++++++++++++++++-
 src/flash/nor/stellaris.h |  107 --------------------------------------------
 src/flash/nor/stm32x.c    |   75 +++++++++++++++++++++++++++++++-
 src/flash/nor/stm32x.h    |   99 -----------------------------------------
 src/flash/nor/str7x.c     |   84 ++++++++++++++++++++++++++++++++++-
 src/flash/nor/str7x.h     |  108 ---------------------------------------------
 src/flash/nor/str9x.c     |   36 ++++++++++++++-
 src/flash/nor/str9x.h     |   60 -------------------------
 src/flash/nor/str9xpec.c  |   51 +++++++++++++++++++++-
 src/flash/nor/str9xpec.h  |   77 --------------------------------
 src/flash/nor/tms470.c    |   15 ++++++-
 src/flash/nor/tms470.h    |   37 ---------------
 21 files changed, 481 insertions(+), 750 deletions(-)
 delete mode 100644 src/flash/nor/avrf.h
 delete mode 100644 src/flash/nor/lpc2000.h
 delete mode 100644 src/flash/nor/lpc288x.h
 delete mode 100644 src/flash/nor/pic32mx.h
 delete mode 100644 src/flash/nor/stellaris.h
 delete mode 100644 src/flash/nor/stm32x.h
 delete mode 100644 src/flash/nor/str7x.h
 delete mode 100644 src/flash/nor/str9x.h
 delete mode 100644 src/flash/nor/str9xpec.h
 delete mode 100644 src/flash/nor/tms470.h


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Fri Nov 19 10:10:19 2010
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Fri, 19 Nov 2010 09:10:19 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-610-gc40571e
Message-ID: <E1PJMz6-00048N-6u@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  c40571e6b9c2f4b181e289dbac2366569f128828 (commit)
       via  8c0c259ed64a7a182c82edfca9809cfe33cb96ce (commit)
       via  d80fca527a6618595a118381a2cd2a569f85889f (commit)
       via  838cd58e24a18102b8a140df9fa993fe65706828 (commit)
      from  ab263fafbb5ed7c0464e8cfefc2f95095aa3e7cd (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit c40571e6b9c2f4b181e289dbac2366569f128828
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Fri Nov 19 09:08:09 2010 +0000

    build: update bootstrap comments
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/bootstrap b/bootstrap
index 81c9804..3452a31 100755
--- a/bootstrap
+++ b/bootstrap
@@ -28,14 +28,10 @@ automake --gnu --add-missing --copy
 # otherwise the documentation will fail to build due to missing version.texi
 echo "Bootstrap complete. Quick start build instructions:"
 echo "" 
-echo "1. Build Jim Tcl"
+echo "1. Fetch Jim Tcl"
 echo ""
 echo "git submodule init"
 echo "git submodule update"
-echo "cd jimtcl"
-echo "./configure --with-jim-ext=nvp"
-echo "make"
-echo "make install"
 echo ""
 echo "2. Configure"
 echo "./configure --enable-maintainer-mode ...."

commit 8c0c259ed64a7a182c82edfca9809cfe33cb96ce
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Fri Nov 19 09:07:43 2010 +0000

    build: prepend --with-jim-ext=nvp to jimtcl configure
    
    This allows us to add options to jimtcl configure.
    The default autoconf AC_CONFIG_SUBDIRS does not currently support this.
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/config_subdir.m4 b/config_subdir.m4
new file mode 100644
index 0000000..f32bc89
--- /dev/null
+++ b/config_subdir.m4
@@ -0,0 +1,27 @@
+dnl
+dnl If needed, define the m4_ifblank and m4_ifnblank macros from autoconf 2.64
+dnl This allows us to run with earlier Autoconfs as well.
+ifdef([m4_ifblank],[],[
+m4_define([m4_ifblank],
+[m4_if(m4_translit([[$1]],  [ ][	][
+]), [], [$2], [$3])])])
+dnl
+ifdef([m4_ifnblank],[],[
+m4_define([m4_ifnblank],
+[m4_if(m4_translit([[$1]],  [ ][	][
+]), [], [$3], [$2])])])
+dnl
+
+dnl AC_CONFIG_SUBDIRS does not allow configure options to be passed
+dnl to subdirs, this function allows that by creating a configure.gnu
+dnl script that prepends configure options and then calls the real
+dnl configure script
+AC_DEFUN([AX_CONFIG_SUBDIR_OPTION],
+[
+AC_CONFIG_SUBDIRS([$1])
+
+m4_ifblank([$2], [rm -f $srcdir/$1/configure.gnu],
+[printf "#!/bin/sh
+"\$"SHELL "../$srcdir/$1/configure" $2 "\$"@" > "$srcdir/$1/configure.gnu"
+])
+])
diff --git a/configure.in b/configure.in
index c5e81a2..b030d9f 100644
--- a/configure.in
+++ b/configure.in
@@ -4,6 +4,8 @@ AC_INIT([openocd], [0.5.0-dev],
 AC_CONFIG_SRCDIR([src/openocd.c])
 AC_CONFIG_AUX_DIR([.])
 
+m4_include(config_subdir.m4)dnl
+
 AM_INIT_AUTOMAKE([-Wall -Wno-portability dist-bzip2 dist-zip])
 AM_MAINTAINER_MODE
 
@@ -763,7 +765,7 @@ fi
 
 if test "$use_internal_jimtcl" = yes; then
   if test -f "$srcdir/jimtcl/configure.ac"; then
-    AC_CONFIG_SUBDIRS([jimtcl])
+    AX_CONFIG_SUBDIR_OPTION(jimtcl, --with-jim-ext=nvp)
   else
     AC_MSG_ERROR([jimtcl not found, run git submodule init and git submodule update.])
   fi
diff --git a/jimtcl b/jimtcl
index 9c8bcfe..f5e5c26 160000
--- a/jimtcl
+++ b/jimtcl
@@ -1 +1 @@
-Subproject commit 9c8bcfe4e6f8ec12552edae7b2afa0a9a21d8861
+Subproject commit f5e5c268eb800278a022c2f894ab2a8c277f0a4f

commit d80fca527a6618595a118381a2cd2a569f85889f
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Wed Nov 17 10:26:21 2010 +0000

    build: add autobuild jimtcl to configure scripts
    
    Rather than having to configure/build jimtcl openocd
    will do this as part of its own build.
    
    To use an external jimtcl lib specify disable-internal-jimtcl
    to the configure step.
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/Makefile.am b/Makefile.am
index 7d42fd3..b31bcea 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -9,7 +9,13 @@ nobase_dist_pkgdata_DATA = \
 	contrib/libdcc/README \
 	contrib/openocd.udev
 
-SUBDIRS = src doc
+if INTERNAL_JIMTCL
+SUBDIRS = jimtcl
+else
+SUBDIRS =
+endif
+
+SUBDIRS += src doc
 
 EXTRA_DIST = \
 	Doxyfile.in \
diff --git a/common.mk b/common.mk
index d2273d7..c1a5e6c 100644
--- a/common.mk
+++ b/common.mk
@@ -3,3 +3,8 @@
 AM_CPPFLAGS = -I$(top_srcdir)/src \
 			  -I$(top_builddir)/src \
 			  -DPKGDATADIR=\"$(pkgdatadir)\"
+
+if INTERNAL_JIMTCL
+AM_CPPFLAGS += -I$(top_srcdir)/jimtcl \
+			   -I$(top_builddir)/jimtcl
+endif
diff --git a/configure.in b/configure.in
index 70dddb9..c5e81a2 100644
--- a/configure.in
+++ b/configure.in
@@ -2,6 +2,7 @@ AC_PREREQ(2.60)
 AC_INIT([openocd], [0.5.0-dev],
   [OpenOCD Mailing List <openocd-development at lists.berlios.de>])
 AC_CONFIG_SRCDIR([src/openocd.c])
+AC_CONFIG_AUX_DIR([.])
 
 AM_INIT_AUTOMAKE([-Wall -Wno-portability dist-bzip2 dist-zip])
 AM_MAINTAINER_MODE
@@ -482,6 +483,9 @@ AC_ARG_ENABLE(minidriver_dummy,
   AS_HELP_STRING([--enable-minidriver-dummy], [Enable the dummy minidriver.]),
   [build_minidriver_dummy=$enableval], [build_minidriver_dummy=no])
 
+AC_ARG_ENABLE(internal-jimtcl,
+  AS_HELP_STRING([--enable-internal-jimtcl], [Enable internal jimtcl]),
+  [use_internal_jimtcl=$enableval], [use_internal_jimtcl=yes])
 
 build_minidriver=no
 AC_MSG_CHECKING([whether to enable ZY1000 minidriver])
@@ -757,6 +761,14 @@ else
   AC_DEFINE(BUILD_BUSPIRATE, 0, [0 if you don't want the Buspirate JTAG driver.])
 fi
 
+if test "$use_internal_jimtcl" = yes; then
+  if test -f "$srcdir/jimtcl/configure.ac"; then
+    AC_CONFIG_SUBDIRS([jimtcl])
+  else
+    AC_MSG_ERROR([jimtcl not found, run git submodule init and git submodule update.])
+  fi
+fi
+
 #-- Deal with MingW/Cygwin FTD2XX issues
 
 if test $is_win32 = yes; then
@@ -1062,6 +1074,8 @@ AM_CONDITIONAL(BITQ, test $build_bitq = yes)
 AM_CONDITIONAL(MINIDRIVER, test $build_minidriver = yes)
 AM_CONDITIONAL(MINIDRIVER_DUMMY, test $build_minidriver_dummy = yes)
 
+AM_CONDITIONAL(INTERNAL_JIMTCL, test $use_internal_jimtcl = yes)
+
 # Look for environ alternatives.  Possibility #1: is environ in unistd.h or stdlib.h?
 AC_MSG_CHECKING([for environ in unistd.h and stdlib.h])
 AC_COMPILE_IFELSE([
diff --git a/jimtcl b/jimtcl
index fbbc8e0..9c8bcfe 160000
--- a/jimtcl
+++ b/jimtcl
@@ -1 +1 @@
-Subproject commit fbbc8e0b402adb4b0c8d3976015fe4a82c94560f
+Subproject commit 9c8bcfe4e6f8ec12552edae7b2afa0a9a21d8861
diff --git a/src/Makefile.am b/src/Makefile.am
index c2d37c1..7744986 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -20,7 +20,13 @@ MAINFILE = main.c
 endif
 
 openocd_SOURCES = $(MAINFILE)
-openocd_LDADD = libopenocd.la -ljim
+openocd_LDADD = libopenocd.la
+
+if INTERNAL_JIMTCL
+openocd_LDADD += $(top_builddir)/jimtcl/libjim.a
+else
+openocd_LDADD += -ljim
+endif
 
 libopenocd_la_SOURCES = \
 	hello.c \

commit 838cd58e24a18102b8a140df9fa993fe65706828
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Fri Nov 12 11:41:55 2010 +0000

    build: add common.mk
    
    Rather than specifying common makefile variables move
    them all to a common.mk.
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/common.mk b/common.mk
new file mode 100644
index 0000000..d2273d7
--- /dev/null
+++ b/common.mk
@@ -0,0 +1,5 @@
+
+# common flags used in openocd build
+AM_CPPFLAGS = -I$(top_srcdir)/src \
+			  -I$(top_builddir)/src \
+			  -DPKGDATADIR=\"$(pkgdatadir)\"
diff --git a/src/Makefile.am b/src/Makefile.am
index 19a0ba9..c2d37c1 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -1,3 +1,5 @@
+include $(top_srcdir)/common.mk
+
 SUBDIRS = \
 	jtag \
 	helper \
@@ -29,12 +31,6 @@ noinst_HEADERS = \
 	hello.h \
 	openocd.h
 
-
-# set the include path found by configure
-AM_CPPFLAGS = \
-	-I$(top_srcdir)/src \
-	-I$(top_builddir)/src
-
 libopenocd_la_CPPFLAGS = -DPKGBLDDATE=\"`date +%F-%R`\"
 
 # banner output includes RELSTR appended to $VERSION from the configure script
diff --git a/src/flash/Makefile.am b/src/flash/Makefile.am
index 9d983a8..ece4018 100644
--- a/src/flash/Makefile.am
+++ b/src/flash/Makefile.am
@@ -1,11 +1,9 @@
+include $(top_srcdir)/common.mk
+
 SUBDIRS = \
 	nor \
 	nand
 
-AM_CPPFLAGS = \
-	-I$(top_srcdir)/src \
-	-I$(top_builddir)/src
-
 METASOURCES = AUTO
 noinst_LTLIBRARIES = libflash.la
 libflash_la_SOURCES = \
diff --git a/src/flash/nand/Makefile.am b/src/flash/nand/Makefile.am
index 8ea7b36..9aa0e69 100644
--- a/src/flash/nand/Makefile.am
+++ b/src/flash/nand/Makefile.am
@@ -1,6 +1,4 @@
-AM_CPPFLAGS = \
-	-I$(top_srcdir)/src \
-	-I$(top_builddir)/src
+include $(top_srcdir)/common.mk
 
 noinst_LTLIBRARIES = libocdflashnand.la
 
diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index 852c0a3..e281c22 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -1,6 +1,4 @@
-AM_CPPFLAGS = \
-	-I$(top_srcdir)/src \
-	-I$(top_builddir)/src
+include $(top_srcdir)/common.mk
 
 noinst_LTLIBRARIES = libocdflashnor.la
 libocdflashnor_la_SOURCES = \
diff --git a/src/helper/Makefile.am b/src/helper/Makefile.am
index c721881..25585a4 100644
--- a/src/helper/Makefile.am
+++ b/src/helper/Makefile.am
@@ -1,7 +1,4 @@
-AM_CPPFLAGS = \
-	-I$(top_srcdir)/src \
-	-I$(top_builddir)/src \
-	-DPKGDATADIR=\"$(pkgdatadir)\"
+include $(top_srcdir)/common.mk
 
 METASOURCES = AUTO
 noinst_LTLIBRARIES = libhelper.la
diff --git a/src/jtag/Makefile.am b/src/jtag/Makefile.am
index 59cd8ff..fa964a3 100644
--- a/src/jtag/Makefile.am
+++ b/src/jtag/Makefile.am
@@ -1,6 +1,4 @@
-AM_CPPFLAGS = \
-	-I$(top_srcdir)/src \
-	-I$(top_builddir)/src
+include $(top_srcdir)/common.mk
 
 METASOURCES = AUTO
 noinst_LTLIBRARIES = libjtag.la
diff --git a/src/jtag/drivers/Makefile.am b/src/jtag/drivers/Makefile.am
index 0588126..f3d5ab0 100644
--- a/src/jtag/drivers/Makefile.am
+++ b/src/jtag/drivers/Makefile.am
@@ -1,6 +1,4 @@
-AM_CPPFLAGS = \
-	-I$(top_srcdir)/src \
-	-I$(top_builddir)/src
+include $(top_srcdir)/common.mk
 
 noinst_LTLIBRARIES = libocdjtagdrivers.la
 
diff --git a/src/pld/Makefile.am b/src/pld/Makefile.am
index 3993622..93b79f4 100644
--- a/src/pld/Makefile.am
+++ b/src/pld/Makefile.am
@@ -1,6 +1,4 @@
-AM_CPPFLAGS = \
-	-I$(top_srcdir)/src \
-	-I$(top_builddir)/src
+include $(top_srcdir)/common.mk
 
 METASOURCES = AUTO
 noinst_LTLIBRARIES = libpld.la
diff --git a/src/server/Makefile.am b/src/server/Makefile.am
index ac24ebb..a7c318c 100644
--- a/src/server/Makefile.am
+++ b/src/server/Makefile.am
@@ -1,7 +1,4 @@
-AM_CPPFLAGS = \
-	-I$(top_srcdir)/src \
-	-I$(top_builddir)/src \
-	-DPKGDATADIR=\"$(pkgdatadir)\"
+include $(top_srcdir)/common.mk
 
 METASOURCES = AUTO
 noinst_LTLIBRARIES = libserver.la
diff --git a/src/svf/Makefile.am b/src/svf/Makefile.am
index 398f967..3a14d20 100644
--- a/src/svf/Makefile.am
+++ b/src/svf/Makefile.am
@@ -1,6 +1,4 @@
-AM_CPPFLAGS = \
-	-I$(top_srcdir)/src \
-	-I$(top_builddir)/src
+include $(top_srcdir)/common.mk
 
 METASOURCES = AUTO
 noinst_LTLIBRARIES = libsvf.la
diff --git a/src/target/Makefile.am b/src/target/Makefile.am
index 1e29ae7..537c8c3 100644
--- a/src/target/Makefile.am
+++ b/src/target/Makefile.am
@@ -1,3 +1,4 @@
+include $(top_srcdir)/common.mk
 
 if OOCD_TRACE
 OOCD_TRACE_FILES = oocd_trace.c
@@ -5,10 +6,6 @@ else
 OOCD_TRACE_FILES =
 endif
 
-AM_CPPFLAGS = \
-	-I$(top_srcdir)/src \
-	-I$(top_builddir)/src
-
 BIN2C		= $(top_builddir)/src/helper/bin2char$(EXEEXT_FOR_BUILD)
 
 DEBUG_HANDLER	= $(srcdir)/xscale/debug_handler.bin
diff --git a/src/xsvf/Makefile.am b/src/xsvf/Makefile.am
index f96331c..1b9cfab 100644
--- a/src/xsvf/Makefile.am
+++ b/src/xsvf/Makefile.am
@@ -1,6 +1,4 @@
-AM_CPPFLAGS = \
-	-I$(top_srcdir)/src \
-	-I$(top_builddir)/src
+include $(top_srcdir)/common.mk
 
 METASOURCES = AUTO
 noinst_LTLIBRARIES = libxsvf.la

-----------------------------------------------------------------------

Summary of changes:
 Makefile.am                  |    8 +++++++-
 bootstrap                    |    6 +-----
 common.mk                    |   10 ++++++++++
 config_subdir.m4             |   27 +++++++++++++++++++++++++++
 configure.in                 |   16 ++++++++++++++++
 jimtcl                       |    2 +-
 src/Makefile.am              |   16 +++++++++-------
 src/flash/Makefile.am        |    6 ++----
 src/flash/nand/Makefile.am   |    4 +---
 src/flash/nor/Makefile.am    |    4 +---
 src/helper/Makefile.am       |    5 +----
 src/jtag/Makefile.am         |    4 +---
 src/jtag/drivers/Makefile.am |    4 +---
 src/pld/Makefile.am          |    4 +---
 src/server/Makefile.am       |    5 +----
 src/svf/Makefile.am          |    4 +---
 src/target/Makefile.am       |    5 +----
 src/xsvf/Makefile.am         |    4 +---
 18 files changed, 83 insertions(+), 51 deletions(-)
 create mode 100644 common.mk
 create mode 100644 config_subdir.m4


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Fri Nov 19 10:57:57 2010
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Fri, 19 Nov 2010 09:57:57 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-611-gfcee511
Message-ID: <E1PJNjC-0007qy-AR@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  fcee511f4e9cd6042b0e3a0e8b072e1f52d75291 (commit)
      from  c40571e6b9c2f4b181e289dbac2366569f128828 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit fcee511f4e9cd6042b0e3a0e8b072e1f52d75291
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Fri Nov 19 09:57:37 2010 +0000

    build: fix subconfigure parameter issue
    
    When passing CFLAGS for example through to the jimtcl subconfigure the
    quotes were not being preserved.
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/config_subdir.m4 b/config_subdir.m4
index f32bc89..4102dfd 100644
--- a/config_subdir.m4
+++ b/config_subdir.m4
@@ -22,6 +22,6 @@ AC_CONFIG_SUBDIRS([$1])
 
 m4_ifblank([$2], [rm -f $srcdir/$1/configure.gnu],
 [printf "#!/bin/sh
-"\$"SHELL "../$srcdir/$1/configure" $2 "\$"@" > "$srcdir/$1/configure.gnu"
+"\$"SHELL "../$srcdir/$1/configure" $2 \""\$"@"\" > "$srcdir/$1/configure.gnu"
 ])
 ])

-----------------------------------------------------------------------

Summary of changes:
 config_subdir.m4 |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Fri Nov 19 12:26:35 2010
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Fri, 19 Nov 2010 11:26:35 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-612-g6475194
Message-ID: <E1PJP6z-0000jy-43@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  64751942a3e59445442c1432b0f7b44c7f02a8a6 (commit)
      from  fcee511f4e9cd6042b0e3a0e8b072e1f52d75291 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 64751942a3e59445442c1432b0f7b44c7f02a8a6
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Fri Nov 19 11:24:11 2010 +0000

    build: disable jimtcl lineedit
    
    This is a recent jimtcl feature but it currently breaks mingw
    builds as this system does not have termios.h etc.
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/configure.in b/configure.in
index b030d9f..f419d71 100644
--- a/configure.in
+++ b/configure.in
@@ -765,7 +765,7 @@ fi
 
 if test "$use_internal_jimtcl" = yes; then
   if test -f "$srcdir/jimtcl/configure.ac"; then
-    AX_CONFIG_SUBDIR_OPTION(jimtcl, --with-jim-ext=nvp)
+    AX_CONFIG_SUBDIR_OPTION([jimtcl], [--with-jim-ext=nvp --disable-lineedit])
   else
     AC_MSG_ERROR([jimtcl not found, run git submodule init and git submodule update.])
   fi

-----------------------------------------------------------------------

Summary of changes:
 configure.in |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Fri Nov 19 12:54:40 2010
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Fri, 19 Nov 2010 11:54:40 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-613-g6dbe9b7
Message-ID: <E1PJPY9-0000Nv-Gm@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  6dbe9b71241172193428d9fa77e59945dc455e78 (commit)
      from  64751942a3e59445442c1432b0f7b44c7f02a8a6 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 6dbe9b71241172193428d9fa77e59945dc455e78
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Fri Nov 19 11:53:17 2010 +0000

    build: remove AC_CONFIG_AUX_DIR macro
    
    This was used during testing and should have been removed.
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/configure.in b/configure.in
index f419d71..a332376 100644
--- a/configure.in
+++ b/configure.in
@@ -2,7 +2,6 @@ AC_PREREQ(2.60)
 AC_INIT([openocd], [0.5.0-dev],
   [OpenOCD Mailing List <openocd-development at lists.berlios.de>])
 AC_CONFIG_SRCDIR([src/openocd.c])
-AC_CONFIG_AUX_DIR([.])
 
 m4_include(config_subdir.m4)dnl
 

-----------------------------------------------------------------------

Summary of changes:
 configure.in |    1 -
 1 files changed, 0 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Nov 22 09:24:35 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 22 Nov 2010 08:24:35 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-614-g17634b3
Message-ID: <E1PKRhU-0001Qa-L9@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  17634b3760c58239f37d75113425e50fd3756470 (commit)
      from  6dbe9b71241172193428d9fa77e59945dc455e78 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 17634b3760c58239f37d75113425e50fd3756470
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Nov 22 09:15:47 2010 +0100

    fastload: fix error handling upon running out of memory
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/target.c b/src/target/target.c
index a282aab..93efa76 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -4964,9 +4964,10 @@ COMMAND_HANDLER(handle_fast_load_image_command)
 	struct duration bench;
 	duration_start(&bench);
 
-	if (image_open(&image, CMD_ARGV[0], (CMD_ARGC >= 3) ? CMD_ARGV[2] : NULL) != ERROR_OK)
+	retval = image_open(&image, CMD_ARGV[0], (CMD_ARGC >= 3) ? CMD_ARGV[2] : NULL);
+	if (retval != ERROR_OK)
 	{
-		return ERROR_OK;
+		return retval;
 	}
 
 	image_size = 0x0;
@@ -4975,6 +4976,7 @@ COMMAND_HANDLER(handle_fast_load_image_command)
 	fastload = (struct FastLoad *)malloc(sizeof(struct FastLoad)*image.num_sections);
 	if (fastload == NULL)
 	{
+		command_print(CMD_CTX, "out of memory");
 		image_close(&image);
 		return ERROR_FAIL;
 	}
@@ -4986,6 +4988,7 @@ COMMAND_HANDLER(handle_fast_load_image_command)
 		{
 			command_print(CMD_CTX, "error allocating buffer for section (%d bytes)",
 						  (int)(image.sections[i].size));
+			retval = ERROR_FAIL;
 			break;
 		}
 
@@ -5021,6 +5024,9 @@ COMMAND_HANDLER(handle_fast_load_image_command)
 			if (fastload[i].data == NULL)
 			{
 				free(buffer);
+				command_print(CMD_CTX, "error allocating buffer for section (%d bytes)",
+							  length);
+				retval = ERROR_FAIL;
 				break;
 			}
 			memcpy(fastload[i].data, buffer + offset, length);
@@ -5075,14 +5081,18 @@ COMMAND_HANDLER(handle_fast_load_command)
 		command_print(CMD_CTX, "Write to 0x%08x, length 0x%08x",
 					  (unsigned int)(fastload[i].address),
 					  (unsigned int)(fastload[i].length));
-		if (retval == ERROR_OK)
+		retval = target_write_buffer(target, fastload[i].address, fastload[i].length, fastload[i].data);
+		if (retval != ERROR_OK)
 		{
-			retval = target_write_buffer(target, fastload[i].address, fastload[i].length, fastload[i].data);
+			break;
 		}
 		size += fastload[i].length;
 	}
-	int after = timeval_ms();
-	command_print(CMD_CTX, "Loaded image %f kBytes/s", (float)(size/1024.0)/((float)(after-ms)/1000.0));
+	if (retval == ERROR_OK)
+	{
+		int after = timeval_ms();
+		command_print(CMD_CTX, "Loaded image %f kBytes/s", (float)(size/1024.0)/((float)(after-ms)/1000.0));
+	}
 	return retval;
 }
 

-----------------------------------------------------------------------

Summary of changes:
 src/target/target.c |   22 ++++++++++++++++------
 1 files changed, 16 insertions(+), 6 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Nov 22 15:55:41 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 22 Nov 2010 14:55:41 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-615-g8902789
Message-ID: <E1PKXnz-0002Kd-Ps@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  8902789f0de78f52d74e467017a064dcc568b66b (commit)
      from  17634b3760c58239f37d75113425e50fd3756470 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 8902789f0de78f52d74e467017a064dcc568b66b
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Nov 22 11:16:40 2010 +0100

    flash: iterating over an address range now handles multiple banks
    
    e.g. flash erase_address now works across an address
    range that spans multiple flash chips.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nor/core.c b/src/flash/nor/core.c
index da73bf6..ff467d3 100644
--- a/src/flash/nor/core.c
+++ b/src/flash/nor/core.c
@@ -379,7 +379,7 @@ int default_flash_blank_check(struct flash_bank *bank)
  * sectors will be added to the range, and that reason string is used when
  * warning about those additions.
  */
-static int flash_iterate_address_range(struct target *target,
+static int flash_iterate_address_range_inner(struct target *target,
 		char *pad_reason, uint32_t addr, uint32_t length,
 		int (*callback)(struct flash_bank *bank, int first, int last))
 {
@@ -498,6 +498,43 @@ static int flash_iterate_address_range(struct target *target,
 	return callback(c, first, last);
 }
 
+/* The inner fn only handles a single bank, we could be spanning
+ * multiple chips.
+ */
+static int flash_iterate_address_range(struct target *target,
+		char *pad_reason, uint32_t addr, uint32_t length,
+		int (*callback)(struct flash_bank *bank, int first, int last))
+{
+	struct flash_bank *c;
+	int retval = ERROR_OK;
+
+	/* Danger! zero-length iterations means entire bank! */
+	do
+	{
+		retval = get_flash_bank_by_addr(target, addr, true, &c);
+		if (retval != ERROR_OK)
+			return retval;
+
+		uint32_t cur_length = length;
+		/* check whether it all fits in this bank */
+		if (addr + length - 1 > c->base + c->size - 1)
+		{
+			LOG_DEBUG("iterating over more than one flash bank.");
+			cur_length = c->base + c->size - addr;
+		}
+		retval = flash_iterate_address_range_inner(target,
+				pad_reason, addr, cur_length,
+				callback);
+		if (retval != ERROR_OK)
+			break;
+
+		length -= cur_length;
+		addr += cur_length;
+	} while (length > 0);
+
+	return retval;
+}
+
 int flash_erase_address_range(struct target *target,
 		bool pad, uint32_t addr, uint32_t length)
 {

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/core.c |   39 ++++++++++++++++++++++++++++++++++++++-
 1 files changed, 38 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Nov 23 08:33:25 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue, 23 Nov 2010 07:33:25 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-616-g06b4903
Message-ID: <E1PKnNW-0007ZY-LI@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  06b4903e3e932a5d21d20adba551c36c296496ce (commit)
      from  8902789f0de78f52d74e467017a064dcc568b66b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 06b4903e3e932a5d21d20adba551c36c296496ce
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Mon Nov 22 19:32:57 2010 +0800

    Documentation: fix typo
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 0d24dde..2727a0b 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -124,7 +124,7 @@ different messaging protocols on top of that signaling).  There
 are many types of debug adapter, and little uniformity in what
 they are called.  (There are also product naming differences.)
 
-These adapters are sometimes packaged as discrete dongles. which
+These adapters are sometimes packaged as discrete dongles, which
 may generically be called @dfn{hardware interface dongles}.
 Some development boards also integrate them directly, which may
 let the development board can be directly connected to the debug

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Nov 23 08:39:41 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue, 23 Nov 2010 07:39:41 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-620-g1892a2b
Message-ID: <E1PKnTa-00016z-Bm@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  1892a2b51009fb15bb1c2c7b10c125d671a5c3bf (commit)
       via  42082f7c23ded282489e8ac6ec52fe94fa097cde (commit)
       via  4bbdf966d4afbf279550c7115c64e60d94ca3fe8 (commit)
       via  e6fc371e2e86a00c7e84004b94c4b8374634953d (commit)
      from  06b4903e3e932a5d21d20adba551c36c296496ce (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 1892a2b51009fb15bb1c2c7b10c125d671a5c3bf
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Mon Nov 22 12:25:09 2010 +0800

    FLASH/NOR: Rename spearsmi.c to stmsmi.c
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index e281c22..e1028ff 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -21,7 +21,7 @@ NOR_DRIVERS = \
 	non_cfi.c \
 	ocl.c \
 	pic32mx.c \
-	spearsmi.c \
+	stmsmi.c \
 	stellaris.c \
 	stm32x.c \
 	str7x.c \
diff --git a/src/flash/nor/spearsmi.c b/src/flash/nor/stmsmi.c
similarity index 100%
rename from src/flash/nor/spearsmi.c
rename to src/flash/nor/stmsmi.c

commit 42082f7c23ded282489e8ac6ec52fe94fa097cde
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Mon Nov 22 12:21:31 2010 +0800

    FLASH/NOR: rename from spearsmi to stmsmi
    
    STMicroelectronics controller SMI is not SPEAr specific.
    Rename it and change name to every symbol in the code.
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 2727a0b..70d789a 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -4252,14 +4252,15 @@ flash bank $_FLASHNAME cfi 0x00000000 0x02000000 2 4 $_TARGETNAME
 @c "cfi part_id" disabled
 @end deffn
 
- at deffn {Flash Driver} spearsmi
- at cindex SPEAr Serial Memory Interface
+ at deffn {Flash Driver} stmsmi
+ at cindex STMicroelectronics Serial Memory Interface
 @cindex SMI
- at cindex spearsmi
-All members of SPEAr MPU family from STMicroelectronics include a
+ at cindex stmsmi
+Some devices form STMicroelectronics (e.g. STR75x MCU family,
+SPEAr MPU family) include a proprietary
 ``Serial Memory Interface'' (SMI) controller able to drive external
 SPI flash devices.
-Depending on specific MPU and board configuration, up to 4 external
+Depending on specific device and board configuration, up to 4 external
 flash devices can be connected.
 
 SMI makes the flash content directly accessible in the CPU address
@@ -4274,7 +4275,7 @@ All other parameters are ignored. Additional information, like
 flash size, are detected automatically.
 
 @example
-flash bank $_FLASHNAME spearsmi 0xf8000000 0 0 0 $_TARGETNAME
+flash bank $_FLASHNAME stmsmi 0xf8000000 0 0 0 $_TARGETNAME
 @end example
 
 @end deffn
diff --git a/src/flash/nor/drivers.c b/src/flash/nor/drivers.c
index f89e3f0..a1a60b1 100644
--- a/src/flash/nor/drivers.c
+++ b/src/flash/nor/drivers.c
@@ -40,7 +40,7 @@ extern struct flash_driver pic32mx_flash;
 extern struct flash_driver avr_flash;
 extern struct flash_driver faux_flash;
 extern struct flash_driver virtual_flash;
-extern struct flash_driver spearsmi_flash;
+extern struct flash_driver stmsmi_flash;
 
 /**
  * The list of built-in flash drivers.
@@ -66,7 +66,7 @@ static struct flash_driver *flash_drivers[] = {
 	&avr_flash,
 	&faux_flash,
 	&virtual_flash,
-	&spearsmi_flash,
+	&stmsmi_flash,
 	NULL,
 };
 
diff --git a/src/flash/nor/spearsmi.c b/src/flash/nor/spearsmi.c
index 10b5403..c9a1672 100644
--- a/src/flash/nor/spearsmi.c
+++ b/src/flash/nor/spearsmi.c
@@ -17,7 +17,7 @@
  *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
  ***************************************************************************/
 
-/* SPEAr Serial Memory Interface (SMI) controller is a SPI bus controller
+/* STM Serial Memory Interface (SMI) controller is a SPI bus controller
  * specifically designed for SPI memories.
  * Only SPI "mode 3" (CPOL=1 and CPHA=1) is supported.
  * Two working modes are available:
@@ -117,7 +117,7 @@
 #define SMI_PROBE_TIMEOUT (100)
 #define SMI_MAX_TIMEOUT  (3000)
 
-struct spearsmi_flash_bank
+struct stmsmi_flash_bank
 {
 	int probed;
 	uint32_t io_base;
@@ -184,41 +184,41 @@ static struct flash_device flash_devices[] = {
 	FLASH_ID(NULL,             0,    0,          0,     0,       0)
 };
 
-struct spearsmi_target {
+struct stmsmi_target {
 	char *name;
 	uint32_t tap_idcode;
 	uint32_t smi_base;
 	uint32_t io_base;
 };
 
-static struct spearsmi_target target_devices[] = {
+static struct stmsmi_target target_devices[] = {
 	/* name,          tap_idcode, smi_base,   io_base */
 	{ "SPEAr3xx/6xx", 0x07926041, 0xf8000000, 0xfc000000 },
 	{ "STR75x",       0x4f1f0041, 0x80000000, 0x90000000 },
 	{ NULL,           0,          0,          0 }
 };
 
-FLASH_BANK_COMMAND_HANDLER(spearsmi_flash_bank_command)
+FLASH_BANK_COMMAND_HANDLER(stmsmi_flash_bank_command)
 {
-	struct spearsmi_flash_bank *spearsmi_info;
+	struct stmsmi_flash_bank *stmsmi_info;
 
 	LOG_DEBUG(__FUNCTION__);
 
 	if (CMD_ARGC < 6)
 	{
-		LOG_WARNING("incomplete flash_bank spearsmi configuration");
+		LOG_WARNING("incomplete flash_bank stmsmi configuration");
 		return ERROR_FLASH_BANK_INVALID;
 	}
 
-	spearsmi_info = malloc(sizeof(struct spearsmi_flash_bank));
-	if (spearsmi_info == NULL)
+	stmsmi_info = malloc(sizeof(struct stmsmi_flash_bank));
+	if (stmsmi_info == NULL)
 	{
 		LOG_ERROR("not enough memory");
 		return ERROR_FAIL;
 	}
 
-	bank->driver_priv = spearsmi_info;
-	spearsmi_info->probed = 0;
+	bank->driver_priv = stmsmi_info;
+	stmsmi_info->probed = 0;
 
 	return ERROR_OK;
 }
@@ -249,14 +249,14 @@ static int poll_tff(struct target *target, uint32_t io_base, int timeout)
 static int read_status_reg(struct flash_bank *bank, uint32_t *status)
 {
 	struct target *target = bank->target;
-	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
-	uint32_t io_base = spearsmi_info->io_base;
+	struct stmsmi_flash_bank *stmsmi_info = bank->driver_priv;
+	uint32_t io_base = stmsmi_info->io_base;
 
 	/* clear transmit finished flag */
 	SMI_CLEAR_TFF();
 
 	/* Read status */
-	SMI_WRITE_REG(SMI_CR2, spearsmi_info->bank_num | SMI_RSR);
+	SMI_WRITE_REG(SMI_CR2, stmsmi_info->bank_num | SMI_RSR);
 
 	/* Poll transmit finished flag */
 	SMI_POLL_TFF(SMI_CMD_TIMEOUT);
@@ -302,8 +302,8 @@ static int wait_till_ready(struct flash_bank *bank, int timeout)
 static int smi_write_enable(struct flash_bank *bank)
 {
 	struct target *target = bank->target;
-	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
-	uint32_t io_base = spearsmi_info->io_base;
+	struct stmsmi_flash_bank *stmsmi_info = bank->driver_priv;
+	uint32_t io_base = stmsmi_info->io_base;
 	uint32_t status;
 	int retval;
 
@@ -314,7 +314,7 @@ static int smi_write_enable(struct flash_bank *bank)
 	SMI_CLEAR_TFF();
 
 	/* Send write enable command */
-	SMI_WRITE_REG(SMI_CR2, spearsmi_info->bank_num | SMI_WE);
+	SMI_WRITE_REG(SMI_CR2, stmsmi_info->bank_num | SMI_WE);
 
 	/* Poll transmit finished flag */
 	SMI_POLL_TFF(SMI_CMD_TIMEOUT);
@@ -334,7 +334,7 @@ static int smi_write_enable(struct flash_bank *bank)
 	return ERROR_OK;
 }
 
-static uint32_t erase_command(struct spearsmi_flash_bank *spearsmi_info,
+static uint32_t erase_command(struct stmsmi_flash_bank *stmsmi_info,
 	uint32_t offset)
 {
 	union {
@@ -342,7 +342,7 @@ static uint32_t erase_command(struct spearsmi_flash_bank *spearsmi_info,
 		uint8_t x[4];
 	} cmd;
 
-	cmd.x[0] = spearsmi_info->dev->erase_cmd;
+	cmd.x[0] = stmsmi_info->dev->erase_cmd;
 	cmd.x[1] = offset >> 16;
 	cmd.x[2] = offset >> 8;
 	cmd.x[3] = offset;
@@ -353,8 +353,8 @@ static uint32_t erase_command(struct spearsmi_flash_bank *spearsmi_info,
 static int smi_erase_sector(struct flash_bank *bank, int sector)
 {
 	struct target *target = bank->target;
-	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
-	uint32_t io_base = spearsmi_info->io_base;
+	struct stmsmi_flash_bank *stmsmi_info = bank->driver_priv;
+	uint32_t io_base = stmsmi_info->io_base;
 	uint32_t cmd;
 	int retval;
 
@@ -369,9 +369,9 @@ static int smi_erase_sector(struct flash_bank *bank, int sector)
 	SMI_CLEAR_TFF();
 
 	/* send SPI command "block erase" */
-	cmd = erase_command(spearsmi_info, bank->sectors[sector].offset);
+	cmd = erase_command(stmsmi_info, bank->sectors[sector].offset);
 	SMI_WRITE_REG(SMI_TR, cmd);
-	SMI_WRITE_REG(SMI_CR2, spearsmi_info->bank_num | SMI_SEND | SMI_TX_LEN_4);
+	SMI_WRITE_REG(SMI_CR2, stmsmi_info->bank_num | SMI_SEND | SMI_TX_LEN_4);
 
 	/* Poll transmit finished flag */
 	SMI_POLL_TFF(SMI_CMD_TIMEOUT);
@@ -384,11 +384,11 @@ static int smi_erase_sector(struct flash_bank *bank, int sector)
 	return ERROR_OK;
 }
 
-static int spearsmi_erase(struct flash_bank *bank, int first, int last)
+static int stmsmi_erase(struct flash_bank *bank, int first, int last)
 {
 	struct target *target = bank->target;
-	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
-	uint32_t io_base = spearsmi_info->io_base;
+	struct stmsmi_flash_bank *stmsmi_info = bank->driver_priv;
+	uint32_t io_base = stmsmi_info->io_base;
 	int retval = ERROR_OK;
 	int sector;
 
@@ -406,7 +406,7 @@ static int spearsmi_erase(struct flash_bank *bank, int first, int last)
 		return ERROR_FLASH_SECTOR_INVALID;
 	}
 
-	if (!(spearsmi_info->probed))
+	if (!(stmsmi_info->probed))
 	{
 		LOG_ERROR("Flash bank not probed");
 		return ERROR_FLASH_BANK_NOT_PROBED;
@@ -434,7 +434,7 @@ static int spearsmi_erase(struct flash_bank *bank, int first, int last)
 	return retval;
 }
 
-static int spearsmi_protect(struct flash_bank *bank, int set,
+static int stmsmi_protect(struct flash_bank *bank, int set,
 	int first, int last)
 {
 	int sector;
@@ -448,8 +448,8 @@ static int smi_write_buffer(struct flash_bank *bank, uint8_t *buffer,
 	uint32_t address, uint32_t len)
 {
 	struct target *target = bank->target;
-	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
-	uint32_t io_base = spearsmi_info->io_base;
+	struct stmsmi_flash_bank *stmsmi_info = bank->driver_priv;
+	uint32_t io_base = stmsmi_info->io_base;
 	int retval;
 
 	LOG_DEBUG("%s: address=0x%08" PRIx32 " len=0x%08" PRIx32,
@@ -469,12 +469,12 @@ static int smi_write_buffer(struct flash_bank *bank, uint8_t *buffer,
 	return ERROR_OK;
 }
 
-static int spearsmi_write(struct flash_bank *bank, uint8_t *buffer,
+static int stmsmi_write(struct flash_bank *bank, uint8_t *buffer,
 	uint32_t offset, uint32_t count)
 {
 	struct target *target = bank->target;
-	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
-	uint32_t io_base = spearsmi_info->io_base;
+	struct stmsmi_flash_bank *stmsmi_info = bank->driver_priv;
+	uint32_t io_base = stmsmi_info->io_base;
 	uint32_t cur_count, page_size, page_offset;
 	int sector;
 	int retval = ERROR_OK;
@@ -488,10 +488,10 @@ static int spearsmi_write(struct flash_bank *bank, uint8_t *buffer,
 		return ERROR_TARGET_NOT_HALTED;
 	}
 
-	if (offset + count > spearsmi_info->dev->size_in_bytes)
+	if (offset + count > stmsmi_info->dev->size_in_bytes)
 	{
 		LOG_WARNING("Write pasts end of flash. Extra data discarded.");
-		count = spearsmi_info->dev->size_in_bytes - offset;
+		count = stmsmi_info->dev->size_in_bytes - offset;
 	}
 
 	/* Check sector protection */
@@ -509,7 +509,7 @@ static int spearsmi_write(struct flash_bank *bank, uint8_t *buffer,
 		}
 	}
 
-	page_size = spearsmi_info->dev->pagesize;
+	page_size = stmsmi_info->dev->pagesize;
 
 	/* unaligned buffer head */
 	if (count > 0 && (offset & 3) != 0)
@@ -564,8 +564,8 @@ err:
 static int read_flash_id(struct flash_bank *bank, uint32_t *id)
 {
 	struct target *target = bank->target;
-	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
-	uint32_t io_base = spearsmi_info->io_base;
+	struct stmsmi_flash_bank *stmsmi_info = bank->driver_priv;
+	uint32_t io_base = stmsmi_info->io_base;
 	int retval;
 
 	if (target->state != TARGET_HALTED)
@@ -588,7 +588,7 @@ static int read_flash_id(struct flash_bank *bank, uint32_t *id)
 	/* Send SPI command "read ID" */
 	SMI_WRITE_REG(SMI_TR, SMI_READ_ID);
 	SMI_WRITE_REG(SMI_CR2,
-		spearsmi_info->bank_num | SMI_SEND | SMI_RX_LEN_3 | SMI_TX_LEN_1);
+		stmsmi_info->bank_num | SMI_SEND | SMI_RX_LEN_3 | SMI_TX_LEN_1);
 
 	/* Poll transmit finished flag */
 	SMI_POLL_TFF(SMI_CMD_TIMEOUT);
@@ -601,19 +601,19 @@ static int read_flash_id(struct flash_bank *bank, uint32_t *id)
 	return ERROR_OK;
 }
 
-static int spearsmi_probe(struct flash_bank *bank)
+static int stmsmi_probe(struct flash_bank *bank)
 {
 	struct target *target = bank->target;
-	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
+	struct stmsmi_flash_bank *stmsmi_info = bank->driver_priv;
 	uint32_t io_base;
 	struct flash_sector *sectors;
 	uint32_t id = 0; /* silence uninitialized warning */
-	struct spearsmi_target *target_device;
+	struct stmsmi_target *target_device;
 	int retval;
 
-	if (spearsmi_info->probed)
+	if (stmsmi_info->probed)
 		free(bank->sectors);
-	spearsmi_info->probed = 0;
+	stmsmi_info->probed = 0;
 
 	for (target_device=target_devices ; target_device->name ; ++target_device)
 		if (target_device->tap_idcode == target->tap->idcode)
@@ -628,23 +628,23 @@ static int spearsmi_probe(struct flash_bank *bank)
 	switch (bank->base - target_device->smi_base)
 	{
 		case 0:
-			spearsmi_info->bank_num = SMI_SEL_BANK0;
+			stmsmi_info->bank_num = SMI_SEL_BANK0;
 			break;
 		case SMI_BANK_SIZE:
-			spearsmi_info->bank_num = SMI_SEL_BANK1;
+			stmsmi_info->bank_num = SMI_SEL_BANK1;
 			break;
 		case 2*SMI_BANK_SIZE:
-			spearsmi_info->bank_num = SMI_SEL_BANK2;
+			stmsmi_info->bank_num = SMI_SEL_BANK2;
 			break;
 		case 3*SMI_BANK_SIZE:
-			spearsmi_info->bank_num = SMI_SEL_BANK3;
+			stmsmi_info->bank_num = SMI_SEL_BANK3;
 			break;
 		default:
 			LOG_ERROR("Invalid SMI base address 0x%" PRIx32, bank->base);
 			return ERROR_FAIL;
 	}
 	io_base = target_device->io_base;
-	spearsmi_info->io_base = io_base;
+	stmsmi_info->io_base = io_base;
 
 	LOG_DEBUG("Valid SMI on device %s at address 0x%" PRIx32,
 		target_device->name, bank->base);
@@ -655,28 +655,28 @@ static int spearsmi_probe(struct flash_bank *bank)
 	if (retval != ERROR_OK)
 		return retval;
 
-	spearsmi_info->dev = NULL;
+	stmsmi_info->dev = NULL;
 	for (struct flash_device *p = flash_devices; p->name ; p++)
 		if (p->device_id == id) {
-			spearsmi_info->dev = p;
+			stmsmi_info->dev = p;
 			break;
 		}
 
-	if (!spearsmi_info->dev)
+	if (!stmsmi_info->dev)
 	{
 		LOG_ERROR("Unknown flash device (ID 0x%08" PRIx32 ")", id);
 		return ERROR_FAIL;
 	}
 
 	LOG_INFO("Found flash device \'%s\' (ID 0x%08" PRIx32 ")",
-		spearsmi_info->dev->name, spearsmi_info->dev->device_id);
+		stmsmi_info->dev->name, stmsmi_info->dev->device_id);
 
 	/* Set correct size value */
-	bank->size = spearsmi_info->dev->size_in_bytes;
+	bank->size = stmsmi_info->dev->size_in_bytes;
 
 	/* create and fill sectors array */
 	bank->num_sectors =
-		spearsmi_info->dev->size_in_bytes / spearsmi_info->dev->sectorsize;
+		stmsmi_info->dev->size_in_bytes / stmsmi_info->dev->sectorsize;
 	sectors = malloc(sizeof(struct flash_sector) * bank->num_sectors);
 	if (sectors == NULL)
 	{
@@ -686,62 +686,62 @@ static int spearsmi_probe(struct flash_bank *bank)
 
 	for (int sector = 0; sector < bank->num_sectors; sector++)
 	{
-		sectors[sector].offset = sector * spearsmi_info->dev->sectorsize;
-		sectors[sector].size = spearsmi_info->dev->sectorsize;
+		sectors[sector].offset = sector * stmsmi_info->dev->sectorsize;
+		sectors[sector].size = stmsmi_info->dev->sectorsize;
 		sectors[sector].is_erased = -1;
 		sectors[sector].is_protected = 1;
 	}
 
 	bank->sectors = sectors;
-	spearsmi_info->probed = 1;
+	stmsmi_info->probed = 1;
 	return ERROR_OK;
 }
 
-static int spearsmi_auto_probe(struct flash_bank *bank)
+static int stmsmi_auto_probe(struct flash_bank *bank)
 {
-	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
-	if (spearsmi_info->probed)
+	struct stmsmi_flash_bank *stmsmi_info = bank->driver_priv;
+	if (stmsmi_info->probed)
 		return ERROR_OK;
-	return spearsmi_probe(bank);
+	return stmsmi_probe(bank);
 }
 
-static int spearsmi_protect_check(struct flash_bank *bank)
+static int stmsmi_protect_check(struct flash_bank *bank)
 {
 	/* Nothing to do. Protection is only handled in SW. */
 	return ERROR_OK;
 }
 
-static int get_spearsmi_info(struct flash_bank *bank, char *buf, int buf_size)
+static int get_stmsmi_info(struct flash_bank *bank, char *buf, int buf_size)
 {
-	struct spearsmi_flash_bank *spearsmi_info = bank->driver_priv;
+	struct stmsmi_flash_bank *stmsmi_info = bank->driver_priv;
 	int printed;
 
-	if (!(spearsmi_info->probed))
+	if (!(stmsmi_info->probed))
 	{
 		printed = snprintf(buf, buf_size,
-			"\nSPEAr SMI flash bank not probed yet\n");
+			"\nSMI flash bank not probed yet\n");
 		return ERROR_OK;
 	}
 
-	printed = snprintf(buf, buf_size, "\nSPEAr SMI flash information:\n"
+	printed = snprintf(buf, buf_size, "\nSMI flash information:\n"
 		"  Device \'%s\' (ID 0x%08x)\n",
-		spearsmi_info->dev->name, spearsmi_info->dev->device_id);
+		stmsmi_info->dev->name, stmsmi_info->dev->device_id);
 	buf += printed;
 	buf_size -= printed;
 
 	return ERROR_OK;
 }
 
-struct flash_driver spearsmi_flash = {
-	.name = "spearsmi",
-	.flash_bank_command = spearsmi_flash_bank_command,
-	.erase = spearsmi_erase,
-	.protect = spearsmi_protect,
-	.write = spearsmi_write,
+struct flash_driver stmsmi_flash = {
+	.name = "stmsmi",
+	.flash_bank_command = stmsmi_flash_bank_command,
+	.erase = stmsmi_erase,
+	.protect = stmsmi_protect,
+	.write = stmsmi_write,
 	.read = default_flash_read,
-	.probe = spearsmi_probe,
-	.auto_probe = spearsmi_auto_probe,
+	.probe = stmsmi_probe,
+	.auto_probe = stmsmi_auto_probe,
 	.erase_check = default_flash_blank_check,
-	.protect_check = spearsmi_protect_check,
-	.info = get_spearsmi_info,
+	.protect_check = stmsmi_protect_check,
+	.info = get_stmsmi_info,
 };
diff --git a/tcl/board/spear310evb20.cfg b/tcl/board/spear310evb20.cfg
index 70783f5..b546eb6 100644
--- a/tcl/board/spear310evb20.cfg
+++ b/tcl/board/spear310evb20.cfg
@@ -27,7 +27,7 @@ flash bank $_FLASHNAME0 cfi 0x50000000 0x01000000 2 4 $_TARGETNAME
 
 # Serial NOR on SMI CS0. 8Mbyte.
 set _FLASHNAME1 $_CHIPNAME.snor
-flash bank $_FLASHNAME1 spearsmi 0xf8000000 0 0 0 $_TARGETNAME
+flash bank $_FLASHNAME1 stmsmi 0xf8000000 0 0 0 $_TARGETNAME
 
 if { [info exists BOARD_HAS_SRST] } {
 	# Modified board has SRST on JTAG connector
diff --git a/tcl/target/str750.cfg b/tcl/target/str750.cfg
index 2fabc12..686aede 100644
--- a/tcl/target/str750.cfg
+++ b/tcl/target/str750.cfg
@@ -61,7 +61,7 @@ flash bank $_FLASHNAME str7x 0x200C0000 0x00004000 0 0 $_TARGETNAME STR75x
 
 # Serial NOR on SMI CS0.
 set _FLASHNAME $_CHIPNAME.snor
-flash bank $_FLASHNAME spearsmi 0x80000000 0 0 0 $_TARGETNAME
+flash bank $_FLASHNAME stmsmi 0x80000000 0 0 0 $_TARGETNAME
 
 source [find mem_helper.tcl]
 

commit 4bbdf966d4afbf279550c7115c64e60d94ca3fe8
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Wed Nov 17 11:28:46 2010 +0800

    STR750: Add SMI interface support
    
    Modified spearsmi driver to include support for STR75x
    Added missing initialization in tcl file for STR750
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/spearsmi.c b/src/flash/nor/spearsmi.c
index 5e6a2c4..10b5403 100644
--- a/src/flash/nor/spearsmi.c
+++ b/src/flash/nor/spearsmi.c
@@ -42,8 +42,6 @@
 #include <jtag/jtag.h>
 #include <helper/time_support.h>
 
-#define JTAG_ID_3XX_6XX  (0x07926041)
-
 #define SMI_READ_REG(a) (_SMI_READ_REG(a))
 #define _SMI_READ_REG(a)        	\
 {	                                \
@@ -84,12 +82,6 @@
 
 #define SMI_BANK_SIZE      (0x01000000)
 
-#define SMI_BASE_3XX_6XX   (0xf8000000)
-#define SMI_CFGREG_3XX_6XX (0xfc000000)
-
-/* #define SMI_BASE_13XX      (0xe6000000) */
-/* #define SMI_CFGREG_13XX    (0xea000000) */
-
 #define SMI_CR1 (0x00) /* Control register 1 */
 #define SMI_CR2 (0x04) /* Control register 2 */
 #define SMI_SR  (0x08) /* Status register */
@@ -192,6 +184,20 @@ static struct flash_device flash_devices[] = {
 	FLASH_ID(NULL,             0,    0,          0,     0,       0)
 };
 
+struct spearsmi_target {
+	char *name;
+	uint32_t tap_idcode;
+	uint32_t smi_base;
+	uint32_t io_base;
+};
+
+static struct spearsmi_target target_devices[] = {
+	/* name,          tap_idcode, smi_base,   io_base */
+	{ "SPEAr3xx/6xx", 0x07926041, 0xf8000000, 0xfc000000 },
+	{ "STR75x",       0x4f1f0041, 0x80000000, 0x90000000 },
+	{ NULL,           0,          0,          0 }
+};
+
 FLASH_BANK_COMMAND_HANDLER(spearsmi_flash_bank_command)
 {
 	struct spearsmi_flash_bank *spearsmi_info;
@@ -602,44 +608,46 @@ static int spearsmi_probe(struct flash_bank *bank)
 	uint32_t io_base;
 	struct flash_sector *sectors;
 	uint32_t id = 0; /* silence uninitialized warning */
+	struct spearsmi_target *target_device;
 	int retval;
 
 	if (spearsmi_info->probed)
 		free(bank->sectors);
 	spearsmi_info->probed = 0;
 
-	/* check for SPEAr device */
-	switch (target->tap->idcode)
-	{
-		case JTAG_ID_3XX_6XX:
-			/* SPEAr3xx/6xx */
-			spearsmi_info->io_base = SMI_CFGREG_3XX_6XX;
-			switch (bank->base)
-			{
-				case SMI_BASE_3XX_6XX:
-					spearsmi_info->bank_num = SMI_SEL_BANK0;
-					break;
-				case SMI_BASE_3XX_6XX + SMI_BANK_SIZE:
-					spearsmi_info->bank_num = SMI_SEL_BANK1;
-					break;
-				case SMI_BASE_3XX_6XX + 2*SMI_BANK_SIZE:
-					spearsmi_info->bank_num = SMI_SEL_BANK2;
-					break;
-				case SMI_BASE_3XX_6XX + 3*SMI_BANK_SIZE:
-					spearsmi_info->bank_num = SMI_SEL_BANK3;
-					break;
-				default:
-					LOG_ERROR("Invalid base address 0x%" PRIx32, bank->base);
-					return ERROR_FAIL;
-			}
+	for (target_device=target_devices ; target_device->name ; ++target_device)
+		if (target_device->tap_idcode == target->tap->idcode)
 			break;
+	if (!target_device->name)
+	{
+		LOG_ERROR("Device ID 0x%" PRIx32 " is not known as SMI capable",
+				target->tap->idcode);
+		return ERROR_FAIL;
+	}
 
+	switch (bank->base - target_device->smi_base)
+	{
+		case 0:
+			spearsmi_info->bank_num = SMI_SEL_BANK0;
+			break;
+		case SMI_BANK_SIZE:
+			spearsmi_info->bank_num = SMI_SEL_BANK1;
+			break;
+		case 2*SMI_BANK_SIZE:
+			spearsmi_info->bank_num = SMI_SEL_BANK2;
+			break;
+		case 3*SMI_BANK_SIZE:
+			spearsmi_info->bank_num = SMI_SEL_BANK3;
+			break;
 		default:
-			LOG_ERROR("0x%" PRIx32 " is invalid id for SPEAr device",
-				target->tap->idcode);
+			LOG_ERROR("Invalid SMI base address 0x%" PRIx32, bank->base);
 			return ERROR_FAIL;
 	}
-	io_base = spearsmi_info->io_base;
+	io_base = target_device->io_base;
+	spearsmi_info->io_base = io_base;
+
+	LOG_DEBUG("Valid SMI on device %s at address 0x%" PRIx32,
+		target_device->name, bank->base);
 
 	/* read and decode flash ID; returns in SW mode */
 	retval = read_flash_id(bank, &id);
diff --git a/tcl/target/str750.cfg b/tcl/target/str750.cfg
index 7d9f034..2fabc12 100644
--- a/tcl/target/str750.cfg
+++ b/tcl/target/str750.cfg
@@ -39,6 +39,7 @@ $_TARGETNAME configure -event reset-start  { adapter_khz 10 }
 $_TARGETNAME configure -event reset-init {
 	adapter_khz 3000
 
+	init_smi
 # Because the hardware cannot be interrogated for the protection state
 # of sectors, initialize all the sectors to be unprotected. The initial
 # state is reflected by the driver, too.
@@ -58,3 +59,14 @@ flash bank $_FLASHNAME str7x 0x20000000 0x00040000 0 0 $_TARGETNAME STR75x
 set _FLASHNAME $_CHIPNAME.flash1
 flash bank $_FLASHNAME str7x 0x200C0000 0x00004000 0 0 $_TARGETNAME STR75x
 
+# Serial NOR on SMI CS0.
+set _FLASHNAME $_CHIPNAME.snor
+flash bank $_FLASHNAME spearsmi 0x80000000 0 0 0 $_TARGETNAME
+
+source [find mem_helper.tcl]
+
+proc init_smi {} {
+	mmw 0x60000030 0x01000000 0x00000000; # enable clock for GPIO regs
+	mmw 0xffffe420 0x00000001 0x00000000; # set SMI_EN bit
+	mmw 0x90000000 0x00000001 0x00000000; # set BLOCK_EN_1
+}

commit e6fc371e2e86a00c7e84004b94c4b8374634953d
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Thu Nov 18 15:01:03 2010 +0800

    NOR/SPEARSMI: fix segfault
    
    If flash chip is not listed in the table, or if no flash is
    connected, pointer must be properly initialized.
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/src/flash/nor/spearsmi.c b/src/flash/nor/spearsmi.c
index c3bc2ec..5e6a2c4 100644
--- a/src/flash/nor/spearsmi.c
+++ b/src/flash/nor/spearsmi.c
@@ -647,6 +647,7 @@ static int spearsmi_probe(struct flash_bank *bank)
 	if (retval != ERROR_OK)
 		return retval;
 
+	spearsmi_info->dev = NULL;
 	for (struct flash_device *p = flash_devices; p->name ; p++)
 		if (p->device_id == id) {
 			spearsmi_info->dev = p;

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi                       |   13 +-
 src/flash/nor/Makefile.am              |    2 +-
 src/flash/nor/drivers.c                |    4 +-
 src/flash/nor/{spearsmi.c => stmsmi.c} |  219 +++++++++++++++++---------------
 tcl/board/spear310evb20.cfg            |    2 +-
 tcl/target/str750.cfg                  |   12 ++
 6 files changed, 137 insertions(+), 115 deletions(-)
 rename src/flash/nor/{spearsmi.c => stmsmi.c} (79%)


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Fri Nov 26 14:57:55 2010
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Fri, 26 Nov 2010 13:57:55 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-621-gc606d85
Message-ID: <E1PLyoH-00029m-B9@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  c606d858a9e7d9170259f4508cbf8a78231b9329 (commit)
      from  1892a2b51009fb15bb1c2c7b10c125d671a5c3bf (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit c606d858a9e7d9170259f4508cbf8a78231b9329
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Fri Nov 26 13:35:41 2010 +0000

    build: correct configure help message
    
    As we default to building jimtcl the help text should show that.
    No change in functionality or configure args required.
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/configure.in b/configure.in
index a332376..627c26b 100644
--- a/configure.in
+++ b/configure.in
@@ -485,7 +485,7 @@ AC_ARG_ENABLE(minidriver_dummy,
   [build_minidriver_dummy=$enableval], [build_minidriver_dummy=no])
 
 AC_ARG_ENABLE(internal-jimtcl,
-  AS_HELP_STRING([--enable-internal-jimtcl], [Enable internal jimtcl]),
+  AS_HELP_STRING([--disable-internal-jimtcl], [Disable building internal jimtcl]),
   [use_internal_jimtcl=$enableval], [use_internal_jimtcl=yes])
 
 build_minidriver=no

-----------------------------------------------------------------------

Summary of changes:
 configure.in |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Fri Nov 26 15:45:22 2010
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Fri, 26 Nov 2010 14:45:22 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-622-g9a04974
Message-ID: <E1PLzYD-0006ZM-4v@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  9a04974131f6e95a587edee92dafba873fc5db52 (commit)
      from  c606d858a9e7d9170259f4508cbf8a78231b9329 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 9a04974131f6e95a587edee92dafba873fc5db52
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Fri Nov 26 14:43:44 2010 +0000

    build: fix make install with jimtcl
    
    Update subproject jimtcl to fix issue with make install.
    see jimtcl commit 373b721510fd2d0754a41cc70a3b7cfd02e929bd
    
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/jimtcl b/jimtcl
index f5e5c26..60dfb02 160000
--- a/jimtcl
+++ b/jimtcl
@@ -1 +1 @@
-Subproject commit f5e5c268eb800278a022c2f894ab2a8c277f0a4f
+Subproject commit 60dfb023c4afa95047e0fa8db49830ccb46446b2

-----------------------------------------------------------------------

Summary of changes:
 jimtcl |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Nov 30 08:15:29 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue, 30 Nov 2010 07:15:29 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-625-g6356604
Message-ID: <E1PNKR1-00045g-D0@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  6356604382698463dd0bc0e8d71cb6d5f480ecaa (commit)
       via  94e1445a864532440380a640e180df81b4db07ec (commit)
       via  a9d0b3de44c2ecbe011d5b01d17c18b0e969cc53 (commit)
      from  9a04974131f6e95a587edee92dafba873fc5db52 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 6356604382698463dd0bc0e8d71cb6d5f480ecaa
Author: Piotr Esden-Tempski <piotr at esden.net>
Date:   Mon Nov 29 12:58:30 2010 -0800

    Some cosmetic fixes to the Lisa/L layout support functions.

diff --git a/src/jtag/drivers/ft2232.c b/src/jtag/drivers/ft2232.c
index 4439159..928ec1c 100644
--- a/src/jtag/drivers/ft2232.c
+++ b/src/jtag/drivers/ft2232.c
@@ -3113,10 +3113,6 @@ static int lisa_l_init(void)
 	uint8_t  buf[3];
 	uint32_t bytes_written;
 
-	/*
-	 * NOTE:  This is now _specific_ to the "usbjtag" layout.
-	 * Don't try cram any more layouts into this.
-	 */
 	ftx232_dbus_init();
 
 	nTRST    = 0x10;
@@ -3227,7 +3223,7 @@ static void turtle_jtag_blink(void)
 static void lisa_l_blink(void)
 {
 	/*
-	 * Lisa/L has two LEDs connected to BCBUS3 and ACBUS4
+	 * Lisa/L has two LEDs connected to BCBUS3 and BCBUS4
 	 */
 	if (high_output & 0x10)
 	{

commit 94e1445a864532440380a640e180df81b4db07ec
Author: Piotr Esden-Tempski <piotr at esden.net>
Date:   Mon Nov 29 12:56:21 2010 -0800

    Added support for the blinking leds on Floss-JTAG v0.3 and newer.

diff --git a/src/jtag/drivers/ft2232.c b/src/jtag/drivers/ft2232.c
index 7440f0c..4439159 100644
--- a/src/jtag/drivers/ft2232.c
+++ b/src/jtag/drivers/ft2232.c
@@ -189,6 +189,7 @@ static int signalyzer_h_init(void);
 static int ktlink_init(void);
 static int redbee_init(void);
 static int lisa_l_init(void);
+static int flossjtag_init(void);
 
 /* reset procedures for supported layouts */
 static void ftx23_reset(int trst, int srst);
@@ -212,6 +213,7 @@ static void turtle_jtag_blink(void);
 static void signalyzer_h_blink(void);
 static void ktlink_blink(void);
 static void lisa_l_blink(void);
+static void flossjtag_blink(void);
 
 /* common transport support options */
 
@@ -311,6 +313,11 @@ static const struct ft2232_layout  ft2232_layouts[] =
 		.blink = lisa_l_blink,
 		.channel = INTERFACE_B,
 	},
+	{ .name = "flossjtag",
+		.init = flossjtag_init,
+		.reset = ftx23_reset,
+		.blink = flossjtag_blink,
+	},
 	{ .name = NULL, /* END OF TABLE */ },
 };
 
@@ -3134,6 +3141,37 @@ static int lisa_l_init(void)
 
 	return ftx232_dbus_write();
 }
+
+static int flossjtag_init(void)
+{
+	uint8_t  buf[3];
+	uint32_t bytes_written;
+
+	ftx232_dbus_init();
+
+	nTRST    = 0x10;
+	nTRSTnOE = 0x10;
+	nSRST    = 0x40;
+	nSRSTnOE = 0x40;
+
+	high_output = 0x00;
+	high_direction = 0x18;
+
+	/* initialize high port */
+	buf[0] = 0x82; /* command "set data bits high byte" */
+	buf[1] = high_output;
+	buf[2] = high_direction;
+	LOG_DEBUG("%2.2x %2.2x %2.2x", buf[0], buf[1], buf[2]);
+
+	if (ft2232_write(buf, sizeof(buf), &bytes_written) != ERROR_OK)
+	{
+		LOG_ERROR("couldn't initialize FT2232 with 'Floss-JTAG' layout");
+		return ERROR_JTAG_INIT_FAILED;
+	}
+
+	return ftx232_dbus_write();
+}
+
 static void olimex_jtag_blink(void)
 {
 	/* Olimex ARM-USB-OCD has a LED connected to ACBUS3
@@ -3205,6 +3243,25 @@ static void lisa_l_blink(void)
 	buffer_write(high_direction);
 }
 
+static void flossjtag_blink(void)
+{
+	/*
+	 * Floss-JTAG has two LEDs connected to ACBUS3 and ACBUS4
+	 */
+	if (high_output & 0x10)
+	{
+		high_output = 0x08;
+	}
+	else
+	{
+		high_output = 0x10;
+	}
+
+	buffer_write(0x82);
+	buffer_write(high_output);
+	buffer_write(high_direction);
+}
+
 static int ft2232_quit(void)
 {
 #if BUILD_FT2232_FTD2XX == 1
diff --git a/tcl/interface/flossjtag.cfg b/tcl/interface/flossjtag.cfg
index 491f39a..9511dd2 100644
--- a/tcl/interface/flossjtag.cfg
+++ b/tcl/interface/flossjtag.cfg
@@ -16,5 +16,5 @@ interface ft2232
 ft2232_vid_pid 0x0403 0x6010
 ft2232_device_desc "FLOSS-JTAG"
 #ft2232_serial "FJ000001"
-ft2232_layout "usbjtag"
+ft2232_layout "flossjtag"
 ft2232_latency 2

commit a9d0b3de44c2ecbe011d5b01d17c18b0e969cc53
Author: Piotr Esden-Tempski <piotr at esden.net>
Date:   Mon Nov 29 12:35:39 2010 -0800

    Updated Floss-JTAG config file to support v0.3 and newer. Also added noeeprom version of the config file for older versions of Floss-JTAG.

diff --git a/tcl/interface/flossjtag-noeeprom.cfg b/tcl/interface/flossjtag-noeeprom.cfg
new file mode 100644
index 0000000..4e3466e
--- /dev/null
+++ b/tcl/interface/flossjtag-noeeprom.cfg
@@ -0,0 +1,19 @@
+#
+# FlossJTAG
+#
+# http://github.com/esden/floss-jtag
+#
+# This is the pre v0.3 Floss-JTAG compatible config file. It can also be used
+# for newer versions of Floss-JTAG with empty or not populated eeprom. If you
+# have several Floss-JTAG connected you have to use the usb id to select a
+# specific one.
+#
+# If you have a Floss-JTAG WITH eeprom that is programmed use flossjtag.cfg
+# file.
+#
+
+interface ft2232
+ft2232_vid_pid 0x0403 0x6010
+ft2232_device_desc "Dual RS232-HS"
+ft2232_layout "usbjtag"
+ft2232_latency 2
diff --git a/tcl/interface/flossjtag.cfg b/tcl/interface/flossjtag.cfg
index 396e964..491f39a 100644
--- a/tcl/interface/flossjtag.cfg
+++ b/tcl/interface/flossjtag.cfg
@@ -3,9 +3,18 @@
 #
 # http://github.com/esden/floss-jtag
 #
+# This is the v0.3 and v1.0 Floss-JTAG compatible config file. It relies on the
+# existence of an eeprom on Floss-JTAG containing a name. If you have several
+# Floss-JTAG adapters connected you can use the serial number to select a
+# specific device.
+#
+# If your Floss-JTAG does not have an eeprom or eeprom is empty use
+# flossjtag-noeeprom.cfg file.
+#
 
 interface ft2232
 ft2232_vid_pid 0x0403 0x6010
-ft2232_device_desc "Dual RS232-HS"
+ft2232_device_desc "FLOSS-JTAG"
+#ft2232_serial "FJ000001"
 ft2232_layout "usbjtag"
 ft2232_latency 2

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/drivers/ft2232.c            |   63 +++++++++++++++++++++++++++++++---
 tcl/interface/flossjtag-noeeprom.cfg |   19 ++++++++++
 tcl/interface/flossjtag.cfg          |   13 ++++++-
 3 files changed, 88 insertions(+), 7 deletions(-)
 create mode 100644 tcl/interface/flossjtag-noeeprom.cfg


hooks/post-receive
-- 
Main OpenOCD repository


