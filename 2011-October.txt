From gowinex at users.sourceforge.net  Sat Oct  1 13:12:04 2011
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Sat,  1 Oct 2011 11:12:04 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-89-ga17adf0
Message-ID: <mailman.180.1331736157.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  a17adf0601f66617f2203c6d4db168a8e8c55055 (commit)
      from  ac49e24149680e9a5c59845648c0031926b7c919 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit a17adf0601f66617f2203c6d4db168a8e8c55055
Author: Ash Charles <ash at gumstix.com>
Date:   Fri Sep 30 16:17:21 2011 -0700

    Verdex: Add support for Gumstix Verdex boards.
    
    Gumstix Verdex is a PXA270-based series of computer-on-modules. This
    configuration file is based off the voipac.cfg configuration with
    a different flash memory configuration. This has been tested flyswatter
    adapter to reflash a Gumstix Verdex XL6P board.

diff --git a/tcl/board/verdex.cfg b/tcl/board/verdex.cfg
new file mode 100644
index 0000000..6da9875
--- /dev/null
+++ b/tcl/board/verdex.cfg
@@ -0,0 +1,17 @@
+# Config for Gumstix Verdex XM4 and XL6P (PXA270)
+
+set CHIPNAME verdex
+source [find target/pxa270.cfg]
+
+# The board supports separate reset lines
+# Override this in the interface config for parallel dongles
+reset_config trst_and_srst separate
+
+# XM4 = 400MHz, XL6P = 600MHz...let's run at 0.1*400MHz=40MHz
+adapter_khz 40000
+
+# flash bank <driver> <base> <size> <chip_width> <bus_width>
+# XL6P has 32 MB flash
+flash bank $_CHIPNAME.flash0 cfi 0x00000000 0x02000000 2 2 $_TARGETNAME
+# XM4 has 16 MB flash
+#flash bank $_CHIPNAME.flash0 cfi 0x00000000 0x01000000 2 2 $_TARGETNAME

-----------------------------------------------------------------------

Summary of changes:
 tcl/board/verdex.cfg |   17 +++++++++++++++++
 1 files changed, 17 insertions(+), 0 deletions(-)
 create mode 100644 tcl/board/verdex.cfg


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Oct  3 18:46:31 2011
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon,  3 Oct 2011 16:46:31 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-90-gda8ce5f
Message-ID: <mailman.181.1331736157.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  da8ce5f2e193b8637202d56c69b22a158a12e32a (commit)
      from  a17adf0601f66617f2203c6d4db168a8e8c55055 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit da8ce5f2e193b8637202d56c69b22a158a12e32a
Author: Cl??ment Burin des Roziers <clement.burin-des-roziers at hikob.com>
Date:   Fri Sep 16 15:55:54 2011 +0200

    STM32L: Added flash driver and target
    
    Added the flash driver for the STM32L family, which highly differ from the STM32F family.
    Added the TCL target file for JTAG access.

diff --git a/contrib/loaders/flash/stm32lx.S b/contrib/loaders/flash/stm32lx.S
new file mode 100644
index 0000000..6e8ccb0
--- /dev/null
+++ b/contrib/loaders/flash/stm32lx.S
@@ -0,0 +1,63 @@
+/***************************************************************************
+ *   Copyright (C) 2010 by Spencer Oliver                                  *
+ *   spen at spen-soft.co.uk                                                  *
+ *                                                                         *
+ *   Copyright (C) 2011 ??yvind Harboe                                      *
+ *   oyvind.harboe at zylin.com                                               *
+ *                                                                         *
+ *   Copyright (C) 2011 Clement Burin des Roziers                          *
+ *   clement.burin-des-roziers at hikob.com                                   *
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ *   This program is distributed in the hope that it will be useful,       *
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
+ *   GNU General Public License for more details.                          *
+ *                                                                         *
+ *   You should have received a copy of the GNU General Public License     *
+ *   along with this program; if not, write to the                         *
+ *   Free Software Foundation, Inc.,                                       *
+ *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
+ ***************************************************************************/
+
+
+// Build : arm-eabi-gcc -c stm32lx.S
+	.text
+	.syntax unified
+	.cpu cortex-m3
+	.thumb
+	.thumb_func
+	.global write
+
+/*
+	r0 - destination address
+	r1 - source address
+	r2 - count
+*/
+
+	// Set 0 to r3
+	movs	r3, #0
+	// Go to compare
+	b.n test_done
+
+write_word:
+	// Load one word from address in r0, increment by 4
+	ldr.w	ip, [r1], #4
+	// Store the word to address in r1, increment by 4
+	str.w	ip, [r0], #4
+	// Increment r3
+	adds	r3, #1
+
+test_done:
+	// Compare r3 and r2
+	cmp 	r3, r2
+	// Loop if not zero
+	bcc.n	write_word
+
+	// Set breakpoint to exit
+	bkpt	#0x00
+
diff --git a/src/flash/nor/Makefile.am b/src/flash/nor/Makefile.am
index a966826..d5832ca 100644
--- a/src/flash/nor/Makefile.am
+++ b/src/flash/nor/Makefile.am
@@ -26,6 +26,7 @@ NOR_DRIVERS = \
 	stellaris.c \
 	stm32f1x.c \
 	stm32f2x.c \
+	stm32lx.c \
 	str7x.c \
 	str9x.c \
 	str9xpec.c \
diff --git a/src/flash/nor/drivers.c b/src/flash/nor/drivers.c
index a437d84..6b0cc36 100644
--- a/src/flash/nor/drivers.c
+++ b/src/flash/nor/drivers.c
@@ -34,6 +34,7 @@ extern struct flash_driver stellaris_flash;
 extern struct flash_driver str9xpec_flash;
 extern struct flash_driver stm32f1x_flash;
 extern struct flash_driver stm32f2x_flash;
+extern struct flash_driver stm32lx_flash;
 extern struct flash_driver tms470_flash;
 extern struct flash_driver ecosflash_flash;
 extern struct flash_driver ocl_flash;
@@ -65,6 +66,7 @@ static struct flash_driver *flash_drivers[] = {
 	&str9xpec_flash,
 	&stm32f1x_flash,
 	&stm32f2x_flash,
+	&stm32lx_flash,
 	&tms470_flash,
 	&ecosflash_flash,
 	&ocl_flash,
diff --git a/src/flash/nor/stm32lx.c b/src/flash/nor/stm32lx.c
new file mode 100644
index 0000000..32b3315
--- /dev/null
+++ b/src/flash/nor/stm32lx.c
@@ -0,0 +1,970 @@
+/***************************************************************************
+ *   Copyright (C) 2005 by Dominic Rath                                    *
+ *   Dominic.Rath at gmx.de                                                   *
+ *                                                                         *
+ *   Copyright (C) 2008 by Spencer Oliver                                  *
+ *   spen at spen-soft.co.uk                                                  *
+ *                                                                         *
+ *   Copyright (C) 2011 by Clement Burin des Roziers                       *
+ *   clement.burin-des-roziers at hikob.com                                   *
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ *   This program is distributed in the hope that it will be useful,       *
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
+ *   GNU General Public License for more details.                          *
+ *                                                                         *
+ *   You should have received a copy of the GNU General Public License     *
+ *   along with this program; if not, write to the                         *
+ *   Free Software Foundation, Inc.,                                       *
+ *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
+ ***************************************************************************/
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
+#include "imp.h"
+#include <helper/binarybuffer.h>
+#include <target/algorithm.h>
+#include <target/armv7m.h>
+
+/* stm32lx flash register locations */
+
+#define FLASH_BASE		0x40023C00
+#define FLASH_ACR		0x40023C00
+#define FLASH_PECR		0x40023C04
+#define FLASH_PDKEYR	0x40023C08
+#define FLASH_PEKEYR	0x40023C0C
+#define FLASH_PRGKEYR	0x40023C10
+#define FLASH_OPTKEYR	0x40023C14
+#define FLASH_SR		0x40023C18
+#define FLASH_OBR		0x40023C1C
+#define FLASH_WRPR		0x40023C20
+
+/* FLASH_ACR bites */
+#define FLASH_ACR__LATENCY		(1<<0)
+#define FLASH_ACR__PRFTEN		(1<<1)
+#define FLASH_ACR__ACC64		(1<<2)
+#define FLASH_ACR__SLEEP_PD		(1<<3)
+#define FLASH_ACR__RUN_PD		(1<<4)
+
+/* FLASH_PECR bits */
+#define FLASH_PECR__PELOCK		(1<<0)
+#define FLASH_PECR__PRGLOCK		(1<<1)
+#define FLASH_PECR__OPTLOCK		(1<<2)
+#define FLASH_PECR__PROG		(1<<3)
+#define FLASH_PECR__DATA		(1<<4)
+#define FLASH_PECR__FTDW		(1<<8)
+#define FLASH_PECR__ERASE		(1<<9)
+#define FLASH_PECR__FPRG		(1<<10)
+#define FLASH_PECR__EOPIE		(1<<16)
+#define FLASH_PECR__ERRIE		(1<<17)
+#define FLASH_PECR__OBL_LAUNCH	(1<<18)
+
+/* FLASH_SR bits */
+#define FLASH_SR__BSY		(1<<0)
+#define FLASH_SR__EOP		(1<<1)
+#define FLASH_SR__ENDHV		(1<<2)
+#define FLASH_SR__READY		(1<<3)
+#define FLASH_SR__WRPERR	(1<<8)
+#define FLASH_SR__PGAERR	(1<<9)
+#define FLASH_SR__SIZERR	(1<<10)
+#define FLASH_SR__OPTVERR	(1<<11)
+
+/* Unlock keys */
+#define PEKEY1			0x89ABCDEF
+#define PEKEY2			0x02030405
+#define PRGKEY1			0x8C9DAEBF
+#define PRGKEY2			0x13141516
+#define OPTKEY1			0xFBEAD9C8
+#define OPTKEY2			0x24252627
+
+/* other registers */
+#define DBGMCU_IDCODE	0xE0042000
+#define F_SIZE			0x1FF8004C
+
+/* Constants */
+#define FLASH_PAGE_SIZE 256
+#define FLASH_SECTOR_SIZE 4096
+#define FLASH_PAGES_PER_SECTOR 16
+#define FLASH_BANK0_ADDRESS 0x08000000
+
+/* stm32lx option byte register location */
+#define OB_RDP			0x1FF80000
+#define OB_USER			0x1FF80004
+#define OB_WRP0_1		0x1FF80008
+#define OB_WRP2_3		0x1FF8000C
+
+/* OB_RDP values */
+#define OB_RDP__LEVEL0	0xFF5500AA
+#define OB_RDP__LEVEL1	0xFFFF0000
+
+/* stm32lx RCC register locations */
+#define RCC_CR		0x40023800
+#define RCC_ICSCR	0x40023804
+#define RCC_CFGR	0x40023808
+
+/* RCC_ICSCR bits */
+#define RCC_ICSCR__MSIRANGE_MASK	(7<<13)
+
+static int stm32lx_unlock_program_memory(struct flash_bank *bank);
+static int stm32lx_lock_program_memory(struct flash_bank *bank);
+static int stm32lx_enable_write_half_page(struct flash_bank *bank);
+static int stm32lx_erase_sector(struct flash_bank *bank, int sector);
+static int stm32lx_wait_until_bsy_clear(struct flash_bank *bank);
+
+struct stm32lx_flash_bank
+{
+	struct working_area *write_algorithm;
+	int probed;
+};
+
+/* flash bank stm32lx <base> <size> 0 0 <target#>
+ */
+FLASH_BANK_COMMAND_HANDLER(stm32lx_flash_bank_command)
+{
+	struct stm32lx_flash_bank *stm32lx_info;
+	if (CMD_ARGC < 6)
+	{
+		LOG_ERROR("incomplete flash_bank stm32lx configuration");
+		return ERROR_FLASH_BANK_INVALID;
+	}
+
+	// Create the bank structure
+	stm32lx_info = malloc(sizeof(struct stm32lx_flash_bank));
+
+	// Check allocation
+	if (stm32lx_info == NULL)
+	{
+		LOG_ERROR("failed to allocate bank structure");
+		return ERROR_FAIL;
+	}
+
+	bank->driver_priv = stm32lx_info;
+
+	stm32lx_info->write_algorithm = NULL;
+	stm32lx_info->probed = 0;
+
+	return ERROR_OK;
+}
+
+static int stm32lx_protect_check(struct flash_bank *bank)
+{
+	int retval;
+	struct target *target = bank->target;
+
+	uint32_t wrpr;
+
+	if (target->state != TARGET_HALTED)
+	{
+		LOG_ERROR("Target not halted");
+		return ERROR_TARGET_NOT_HALTED;
+	}
+
+	/*
+	 * Read the WRPR word, and check each bit (corresponding to each
+	 * flash sector
+	 */
+	retval = target_read_u32(target, FLASH_WRPR, &wrpr);
+	if (retval != ERROR_OK)
+		return retval;
+
+	for (int i = 0; i < 32; i++)
+	{
+		if (wrpr & (1 << i))
+		{
+			bank->sectors[i].is_protected = 1;
+		}
+		else
+		{
+			bank->sectors[i].is_protected = 0;
+		}
+	}
+	return ERROR_OK;
+}
+
+static int stm32lx_erase(struct flash_bank *bank, int first, int last)
+{
+	int retval;
+
+	/*
+	 * It could be possible to do a mass erase if all sectors must be
+	 * erased, but it is not implemented yet.
+	 */
+
+	if (bank->target->state != TARGET_HALTED)
+	{
+		LOG_ERROR("Target not halted");
+		return ERROR_TARGET_NOT_HALTED;
+	}
+
+	/*
+	 * Loop over the selected sectors and erase them
+	 */
+	for (int i = first; i <= last; i++)
+	{
+		retval = stm32lx_erase_sector(bank, i);
+		if (retval != ERROR_OK)
+			return retval;
+		bank->sectors[i].is_erased = 1;
+	}
+	return ERROR_OK;
+}
+
+static int stm32lx_protect(struct flash_bank *bank, int set, int first,
+		int last)
+{
+	LOG_WARNING("protection of the STM32L flash is not implemented");
+	return ERROR_OK;
+}
+
+static int stm32lx_write_half_pages(struct flash_bank *bank, uint8_t *buffer,
+		uint32_t offset, uint32_t count)
+{
+	struct stm32lx_flash_bank *stm32lx_info = bank->driver_priv;
+	struct target *target = bank->target;
+	uint32_t buffer_size = 4096 * 4;
+	struct working_area *source;
+	uint32_t address = bank->base + offset;
+
+	struct reg_param reg_params[5];
+	struct armv7m_algorithm armv7m_info;
+
+	int retval = ERROR_OK;
+	uint32_t reg32;
+
+	/* see contib/loaders/flash/stm32lx.s for src */
+
+	static const uint16_t stm32lx_flash_write_code_16[] =
+	{
+	//	00000000 <write_word-0x4>:
+			0x2300, // 0:	2300	  	movs	r3, #0
+			0xe004, // 2:	e004	  	b.n	e <test_done>
+
+			//	00000004 <write_word>:
+			0xf851, 0xcb04, // 4:	f851 cb04 	ldr.w	ip, [r1], #4
+			0xf840, 0xcb04, // 8:	f840 cb04 	str.w	ip, [r0], #4
+			0x3301, // c:	3301	  	adds	r3, #1
+
+			//	0000000e <test_done>:
+			0x4293, // e:	4293	  	cmp	r3, r2
+			0xd3f8, // 10:	d3f8	  	bcc.n	4 <write_word>
+			0xbe00, // 12:	be00	  	bkpt	0x0000
+
+			};
+
+	// Flip endian
+	uint8_t stm32lx_flash_write_code[sizeof(stm32lx_flash_write_code_16)];
+	for (unsigned int i = 0; i < sizeof(stm32lx_flash_write_code_16) / 2; i++)
+	{
+		stm32lx_flash_write_code[i * 2 + 0] = stm32lx_flash_write_code_16[i]
+				& 0xff;
+		stm32lx_flash_write_code[i * 2 + 1] = (stm32lx_flash_write_code_16[i]
+				>> 8) & 0xff;
+	}
+	// Check if there is an even number of half pages (128bytes)
+	if (count % 128)
+	{
+		LOG_ERROR("there should be an even number "
+				"of half pages = 128 bytes (count = %" PRIi32 " bytes)", count);
+		return ERROR_FAIL;
+	}
+
+	// Allocate working area
+	reg32 = sizeof(stm32lx_flash_write_code);
+	// Add bytes to make 4byte aligned
+	reg32 += (4 - (reg32 % 4)) % 4;
+	retval = target_alloc_working_area(target, reg32,
+			&stm32lx_info->write_algorithm);
+	if (retval != ERROR_OK)
+		return retval;
+
+	// Write the flashing code
+	retval = target_write_buffer(target,
+			stm32lx_info->write_algorithm->address,
+			sizeof(stm32lx_flash_write_code),
+			(uint8_t*) stm32lx_flash_write_code);
+	if (retval != ERROR_OK)
+	{
+		target_free_working_area(target, stm32lx_info->write_algorithm);
+		return retval;
+	}
+
+	// Allocate half pages memory
+	while (target_alloc_working_area_try(target, buffer_size, &source)
+			!= ERROR_OK)
+	{
+		if (buffer_size > 1024)
+			buffer_size -= 1024;
+		else
+			buffer_size /= 2;
+
+		if (buffer_size <= 256)
+		{
+			/* if we already allocated the writing code, but failed to get a
+			 * buffer, free the algorithm */
+			if (stm32lx_info->write_algorithm)
+				target_free_working_area(target, stm32lx_info->write_algorithm);
+
+			LOG_WARNING("no large enough working area available, can't do block memory writes");
+			return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
+		}
+	}
+	LOG_DEBUG("allocated working area for data (%" PRIx32 " bytes)", buffer_size);
+
+	armv7m_info.common_magic = ARMV7M_COMMON_MAGIC;
+	armv7m_info.core_mode = ARMV7M_MODE_ANY;
+	init_reg_param(&reg_params[0], "r0", 32, PARAM_OUT);
+	init_reg_param(&reg_params[1], "r1", 32, PARAM_OUT);
+	init_reg_param(&reg_params[2], "r2", 32, PARAM_OUT);
+	init_reg_param(&reg_params[3], "r3", 32, PARAM_IN_OUT);
+	init_reg_param(&reg_params[4], "r4", 32, PARAM_OUT);
+
+	// Enable half-page write
+	retval = stm32lx_enable_write_half_page(bank);
+	if (retval != ERROR_OK)
+	{
+
+		target_free_working_area(target, source);
+		target_free_working_area(target, stm32lx_info->write_algorithm);
+
+		destroy_reg_param(&reg_params[0]);
+		destroy_reg_param(&reg_params[1]);
+		destroy_reg_param(&reg_params[2]);
+		destroy_reg_param(&reg_params[3]);
+
+		return retval;
+	}
+
+	// Loop while there are bytes to write
+	while (count > 0)
+	{
+		uint32_t this_count;
+		this_count = (count > buffer_size) ? buffer_size : count;
+
+		// Write the next half pages
+		retval = target_write_buffer(target, source->address, this_count,
+				buffer);
+		if (retval != ERROR_OK)
+			break;
+
+		// 4: Store useful information in the registers
+		// the destination address of the copy (R0)
+		buf_set_u32(reg_params[0].value, 0, 32, address);
+		// The source address of the copy (R1)
+		buf_set_u32(reg_params[1].value, 0, 32, source->address);
+		// The length of the copy (R2)
+		buf_set_u32(reg_params[2].value, 0, 32, this_count / 4);
+
+		// 5: Execute the bunch of code
+		retval = target_run_algorithm(target, 0, NULL, sizeof(reg_params)
+				/ sizeof(*reg_params), reg_params,
+				stm32lx_info->write_algorithm->address, 0, 20000, &armv7m_info);
+		if (retval != ERROR_OK)
+			break;
+
+		// 6: Wait while busy
+		retval = stm32lx_wait_until_bsy_clear(bank);
+		if (retval != ERROR_OK)
+			break;
+
+		buffer += this_count;
+		address += this_count;
+		count -= this_count;
+	}
+
+	if (retval == ERROR_OK)
+		retval = stm32lx_lock_program_memory(bank);
+
+	target_free_working_area(target, source);
+	target_free_working_area(target, stm32lx_info->write_algorithm);
+
+	destroy_reg_param(&reg_params[0]);
+	destroy_reg_param(&reg_params[1]);
+	destroy_reg_param(&reg_params[2]);
+	destroy_reg_param(&reg_params[3]);
+
+	return retval;
+}
+static int stm32lx_write(struct flash_bank *bank, uint8_t *buffer,
+		uint32_t offset, uint32_t count)
+{
+	struct target *target = bank->target;
+
+	uint32_t halfpages_number;
+	uint32_t words_remaining;
+	uint32_t bytes_remaining;
+	uint32_t address = bank->base + offset;
+	uint32_t bytes_written = 0;
+	int retval;
+
+	if (bank->target->state != TARGET_HALTED)
+	{
+		LOG_ERROR("Target not halted");
+		return ERROR_TARGET_NOT_HALTED;
+	}
+
+	if (offset & 0x1)
+	{
+		LOG_ERROR("offset 0x%" PRIx32 " breaks required 2-byte alignment", offset);
+		return ERROR_FLASH_DST_BREAKS_ALIGNMENT;
+	}
+
+	// Check if there are some full half pages
+	if (((offset % 128) == 0) && (count >= 128))
+	{
+		halfpages_number = count / 128;
+		words_remaining = (count - 128 * halfpages_number) / 4;
+		bytes_remaining = (count & 0x3);
+	}
+	else
+	{
+		halfpages_number = 0;
+		words_remaining = (count / 4);
+		bytes_remaining = (count & 0x3);
+	}
+
+	if (halfpages_number)
+	{
+		retval = stm32lx_write_half_pages(bank, buffer, offset, 128
+				* halfpages_number);
+		if (retval != ERROR_OK)
+			return ERROR_FAIL;
+	}
+
+	bytes_written = 128 * halfpages_number;
+
+	retval = stm32lx_unlock_program_memory(bank);
+	if (retval != ERROR_OK)
+		return retval;
+
+	while (words_remaining > 0)
+	{
+		uint32_t value;
+		uint8_t* p = buffer + bytes_written;
+
+		// Prepare the word, Little endian conversion
+		value = p[0] + (p[1] << 8) + (p[2] << 16) + (p[3] << 24);
+
+		retval = target_write_u32(target, address, value);
+		if (retval != ERROR_OK)
+			return retval;
+
+		bytes_written += 4;
+		words_remaining--;
+		address += 4;
+
+		retval = stm32lx_wait_until_bsy_clear(bank);
+		if (retval != ERROR_OK)
+			return retval;
+	}
+
+	if (bytes_remaining)
+	{
+		uint32_t value = 0;
+		for (int i = 0; i < 4; i++)
+		{
+			if (bytes_remaining)
+			{
+				value += (buffer[i] << (8 * i));
+				bytes_remaining--;
+			}
+		}
+
+		retval = target_write_u32(target, address, value);
+		if (retval != ERROR_OK)
+			return retval;
+
+		retval = stm32lx_wait_until_bsy_clear(bank);
+		if (retval != ERROR_OK)
+			return retval;
+	}
+
+	retval = stm32lx_lock_program_memory(bank);
+	if (retval != ERROR_OK)
+		return retval;
+
+	return ERROR_OK;
+}
+
+static int stm32lx_probe(struct flash_bank *bank)
+{
+	struct target *target = bank->target;
+	struct stm32lx_flash_bank *stm32lx_info = bank->driver_priv;
+	int i;
+	uint16_t flash_size;
+	uint32_t device_id;
+	uint32_t reg32;
+
+	stm32lx_info->probed = 0;
+
+	/* read stm32 device id register */
+	int retval = target_read_u32(target, DBGMCU_IDCODE, &device_id);
+	if (retval != ERROR_OK)
+		return retval;
+
+	LOG_DEBUG("device id = 0x%08" PRIx32 "", device_id);
+
+	if ((device_id & 0x7ff) != 0x416)
+	{
+		LOG_WARNING("Cannot identify target as a STM32L family.");
+		return ERROR_FAIL;
+	}
+
+	// Read the RDP byte and check if it is 0xAA
+	uint8_t rdp;
+	retval = target_read_u32(target, FLASH_OBR, &reg32);
+	if (retval != ERROR_OK)
+		return retval;
+	rdp = reg32 & 0xFF;
+	if (rdp != 0xAA)
+	{
+		/*
+		 * Unlocking the option byte is done by unlocking the PECR, then
+		 * by writing the 2 option byte keys to OPTKEYR
+		 */
+
+		/* To unlock the PECR write the 2 PEKEY to the PEKEYR register */
+		retval = target_write_u32(target, FLASH_PEKEYR, PEKEY1);
+		if (retval != ERROR_OK)
+			return retval;
+
+		retval = target_write_u32(target, FLASH_PEKEYR, PEKEY2);
+		if (retval != ERROR_OK)
+			return retval;
+
+		/* Make sure it worked */
+		retval = target_read_u32(target, FLASH_PECR, &reg32);
+		if (retval != ERROR_OK)
+			return retval;
+
+		if (reg32 & FLASH_PECR__PELOCK)
+			return ERROR_FLASH_OPERATION_FAILED;
+
+		retval = target_write_u32(target, FLASH_OPTKEYR, OPTKEY1);
+		if (retval != ERROR_OK)
+			return retval;
+		retval = target_write_u32(target, FLASH_OPTKEYR, OPTKEY2);
+		if (retval != ERROR_OK)
+			return retval;
+
+		retval = target_read_u32(target, FLASH_PECR, &reg32);
+		if (retval != ERROR_OK)
+			return retval;
+
+		if (reg32 & FLASH_PECR__OPTLOCK)
+		{
+			LOG_ERROR("OPTLOCK is not cleared");
+			return ERROR_FLASH_OPERATION_FAILED;
+		}
+
+		// Then, write RDP to 0x00 to set level 1
+		reg32 = ((~0xAA) << 16) | (0xAA);
+		retval = target_write_u32(target, OB_RDP, reg32);
+		if (retval != ERROR_OK)
+			return retval;
+
+		// Set Automatic update of the option byte, by setting OBL_LAUNCH in FLASH_PECR
+		reg32 = FLASH_PECR__OBL_LAUNCH;
+		retval = target_write_u32(target, FLASH_PECR, reg32);
+		if (retval != ERROR_OK)
+			return retval;
+	}
+
+	/* get flash size from target. */
+	retval = target_read_u16(target, F_SIZE, &flash_size);
+	if (retval != ERROR_OK)
+		return retval;
+
+	/* check for valid flash size */
+	if (flash_size == 0xffff)
+	{
+		/* number of sectors incorrect on revA */
+		LOG_ERROR("STM32 flash size failed, probe inaccurate");
+		return ERROR_FAIL;
+	}
+
+	/* STM32L - we have 32 sectors, 16 pages per sector -> 512 pages
+	 * 16 pages for a protection area */
+
+	/* calculate numbers of sectors (4kB per sector) */
+	int num_sectors = (flash_size * 1024) / FLASH_SECTOR_SIZE;
+	LOG_INFO("flash size = %dkbytes", flash_size);
+
+	if (bank->sectors)
+	{
+		free(bank->sectors);
+		bank->sectors = NULL;
+	}
+
+	bank->base = FLASH_BANK0_ADDRESS;
+	bank->size = flash_size * 1024;
+	bank->num_sectors = num_sectors;
+	bank->sectors = malloc(sizeof(struct flash_sector) * num_sectors);
+	if (bank->sectors == NULL)
+	{
+		LOG_ERROR("failed to allocate bank sectors");
+		return ERROR_FAIL;
+	}
+
+	for (i = 0; i < num_sectors; i++)
+	{
+		bank->sectors[i].offset = i * FLASH_SECTOR_SIZE;
+		bank->sectors[i].size = FLASH_SECTOR_SIZE;
+		bank->sectors[i].is_erased = -1;
+		bank->sectors[i].is_protected = 1;
+	}
+
+	stm32lx_info->probed = 1;
+
+	return ERROR_OK;
+}
+
+static int stm32lx_auto_probe(struct flash_bank *bank)
+{
+	struct stm32lx_flash_bank *stm32lx_info = bank->driver_priv;
+
+	if (stm32lx_info->probed)
+	{
+		return ERROR_OK;
+	}
+
+	return stm32lx_probe(bank);
+}
+
+static int stm32lx_erase_check(struct flash_bank *bank)
+{
+	struct target *target = bank->target;
+	const int buffer_size = 4096;
+	int i;
+	uint32_t nBytes;
+	int retval = ERROR_OK;
+
+	if (bank->target->state != TARGET_HALTED)
+	{
+		LOG_ERROR("Target not halted");
+		return ERROR_TARGET_NOT_HALTED;
+	}
+
+	uint8_t *buffer = malloc(buffer_size);
+	if (buffer == NULL)
+	{
+		LOG_ERROR("failed to allocate read buffer");
+		return ERROR_FAIL;
+	}
+
+	for (i = 0; i < bank->num_sectors; i++)
+	{
+		uint32_t j;
+		bank->sectors[i].is_erased = 1;
+
+		// Loop chunk by chunk over the sector
+		for (j = 0; j < bank->sectors[i].size; j += buffer_size)
+		{
+			uint32_t chunk;
+			chunk = buffer_size;
+			if (chunk > (j - bank->sectors[i].size))
+			{
+				chunk = (j - bank->sectors[i].size);
+			}
+
+			retval = target_read_memory(target, bank->base
+					+ bank->sectors[i].offset + j, 4, chunk / 4, buffer);
+			if (retval != ERROR_OK)
+				break;
+
+			for (nBytes = 0; nBytes < chunk; nBytes++)
+			{
+				if (buffer[nBytes] != 0x00)
+				{
+					bank->sectors[i].is_erased = 0;
+					break;
+				}
+			}
+		}
+		if (retval != ERROR_OK)
+		{
+			break;
+		}
+	}
+	free(buffer);
+
+	return retval;
+}
+static int stm32lx_get_info(struct flash_bank *bank, char *buf, int buf_size)
+{
+	// This method must return a string displaying information about the bank
+
+	struct target *target = bank->target;
+	uint32_t device_id;
+	int printed;
+
+	/* read stm32 device id register */
+	int retval = target_read_u32(target, DBGMCU_IDCODE, &device_id);
+	if (retval != ERROR_OK)
+		return retval;
+
+	if ((device_id & 0x7ff) == 0x416)
+	{
+		printed = snprintf(buf, buf_size, "stm32lx - Rev: ");
+		buf += printed;
+		buf_size -= printed;
+
+		switch (device_id >> 16)
+		{
+			case 0x1000:
+				snprintf(buf, buf_size, "A");
+				break;
+
+			case 0x1008:
+				snprintf(buf, buf_size, "Y");
+				break;
+			default:
+				snprintf(buf, buf_size, "unknown");
+				break;
+		}
+	}
+	else
+	{
+		snprintf(buf, buf_size, "Cannot identify target as a stm32lx");
+		return ERROR_FAIL;
+	}
+
+	return ERROR_OK;
+}
+
+static const struct command_registration stm32lx_exec_command_handlers[] =
+{
+	COMMAND_REGISTRATION_DONE
+};
+
+static const struct command_registration stm32lx_command_handlers[] =
+{
+	{
+		.name = "stm32lx",
+		.mode = COMMAND_ANY,
+		.help = "stm32lx flash command group",
+		.chain = stm32lx_exec_command_handlers,
+	},
+	COMMAND_REGISTRATION_DONE
+};
+
+struct flash_driver stm32lx_flash =
+{
+		.name = "stm32lx",
+		.commands = stm32lx_command_handlers,
+		.flash_bank_command = stm32lx_flash_bank_command,
+		.erase = stm32lx_erase,
+		.protect = stm32lx_protect,
+		.write = stm32lx_write,
+		.read = default_flash_read,
+		.probe = stm32lx_probe,
+		.auto_probe = stm32lx_auto_probe,
+		.erase_check = stm32lx_erase_check,
+		.protect_check = stm32lx_protect_check,
+		.info = stm32lx_get_info,
+};
+
+// Static methods implementation
+
+static int stm32lx_unlock_program_memory(struct flash_bank *bank)
+{
+	struct target *target = bank->target;
+	int retval;
+	uint32_t reg32;
+
+	/*
+	 * Unlocking the program memory is done by unlocking the PECR,
+	 * then by writing the 2 PRGKEY to the PRGKEYR register
+	 */
+
+	/* To unlock the PECR write the 2 PEKEY to the PEKEYR register */
+	retval = target_write_u32(target, FLASH_PEKEYR, PEKEY1);
+	if (retval != ERROR_OK)
+		return retval;
+
+	retval = target_write_u32(target, FLASH_PEKEYR, PEKEY2);
+	if (retval != ERROR_OK)
+		return retval;
+
+	/* Make sure it worked */
+	retval = target_read_u32(target, FLASH_PECR, &reg32);
+	if (retval != ERROR_OK)
+		return retval;
+
+	if (reg32 & FLASH_PECR__PELOCK)
+	{
+		LOG_ERROR("PELOCK is not cleared :(");
+		return ERROR_FLASH_OPERATION_FAILED;
+	}
+
+	retval = target_write_u32(target, FLASH_PRGKEYR, PRGKEY1);
+	if (retval != ERROR_OK)
+		return retval;
+	retval = target_write_u32(target, FLASH_PRGKEYR, PRGKEY2);
+	if (retval != ERROR_OK)
+		return retval;
+
+	/* Make sure it worked */
+	retval = target_read_u32(target, FLASH_PECR, &reg32);
+	if (retval != ERROR_OK)
+		return retval;
+
+	if (reg32 & FLASH_PECR__PRGLOCK)
+	{
+		LOG_ERROR("PRGLOCK is not cleared :(");
+		return ERROR_FLASH_OPERATION_FAILED;
+	}
+	return ERROR_OK;
+}
+
+static int stm32lx_enable_write_half_page(struct flash_bank *bank)
+{
+	struct target *target = bank->target;
+	int retval;
+	uint32_t reg32;
+
+	/**
+	 * Unlock the program memory, then set the FPRG bit in the PECR register.
+	 */
+	retval = stm32lx_unlock_program_memory(bank);
+	if (retval != ERROR_OK)
+		return retval;
+
+	retval = target_read_u32(target, FLASH_PECR, &reg32);
+	if (retval != ERROR_OK)
+		return retval;
+
+	reg32 |= FLASH_PECR__FPRG;
+	retval = target_write_u32(target, FLASH_PECR, reg32);
+	if (retval != ERROR_OK)
+		return retval;
+
+	retval = target_read_u32(target, FLASH_PECR, &reg32);
+	if (retval != ERROR_OK)
+		return retval;
+
+	reg32 |= FLASH_PECR__PROG;
+	retval = target_write_u32(target, FLASH_PECR, reg32);
+
+	return retval;
+}
+
+static int stm32lx_lock_program_memory(struct flash_bank *bank)
+{
+	struct target *target = bank->target;
+	int retval;
+	uint32_t reg32;
+
+	/* To lock the program memory, simply set the lock bit and lock PECR */
+
+	retval = target_read_u32(target, FLASH_PECR, &reg32);
+	if (retval != ERROR_OK)
+		return retval;
+
+	reg32 |= FLASH_PECR__PRGLOCK;
+	retval = target_write_u32(target, FLASH_PECR, reg32);
+	if (retval != ERROR_OK)
+		return retval;
+
+	retval = target_read_u32(target, FLASH_PECR, &reg32);
+	if (retval != ERROR_OK)
+		return retval;
+
+	reg32 |= FLASH_PECR__PELOCK;
+	retval = target_write_u32(target, FLASH_PECR, reg32);
+	if (retval != ERROR_OK)
+		return retval;
+
+	return ERROR_OK;
+}
+
+static int stm32lx_erase_sector(struct flash_bank *bank, int sector)
+{
+	struct target *target = bank->target;
+	int retval;
+	uint32_t reg32;
+
+	/*
+	 * To erase a sector (i.e. FLASH_PAGES_PER_SECTOR pages),
+	 * first unlock the memory, loop over the pages of this sector
+	 * and write 0x0 to its first word.
+	 */
+
+	retval = stm32lx_unlock_program_memory(bank);
+	if (retval != ERROR_OK)
+		return retval;
+
+	for (int page = 0; page < FLASH_PAGES_PER_SECTOR; page++)
+	{
+		reg32 = FLASH_PECR__PROG | FLASH_PECR__ERASE;
+		retval = target_write_u32(target, FLASH_PECR, reg32);
+		if (retval != ERROR_OK)
+			return retval;
+
+		retval = stm32lx_wait_until_bsy_clear(bank);
+		if (retval != ERROR_OK)
+			return retval;
+
+		uint32_t addr = bank->base + bank->sectors[sector].offset + (page
+				* FLASH_PAGE_SIZE);
+		retval = target_write_u32(target, addr, 0x0);
+		if (retval != ERROR_OK)
+			return retval;
+
+		retval = stm32lx_wait_until_bsy_clear(bank);
+		if (retval != ERROR_OK)
+			return retval;
+	}
+
+	retval = stm32lx_lock_program_memory(bank);
+	if (retval != ERROR_OK)
+		return retval;
+
+	return ERROR_OK;
+}
+
+static int stm32lx_wait_until_bsy_clear(struct flash_bank *bank)
+{
+	struct target *target = bank->target;
+	uint32_t status;
+	int retval = ERROR_OK;
+	int timeout = 100;
+
+	/* wait for busy to clear */
+	for (;;)
+	{
+		retval = target_read_u32(target, FLASH_SR, &status);
+		if (retval != ERROR_OK)
+			return retval;
+
+		if ((status & FLASH_SR__BSY) == 0)
+		{
+			break;
+		}
+		if (timeout-- <= 0)
+		{
+			LOG_ERROR("timed out waiting for flash");
+			return ERROR_FAIL;
+		}
+		alive_sleep(1);
+	}
+
+	if (status & FLASH_SR__WRPERR)
+	{
+		LOG_ERROR("access denied / write protected");
+		retval = ERROR_FAIL;
+	}
+
+	if (status & FLASH_SR__PGAERR)
+	{
+		LOG_ERROR("invalid program address");
+		retval = ERROR_FAIL;
+	}
+
+	return retval;
+}
diff --git a/tcl/target/stm32l.cfg b/tcl/target/stm32l.cfg
new file mode 100644
index 0000000..5c3d368
--- /dev/null
+++ b/tcl/target/stm32l.cfg
@@ -0,0 +1,81 @@
+# script for stm32l
+
+if { [info exists CHIPNAME] } {
+   set  _CHIPNAME $CHIPNAME
+} else {
+   set  _CHIPNAME stm32l
+}
+
+if { [info exists ENDIAN] } {
+   set  _ENDIAN $ENDIAN
+} else {
+   set  _ENDIAN little
+}
+
+# Work-area is a space in RAM used for flash programming
+# By default use 14kB
+if { [info exists WORKAREASIZE] } {
+   set  _WORKAREASIZE $WORKAREASIZE
+} else {
+   set  _WORKAREASIZE 0x3800
+}
+
+# JTAG speed should be <= F_CPU/6.
+# F_CPU after reset is 2MHz, so use F_JTAG max = 333kHz
+adapter_khz 100
+
+adapter_nsrst_delay 100
+jtag_ntrst_delay 100
+
+#jtag scan chain
+if { [info exists CPUTAPID ] } {
+   set _CPUTAPID $CPUTAPID
+} else {
+  # See STM Document RM0038
+  # Section 24.6.3
+   set _CPUTAPID 0x4ba00477
+}
+jtag newtap $_CHIPNAME cpu -irlen 4 -ircapture 0x1 -irmask 0xf -expected-id $_CPUTAPID
+
+if { [info exists BSTAPID ] } {
+   # FIXME this never gets used to override defaults...
+   set _BSTAPID $BSTAPID
+} else {
+  # See STM Document RM0038
+  # Section 24.6.2
+  set _BSTAPID 0x06416041
+}
+jtag newtap $_CHIPNAME bs -irlen 5 -expected-id $_BSTAPID
+
+set _TARGETNAME $_CHIPNAME.cpu
+target create $_TARGETNAME cortex_m3 -endian $_ENDIAN -chain-position $_TARGETNAME
+
+$_TARGETNAME configure -work-area-phys 0x20000000 -work-area-size $_WORKAREASIZE -work-area-backup 0
+
+
+# flash size will be probed
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME stm32lx 0x08000000 0 0 0 $_TARGETNAME
+
+# if srst is not fitted use SYSRESETREQ to
+# perform a soft reset
+cortex_m3 reset_config sysresetreq
+
+proc stm32l_enable_HSI {} {
+	# Enable HSI as clock source
+	echo "STM32L: Enabling HSI"
+	
+	# Set HSION in RCC_CR
+	mww 0x40023800 0x00000101
+	
+	# Set HSI as SYSCLK
+	mww 0x40023808 0x00000001
+	
+	# Increase JTAG speed
+	adapter_khz 2000
+}
+
+$_TARGETNAME configure -event reset-init {
+	stm32l_enable_HSI
+}
+

-----------------------------------------------------------------------

Summary of changes:
 .../loaders/flash/stm32lx.S                        |   66 +-
 src/flash/nor/Makefile.am                          |    1 +
 src/flash/nor/drivers.c                            |    2 +
 src/flash/nor/stm32lx.c                            |  970 ++++++++++++++++++++
 tcl/target/{stm32f2x.cfg => stm32l.cfg}            |   58 +-
 5 files changed, 1055 insertions(+), 42 deletions(-)
 copy src/helper/time_support_ecos.c => contrib/loaders/flash/stm32lx.S (67%)
 create mode 100644 src/flash/nor/stm32lx.c
 copy tcl/target/{stm32f2x.cfg => stm32l.cfg} (50%)


hooks/post-receive
-- 
Main OpenOCD repository


From nattgris at users.sourceforge.net  Sat Oct  8 23:26:30 2011
From: nattgris at users.sourceforge.net (Andreas Fritiofson)
Date: Sat,  8 Oct 2011 21:26:30 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-99-ge56e5a3
Message-ID: <mailman.182.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  e56e5a3929a05d18e560c8e37f1985aeb4b95cc9 (commit)
       via  830e76fecd9c8475234964d533e7bd79a179c6ca (commit)
       via  028d9aa9ed5cc7fad3ce98e4da97e14d4a16f8f1 (commit)
       via  b1c74747b634fab259ca1c16f298e97d274b18c5 (commit)
       via  e4590dad08ca7d137b129d2b5f70a674c4948174 (commit)
       via  07bf5f443a13c99af8e92ccb5c43eb990f68e588 (commit)
       via  8b61ed2e957393cbe1b304ac267937c85e3f2972 (commit)
       via  3977c5169b53ae658db143ec95b652fdfbf0aec1 (commit)
       via  e42363c0f6a26522159e286e1524487863b66618 (commit)
      from  da8ce5f2e193b8637202d56c69b22a158a12e32a (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit e56e5a3929a05d18e560c8e37f1985aeb4b95cc9
Author: Simon Barner <barner at gmx.de>
Date:   Fri Sep 16 21:15:19 2011 +0200

    arm-jtag-ew: Send GDB keep_alive() messages when logging USB communication
    
    - Ticket: #35

diff --git a/src/jtag/drivers/arm-jtag-ew.c b/src/jtag/drivers/arm-jtag-ew.c
index b0c522f..6af3304 100644
--- a/src/jtag/drivers/arm-jtag-ew.c
+++ b/src/jtag/drivers/arm-jtag-ew.c
@@ -847,6 +847,9 @@ static void armjtagew_debug_buffer(uint8_t *buffer, int length)
 			strcat(line, s);
 		}
 		LOG_DEBUG("%s", line);
+
+		// Prevent GDB timeout (writing to log might take some time)
+		keep_alive();
 	}
 }
 #endif

commit 830e76fecd9c8475234964d533e7bd79a179c6ca
Author: Simon Barner <barner at gmx.de>
Date:   Fri Sep 16 21:14:39 2011 +0200

    arm-jtag-ew: Formatting

diff --git a/src/jtag/drivers/arm-jtag-ew.c b/src/jtag/drivers/arm-jtag-ew.c
index d42756c..b0c522f 100644
--- a/src/jtag/drivers/arm-jtag-ew.c
+++ b/src/jtag/drivers/arm-jtag-ew.c
@@ -204,7 +204,7 @@ static int armjtagew_speed(int speed)
 	}
 	else
 	{
-	LOG_INFO("Requested speed %dkHz, emulator reported %dkHz.", speed, speed_real);
+		LOG_INFO("Requested speed %dkHz, emulator reported %dkHz.", speed, speed_real);
 	}
 
     return ERROR_OK;

commit 028d9aa9ed5cc7fad3ce98e4da97e14d4a16f8f1
Author: Simon Barner <barner at gmx.de>
Date:   Fri Sep 16 21:13:39 2011 +0200

    arm-jtag-ew: In armjtagew_init(), set initial JTAG speed to 32 kHz (before TAP initialization).
    
    This prevents rare communication errors during startup.

diff --git a/src/jtag/drivers/arm-jtag-ew.c b/src/jtag/drivers/arm-jtag-ew.c
index 7712a9e..d42756c 100644
--- a/src/jtag/drivers/arm-jtag-ew.c
+++ b/src/jtag/drivers/arm-jtag-ew.c
@@ -256,6 +256,9 @@ static int armjtagew_init(void)
 		LOG_INFO("ARM-JTAG-EW initial read failed, don't worry");
 	}
 
+	// Initial JTAG speed (for reset and initialization): 32 kHz
+	armjtagew_speed(32);
+
 	LOG_INFO("ARM-JTAG-EW JTAG Interface ready");
 
 	armjtagew_reset(0, 0);

commit b1c74747b634fab259ca1c16f298e97d274b18c5
Author: Simon Barner <barner at gmx.de>
Date:   Fri Sep 16 21:12:47 2011 +0200

    arm-jtag-ew: Emit a warning if interface firmware version != 1.6

diff --git a/src/jtag/drivers/arm-jtag-ew.c b/src/jtag/drivers/arm-jtag-ew.c
index 5293365..7712a9e 100644
--- a/src/jtag/drivers/arm-jtag-ew.c
+++ b/src/jtag/drivers/arm-jtag-ew.c
@@ -496,6 +496,11 @@ static int armjtagew_get_version_info(void)
 			usb_in_buffer[1], usb_in_buffer[0], \
 			isgraph(usb_in_buffer[2]) ? usb_in_buffer[2] : 'X', \
 			sn, auxinfo);
+
+	if (1 != usb_in_buffer[1] || 6 != usb_in_buffer[0])
+	{
+		LOG_WARNING("ARM-JTAG-EW firmware version %d.%d is untested with this version of OpenOCD. You might experience unexpected behavior.", usb_in_buffer[1], usb_in_buffer[0]);
+	}
 	return ERROR_OK;
 }
 

commit e4590dad08ca7d137b129d2b5f70a674c4948174
Author: Simon Barner <barner at gmx.de>
Date:   Fri Sep 16 21:11:40 2011 +0200

    arm-jtag-ew: Declare interface as `jtag_only'

diff --git a/src/jtag/drivers/arm-jtag-ew.c b/src/jtag/drivers/arm-jtag-ew.c
index 2d6a400..5293365 100644
--- a/src/jtag/drivers/arm-jtag-ew.c
+++ b/src/jtag/drivers/arm-jtag-ew.c
@@ -523,6 +523,7 @@ static const struct command_registration armjtagew_command_handlers[] = {
 struct jtag_interface armjtagew_interface = {
 	.name = "arm-jtag-ew",
 	.commands = armjtagew_command_handlers,
+	.transports = jtag_only,
 
 	.execute_queue = armjtagew_execute_queue,
 	.speed = armjtagew_speed,

commit 07bf5f443a13c99af8e92ccb5c43eb990f68e588
Author: Simon Barner <barner at gmx.de>
Date:   Fri Sep 16 21:10:23 2011 +0200

    arm-jtag-ew: Provide armjtagew_speed_div() in order to fix interactive use of `adapter_khz'

diff --git a/src/jtag/drivers/arm-jtag-ew.c b/src/jtag/drivers/arm-jtag-ew.c
index bf60c77..2d6a400 100644
--- a/src/jtag/drivers/arm-jtag-ew.c
+++ b/src/jtag/drivers/arm-jtag-ew.c
@@ -218,6 +218,14 @@ static int armjtagew_khz(int khz, int *jtag_speed)
 	return ERROR_OK;
 }
 
+static int armjtagew_speed_div(int speed, int* khz)
+{
+	*khz = speed;
+
+	return ERROR_OK;
+}
+
+
 static int armjtagew_init(void)
 {
 	int check_cnt;
@@ -518,6 +526,7 @@ struct jtag_interface armjtagew_interface = {
 
 	.execute_queue = armjtagew_execute_queue,
 	.speed = armjtagew_speed,
+	.speed_div = armjtagew_speed_div,
 	.khz = armjtagew_khz,
 	.init = armjtagew_init,
 	.quit = armjtagew_quit,

commit 8b61ed2e957393cbe1b304ac267937c85e3f2972
Author: Simon Barner <barner at gmx.de>
Date:   Fri Sep 16 21:08:10 2011 +0200

    arm-jtag-ew: Fix setting interface speed (2/2)
    
    Interface expects speed in Hz, not kHz
    
    - Ticket #34

diff --git a/src/jtag/drivers/arm-jtag-ew.c b/src/jtag/drivers/arm-jtag-ew.c
index f39730f..bf60c77 100644
--- a/src/jtag/drivers/arm-jtag-ew.c
+++ b/src/jtag/drivers/arm-jtag-ew.c
@@ -184,7 +184,7 @@ static int armjtagew_speed(int speed)
 
 
     usb_out_buffer[0] = CMD_SET_TCK_FREQUENCY;
-	buf_set_u32(usb_out_buffer + 1, 0, 32, speed);
+	buf_set_u32(usb_out_buffer + 1, 0, 32, speed*1000);
 
     result = armjtagew_usb_message(armjtagew_handle, 5, 4);
 
@@ -196,7 +196,7 @@ static int armjtagew_speed(int speed)
 
 	usb_out_buffer[0] = CMD_GET_TCK_FREQUENCY;
     result = armjtagew_usb_message(armjtagew_handle, 1, 4);
-	speed_real = (int)buf_get_u32(usb_in_buffer,0,32);
+	speed_real = (int)buf_get_u32(usb_in_buffer,0,32) / 1000;
 	if (result < 0)
 	{
         LOG_ERROR("ARM-JTAG-EW getting speed failed (%d)", result);

commit 3977c5169b53ae658db143ec95b652fdfbf0aec1
Author: Simon Barner <barner at gmx.de>
Date:   Fri Sep 16 21:06:02 2011 +0200

    arm-jtag-ew: Fix setting interface speed (1/2)
    
    CMD_SET_TCK_FREQUENCY message length is 5, not 4
    
    - Ticket: #34

diff --git a/src/jtag/drivers/arm-jtag-ew.c b/src/jtag/drivers/arm-jtag-ew.c
index 44eaeff..f39730f 100644
--- a/src/jtag/drivers/arm-jtag-ew.c
+++ b/src/jtag/drivers/arm-jtag-ew.c
@@ -186,7 +186,7 @@ static int armjtagew_speed(int speed)
     usb_out_buffer[0] = CMD_SET_TCK_FREQUENCY;
 	buf_set_u32(usb_out_buffer + 1, 0, 32, speed);
 
-    result = armjtagew_usb_message(armjtagew_handle, 4, 4);
+    result = armjtagew_usb_message(armjtagew_handle, 5, 4);
 
     if (result < 0)
     {

commit e42363c0f6a26522159e286e1524487863b66618
Author: Eugeniy Meshcheryakov <eugen at debian.org>
Date:   Tue Oct 4 15:14:02 2011 +0200

    Add udev rules for openmoko neo1973 debug board

diff --git a/contrib/openocd.udev b/contrib/openocd.udev
index c239072..3de11c1 100644
--- a/contrib/openocd.udev
+++ b/contrib/openocd.udev
@@ -67,5 +67,8 @@ ATTRS{idVendor}=="0403", ATTRS{idProduct}=="c141", MODE="664", GROUP="plugdev"
 # Hilscher NXHX Boards
 ATTRS{idVendor}=="0640", ATTRS{idProduct}=="0028", MODE="664", GROUP="plugdev"
 
+# Debug Board for Neo1973
+ATTRS{idVendor}=="1457", ATTRS{idProduct}=="5118", MODE="644", GROUP="plugdev"
+
 LABEL="openocd_rules_end"
 

-----------------------------------------------------------------------

Summary of changes:
 contrib/openocd.udev           |    3 +++
 src/jtag/drivers/arm-jtag-ew.c |   29 +++++++++++++++++++++++++----
 2 files changed, 28 insertions(+), 4 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From nattgris at users.sourceforge.net  Sun Oct  9 00:36:52 2011
From: nattgris at users.sourceforge.net (Andreas Fritiofson)
Date: Sat,  8 Oct 2011 22:36:52 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-104-g92b14f8
Message-ID: <mailman.183.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  92b14f8ca96e87715697be74a08907595a7d4dcb (commit)
       via  a147563ac1e96e3dbe56770a9f958a7b47cc0fc8 (commit)
       via  1163435e19f316a4a97fd33f1467f5c1684db654 (commit)
       via  9d4c466c219039bd6a2ea03467cd3ee8be2a0e76 (commit)
       via  3f6ef7a40bcff5e1278b662248902c45a1dc8f81 (commit)
      from  e56e5a3929a05d18e560c8e37f1985aeb4b95cc9 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 92b14f8ca96e87715697be74a08907595a7d4dcb
Author: Andreas Fritiofson <andreas.fritiofson at gmail.com>
Date:   Sun Jul 31 10:31:56 2011 +0200

    stm32f1x: use async algorithm in flash programming routine
    
    Let the target algorithm be running in the background and buffer data
    continuously through a FIFO. This reduces or removes the effect of latency
    because only a very small number of queue executions needs to be done per
    buffer fill. Previously, the many repeated target state changes, register
    accesses (really inefficient) and algorithm uploads caused the flash
    programming to be latency bound in many cases. Now it should scale better
    with increased throughput.
    
    Signed-off-by: Andreas Fritiofson <andreas.fritiofson at gmail.com>

diff --git a/contrib/loaders/flash/stm32x.S b/contrib/loaders/flash/stm32f1x.S
similarity index 51%
rename from contrib/loaders/flash/stm32x.S
rename to contrib/loaders/flash/stm32f1x.S
index 01494b8..125c76a 100644
--- a/contrib/loaders/flash/stm32x.S
+++ b/contrib/loaders/flash/stm32f1x.S
@@ -1,6 +1,6 @@
 /***************************************************************************
- *   Copyright (C) 2010 by Spencer Oliver                                  *
- *   spen at spen-soft.co.uk                                                  *
+ *   Copyright (C) 2011 by Andreas Fritiofson                              *
+ *   andreas.fritiofson at gmail.com                                          *
  *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
  *   it under the terms of the GNU General Public License as published by  *
@@ -25,34 +25,47 @@
 	.thumb_func
 	.global write
 
-/*
-	r0 - source address
-	r1 - target address
-	r2 - count (halfword-16bit)
-	r3 - sector offet in : result out
-	r4 - flash base
-*/
+	/* Params:
+	 * r0 - flash base (in), status (out)
+	 * r1 - count (halfword-16bit)
+	 * r2 - workarea start
+	 * r3 - workarea end
+	 * r4 - target address
+	 * Clobbered:
+	 * r5 - rp
+	 * r6 - wp, tmp
+	 */
 
-#define STM32_FLASH_CR_OFFSET	0x10			/* offset of CR register in FLASH struct */
-#define STM32_FLASH_SR_OFFSET	0x0c			/* offset of CR register in FLASH struct */
+#define STM32_FLASH_CR_OFFSET 0x10 /* offset of CR register from flash reg base */
+#define STM32_FLASH_SR_OFFSET 0x0c /* offset of SR register from flash reg base */
 
-write:
-	ldr		r4, STM32_FLASH_BASE
-	add		r4, r3								/* add offset 0x00 for sector 0 : 0x40 for sector 1 */
-write_half_word:
-	movs	r3, #0x01
-	str		r3, [r4, #STM32_FLASH_CR_OFFSET]	/* PG (bit0) == 1 => flash programming enabled */
-	ldrh 	r3, [r0], #0x02						/* read one half-word from src, increment ptr */
-	strh 	r3, [r1], #0x02						/* write one half-word from src, increment ptr */
+wait_fifo:
+	ldr 	r6, [r2, #0]	/* read wp */
+	cmp 	r6, #0			/* abort if wp == 0 */
+	beq 	exit
+	ldr 	r5, [r2, #4]	/* read rp */
+	cmp 	r5, r6			/* wait until rp != wp */
+	beq 	wait_fifo
+	movs	r6, #1			/* set PG flag to enable flash programming */
+	str 	r6, [r0, #STM32_FLASH_CR_OFFSET]
+	ldrh	r6, [r5], #2	/* "*target_address++ = *rp++" */
+	strh	r6, [r4], #2
 busy:
-	ldr 	r3, [r4, #STM32_FLASH_SR_OFFSET]
-	tst 	r3, #0x01							/* BSY (bit0) == 1 => operation in progress */
-	beq 	busy								/* wait more... */
-	tst		r3, #0x14							/* PGERR (bit2) == 1 or WRPRTERR (bit4) == 1 => error */
-	bne		exit								/* fail... */
-	subs	r2, r2, #0x01						/* decrement counter */
-	bne		write_half_word						/* write next half-word if anything left */
+	ldr 	r6, [r0, #STM32_FLASH_SR_OFFSET]	/* wait until BSY flag is reset */
+	tst 	r6, #1
+	bne 	busy
+	tst 	r6, #0x14		/* check the error bits */
+	bne 	error
+	cmp 	r5, r3			/* wrap rp at end of buffer */
+	it  	cs
+	addcs	r5, r2, #8
+	str 	r5, [r2, #4]	/* store rp */
+	subs	r1, r1, #1		/* decrement halfword count */
+	cbz 	r1, exit		/* loop if not done */
+	b		wait_fifo
+error:
+	movs	r0, #0
+	str 	r0, [r2, #2]	/* set rp = 0 on error */
 exit:
-	bkpt	#0x00
-
-STM32_FLASH_BASE: .word 0x40022000				/* base address of FLASH struct */
+	mov		r0, r6			/* return status in r0 */
+	bkpt	#0
diff --git a/src/flash/nor/stm32f1x.c b/src/flash/nor/stm32f1x.c
index 142b03e..a0520c7 100644
--- a/src/flash/nor/stm32f1x.c
+++ b/src/flash/nor/stm32f1x.c
@@ -5,6 +5,9 @@
  *   Copyright (C) 2008 by Spencer Oliver                                  *
  *   spen at spen-soft.co.uk                                                  *
  *                                                                         *
+ *   Copyright (C) 2011 by Andreas Fritiofson                              *
+ *   andreas.fritiofson at gmail.com                                          *
+ *
  *   This program is free software; you can redistribute it and/or modify  *
  *   it under the terms of the GNU General Public License as published by  *
  *   the Free Software Foundation; either version 2 of the License, or     *
@@ -623,34 +626,45 @@ static int stm32x_write_block(struct flash_bank *bank, uint8_t *buffer,
 	uint32_t buffer_size = 16384;
 	struct working_area *source;
 	uint32_t address = bank->base + offset;
-	struct reg_param reg_params[4];
+	struct reg_param reg_params[5];
 	struct armv7m_algorithm armv7m_info;
 	int retval = ERROR_OK;
 
-	/* see contib/loaders/flash/stm32x.s for src */
+	/* see contrib/loaders/flash/stm32f1x.S for src */
 
 	static const uint8_t stm32x_flash_write_code[] = {
-									/* #define STM32_FLASH_CR_OFFSET	0x10 */
-									/* #define STM32_FLASH_SR_OFFSET	0x0C */
-									/* write: */
-		0x08, 0x4c,					/* ldr	r4, STM32_FLASH_BASE */
-		0x1c, 0x44,					/* add	r4, r3 */
-									/* write_half_word: */
-		0x01, 0x23,					/* movs	r3, #0x01 */
-		0x23, 0x61,					/* str	r3, [r4, #STM32_FLASH_CR_OFFSET] */
-		0x30, 0xf8, 0x02, 0x3b,		/* ldrh	r3, [r0], #0x02 */
-		0x21, 0xf8, 0x02, 0x3b,		/* strh	r3, [r1], #0x02 */
-									/* busy: */
-		0xe3, 0x68,					/* ldr	r3, [r4, #STM32_FLASH_SR_OFFSET] */
-		0x13, 0xf0, 0x01, 0x0f,		/* tst	r3, #0x01 */
-		0xfb, 0xd0,					/* beq	busy */
-		0x13, 0xf0, 0x14, 0x0f,		/* tst	r3, #0x14 */
-		0x01, 0xd1,					/* bne	exit */
-		0x01, 0x3a,					/* subs	r2, r2, #0x01 */
-		0xf0, 0xd1,					/* bne	write_half_word */
-									/* exit: */
-		0x00, 0xbe,					/* bkpt	#0x00 */
-		0x00, 0x20, 0x02, 0x40,		/* STM32_FLASH_BASE: .word 0x40022000 */
+		/* #define STM32_FLASH_CR_OFFSET 0x10 */
+		/* #define STM32_FLASH_SR_OFFSET 0x0C */
+		/* wait_fifo: */
+			0x16, 0x68,             /* ldr  	r6, [r2, #0] */
+			0x00, 0x2e,             /* cmp  	r6, #0 */
+			0x1a, 0xd0,             /* beq  	exit */
+			0x55, 0x68,             /* ldr  	r5, [r2, #4] */
+			0xb5, 0x42,             /* cmp  	r5, r6 */
+			0xf9, 0xd0,             /* beq  	wait_fifo */
+			0x01, 0x26,             /* movs 	r6, #1 */
+			0x06, 0x61,             /* str  	r6, [r0, #STM32_FLASH_CR_OFFSET] */
+			0x35, 0xf8, 0x02, 0x6b, /* ldrh 	r6, [r5], #2 */
+			0x24, 0xf8, 0x02, 0x6b, /* strh 	r6, [r4], #2 */
+		/* busy: */
+			0xc6, 0x68,             /* ldr  	r6, [r0, #STM32_FLASH_SR_OFFSET] */
+			0x16, 0xf0, 0x01, 0x0f, /* tst  	r6, #1 */
+			0xfb, 0xd1,             /* bne  	busy */
+			0x16, 0xf0, 0x14, 0x0f, /* tst  	r6, #0x14 */
+			0x07, 0xd1,             /* bne  	error */
+			0x9d, 0x42,             /* cmp  	r5, r3 */
+			0x28, 0xbf,             /* it   	cs */
+			0x02, 0xf1, 0x08, 0x05, /* addcs	r5, r2, #8 */
+			0x55, 0x60,             /* str  	r5, [r2, #4] */
+			0x01, 0x39,             /* subs 	r1, r1, #1 */
+			0x19, 0xb1,             /* cbz  	r1, exit */
+			0xe4, 0xe7,             /* b    	wait_fifo */
+		/* error: */
+			0x00, 0x20,             /* movs 	r0, #0 */
+			0xc2, 0xf8,	0x02, 0x00, /* str  	r0, [r2, #2] */
+		/* exit: */
+			0x30, 0x46,             /* mov  	r0, r6 */
+			0x00, 0xbe,             /* bkpt 	#0 */
 	};
 
 	/* flash write code */
@@ -670,6 +684,7 @@ static int stm32x_write_block(struct flash_bank *bank, uint8_t *buffer,
 	while (target_alloc_working_area_try(target, buffer_size, &source) != ERROR_OK)
 	{
 		buffer_size /= 2;
+		buffer_size &= ~3UL; // Make sure it's 4 byte aligned
 		if (buffer_size <= 256)
 		{
 			/* if we already allocated the writing code, but failed to get a
@@ -682,60 +697,152 @@ static int stm32x_write_block(struct flash_bank *bank, uint8_t *buffer,
 		}
 	};
 
+	/* Set up working area. First word is write pointer, second word is read pointer,
+	 * rest is fifo data area. */
+	uint32_t wp_addr = source->address;
+	uint32_t rp_addr = source->address + 4;
+	uint32_t fifo_start_addr = source->address + 8;
+	uint32_t fifo_end_addr = source->address + source->size;
+
+	uint32_t wp = fifo_start_addr;
+	uint32_t rp = fifo_start_addr;
+
+	retval = target_write_u32(target, wp_addr, wp);
+	if (retval != ERROR_OK)
+		return retval;
+	retval = target_write_u32(target, rp_addr, rp);
+	if (retval != ERROR_OK)
+		return retval;
+
+	init_reg_param(&reg_params[0], "r0", 32, PARAM_IN_OUT);	/* flash base (in), status (out) */
+	init_reg_param(&reg_params[1], "r1", 32, PARAM_OUT);	/* count (halfword-16bit) */
+	init_reg_param(&reg_params[2], "r2", 32, PARAM_OUT);	/* buffer start */
+	init_reg_param(&reg_params[3], "r3", 32, PARAM_OUT);	/* buffer end */
+	init_reg_param(&reg_params[4], "r4", 32, PARAM_IN_OUT);	/* target address */
+
+	buf_set_u32(reg_params[0].value, 0, 32, stm32x_info->register_base);
+	buf_set_u32(reg_params[1].value, 0, 32, count);
+	buf_set_u32(reg_params[2].value, 0, 32, source->address);
+	buf_set_u32(reg_params[3].value, 0, 32, source->address + source->size);
+	buf_set_u32(reg_params[4].value, 0, 32, address);
+
 	armv7m_info.common_magic = ARMV7M_COMMON_MAGIC;
 	armv7m_info.core_mode = ARMV7M_MODE_ANY;
 
-	init_reg_param(&reg_params[0], "r0", 32, PARAM_OUT);
-	init_reg_param(&reg_params[1], "r1", 32, PARAM_OUT);
-	init_reg_param(&reg_params[2], "r2", 32, PARAM_OUT);
-	init_reg_param(&reg_params[3], "r3", 32, PARAM_IN_OUT);
+	/* Start up algorithm on target and let it idle while writing the first chunk */
+	if ((retval = target_start_algorithm(target, 0, NULL, 5, reg_params,
+			stm32x_info->write_algorithm->address,
+			0,
+			&armv7m_info)) != ERROR_OK)
+	{
+		LOG_ERROR("error starting stm32x flash write algorithm");
+		goto cleanup;
+	}
 
 	while (count > 0)
 	{
-		uint32_t thisrun_count = (count > (buffer_size / 2)) ?
-				(buffer_size / 2) : count;
-
-		if ((retval = target_write_buffer(target, source->address,
-				thisrun_count * 2, buffer)) != ERROR_OK)
+		retval = target_read_u32(target, rp_addr, &rp);
+		if (retval != ERROR_OK)
+		{
+			LOG_ERROR("failed to get read pointer");
 			break;
+		}
 
-		buf_set_u32(reg_params[0].value, 0, 32, source->address);
-		buf_set_u32(reg_params[1].value, 0, 32, address);
-		buf_set_u32(reg_params[2].value, 0, 32, thisrun_count);
-		buf_set_u32(reg_params[3].value, 0, 32, stm32x_info->register_base - FLASH_REG_BASE_B0);
+		LOG_DEBUG("count 0x%"PRIx32" wp 0x%"PRIx32" rp 0x%"PRIx32, count, wp, rp);
 
-		if ((retval = target_run_algorithm(target, 0, NULL, 4, reg_params,
-				stm32x_info->write_algorithm->address,
-				0,
-				10000, &armv7m_info)) != ERROR_OK)
+		if (rp == 0)
 		{
-			LOG_ERROR("error executing stm32x flash write algorithm");
+			LOG_ERROR("flash write algorithm aborted by target");
+			retval = ERROR_FLASH_OPERATION_FAILED;
 			break;
 		}
 
-		if (buf_get_u32(reg_params[3].value, 0, 32) & FLASH_PGERR)
+		if ((rp & 1) || rp < fifo_start_addr || rp >= fifo_end_addr)
+		{
+			LOG_ERROR("corrupted fifo read pointer 0x%"PRIx32, rp);
+			break;
+		}
+
+		/* Count the number of bytes available in the fifo without
+		 * crossing the wrap around. Make sure to not fill it completely,
+		 * because that would make wp == rp and that's the empty condition. */
+		uint32_t thisrun_bytes;
+		if (rp > wp)
+			thisrun_bytes = rp - wp - 2;
+		else if (rp > fifo_start_addr)
+			thisrun_bytes = fifo_end_addr - wp;
+		else
+			thisrun_bytes = fifo_end_addr - wp - 2;
+
+		if (thisrun_bytes == 0)
+		{
+			/* Throttle polling a bit if transfer is (much) faster than flash
+			 * programming. The exact delay shouldn't matter as long as it's
+			 * less than buffer size / flash speed. This is very unlikely to
+			 * run when using high latency connections such as USB. */
+			alive_sleep(10);
+			continue;
+		}
+
+		/* Limit to the amount of data we actually want to write */
+		if (thisrun_bytes > count * 2)
+			thisrun_bytes = count * 2;
+
+		/* Write data to fifo */
+		retval = target_write_buffer(target, wp, thisrun_bytes, buffer);
+		if (retval != ERROR_OK)
+			break;
+
+		/* Update counters and wrap write pointer */
+		buffer += thisrun_bytes;
+		count -= thisrun_bytes / 2;
+		wp += thisrun_bytes;
+		if (wp >= fifo_end_addr)
+			wp = fifo_start_addr;
+
+		/* Store updated write pointer to target */
+		retval = target_write_u32(target, wp_addr, wp);
+		if (retval != ERROR_OK)
+			break;
+	}
+
+	if (retval != ERROR_OK)
+	{
+		/* abort flash write algorithm on target */
+		target_write_u32(target, wp_addr, 0);
+	}
+
+	int retval2;
+	if ((retval2 = target_wait_algorithm(target, 0, NULL, 5, reg_params,
+			0,
+			10000,
+			&armv7m_info)) != ERROR_OK)
+	{
+		LOG_ERROR("error waiting for stm32x flash write algorithm");
+		retval = retval2;
+	}
+
+	if (retval == ERROR_FLASH_OPERATION_FAILED)
+	{
+		LOG_ERROR("flash write failed at address 0x%"PRIx32,
+				buf_get_u32(reg_params[4].value, 0, 32));
+
+		if (buf_get_u32(reg_params[0].value, 0, 32) & FLASH_PGERR)
 		{
 			LOG_ERROR("flash memory not erased before writing");
 			/* Clear but report errors */
 			target_write_u32(target, STM32_FLASH_SR_B0, FLASH_PGERR);
-			retval = ERROR_FAIL;
-			break;
 		}
 
-		if (buf_get_u32(reg_params[3].value, 0, 32) & FLASH_WRPRTERR)
+		if (buf_get_u32(reg_params[0].value, 0, 32) & FLASH_WRPRTERR)
 		{
 			LOG_ERROR("flash memory write protected");
 			/* Clear but report errors */
 			target_write_u32(target, STM32_FLASH_SR_B0, FLASH_WRPRTERR);
-			retval = ERROR_FAIL;
-			break;
 		}
-
-		buffer += thisrun_count * 2;
-		address += thisrun_count * 2;
-		count -= thisrun_count;
 	}
 
+cleanup:
 	target_free_working_area(target, source);
 	target_free_working_area(target, stm32x_info->write_algorithm);
 
@@ -743,6 +850,7 @@ static int stm32x_write_block(struct flash_bank *bank, uint8_t *buffer,
 	destroy_reg_param(&reg_params[1]);
 	destroy_reg_param(&reg_params[2]);
 	destroy_reg_param(&reg_params[3]);
+	destroy_reg_param(&reg_params[4]);
 
 	return retval;
 }

commit a147563ac1e96e3dbe56770a9f958a7b47cc0fc8
Author: Andreas Fritiofson <andreas.fritiofson at gmail.com>
Date:   Sun Jul 17 14:07:26 2011 +0200

    stm32f1x: use register base instead of register offset
    
    Access the different flash banks' registers using a bank specific register
    base and a register specific offset. This is equivalent but feels more
    natural.
    
    Some accesses were discovered that maybe should not be hard coded to bank0
    registers. Add a note about that.
    
    Signed-off-by: Andreas Fritiofson <andreas.fritiofson at gmail.com>

diff --git a/src/flash/nor/stm32f1x.c b/src/flash/nor/stm32f1x.c
index 4927fb8..142b03e 100644
--- a/src/flash/nor/stm32f1x.c
+++ b/src/flash/nor/stm32f1x.c
@@ -31,14 +31,29 @@
 
 /* stm32x register locations */
 
-#define STM32_FLASH_ACR		0x40022000
-#define STM32_FLASH_KEYR	0x40022004
-#define STM32_FLASH_OPTKEYR	0x40022008
-#define STM32_FLASH_SR		0x4002200C
-#define STM32_FLASH_CR		0x40022010
-#define STM32_FLASH_AR		0x40022014
-#define STM32_FLASH_OBR		0x4002201C
-#define STM32_FLASH_WRPR	0x40022020
+#define FLASH_REG_BASE_B0 0x40022000
+#define FLASH_REG_BASE_B1 0x40022040
+
+#define STM32_FLASH_ACR     0x00
+#define STM32_FLASH_KEYR    0x04
+#define STM32_FLASH_OPTKEYR 0x08
+#define STM32_FLASH_SR      0x0C
+#define STM32_FLASH_CR      0x10
+#define STM32_FLASH_AR      0x14
+#define STM32_FLASH_OBR     0x1C
+#define STM32_FLASH_WRPR    0x20
+
+/* TODO: Check if code using these really should be hard coded to bank 0.
+ * There are valid cases, on dual flash devices the protection of the
+ * second bank is done on the bank0 reg's. */
+#define STM32_FLASH_ACR_B0     0x40022000
+#define STM32_FLASH_KEYR_B0    0x40022004
+#define STM32_FLASH_OPTKEYR_B0 0x40022008
+#define STM32_FLASH_SR_B0      0x4002200C
+#define STM32_FLASH_CR_B0      0x40022010
+#define STM32_FLASH_AR_B0      0x40022014
+#define STM32_FLASH_OBR_B0     0x4002201C
+#define STM32_FLASH_WRPR_B0    0x40022020
 
 /* option byte location */
 
@@ -83,12 +98,6 @@
 #define KEY1			0x45670123
 #define KEY2			0xCDEF89AB
 
-/* we use an offset to access the second bank on dual flash devices
- * strangely the protection of the second bank is done on the bank0 reg's */
-
-#define FLASH_OFFSET_B0	0x00
-#define FLASH_OFFSET_B1 0x40
-
 struct stm32x_options
 {
 	uint16_t RDP;
@@ -104,10 +113,8 @@ struct stm32x_flash_bank
 	int probed;
 
 	bool has_dual_banks;
-	/* used to access dual flash bank stm32xl
-	 * 0x00 will address bank 0 flash
-	 * 0x40 will address bank 1 flash */
-	int register_offset;
+	/* used to access dual flash bank stm32xl */
+	uint32_t register_base;
 };
 
 static int stm32x_mass_erase(struct flash_bank *bank);
@@ -130,7 +137,7 @@ FLASH_BANK_COMMAND_HANDLER(stm32x_flash_bank_command)
 	stm32x_info->write_algorithm = NULL;
 	stm32x_info->probed = 0;
 	stm32x_info->has_dual_banks = false;
-	stm32x_info->register_offset = FLASH_OFFSET_B0;
+	stm32x_info->register_base = FLASH_REG_BASE_B0;
 
 	return ERROR_OK;
 }
@@ -138,7 +145,7 @@ FLASH_BANK_COMMAND_HANDLER(stm32x_flash_bank_command)
 static inline int stm32x_get_flash_reg(struct flash_bank *bank, uint32_t reg)
 {
 	struct stm32x_flash_bank *stm32x_info = bank->driver_priv;
-	return reg + stm32x_info->register_offset;
+	return reg + stm32x_info->register_base;
 }
 
 static inline int stm32x_get_flash_status(struct flash_bank *bank, uint32_t *status)
@@ -200,7 +207,7 @@ int stm32x_check_operation_supported(struct flash_bank *bank)
 
 	/* if we have a dual flash bank device then
 	 * we need to perform option byte stuff on bank0 only */
-	if (stm32x_info->register_offset != FLASH_OFFSET_B0)
+	if (stm32x_info->register_base != FLASH_REG_BASE_B0)
 	{
 		LOG_ERROR("Option Byte Operation's must use bank0");
 		return ERROR_FLASH_OPERATION_FAILED;
@@ -218,7 +225,7 @@ static int stm32x_read_options(struct flash_bank *bank)
 	stm32x_info = bank->driver_priv;
 
 	/* read current option bytes */
-	int retval = target_read_u32(target, STM32_FLASH_OBR, &optiondata);
+	int retval = target_read_u32(target, STM32_FLASH_OBR_B0, &optiondata);
 	if (retval != ERROR_OK)
 		return retval;
 
@@ -229,7 +236,7 @@ static int stm32x_read_options(struct flash_bank *bank)
 		LOG_INFO("Device Security Bit Set");
 
 	/* each bit refers to a 4bank protection */
-	retval = target_read_u32(target, STM32_FLASH_WRPR, &optiondata);
+	retval = target_read_u32(target, STM32_FLASH_WRPR_B0, &optiondata);
 	if (retval != ERROR_OK)
 		return retval;
 
@@ -252,27 +259,27 @@ static int stm32x_erase_options(struct flash_bank *bank)
 	stm32x_read_options(bank);
 
 	/* unlock flash registers */
-	int retval = target_write_u32(target, STM32_FLASH_KEYR, KEY1);
+	int retval = target_write_u32(target, STM32_FLASH_KEYR_B0, KEY1);
 	if (retval != ERROR_OK)
 		return retval;
 
-	retval = target_write_u32(target, STM32_FLASH_KEYR, KEY2);
+	retval = target_write_u32(target, STM32_FLASH_KEYR_B0, KEY2);
 	if (retval != ERROR_OK)
 		return retval;
 
 	/* unlock option flash registers */
-	retval = target_write_u32(target, STM32_FLASH_OPTKEYR, KEY1);
+	retval = target_write_u32(target, STM32_FLASH_OPTKEYR_B0, KEY1);
 	if (retval != ERROR_OK)
 		return retval;
-	retval = target_write_u32(target, STM32_FLASH_OPTKEYR, KEY2);
+	retval = target_write_u32(target, STM32_FLASH_OPTKEYR_B0, KEY2);
 	if (retval != ERROR_OK)
 		return retval;
 
 	/* erase option bytes */
-	retval = target_write_u32(target, STM32_FLASH_CR, FLASH_OPTER | FLASH_OPTWRE);
+	retval = target_write_u32(target, STM32_FLASH_CR_B0, FLASH_OPTER | FLASH_OPTWRE);
 	if (retval != ERROR_OK)
 		return retval;
-	retval = target_write_u32(target, STM32_FLASH_CR, FLASH_OPTER | FLASH_STRT | FLASH_OPTWRE);
+	retval = target_write_u32(target, STM32_FLASH_CR_B0, FLASH_OPTER | FLASH_STRT | FLASH_OPTWRE);
 	if (retval != ERROR_OK)
 		return retval;
 
@@ -295,23 +302,23 @@ static int stm32x_write_options(struct flash_bank *bank)
 	stm32x_info = bank->driver_priv;
 
 	/* unlock flash registers */
-	int retval = target_write_u32(target, STM32_FLASH_KEYR, KEY1);
+	int retval = target_write_u32(target, STM32_FLASH_KEYR_B0, KEY1);
 	if (retval != ERROR_OK)
 		return retval;
-	retval = target_write_u32(target, STM32_FLASH_KEYR, KEY2);
+	retval = target_write_u32(target, STM32_FLASH_KEYR_B0, KEY2);
 	if (retval != ERROR_OK)
 		return retval;
 
 	/* unlock option flash registers */
-	retval = target_write_u32(target, STM32_FLASH_OPTKEYR, KEY1);
+	retval = target_write_u32(target, STM32_FLASH_OPTKEYR_B0, KEY1);
 	if (retval != ERROR_OK)
 		return retval;
-	retval = target_write_u32(target, STM32_FLASH_OPTKEYR, KEY2);
+	retval = target_write_u32(target, STM32_FLASH_OPTKEYR_B0, KEY2);
 	if (retval != ERROR_OK)
 		return retval;
 
 	/* program option bytes */
-	retval = target_write_u32(target, STM32_FLASH_CR, FLASH_OPTPG | FLASH_OPTWRE);
+	retval = target_write_u32(target, STM32_FLASH_CR_B0, FLASH_OPTPG | FLASH_OPTWRE);
 	if (retval != ERROR_OK)
 		return retval;
 
@@ -369,7 +376,7 @@ static int stm32x_write_options(struct flash_bank *bank)
 	if (retval != ERROR_OK)
 		return retval;
 
-	retval = target_write_u32(target, STM32_FLASH_CR, FLASH_LOCK);
+	retval = target_write_u32(target, STM32_FLASH_CR_B0, FLASH_LOCK);
 	if (retval != ERROR_OK)
 		return retval;
 
@@ -398,7 +405,7 @@ static int stm32x_protect_check(struct flash_bank *bank)
 
 	/* medium density - each bit refers to a 4bank protection
 	 * high density - each bit refers to a 2bank protection */
-	retval = target_read_u32(target, STM32_FLASH_WRPR, &protection);
+	retval = target_read_u32(target, STM32_FLASH_WRPR_B0, &protection);
 	if (retval != ERROR_OK)
 		return retval;
 
@@ -544,7 +551,7 @@ static int stm32x_protect(struct flash_bank *bank, int set, int first, int last)
 
 	/* medium density - each bit refers to a 4bank protection
 	 * high density - each bit refers to a 2bank protection */
-	retval = target_read_u32(target, STM32_FLASH_WRPR, &protection);
+	retval = target_read_u32(target, STM32_FLASH_WRPR_B0, &protection);
 	if (retval != ERROR_OK)
 		return retval;
 
@@ -695,7 +702,7 @@ static int stm32x_write_block(struct flash_bank *bank, uint8_t *buffer,
 		buf_set_u32(reg_params[0].value, 0, 32, source->address);
 		buf_set_u32(reg_params[1].value, 0, 32, address);
 		buf_set_u32(reg_params[2].value, 0, 32, thisrun_count);
-		buf_set_u32(reg_params[3].value, 0, 32, stm32x_info->register_offset);
+		buf_set_u32(reg_params[3].value, 0, 32, stm32x_info->register_base - FLASH_REG_BASE_B0);
 
 		if ((retval = target_run_algorithm(target, 0, NULL, 4, reg_params,
 				stm32x_info->write_algorithm->address,
@@ -710,7 +717,7 @@ static int stm32x_write_block(struct flash_bank *bank, uint8_t *buffer,
 		{
 			LOG_ERROR("flash memory not erased before writing");
 			/* Clear but report errors */
-			target_write_u32(target, STM32_FLASH_SR, FLASH_PGERR);
+			target_write_u32(target, STM32_FLASH_SR_B0, FLASH_PGERR);
 			retval = ERROR_FAIL;
 			break;
 		}
@@ -719,7 +726,7 @@ static int stm32x_write_block(struct flash_bank *bank, uint8_t *buffer,
 		{
 			LOG_ERROR("flash memory write protected");
 			/* Clear but report errors */
-			target_write_u32(target, STM32_FLASH_SR, FLASH_WRPRTERR);
+			target_write_u32(target, STM32_FLASH_SR_B0, FLASH_WRPRTERR);
 			retval = ERROR_FAIL;
 			break;
 		}
@@ -832,7 +839,7 @@ static int stm32x_write(struct flash_bank *bank, uint8_t *buffer,
 			return retval;
 	}
 
-	return target_write_u32(target, STM32_FLASH_CR, FLASH_LOCK);
+	return target_write_u32(target, STM32_FLASH_CR_B0, FLASH_LOCK);
 }
 
 static int stm32x_probe(struct flash_bank *bank)
@@ -846,7 +853,7 @@ static int stm32x_probe(struct flash_bank *bank)
 	uint32_t base_address = 0x08000000;
 
 	stm32x_info->probed = 0;
-	stm32x_info->register_offset = FLASH_OFFSET_B0;
+	stm32x_info->register_base = FLASH_REG_BASE_B0;
 
 	/* read stm32 device id register */
 	int retval = target_read_u32(target, 0xE0042000, &device_id);
@@ -980,7 +987,7 @@ static int stm32x_probe(struct flash_bank *bank)
 		{
 			num_pages -= 512;
 			/* bank1 also uses a register offset */
-			stm32x_info->register_offset = FLASH_OFFSET_B1;
+			stm32x_info->register_base = FLASH_REG_BASE_B1;
 			base_address = 0x08080000;
 		}
 	}
@@ -1328,7 +1335,7 @@ COMMAND_HANDLER(stm32x_handle_options_read_command)
 	if (ERROR_OK != retval)
 		return retval;
 
-	retval = target_read_u32(target, STM32_FLASH_OBR, &optionbyte);
+	retval = target_read_u32(target, STM32_FLASH_OBR_B0, &optionbyte);
 	if (retval != ERROR_OK)
 		return retval;
 	command_print(CMD_CTX, "Option Byte: 0x%" PRIx32 "", optionbyte);

commit 1163435e19f316a4a97fd33f1467f5c1684db654
Author: Andreas Fritiofson <andreas.fritiofson at gmail.com>
Date:   Fri Jul 15 22:21:34 2011 +0200

    cortex_m3: use armv7m's async algorithm implementation
    
    Signed-off-by: Andreas Fritiofson <andreas.fritiofson at gmail.com>

diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index 98a775c..a2f8b78 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -2329,6 +2329,8 @@ struct target_type cortexm3_target =
 	.blank_check_memory = armv7m_blank_check_memory,
 
 	.run_algorithm = armv7m_run_algorithm,
+	.start_algorithm = armv7m_start_algorithm,
+	.wait_algorithm = armv7m_wait_algorithm,
 
 	.add_breakpoint = cortex_m3_add_breakpoint,
 	.remove_breakpoint = cortex_m3_remove_breakpoint,

commit 9d4c466c219039bd6a2ea03467cd3ee8be2a0e76
Author: Andreas Fritiofson <andreas.fritiofson at gmail.com>
Date:   Fri Jul 15 22:20:34 2011 +0200

    armv7m: implement async algorithm functions
    
    Split armv7m_run_algorithm into two pieces and use them to reimplement it.
    The arch_info parameter is used to keep context between the two calls, so
    both calls must refer to the same armv7m_algorithm struct. Ugly but works
    for a proof-of-concept.
    
    Signed-off-by: Andreas Fritiofson <andreas.fritiofson at gmail.com>

diff --git a/src/target/armv7m.c b/src/target/armv7m.c
index fff5dd8..39a89b9 100644
--- a/src/target/armv7m.c
+++ b/src/target/armv7m.c
@@ -287,53 +287,42 @@ int armv7m_get_gdb_reg_list(struct target *target, struct reg **reg_list[], int
 	return ERROR_OK;
 }
 
-/* run to exit point. return error if exit point was not reached. */
-static int armv7m_run_and_wait(struct target *target, uint32_t entry_point, int timeout_ms, uint32_t exit_point, struct armv7m_common *armv7m)
+/** Runs a Thumb algorithm in the target. */
+int armv7m_run_algorithm(struct target *target,
+	int num_mem_params, struct mem_param *mem_params,
+	int num_reg_params, struct reg_param *reg_params,
+	uint32_t entry_point, uint32_t exit_point,
+	int timeout_ms, void *arch_info)
 {
-	uint32_t pc;
 	int retval;
-	/* This code relies on the target specific  resume() and  poll()->debug_entry()
-	 * sequence to write register values to the processor and the read them back */
-	if ((retval = target_resume(target, 0, entry_point, 1, 1)) != ERROR_OK)
-	{
-		return retval;
-	}
 
-	retval = target_wait_state(target, TARGET_HALTED, timeout_ms);
-	/* If the target fails to halt due to the breakpoint, force a halt */
-	if (retval != ERROR_OK || target->state != TARGET_HALTED)
-	{
-		if ((retval = target_halt(target)) != ERROR_OK)
-			return retval;
-		if ((retval = target_wait_state(target, TARGET_HALTED, 500)) != ERROR_OK)
-		{
-			return retval;
-		}
-		return ERROR_TARGET_TIMEOUT;
-	}
+	retval = armv7m_start_algorithm(target,
+			num_mem_params, mem_params,
+			num_reg_params, reg_params,
+			entry_point, exit_point,
+			arch_info);
 
-	armv7m->load_core_reg_u32(target, ARMV7M_REGISTER_CORE_GP, 15, &pc);
-	if (exit_point && (pc != exit_point))
-	{
-		LOG_DEBUG("failed algorithm halted at 0x%" PRIx32 " ", pc);
-		return ERROR_TARGET_TIMEOUT;
-	}
+	if (retval == ERROR_OK)
+		retval = armv7m_wait_algorithm(target,
+				num_mem_params, mem_params,
+				num_reg_params, reg_params,
+				exit_point, timeout_ms,
+				arch_info);
 
-	return ERROR_OK;
+	return retval;
 }
 
-/** Runs a Thumb algorithm in the target. */
-int armv7m_run_algorithm(struct target *target,
+/** Starts a Thumb algorithm in the target. */
+int armv7m_start_algorithm(struct target *target,
 	int num_mem_params, struct mem_param *mem_params,
 	int num_reg_params, struct reg_param *reg_params,
 	uint32_t entry_point, uint32_t exit_point,
-	int timeout_ms, void *arch_info)
+	void *arch_info)
 {
 	struct armv7m_common *armv7m = target_to_armv7m(target);
 	struct armv7m_algorithm *armv7m_algorithm_info = arch_info;
 	enum armv7m_mode core_mode = armv7m->core_mode;
 	int retval = ERROR_OK;
-	uint32_t context[ARMV7M_NUM_REGS];
 
 	/* NOTE: armv7m_run_algorithm requires that each algorithm uses a software breakpoint
 	 * at the exit point */
@@ -356,11 +345,12 @@ int armv7m_run_algorithm(struct target *target,
 	{
 		if (!armv7m->core_cache->reg_list[i].valid)
 			armv7m->read_core_reg(target, i);
-		context[i] = buf_get_u32(armv7m->core_cache->reg_list[i].value, 0, 32);
+		armv7m_algorithm_info->context[i] = buf_get_u32(armv7m->core_cache->reg_list[i].value, 0, 32);
 	}
 
 	for (int i = 0; i < num_mem_params; i++)
 	{
+		// TODO: Write only out params
 		if ((retval = target_write_buffer(target, mem_params[i].address, mem_params[i].size, mem_params[i].value)) != ERROR_OK)
 			return retval;
 	}
@@ -394,12 +384,52 @@ int armv7m_run_algorithm(struct target *target,
 		armv7m->core_cache->reg_list[ARMV7M_CONTROL].dirty = 1;
 		armv7m->core_cache->reg_list[ARMV7M_CONTROL].valid = 1;
 	}
+	armv7m_algorithm_info->core_mode = core_mode;
 
-	retval = armv7m_run_and_wait(target, entry_point, timeout_ms, exit_point, armv7m);
+	retval = target_resume(target, 0, entry_point, 1, 1);
 
-	if (retval != ERROR_OK)
+	return retval;
+}
+
+/** Waits for an algorithm in the target. */
+int armv7m_wait_algorithm(struct target *target,
+	int num_mem_params, struct mem_param *mem_params,
+	int num_reg_params, struct reg_param *reg_params,
+	uint32_t exit_point, int timeout_ms,
+	void *arch_info)
+{
+	struct armv7m_common *armv7m = target_to_armv7m(target);
+	struct armv7m_algorithm *armv7m_algorithm_info = arch_info;
+	int retval = ERROR_OK;
+	uint32_t pc;
+
+	/* NOTE: armv7m_run_algorithm requires that each algorithm uses a software breakpoint
+	 * at the exit point */
+
+	if (armv7m_algorithm_info->common_magic != ARMV7M_COMMON_MAGIC)
 	{
-		return retval;
+		LOG_ERROR("current target isn't an ARMV7M target");
+		return ERROR_TARGET_INVALID;
+	}
+
+	retval = target_wait_state(target, TARGET_HALTED, timeout_ms);
+	/* If the target fails to halt due to the breakpoint, force a halt */
+	if (retval != ERROR_OK || target->state != TARGET_HALTED)
+	{
+		if ((retval = target_halt(target)) != ERROR_OK)
+			return retval;
+		if ((retval = target_wait_state(target, TARGET_HALTED, 500)) != ERROR_OK)
+		{
+			return retval;
+		}
+		return ERROR_TARGET_TIMEOUT;
+	}
+
+	armv7m->load_core_reg_u32(target, ARMV7M_REGISTER_CORE_GP, 15, &pc);
+	if (exit_point && (pc != exit_point))
+	{
+		LOG_DEBUG("failed algorithm halted at 0x%" PRIx32 ", expected 0x%" PRIx32 , pc, exit_point);
+		return ERROR_TARGET_TIMEOUT;
 	}
 
 	/* Read memory values to mem_params[] */
@@ -439,18 +469,18 @@ int armv7m_run_algorithm(struct target *target,
 	{
 		uint32_t regvalue;
 		regvalue = buf_get_u32(armv7m->core_cache->reg_list[i].value, 0, 32);
-		if (regvalue != context[i])
+		if (regvalue != armv7m_algorithm_info->context[i])
 		{
 			LOG_DEBUG("restoring register %s with value 0x%8.8" PRIx32,
-				armv7m->core_cache->reg_list[i].name, context[i]);
+				armv7m->core_cache->reg_list[i].name, armv7m_algorithm_info->context[i]);
 			buf_set_u32(armv7m->core_cache->reg_list[i].value,
-					0, 32, context[i]);
+					0, 32, armv7m_algorithm_info->context[i]);
 			armv7m->core_cache->reg_list[i].valid = 1;
 			armv7m->core_cache->reg_list[i].dirty = 1;
 		}
 	}
 
-	armv7m->core_mode = core_mode;
+	armv7m->core_mode = armv7m_algorithm_info->core_mode;
 
 	return retval;
 }
diff --git a/src/target/armv7m.h b/src/target/armv7m.h
index 8ef3800..ca92146 100644
--- a/src/target/armv7m.h
+++ b/src/target/armv7m.h
@@ -142,6 +142,8 @@ struct armv7m_algorithm
 	int common_magic;
 
 	enum armv7m_mode core_mode;
+
+	uint32_t context[ARMV7M_CONTROL + 1]; //ARMV7M_NUM_REGS
 };
 
 struct armv7m_core_reg
@@ -168,6 +170,18 @@ int armv7m_run_algorithm(struct target *target,
 		uint32_t entry_point, uint32_t exit_point,
 		int timeout_ms, void *arch_info);
 
+int armv7m_start_algorithm(struct target *target,
+		int num_mem_params, struct mem_param *mem_params,
+		int num_reg_params, struct reg_param *reg_params,
+		uint32_t entry_point, uint32_t exit_point,
+		void *arch_info);
+
+int armv7m_wait_algorithm(struct target *target,
+		int num_mem_params, struct mem_param *mem_params,
+		int num_reg_params, struct reg_param *reg_params,
+		uint32_t exit_point, int timeout_ms,
+		void *arch_info);
+
 int armv7m_invalidate_core_regs(struct target *target);
 
 int armv7m_restore_context(struct target *target);

commit 3f6ef7a40bcff5e1278b662248902c45a1dc8f81
Author: Andreas Fritiofson <andreas.fritiofson at gmail.com>
Date:   Fri Jul 15 22:18:39 2011 +0200

    target: add async algorithm entries to the target type
    
    On supported targets, this may be used to start a long running algorithm in
    the background so the target may be interacted with during execution and
    later wait for its completion.
    
    The most obvious use case is a double buffered flash algorithm that can
    upload the next block of data while the algorithm is flashing the current.
    
    Signed-off-by: Andreas Fritiofson <andreas.fritiofson at gmail.com>

diff --git a/src/target/target.c b/src/target/target.c
index be9742f..6a60b4e 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -732,6 +732,81 @@ done:
 	return retval;
 }
 
+/**
+ * Downloads a target-specific native code algorithm to the target,
+ * executes and leaves it running.
+ *
+ * @param target used to run the algorithm
+ * @param arch_info target-specific description of the algorithm.
+ */
+int target_start_algorithm(struct target *target,
+		int num_mem_params, struct mem_param *mem_params,
+		int num_reg_params, struct reg_param *reg_params,
+		uint32_t entry_point, uint32_t exit_point,
+		void *arch_info)
+{
+	int retval = ERROR_FAIL;
+
+	if (!target_was_examined(target))
+	{
+		LOG_ERROR("Target not examined yet");
+		goto done;
+	}
+	if (!target->type->start_algorithm) {
+		LOG_ERROR("Target type '%s' does not support %s",
+				target_type_name(target), __func__);
+		goto done;
+	}
+	if (target->running_alg) {
+		LOG_ERROR("Target is already running an algorithm");
+		goto done;
+	}
+
+	target->running_alg = true;
+	retval = target->type->start_algorithm(target,
+			num_mem_params, mem_params,
+			num_reg_params, reg_params,
+			entry_point, exit_point, arch_info);
+
+done:
+	return retval;
+}
+
+/**
+ * Waits for an algorithm started with target_start_algorithm() to complete.
+ *
+ * @param target used to run the algorithm
+ * @param arch_info target-specific description of the algorithm.
+ */
+int target_wait_algorithm(struct target *target,
+		int num_mem_params, struct mem_param *mem_params,
+		int num_reg_params, struct reg_param *reg_params,
+		uint32_t exit_point, int timeout_ms,
+		void *arch_info)
+{
+	int retval = ERROR_FAIL;
+
+	if (!target->type->wait_algorithm) {
+		LOG_ERROR("Target type '%s' does not support %s",
+				target_type_name(target), __func__);
+		goto done;
+	}
+	if (!target->running_alg) {
+		LOG_ERROR("Target is not running an algorithm");
+		goto done;
+	}
+
+	retval = target->type->wait_algorithm(target,
+			num_mem_params, mem_params,
+			num_reg_params, reg_params,
+			exit_point, timeout_ms, arch_info);
+	if (retval != ERROR_TARGET_TIMEOUT)
+		target->running_alg = false;
+
+done:
+	return retval;
+}
+
 
 int target_read_memory(struct target *target,
 		uint32_t address, uint32_t size, uint32_t count, uint8_t *buffer)
diff --git a/src/target/target.h b/src/target/target.h
index 5248d69..12726bd 100644
--- a/src/target/target.h
+++ b/src/target/target.h
@@ -432,6 +432,28 @@ int target_run_algorithm(struct target *target,
 		int timeout_ms, void *arch_info);
 
 /**
+ * Starts an algorithm in the background on the @a target given.
+ *
+ * This routine is a wrapper for target->type->start_algorithm.
+ */
+int target_start_algorithm(struct target *target,
+		int num_mem_params, struct mem_param *mem_params,
+		int num_reg_params, struct reg_param *reg_params,
+		uint32_t entry_point, uint32_t exit_point,
+		void *arch_info);
+
+/**
+ * Wait for an algorithm on the @a target given.
+ *
+ * This routine is a wrapper for target->type->wait_algorithm.
+ */
+int target_wait_algorithm(struct target *target,
+		int num_mem_params, struct mem_param *mem_params,
+		int num_reg_params, struct reg_param *reg_params,
+		uint32_t exit_point, int timeout_ms,
+		void *arch_info);
+
+/**
  * Read @a count items of @a size bytes from the memory of @a target at
  * the @a address given.
  *
diff --git a/src/target/target_type.h b/src/target/target_type.h
index fc062da..10b6f33 100644
--- a/src/target/target_type.h
+++ b/src/target/target_type.h
@@ -171,6 +171,8 @@ struct target_type
 	 * use target_run_algorithm() instead.
 	 */
 	int (*run_algorithm)(struct target *target, int num_mem_params, struct mem_param *mem_params, int num_reg_params, struct reg_param *reg_param, uint32_t entry_point, uint32_t exit_point, int timeout_ms, void *arch_info);
+	int (*start_algorithm)(struct target *target, int num_mem_params, struct mem_param *mem_params, int num_reg_params, struct reg_param *reg_param, uint32_t entry_point, uint32_t exit_point, void *arch_info);
+	int (*wait_algorithm)(struct target *target, int num_mem_params, struct mem_param *mem_params, int num_reg_params, struct reg_param *reg_param, uint32_t exit_point, int timeout_ms, void *arch_info);
 
 	const struct command_registration *commands;
 

-----------------------------------------------------------------------

Summary of changes:
 contrib/loaders/flash/{stm32x.S => stm32f1x.S} |   71 ++++---
 src/flash/nor/stm32f1x.c                       |  303 ++++++++++++++++--------
 src/target/armv7m.c                            |  110 ++++++---
 src/target/armv7m.h                            |   14 +
 src/target/cortex_m3.c                         |    2 +
 src/target/target.c                            |   75 ++++++
 src/target/target.h                            |   22 ++
 src/target/target_type.h                       |    2 +
 8 files changed, 436 insertions(+), 163 deletions(-)
 rename contrib/loaders/flash/{stm32x.S => stm32f1x.S} (51%)


hooks/post-receive
-- 
Main OpenOCD repository


From ntfreak at users.sourceforge.net  Tue Oct 11 12:14:39 2011
From: ntfreak at users.sourceforge.net (Spencer Oliver)
Date: Tue, 11 Oct 2011 10:14:39 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, v0.3.1,
	deleted. v0.3.1
Message-ID: <mailman.184.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, v0.3.1 has been deleted
       was  371530224ce8b485d3cff59a4d6062d148bdad02

-----------------------------------------------------------------------
371530224ce8b485d3cff59a4d6062d148bdad02 Version 0.3.1
-----------------------------------------------------------------------


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Tue Oct 11 20:50:49 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Tue, 11 Oct 2011 18:50:49 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-106-gcf692ab
Message-ID: <mailman.185.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  cf692abe83a90f74cb21b1864f348cd52fe26454 (commit)
      from  43689d3371714a100ad610ec1857b4d0c2219636 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit cf692abe83a90f74cb21b1864f348cd52fe26454
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Tue Oct 11 17:18:05 2011 +0100

    replace berlios url's with sourceforge url's
    
    Change-Id: I1c9957bb64df87cee7c5e832f21453eb8934a5fb
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/README b/README
index 7c1b5b2..62d1f77 100644
--- a/README
+++ b/README
@@ -23,10 +23,10 @@ In addition to in-tree documentation, the latest documentation may be
 viewed on-line at the following URLs:
 
  OpenOCD User's Guide:
-    http://openocd.berlios.de/doc/html/index.html
+    http://openocd.sourceforge.net/doc/html/index.html
 
  OpenOCD Developer's Manual:
-    http://openocd.berlios.de/doc/doxygen/index.html
+    http://openocd.sourceforge.net/doc/doxygen/index.html
 
 These reflect the latest development versions, so the following section
 introduces how to build the complete documentation from the package.
@@ -35,7 +35,7 @@ introduces how to build the complete documentation from the package.
 For more information, refer to these documents or contact the developers
 by subscribing to the OpenOCD developer mailing list:
 
-	openocd-development at lists.berlios.de
+	openocd-devel at lists.sourceforge.net
 
 Building the OpenOCD Documentation
 ----------------------------------
diff --git a/configure.ac b/configure.ac
index ef847ec..d0386bc 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1,6 +1,6 @@
 AC_PREREQ(2.60)
 AC_INIT([openocd], [0.6.0-dev],
-  [OpenOCD Mailing List <openocd-development at lists.berlios.de>])
+  [OpenOCD Mailing List <openocd-devel at lists.sourceforge.net>])
 AC_CONFIG_SRCDIR([src/openocd.c])
 
 m4_include(config_subdir.m4)dnl
diff --git a/doc/openocd.texi b/doc/openocd.texi
index 05c06b8..817c4f9 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -168,7 +168,7 @@ STM32x). Preliminary support for various NAND flash controllers
 
 The OpenOCD web site provides the latest public news from the community:
 
- at uref{http://openocd.berlios.de/web/}
+ at uref{http://openocd.sourceforge.net/web/}
 
 @section Latest User's Guide:
 
@@ -176,11 +176,11 @@ The user's guide you are now reading may not be the latest one
 available.  A version for more recent code may be available.
 Its HTML form is published irregularly at:
 
- at uref{http://openocd.berlios.de/doc/html/index.html}
+ at uref{http://openocd.sourceforge.net/doc/html/index.html}
 
 PDF form is likewise published at:
 
- at uref{http://openocd.berlios.de/doc/pdf/openocd.pdf}
+ at uref{http://openocd.sourceforge.net/doc/pdf/openocd.pdf}
 
 @section OpenOCD User's Forum
 
@@ -241,7 +241,7 @@ providing a Doxygen reference manual.  This document contains more
 technical information about the software internals, development
 processes, and similar documentation:
 
- at uref{http://openocd.berlios.de/doc/doxygen/index.html}
+ at uref{http://openocd.sourceforge.net/doc/doxygen/index.html}
 
 This document is a work-in-progress, but contributions would be welcome
 to fill in the gaps.  All of the source files are provided in-tree,
@@ -252,7 +252,7 @@ listed in the Doxyfile configuration in the top of the source tree.
 The OpenOCD Developer Mailing List provides the primary means of
 communication between developers:
 
- at uref{https://lists.berlios.de/mailman/listinfo/openocd-development}
+ at uref{https://lists.sourceforge.net/mailman/listinfo/openocd-devel}
 
 Discuss and submit patches to this list.
 The @file{PATCHES.txt} file contains basic information about how
@@ -632,7 +632,7 @@ If all goes well you'll see output something like
 @example
 Open On-Chip Debugger 0.4.0 (2010-01-14-15:06)
 For bug reports, read
-        http://openocd.berlios.de/doc/doxygen/bugs.html
+        http://openocd.sourceforge.net/doc/doxygen/bugs.html
 Info : JTAG tap: lm3s.cpu tap/device found: 0x3ba00477
        (mfg: 0x23b, part: 0xba00, ver: 0x3)
 @end example
diff --git a/src/openocd.c b/src/openocd.c
index c492030..2c27fc4 100644
--- a/src/openocd.c
+++ b/src/openocd.c
@@ -329,7 +329,7 @@ int openocd_main(int argc, char *argv[])
 		return EXIT_FAILURE;
 
 	LOG_OUTPUT("For bug reports, read\n\t"
-		"http://openocd.berlios.de/doc/doxygen/bugs.html"
+		"http://openocd.sourceforge.net/doc/doxygen/bugs.html"
 		"\n");
 
 	command_context_mode(cmd_ctx, COMMAND_CONFIG);

-----------------------------------------------------------------------

Summary of changes:
 README           |    6 +++---
 configure.ac     |    2 +-
 doc/openocd.texi |   12 ++++++------
 src/openocd.c    |    2 +-
 4 files changed, 11 insertions(+), 11 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Tue Oct 11 23:50:29 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Tue, 11 Oct 2011 21:50:29 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-107-g3ab7855
Message-ID: <mailman.186.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  3ab7855d1a7513df523cf59ef4a735cdedb46362 (commit)
      from  cf692abe83a90f74cb21b1864f348cd52fe26454 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 3ab7855d1a7513df523cf59ef4a735cdedb46362
Author: Michel Jaouen <michel.jaouen at stericsson.com>
Date:   Mon Oct 3 19:03:47 2011 +0200

    breakpoint : indentation
    
    Change-Id: Icdb8f72dbb516cd0dfc612c3d61b6801f6382be6
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/breakpoints.c b/src/target/breakpoints.c
index 5a0fc40..e722f67 100644
--- a/src/target/breakpoints.c
+++ b/src/target/breakpoints.c
@@ -63,7 +63,7 @@ int breakpoint_add_internal(struct target *target, uint32_t address, uint32_t le
 			 * succeeding.
 			 */
 			LOG_DEBUG("Duplicate Breakpoint address: 0x%08" PRIx32 " (BP %d)",
-				  address, breakpoint->unique_id );
+					address, breakpoint->unique_id);
 			return ERROR_OK;
 		}
 		breakpoint_p = &breakpoint->next;
@@ -101,9 +101,9 @@ fail:
 	}
 
 	LOG_DEBUG("added %s breakpoint at 0x%8.8" PRIx32 " of length 0x%8.8x, (BPID: %d)",
-			  breakpoint_type_strings[(*breakpoint_p)->type],
-			  (*breakpoint_p)->address, (*breakpoint_p)->length,
-			  (*breakpoint_p)->unique_id  );
+			breakpoint_type_strings[(*breakpoint_p)->type],
+			(*breakpoint_p)->address, (*breakpoint_p)->length,
+			(*breakpoint_p)->unique_id);
 
 	return ERROR_OK;
 }
@@ -119,14 +119,14 @@ int context_breakpoint_add_internal(struct target *target, uint32_t asid, uint32
 	while (breakpoint)
 	{
 		n++;
-		if (breakpoint->asid == asid) 
+		if (breakpoint->asid == asid)
 		{
 			/* FIXME don't assume "same address" means "same
 			 * breakpoint" ... check all the parameters before
 			 * succeeding.
 			 */
 			LOG_DEBUG("Duplicate Breakpoint asid: 0x%08" PRIx32 " (BP %d)",
-					asid, breakpoint->unique_id );
+					asid, breakpoint->unique_id);
 			return -1;
 		}
 		breakpoint_p = &breakpoint->next;
@@ -155,13 +155,13 @@ int context_breakpoint_add_internal(struct target *target, uint32_t asid, uint32
 	LOG_DEBUG("added %s Context breakpoint at 0x%8.8" PRIx32 " of length 0x%8.8x, (BPID: %d)",
 			breakpoint_type_strings[(*breakpoint_p)->type],
 			(*breakpoint_p)->asid, (*breakpoint_p)->length,
-			(*breakpoint_p)->unique_id  );
+			(*breakpoint_p)->unique_id);
 
 	return ERROR_OK;
 }
 
 int hybrid_breakpoint_add_internal(struct target *target, uint32_t address, uint32_t asid, uint32_t length, enum breakpoint_type type)
-{	
+{
 	struct breakpoint *breakpoint = target->breakpoints;
 	struct breakpoint **breakpoint_p = &target->breakpoints;
 	int retval;
@@ -176,15 +176,15 @@ int hybrid_breakpoint_add_internal(struct target *target, uint32_t address, uint
 			 * succeeding.
 			 */
 			LOG_DEBUG("Duplicate Hybrid Breakpoint asid: 0x%08" PRIx32 " (BP %d)",
-					asid, breakpoint->unique_id );
+					asid, breakpoint->unique_id);
 			return -1;
 		}
-		else if ((breakpoint->address == address) && (breakpoint->asid == 0)) 
+		else if ((breakpoint->address == address) && (breakpoint->asid == 0))
 		{
 			LOG_DEBUG("Duplicate Breakpoint IVA: 0x%08" PRIx32 " (BP %d)",
-					address, breakpoint->unique_id );
+					address, breakpoint->unique_id);
 			return -1;
-			
+
 		}
 		breakpoint_p = &breakpoint->next;
 		breakpoint = breakpoint->next;
@@ -212,7 +212,7 @@ int hybrid_breakpoint_add_internal(struct target *target, uint32_t address, uint
 	LOG_DEBUG("added %s Hybrid breakpoint at address 0x%8.8" PRIx32 " of length 0x%8.8x, (BPID: %d)",
 			breakpoint_type_strings[(*breakpoint_p)->type],
 			(*breakpoint_p)->address, (*breakpoint_p)->length,
-			(*breakpoint_p)->unique_id  );
+			(*breakpoint_p)->unique_id);
 
 	return ERROR_OK;
 }
@@ -222,8 +222,8 @@ int hybrid_breakpoint_add_internal(struct target *target, uint32_t address, uint
 int breakpoint_add(struct target *target, uint32_t address, uint32_t length, enum breakpoint_type type)
 {
 
-int retval = ERROR_OK;
-    if (target->smp)
+	int retval = ERROR_OK;
+	if (target->smp)
 	{
 		struct target_list *head;
 		struct target *curr;
@@ -233,19 +233,19 @@ int retval = ERROR_OK;
 			curr = head->target;
 			retval = breakpoint_add_internal(curr, address,length, type);
 			if (retval != ERROR_OK) return retval;
-			head = head->next;	
+			head = head->next;
 		}
 		return retval;
 	}
 	else
-	return(breakpoint_add_internal(target, address, length, type));
+		return(breakpoint_add_internal(target, address, length, type));
 
 }
 int context_breakpoint_add(struct target *target, uint32_t asid, uint32_t length, enum breakpoint_type type)
 {
 
-int retval = ERROR_OK;
-    if (target->smp)
+	int retval = ERROR_OK;
+	if (target->smp)
 	{
 		struct target_list *head;
 		struct target *curr;
@@ -255,19 +255,19 @@ int retval = ERROR_OK;
 			curr = head->target;
 			retval = context_breakpoint_add_internal(curr, asid,length, type);
 			if (retval != ERROR_OK) return retval;
-			head = head->next;	
+			head = head->next;
 		}
 		return retval;
 	}
 	else
-	return(context_breakpoint_add_internal(target, asid, length, type));
+		return(context_breakpoint_add_internal(target, asid, length, type));
 
 }
 int hybrid_breakpoint_add(struct target *target, uint32_t address, uint32_t asid, uint32_t length, enum breakpoint_type type)
 {
 
-int retval = ERROR_OK;
-    if (target->smp)
+	int retval = ERROR_OK;
+	if (target->smp)
 	{
 		struct target_list *head;
 		struct target *curr;
@@ -277,12 +277,12 @@ int retval = ERROR_OK;
 			curr = head->target;
 			retval = hybrid_breakpoint_add_internal(curr, address, asid, length, type);
 			if (retval != ERROR_OK) return retval;
-			head = head->next;	
+			head = head->next;
 		}
 		return retval;
 	}
 	else
-	return(hybrid_breakpoint_add_internal(target, address, asid, length, type));
+		return(hybrid_breakpoint_add_internal(target, address, asid, length, type));
 
 }
 
@@ -338,7 +338,7 @@ void breakpoint_remove_internal(struct target *target, uint32_t address)
 }
 void breakpoint_remove(struct target *target, uint32_t address)
 {
-    if ((target->smp))
+	if (target->smp)
 	{
 		struct target_list *head;
 		struct target *curr;
@@ -347,7 +347,7 @@ void breakpoint_remove(struct target *target, uint32_t address)
 		{
 			curr = head->target;
 			breakpoint_remove_internal(curr, address);
-			head = head->next;	
+			head = head->next;
 		}
 	}
 	else  breakpoint_remove_internal(target, address);
@@ -367,7 +367,7 @@ void breakpoint_clear_target_internal(struct target *target)
 
 void breakpoint_clear_target(struct target *target)
 {
-    if (target->smp)
+	if (target->smp)
 	{
 		struct target_list *head;
 		struct target *curr;
@@ -375,12 +375,12 @@ void breakpoint_clear_target(struct target *target)
 		while(head != (struct target_list*)NULL)
 		{
 			curr = head->target;
-		    breakpoint_clear_target_internal(curr);
-			head = head->next;	
+			breakpoint_clear_target_internal(curr);
+			head = head->next;
 		}
-     }
-	 else breakpoint_clear_target_internal(target);
-	
+	}
+	else breakpoint_clear_target_internal(target);
+
 }
 
 
@@ -448,8 +448,8 @@ int watchpoint_add(struct target *target, uint32_t address, uint32_t length,
 		reason = "unrecognized error";
 bye:
 		LOG_ERROR("can't add %s watchpoint at 0x%8.8" PRIx32 ", %s",
-			 watchpoint_rw_strings[(*watchpoint_p)->rw],
-			 address, reason);
+				watchpoint_rw_strings[(*watchpoint_p)->rw],
+				address, reason);
 		free (*watchpoint_p);
 		*watchpoint_p = NULL;
 		return retval;
@@ -460,7 +460,7 @@ bye:
 			watchpoint_rw_strings[(*watchpoint_p)->rw],
 			(*watchpoint_p)->address,
 			(*watchpoint_p)->length,
-			(*watchpoint_p)->unique_id );
+			(*watchpoint_p)->unique_id);
 
 	return ERROR_OK;
 }

-----------------------------------------------------------------------

Summary of changes:
 src/target/breakpoints.c |   72 +++++++++++++++++++++++-----------------------
 1 files changed, 36 insertions(+), 36 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Wed Oct 12 12:04:52 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Wed, 12 Oct 2011 10:04:52 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-108-gca0cc39
Message-ID: <mailman.187.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  ca0cc39f5f33e83613bea1a829842339e023dfb4 (commit)
      from  3ab7855d1a7513df523cf59ef4a735cdedb46362 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit ca0cc39f5f33e83613bea1a829842339e023dfb4
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Wed Oct 12 09:32:59 2011 +0100

    docs: update project url's
    
    Change-Id: I54fc3aff722ed25143aad85e58d19b72fcecbba0
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/NEWTAPS b/NEWTAPS
index e789054..638fa00 100644
--- a/NEWTAPS
+++ b/NEWTAPS
@@ -4,7 +4,7 @@ Reporting Unknown JTAG TAP IDS
 If OpenOCD reports an UNKNOWN or Unexpected Tap ID please report it to
 the development mailing list - However - keep reading.
 
-openocd-development at lists.berlios.de.
+openocd-devel at lists.sourceforge.net.
 
 ========================================
 
diff --git a/PATCHES.txt b/PATCHES.txt
index 856b094..2757eac 100644
--- a/PATCHES.txt
+++ b/PATCHES.txt
@@ -2,7 +2,7 @@
 /** @page patchguide Patch Guidelines
 
 Please mail patches to: @par
-	openocd-development at lists.berlios.de
+	openocd-devel at lists.sourceforge.net
 
 Note that you can't send patches to that list unless
 you're a member, despite what the list info page says.
diff --git a/README b/README
index 62d1f77..f49dd31 100644
--- a/README
+++ b/README
@@ -26,7 +26,7 @@ viewed on-line at the following URLs:
     http://openocd.sourceforge.net/doc/html/index.html
 
  OpenOCD Developer's Manual:
-    http://openocd.sourceforge.net/doc/doxygen/index.html
+    http://openocd.sourceforge.net/doc/doxygen/html/index.html
 
 These reflect the latest development versions, so the following section
 introduces how to build the complete documentation from the package.
diff --git a/doc/manual/primer/patches.txt b/doc/manual/primer/patches.txt
index a894234..cb3c07c 100644
--- a/doc/manual/primer/patches.txt
+++ b/doc/manual/primer/patches.txt
@@ -139,7 +139,7 @@ these maintainers.
 
 Patches must be sent to the OpenOCD developer mailing list:
 @par
-	openocd-development at lists.berlios.de
+	openocd-devel at lists.sourceforge.net
 
 They will be reviewed and committed if the changes are found to be
 acceptable.  If there are problems, you will receive feedback via the
diff --git a/doc/manual/server.txt b/doc/manual/server.txt
index f6a0670..3c2fbd0 100644
--- a/doc/manual/server.txt
+++ b/doc/manual/server.txt
@@ -309,3 +309,8 @@ This section needs to be expanded.
 
  */
 
+/** @page serverhttp OpenOCD http Server API
+
+This section needs to be expanded.
+
+ */
diff --git a/doc/openocd.texi b/doc/openocd.texi
index 817c4f9..1759931 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -168,7 +168,7 @@ STM32x). Preliminary support for various NAND flash controllers
 
 The OpenOCD web site provides the latest public news from the community:
 
- at uref{http://openocd.sourceforge.net/web/}
+ at uref{http://openocd.sourceforge.net/}
 
 @section Latest User's Guide:
 

-----------------------------------------------------------------------

Summary of changes:
 NEWTAPS                       |    2 +-
 PATCHES.txt                   |    2 +-
 README                        |    2 +-
 doc/manual/primer/patches.txt |    2 +-
 doc/manual/server.txt         |    5 +++++
 doc/openocd.texi              |    2 +-
 6 files changed, 10 insertions(+), 5 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Wed Oct 12 13:43:45 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Wed, 12 Oct 2011 11:43:45 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-109-g24f8210
Message-ID: <mailman.188.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  24f82100f894351d3359e0d4542ec1daed944354 (commit)
      from  ca0cc39f5f33e83613bea1a829842339e023dfb4 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 24f82100f894351d3359e0d4542ec1daed944354
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Wed Oct 12 12:25:59 2011 +0100

    docs: update more url's
    
    Change-Id: I476078f32910579fed55777c3b0e6da3ef3363b7
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 1759931..960a4c0 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -241,7 +241,7 @@ providing a Doxygen reference manual.  This document contains more
 technical information about the software internals, development
 processes, and similar documentation:
 
- at uref{http://openocd.sourceforge.net/doc/doxygen/index.html}
+ at uref{http://openocd.sourceforge.net/doc/doxygen/html/index.html}
 
 This document is a work-in-progress, but contributions would be welcome
 to fill in the gaps.  All of the source files are provided in-tree,

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Wed Oct 12 20:48:49 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Wed, 12 Oct 2011 18:48:49 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-111-g2c6d312
Message-ID: <mailman.189.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  2c6d312ec9e1aec514e80b7c317ed93d72197ba2 (commit)
       via  4e80a9128e69d67d8aed8e5a83995246913bc98a (commit)
      from  24f82100f894351d3359e0d4542ec1daed944354 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 2c6d312ec9e1aec514e80b7c317ed93d72197ba2
Merge: 24f8210 4e80a91
Author: Peter Stuge <peter at stuge.se>
Date:   Wed Oct 12 18:48:21 2011 +0000

    Merge "docs: update HACKING to point to Gerrit"


commit 4e80a9128e69d67d8aed8e5a83995246913bc98a
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Wed Oct 12 20:21:18 2011 +0200

    docs: update HACKING to point to Gerrit
    
    Change-Id: If79e86c731ac06aaefca1aebde40e7cb3de68e4d
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/HACKING b/HACKING
index 6e4fc4b..42c50f0 100644
--- a/HACKING
+++ b/HACKING
@@ -1,13 +1,22 @@
-Submitting patches to the OpenOCD mailing list:
+Submitting patches to the OpenOCD Gerrit server:
 
-By the time you have read this, one supposes that 
-you have figured out how to clone the OpenOCD git
-repository.
+OpenOCD is to some extent a "self service" open source project, so to
+contribute, you must follow the standard procedures to have the best
+possible chance to get your changes accepted.
+
+The procedure to create a patch is essentially:
+
+- make the changes
+- create a commit
+- send the changes to the Gerrit server for review
+- correct the patch and re-send it according to review feedback
+ 
 
-Below is a basic workflow and specific instructions 
-to get you going with git and patches.
+0. Create a Gerrit account at:
 
-0. Clone the git repository, rather than just
+http://openocd.zylin.com
+
+1. Clone the git repository, rather than just
 download the source. 
 
 git clone git://openocd.git.sourceforge.net/gitroot/openocd/openocd
@@ -17,19 +26,32 @@ the slower http protocol:
 
 git clone http://repo.or.cz/r/openocd.git
 
-1. Set up git with your name and email:
+2. Set up Gerrit with your local repository. All this does it
+to instruct git locally how to send off the changes.
+
+Add a new remote to git using Gerrit username:
+
+git remote add review ssh://USERNAME at openocd.zylin.com:29418/openocd.git
+git config remote.review.push HEAD:refs/for/master
+
+You will need to install this hook, we will look into a better
+solution:
+
+scp -p -P 29418 USERNAME at openocd.zylin.com:hooks/commit-msg .git/hooks/
+
+3. Set up git with your name and email:
 
 git config --global user.name "John Smith"
 git config --global user.email "john at smith.org"
 
-2. Work on your patches. Split the work into 
+4. Work on your patches. Split the work into 
 multiple small patches that can be reviewed and
 applied seperately and safely to the OpenOCD
 repository.
 
 while(!done) {
   work - edit files using your favorite editor.
-  run "git commit -a" to commit all changes. 
+  run "git commit -s -a" to commit all changes. 
 }
 
 TIP! use "git add ." before commit to add new files.
@@ -41,16 +63,21 @@ longer comments over several
 lines...
 -----
 
-3. Next you need to make sure that your patches
+5. Next you need to make sure that your patches
 are on top of the latest stuff on the server and
 that there are no conflicts.
 
-git pull --rebase
+git pull --rebase origin/master
+
+6. Send the patches to the Gerrit server for review.
+
+git push review
+
+7. Forgot something, want to add more? Just make the changes and do:
 
-4. Generate the patch files. This will generate
-patches for all commits that are on top of
-the latest stuff on the server:
+git commit --amend
+git push review
 
-git format-patch origin/master
+Further reading:
 
-5. Email the patches to openocd-development at lists.berlios.de  
+http://www.coreboot.org/Git
\ No newline at end of file

-----------------------------------------------------------------------

Summary of changes:
 HACKING |   61 ++++++++++++++++++++++++++++++++++++++++++++-----------------
 1 files changed, 44 insertions(+), 17 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Thu Oct 13 20:54:33 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Thu, 13 Oct 2011 18:54:33 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-112-g5a7cff2
Message-ID: <mailman.190.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  5a7cff26a502ecc5dbd027ebb9d28d95782681a8 (commit)
      from  2c6d312ec9e1aec514e80b7c317ed93d72197ba2 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 5a7cff26a502ecc5dbd027ebb9d28d95782681a8
Author: Michel Jaouen <michel.jaouen at stericsson.com>
Date:   Mon Oct 3 19:05:59 2011 +0200

    breakpoint : smp software breakpoint issue
    
    Change-Id: Iefe78bad71d4fdb38ae412ab8fe2f6282836c22e
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/14
    Tested-by: Spencer Oliver <spen at spen-soft.co.uk>
    Reviewed-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/src/target/breakpoints.c b/src/target/breakpoints.c
index e722f67..c0905ed 100644
--- a/src/target/breakpoints.c
+++ b/src/target/breakpoints.c
@@ -228,6 +228,9 @@ int breakpoint_add(struct target *target, uint32_t address, uint32_t length, enu
 		struct target_list *head;
 		struct target *curr;
 		head = target->head;
+		if (type == BKPT_SOFT)
+			return(breakpoint_add_internal(head->target, address,length, type));
+
 		while(head != (struct target_list*)NULL)
 		{
 			curr = head->target;
@@ -312,7 +315,7 @@ static void breakpoint_free(struct target *target, struct breakpoint *breakpoint
 	free(breakpoint);
 }
 
-void breakpoint_remove_internal(struct target *target, uint32_t address)
+int breakpoint_remove_internal(struct target *target, uint32_t address)
 {
 	struct breakpoint *breakpoint = target->breakpoints;
 
@@ -330,14 +333,18 @@ void breakpoint_remove_internal(struct target *target, uint32_t address)
 	if (breakpoint)
 	{
 		breakpoint_free(target, breakpoint);
+		return 1;
 	}
 	else
 	{
-		LOG_ERROR("no breakpoint at address 0x%8.8" PRIx32 " found", address);
+		if (!target->smp)
+			LOG_ERROR("no breakpoint at address 0x%8.8" PRIx32 " found", address);
+		return 0;
 	}
 }
 void breakpoint_remove(struct target *target, uint32_t address)
 {
+	int found = 0;
 	if (target->smp)
 	{
 		struct target_list *head;
@@ -346,9 +353,11 @@ void breakpoint_remove(struct target *target, uint32_t address)
 		while(head != (struct target_list*)NULL)
 		{
 			curr = head->target;
-			breakpoint_remove_internal(curr, address);
+			found += breakpoint_remove_internal(curr, address);
 			head = head->next;
 		}
+		if (found == 0)
+			LOG_ERROR("no breakpoint at address 0x%8.8" PRIx32 " found", address);
 	}
 	else  breakpoint_remove_internal(target, address);
 }
diff --git a/src/target/target.c b/src/target/target.c
index 6a60b4e..e03b398 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -3098,6 +3098,13 @@ COMMAND_HANDLER(handle_bp_command)
 	{
 		case 0:
 			return handle_bp_command_list(CMD_CTX);
+
+		case 2:
+			asid = 0;
+			COMMAND_PARSE_NUMBER(u32, CMD_ARGV[0], addr);
+			COMMAND_PARSE_NUMBER(u32, CMD_ARGV[1], length);
+			return handle_bp_command_set(CMD_CTX, addr, asid, length, hw);
+
 		case 3:
 
 			if(strcmp(CMD_ARGV[2], "hw") == 0)

-----------------------------------------------------------------------

Summary of changes:
 src/target/breakpoints.c |   15 ++++++++++++---
 src/target/target.c      |    7 +++++++
 2 files changed, 19 insertions(+), 3 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Thu Oct 13 22:19:12 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Thu, 13 Oct 2011 20:19:12 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-113-g8cd3832
Message-ID: <mailman.191.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  8cd3832e2b76421a955dddbe4b6199b62fed69c6 (commit)
      from  5a7cff26a502ecc5dbd027ebb9d28d95782681a8 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 8cd3832e2b76421a955dddbe4b6199b62fed69c6
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Thu Oct 13 19:58:06 2011 +0100

    target: whitespace cleanup
    
    Change-Id: I1453f4f3dc0add529da20577e38b8b82d7d00366
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>
    Reviewed-on: http://openocd.zylin.com/18
    Reviewed-by: Alex Austin <alex.austin at spectrumdsi.com>
    Tested-by: Spencer Oliver <spen at spen-soft.co.uk>
    Reviewed-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/src/target/target.c b/src/target/target.c
index e03b398..b68eee3 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -3050,42 +3050,41 @@ static int handle_bp_command_set(struct command_context *cmd_ctx,
 		uint32_t addr, uint32_t asid, uint32_t length, int hw)
 {
 	struct target *target = get_current_target(cmd_ctx);
-	
-		if (asid == 0)
-		{	int retval = breakpoint_add(target, addr, length, hw);
-			if (ERROR_OK == retval)
-				command_print(cmd_ctx, "breakpoint set at 0x%8.8" PRIx32 "", addr);
-			else
-			{
-				LOG_ERROR("Failure setting breakpoint, the same address(IVA) is already used");
-				return retval;
-			}
-		}
-		else if (addr == 0)
+
+	if (asid == 0)
+	{
+		int retval = breakpoint_add(target, addr, length, hw);
+		if (ERROR_OK == retval)
+			command_print(cmd_ctx, "breakpoint set at 0x%8.8" PRIx32 "", addr);
+		else
 		{
-			int retval = context_breakpoint_add(target, asid, length, hw);
-			if (ERROR_OK == retval)
-				command_print(cmd_ctx, "Context breakpoint set at 0x%8.8" PRIx32 "", asid);
-			else
-			{
-				LOG_ERROR("Failure setting breakpoint, the same address(CONTEXTID) is already used");
-				return retval;
-			}
+			LOG_ERROR("Failure setting breakpoint, the same address(IVA) is already used");
+			return retval;
 		}
+	}
+	else if (addr == 0)
+	{
+		int retval = context_breakpoint_add(target, asid, length, hw);
+		if (ERROR_OK == retval)
+			command_print(cmd_ctx, "Context breakpoint set at 0x%8.8" PRIx32 "", asid);
 		else
-		{	
-			int retval = hybrid_breakpoint_add(target, addr, asid, length, hw);
-			if(ERROR_OK == retval)
+		{
+			LOG_ERROR("Failure setting breakpoint, the same address(CONTEXTID) is already used");
+			return retval;
+		}
+	}
+	else
+	{
+		int retval = hybrid_breakpoint_add(target, addr, asid, length, hw);
+		if(ERROR_OK == retval)
 			command_print(cmd_ctx, "Hybrid breakpoint set at 0x%8.8" PRIx32 "", asid);
-			else
-			{
-				LOG_ERROR("Failure setting breakpoint, the same address is already used");
-				return retval;
-			}
+		else
+		{
+			LOG_ERROR("Failure setting breakpoint, the same address is already used");
+			return retval;
 		}
+	}
 	return ERROR_OK;
-
-	
 }
 
 COMMAND_HANDLER(handle_bp_command)
@@ -3106,7 +3105,6 @@ COMMAND_HANDLER(handle_bp_command)
 			return handle_bp_command_set(CMD_CTX, addr, asid, length, hw);
 
 		case 3:
-
 			if(strcmp(CMD_ARGV[2], "hw") == 0)
 			{
 				hw = BKPT_HARD;
@@ -3132,12 +3130,11 @@ COMMAND_HANDLER(handle_bp_command)
 			COMMAND_PARSE_NUMBER(u32, CMD_ARGV[1], asid);
 			COMMAND_PARSE_NUMBER(u32, CMD_ARGV[2], length);
 			return handle_bp_command_set(CMD_CTX, addr, asid, length, hw);
+
 		default:
 			command_print(CMD_CTX, "usage: bp <address> [<asid>]<length> ['hw'|'hw_ctx']");
 			return ERROR_COMMAND_SYNTAX_ERROR;
 	}
-
-	
 }
 
 COMMAND_HANDLER(handle_rbp_command)
@@ -5108,7 +5105,7 @@ static int jim_target_smp(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 	retval = 0;
 	LOG_DEBUG("%d",argc);
 	/* argv[1] = target to associate in smp
-	 * argv[2] = target to assoicate in smp 
+	 * argv[2] = target to assoicate in smp
 	 * argv[3] ...
 	 */
 
@@ -5145,7 +5142,7 @@ static int jim_target_smp(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 	target->head = head;
 	curr=curr->next;
 	}
-	return retval; 
+	return retval;
 }
 
 

-----------------------------------------------------------------------

Summary of changes:
 src/target/target.c |   67 ++++++++++++++++++++++++--------------------------
 1 files changed, 32 insertions(+), 35 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Fri Oct 14 00:28:44 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Thu, 13 Oct 2011 22:28:44 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-114-gd4599b8
Message-ID: <mailman.192.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  d4599b8b3f0c568961d6007e59633456a13a9c18 (commit)
      from  8cd3832e2b76421a955dddbe4b6199b62fed69c6 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit d4599b8b3f0c568961d6007e59633456a13a9c18
Author: Uwe Hermann <uwe at hermann-uwe.de>
Date:   Fri Oct 14 00:13:47 2011 +0200

    Add a board file for the Glyn Tonga2.
    
    This is a Toshiba TMPA900CMXBG (ARM9) based SO-DIMM CPU module with 64MB
    DDR SDRAM, 256MB NAND flash, and on-board Ethernet.
    
    The board file provides a tonga2_init function which sets up the
    PLL/clocks and memory (SDRAM and SRAM), which allows writing a boot-loader
    into RAM via JTAG.
    
    Change-Id: I60522b97997bdf50e1f25aebab910d93a98522fb
    Signed-off-by: Uwe Hermann <uwe at hermann-uwe.de>
    Reviewed-on: http://openocd.zylin.com/19
    Reviewed-by: Spencer Oliver <spen at spen-soft.co.uk>
    Tested-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/tcl/board/glyn_tonga2.cfg b/tcl/board/glyn_tonga2.cfg
new file mode 100644
index 0000000..783ef9f
--- /dev/null
+++ b/tcl/board/glyn_tonga2.cfg
@@ -0,0 +1,170 @@
+#
+# Glyn Tonga2 SO-DIMM CPU module (Toshiba TMPA900CMXBG, ARM9)
+#
+# http://toshiba-mikrocontroller.de/sites/TMPA900CPUBOARDStarter.htm
+#
+# Hardware on the S0-DIMM module:
+#   - Toshiba TMPA900CMXBG (ARM9, ARM926EJ-S, max. 200MHz)
+#   - DDR SDRAM: Hynix H5MS5162DFR-J3M (64Mbyte, x16, 1.8V, 166/83MHz at CL3/2)
+#   - NAND flash: Samsung K9F2G08U0B-PIB0 (256M x 8 Bit, 3.3V)
+#   - Ethernet: SMSC LAN9221I-ABZJ (10/100Mbit, Non-PCI, 16 bit interface)
+#
+
+source [find target/tmpa900.cfg]
+
+########################
+# Target configuration #
+########################
+
+$_TARGETNAME configure -event reset-init { tonga2_init }
+
+proc tonga2_init { } {
+
+	######################
+	# PLL initialization #
+	######################
+
+	# Clock overview (see datasheet chapter 3.5.2, page 57):
+	#   - fs: Low-frequency oscillator
+	#   - fOSCH: High-frequency oscillator (24MHz on this board)
+	#   - fPLL = fOSCH * multiplier (where multiplier can be 6 or 8)
+	#   - fFCLK = fPLL / gear (where gear can be 1/2/4/8)
+	#   - fHCLK is always fFCLK/2. fPCLK is also fFCLK/2.
+	#
+	# We select multiplier = 8 and gear = 1, so
+	#   fFCLK = fOSCH * 8 / 1 = 192MHz.
+
+	# SYSCR3 (System Control Register 3): Disable and configure PLL.
+	#   - PLL operation control: off
+	#   - PLL constant value setting 1: always 0, as per datasheet
+	#   - PLL constant value setting 2: x8 (multiplier = 8)
+	mww 0xf005000c 0x00000007
+
+	# SYSCR4 (System Control Register 4): Configure PLL.
+	#   - PLL constant value setting 3: 140MHz or more
+	#   - PLL constant value setting 4: always 1, as per datasheet
+	#   - PLL constant value setting 5: 140MHz or more
+	mww 0xf0050010 0x00000065
+
+	# SYSCR3 (System Control Register 3): Enable PLL.
+	#   - PLL operation control: on
+	#   - All other bits remain set as above.
+	mww 0xf005000c 0x00000087
+
+	# Wait for PLL to stabilize.
+	sleep 10
+
+	# SYSCR2 (System Control Register 2): Switch from fOSCH to fPLL.
+	#   - Selection of the PLL output clock: fPLL
+	mww 0xf0050008 0x00000002
+
+	# SYSCR1 (System Control Register 1):
+	#   - Clock gear programming: fc/1 (i.e., gear = 1, don't divide).
+	mww 0xf0050004 0x00000000
+
+	# CLKCR5 (Clock Control Register 5): Set bits 3 and 6. The datasheet
+	# says the bits are reserved, but also recommends "Write as one".
+	mww 0xf0050054 0x00000048
+
+
+	##############################################################
+	# Dynamic Memory Controller (DMC) / DDR SDRAM initialization #
+	##############################################################
+
+	# PMC (Power Management Controller):
+	# PMCDRV (External Port "Driverbility" control register):
+	# Bits DRV_MEM0/DRV_MEM1 (memory relation port drive power):
+	mww 0xf0020260 0x00000003	;# Select 1.8V +/- 0.1V
+
+	# Setup DDR SDRAM timing parameters for our specific chip.
+	mww 0xf4310014 0x00000004	;# cas_latency = 2
+	mww 0xf4310018 0x00000001	;# t_dqss = 1
+	mww 0xf431001c 0x00000002	;# t_mrd = 2
+	mww 0xf4310020 0x0000000a	;# t_ras = 10
+	mww 0xf4310024 0x0000000a	;# t_rc = 10
+	mww 0xf4310028 0x00000013	;# t_rcd = 3, schedule_rcd = 2
+	mww 0xf431002c 0x0000010a	;# t_rfc = 10, schedule_rfc = 8
+	mww 0xf4310030 0x00000013	;# t_rp = 3, schedule_rp = 2
+	mww 0xf4310034 0x00000002	;# t_rrd = 2
+	mww 0xf4310038 0x00000002	;# t_wr = 2
+	mww 0xf431003c 0x00000001	;# t_wtr = 1
+	mww 0xf4310040 0x0000000a	;# t_xp = 10
+	mww 0xf4310044 0x0000000c	;# t_xsr = 12
+	mww 0xf4310048 0x00000014	;# t_esr = 20
+
+	# dmc_memory_cfg_5 (DMC Memory Configuration register):
+	# Set memory configuration:
+	# column_bits = 10, row_bits = 13, ap-bit = 10, power_down_prd = 0,
+	# auto_power_down = disable, stop_mem_clock = disable, memory_burst = 4
+	mww 0xf431000c 0x00010012
+
+	# dmc_user_config_5 (DMC user_config register):
+	# Data bus width of DDR SDRAM: 16 bit
+	mww 0xf4310304 0x00000058
+
+	# dmc_refresh_prd_5 (DMC Refresh Period register):
+	# Auto refresh: every 2656 (0xa60) DMCSCLK periods.
+	mww 0xf4310010 0x00000a60
+
+	# dmc_chip_0_cfg_5 (DMC chip_0_cfg registers):
+	#   - SDRAM address structure: bank, row, column
+	#   - address_match = 01000000 (start address [31:24])
+	#   - address_mask  = 11111100 (start address [31:24] mask value)
+	mww 0xf4310200 0x000140fc
+
+	# Initialize the DDR SDRAM chip.
+	# dmc_direct_cmd_5 (DMC Direct Command register).
+	# See datasheet chapter 3.10.5.1, page 268.
+	mww 0xf4310008 0x000c0000	;# RAM init: NOP
+	mww 0xf4310008 0x00000000	;# RAM init: Precharge all
+	mww 0xf4310008 0x00040000	;# RAM init: Autorefresh
+	mww 0xf4310008 0x00040000	;# RAM init: Autorefresh
+	mww 0xf4310008 0x00080032	;# RAM init: addr_13_to_0 = 0x32
+	mww 0xf4310008 0x000c0000	;# RAM init: NOP
+	mww 0xf4310008 0x000a0000	;# RAM init: bank_addr = bank 2
+
+	# dmc_id_<0-5>_cfg_5 (DMC id_<0-5>_cfg registers):
+	# Set min./max. QoS values.
+	#   - 0x5: Enable QoS, max. QoS = 1
+	#   - 0xb: Enable QoS, min. QoS = 2
+	mww 0xf4310100 0x00000005	;# AHB0: CPU Data
+	mww 0xf4310104 0x00000005	;# AHB1: CPU Inst
+	mww 0xf4310108 0x0000000b	;# AHB2: LCDC
+	mww 0xf431010c 0x00000005	;# AHB3: LCDDA, USB
+	mww 0xf4310110 0x00000005	;# AHB4: DMA1
+	mww 0xf4310114 0x00000005	;# AHB5: DMA2
+
+	# dmc_memc_cmd_5 (DMC Memory Controller Command register):
+	# Change DMC state to ready.
+	mww 0xf4310004 0x00000000	;# memc_cmd = "Go"
+
+	# EBI: SMC Timeout register
+	mww 0xf00a0050 0x00000001	;# smc_timeout = 1
+
+
+	########################################################
+	# Static Memory Controller (SMC) / SRAM initialization #
+	########################################################
+
+	# smc_set_cycles_5 (SMC Set Cycles register):
+	# tRC = 10, tWC = 10, tCEOE = 7, tWP = 5, tPC=2, tTR=2
+	mww 0xf4311014 0x0004afaa
+
+	# smc_set_opmode_5 (SMC Set Opmode register):
+	# Memory data bus width = 16 bits, async read mode, read burst
+	# length = 1 beat, async write mode, write burst length = 1 beat,
+	# byte enable (SMCBE0-1) timing = SMCCSn timing, memory burst boundary
+	# split setting = burst can cross any address boundary
+	mww 0xf4311018 0x00000001
+
+	# smc_direct_cmd_5 (SMC Direct Command register):
+	# cmd_type = UpdateRegs, chip_select = CS1
+	mww 0xf4311010 0x00c00000
+}
+
+#######################
+# Flash configuration #
+#######################
+
+# TODO: Implement NAND support.
+

-----------------------------------------------------------------------

Summary of changes:
 tcl/board/glyn_tonga2.cfg |  170 +++++++++++++++++++++++++++++++++++++++++++++
 1 files changed, 170 insertions(+), 0 deletions(-)
 create mode 100644 tcl/board/glyn_tonga2.cfg


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Fri Oct 14 00:31:35 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Thu, 13 Oct 2011 22:31:35 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-115-g498662e
Message-ID: <mailman.193.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  498662e2e5e89ab7299b2fa54a307c5bfcdcd00e (commit)
      from  d4599b8b3f0c568961d6007e59633456a13a9c18 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 498662e2e5e89ab7299b2fa54a307c5bfcdcd00e
Author: Uwe Hermann <uwe at hermann-uwe.de>
Date:   Fri Oct 14 00:21:06 2011 +0200

    Add an interface file for DLP Design DLP-USB1232H.
    
    The DLP Design DLP-USB1232H UART/SPI/JTAG module is based on an FTDI FT2232H
    chip. Among other things, it can used as JTAG programmer if connected to
    the JTAG target properly. I have successfully wired the module to an
    Olimex STM32-H103 eval board and flashed a firmware onto that using OpenOCD.
    
    The setup details and schematics are documented at:
    http://randomprojects.org/wiki/DLP-USB1232H_and_OpenOCD_based_JTAG_adapter
    
    Change-Id: I5eb9255a61eeece233009bee77d7dc3b5d1afb8b
    Signed-off-by: Uwe Hermann <uwe at hermann-uwe.de>
    Reviewed-on: http://openocd.zylin.com/20
    Reviewed-by: Spencer Oliver <spen at spen-soft.co.uk>
    Tested-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/contrib/openocd.udev b/contrib/openocd.udev
index ba951fb..25cc718 100644
--- a/contrib/openocd.udev
+++ b/contrib/openocd.udev
@@ -27,6 +27,7 @@ ATTRS{idVendor}=="0fbb", ATTRS{idProduct}=="1000", MODE="664", GROUP="plugdev"
 # TinCanTools Flyswatter
 # OOCD-Link
 # Marvell Sheevaplug (early development versions)
+# DLP Design DLP-USB1232H USB-to-UART/FIFO interface module
 ATTRS{idVendor}=="0403", ATTRS{idProduct}=="6010", MODE="664", GROUP="plugdev"
 
 # Calao Systems USB-A9260-C02
diff --git a/doc/openocd.texi b/doc/openocd.texi
index 960a4c0..3789859 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -372,6 +372,8 @@ Stellaris eval boards, they can be used to debug other target boards.
 @* Axiom AXM-0432 Link @url{http://www.axman.com}
 @item @b{cortino}
 @* Link @url{http://www.hitex.com/index.php?id=cortino}
+ at item @b{dlp-usb1232h}
+@* Link @url{http://www.dlpdesign.com/usb/usb1232h.shtml}
 @end itemize
 
 @section USB-JTAG / Altera USB-Blaster compatibles
diff --git a/tcl/interface/dlp-usb1232h.cfg b/tcl/interface/dlp-usb1232h.cfg
new file mode 100644
index 0000000..7432413
--- /dev/null
+++ b/tcl/interface/dlp-usb1232h.cfg
@@ -0,0 +1,14 @@
+#
+# DLP Design DLP-USB1232H USB-to-UART/FIFO interface module
+#
+# http://www.dlpdesign.com/usb/usb1232h.shtml
+#
+# Schematics for OpenOCD usage:
+# http://randomprojects.org/wiki/DLP-USB1232H_and_OpenOCD_based_JTAG_adapter
+#
+
+interface ft2232
+ft2232_device_desc "Dual RS232-HS"
+ft2232_layout usbjtag
+ft2232_vid_pid 0x0403 0x6010
+

-----------------------------------------------------------------------

Summary of changes:
 contrib/openocd.udev           |    1 +
 doc/openocd.texi               |    2 ++
 tcl/interface/dlp-usb1232h.cfg |   14 ++++++++++++++
 3 files changed, 17 insertions(+), 0 deletions(-)
 create mode 100644 tcl/interface/dlp-usb1232h.cfg


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Fri Oct 14 14:19:53 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Fri, 14 Oct 2011 12:19:53 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-116-g8c3c5e5
Message-ID: <mailman.194.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  8c3c5e53e360a76a90c5fdbfa6850928f16f8d43 (commit)
      from  498662e2e5e89ab7299b2fa54a307c5bfcdcd00e (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 8c3c5e53e360a76a90c5fdbfa6850928f16f8d43
Author: Spencer Oliver <spen at spen-soft.co.uk>
Date:   Fri Oct 14 13:03:29 2011 +0100

    flash: fix lpc2000 driver typo
    
    Change-Id: I3a759ed98a27fd186c12355b846d5e97dba86c5b
    Signed-off-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/src/flash/nor/lpc2000.c b/src/flash/nor/lpc2000.c
index fea663e..b639d1e 100644
--- a/src/flash/nor/lpc2000.c
+++ b/src/flash/nor/lpc2000.c
@@ -31,7 +31,6 @@
 #include <target/arm_opcodes.h>
 #include <target/armv7m.h>
 
-
 /**
  * @file
  * flash programming support for NXP LPC17xx and LPC2xxx devices.
@@ -104,7 +103,6 @@ enum lpc2000_status_codes
 	LPC2000_INVALID_BAUD_RATE = 17,
 	LPC2000_INVALID_STOP_BIT = 18,
 	LPC2000_CRP_ENABLED = 19
-
 };
 
 static int lpc2000_build_sector_list(struct flash_bank *bank)
@@ -330,7 +328,7 @@ static int lpc2000_iap_call(struct flash_bank *bank, int code, uint32_t param_ta
 				target_buffer_set_u32(target, jump_gate + 4, ARMV4_5_B(0xfffffe, 0));
 				break;
 			default:
-				LOG_ERROR("BUG: unknown bank->size encountered");
+				LOG_ERROR("BUG: unknown lpc2000_info->variant encountered");
 				exit(-1);
 		}
 
@@ -412,7 +410,6 @@ static int lpc2000_iap_call(struct flash_bank *bank, int code, uint32_t param_ta
 			exit(-1);
 	}
 
-
 	status_code     = target_buffer_get_u32(target, mem_params[1].value);
 	result_table[0] = target_buffer_get_u32(target, mem_params[1].value + 0x04);
 	result_table[1] = target_buffer_get_u32(target, mem_params[1].value + 0x08);

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/lpc2000.c |    5 +----
 1 files changed, 1 insertions(+), 4 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Fri Oct 14 15:02:19 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Fri, 14 Oct 2011 13:02:19 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-117-g3828b58
Message-ID: <mailman.195.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  3828b5827d0a701143e4d21be938d7d1acf110a2 (commit)
      from  8c3c5e53e360a76a90c5fdbfa6850928f16f8d43 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 3828b5827d0a701143e4d21be938d7d1acf110a2
Author: Spencer Oliver <ntfreak at users.sourceforge.net>
Date:   Fri Oct 14 09:40:58 2011 +0100

    arm-jtag-ew: whitespace cleanup
    
    Change-Id: I8861e825f9c84525e0c09c3adaa3fe300640770d
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>
    Reviewed-on: http://openocd.zylin.com/21
    Tested-by: Spencer Oliver <spen at spen-soft.co.uk>
    Reviewed-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/src/jtag/drivers/arm-jtag-ew.c b/src/jtag/drivers/arm-jtag-ew.c
index 6af3304..b090050 100644
--- a/src/jtag/drivers/arm-jtag-ew.c
+++ b/src/jtag/drivers/arm-jtag-ew.c
@@ -27,7 +27,6 @@
 #include <usb.h>
 #include "usb_common.h"
 
-
 #define USB_VID						0x15ba
 #define USB_PID						0x001e
 
@@ -39,7 +38,6 @@
 #define ARMJTAGEW_IN_BUFFER_SIZE	(4*1024)
 #define ARMJTAGEW_OUT_BUFFER_SIZE	(4*1024)
 
-
 /* USB command request codes. */
 #define CMD_GET_VERSION				0x00
 #define CMD_SELECT_DPIMPL			0x10
@@ -93,8 +91,6 @@ static void armjtagew_debug_buffer(uint8_t *buffer, int length);
 
 static struct armjtagew* armjtagew_handle;
 
-
-
 /***************************************************************************/
 /* External interface implementation */
 
@@ -175,42 +171,40 @@ static int armjtagew_execute_queue(void)
 	return armjtagew_tap_execute();
 }
 
-
 /* Sets speed in kHz. */
 static int armjtagew_speed(int speed)
 {
-    int result;
-    int speed_real;
+	int result;
+	int speed_real;
 
 
-    usb_out_buffer[0] = CMD_SET_TCK_FREQUENCY;
+	usb_out_buffer[0] = CMD_SET_TCK_FREQUENCY;
 	buf_set_u32(usb_out_buffer + 1, 0, 32, speed*1000);
 
-    result = armjtagew_usb_message(armjtagew_handle, 5, 4);
+	result = armjtagew_usb_message(armjtagew_handle, 5, 4);
 
-    if (result < 0)
-    {
-        LOG_ERROR("ARM-JTAG-EW setting speed failed (%d)", result);
-        return ERROR_JTAG_DEVICE_ERROR;
-    }
+	if (result < 0)
+	{
+		LOG_ERROR("ARM-JTAG-EW setting speed failed (%d)", result);
+		return ERROR_JTAG_DEVICE_ERROR;
+	}
 
 	usb_out_buffer[0] = CMD_GET_TCK_FREQUENCY;
-    result = armjtagew_usb_message(armjtagew_handle, 1, 4);
-	speed_real = (int)buf_get_u32(usb_in_buffer,0,32) / 1000;
+	result = armjtagew_usb_message(armjtagew_handle, 1, 4);
+	speed_real = (int)buf_get_u32(usb_in_buffer, 0, 32) / 1000;
 	if (result < 0)
 	{
-        LOG_ERROR("ARM-JTAG-EW getting speed failed (%d)", result);
-        return ERROR_JTAG_DEVICE_ERROR;
+		LOG_ERROR("ARM-JTAG-EW getting speed failed (%d)", result);
+		return ERROR_JTAG_DEVICE_ERROR;
 	}
 	else
 	{
 		LOG_INFO("Requested speed %dkHz, emulator reported %dkHz.", speed, speed_real);
 	}
 
-    return ERROR_OK;
+	return ERROR_OK;
 }
 
-
 static int armjtagew_khz(int khz, int *jtag_speed)
 {
 	*jtag_speed = khz;
@@ -225,7 +219,6 @@ static int armjtagew_speed_div(int speed, int* khz)
 	return ERROR_OK;
 }
 
-
 static int armjtagew_init(void)
 {
 	int check_cnt;
@@ -256,7 +249,7 @@ static int armjtagew_init(void)
 		LOG_INFO("ARM-JTAG-EW initial read failed, don't worry");
 	}
 
-	// Initial JTAG speed (for reset and initialization): 32 kHz
+	/* Initial JTAG speed (for reset and initialization): 32 kHz */
 	armjtagew_speed(32);
 
 	LOG_INFO("ARM-JTAG-EW JTAG Interface ready");
@@ -440,7 +433,6 @@ static void armjtagew_reset(int trst, int srst)
 	}
 }
 
-
 static int armjtagew_get_status(void)
 {
 	int result;
@@ -532,7 +524,6 @@ struct jtag_interface armjtagew_interface = {
 	.name = "arm-jtag-ew",
 	.commands = armjtagew_command_handlers,
 	.transports = jtag_only,
-
 	.execute_queue = armjtagew_execute_queue,
 	.speed = armjtagew_speed,
 	.speed_div = armjtagew_speed_div,
@@ -827,7 +818,6 @@ static int armjtagew_usb_read(struct armjtagew *armjtagew, int exp_in_length)
 	return result;
 }
 
-
 #ifdef _DEBUG_USB_COMMS_
 #define BYTES_PER_LINE  16
 
@@ -853,4 +843,3 @@ static void armjtagew_debug_buffer(uint8_t *buffer, int length)
 	}
 }
 #endif
-

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/drivers/arm-jtag-ew.c |   41 ++++++++++++++-------------------------
 1 files changed, 15 insertions(+), 26 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sat Oct 15 02:00:58 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sat, 15 Oct 2011 00:00:58 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-118-g2d4bdb9
Message-ID: <mailman.196.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  2d4bdb9fe089b5fe169639cecf32fbe38dca1a16 (commit)
      from  3828b5827d0a701143e4d21be938d7d1acf110a2 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 2d4bdb9fe089b5fe169639cecf32fbe38dca1a16
Author: Jim Norris <u17263 at att.net>
Date:   Fri Oct 14 13:42:26 2011 -0500

    Add some more detail for setting up Gerrit account.
    
    1) Add a couple more steps when setting up the Gerrit account.
    
    Change-Id: I5d81feac4650d4d28653d14cfc0baf14270424c1
    Signed-off-by: Jim Norris <u17263 at att.net>
    Reviewed-on: http://openocd.zylin.com/28
    Reviewed-by: Peter Stuge <peter at stuge.se>
    Tested-by: Peter Stuge <peter at stuge.se>

diff --git a/HACKING b/HACKING
index 42c50f0..dc06b45 100644
--- a/HACKING
+++ b/HACKING
@@ -16,6 +16,32 @@ The procedure to create a patch is essentially:
 
 http://openocd.zylin.com
 
+- On subsequent sign ins, use the full URL prefaced with 'http://'
+  For example:
+
+	http://user_identifier.open_id_provider.com
+
+0.1. Add a username to your profile.
+
+After creating the Gerrit account and signing in, you will need to
+add a username to your profile. To do this, go to 'Settings', and
+add a username of your choice.
+
+Your username will be required in step 2 and substituted wherever
+the string 'USERNAME' is found.
+
+0.2. Add an SSH public key
+
+Following the directions for your specific platform:
+
+	for Windows: help.github.com/win-set-up-git/#_set_up_ssh_keys
+	for OSX:     help.github.com/mac-set-up-git/#_set_up_ssh_keys
+	for Linux:   help.github.com/linux-set-up-git/#_set_up_ssh_keys
+
+While these pages describe the setting up of git as well,
+you should scroll down the page till you get to the section:
+'Next: Set Up SSH Keys', and follow the steps described.
+
 1. Clone the git repository, rather than just
 download the source. 
 

-----------------------------------------------------------------------

Summary of changes:
 HACKING |   26 ++++++++++++++++++++++++++
 1 files changed, 26 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Mon Oct 17 14:32:41 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Mon, 17 Oct 2011 12:32:41 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-119-gea295bd
Message-ID: <mailman.197.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  ea295bd694250b077b780cfd506cf4d7f6fd1471 (commit)
      from  2d4bdb9fe089b5fe169639cecf32fbe38dca1a16 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit ea295bd694250b077b780cfd506cf4d7f6fd1471
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Fri Oct 14 15:05:45 2011 +0200

    target: DCC / target message backoff algorithm
    
    by immediately polling again when we have received a message from
    the target instead of waiting 100ms, we can hope for much better
    performance. More than 100x? :-)
    
    Change-Id: Ieaf0c6c8b6e5addc482895670ffbf9a743e07a29
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/27
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>
    Tested-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/server/server.c b/src/server/server.c
index c70a522..84ec1ac 100644
--- a/src/server/server.c
+++ b/src/server/server.c
@@ -29,6 +29,7 @@
 
 #include "server.h"
 #include <target/target.h>
+#include <target/target_request.h>
 #include "openocd.h"
 #include "tcl_server.h"
 #include "telnet_server.h"
@@ -443,6 +444,13 @@ int server_loop(struct command_context *command_context)
 			poll_ok = true;
 		}
 
+		/* This is a simple back-off algorithm where we immediately
+		 * re-poll if we did something this time around.
+		 *
+		 * This greatly improves performance of DCC.
+		 */
+		poll_ok = poll_ok || target_got_message();
+
 		for (service = services; service; service = service->next)
 		{
 			/* handle new connections on listeners */

-----------------------------------------------------------------------

Summary of changes:
 src/server/server.c |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Mon Oct 17 14:33:10 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Mon, 17 Oct 2011 12:33:10 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-120-g80c20a1
Message-ID: <mailman.198.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  80c20a186b49b30575bc9a1e1316ab0acf502512 (commit)
      from  ea295bd694250b077b780cfd506cf4d7f6fd1471 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 80c20a186b49b30575bc9a1e1316ab0acf502512
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Fri Oct 14 14:55:17 2011 +0200

    target_request: add target_got_message() that can be used to improve DCC performance
    
    API change to allow implementing a back-off algorithm for
    polling hardware.
    
    Change-Id: I6cbe8b4534c8dfeb8442305171ea96b5481c1f17
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/26
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>
    Tested-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/target/target_request.c b/src/target/target_request.c
index ec3d48e..3cdca5e 100644
--- a/src/target/target_request.c
+++ b/src/target/target_request.c
@@ -36,6 +36,15 @@
 #include "trace.h"
 
 
+static bool got_message = false;
+
+bool target_got_message(void)
+{
+	bool t = got_message;
+	got_message = false;
+	return t;
+}
+
 static int charmsg_mode = 0;
 
 static int target_asciimsg(struct target *target, uint32_t length)
@@ -118,6 +127,9 @@ int target_request(struct target *target, uint32_t request)
 {
 	target_req_cmd_t target_req_cmd = request & 0xff;
 
+	/* Record that we got a target message for back-off algorithm */
+	got_message = true;
+
 	if (charmsg_mode) {
 		target_charmsg(target, target_req_cmd);
 		return ERROR_OK;
diff --git a/src/target/target_request.h b/src/target/target_request.h
index e50c425..740645e 100644
--- a/src/target/target_request.h
+++ b/src/target/target_request.h
@@ -47,5 +47,12 @@ int target_request(struct target *target, uint32_t request);
 int delete_debug_msg_receiver(struct command_context *cmd_ctx,
 		struct target *target);
 int target_request_register_commands(struct command_context *cmd_ctx);
+/**
+ * Read and clear the flag as to whether we got a message.
+ *
+ * This is used to implement the back-off algorithm on
+ * sleeping in idle mode.
+ */
+bool target_got_message(void);
 
 #endif /* TARGET_REQUEST_H */

-----------------------------------------------------------------------

Summary of changes:
 src/target/target_request.c |   12 ++++++++++++
 src/target/target_request.h |    7 +++++++
 2 files changed, 19 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Mon Oct 17 19:40:52 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Mon, 17 Oct 2011 17:40:52 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-121-g2f6bdac
Message-ID: <mailman.199.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  2f6bdac60a76d5a64a106d9ff3d1fe5ffeba2dd4 (commit)
      from  80c20a186b49b30575bc9a1e1316ab0acf502512 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 2f6bdac60a76d5a64a106d9ff3d1fe5ffeba2dd4
Author: Attila Kinali <attila at kinali.ch>
Date:   Mon Oct 10 15:09:22 2011 +0200

    Add the SAM3N familly to the chip_details table
    
    Change-Id: Ic122d324eacf6e667ed6008ebb84708be944222c
    Signed-off-by: Attila Kinali <attila at kinali.ch>
    Reviewed-on: http://openocd.zylin.com/29
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>
    Tested-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/flash/nor/at91sam3.c b/src/flash/nor/at91sam3.c
index 1fe5f62..c46829e 100644
--- a/src/flash/nor/at91sam3.c
+++ b/src/flash/nor/at91sam3.c
@@ -73,6 +73,9 @@
 // at91sam3s series (has always one flash bank)
 #define FLASH_BANK_BASE_S   0x00400000
 
+// at91sam3n series (has always one flash bank)
+#define FLASH_BANK_BASE_N   0x00400000
+
 #define 	AT91C_EFC_FCMD_GETD                 (0x0) // (EFC) Get Flash Descriptor
 #define 	AT91C_EFC_FCMD_WP                   (0x1) // (EFC) Write Page
 #define 	AT91C_EFC_FCMD_WPL                  (0x2) // (EFC) Write Page and Lock
@@ -832,6 +835,440 @@ static const struct sam3_chip_details all_sam3_details[] = {
 		  },
 		},
 	},
+
+	// Start at91sam3n* series
+	{
+		.chipid_cidr    = 0x29540960,
+		.name           = "at91sam3n4c",
+		.total_flash_size     = 256 * 1024,
+		.total_sram_size      = 24 * 1024,
+		.n_gpnvms       = 3,
+		.n_banks        = 1,
+
+		// System boots at address 0x0
+		// gpnvm[1] = selects boot code
+		//     if gpnvm[1] == 0
+		//         boot is via "SAMBA" (rom)
+		//     else
+		//         boot is via FLASH
+		//         Selection is via gpnvm[2]
+		//     endif
+		//
+		// NOTE: banks 0 & 1 switch places
+		//     if gpnvm[2] == 0
+		//         Bank0 is the boot rom
+		//      else
+		//         Bank1 is the boot rom
+		//      endif
+//		.bank[0] = {
+		{
+		  {
+			.probed = 0,
+			.pChip  = NULL,
+			.pBank  = NULL,
+			.bank_number = 0,
+			.base_address = FLASH_BANK_BASE_N,
+			.controller_address = 0x400e0A00,
+			.present = 1,
+			.size_bytes = 256 * 1024,
+			.nsectors   = 16,
+			.sector_size = 16384,
+			.page_size   = 256,
+		  },
+
+//		.bank[1] = {
+		  {
+		  	.present = 0,
+			.probed = 0,
+			.bank_number = 1,
+		  },
+		},
+	},
+
+	{
+		.chipid_cidr    = 0x29440960,
+		.name           = "at91sam3n4b",
+		.total_flash_size     = 256 * 1024,
+		.total_sram_size      = 24 * 1024,
+		.n_gpnvms       = 3,
+		.n_banks        = 1,
+
+		// System boots at address 0x0
+		// gpnvm[1] = selects boot code
+		//     if gpnvm[1] == 0
+		//         boot is via "SAMBA" (rom)
+		//     else
+		//         boot is via FLASH
+		//         Selection is via gpnvm[2]
+		//     endif
+		//
+		// NOTE: banks 0 & 1 switch places
+		//     if gpnvm[2] == 0
+		//         Bank0 is the boot rom
+		//      else
+		//         Bank1 is the boot rom
+		//      endif
+//		.bank[0] = {
+		{
+		  {
+			.probed = 0,
+			.pChip  = NULL,
+			.pBank  = NULL,
+			.bank_number = 0,
+			.base_address = FLASH_BANK_BASE_N,
+			.controller_address = 0x400e0A00,
+			.present = 1,
+			.size_bytes = 256 * 1024,
+			.nsectors   = 16,
+			.sector_size = 16384,
+			.page_size   = 256,
+		  },
+
+//		.bank[1] = {
+		  {
+		  	.present = 0,
+			.probed = 0,
+			.bank_number = 1,
+		  },
+		},
+	},
+
+	{
+		.chipid_cidr    = 0x29340960,
+		.name           = "at91sam3n4a",
+		.total_flash_size     = 256 * 1024,
+		.total_sram_size      = 24 * 1024,
+		.n_gpnvms       = 3,
+		.n_banks        = 1,
+
+		// System boots at address 0x0
+		// gpnvm[1] = selects boot code
+		//     if gpnvm[1] == 0
+		//         boot is via "SAMBA" (rom)
+		//     else
+		//         boot is via FLASH
+		//         Selection is via gpnvm[2]
+		//     endif
+		//
+		// NOTE: banks 0 & 1 switch places
+		//     if gpnvm[2] == 0
+		//         Bank0 is the boot rom
+		//      else
+		//         Bank1 is the boot rom
+		//      endif
+//		.bank[0] = {
+		{
+		  {
+			.probed = 0,
+			.pChip  = NULL,
+			.pBank  = NULL,
+			.bank_number = 0,
+			.base_address = FLASH_BANK_BASE_N,
+			.controller_address = 0x400e0A00,
+			.present = 1,
+			.size_bytes = 256 * 1024,
+			.nsectors   = 16,
+			.sector_size = 16384,
+			.page_size   = 256,
+		  },
+
+//		.bank[1] = {
+		  {
+		  	.present = 0,
+			.probed = 0,
+			.bank_number = 1,
+		  },
+		},
+	},
+
+	{
+		.chipid_cidr    = 0x29590760,
+		.name           = "at91sam3n2c",
+		.total_flash_size     = 128 * 1024,
+		.total_sram_size      = 16 * 1024,
+		.n_gpnvms       = 3,
+		.n_banks        = 1,
+
+		// System boots at address 0x0
+		// gpnvm[1] = selects boot code
+		//     if gpnvm[1] == 0
+		//         boot is via "SAMBA" (rom)
+		//     else
+		//         boot is via FLASH
+		//         Selection is via gpnvm[2]
+		//     endif
+		//
+		// NOTE: banks 0 & 1 switch places
+		//     if gpnvm[2] == 0
+		//         Bank0 is the boot rom
+		//      else
+		//         Bank1 is the boot rom
+		//      endif
+//		.bank[0] = {
+		{
+		  {
+			.probed = 0,
+			.pChip  = NULL,
+			.pBank  = NULL,
+			.bank_number = 0,
+			.base_address = FLASH_BANK_BASE_N,
+			.controller_address = 0x400e0A00,
+			.present = 1,
+			.size_bytes = 128 * 1024,
+			.nsectors   = 8,
+			.sector_size = 16384,
+			.page_size   = 256,
+		  },
+
+//		.bank[1] = {
+		  {
+		  	.present = 0,
+			.probed = 0,
+			.bank_number = 1,
+		  },
+		},
+	},
+
+	{
+		.chipid_cidr    = 0x29490760,
+		.name           = "at91sam3n2b",
+		.total_flash_size     = 128 * 1024,
+		.total_sram_size      = 16 * 1024,
+		.n_gpnvms       = 3,
+		.n_banks        = 1,
+
+		// System boots at address 0x0
+		// gpnvm[1] = selects boot code
+		//     if gpnvm[1] == 0
+		//         boot is via "SAMBA" (rom)
+		//     else
+		//         boot is via FLASH
+		//         Selection is via gpnvm[2]
+		//     endif
+		//
+		// NOTE: banks 0 & 1 switch places
+		//     if gpnvm[2] == 0
+		//         Bank0 is the boot rom
+		//      else
+		//         Bank1 is the boot rom
+		//      endif
+//		.bank[0] = {
+		{
+		  {
+			.probed = 0,
+			.pChip  = NULL,
+			.pBank  = NULL,
+			.bank_number = 0,
+			.base_address = FLASH_BANK_BASE_N,
+			.controller_address = 0x400e0A00,
+			.present = 1,
+			.size_bytes = 128 * 1024,
+			.nsectors   = 8,
+			.sector_size = 16384,
+			.page_size   = 256,
+		  },
+
+//		.bank[1] = {
+		  {
+		  	.present = 0,
+			.probed = 0,
+			.bank_number = 1,
+		  },
+		},
+	},
+
+	{
+		.chipid_cidr    = 0x29390760,
+		.name           = "at91sam3n2a",
+		.total_flash_size     = 128 * 1024,
+		.total_sram_size      = 16 * 1024,
+		.n_gpnvms       = 3,
+		.n_banks        = 1,
+
+		// System boots at address 0x0
+		// gpnvm[1] = selects boot code
+		//     if gpnvm[1] == 0
+		//         boot is via "SAMBA" (rom)
+		//     else
+		//         boot is via FLASH
+		//         Selection is via gpnvm[2]
+		//     endif
+		//
+		// NOTE: banks 0 & 1 switch places
+		//     if gpnvm[2] == 0
+		//         Bank0 is the boot rom
+		//      else
+		//         Bank1 is the boot rom
+		//      endif
+//		.bank[0] = {
+		{
+		  {
+			.probed = 0,
+			.pChip  = NULL,
+			.pBank  = NULL,
+			.bank_number = 0,
+			.base_address = FLASH_BANK_BASE_N,
+			.controller_address = 0x400e0A00,
+			.present = 1,
+			.size_bytes = 128 * 1024,
+			.nsectors   = 8,
+			.sector_size = 16384,
+			.page_size   = 256,
+		  },
+
+//		.bank[1] = {
+		  {
+		  	.present = 0,
+			.probed = 0,
+			.bank_number = 1,
+		  },
+		},
+	},
+
+	{
+		.chipid_cidr    = 0x29580560,
+		.name           = "at91sam3n1c",
+		.total_flash_size     = 64 * 1024,
+		.total_sram_size      = 8 * 1024,
+		.n_gpnvms       = 3,
+		.n_banks        = 1,
+
+		// System boots at address 0x0
+		// gpnvm[1] = selects boot code
+		//     if gpnvm[1] == 0
+		//         boot is via "SAMBA" (rom)
+		//     else
+		//         boot is via FLASH
+		//         Selection is via gpnvm[2]
+		//     endif
+		//
+		// NOTE: banks 0 & 1 switch places
+		//     if gpnvm[2] == 0
+		//         Bank0 is the boot rom
+		//      else
+		//         Bank1 is the boot rom
+		//      endif
+//		.bank[0] = {
+		{
+		  {
+			.probed = 0,
+			.pChip  = NULL,
+			.pBank  = NULL,
+			.bank_number = 0,
+			.base_address = FLASH_BANK_BASE_N,
+			.controller_address = 0x400e0A00,
+			.present = 1,
+			.size_bytes = 64 * 1024,
+			.nsectors   = 4,
+			.sector_size = 16384,
+			.page_size   = 256,
+		  },
+
+//		.bank[1] = {
+		  {
+		  	.present = 0,
+			.probed = 0,
+			.bank_number = 1,
+		  },
+		},
+	},
+
+	{
+		.chipid_cidr    = 0x29480560,
+		.name           = "at91sam3n1b",
+		.total_flash_size     = 64 * 1024,
+		.total_sram_size      = 8 * 1024,
+		.n_gpnvms       = 3,
+		.n_banks        = 1,
+
+		// System boots at address 0x0
+		// gpnvm[1] = selects boot code
+		//     if gpnvm[1] == 0
+		//         boot is via "SAMBA" (rom)
+		//     else
+		//         boot is via FLASH
+		//         Selection is via gpnvm[2]
+		//     endif
+		//
+		// NOTE: banks 0 & 1 switch places
+		//     if gpnvm[2] == 0
+		//         Bank0 is the boot rom
+		//      else
+		//         Bank1 is the boot rom
+		//      endif
+//		.bank[0] = {
+		{
+		  {
+			.probed = 0,
+			.pChip  = NULL,
+			.pBank  = NULL,
+			.bank_number = 0,
+			.base_address = FLASH_BANK_BASE_N,
+			.controller_address = 0x400e0A00,
+			.present = 1,
+			.size_bytes = 64 * 1024,
+			.nsectors   = 4,
+			.sector_size = 16384,
+			.page_size   = 256,
+		  },
+
+//		.bank[1] = {
+		  {
+		  	.present = 0,
+			.probed = 0,
+			.bank_number = 1,
+		  },
+		},
+	},
+
+	{
+		.chipid_cidr    = 0x29380560,
+		.name           = "at91sam3n1a",
+		.total_flash_size     = 64 * 1024,
+		.total_sram_size      = 8 * 1024,
+		.n_gpnvms       = 3,
+		.n_banks        = 1,
+
+		// System boots at address 0x0
+		// gpnvm[1] = selects boot code
+		//     if gpnvm[1] == 0
+		//         boot is via "SAMBA" (rom)
+		//     else
+		//         boot is via FLASH
+		//         Selection is via gpnvm[2]
+		//     endif
+		//
+		// NOTE: banks 0 & 1 switch places
+		//     if gpnvm[2] == 0
+		//         Bank0 is the boot rom
+		//      else
+		//         Bank1 is the boot rom
+		//      endif
+//		.bank[0] = {
+		{
+		  {
+			.probed = 0,
+			.pChip  = NULL,
+			.pBank  = NULL,
+			.bank_number = 0,
+			.base_address = FLASH_BANK_BASE_N,
+			.controller_address = 0x400e0A00,
+			.present = 1,
+			.size_bytes = 64 * 1024,
+			.nsectors   = 4,
+			.sector_size = 16384,
+			.page_size   = 256,
+		  },
+
+//		.bank[1] = {
+		  {
+		  	.present = 0,
+			.probed = 0,
+			.bank_number = 1,
+		  },
+		},
+	},
+
 	// terminate
 	{
 		.chipid_cidr	= 0,

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/at91sam3.c |  437 ++++++++++++++++++++++++++++++++++++++++++++++
 1 files changed, 437 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Mon Oct 17 21:36:01 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Mon, 17 Oct 2011 19:36:01 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-122-g70143a9
Message-ID: <mailman.200.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  70143a96c5cfcf13e1bfcabcbd39bc321f2da151 (commit)
      from  2f6bdac60a76d5a64a106d9ff3d1fe5ffeba2dd4 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 70143a96c5cfcf13e1bfcabcbd39bc321f2da151
Author: Karl Kurbjun <kkurbjun at gmail.com>
Date:   Sun Oct 2 10:52:20 2011 -0600

    ICEPick-C: Add support for warm reset through JTAG controller and provide finer detail functions.
    
    This sets up simple functions that can later be used to provide additional
    ICEPick Operations.
    
    Change-Id: I313b8679267696fad87d23f3692963e513f2fe21
    Signed-off-by: Spencer Oliver <spen at spen-soft.co.uk>
    Reviewed-on: http://openocd.zylin.com/22
    Tested-by: ??yvind Harboe <oyvindharboe at gmail.com>
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/tcl/target/icepick.cfg b/tcl/target/icepick.cfg
index da92c9e..ff73138 100644
--- a/tcl/target/icepick.cfg
+++ b/tcl/target/icepick.cfg
@@ -1,21 +1,115 @@
+#
+# Copyright (C)   2011        by Karl Kurbjun
+# Copyright (C)   2009        by David Brownell
+#
+
 # Utilities for TI ICEpick-C ... used in DaVinci, OMAP3, and more.
+# Details about the ICEPickC are available in the AM/DM37x document SPRUGN4M
+
+# create "constants"
+proc CONST { key } {
+
+	array set constant {
+		# define ICEPick instructions
+		IR_BYPASS   0x00
+		IR_ROUTER   0x02
+		IR_CONNECT  0x07
+		IF_BYPASS   0x3F
+	}
+	return $constant($key)
+}
+
+# Instruction to connect to the icepick module
+proc icepick_c_connect {jrc} {
+
+	# Send CONNECT instruction in IR state
+	irscan $jrc [CONST IR_CONNECT] -endstate IRPAUSE
+
+	# Send write and connect key
+	drscan $jrc 8 0x89 -endstate DRPAUSE
+}
+
+# Instruction to disconnect to the icepick module
+proc icepick_c_disconnect {jrc} {
+
+	# Send CONNECT instruction in IR state
+	irscan $jrc [CONST IR_CONNECT] -endstate IRPAUSE
+
+	# Send write and connect key
+	drscan $jrc 8 0x86 -endstate DRPAUSE
+}
+
+#
+# icepick_c_router:
+#  this function is for sending router commands
+# arguments are:
+#  jrc:        TAP name for the ICEpick
+#  rw:         read/write (0 for read, 1 for write)
+#  block:      icepick or DAP
+#  register:   which register to read/write
+#  payload:    value to read/write
+# this function is for sending router commands
+#
+proc icepick_c_router {jrc rw block register payload} {
+
+	set new_dr_value \
+		[expr ( ($rw & 0x1) << 31)        | ( ($block & 0x7) << 28) | \
+			( ($register & 0xF) << 24)  | ( $payload & 0xFFFFFF ) ]
+
+#	echo "\tNew router value:\t0x[format %x $new_dr_value]"
+
+	# select router
+	irscan $jrc [CONST IR_ROUTER] -endstate IRPAUSE
+
+	# ROUTER instructions are 32 bits wide
+	set old_dr_value [drscan $jrc 32 $new_dr_value -endstate DRPAUSE]
+}
+
+# Configure the icepick control register
+proc icepick_c_setup {jrc} {
+
+	# send a router write, block is 0, register is 1, value is 0x2100
+	icepick_c_router $jrc 1 0x0 0x1 0x001000
+}
 
 # jrc	== TAP name for the ICEpick
 # port	== a port number, 0..15
 proc icepick_c_tapenable {jrc port} {
 
+	# First CONNECT to the ICEPick
+#	echo "Connecting to ICEPick"
+	icepick_c_connect $jrc
+
+#	echo "Configuring the ICEpick"
+	icepick_c_setup $jrc
+
 	# NOTE:  it's important not to enter RUN/IDLE state until
 	# done sending these instructions and data to the ICEpick.
 	# And never to enter RESET, which will disable the TAPs.
 
-	# select router
-	irscan $jrc 7 -endstate IRPAUSE
-	drscan $jrc 8 0x89 -endstate DRPAUSE
+	# first enable power and clock for TAP
+	icepick_c_router $jrc 1 0x2 $port 0x100048
+
+	# TRM states that the register should be read back here, skipped for now
+
+	# enable debug "default" mode
+	icepick_c_router $jrc 1 0x2 $port 0x102048
+
+	# TRM states that debug enable and debug mode should be read back and
+	# confirmed - skipped for now
 
-	# set ip control
-	irscan $jrc 2 -endstate IRPAUSE
-	drscan $jrc 32 [expr 0xa0002108 + ($port << 24)] -endstate DRPAUSE
+	# Finally select the tap
+	icepick_c_router $jrc 1 0x2 $port 0x102148
 
-	irscan $jrc 0x3F -endstate RUN/IDLE
+	# Enter the bypass state
+	irscan $jrc [CONST IR_BYPASS] -endstate RUN/IDLE
 	runtest 10
 }
+
+# This function uses the ICEPick to send a warm system reset
+proc icepick_c_wreset {jrc} {
+
+	# send a router write, block is 0, register is 1, value is 0x2100
+	icepick_c_router $jrc 1 0x0 0x1 0x002101
+}
+

-----------------------------------------------------------------------

Summary of changes:
 tcl/target/icepick.cfg |  108 ++++++++++++++++++++++++++++++++++++++++++++---
 1 files changed, 101 insertions(+), 7 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Mon Oct 17 21:36:33 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Mon, 17 Oct 2011 19:36:33 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-123-g59beb93
Message-ID: <mailman.201.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  59beb93752c096fdfa0257ec126ee3e650140eec (commit)
      from  70143a96c5cfcf13e1bfcabcbd39bc321f2da151 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 59beb93752c096fdfa0257ec126ee3e650140eec
Author: Karl Kurbjun <kkurbjun at gmail.com>
Date:   Sun Oct 2 11:41:33 2011 -0600

    AM/DM37x: Use ICEPick warm reset and include halt when gdb connects.
    
    Using the ICEPick reset seems to allow the processor to be halted sooner
    and the halt on gdb connection makes the connect process more robust.
    
    Change-Id: I0586f6e6becc60a729030509ef58907a19d545ec
    Signed-off-by: Spencer Oliver <spen at spen-soft.co.uk>
    Reviewed-on: http://openocd.zylin.com/23
    Tested-by: ??yvind Harboe <oyvindharboe at gmail.com>
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/tcl/target/amdm37x.cfg b/tcl/target/amdm37x.cfg
index a6daeab..b1bd25c 100644
--- a/tcl/target/amdm37x.cfg
+++ b/tcl/target/amdm37x.cfg
@@ -1,6 +1,6 @@
 #
-# Copyright (C)   2010        by Karl Kurbjun
-# Copyright (C)   2009-2011  by ??yvind Harboe
+# Copyright (C)   2010-2011   by Karl Kurbjun
+# Copyright (C)   2009-2011   by ??yvind Harboe
 # Copyright (C)   2009        by David Brownell
 # Copyright (C)   2009        by Magnus Lundin
 #
@@ -114,7 +114,7 @@ jtag configure $_CHIPNAME.d2d -event tap-enable \
 
 # Primary TAP: ICEpick - it is closest to TDI so last in the chain
 eval "jtag newtap $_CHIPNAME jrc -irlen 6 -ircapture 0x1 -irmask 0x3f $_JRC_TAPID"
-	
+
 ######
 # End of Chain Description
 ######
@@ -153,30 +153,39 @@ $_TARGETNAME configure -work-area-phys 0x40200000 -work-area-size 0x4000
 ######
 
 # Set the JTAG clock down to 10 kHz to be sure that it will work with the
-#  slowest possible core clock (16.8MHz/2 = 8.4MHz). It is OK to speed up 
+#  slowest possible core clock (16.8MHz/2 = 8.4MHz). It is OK to speed up
 #  *after* PLL and clock tree setup.
 
 $_TARGETNAME configure -event "reset-start" { adapter_khz 10 }
 
-# Reset needs to be performed in in software.
-# The AM/DM37x TRM (sprugn4b) describes the software reset in detail.
-# PRM_RSTCTRL is described in table 3-425 on page 618.  We assert RST_GS
-# (bit 1 (in 31:0) ) to do a warm reset.
-
-# Create a vaiable for the register address
-set PRM_RSTCTRL 0x48307250
+# Describe the reset assert process for openocd - this is asserted with the
+# ICEPick
+$_TARGETNAME configure -event "reset-assert" {
 
-# Describe the reset assert process: A value of 2 must be written 
-# (assert bit 1) to the physical address of PRM_RSTCTRL.
+   global _CHIPNAME
 
-$_TARGETNAME configure -event \
-   reset-assert "$_TARGETNAME mww phys $PRM_RSTCTRL 2"
+   # assert warm system reset through ICEPick
+   icepick_c_wreset $_CHIPNAME.jrc
+}
 
 # After the reset is asserted we need to re-initialize debugging and speed up
 # the JTAG clock.
 
-$_TARGETNAME configure -event \
-   reset-assert-post "amdm37x_dbginit $_TARGETNAME; adapter_khz 1000"
+$_TARGETNAME configure -event reset-assert-post {
+
+   global _TARGETNAME
+   amdm37x_dbginit $_TARGETNAME
+   adapter_khz 1000
+}
+
+$_TARGETNAME configure -event gdb-attach {
+
+   global _TARGETNAME
+   amdm37x_dbginit $_TARGETNAME
+
+   echo "Halting target"
+   halt
+}
 
 ######
 # End Target Reset Event Setup:
@@ -192,8 +201,8 @@ $_TARGETNAME configure -event \
 proc amdm37x_dbginit {target} {
    # General Cortex A8 debug initialisation
    cortex_a8 dbginit
-   
-   # Enable DBGEN signal.  This signal is described in the ARM v7 TRM, but 
+
+   # Enable DBGEN signal.  This signal is described in the ARM v7 TRM, but
    # access to the signal appears to be implementation specific.  TI does not
    # describe this register much except a quick line that states DBGEM (sic) is
    # at this address and this bit.

-----------------------------------------------------------------------

Summary of changes:
 tcl/target/amdm37x.cfg |   47 ++++++++++++++++++++++++++++-------------------
 1 files changed, 28 insertions(+), 19 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Tue Oct 18 08:36:09 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Tue, 18 Oct 2011 06:36:09 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-124-gaf37d5f
Message-ID: <mailman.202.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  af37d5f1960c215d7bbe8d8f2becd4329d6c8e3e (commit)
      from  59beb93752c096fdfa0257ec126ee3e650140eec (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit af37d5f1960c215d7bbe8d8f2becd4329d6c8e3e
Author: Spencer Oliver <spen at spen-soft.co.uk>
Date:   Mon Oct 17 22:04:21 2011 +0100

    luminary: add peripheral reset script
    
    some luminary device classes require a reset script
    to emulate a hardware reset.
    
    Change-Id: Id505c92451244b48b0238c2130aebab2df8d208b
    Signed-off-by: Spencer Oliver <spen at spen-soft.co.uk>
    Reviewed-on: http://openocd.zylin.com/30
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>
    Tested-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/tcl/chip/ti/lm3s/lm3s.tcl b/tcl/chip/ti/lm3s/lm3s.tcl
new file mode 100644
index 0000000..42da8c6
--- /dev/null
+++ b/tcl/chip/ti/lm3s/lm3s.tcl
@@ -0,0 +1 @@
+source [find chip/ti/lm3s/lm3s_regs.tcl]
diff --git a/tcl/chip/ti/lm3s/lm3s_regs.tcl b/tcl/chip/ti/lm3s/lm3s_regs.tcl
new file mode 100644
index 0000000..cb20812
--- /dev/null
+++ b/tcl/chip/ti/lm3s/lm3s_regs.tcl
@@ -0,0 +1,84 @@
+#*****************************************************************************
+#
+# The following are defines for the System Control register addresses.
+#
+#*****************************************************************************
+
+set SYSCTL_DID0             0x400FE000  ;# Device Identification 0
+set SYSCTL_DID1             0x400FE004  ;# Device Identification 1
+set SYSCTL_DC0              0x400FE008  ;# Device Capabilities 0
+set SYSCTL_DC1              0x400FE010  ;# Device Capabilities 1
+set SYSCTL_DC2              0x400FE014  ;# Device Capabilities 2
+set SYSCTL_DC3              0x400FE018  ;# Device Capabilities 3
+set SYSCTL_DC4              0x400FE01C  ;# Device Capabilities 4
+set SYSCTL_DC5              0x400FE020  ;# Device Capabilities 5
+set SYSCTL_DC6              0x400FE024  ;# Device Capabilities 6
+set SYSCTL_DC7              0x400FE028  ;# Device Capabilities 7
+set SYSCTL_DC8              0x400FE02C  ;# Device Capabilities 8 ADC
+                                        ;# Channels
+set SYSCTL_PBORCTL          0x400FE030  ;# Brown-Out Reset Control
+set SYSCTL_LDOPCTL          0x400FE034  ;# LDO Power Control
+set SYSCTL_SRCR0            0x400FE040  ;# Software Reset Control 0
+set SYSCTL_SRCR1            0x400FE044  ;# Software Reset Control 1
+set SYSCTL_SRCR2            0x400FE048  ;# Software Reset Control 2
+set SYSCTL_RIS              0x400FE050  ;# Raw Interrupt Status
+set SYSCTL_IMC              0x400FE054  ;# Interrupt Mask Control
+set SYSCTL_MISC             0x400FE058  ;# Masked Interrupt Status and
+                                        ;# Clear
+set SYSCTL_RESC             0x400FE05C  ;# Reset Cause
+set SYSCTL_RCC              0x400FE060  ;# Run-Mode Clock Configuration
+set SYSCTL_PLLCFG           0x400FE064  ;# XTAL to PLL Translation
+set SYSCTL_GPIOHSCTL        0x400FE06C  ;# GPIO High-Speed Control
+set SYSCTL_GPIOHBCTL        0x400FE06C  ;# GPIO High-Performance Bus
+                                        ;# Control
+set SYSCTL_RCC2             0x400FE070  ;# Run-Mode Clock Configuration 2
+set SYSCTL_MOSCCTL          0x400FE07C  ;# Main Oscillator Control
+set SYSCTL_RCGC0            0x400FE100  ;# Run Mode Clock Gating Control
+                                        ;# Register 0
+set SYSCTL_RCGC1            0x400FE104  ;# Run Mode Clock Gating Control
+                                        ;# Register 1
+set SYSCTL_RCGC2            0x400FE108  ;# Run Mode Clock Gating Control
+                                        ;# Register 2
+set SYSCTL_SCGC0            0x400FE110  ;# Sleep Mode Clock Gating Control
+                                        ;# Register 0
+set SYSCTL_SCGC1            0x400FE114  ;# Sleep Mode Clock Gating Control
+                                        ;# Register 1
+set SYSCTL_SCGC2            0x400FE118  ;# Sleep Mode Clock Gating Control
+                                        ;# Register 2
+set SYSCTL_DCGC0            0x400FE120  ;# Deep Sleep Mode Clock Gating
+                                        ;# Control Register 0
+set SYSCTL_DCGC1            0x400FE124  ;# Deep-Sleep Mode Clock Gating
+                                        ;# Control Register 1
+set SYSCTL_DCGC2            0x400FE128  ;# Deep Sleep Mode Clock Gating
+                                        ;# Control Register 2
+set SYSCTL_DSLPCLKCFG       0x400FE144  ;# Deep Sleep Clock Configuration
+set SYSCTL_CLKVCLR          0x400FE150  ;# Clock Verification Clear
+set SYSCTL_PIOSCCAL         0x400FE150  ;# Precision Internal Oscillator
+                                        ;# Calibration
+set SYSCTL_PIOSCSTAT        0x400FE154  ;# Precision Internal Oscillator
+                                        ;# Statistics
+set SYSCTL_LDOARST          0x400FE160  ;# Allow Unregulated LDO to Reset
+                                        ;# the Part
+set SYSCTL_I2SMCLKCFG       0x400FE170  ;# I2S MCLK Configuration
+set SYSCTL_DC9              0x400FE190  ;# Device Capabilities 9 ADC
+                                        ;# Digital Comparators
+set SYSCTL_NVMSTAT          0x400FE1A0  ;# Non-Volatile Memory Information
+
+set SYSCTL_RCC_USESYSDIV    0x00400000  ;# Enable System Clock Divider
+set SYSCTL_RCC2_BYPASS2     0x00000800  ;# PLL Bypass 2
+set SYSCTL_RCC_MOSCDIS      0x00000001  ;# Main Oscillator Disable
+
+set SYSCTL_SRCR0            0x400FE040  ;# Software Reset Control 0
+set SYSCTL_SRCR1            0x400FE044  ;# Software Reset Control 1
+set SYSCTL_SRCR2            0x400FE048  ;# Software Reset Control 2
+
+set SYSCTL_MISC             0x400FE058  ;# Masked Interrupt Status and Clear
+
+set FLASH_FMA               0x400FD000  ;# Flash Memory Address
+set FLASH_FMD               0x400FD004  ;# Flash Memory Data
+set FLASH_FMC               0x400FD008  ;# Flash Memory Control
+set FLASH_FCRIS             0x400FD00C  ;# Flash Controller Raw Interrupt Status
+set FLASH_FCIM              0x400FD010  ;# Flash Controller Interrupt Mask
+set FLASH_FCMISC            0x400FD014  ;# Flash Controller Masked Interrupt Status and Clear
+set FLASH_FMC2              0x400FD020  ;#  Flash Memory Control 2
+set FLASH_FWBVAL            0x400FD030  ;# Flash Write Buffer Valid
diff --git a/tcl/target/stellaris.cfg b/tcl/target/stellaris.cfg
index b985de0..7fef4ec 100644
--- a/tcl/target/stellaris.cfg
+++ b/tcl/target/stellaris.cfg
@@ -70,6 +70,65 @@ adapter_khz 500
 
 source [find mem_helper.tcl]
 
+proc reset_peripherals {family} {
+
+	source [find chip/ti/lm3s/lm3s.tcl]
+
+	echo "Resetting Core Peripherals"
+
+	# Disable the PLL and the system clock divider (nop if disabled)
+	mmw $SYSCTL_RCC 0 $SYSCTL_RCC_USESYSDIV
+	mmw $SYSCTL_RCC2 $SYSCTL_RCC2_BYPASS2 0
+
+	# RCC and RCC2 to their reset values
+	mww $SYSCTL_RCC [expr (0x078e3ad0 | ([mrw $SYSCTL_RCC] & $SYSCTL_RCC_MOSCDIS))]
+	mww $SYSCTL_RCC2 0x07806810
+	mww $SYSCTL_RCC 0x078e3ad1
+
+	# Reset the deep sleep clock configuration register
+	mww $SYSCTL_DSLPCLKCFG 0x07800000
+
+	# Reset the clock gating registers
+	mww $SYSCTL_RCGC0 0x00000040
+	mww $SYSCTL_RCGC1 0
+	mww $SYSCTL_RCGC2 0
+	mww $SYSCTL_SCGC0 0x00000040
+	mww $SYSCTL_SCGC1 0
+	mww $SYSCTL_SCGC2 0
+	mww $SYSCTL_DCGC0 0x00000040
+	mww $SYSCTL_DCGC1 0
+	mww $SYSCTL_DCGC2 0
+
+	# Reset the remaining SysCtl registers
+	mww $SYSCTL_PBORCTL 0
+	mww $SYSCTL_IMC 0
+	mww $SYSCTL_GPIOHBCTL 0
+	mww $SYSCTL_MOSCCTL 0
+	mww $SYSCTL_PIOSCCAL 0
+	mww $SYSCTL_I2SMCLKCFG 0
+
+	# Reset the peripherals
+	mww $SYSCTL_SRCR0 0xffffffff
+	mww $SYSCTL_SRCR1 0xffffffff
+	mww $SYSCTL_SRCR2 0xffffffff
+	mww $SYSCTL_SRCR0 0
+	mww $SYSCTL_SRCR1 0
+	mww $SYSCTL_SRCR2 0
+
+	# Clear any pending SysCtl interrupts
+	mww $SYSCTL_MISC 0xffffffff
+
+	# Wait for any pending flash operations to complete
+	while {[expr [mrw $FLASH_FMC] & 0xffff] != 0} { sleep 1 }
+	while {[expr [mrw $FLASH_FMC2] & 0xffff] != 0} { sleep 1 }
+
+	# Reset the flash controller registers
+	mww $FLASH_FMA 0
+	mww $FLASH_FCIM 0
+	mww $FLASH_FCMISC 0xffffffff
+	mww $FLASH_FWBVAL 0
+}
+
 $_TARGETNAME configure -event reset-start {
 	adapter_khz 500
 
@@ -99,12 +158,14 @@ $_TARGETNAME configure -event reset-start {
 		cortex_m3 reset_config sysresetreq
 	} else {
 		# Tempest and newer default to using NVIC VECTRESET
-		# this does mean a reset-init event handler is required to reset
-		# any peripherals
+		# peripherals will need reseting manually, see proc reset_peripherals
 		cortex_m3 reset_config vectreset
+
+		# reset peripherals, based on code in
+		# http://www.ti.com/lit/er/spmz573a/spmz573a.pdf
+		reset_peripherals $device_class
 	}
 }
 
 # flash configuration ... autodetects sizes, autoprobed
 flash bank $_CHIPNAME.flash stellaris 0 0 0 0 $_TARGETNAME
-

-----------------------------------------------------------------------

Summary of changes:
 tcl/chip/ti/lm3s/lm3s.tcl      |    1 +
 tcl/chip/ti/lm3s/lm3s_regs.tcl |   84 ++++++++++++++++++++++++++++++++++++++++
 tcl/target/stellaris.cfg       |   67 ++++++++++++++++++++++++++++++-
 3 files changed, 149 insertions(+), 3 deletions(-)
 create mode 100644 tcl/chip/ti/lm3s/lm3s.tcl
 create mode 100644 tcl/chip/ti/lm3s/lm3s_regs.tcl


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Tue Oct 18 08:36:37 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Tue, 18 Oct 2011 06:36:37 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-125-g0dac042
Message-ID: <mailman.203.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  0dac042a107f000936995ea468c3fa02b9896fb6 (commit)
      from  af37d5f1960c215d7bbe8d8f2becd4329d6c8e3e (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 0dac042a107f000936995ea468c3fa02b9896fb6
Author: Spencer Oliver <spen at spen-soft.co.uk>
Date:   Mon Oct 17 22:27:49 2011 +0100

    luminary: add new targets
    
    update target support from latest SW-DRL 8049
    
    Change-Id: I40aba4d30fe2b79fd955f466c64d99a1dfd63ecf
    Signed-off-by: Spencer Oliver <spen at spen-soft.co.uk>
    Reviewed-on: http://openocd.zylin.com/31
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>
    Tested-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/flash/nor/stellaris.c b/src/flash/nor/stellaris.c
index 89cc8ef..4a21028 100644
--- a/src/flash/nor/stellaris.c
+++ b/src/flash/nor/stellaris.c
@@ -124,7 +124,7 @@ struct stellaris_flash_bank
 };
 
 // Autogenerated by contrib/gen-stellaris-part-header.pl
-// From Stellaris Firmware Development Package revision 6734
+// From Stellaris Firmware Development Package revision 8049
 static struct {
 	uint32_t partno;
 	const char *partname;
@@ -166,6 +166,7 @@ static struct {
 	{0x10C1,"LM3S1150"},
 	{0x10C4,"LM3S1162"},
 	{0x10C2,"LM3S1165"},
+	{0x10EC,"LM3S1166"},
 	{0x10C6,"LM3S1332"},
 	{0x10BC,"LM3S1435"},
 	{0x10BA,"LM3S1439"},
@@ -175,10 +176,12 @@ static struct {
 	{0x1006,"LM3S1607"},
 	{0x10DA,"LM3S1608"},
 	{0x10C0,"LM3S1620"},
+	{0x10CD,"LM3S1621"},
 	{0x1003,"LM3S1625"},
 	{0x1004,"LM3S1626"},
 	{0x1005,"LM3S1627"},
 	{0x10B3,"LM3S1635"},
+	{0x10EB,"LM3S1636"},
 	{0x10BD,"LM3S1637"},
 	{0x10B1,"LM3S1651"},
 	{0x10B9,"LM3S1751"},
@@ -192,14 +195,29 @@ static struct {
 	{0x10BE,"LM3S1958"},
 	{0x10B5,"LM3S1960"},
 	{0x10B8,"LM3S1968"},
+	{0x10EA,"LM3S1969"},
+	{0x10CE,"LM3S1B21"},
+	{0x10CA,"LM3S1C21"},
+	{0x10CB,"LM3S1C26"},
+	{0x1098,"LM3S1C58"},
+	{0x10B0,"LM3S1D21"},
+	{0x10CC,"LM3S1D26"},
+	{0x101D,"LM3S1F11"},
+	{0x101B,"LM3S1F16"},
+	{0x10AF,"LM3S1G21"},
+	{0x1095,"LM3S1G58"},
+	{0x101E,"LM3S1H11"},
+	{0x101C,"LM3S1H16"},
 	{0x100F,"LM3S1J11"},
 	{0x103C,"LM3S1J16"},
 	{0x100E,"LM3S1N11"},
 	{0x103B,"LM3S1N16"},
 	{0x10B2,"LM3S1P51"},
 	{0x109E,"LM3S1R21"},
+	{0x10C9,"LM3S1R26"},
 	{0x1030,"LM3S1W16"},
 	{0x102F,"LM3S1Z16"},
+	{0x10D4,"LM3S2016"},
 	{0x1051,"LM3S2110"},
 	{0x1084,"LM3S2139"},
 	{0x1039,"LM3S2276"},
@@ -221,13 +239,17 @@ static struct {
 	{0x106D,"LM3S2793"},
 	{0x10E3,"LM3S2911"},
 	{0x10E2,"LM3S2918"},
+	{0x10ED,"LM3S2919"},
 	{0x1054,"LM3S2939"},
 	{0x108F,"LM3S2948"},
 	{0x1058,"LM3S2950"},
 	{0x1055,"LM3S2965"},
 	{0x106C,"LM3S2B93"},
+	{0x1094,"LM3S2D93"},
+	{0x1093,"LM3S2U93"},
 	{0x1008,"LM3S3634"},
 	{0x1043,"LM3S3651"},
+	{0x10C8,"LM3S3654"},
 	{0x1044,"LM3S3739"},
 	{0x1049,"LM3S3748"},
 	{0x1045,"LM3S3749"},
@@ -252,15 +274,28 @@ static struct {
 	{0x100B,"LM3S5951"},
 	{0x104E,"LM3S5956"},
 	{0x1068,"LM3S5B91"},
+	{0x102E,"LM3S5C31"},
+	{0x102C,"LM3S5C36"},
+	{0x105E,"LM3S5C51"},
+	{0x105B,"LM3S5C56"},
+	{0x105F,"LM3S5D51"},
+	{0x105C,"LM3S5D56"},
+	{0x1087,"LM3S5D91"},
+	{0x102D,"LM3S5G31"},
+	{0x101F,"LM3S5G36"},
+	{0x105D,"LM3S5G51"},
+	{0x104F,"LM3S5G56"},
 	{0x1009,"LM3S5K31"},
 	{0x104A,"LM3S5K36"},
 	{0x100A,"LM3S5P31"},
 	{0x1048,"LM3S5P36"},
+	{0x10B6,"LM3S5P3B"},
 	{0x100D,"LM3S5P51"},
 	{0x104C,"LM3S5P56"},
 	{0x1007,"LM3S5R31"},
 	{0x104B,"LM3S5R36"},
 	{0x1047,"LM3S5T36"},
+	{0x107F,"LM3S5U91"},
 	{0x1046,"LM3S5Y36"},
 	{0x10A1,"LM3S6100"},
 	{0x1074,"LM3S6110"},
@@ -275,12 +310,18 @@ static struct {
 	{0x108B,"LM3S6637"},
 	{0x10A3,"LM3S6730"},
 	{0x1077,"LM3S6753"},
+	{0x10D1,"LM3S6816"},
 	{0x10E9,"LM3S6911"},
+	{0x10D3,"LM3S6916"},
 	{0x10E8,"LM3S6918"},
 	{0x1089,"LM3S6938"},
 	{0x1072,"LM3S6950"},
 	{0x1078,"LM3S6952"},
 	{0x1073,"LM3S6965"},
+	{0x10AA,"LM3S6C11"},
+	{0x10AC,"LM3S6C65"},
+	{0x109F,"LM3S6G11"},
+	{0x10AB,"LM3S6G65"},
 	{0x1064,"LM3S8530"},
 	{0x108E,"LM3S8538"},
 	{0x1061,"LM3S8630"},
@@ -293,24 +334,51 @@ static struct {
 	{0x10A6,"LM3S8962"},
 	{0x1062,"LM3S8970"},
 	{0x10D7,"LM3S8971"},
+	{0x10AE,"LM3S8C62"},
+	{0x10AD,"LM3S8G62"},
+	{0x10CF,"LM3S9781"},
 	{0x1067,"LM3S9790"},
 	{0x106B,"LM3S9792"},
+	{0x102D,"LM3S9971"},
 	{0x1020,"LM3S9997"},
+	{0x10D0,"LM3S9B81"},
 	{0x1066,"LM3S9B90"},
 	{0x106A,"LM3S9B92"},
 	{0x106E,"LM3S9B95"},
 	{0x106F,"LM3S9B96"},
+	{0x101D,"LM3S9BN2"},
+	{0x101E,"LM3S9BN5"},
+	{0x101F,"LM3S9BN6"},
+	{0x1070,"LM3S9C97"},
+	{0x107A,"LM3S9CN5"},
+	{0x10A9,"LM3S9D81"},
+	{0x107E,"LM3S9D90"},
+	{0x1092,"LM3S9D92"},
+	{0x10C8,"LM3S9D95"},
+	{0x109D,"LM3S9D96"},
+	{0x107B,"LM3S9DN5"},
+	{0x107C,"LM3S9DN6"},
+	{0x1060,"LM3S9G97"},
+	{0x1079,"LM3S9GN5"},
+	{0x101B,"LM3S9L71"},
 	{0x1018,"LM3S9L97"},
+	{0x10A8,"LM3S9U81"},
+	{0x107D,"LM3S9U90"},
+	{0x1090,"LM3S9U92"},
+	{0x10B7,"LM3S9U95"},
+	{0x109B,"LM3S9U96"},
 	{0,"Unknown part"}
 };
 
-static char * StellarisClassname[5] =
+static char * StellarisClassname[7] =
 {
 	"Sandstorm",
 	"Fury",
 	"Unknown",
 	"DustDevil",
-	"Tempest"
+	"Tempest",
+	"Unknown",
+	"Firestorm"
 };
 
 /***************************************************************************

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/stellaris.c |   74 +++++++++++++++++++++++++++++++++++++++++++--
 1 files changed, 71 insertions(+), 3 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Tue Oct 18 22:33:04 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Tue, 18 Oct 2011 20:33:04 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-126-g4eca579
Message-ID: <mailman.204.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  4eca579a6edf49ff8cb0872c757165c35013e46d (commit)
      from  0dac042a107f000936995ea468c3fa02b9896fb6 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 4eca579a6edf49ff8cb0872c757165c35013e46d
Author: Matt Reimer <mreimer at sdgsystems.com>
Date:   Mon Sep 19 10:30:13 2011 -0400

    xscale: fix bug in xscale_receive()
    
    The code in xscale_receive() that tries to skip invalid reads (i.e.
    reads that don't have the DBG_SR[0] 'valid' bit set) seems to be
    wrong, as it only looks at the first word's valid flag rather than
    each word's own valid flag. Am I reading the code correctly? If so,
    the attached patch should fix it.
    
    If this looks correct, I'll generate a proper patch and commit message.
    
    Matt
    
    Change-Id: I74ebe2ad7a36d340a9dd3b8487578b6ea7f3cf1e
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/32
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/target/xscale.c b/src/target/xscale.c
index 3b56745..b469b86 100644
--- a/src/target/xscale.c
+++ b/src/target/xscale.c
@@ -317,7 +317,7 @@ static int xscale_receive(struct target *target, uint32_t *buffer, int num_words
 		/* examine results */
 		for (i = words_done; i < num_words; i++)
 		{
-			if (!(field0[0] & 1))
+			if (!(field0[i] & 1))
 			{
 				/* move backwards if necessary */
 				int j;

-----------------------------------------------------------------------

Summary of changes:
 src/target/xscale.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Wed Oct 19 02:25:13 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Wed, 19 Oct 2011 00:25:13 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-128-g36e3009
Message-ID: <mailman.205.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  36e3009ff9ddd449a394b8e4aed0cc68c77b5a4b (commit)
       via  4f2655c28ba9dd1c259b4b48741f2bec933e4592 (commit)
      from  4eca579a6edf49ff8cb0872c757165c35013e46d (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 36e3009ff9ddd449a394b8e4aed0cc68c77b5a4b
Author: Uwe Hermann <uwe at hermann-uwe.de>
Date:   Wed Oct 19 01:54:25 2011 +0200

    TMPA900/910 MCUs are always little endian.
    
    Signed-off-by: Uwe Hermann <uwe at hermann-uwe.de>
    Change-Id: I8839f2cf0faf1b5ba9f99901c5ee028b199fabd2
    Reviewed-on: http://openocd.zylin.com/35
    Tested-by: jenkins
    Reviewed-by: Peter Stuge <peter at stuge.se>

diff --git a/tcl/target/tmpa900.cfg b/tcl/target/tmpa900.cfg
index 90851f6..cfb445e 100644
--- a/tcl/target/tmpa900.cfg
+++ b/tcl/target/tmpa900.cfg
@@ -8,11 +8,8 @@ if { [info exists CHIPNAME] } {
    set  _CHIPNAME tmpa900
 }
 
-if { [info exists ENDIAN] } {
-   set  _ENDIAN $ENDIAN
-} else {
-   set  _ENDIAN little
-}
+# Toshiba TMPA900 series MCUs are always little endian as per datasheet.
+set _ENDIAN little
 
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
diff --git a/tcl/target/tmpa910.cfg b/tcl/target/tmpa910.cfg
index 36874d9..4d4d3fc 100644
--- a/tcl/target/tmpa910.cfg
+++ b/tcl/target/tmpa910.cfg
@@ -8,11 +8,8 @@ if { [info exists CHIPNAME] } {
    set  _CHIPNAME tmpa910
 }
 
-if { [info exists ENDIAN] } {
-   set  _ENDIAN $ENDIAN
-} else {
-   set  _ENDIAN little
-}
+# Toshiba TMPA910 series MCUs are always little endian as per datasheet.
+set _ENDIAN little
 
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID

commit 4f2655c28ba9dd1c259b4b48741f2bec933e4592
Author: Uwe Hermann <uwe at hermann-uwe.de>
Date:   Wed Oct 19 01:09:44 2011 +0200

    Toshiba TMPA900 config: Fix incorrect working area.
    
    The Toshiba TMPA900 series (TMPA900/901) only has internal RAM regions
    RAM-0 (16kB) and RAM-1 (8kB) which we can use as working area.
    
    This is probably a copy-paste error from tmpa910.cfg, which has the
    correct values and sizes for the TMPA910 series (TMPA910/911/912/913):
    there are RAM-0, RAM-1, and RAM-2 (each 16kB).
    
    Also, change "built-in RAM" to "internal RAM" to match what the
    datasheet uses.
    
    Change-Id: I993cd6b7fadc28cf34e5cc18426bb2bb42597670
    Signed-off-by: Uwe Hermann <uwe at hermann-uwe.de>
    Reviewed-on: http://openocd.zylin.com/34
    Tested-by: jenkins
    Reviewed-by: Peter Stuge <peter at stuge.se>

diff --git a/tcl/target/tmpa900.cfg b/tcl/target/tmpa900.cfg
index d5b458f..90851f6 100644
--- a/tcl/target/tmpa900.cfg
+++ b/tcl/target/tmpa900.cfg
@@ -42,15 +42,9 @@ jtag_ntrst_delay 20
 set _TARGETNAME $_CHIPNAME.cpu
 target create $_TARGETNAME arm926ejs -endian $_ENDIAN -chain-position $_TARGETNAME
 
-# built-in RAM0
-#working_area 0 0xf8004000 0x4000 nobackup
-# built-in RAM1
-#working_area 1 0xf8008000 0x4000 nobackup
-# built-in RAM2
-#working_area 2 0xf800c000 0x4000 nobackup
-# built-in RAM 0-2 48k total
-#working_area 0 0xf8004000 0xc000 nobackup
-
-# Internal sram1 memory
-$_TARGETNAME configure -work-area-phys 0xf8004000 -work-area-size 0x8000 \
+# Internal RAM-0 (16kB): 0xf8004000
+# Internal RAM-1 (8kB): 0xf8008000
+
+# Use internal RAM-0 and RAM-1 as working area (24kB total).
+$_TARGETNAME configure -work-area-phys 0xf8004000 -work-area-size 0x6000 \
 -work-area-backup 0
diff --git a/tcl/target/tmpa910.cfg b/tcl/target/tmpa910.cfg
index fa6f87b..36874d9 100644
--- a/tcl/target/tmpa910.cfg
+++ b/tcl/target/tmpa910.cfg
@@ -42,15 +42,10 @@ jtag_ntrst_delay 20
 set _TARGETNAME $_CHIPNAME.cpu
 target create $_TARGETNAME arm926ejs -endian $_ENDIAN -chain-position $_TARGETNAME
 
-# built-in RAM0
-#working_area 0 0xf8004000 0x4000 nobackup
-# built-in RAM1
-#working_area 1 0xf8008000 0x4000 nobackup
-# built-in RAM2
-#working_area 2 0xf800c000 0x4000 nobackup
-# built-in RAM 0-2 48k total
-#working_area 0 0xf8004000 0xc000 nobackup
-
-# Internal sram1 memory
+# Internal RAM-0 (16kB): 0xf8004000
+# Internal RAM-1 (16kB): 0xf8008000
+# Internal RAM-2 (16kB): 0xf800c000
+
+# Use internal RAM-0, RAM-1, and RAM-2 as working area (48kB total).
 $_TARGETNAME configure -work-area-phys 0xf8004000 -work-area-size 0xc000 \
 -work-area-backup 0

-----------------------------------------------------------------------

Summary of changes:
 tcl/target/tmpa900.cfg |   23 +++++++----------------
 tcl/target/tmpa910.cfg |   20 ++++++--------------
 2 files changed, 13 insertions(+), 30 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Wed Oct 19 13:05:56 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Wed, 19 Oct 2011 11:05:56 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-129-g9ddb94c
Message-ID: <mailman.206.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  9ddb94c1f3227b4fc693e9aaba5df0ee4f9171e6 (commit)
      from  36e3009ff9ddd449a394b8e4aed0cc68c77b5a4b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 9ddb94c1f3227b4fc693e9aaba5df0ee4f9171e6
Author: Marc Willam / Holger Wech <openocd.fseu at de.fujitsu.com>
Date:   Thu Oct 13 14:43:06 2011 +0100

    Updated fm3.c, added Flash type 2 support, error handling improved
    
    Change-Id: I684aca11c4554290d0e57c6d3318d8082980c1ef
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Signed-off-by: Spencer Oliver <ntfreak at users.sourceforge.net>
    Reviewed-on: http://openocd.zylin.com/10
    Tested-by: jenkins
    Reviewed-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/src/flash/nor/fm3.c b/src/flash/nor/fm3.c
index a584964..1e2adf5 100644
--- a/src/flash/nor/fm3.c
+++ b/src/flash/nor/fm3.c
@@ -1,6 +1,7 @@
 /***************************************************************************
  *   Copyright (C) 2011 by Marc Willam, Holger Wech                        *
- *   m.willam at gmx.eu                                                       *
+ *   openOCD.fseu(AT)de.fujitsu.com                                        *
+ *                                                                         *
  *   Copyright (C) 2011 Ronny Strutz                                       *
  *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
@@ -18,6 +19,7 @@
  *   Free Software Foundation, Inc.,                                       *
  *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
  ***************************************************************************/
+
 #ifdef HAVE_CONFIG_H
 #include "config.h"
 #endif
@@ -27,23 +29,37 @@
 #include <target/algorithm.h>
 #include <target/armv7m.h>
 
-#define FLASH_DQ6 0x00000040	/* Data toggle flag bit (TOGG) position */
-#define FLASH_DQ5 0x00000020	/* Time limit exceeding flag bit (TLOV) position */
+#define FLASH_DQ6 0x00000040	/* Data toggle flag bit (TOGG) */
+#define FLASH_DQ5 0x00000020	/* Time limit exceeding flag bit (TLOV) */
 
 enum fm3_variant
 {
-	mb9bfxx1,
+	mb9bfxx1,	/* Flash Type '1' */
 	mb9bfxx2,
 	mb9bfxx3,
 	mb9bfxx4,
 	mb9bfxx5,
-	mb9bfxx6
+	mb9bfxx6,
+	mb9afxx1,	/* Flash Type '2' */
+	mb9afxx2,
+	mb9afxx3,
+	mb9afxx4,
+	mb9afxx5,
+	mb9afxx6
+};
+
+enum fm3_flash_type
+{
+	fm3_no_flash_type = 0,
+	fm3_flash_type1   = 1,
+	fm3_flash_type2   = 2
 };
 
 struct fm3_flash_bank
 {
 	struct working_area *write_algorithm;
 	enum fm3_variant variant;
+	enum fm3_flash_type flashtype;
 	int probed;
 };
 
@@ -57,36 +73,74 @@ FLASH_BANK_COMMAND_HANDLER(fm3_flash_bank_command)
 		return ERROR_FLASH_BANK_INVALID;
 	}
 
-	LOG_INFO("******HWE* FLASH CMD Parameter %s", CMD_ARGV[5]);
-
 	fm3_info = malloc(sizeof(struct fm3_flash_bank));
 	bank->driver_priv = fm3_info;
 
+	/* Flash type '1' */
 	if (strcmp(CMD_ARGV[5], "mb9bfxx1.cpu") == 0)
 	{
 		fm3_info->variant = mb9bfxx1;
+		fm3_info->flashtype = fm3_flash_type1;
 	}
 	else if (strcmp(CMD_ARGV[5], "mb9bfxx2.cpu") == 0)
 	{
 		fm3_info->variant = mb9bfxx2;
+		fm3_info->flashtype = fm3_flash_type1;
 	}
 	else if (strcmp(CMD_ARGV[5], "mb9bfxx3.cpu") == 0)
 	{
 		fm3_info->variant = mb9bfxx3;
+		fm3_info->flashtype = fm3_flash_type1;
 	}
 	else if (strcmp(CMD_ARGV[5], "mb9bfxx4.cpu") == 0)
 	{
 		fm3_info->variant = mb9bfxx4;
+		fm3_info->flashtype = fm3_flash_type1;
 	}
 	else if (strcmp(CMD_ARGV[5], "mb9bfxx5.cpu") == 0)
 	{
 		fm3_info->variant = mb9bfxx5;
+		fm3_info->flashtype = fm3_flash_type1;
 	}
 	else if (strcmp(CMD_ARGV[5], "mb9bfxx6.cpu") == 0)
 	{
 		fm3_info->variant = mb9bfxx6;
-		LOG_INFO("******HWE* fm3 Variant set to: mb9bfxx6");
+		fm3_info->flashtype = fm3_flash_type1;
+	}
+
+	/* Flash type '2' */
+	else if (strcmp(CMD_ARGV[5], "mb9afxx1.cpu") == 0)
+	{
+		fm3_info->variant = mb9afxx1;
+		fm3_info->flashtype = fm3_flash_type2;
+	}
+	else if (strcmp(CMD_ARGV[5], "mb9afxx2.cpu") == 0)
+	{
+		fm3_info->variant = mb9afxx2;
+		fm3_info->flashtype = fm3_flash_type2;
+	}
+	else if (strcmp(CMD_ARGV[5], "mb9afxx3.cpu") == 0)
+	{
+		fm3_info->variant = mb9afxx3;
+		fm3_info->flashtype = fm3_flash_type2;
+	}
+	else if (strcmp(CMD_ARGV[5], "mb9afxx4.cpu") == 0)
+	{
+		fm3_info->variant = mb9afxx4;
+		fm3_info->flashtype = fm3_flash_type2;
+	}
+	else if (strcmp(CMD_ARGV[5], "mb9afxx5.cpu") == 0)
+	{
+		fm3_info->variant = mb9afxx5;
+		fm3_info->flashtype = fm3_flash_type2;
+	}
+	else if (strcmp(CMD_ARGV[5], "mb9afxx6.cpu") == 0)
+	{
+		fm3_info->variant = mb9afxx6;
+		fm3_info->flashtype = fm3_flash_type2;
 	}
+
+	/* unknown Flash type */
 	else
 	{
 		LOG_ERROR("unknown fm3 variant: %s", CMD_ARGV[5]);
@@ -100,34 +154,68 @@ FLASH_BANK_COMMAND_HANDLER(fm3_flash_bank_command)
 	return ERROR_OK;
 }
 
+/* Data polling algorithm */
 static int fm3_busy_wait(struct target *target, uint32_t offset, int timeout_ms)
 {
 	int retval = ERROR_OK;
 	uint16_t state1, state2;
 	int ms = 0;
 
-	while(1) {
-		target_read_u16(target, offset, &state1);	/* dummy-read - see flash manual */
-		target_read_u16(target, offset, &state1);
-		target_read_u16(target, offset, &state2);
+	/* While(1) loop exit via "break" and "return" on error */
+	while(1)
+	{
+		/* dummy-read - see flash manual */
+		retval = target_read_u16(target, offset, &state1);
+		if (retval != ERROR_OK)
+			return retval;
+
+		/* Data polling 1 */
+		retval = target_read_u16(target, offset, &state1);
+		if (retval != ERROR_OK)
+			return retval;
+
+		/* Data polling 2 */
+		retval = target_read_u16(target, offset, &state2);
+		if (retval != ERROR_OK)
+			return retval;
 
-		if ( (state1 & FLASH_DQ6) == (state2 & FLASH_DQ6) ) {
+		/* Flash command finished via polled data equal? */
+		if ( (state1 & FLASH_DQ6) == (state2 & FLASH_DQ6) )
+		{
 			break;
 		}
-		else if (state1 & FLASH_DQ5) {
-			target_read_u16(target, offset, &state1);
-			target_read_u16(target, offset, &state2);
+		/* Timeout Flag? */
+		else if (state1 & FLASH_DQ5)
+		{
+			/* Retry data polling */
+
+			/* Data polling 1 */
+			retval = target_read_u16(target, offset, &state1);
+			if (retval != ERROR_OK)
+				return retval;
+
+			/* Data polling 2 */
+			retval = target_read_u16(target, offset, &state2);
+			if (retval != ERROR_OK)
+				return retval;
+
+			/* Flash command finished via polled data equal? */
 			if ( (state1 & FLASH_DQ6) != (state2 & FLASH_DQ6) )
-				retval = ERROR_FLASH_OPERATION_FAILED;
+			{
+				return ERROR_FLASH_OPERATION_FAILED;
+			}
+
+			/* finish anyway */
 			break;
 		}
 		usleep(1000);
 		++ms;
 
-		if (ms > timeout_ms) {
-			LOG_ERROR("toggle bit reading timed out!");
-			retval = ERROR_FLASH_OPERATION_FAILED;
-			break;
+		/* Polling time exceeded? */
+		if (ms > timeout_ms)
+		{
+			LOG_ERROR("Polling data reading timed out!");
+			return ERROR_FLASH_OPERATION_FAILED;
 		}
 	}
 
@@ -139,10 +227,32 @@ static int fm3_busy_wait(struct target *target, uint32_t offset, int timeout_ms)
 
 static int fm3_erase(struct flash_bank *bank, int first, int last)
 {
+	struct fm3_flash_bank *fm3_info = bank->driver_priv;
 	struct target *target = bank->target;
 	int retval = ERROR_OK;
 	uint32_t u32DummyRead;
 	int sector, odd;
+	uint32_t u32FlashType;
+	uint32_t u32FlashSeqAddress1;
+	uint32_t u32FlashSeqAddress2;
+
+	u32FlashType = (uint32_t) fm3_info->flashtype;
+
+	if (u32FlashType == fm3_flash_type1)
+	{
+		u32FlashSeqAddress1 = 0x00001550;
+		u32FlashSeqAddress2 = 0x00000AA8;
+	}
+	else if (u32FlashType == fm3_flash_type2)
+	{
+		u32FlashSeqAddress1 = 0x00000AA8;
+		u32FlashSeqAddress2 = 0x00000554;
+	}
+	else
+	{
+		LOG_ERROR("Flash/Device type unknown!");
+		return ERROR_FLASH_OPERATION_FAILED;
+	}
 
 	if (target->state != TARGET_HALTED) {
 		LOG_ERROR("Target not halted");
@@ -151,180 +261,248 @@ static int fm3_erase(struct flash_bank *bank, int first, int last)
 
 	LOG_INFO("Fujitsu MB9Bxxx: Sector Erase ... (%d to %d)", first, last);
 
-	target_write_u32(target, 0x40000000, 0x0001);		/* FASZR = 0x01, Enables CPU Programming Mode */
-	target_read_u32(target, 0x40000000, &u32DummyRead); /* dummy read of FASZR */
+	/* FASZR = 0x01, Enables CPU Programming Mode (16-bit Flash acccess) */
+	retval = target_write_u32(target, 0x40000000, 0x0001);
+	if (retval != ERROR_OK)
+		return retval;
+
+	/* dummy read of FASZR */
+	retval = target_read_u32(target, 0x40000000, &u32DummyRead);
+	if (retval != ERROR_OK)
+		return retval;
 
-	for (sector = first ; sector <= last ; sector++) {
+	for (sector = first ; sector <= last ; sector++)
+	{
 		uint32_t offset = bank->sectors[sector].offset;
 
-		for (odd = 0; odd < 2 ; odd++) {
-
+		for (odd = 0; odd < 2 ; odd++)
+		{
 			if (odd)
 				offset += 4;
 
-			target_write_u16(target, 0x1550, 0x00AA);
-			target_write_u16(target, 0x0AA8, 0x0055);
-			target_write_u16(target, 0x1550, 0x0080);
-			target_write_u16(target, 0x1550, 0x00AA);
-			target_write_u16(target, 0x0AA8, 0x0055);
-			target_write_u16(target, offset, 0x0030);
+			/* Flash unlock sequence */
+			retval = target_write_u16(target, u32FlashSeqAddress1, 0x00AA);
+			if (retval != ERROR_OK)
+				return retval;
 
-			retval = fm3_busy_wait(target, offset, 500);
+			retval = target_write_u16(target, u32FlashSeqAddress2, 0x0055);
+			if (retval != ERROR_OK)
+				return retval;
 
+			retval = target_write_u16(target, u32FlashSeqAddress1, 0x0080);
 			if (retval != ERROR_OK)
-				break;
+				return retval;
+
+			retval = target_write_u16(target, u32FlashSeqAddress1, 0x00AA);
+			if (retval != ERROR_OK)
+				return retval;
+
+			retval = target_write_u16(target, u32FlashSeqAddress2, 0x0055);
+			if (retval != ERROR_OK)
+				return retval;
+
+			/* Sector erase command (0x0030) */
+			retval = target_write_u16(target, offset, 0x0030);
+			if (retval != ERROR_OK)
+				return retval;
+
+			retval = fm3_busy_wait(target, offset, 500);
+			if (retval != ERROR_OK)
+				return retval;
 		}
 		bank->sectors[sector].is_erased = 1;
 	}
 
-	target_write_u32(target, 0x40000000, 0x0002);
-	target_read_u32(target, 0x40000000, &u32DummyRead); /* dummy read of FASZR */
+	/* FASZR = 0x02, Enables CPU Run Mode (32-bit Flash acccess) */
+	retval = target_write_u32(target, 0x40000000, 0x0002);
+	if (retval != ERROR_OK)
+		return retval;
+
+	/* dummy read of FASZR */
+	retval = target_read_u32(target, 0x40000000, &u32DummyRead);
 
 	return retval;
 }
 
-static int fm3_write_block(struct flash_bank *bank, uint8_t *buffer, uint32_t offset, uint32_t count)
+static int fm3_write_block(struct flash_bank *bank, uint8_t *buffer,
+		uint32_t offset, uint32_t count)
 {
 	struct fm3_flash_bank *fm3_info = bank->driver_priv;
 	struct target *target = bank->target;
-	uint32_t buffer_size = 8192;
+	uint32_t buffer_size = 2048;		/* 8192 for MB9Bxx6! */
 	struct working_area *source;
 	uint32_t address = bank->base + offset;
-	struct reg_param reg_params[4];
+	struct reg_param reg_params[6];
 	struct armv7m_algorithm armv7m_info;
 	int retval = ERROR_OK;
+	uint32_t u32FlashType;
+	uint32_t u32FlashSeqAddress1;
+	uint32_t u32FlashSeqAddress2;
+
+	u32FlashType = (uint32_t) fm3_info->flashtype;
+
+	if (u32FlashType == fm3_flash_type1)
+	{
+		u32FlashSeqAddress1 = 0x00001550;
+		u32FlashSeqAddress2 = 0x00000AA8;
+	}
+	else if (u32FlashType == fm3_flash_type2)
+	{
+		u32FlashSeqAddress1 = 0x00000AA8;
+		u32FlashSeqAddress2 = 0x00000554;
+	}
+	else
+	{
+		LOG_ERROR("Flash/Device type unknown!");
+		return ERROR_FLASH_OPERATION_FAILED;
+	}
 
 	/* RAMCODE used for fm3 Flash programming:                 */
 	/* R0 keeps source start address         (u32Source)       */
 	/* R1 keeps target start address         (u32Target)       */
 	/* R2 keeps number of halfwords to write (u32Count)        */
-	/* R3 returns result value               (u32FlashResult)  */
+	/* R3 keeps Flash Sequence address 1     (u32FlashSeq1)    */
+	/* R4 keeps Flash Sequence address 2     (u32FlashSeq2)    */
+	/* R5 returns result value               (u32FlashResult)  */
 
 	const uint8_t fm3_flash_write_code[] = {
-								/*    fm3_FLASH_IF->FASZ &= 0xFFFD;                               */
-	0x00, 0xBF,                 /*        NOP                                                     */
-	0x5F, 0xF0, 0x80, 0x43,     /*        MOVS.W   R3, #(fm3_FLASH_IF->FASZ)                      */
-	0x1B, 0x68,                 /*        LDR      R3, [R3]                                       */
-	0x4F, 0xF6, 0xFD, 0x74,     /*        MOVW     R4, #0xFFFD                                    */
-	0x23, 0x40,                 /*        ANDS     R3, R3, R4                                     */
-	0x5F, 0xF0, 0x80, 0x44,     /*        MOVS.W   R4, #(fm3_FLASH_IF->FASZ)                      */
-	0x23, 0x60,                 /*        STR      R3, [R4]                                       */
-								/*    fm3_FLASH_IF->FASZ |= 1;                                    */
-	0x5F, 0xF0, 0x80, 0x43,     /*        MOVS.W   R3, #(fm3_FLASH_IF->FASZ)                      */
-	0x1B, 0x68,                 /*        LDR      R3, [R3]                                       */
-	0x53, 0xF0, 0x01, 0x03,     /*        ORRS.W   R3, R3, #1                                     */
-	0x5F, 0xF0, 0x80, 0x44,     /*        MOVS.W   R4, #(fm3_FLASH_IF->FASZ)                      */
-	0x23, 0x60,                 /*        STR      R3, [R4]                                       */
-	                            /*    u32DummyRead = fm3_FLASH_IF->FASZ;                          */
-	0x2B, 0x4B,                 /*        LDR.N    R3, ??u32DummyRead                             */
-	0x5F, 0xF0, 0x80, 0x44,     /*        MOVS.W   R4, #(fm3_FLASH_IF->FASZ)                      */
-	0x24, 0x68,                 /*        LDR      R4, [R4]                                       */
-	0x1C, 0x60,                 /*        STR      R4, [R3]                                       */
-	                            /*    u32FlashResult = FLASH_WRITE_NO_RESULT                      */
-	0x2A, 0x4B,                 /*        LDR.N    R3, ??u32FlashResult                           */
-	0x00, 0x24,                 /*        MOVS     R4, #0                                         */
-	0x1C, 0x60,                 /*        STR      R4, [R3]                                       */
-	                            /*    while ((u32Count > 0 ) && (u32FlashResult                   */
-	                            /*      == FLASH_WRITE_NO_RESULT))                                */
-	0x01, 0x2A,                 /* L0:    CMP      R2, #1                                         */
-	0x32, 0xDB,                 /*        BLT.N    L1                                             */
-	0x27, 0x4B,                 /*        LDR.N    R3, ??u32FlashResult                           */
-	0x1B, 0x68,                 /*        LDR      R3, [R3]                                       */
-	0x00, 0x2B,                 /*        CMP      R3, #0                                         */
-	0x2E, 0xD1,                 /*        BNE.N    L1                                             */
-	                            /*    *(FLASH_SEQ_1550) = FLASH_WRITE_1;                          */
-	0x41, 0xF2, 0x50, 0x53,     /*        MOVW     R3, #0x1550                                    */
-	0xAA, 0x24,                 /*        MOVS     R4. #0xAA                                      */
-	0x1C, 0x80,                 /*        STRH     R4, [R3]                                       */
-	                            /*    *(FLASH_SEQ_0AA8) = FLASH_WRITE_2;                          */
-	0x40, 0xF6, 0xA8, 0x23,     /*        MOVW     R3, #0x0AA8                                    */
-	0x55, 0x24,                 /*        MOVS     R4. #0x55                                      */
-	0x1C, 0x80,                 /*        STRH     R4, [R3]                                       */
-	                            /*    *(FLASH_SEQ_1550) = FLASH_WRITE_3;                          */
-	0x41, 0xF2, 0x50, 0x53,     /*        MOVW     R3, #0x1550                                    */
-	0xA0, 0x24,                 /*        MOVS     R4. #0xA0                                      */
-	0x1C, 0x80,                 /*        STRH     R4, [R3]                                       */
-	                            /*    *(volatile uint16_t*)u32Target                              */
-	                            /*      = *(volatile uint16_t*)u32Source;                         */
-	0x03, 0x88,                 /*        LDRH     R3, [R0]                                       */
-	0x0B, 0x80,                 /*        STRH     R3, [R1]                                       */
-	                            /*    while (u32FlashResult == FLASH_WRITE_NO_RESTULT)            */
-	0x1E, 0x4B,                 /* L2:    LDR.N    R3, ??u32FlashResult                           */
-	0x1B, 0x68,                 /*        LDR      R3, [R3]                                       */
-	0x00, 0x2B,                 /*        CMP      R3, #0                                         */
-	0x11, 0xD1,                 /*        BNE.N    L3                                             */
-	                            /*    if ((*(volatile uint16_t*)u32Target & FLASH_DQ5)             */
-	                            /*      == FLASH_DQ5)                                             */
-	0x0B, 0x88,                 /*        LDRH     R3, [R1]                                       */
-	0x9B, 0x06,                 /*        LSLS     R3, R3, #0x1A                                  */
-	0x02, 0xD5,                 /*        BPL.N    L4                                             */
-	                            /*    u32FlashResult = FLASH_WRITE_TIMEOUT                        */
-	0x1B, 0x4B,                 /*        LDR.N    R3, ??u32FlashResult                           */
-	0x02, 0x24,                 /*        MOVS     R4, #2                                         */
-	0x1C, 0x60,                 /*        STR      R4, [R3]                                       */
-	                            /*    if ((*(volatile uint16_t *)u32Target & FLASH_DQ7)            */
-	                            /*      == (*(volatile uint16_t*)u32Source & FLASH_DQ7))          */
-	0x0B, 0x88,                 /* L4:    LDRH     R3, [R1]                                       */
-	0x13, 0xF0, 0x80, 0x03,     /*        ANDS.W   R3, R3, #0x80                                  */
-	0x04, 0x88,                 /*        LDRH     R4, [R0]                                       */
-	0x14, 0xF0, 0x80, 0x04,     /*        ANDS.W   R4, R4, #0x80                                  */
-	0xA3, 0x42,                 /*        CMP      R3, R4                                         */
-	0xED, 0xD1,                 /*        BNE.N    L2                                             */
-	                            /*    u32FlashResult = FLASH_WRITE_OKAY                           */
-	0x15, 0x4B,                 /*        LDR.N    R3, ??u32FlashResult                           */
-	0x01, 0x24,                 /*        MOVS     R4, #1                                         */
-	0x1C, 0x60,                 /*        STR      R4, [R3]                                       */
-	0xE9, 0xE7,                 /*        B.N      L2                                             */
-	                            /*    if (u32FlashResult != FLASH_WRITE_TIMEOUT)                   */
-	0x13, 0x4B,                 /*        LDR.N    R3, ??u32FlashResult                           */
-	0x1B, 0x68,                 /*        LDR      R3, [R3]                                       */
-	0x02, 0x2B,                 /*        CMP      R3, #2                                         */
-	0x02, 0xD0,                 /*        BEQ.N    L5                                             */
-	                            /*    u32FlashResult = FLASH_WRITE_NO_RESULT                      */
-	0x11, 0x4B,                 /*        LDR.N    R3, ??u32FlashResult                           */
-	0x00, 0x24,                 /*        MOVS     R4, #0                                         */
-	0x1C, 0x60,                 /*        STR      R4, [R3]                                       */
-	                            /*    u32Count--;                                                 */
-	0x52, 0x1E,                 /* L5:    SUBS     R2, R2, #1                                     */
-	                            /*    u32Source += 2;                                             */
-	0x80, 0x1C,                 /*        ADDS     R0, R0, #2                                     */
-	                            /*    u32Target += 2;                                             */
-	0x89, 0x1C,                 /*        ADDS     R1, R1, #2                                     */
-	0xCA, 0xE7,                 /*        B.N      L0                                             */
-	                            /*    fm3_FLASH_IF->FASZ &= 0xFFFE;                               */
-	0x5F, 0xF0, 0x80, 0x43,     /* L1:    MOVS.W   R3, #(fm3_FLASH_IF->FASZ)                      */
-	0x1B, 0x68,                 /*        LDR      R3, [R3]                                       */
-	0x4F, 0xF6, 0xFE, 0x74,     /*        MOVW     R4, #0xFFFE                                    */
-	0x23, 0x40,                 /*        ANDS     R3, R3, R4                                     */
-	0x5F, 0xF0, 0x80, 0x44,     /*        MOVS.W   R4, #(fm3_FLASH_IF->FASZ)                      */
-	0x23, 0x60,                 /*        STR      R3, [R4]                                       */
-	                            /*    fm3_FLASH_IF->FASZ |= 2;                                    */
-	0x5F, 0xF0, 0x80, 0x43,     /*        MOVS.W   R3, #(fm3_FLASH_IF->FASZ)                      */
-	0x1B, 0x68,                 /*        LDR      R3, [R3]                                       */
-	0x53, 0xF0, 0x02, 0x03,     /*        ORRS.W   R3, R3, #2                                     */
-	0x5F, 0xF0, 0x80, 0x44,     /*        MOVS.W   R4, #(fm3_FLASH_IF->FASZ)                      */
-	0x23, 0x60,                 /*        STR      R4, [R3]                                       */
-	                            /*    u32DummyRead = fm3_FLASH_IF->FASZ;                          */
-	0x04, 0x4B,                 /*        LDR.N    R3, ??u32DummyRead                             */
-	0x5F, 0xF0, 0x80, 0x44,     /*        MOVS.W   R4, #(fm3_FLASH_IF->FASZ)                      */
-	0x24, 0x68,                 /*        LDR      R4, [R4]                                       */
-	0x1C, 0x60,                 /*        STR      R4, [R3]                                       */
-	                            /*    copy u32FlashResult to R3 for return value                  */
-	0xDF, 0xF8, 0x0C, 0x30,     /*        LDR.W    R3, ??u32FlashResult                           */
-	0x1B, 0x68,                 /*        LDR      R3, [R3]                                       */
-	                            /*    Breakpoint here                                             */
-	0x00, 0xBE,                 /* Breakpoint #0                                                  */
-	0x00, 0x00,                 /*    alignment padding bytes                                     */
-	0x00, 0x80, 0xFF, 0x1F,     /* u32DummyRead address in RAM (0x1FFF8000)                       */
-	0x04, 0x80, 0xFF, 0x1F      /* u32FlashResult address in RAM (0x1FFF8004)                     */
+								/*    fm3_FLASH_IF->FASZ &= 0xFFFD;           */
+	0x5F, 0xF0, 0x80, 0x45,		/*        MOVS.W   R5, #(fm3_FLASH_IF->FASZ)  */
+	0x2D, 0x68,					/*        LDR      R5, [R5]                   */
+	0x4F, 0xF6, 0xFD, 0x76,		/*        MOVW     R6, #0xFFFD                */
+	0x35, 0x40,					/*        ANDS     R5, R5, R6                 */
+	0x5F, 0xF0, 0x80, 0x46,		/*        MOVS.W   R6, #(fm3_FLASH_IF->FASZ)  */
+	0x35, 0x60,					/*        STR      R5, [R6]                   */
+								/*    fm3_FLASH_IF->FASZ |= 1;                */
+	0x5F, 0xF0, 0x80, 0x45,		/*        MOVS.W   R5, #(fm3_FLASH_IF->FASZ)  */
+	0x2D, 0x68,					/*        LDR      R5, [R3]                   */
+	0x55, 0xF0, 0x01, 0x05,		/*        ORRS.W   R5, R5, #1                 */
+	0x5F, 0xF0, 0x80, 0x46,		/*        MOVS.W   R6, #(fm3_FLASH_IF->FASZ)  */
+	0x35, 0x60,					/*        STR      R5, [R6]                   */
+								/*    u32DummyRead = fm3_FLASH_IF->FASZ;      */
+	0x28, 0x4D,					/*        LDR.N    R5, ??u32DummyRead         */
+	0x5F, 0xF0, 0x80, 0x46,		/*        MOVS.W   R6, #(fm3_FLASH_IF->FASZ)  */
+	0x36, 0x68,					/*        LDR      R6, [R6]                   */
+	0x2E, 0x60,					/*        STR      R6, [R5]                   */
+								/*    u32FlashResult = FLASH_WRITE_NO_RESULT  */
+	0x26, 0x4D,					/*        LDR.N    R5, ??u32FlashResult       */
+	0x00, 0x26,					/*        MOVS     R6, #0                     */
+	0x2E, 0x60,					/*        STR      R6, [R5]                   */
+								/*    while ((u32Count > 0 )                  */
+								/*      && (u32FlashResult                    */
+								/*          == FLASH_WRITE_NO_RESULT))        */
+	0x01, 0x2A,					/* L0:    CMP      R2, #1                     */
+	0x2C, 0xDB,					/*        BLT.N    L1                         */
+	0x24, 0x4D,					/*        LDR.N    R5, ??u32FlashResult       */
+	0x2D, 0x68,					/*        LDR      R5, [R5]                   */
+	0x00, 0x2D,					/*        CMP      R5, #0                     */
+	0x28, 0xD1,					/*        BNE.N    L1                         */
+								/*    *u32FlashSeq1 = FLASH_WRITE_1;          */
+	0xAA, 0x25,					/*        MOVS     R5, #0xAA                  */
+	0x1D, 0x60,					/*        STR      R5, [R3]                   */
+								/*    *u32FlashSeq2 = FLASH_WRITE_2;          */
+	0x55, 0x25,					/*        MOVS     R5, #0x55                  */
+	0x25, 0x60,					/*        STR      R5, [R4]                   */
+								/*    *u32FlashSeq1 = FLASH_WRITE_3;          */
+	0xA0, 0x25,					/*        MOVS     R5, #0xA0                  */
+	0x1D, 0x60,					/*        STRH     R5, [R3]                   */
+								/*    *(volatile uint16_t*)u32Target          */
+								/*      = *(volatile uint16_t*)u32Source;     */
+	0x05, 0x88,					/*        LDRH     R5, [R0]                   */
+	0x0D, 0x80,					/*        STRH     R5, [R1]                   */
+								/*    while (u32FlashResult                   */
+								/*           == FLASH_WRITE_NO_RESTULT)       */
+	0x1E, 0x4D,					/* L2:    LDR.N    R5, ??u32FlashResult       */
+	0x2D, 0x68,					/*        LDR      R5, [R5]                   */
+	0x00, 0x2D,					/*        CMP      R5, #0                     */
+	0x11, 0xD1,					/*        BNE.N    L3                         */
+								/*    if ((*(volatile uint16_t*)u32Target     */
+								/*        & FLASH_DQ5) == FLASH_DQ5)          */
+	0x0D, 0x88,					/*        LDRH     R5, [R1]                   */
+	0xAD, 0x06,					/*        LSLS     R5, R5, #0x1A              */
+	0x02, 0xD5,					/*        BPL.N    L4                         */
+								/*    u32FlashResult = FLASH_WRITE_TIMEOUT    */
+	0x1A, 0x4D,					/*        LDR.N    R5, ??u32FlashResult       */
+	0x02, 0x26,					/*        MOVS     R6, #2                     */
+	0x2E, 0x60,					/*        STR      R6, [R5]                   */
+								/*    if ((*(volatile uint16_t *)u32Target    */
+								/*         & FLASH_DQ7)                       */
+								/*        == (*(volatile uint16_t*)u32Source  */
+								/*            & FLASH_DQ7))                   */
+	0x0D, 0x88,					/* L4:    LDRH     R5, [R1]                   */
+	0x15, 0xF0, 0x80, 0x05,		/*        ANDS.W   R5, R5, #0x80              */
+	0x06, 0x88,					/*        LDRH     R6, [R0]                   */
+	0x16, 0xF0, 0x80, 0x06,		/*        ANDS.W   R6, R6, #0x80              */
+	0xB5, 0x42,					/*        CMP      R5, R6                     */
+	0xED, 0xD1,					/*        BNE.N    L2                         */
+								/*    u32FlashResult = FLASH_WRITE_OKAY       */
+	0x15, 0x4D,					/*        LDR.N    R5, ??u32FlashResult       */
+	0x01, 0x26,					/*        MOVS     R6, #1                     */
+	0x2E, 0x60,					/*        STR      R6, [R5]                   */
+	0xE9, 0xE7,					/*        B.N      L2                         */
+								/*    if (u32FlashResult                      */
+								/*        != FLASH_WRITE_TIMEOUT)             */
+	0x13, 0x4D,					/*        LDR.N    R5, ??u32FlashResult       */
+	0x2D, 0x68,					/*        LDR      R5, [R5]                   */
+	0x02, 0x2D,					/*        CMP      R5, #2                     */
+	0x02, 0xD0,					/*        BEQ.N    L5                         */
+								/*    u32FlashResult = FLASH_WRITE_NO_RESULT  */
+	0x11, 0x4D,					/*        LDR.N    R5, ??u32FlashResult       */
+	0x00, 0x26,					/*        MOVS     R6, #0                     */
+	0x2E, 0x60,					/*        STR      R6, [R5]                   */
+								/*    u32Count--;                             */
+	0x52, 0x1E,					/* L5:    SUBS     R2, R2, #1                 */
+								/*    u32Source += 2;                         */
+	0x80, 0x1C,					/*        ADDS     R0, R0, #2                 */
+								/*    u32Target += 2;                         */
+	0x89, 0x1C,					/*        ADDS     R1, R1, #2                 */
+	0xD0, 0xE7,					/*        B.N      L0                         */
+								/*    fm3_FLASH_IF->FASZ &= 0xFFFE;           */
+	0x5F, 0xF0, 0x80, 0x45,		/* L1:    MOVS.W   R5, #(fm3_FLASH_IF->FASZ)  */
+	0x2D, 0x68,					/*        LDR      R5, [R5]                   */
+	0x4F, 0xF6, 0xFE, 0x76,		/*        MOVW     R6, #0xFFFE                */
+	0x35, 0x40,					/*        ANDS     R5, R5, R6                 */
+	0x5F, 0xF0, 0x80, 0x46,		/*        MOVS.W   R6, #(fm3_FLASH_IF->FASZ)  */
+	0x35, 0x60,					/*        STR      R5, [R6]                   */
+								/*    fm3_FLASH_IF->FASZ |= 2;                */
+	0x5F, 0xF0, 0x80, 0x45,		/*        MOVS.W   R5, #(fm3_FLASH_IF->FASZ)  */
+	0x2D, 0x68,					/*        LDR      R5, [R5]                   */
+	0x55, 0xF0, 0x02, 0x05,		/*        ORRS.W   R5, R5, #2                 */
+	0x5F, 0xF0, 0x80, 0x46,		/*        MOVS.W   R6, #(fm3_FLASH_IF->FASZ)  */
+	0x35, 0x60,					/*        STR      R5, [R6]                   */
+								/*    u32DummyRead = fm3_FLASH_IF->FASZ;      */
+	0x04, 0x4D,					/*        LDR.N    R5, ??u32DummyRead         */
+	0x5F, 0xF0, 0x80, 0x46,		/*        MOVS.W   R6, #(fm3_FLASH_IF->FASZ)  */
+	0x36, 0x68,					/*        LDR      R6, [R6]                   */
+	0x2E, 0x60,					/*        STR      R6, [R5]                   */
+								/*    copy u32FlashResult to R3 for return    */
+								/*      value                                 */
+	0xDF, 0xF8, 0x08, 0x50,		/*        LDR.W    R5, ??u32FlashResult       */
+	0x2D, 0x68,					/*        LDR      R5, [R5]                   */
+								/*    Breakpoint here                         */
+	0x00, 0xBE,					/*        BKPT     #0                         */
+
+	/* The following address pointers assume, that the code is running from   */
+	/* address 0x1FFF8008. These address pointers will be patched, if a       */
+	/* different start address in RAM is used (e.g. for Flash type 2)!        */
+	0x00, 0x80, 0xFF, 0x1F,		/* u32DummyRead address in RAM (0x1FFF8000)   */
+	0x04, 0x80, 0xFF, 0x1F		/* u32FlashResult address in RAM (0x1FFF8004) */
 	};
 
 	LOG_INFO("Fujitsu MB9B500: FLASH Write ...");
 
 	/* disable HW watchdog */
-	target_write_u32(target, 0x40011C00, 0x1ACCE551);
-	target_write_u32(target, 0x40011C00, 0xE5331AAE);
-	target_write_u32(target, 0x40011008, 0x00000000);
+	retval = target_write_u32(target, 0x40011C00, 0x1ACCE551);
+	if (retval != ERROR_OK)
+		return retval;
+
+	retval = target_write_u32(target, 0x40011C00, 0xE5331AAE);
+	if (retval != ERROR_OK)
+		return retval;
+
+	retval = target_write_u32(target, 0x40011008, 0x00000000);
+	if (retval != ERROR_OK)
+		return retval;
 
 	count = count / 2;		/* number bytes -> number halfwords */
 
@@ -360,7 +538,7 @@ static int fm3_write_block(struct flash_bank *bank, uint8_t *buffer, uint32_t of
 				target_free_working_area(target, fm3_info->write_algorithm);
 			}
 
-			LOG_WARNING("no large enough working area available, can't do block memory writes");
+			LOG_WARNING("No large enough working area available, can't do block memory writes");
 			return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
 		}
 	}
@@ -368,60 +546,65 @@ static int fm3_write_block(struct flash_bank *bank, uint8_t *buffer, uint32_t of
 	armv7m_info.common_magic = ARMV7M_COMMON_MAGIC;
 	armv7m_info.core_mode = ARMV7M_MODE_ANY;
 
-	init_reg_param(&reg_params[0], "r0", 32, PARAM_OUT); // source start address
-	init_reg_param(&reg_params[1], "r1", 32, PARAM_OUT); // target start address
-	init_reg_param(&reg_params[2], "r2", 32, PARAM_OUT); // number of halfwords to program
-	init_reg_param(&reg_params[3], "r3", 32, PARAM_IN);  // result
+	init_reg_param(&reg_params[0], "r0", 32, PARAM_OUT); /* source start address */
+	init_reg_param(&reg_params[1], "r1", 32, PARAM_OUT); /* target start address */
+	init_reg_param(&reg_params[2], "r2", 32, PARAM_OUT); /* number of halfwords to program */
+	init_reg_param(&reg_params[3], "r3", 32, PARAM_OUT); /* Flash Sequence address 1 */
+	init_reg_param(&reg_params[4], "r4", 32, PARAM_OUT); /* Flash Sequence address 1 */
+	init_reg_param(&reg_params[5], "r5", 32, PARAM_IN);  /* result */
 
-	/* write code buffer and use Flash programming code within fm3           */
-	/* Set breakpoint to 0 with time-out of 1000 ms                          */
+	/* write code buffer and use Flash programming code within fm3 */
+	/* Set breakpoint to 0 with time-out of 1000 ms */
 	while (count > 0)
 	{
 		uint32_t thisrun_count = (count > (buffer_size / 2)) ? (buffer_size / 2) : count;
 
-		/* for some reason the first 8 byte of code are corrupt when target_run_algorithm() returns */
-		/* need some more investigation on this                                                     */
-		retval = target_write_buffer(target,
-				fm3_info->write_algorithm->address, 8, fm3_flash_write_code);
+		retval = target_write_buffer(target, fm3_info->write_algorithm->address,
+				8, fm3_flash_write_code);
 		if (retval != ERROR_OK)
-			return retval;
+			break;
+
+		/* Patching 'local variable address' for different RAM addresses */
+		if (fm3_info->write_algorithm->address != 0x1FFF8008)
+		{
+			/* Algorithm: u32DummyRead: */
+			retval = target_write_u32(target, (fm3_info->write_algorithm->address)
+					+ sizeof(fm3_flash_write_code) - 8,
+					(fm3_info->write_algorithm->address) - 8);
+			if (retval != ERROR_OK)
+				break;
 
+			/* Algorithm: u32FlashResult: */
+			retval = target_write_u32(target, (fm3_info->write_algorithm->address)
+					+ sizeof(fm3_flash_write_code) - 4, (fm3_info->write_algorithm->address) - 4);
+			if (retval != ERROR_OK)
+				break;
+		}
 
-		retval = target_write_buffer(target,
-				source->address, thisrun_count * 2, buffer);
+		retval = target_write_buffer(target, source->address, thisrun_count * 2,
+				buffer);
 		if (retval != ERROR_OK)
 			break;
 
 		buf_set_u32(reg_params[0].value, 0, 32, source->address);
 		buf_set_u32(reg_params[1].value, 0, 32, address);
 		buf_set_u32(reg_params[2].value, 0, 32, thisrun_count);
+		buf_set_u32(reg_params[3].value, 0, 32, u32FlashSeqAddress1);
+		buf_set_u32(reg_params[4].value, 0, 32, u32FlashSeqAddress2);
 
-
-		retval = target_run_algorithm(target, 0, NULL, 4, reg_params,
+		retval = target_run_algorithm(target, 0, NULL, 6, reg_params,
 				fm3_info->write_algorithm->address, 0, 1000, &armv7m_info);
 		if (retval != ERROR_OK)
 		{
-			LOG_ERROR("error executing fm3 Flash programming algorithm");
+			LOG_ERROR("Error executing fm3 Flash programming algorithm");
 			retval = ERROR_FLASH_OPERATION_FAILED;
 			break;
 		}
 
-#if 0
-		/* debug the corrupted 8 bytes */
-		unsigned char buf[256];
-		retval = target_read_buffer(target, fm3_info->write_algorithm->address, 256, buf);
-		if (retval != ERROR_OK)
-			printf("cannot read buffer\n");
-		unsigned int i;
-		for ( i = 0; i < sizeof(fm3_flash_write_code); i++)
-			if (buf[i] != fm3_flash_write_code[i])
-				printf("broken: %d %02x != %02x\n", i, buf[i], fm3_flash_write_code[i]);
-#endif
-
-		if (buf_get_u32(reg_params[3].value, 0, 32) != ERROR_OK)
+		if (buf_get_u32(reg_params[5].value, 0, 32) != ERROR_OK)
 		{
-			LOG_ERROR("Fujitsu MB9B500: FLASH programming ERROR (Timeout) -> Reg R3: %x",
-					buf_get_u32(reg_params[3].value, 0, 32));
+			LOG_ERROR("Fujitsu MB9[A/B]FXXX: Flash programming ERROR (Timeout) \
+					-> Reg R3: %x", buf_get_u32(reg_params[5].value, 0, 32));
 			retval = ERROR_FLASH_OPERATION_FAILED;
 			break;
 		}
@@ -438,6 +621,8 @@ static int fm3_write_block(struct flash_bank *bank, uint8_t *buffer, uint32_t of
 	destroy_reg_param(&reg_params[1]);
 	destroy_reg_param(&reg_params[2]);
 	destroy_reg_param(&reg_params[3]);
+	destroy_reg_param(&reg_params[4]);
+	destroy_reg_param(&reg_params[5]);
 
 	return retval;
 }
@@ -471,7 +656,7 @@ static int fm3_probe(struct flash_bank *bank)
 	bank->sectors[1].is_erased = -1;
 	bank->sectors[1].is_protected = -1;
 
-	if (fm3_info->variant == mb9bfxx1)
+	if ((fm3_info->variant == mb9bfxx1) || (fm3_info->variant == mb9afxx1))
 	{
 		num_pages = 3;
 		bank->size = 64 * 1024; /* bytes */
@@ -483,13 +668,17 @@ static int fm3_probe(struct flash_bank *bank)
 		bank->sectors[2].is_protected = -1;
 	}
 
-	if (  (fm3_info->variant == mb9bfxx2)
+	if ((fm3_info->variant == mb9bfxx2)
 		|| (fm3_info->variant == mb9bfxx4)
 		|| (fm3_info->variant == mb9bfxx5)
-		|| (fm3_info->variant == mb9bfxx6))
+		|| (fm3_info->variant == mb9bfxx6)
+		|| (fm3_info->variant == mb9afxx2)
+		|| (fm3_info->variant == mb9afxx4)
+		|| (fm3_info->variant == mb9afxx5)
+		|| (fm3_info->variant == mb9afxx6))
 	{
 		num_pages = 3;
-		bank->size = 128 * 1024; // bytes
+		bank->size = 128 * 1024; /* bytes */
 		bank->num_sectors = num_pages;
 
 		bank->sectors[2].offset = 0x8000;
@@ -498,12 +687,15 @@ static int fm3_probe(struct flash_bank *bank)
 		bank->sectors[2].is_protected = -1;
 	}
 
-	if ( (fm3_info->variant == mb9bfxx4)
+	if ((fm3_info->variant == mb9bfxx4)
 		|| (fm3_info->variant == mb9bfxx5)
-		|| (fm3_info->variant == mb9bfxx6))
+		|| (fm3_info->variant == mb9bfxx6)
+		|| (fm3_info->variant == mb9afxx4)
+		|| (fm3_info->variant == mb9afxx5)
+		|| (fm3_info->variant == mb9afxx6))
 	{
 		num_pages = 4;
-		bank->size = 256 * 1024; // bytes
+		bank->size = 256 * 1024; /* bytes */
 		bank->num_sectors = num_pages;
 
 		bank->sectors[3].offset = 0x20000;
@@ -512,11 +704,13 @@ static int fm3_probe(struct flash_bank *bank)
 		bank->sectors[3].is_protected = -1;
 	}
 
-	if ( (fm3_info->variant == mb9bfxx5)
-		|| (fm3_info->variant == mb9bfxx6))
+	if ((fm3_info->variant == mb9bfxx5)
+		|| (fm3_info->variant == mb9bfxx6)
+		|| (fm3_info->variant == mb9afxx5)
+		|| (fm3_info->variant == mb9afxx6))
 	{
 		num_pages = 5;
-		bank->size = 384 * 1024; // bytes
+		bank->size = 384 * 1024; /* bytes */
 		bank->num_sectors = num_pages;
 
 		bank->sectors[4].offset = 0x40000;
@@ -525,10 +719,11 @@ static int fm3_probe(struct flash_bank *bank)
 		bank->sectors[4].is_protected = -1;
 	}
 
-	if (fm3_info->variant == mb9bfxx6)
+	if ((fm3_info->variant == mb9bfxx6)
+		|| (fm3_info->variant == mb9afxx6))
 	{
 		num_pages = 6;
-		bank->size = 512 * 1024; // bytes
+		bank->size = 512 * 1024; /* bytes */
 		bank->num_sectors = num_pages;
 
 		bank->sectors[5].offset = 0x60000;
@@ -550,7 +745,7 @@ static int fm3_auto_probe(struct flash_bank *bank)
 	return fm3_probe(bank);
 }
 
-static int fm3_info(struct flash_bank *bank, char *buf, int buf_size)
+static int fm3_info_cmd(struct flash_bank *bank, char *buf, int buf_size)
 {
 	snprintf(buf, buf_size, "Fujitsu fm3 Device does not support Chip-ID (Type unknown)");
 	return ERROR_OK;
@@ -559,8 +754,32 @@ static int fm3_info(struct flash_bank *bank, char *buf, int buf_size)
 static int fm3_chip_erase(struct flash_bank *bank)
 {
 	struct target *target = bank->target;
+	struct fm3_flash_bank *fm3_info = bank->driver_priv;
 	int retval = ERROR_OK;
 	uint32_t u32DummyRead;
+	uint32_t u32FlashType;
+	uint32_t u32FlashSeqAddress1;
+	uint32_t u32FlashSeqAddress2;
+
+	u32FlashType = (uint32_t) fm3_info->flashtype;
+
+	if (u32FlashType == fm3_flash_type1)
+	{
+		LOG_INFO("*** Erasing mb9bfxxx type");
+		u32FlashSeqAddress1 = 0x00001550;
+		u32FlashSeqAddress2 = 0x00000AA8;
+	}
+	else if (u32FlashType == fm3_flash_type2)
+	{
+		LOG_INFO("*** Erasing mb9afxxx type");
+		u32FlashSeqAddress1 = 0x00000AA8;
+		u32FlashSeqAddress2 = 0x00000554;
+	}
+	else
+	{
+		LOG_ERROR("Flash/Device type unknown!");
+		return ERROR_FLASH_OPERATION_FAILED;
+	}
 
 	if (target->state != TARGET_HALTED)
 	{
@@ -568,23 +787,57 @@ static int fm3_chip_erase(struct flash_bank *bank)
 		return ERROR_TARGET_NOT_HALTED;
 	}
 
-	LOG_INFO("Fujitsu MB9Bxxx: Chip Erase ... (may take several seconds)");
+	LOG_INFO("Fujitsu MB9[AB]xxx: Chip Erase ... (may take several seconds)");
 
 	/* Implement Flash chip erase (mass erase) completely on host */
-	target_write_u32(target, 0x40000000, 0x0001);		/* FASZR = 0x01, Enables CPU Programming Mode (16-bit Flash access) */
-	target_read_u32(target, 0x40000000, &u32DummyRead); /* dummy read of FASZR */
 
-	target_write_u16(target, 0x00001550, 0x00AA); 		/* Flash unlock sequence */
-	target_write_u16(target, 0x00000AA8, 0x0055);
-	target_write_u16(target, 0x00001550, 0x0080);
-	target_write_u16(target, 0x00001550, 0x00AA);
-	target_write_u16(target, 0x00000AA8, 0x0055);
-	target_write_u16(target, 0x00001550, 0x0010); 		/* Chip Erase command */
+	/* FASZR = 0x01, Enables CPU Programming Mode (16-bit Flash access) */
+	retval = target_write_u32(target, 0x40000000, 0x0001);
+	if (retval != ERROR_OK)
+		return retval;
+
+	/* dummy read of FASZR */
+	retval = target_read_u32(target, 0x40000000, &u32DummyRead);
+	if (retval != ERROR_OK)
+		return retval;
+
+	/* Flash unlock sequence */
+	retval = target_write_u16(target, u32FlashSeqAddress1, 0x00AA);
+	if (retval != ERROR_OK)
+		return retval;
+
+	retval = target_write_u16(target, u32FlashSeqAddress2, 0x0055);
+	if (retval != ERROR_OK)
+		return retval;
+
+	retval = target_write_u16(target, u32FlashSeqAddress1, 0x0080);
+	if (retval != ERROR_OK)
+		return retval;
+
+	retval = target_write_u16(target, u32FlashSeqAddress1, 0x00AA);
+	if (retval != ERROR_OK)
+		return retval;
+
+	retval = target_write_u16(target, u32FlashSeqAddress2, 0x0055);
+	if (retval != ERROR_OK)
+		return retval;
+
+	/* Chip Erase command (0x0010) */
+	retval = target_write_u16(target, u32FlashSeqAddress1, 0x0010);
+	if (retval != ERROR_OK)
+		return retval;
 
-	retval = fm3_busy_wait(target, 0xAA8, 20000);
+	retval = fm3_busy_wait(target, u32FlashSeqAddress2, 20000);	/* 20s timeout */
+	if (retval != ERROR_OK)
+		return retval;
+
+	/* FASZR = 0x02, Re-enables CPU Run Mode (32-bit Flash access) */
+	retval = target_write_u32(target, 0x40000000, 0x0002);
+	if (retval != ERROR_OK)
+		return retval;
 
-	target_write_u32(target, 0x40000000, 0x0002);
-	target_read_u32(target, 0x40000000, &u32DummyRead); /* dummy read of FASZR */
+	/* dummy read of FASZR */
+	retval = target_read_u32(target, 0x40000000, &u32DummyRead);
 
 	return retval;
 }
@@ -650,5 +903,5 @@ struct flash_driver fm3_flash = {
 	.probe = fm3_probe,
 	.auto_probe = fm3_auto_probe,
 	.erase_check = default_flash_mem_blank_check,
-	.info = fm3_info,
+	.info = fm3_info_cmd,
 };

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/fm3.c |  687 +++++++++++++++++++++++++++++++++++----------------
 1 files changed, 470 insertions(+), 217 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Wed Oct 19 21:53:27 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Wed, 19 Oct 2011 19:53:27 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-130-g1c1771e
Message-ID: <mailman.207.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  1c1771ef6c4ed8d913146f943a64c0cf16850b59 (commit)
      from  9ddb94c1f3227b4fc693e9aaba5df0ee4f9171e6 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 1c1771ef6c4ed8d913146f943a64c0cf16850b59
Author: Freddie Chopin <freddie.chopin at gmail.com>
Date:   Wed Oct 19 21:40:48 2011 +0200

    Unused variables
    
    Fix a few errors with set and unused variables detected by GCC 4.7.0
    
    Change-Id: I59b748e18e514ee9f0cde7883b4ed5116198bd4a
    Signed-off-by: Freddie Chopin <freddie.chopin at gmail.com>
    Reviewed-on: http://openocd.zylin.com/36
    Tested-by: jenkins
    Reviewed-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/src/target/armv7a.c b/src/target/armv7a.c
index e0d0882..0bac27f 100644
--- a/src/target/armv7a.c
+++ b/src/target/armv7a.c
@@ -129,7 +129,6 @@ int armv7a_mmu_translate_va(struct target *target,  uint32_t va, uint32_t *val)
 	uint32_t first_lvl_descriptor = 0x0;
 	uint32_t second_lvl_descriptor = 0x0;
 	int retval;
-	uint32_t cb;
 	struct armv7a_common *armv7a = target_to_armv7a(target);
 	struct arm_dpm *dpm = armv7a->armv4_5_common.dpm;
 	uint32_t ttb = 0; /*  default ttb0 */
@@ -168,7 +167,6 @@ int armv7a_mmu_translate_va(struct target *target,  uint32_t va, uint32_t *val)
 	if ((first_lvl_descriptor & 0x3) == 2)
 	{
 		/* section descriptor */
-		cb = (first_lvl_descriptor & 0xc) >> 2;
 		*val = (first_lvl_descriptor & 0xfff00000) | (va & 0x000fffff);
 		return ERROR_OK;
 	}
@@ -203,9 +201,6 @@ int armv7a_mmu_translate_va(struct target *target,  uint32_t va, uint32_t *val)
 		return ERROR_TARGET_TRANSLATION_FAULT;
 	}
 
-	/* cacheable/bufferable is always specified in bits 3-2 */
-	cb = (second_lvl_descriptor & 0xc) >> 2;
-
 	if ((second_lvl_descriptor & 0x3) == 1)
 	{
 		/* large page descriptor */
@@ -243,7 +238,7 @@ int armv7a_mmu_translate_va_pa(struct target *target, uint32_t va,
 	struct armv7a_common *armv7a = target_to_armv7a(target);
 	struct arm_dpm *dpm = armv7a->armv4_5_common.dpm;
 	uint32_t virt = va & ~0xfff;
-	uint32_t NOS,NS,SH,INNER,OUTER;
+	uint32_t NOS,NS,INNER,OUTER;
 	*val = 0xdeadbeef;
 	retval = dpm->prepare(dpm);
 	if (retval != ERROR_OK)
@@ -260,7 +255,6 @@ int armv7a_mmu_translate_va_pa(struct target *target, uint32_t va,
 	/* decode memory attribute */
 	NOS = (*val >> 10) & 1; /*  Not Outer shareable */
 	NS = (*val >> 9) & 1; /* Non secure */
-	SH = (*val >> 7 )& 1; /*  shareable */
 	INNER = (*val >> 4) &  0x7;
 	OUTER = (*val >> 2) & 0x3;
 
@@ -726,7 +720,6 @@ done:
 
 int armv7a_init_arch_info(struct target *target, struct armv7a_common *armv7a)
 {
-	struct armv7a_common *again;
 	struct arm *armv4_5 = &armv7a->armv4_5_common;
     armv4_5->arch_info = armv7a;
 	target->arch_info = &armv7a->armv4_5_common;
@@ -738,7 +731,6 @@ int armv7a_init_arch_info(struct target *target, struct armv7a_common *armv7a)
 	armv7a->armv7a_mmu.armv7a_cache.ctype = -1;
 	armv7a->armv7a_mmu.armv7a_cache.flush_all_data_cache = NULL;
     armv7a->armv7a_mmu.armv7a_cache.display_cache_info = NULL;
-    again =target_to_armv7a(target);
 	return ERROR_OK;
 }
 
diff --git a/src/target/cortex_a.c b/src/target/cortex_a.c
index 7547f17..2370d95 100755
--- a/src/target/cortex_a.c
+++ b/src/target/cortex_a.c
@@ -92,7 +92,7 @@ static int cortex_a8_restore_cp15_control_reg(struct target* target)
 				1, 0,   /* CRn, CRm */
 				cortex_a8->cp15_control_reg);
 	}
-	return ERROR_OK;
+	return retval;
 }
 
 /*  check address before cortex_a8_apb read write access with mmu on

-----------------------------------------------------------------------

Summary of changes:
 src/target/armv7a.c   |   10 +---------
 src/target/cortex_a.c |    2 +-
 2 files changed, 2 insertions(+), 10 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Thu Oct 20 03:46:04 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Thu, 20 Oct 2011 01:46:04 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-131-g3d2305f
Message-ID: <mailman.208.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  3d2305f2e6a55912d5851c0dbed886d913a4d015 (commit)
      from  1c1771ef6c4ed8d913146f943a64c0cf16850b59 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 3d2305f2e6a55912d5851c0dbed886d913a4d015
Author: Andreas Fritiofson <andreas.fritiofson at gmail.com>
Date:   Thu Oct 20 00:25:08 2011 +0200

    rtos: return the correct value if the T or H packets are handled
    
    Change-Id: Iea31e20ee4e35c1a9cb7b93424c92b3f38081067
    Signed-off-by: Andreas Fritiofson <andreas.fritiofson at gmail.com>
    Reviewed-on: http://openocd.zylin.com/38
    Tested-by: jenkins
    Reviewed-by: Evan Hunter <evan at ozhiker.com>
    Reviewed-by: Peter Stuge <peter at stuge.se>

diff --git a/src/rtos/rtos.c b/src/rtos/rtos.c
index 74e8724..8591007 100644
--- a/src/rtos/rtos.c
+++ b/src/rtos/rtos.c
@@ -490,6 +490,7 @@ int gdb_thread_packet(struct connection *connection, char *packet, int packet_si
 		} else {
 			gdb_put_packet(connection, "E01", 3); // thread not found
 		}
+		return ERROR_OK;
 	}
 	else if ( packet[0] == 'H') // Set current thread ( 'c' for step and continue, 'g' for all other operations )
 	{
@@ -498,6 +499,7 @@ int gdb_thread_packet(struct connection *connection, char *packet, int packet_si
 			sscanf(packet, "Hg%16" SCNx64, &current_threadid);
 		}
 		gdb_put_packet(connection, "OK", 2);
+		return ERROR_OK;
 	}
 
 	return GDB_THREAD_PACKET_NOT_CONSUMED;

-----------------------------------------------------------------------

Summary of changes:
 src/rtos/rtos.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Thu Oct 20 03:46:40 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Thu, 20 Oct 2011 01:46:40 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-132-g6b209e7
Message-ID: <mailman.209.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  6b209e74897c5a7dc2ff72bb598e898437038c7b (commit)
      from  3d2305f2e6a55912d5851c0dbed886d913a4d015 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 6b209e74897c5a7dc2ff72bb598e898437038c7b
Author: Andreas Fritiofson <andreas.fritiofson at gmail.com>
Date:   Thu Oct 20 00:21:33 2011 +0200

    rtos: remove broken code for handling the deprecated qP packet
    
    Change-Id: Icca522c1e2a2877abb20665b171c61079b1d8f48
    Signed-off-by: Andreas Fritiofson <andreas.fritiofson at gmail.com>
    Reviewed-on: http://openocd.zylin.com/37
    Tested-by: jenkins
    Reviewed-by: Peter Stuge <peter at stuge.se>

diff --git a/src/rtos/rtos.c b/src/rtos/rtos.c
index 8591007..8a59fd3 100644
--- a/src/rtos/rtos.c
+++ b/src/rtos/rtos.c
@@ -132,91 +132,7 @@ int gdb_thread_packet(struct connection *connection, char *packet, int packet_si
 {
 	struct target *target = get_target_from_connection(connection);
 
-	if (strstr(packet, "qP"))
-	{
-		#define TAG_THREADID 1		/* Echo the thread identifier */
-		#define TAG_EXISTS 2		/* Is this process defined enough to
-						   fetch registers and its stack */
-		#define TAG_DISPLAY 4		/* A short thing maybe to put on a window */
-		#define TAG_THREADNAME 8	/* string, maps 1-to-1 with a thread is */
-		#define TAG_MOREDISPLAY 16	/* Whatever the kernel wants to say about */
-
-			// TODO: need to scanf the mode variable (or it with the tags), and the threadid
-
-		unsigned long mode;
-		threadid_t threadid = 0;
-		struct thread_detail* detail;
-		sscanf(packet, "qP%8lx%16" SCNx64, &mode, &threadid);
-
-
-		int found = -1;
-
-		if ((target->rtos != NULL) && (target->rtos->thread_details
-				!= NULL)) {
-			int thread_num;
-			for (thread_num = 0; thread_num
-					< target->rtos->thread_count; thread_num++) {
-				if (target->rtos->thread_details[thread_num].threadid
-						== threadid) {
-					if (target->rtos->thread_details[thread_num].exists) {
-						found = thread_num;
-					}
-				}
-			}
-		}
-		if (found == -1) {
-			gdb_put_packet(connection, "E01", 3); // thread not found
-			return ERROR_OK;
-		}
-
-		detail = &target->rtos->thread_details[found];
-
-		if ( detail->display_str != NULL )
-		{
-			mode &= TAG_DISPLAY;
-		}
-		if ( detail->thread_name_str != NULL )
-		{
-			mode &= TAG_THREADNAME;
-		}
-		if ( detail->extra_info_str != NULL )
-		{
-			mode &= TAG_MOREDISPLAY;
-		}
-
-
-		mode &= TAG_THREADID | TAG_EXISTS;
-
-		char thread_str[1000];
-
-		sprintf(thread_str, "%08lx", mode);
-		sprintf(thread_str, "%016" PRIx64, threadid);
-
-
-		if (mode & TAG_THREADID) {
-			sprintf(thread_str, "%08" PRIx32 "10%016" PRIx64, TAG_THREADID, threadid);
-		}
-		if (mode & TAG_EXISTS) {
-			sprintf(thread_str, "%08" PRIx32 "08%08" PRIx32, TAG_EXISTS, (detail->exists==true)?1:0);
-		}
-		if (mode & TAG_DISPLAY) {
-			sprintf(thread_str, "%08" PRIx32 "%02x%s", TAG_DISPLAY, (unsigned char)strlen(detail->display_str), detail->display_str );
-		}
-		if (mode & TAG_MOREDISPLAY) {
-			sprintf(thread_str, "%08" PRIx32 "%02x%s", TAG_MOREDISPLAY, (unsigned char)strlen(detail->extra_info_str), detail->extra_info_str );
-		}
-		if (mode & TAG_THREADNAME) {
-			sprintf(thread_str, "%08" PRIx32 "%02x%s", TAG_THREADNAME, (unsigned char)strlen(detail->thread_name_str), detail->thread_name_str );
-		}
-
-		//gdb_put_packet(connection, tmpstr, sizeof(tmpstr)-1);
-		gdb_put_packet(connection, thread_str, strlen(thread_str));
-
-		//			gdb_put_packet(connection, "", 0);
-		//		gdb_put_packet(connection, "OK", 2); // all threads alive
-		return ERROR_OK;
-	}
-	else if (strstr(packet, "qThreadExtraInfo,"))
+	if (strstr(packet, "qThreadExtraInfo,"))
 	{
 		if ((target->rtos != NULL) && (target->rtos->thread_details != NULL) && (target->rtos->thread_count != 0))
 		{

-----------------------------------------------------------------------

Summary of changes:
 src/rtos/rtos.c |   86 +------------------------------------------------------
 1 files changed, 1 insertions(+), 85 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Fri Oct 21 11:30:48 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Fri, 21 Oct 2011 09:30:48 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-133-g7fe05ff
Message-ID: <mailman.210.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  7fe05ff330490cd3399e3d2101ec3b2eb03524bf (commit)
      from  6b209e74897c5a7dc2ff72bb598e898437038c7b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 7fe05ff330490cd3399e3d2101ec3b2eb03524bf
Author: Spencer Oliver <spen at spen-soft.co.uk>
Date:   Fri Oct 21 09:51:21 2011 +0100

    jim: add missing jim license
    
    Change-Id: Ib8e34739d92cd54655b9b47d07b856a82ff25f3c
    Signed-off-by: Spencer Oliver <spen at spen-soft.co.uk>
    Reviewed-on: http://openocd.zylin.com/39
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/helper/jim-nvp.c b/src/helper/jim-nvp.c
index be94f15..6a78a84 100644
--- a/src/helper/jim-nvp.c
+++ b/src/helper/jim-nvp.c
@@ -1,3 +1,46 @@
+/* Jim - A small embeddable Tcl interpreter
+ *
+ * Copyright 2005 Salvatore Sanfilippo <antirez at invece.org>
+ * Copyright 2005 Clemens Hintze <c.hintze at gmx.net>
+ * Copyright 2005 patthoyts - Pat Thoyts <patthoyts at users.sf.net>
+ * Copyright 2008 oharboe - ??yvind Harboe - oyvind.harboe at zylin.com
+ * Copyright 2008 Andrew Lunn <andrew at lunn.ch>
+ * Copyright 2008 Duane Ellis <openocd at duaneellis.com>
+ * Copyright 2008 Uwe Klein <uklein at klein-messgeraete.de>
+ * Copyright 2008 Steve Bennett <steveb at workware.net.au>
+ * Copyright 2009 Nico Coesel <ncoesel at dealogic.nl>
+ * Copyright 2009 Zachary T Welch zw at superlucidity.net
+ * Copyright 2009 David Brownell
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ * 2. Redistributions in binary form must reproduce the above
+ *    copyright notice, this list of conditions and the following
+ *    disclaimer in the documentation and/or other materials
+ *    provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE JIM TCL PROJECT ``AS IS'' AND ANY
+ * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
+ * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
+ * PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
+ * JIM TCL PROJECT OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+ * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+ * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
+ * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
+ * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ *
+ * The views and conclusions contained in the software and documentation
+ * are those of the authors and should not be interpreted as representing
+ * official policies, either expressed or implied, of the Jim Tcl Project.
+ */
+
 #include <string.h>
 #include <jim-nvp.h>
 
diff --git a/src/helper/jim-nvp.h b/src/helper/jim-nvp.h
index 12ff889..4428f5d 100644
--- a/src/helper/jim-nvp.h
+++ b/src/helper/jim-nvp.h
@@ -1,3 +1,46 @@
+/* Jim - A small embeddable Tcl interpreter
+ *
+ * Copyright 2005 Salvatore Sanfilippo <antirez at invece.org>
+ * Copyright 2005 Clemens Hintze <c.hintze at gmx.net>
+ * Copyright 2005 patthoyts - Pat Thoyts <patthoyts at users.sf.net>
+ * Copyright 2008 oharboe - ??yvind Harboe - oyvind.harboe at zylin.com
+ * Copyright 2008 Andrew Lunn <andrew at lunn.ch>
+ * Copyright 2008 Duane Ellis <openocd at duaneellis.com>
+ * Copyright 2008 Uwe Klein <uklein at klein-messgeraete.de>
+ * Copyright 2008 Steve Bennett <steveb at workware.net.au>
+ * Copyright 2009 Nico Coesel <ncoesel at dealogic.nl>
+ * Copyright 2009 Zachary T Welch zw at superlucidity.net
+ * Copyright 2009 David Brownell
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ * 2. Redistributions in binary form must reproduce the above
+ *    copyright notice, this list of conditions and the following
+ *    disclaimer in the documentation and/or other materials
+ *    provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE JIM TCL PROJECT ``AS IS'' AND ANY
+ * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
+ * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
+ * PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
+ * JIM TCL PROJECT OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+ * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+ * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
+ * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
+ * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ *
+ * The views and conclusions contained in the software and documentation
+ * are those of the authors and should not be interpreted as representing
+ * official policies, either expressed or implied, of the Jim Tcl Project.
+ */
+
 #ifndef JIM_NVP_H
 #define JIM_NVP_H
 

-----------------------------------------------------------------------

Summary of changes:
 src/helper/jim-nvp.c |   43 +++++++++++++++++++++++++++++++++++++++++++
 src/helper/jim-nvp.h |   43 +++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 86 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sat Oct 22 08:19:22 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sat, 22 Oct 2011 06:19:22 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-134-ga093f82
Message-ID: <mailman.211.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  a093f82bb74710533e1b3352acda13960167c53e (commit)
      from  7fe05ff330490cd3399e3d2101ec3b2eb03524bf (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit a093f82bb74710533e1b3352acda13960167c53e
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sat Oct 22 01:04:27 2011 +0200

    server: remove warning due to dead assignment
    
    Change-Id: Idb08aef0c11b3fae92286e8fcea61ab09ab09e74
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/44
    Reviewed-by: Peter Stuge <peter at stuge.se>
    Tested-by: jenkins

diff --git a/src/server/server.c b/src/server/server.c
index 84ec1ac..bb60fc5 100644
--- a/src/server/server.c
+++ b/src/server/server.c
@@ -71,8 +71,11 @@ static int add_connection(struct service *service, struct command_context *cmd_c
 		c->fd_out = c->fd;
 
 		/* This increases performance dramatically for e.g. GDB load which
-		 * does not have a sliding window protocol. */
-		retval = setsockopt(c->fd,	/* socket affected */
+		 * does not have a sliding window protocol. 
+		 *
+		 * Ignore errors from this fn as it probably just means less performance
+		 */
+		setsockopt(c->fd,	/* socket affected */
 				IPPROTO_TCP,		/* set option at TCP level */
 				TCP_NODELAY,		/* name of option */
 				(char *)&flag,		/* the cast is historical cruft */

-----------------------------------------------------------------------

Summary of changes:
 src/server/server.c |    7 +++++--
 1 files changed, 5 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sat Oct 22 08:46:30 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sat, 22 Oct 2011 06:46:30 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-135-g5179738
Message-ID: <mailman.212.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  51797380621f3257a427bcf25ae4b34f1f5838bd (commit)
      from  a093f82bb74710533e1b3352acda13960167c53e (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 51797380621f3257a427bcf25ae4b34f1f5838bd
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sat Oct 22 08:25:00 2011 +0200

    warning: fix false positive
    
    may be used uninitialized in this function [-Werror=uninitialized]
    
    Change-Id: Ida2cf8efe4e7da6fd9f669b806a20894563ac3d4
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/49
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/jtag/core.c b/src/jtag/core.c
index b26701e..ad63753 100644
--- a/src/jtag/core.c
+++ b/src/jtag/core.c
@@ -1398,7 +1398,7 @@ int adapter_init(struct command_context *cmd_ctx)
 
 	int requested_khz = jtag_get_speed_khz();
 	int actual_khz = requested_khz;
-	int jtag_speed_var;
+	int jtag_speed_var = 0;
 	retval = jtag_get_speed(&jtag_speed_var);
 	if (retval != ERROR_OK)
 		return retval;

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/core.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sat Oct 22 11:01:31 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sat, 22 Oct 2011 09:01:31 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-136-g8d5e346
Message-ID: <mailman.213.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  8d5e34635cf5049440dcbc2e6df82dd524ce1b76 (commit)
      from  51797380621f3257a427bcf25ae4b34f1f5838bd (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 8d5e34635cf5049440dcbc2e6df82dd524ce1b76
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sat Oct 22 00:40:51 2011 +0200

    buspirate: ignore return value and fix warning
    
    Perhaps we could do one better and propagate the error?
    
    Change-Id: Idc45f516c26f09de4ee01fe05e8d3475f4b80db3
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/43
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/jtag/drivers/buspirate.c b/src/jtag/drivers/buspirate.c
index 62ab008..3a368eb 100644
--- a/src/jtag/drivers/buspirate.c
+++ b/src/jtag/drivers/buspirate.c
@@ -757,13 +757,13 @@ static void buspirate_jtag_enable(int fd)
 
 static void buspirate_jtag_reset(int fd)
 {
-	int ret;
 	char tmp[5];
 
 	tmp[0] = 0x00; /* exit OCD1 mode */
 	buspirate_serial_write(fd, tmp, 1);
 	usleep(10000);
-	ret = buspirate_serial_read(fd, tmp, 5);
+	/* We ignore the return value here purposly, nothing we can do */
+	buspirate_serial_read(fd, tmp, 5);
 	if (strncmp(tmp, "BBIO1", 5) == 0) {
 		tmp[0] = 0x0F; /*  reset BP */
 		buspirate_serial_write(fd, tmp, 1);

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/drivers/buspirate.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sat Oct 22 13:46:05 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sat, 22 Oct 2011 11:46:05 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-137-g811f7d3
Message-ID: <mailman.214.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  811f7d3f7eb0a2f40406949e21d7f2ab577d2d46 (commit)
      from  8d5e34635cf5049440dcbc2e6df82dd524ce1b76 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 811f7d3f7eb0a2f40406949e21d7f2ab577d2d46
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Sat Oct 22 19:23:10 2011 +0800

    FLASH/STMSMI: fix clang "dead store" warning
    
    Change-Id: Icfdefdc48432db2057d3fea19dc424571d2385eb
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>
    Reviewed-on: http://openocd.zylin.com/50
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/flash/nor/stmsmi.c b/src/flash/nor/stmsmi.c
index d298b36..bfec789 100644
--- a/src/flash/nor/stmsmi.c
+++ b/src/flash/nor/stmsmi.c
@@ -714,20 +714,17 @@ static int stmsmi_protect_check(struct flash_bank *bank)
 static int get_stmsmi_info(struct flash_bank *bank, char *buf, int buf_size)
 {
 	struct stmsmi_flash_bank *stmsmi_info = bank->driver_priv;
-	int printed;
 
 	if (!(stmsmi_info->probed))
 	{
-		printed = snprintf(buf, buf_size,
+		snprintf(buf, buf_size,
 			"\nSMI flash bank not probed yet\n");
 		return ERROR_OK;
 	}
 
-	printed = snprintf(buf, buf_size, "\nSMI flash information:\n"
+	snprintf(buf, buf_size, "\nSMI flash information:\n"
 		"  Device \'%s\' (ID 0x%08x)\n",
 		stmsmi_info->dev->name, stmsmi_info->dev->device_id);
-	buf += printed;
-	buf_size -= printed;
 
 	return ERROR_OK;
 }

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/stmsmi.c |    7 ++-----
 1 files changed, 2 insertions(+), 5 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 23 13:34:45 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 23 Oct 2011 11:34:45 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-138-g0577ba8
Message-ID: <mailman.215.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  0577ba8331080f57966d06e6aced1c061d228bb9 (commit)
      from  811f7d3f7eb0a2f40406949e21d7f2ab577d2d46 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 0577ba8331080f57966d06e6aced1c061d228bb9
Author: Edgar Grimberg <edgar.grimberg at gmail.com>
Date:   Sun Oct 23 11:39:50 2011 +0200

    tms470: removed unnecessary operations
    
    This should silence a warning.
    
    Change-Id: Id91a9ebacae836083b1db2654a8e7bf24b2300e9
    Signed-off-by: Edgar Grimberg <edgar.grimberg at gmail.com>
    Reviewed-on: http://openocd.zylin.com/52
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/flash/nor/tms470.c b/src/flash/nor/tms470.c
index dd9ff5b..359d3aa 100644
--- a/src/flash/nor/tms470.c
+++ b/src/flash/nor/tms470.c
@@ -1244,13 +1244,11 @@ static int get_tms470_info(struct flash_bank *bank, char *buf, int buf_size)
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
 
-	used += snprintf(buf, buf_size, "\ntms470 information: Chip is %s\n", tms470_info->part_name);
+	used = snprintf(buf, buf_size, "\ntms470 information: Chip is %s\n", tms470_info->part_name);
 	buf += used;
 	buf_size -= used;
 
-	used += snprintf(buf, buf_size, "Flash protection level 2 is %s\n", tms470_check_flash_unlocked(bank->target) == ERROR_OK ? "disabled" : "enabled");
-	buf += used;
-	buf_size -= used;
+	snprintf(buf, buf_size, "Flash protection level 2 is %s\n", tms470_check_flash_unlocked(bank->target) == ERROR_OK ? "disabled" : "enabled");
 
 	return ERROR_OK;
 }

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/tms470.c |    6 ++----
 1 files changed, 2 insertions(+), 4 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 23 13:56:35 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 23 Oct 2011 11:56:35 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-139-g4e079d1
Message-ID: <mailman.216.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  4e079d18bffaed0372ab5b2f13cfd5d14db79d21 (commit)
      from  0577ba8331080f57966d06e6aced1c061d228bb9 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 4e079d18bffaed0372ab5b2f13cfd5d14db79d21
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Fri Oct 21 19:00:09 2011 +0200

    clang: fix malloc() warning with assert
    
    Change-Id: I989d2655622a9f11f4a0a2994014e42822587ecd
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/41
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/jtag/tcl.c b/src/jtag/tcl.c
index 3b2f83b..468edf5 100644
--- a/src/jtag/tcl.c
+++ b/src/jtag/tcl.c
@@ -172,6 +172,7 @@ static int Jim_Command_drscan(Jim_Interp *interp, int argc, Jim_Obj *const *args
 	}
 
 	num_fields = (argc-2)/2;
+	assert(num_fields > 0);
 	fields = malloc(sizeof(struct scan_field) * num_fields);
 	for (i = 2; i < argc; i += 2)
 	{
diff --git a/src/target/image.c b/src/target/image.c
index 21ce11f..8f437c0 100644
--- a/src/target/image.c
+++ b/src/target/image.c
@@ -473,6 +473,8 @@ static int image_elf_read_headers(struct image *image)
 		if ((field32(elf, elf->segments[i].p_type) == PT_LOAD) && (field32(elf, elf->segments[i].p_filesz) != 0))
 			image->num_sections++;
 
+	assert(image->num_sections > 0);
+
 	/**
 	 * some ELF linkers produce binaries with *all* the program header
 	 * p_paddr fields zero (there can be however one loadable segment

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/tcl.c     |    1 +
 src/target/image.c |    2 ++
 2 files changed, 3 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 23 13:58:19 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 23 Oct 2011 11:58:19 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-140-gc9f51ac
Message-ID: <mailman.217.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  c9f51acdc31a6277b9a743974fed06d390df221e (commit)
      from  4e079d18bffaed0372ab5b2f13cfd5d14db79d21 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit c9f51acdc31a6277b9a743974fed06d390df221e
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Fri Oct 21 19:14:57 2011 +0200

    clang: fix warning w/assert so that clang knows that there will be no division by zero
    
    Change-Id: I98ac62a22f21043bb535a667a4f1f1537ccde2a4
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/42
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/target/target.c b/src/target/target.c
index b68eee3..d4cb577 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -3317,7 +3317,8 @@ static void writeGmon(uint32_t *samples, uint32_t sampleNum, const char *filenam
 		}
 	}
 
-	int addressSpace = (max-min + 1);
+	int addressSpace = (max - min + 1);
+	assert(addressSpace >= 2);
 
 	static const uint32_t maxBuckets = 16 * 1024; /* maximum buckets. */
 	uint32_t length = addressSpace;

-----------------------------------------------------------------------

Summary of changes:
 src/target/target.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 23 15:24:23 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 23 Oct 2011 13:24:23 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-141-gc5c4ed8
Message-ID: <mailman.218.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  c5c4ed82abcef3e9d5494d850d4f3acded320e55 (commit)
      from  c9f51acdc31a6277b9a743974fed06d390df221e (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit c5c4ed82abcef3e9d5494d850d4f3acded320e55
Author: Mathias K <kesmtp at freenet.de>
Date:   Sat Oct 22 18:00:20 2011 +0200

    add Freescale Kinetis K40 devices and Kwikstik eval board
    
    Change-Id: I4817921d09ab915c50f42651bc073690033450fe
    Signed-off-by: Mathias K <kesmtp at freenet.de>
    Reviewed-on: http://openocd.zylin.com/51
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/tcl/board/kwikstik.cfg b/tcl/board/kwikstik.cfg
new file mode 100644
index 0000000..ed9b583
--- /dev/null
+++ b/tcl/board/kwikstik.cfg
@@ -0,0 +1,19 @@
+#
+# Freescale KwikStik development board
+#
+
+#
+# JLINK interface is onboard
+#
+source [find interface/jlink.cfg]
+
+jtag_rclk 100
+
+source [find target/k40.cfg]
+
+reset_config trst_and_srst
+
+#
+# Bank definition for the 'program flash' (instructions and/or data)
+#
+flash bank $_CHIPNAME.pflash kinetis 0x00000000 0x40000 0 4 $_TARGETNAME
diff --git a/tcl/target/k40.cfg b/tcl/target/k40.cfg
new file mode 100644
index 0000000..9984bfc
--- /dev/null
+++ b/tcl/target/k40.cfg
@@ -0,0 +1,35 @@
+#
+# Freescale Kinetis K40 devices
+#
+
+#
+# K40 devices support both JTAG and SWD transports.
+#
+source [find target/swj-dp.tcl]
+
+if { [info exists CHIPNAME] } {
+    set _CHIPNAME $CHIPNAME
+} else {
+    set _CHIPNAME k40
+}
+
+if { [info exists ENDIAN] } {
+    set _ENDIAN $ENDIAN
+} else {
+    set _ENDIAN little
+}
+
+if { [info exists CPUTAPID ] } {
+    set _CPUTAPID $CPUTAPID
+} else {
+    set _CPUTAPID 0x4ba00477
+}
+
+set _TARGETNAME $_CHIPNAME.cpu
+
+swj_newdap $_CHIPNAME cpu -irlen 4 -ircapture 0x1 -irmask 0xf -expected-id $_CPUTAPID
+
+target create $_TARGETNAME cortex_m3 -chain-position $_CHIPNAME.cpu
+
+$_CHIPNAME.cpu configure -event examine-start { puts "START..." ; }
+$_CHIPNAME.cpu configure -event examine-end { puts "END..." ; }

-----------------------------------------------------------------------

Summary of changes:
 tcl/board/kwikstik.cfg |   19 +++++++++++++++++++
 tcl/target/k40.cfg     |   35 +++++++++++++++++++++++++++++++++++
 2 files changed, 54 insertions(+), 0 deletions(-)
 create mode 100644 tcl/board/kwikstik.cfg
 create mode 100644 tcl/target/k40.cfg


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 23 15:26:12 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 23 Oct 2011 13:26:12 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-142-g2c31adb
Message-ID: <mailman.219.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  2c31adb31df0fa7608dd5a0fe3ba0acb1cee6a04 (commit)
      from  c5c4ed82abcef3e9d5494d850d4f3acded320e55 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 2c31adb31df0fa7608dd5a0fe3ba0acb1cee6a04
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sat Oct 22 01:06:26 2011 +0200

    tms470: remove dead assignment warning
    
    Change-Id: I21e7ac47f80d93c9c0d7b169f8848b929c664b20
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/45
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

-----------------------------------------------------------------------

Summary of changes:


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 23 15:28:27 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 23 Oct 2011 13:28:27 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-143-gd5b5f9f
Message-ID: <mailman.220.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  d5b5f9f4fd1a2781600cc74a54d5c9a2b7e09e87 (commit)
      from  2c31adb31df0fa7608dd5a0fe3ba0acb1cee6a04 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit d5b5f9f4fd1a2781600cc74a54d5c9a2b7e09e87
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sat Oct 22 01:09:32 2011 +0200

    kinetis: fix warning about malloc(0) w/assert
    
    Change-Id: Ib40204675bfc5429c744f9ed7e2f7098384b753d
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/47
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/flash/nor/kinetis.c b/src/flash/nor/kinetis.c
index 2613522..ecc60be 100644
--- a/src/flash/nor/kinetis.c
+++ b/src/flash/nor/kinetis.c
@@ -467,6 +467,7 @@ static int kinetis_probe(struct flash_bank *bank)
 	}
 
 	bank->num_sectors = bank->size / (2 * 1024);
+	assert(bank->num_sectors > 0);
 	bank->sectors = malloc(sizeof(struct flash_sector) * bank->num_sectors);
 
 	for (i = 0; i < bank->num_sectors; i++) {

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/kinetis.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 23 15:30:22 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 23 Oct 2011 13:30:22 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-144-gdad3850
Message-ID: <mailman.221.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  dad38502643de668d751c6a5ff23334270e650b7 (commit)
      from  d5b5f9f4fd1a2781600cc74a54d5c9a2b7e09e87 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit dad38502643de668d751c6a5ff23334270e650b7
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sat Oct 22 01:08:16 2011 +0200

    fm3: fix warning for superfluous assignment
    
    Change-Id: I4f8e8c2e676a2728ddc6227daf9ca6a7ceb3d505
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/46
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/flash/nor/fm3.c b/src/flash/nor/fm3.c
index 1e2adf5..e852589 100644
--- a/src/flash/nor/fm3.c
+++ b/src/flash/nor/fm3.c
@@ -643,7 +643,6 @@ static int fm3_probe(struct flash_bank *bank)
 
 	bank->sectors = malloc(sizeof(struct flash_sector) * num_pages);
 	bank->base = 0x00000000;
-	num_pages = 2;				/* start with smallest Flash pages number */
 	bank->size = 32 * 1024;		/* bytes */
 
 	bank->sectors[0].offset = 0;

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/fm3.c |    1 -
 1 files changed, 0 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 23 15:31:42 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 23 Oct 2011 13:31:42 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-145-g9bb3a05
Message-ID: <mailman.222.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  9bb3a05f0e53ca824ccfb5828c8c9399e375de8b (commit)
      from  dad38502643de668d751c6a5ff23334270e650b7 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 9bb3a05f0e53ca824ccfb5828c8c9399e375de8b
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sat Oct 22 01:11:58 2011 +0200

    mx2: add error propagation and remove warnings
    
    Change-Id: Idd4fb452790e5d7921a749679dbd865586e5a4a9
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/48
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/flash/nand/mx2.c b/src/flash/nand/mx2.c
index 77ae138..6c3c550 100644
--- a/src/flash/nand/mx2.c
+++ b/src/flash/nand/mx2.c
@@ -501,15 +501,20 @@ static int imx27_read_page(struct nand_device *nand, uint32_t page,
 		return retval;
 	}
 	/* Reset address_cycles before imx27_command ?? */
-	retval = ERROR_OK;
-	retval |= imx27_command(nand, NAND_CMD_READ0);
-
-	retval |= imx27_address(nand, 0); //col
-	retval |= imx27_address(nand, 0); //col
-	retval |= imx27_address(nand, page & 0xff); //page address
-	retval |= imx27_address(nand, (page >> 8) & 0xff); //page address
-	retval |= imx27_address(nand, (page >> 16) & 0xff); //page address
-	retval |= imx27_command(nand, NAND_CMD_READSTART);
+	retval = imx27_command(nand, NAND_CMD_READ0);
+	if (retval != ERROR_OK) return retval;
+	retval = imx27_address(nand, 0); //col
+	if (retval != ERROR_OK) return retval;
+	retval = imx27_address(nand, 0); //col
+	if (retval != ERROR_OK) return retval;
+	retval = imx27_address(nand, page & 0xff); //page address
+	if (retval != ERROR_OK) return retval;
+	retval = imx27_address(nand, (page >> 8) & 0xff); //page address
+	if (retval != ERROR_OK) return retval;
+	retval = imx27_address(nand, (page >> 16) & 0xff); //page address
+	if (retval != ERROR_OK) return retval;
+	retval = imx27_command(nand, NAND_CMD_READSTART);
+	if (retval != ERROR_OK) return retval;
 
 	target_write_u16(target, MX2_NF_BUFADDR, 0);
 	mx2_nf_info->fin = MX2_NF_FIN_DATAOUT;

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nand/mx2.c |   23 ++++++++++++++---------
 1 files changed, 14 insertions(+), 9 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 23 16:17:21 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 23 Oct 2011 14:17:21 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-146-g3432049
Message-ID: <mailman.223.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  343204927656561dd3deec52c58c13ef2de4f60b (commit)
      from  9bb3a05f0e53ca824ccfb5828c8c9399e375de8b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 343204927656561dd3deec52c58c13ef2de4f60b
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Sun Oct 23 11:21:44 2011 +0800

    FLASH/CFI: fix clang warnings
    
    Total of 5 warnings:
    3x "Dead store": removed dead assignment to variable;
    1x "Dereference of null pointer": this is not an error, but a
       limited visibility of clang, since pointer erase_region_info
       is initialized inside cfi_fixup_non_cfi();
    1x "Branch condition evaluates to a garbage value":
       this is a real coding bug that could issue SIGSEGV, since
       "goto cleanup" can be executed before initialization
       of "source".
    
    Change-Id: Id3c323c82bb15cbd3bb8fc04b23541f11145f109
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>
    Reviewed-on: http://openocd.zylin.com/84
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/flash/nor/cfi.c b/src/flash/nor/cfi.c
index 5d35801..f75efac 100644
--- a/src/flash/nor/cfi.c
+++ b/src/flash/nor/cfi.c
@@ -768,7 +768,7 @@ static int cfi_spansion_info(struct flash_bank *bank, char *buf, int buf_size)
 	buf += printed;
 	buf_size -= printed;
 
-	printed = snprintf(buf, buf_size, "VppMin: %u.%x, VppMax: %u.%x\n",
+	snprintf(buf, buf_size, "VppMin: %u.%x, VppMax: %u.%x\n",
 			(pri_ext->VppMin & 0xf0) >> 4, pri_ext->VppMin & 0x0f,
 			(pri_ext->VppMax & 0xf0) >> 4, pri_ext->VppMax & 0x0f);
 
@@ -802,7 +802,7 @@ static int cfi_intel_info(struct flash_bank *bank, char *buf, int buf_size)
 	buf += printed;
 	buf_size -= printed;
 
-	printed = snprintf(buf, buf_size, "protection_fields: %i, prot_reg_addr: 0x%x, "
+	snprintf(buf, buf_size, "protection_fields: %i, prot_reg_addr: 0x%x, "
 			"factory pre-programmed: %i, user programmable: %i\n",
 			pri_ext->num_protection_fields, pri_ext->prot_reg_addr,
 			1 << pri_ext->fact_prot_reg_size, 1 << pri_ext->user_prot_reg_size);
@@ -1222,7 +1222,7 @@ static int cfi_intel_write_block(struct flash_bank *bank, uint8_t *buffer,
 	struct target *target = bank->target;
 	struct reg_param reg_params[7];
 	struct arm_algorithm armv4_5_info;
-	struct working_area *source;
+	struct working_area *source = NULL;
 	uint32_t buffer_size = 32768;
 	uint32_t write_command_val, busy_pattern_val, error_pattern_val;
 
@@ -2704,6 +2704,7 @@ static int cfi_probe(struct flash_bank *bank)
 	}
 
 	cfi_info->probed = 0;
+	cfi_info->num_erase_regions = 0;
 	if (bank->sectors)
 	{
 		free(bank->sectors);
@@ -3151,7 +3152,7 @@ static int get_cfi_info(struct flash_bank *bank, char *buf, int buf_size)
 
 	if (cfi_info->qry[0] == 0xff)
 	{
-		printed = snprintf(buf, buf_size, "\ncfi flash bank not probed yet\n");
+		snprintf(buf, buf_size, "\ncfi flash bank not probed yet\n");
 		return ERROR_OK;
 	}
 

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/cfi.c |    9 +++++----
 1 files changed, 5 insertions(+), 4 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 23 16:32:41 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 23 Oct 2011 14:32:41 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-147-g7b94f4c
Message-ID: <mailman.224.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  7b94f4c99d7f7970c4f8bf51d477d88b93a4278c (commit)
      from  343204927656561dd3deec52c58c13ef2de4f60b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 7b94f4c99d7f7970c4f8bf51d477d88b93a4278c
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Sun Oct 23 12:02:57 2011 +0800

    NAND/CORE: fix clang warning
    
    The fix is inline with the Linux coding style that forbids
    assignment in if condition
    
    Change-Id: I42a371d6adfdf3b3fb867705211c47d89776ee2a
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>
    Reviewed-on: http://openocd.zylin.com/85
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/flash/nand/core.c b/src/flash/nand/core.c
index 03deabd..d9bb7de 100644
--- a/src/flash/nand/core.c
+++ b/src/flash/nand/core.c
@@ -598,7 +598,8 @@ int nand_erase(struct nand_device *nand, int first_block, int last_block)
 			return ERROR_NAND_OPERATION_TIMEOUT;
 		}
 
-		if ((retval = nand_read_status(nand, &status)) != ERROR_OK)
+		retval = nand_read_status(nand, &status);
+		if (retval != ERROR_OK)
 		{
 			LOG_ERROR("couldn't read status");
 			return ERROR_NAND_OPERATION_FAILED;

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nand/core.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 23 16:38:22 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 23 Oct 2011 14:38:22 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-148-g40c425e
Message-ID: <mailman.225.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  40c425e4005b6c00cab3ff2cd620cd3d6ae66514 (commit)
      from  7b94f4c99d7f7970c4f8bf51d477d88b93a4278c (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 40c425e4005b6c00cab3ff2cd620cd3d6ae66514
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Sun Oct 23 12:12:57 2011 +0800

    NOR/CORE: fix clang warning
    
    The fix is inline with the Linux coding style that forbids
    assignment in if condition
    
    Change-Id: I10338a249bcfeff87d8596f7e17f209e26b41678
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>
    Reviewed-on: http://openocd.zylin.com/86
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/flash/nor/core.c b/src/flash/nor/core.c
index 4b5fe7d..7f40bbf 100644
--- a/src/flash/nor/core.c
+++ b/src/flash/nor/core.c
@@ -344,7 +344,8 @@ int default_flash_blank_check(struct flash_bank *bank)
 		uint32_t address = bank->base + bank->sectors[i].offset;
 		uint32_t size = bank->sectors[i].size;
 
-		if ((retval = target_blank_check_memory(target, address, size, &blank)) != ERROR_OK)
+		retval = target_blank_check_memory(target, address, size, &blank);
+		if (retval != ERROR_OK)
 		{
 			fast_check = 0;
 			break;

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/core.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 23 17:14:32 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 23 Oct 2011 15:14:32 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-149-g09fbc0a
Message-ID: <mailman.226.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  09fbc0ab8649c69a9f97fa4ed599db836a2c0152 (commit)
      from  40c425e4005b6c00cab3ff2cd620cd3d6ae66514 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 09fbc0ab8649c69a9f97fa4ed599db836a2c0152
Author: Richard Barlow <richard at richardbarlow.co.uk>
Date:   Sun Oct 23 12:50:34 2011 +0100

    cfg: Add interface config for Dangerous Prototypes BusBlaster
    
    The BusBlaster from Dangerous Prototypes is based on the FTDI FT2232H IC.
    It has a CPLD between the FT2232H and the JTAG header allowing it to
    emulate various debugger types. It comes configured as a JTAGkey compatible
    device.
    
    Change-Id: Iab56907bf67ded87001e628d93012f1e16287d90
    Signed-off-by: Richard Barlow <richard at richardbarlow.co.uk>
    Reviewed-on: http://openocd.zylin.com/53
    Tested-by: jenkins
    Reviewed-by: Peter Stuge <peter at stuge.se>

diff --git a/tcl/interface/dp_busblaster.cfg b/tcl/interface/dp_busblaster.cfg
new file mode 100644
index 0000000..f87a482
--- /dev/null
+++ b/tcl/interface/dp_busblaster.cfg
@@ -0,0 +1,14 @@
+#
+# Dangerous Prototypes - Bus Blaster
+#
+# The Bus Blaster has a configurable buffer between the FTDI FT2232H and the
+# JTAG header which allows it to emulate various debugger types. It comes
+# configured as a JTAGkey device.
+#
+# http://dangerousprototypes.com/docs/Bus_Blaster
+#
+
+interface ft2232
+ft2232_device_desc "Dual RS232-HS"
+ft2232_layout jtagkey
+ft2232_vid_pid 0x0403 0x6010

-----------------------------------------------------------------------

Summary of changes:
 tcl/interface/dp_busblaster.cfg |   14 ++++++++++++++
 1 files changed, 14 insertions(+), 0 deletions(-)
 create mode 100644 tcl/interface/dp_busblaster.cfg


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 23 17:17:38 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 23 Oct 2011 15:17:38 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-150-g8e8ff02
Message-ID: <mailman.227.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  8e8ff02b74fd98fcff080ecb081312d2a08f314e (commit)
      from  09fbc0ab8649c69a9f97fa4ed599db836a2c0152 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 8e8ff02b74fd98fcff080ecb081312d2a08f314e
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Sun Oct 23 12:16:26 2011 +0800

    SERVER: fix clang warning
    
    The fix is inline with the Linux coding style that forbids
    assignment in if condition
    
    Change-Id: I0b9d0b419d9c8b7a8c755e048d5faf72d1658ba2
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>
    Reviewed-on: http://openocd.zylin.com/87
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/server/server.c b/src/server/server.c
index bb60fc5..a7fddf6 100644
--- a/src/server/server.c
+++ b/src/server/server.c
@@ -487,7 +487,8 @@ int server_loop(struct command_context *command_context)
 				{
 					if ((FD_ISSET(c->fd, &read_fds)) || c->input_pending)
 					{
-						if ((retval = service->input(c)) != ERROR_OK)
+						retval = service->input(c);
+						if (retval != ERROR_OK)
 						{
 							struct connection *next = c->next;
 							if (service->type == CONNECTION_PIPE)

-----------------------------------------------------------------------

Summary of changes:
 src/server/server.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Mon Oct 24 19:11:14 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Mon, 24 Oct 2011 17:11:14 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-151-ge5fd613
Message-ID: <mailman.228.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  e5fd6131fe781631797631ba8ba48cf361ff7635 (commit)
      from  8e8ff02b74fd98fcff080ecb081312d2a08f314e (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit e5fd6131fe781631797631ba8ba48cf361ff7635
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Oct 24 18:11:43 2011 +0200

    warning: silence gcc by initializing local variables
    
    GCC doesn't understand that these are in fact initialized if they are
    used.
    
    Change-Id: I01988adb0547f785b48d869ddbe44cc17dca4739
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/116
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 7f89f2e..9ea7b5a 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -1352,7 +1352,7 @@ static int dap_info_command(struct command_context *cmd_ctx,
 		struct adiv5_dap *dap, int ap)
 {
 	int retval;
-	uint32_t dbgbase, apid;
+	uint32_t dbgbase = 0, apid = 0; /* Silence gcc by initializing */
 	int romtable_present = 0;
 	uint8_t mem_ap;
 	uint32_t ap_old;

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm_adi_v5.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Mon Oct 24 19:41:26 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Mon, 24 Oct 2011 17:41:26 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-152-gea10093
Message-ID: <mailman.229.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  ea10093422df328bbb33c78d21dc4646a193f8bf (commit)
      from  e5fd6131fe781631797631ba8ba48cf361ff7635 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit ea10093422df328bbb33c78d21dc4646a193f8bf
Author: Freddie Chopin <freddie.chopin at gmail.com>
Date:   Sat Oct 22 09:53:55 2011 +0200

    Fix "Evaluate 'script' in the global scope"
    
    This fixes commit Evaluate 'script' in the global scope. It caused
    Windows builds behave differently than before because path was evaluated twice
    and backslashes from Windows' paths got unescaped and effectively wiped out.
    Configs could only be passed with "-f ../dir/config.cfg" or "-f
    ..\\dir\\config.cfg" instead of usual "-f dir/config.cfg" (or using backslash)
    as previously.
    
    Change-Id: I13b4abac6dbe6d770cc11a4e61c9421ef340da83
    Author: Steve Bennett <steveb at workware.net.au>
    Signed-off-by: Freddie Chopin <freddie.chopin at gmail.com>
    Reviewed-on: http://openocd.zylin.com/40
    Tested-by: jenkins
    Reviewed-by: Xiaofan <xiaofanc at gmail.com>
    Reviewed-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/src/helper/startup.tcl b/src/helper/startup.tcl
index e2ea27d..a7c0d58 100644
--- a/src/helper/startup.tcl
+++ b/src/helper/startup.tcl
@@ -55,7 +55,7 @@ add_help_text find "print full path to file according to OpenOCD search rules"
 
 # Find and run a script
 proc script {filename} {
-	uplevel #0 source [find $filename]
+	uplevel #0 [list source [find $filename]]
 }
 add_help_text script "filename of OpenOCD script (tcl) to run"
 add_usage_text script "<file>"

-----------------------------------------------------------------------

Summary of changes:
 src/helper/startup.tcl |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Tue Oct 25 07:14:44 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Tue, 25 Oct 2011 05:14:44 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-153-g8c6b95e
Message-ID: <mailman.230.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  8c6b95ed162ada54b1165ca0c9b46aa92f92975c (commit)
      from  ea10093422df328bbb33c78d21dc4646a193f8bf (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 8c6b95ed162ada54b1165ca0c9b46aa92f92975c
Author: Andreas Fritiofson <andreas.fritiofson at gmail.com>
Date:   Tue Oct 25 00:03:42 2011 +0200

    armv7m: improve error handling
    
    Propagate errors unchanged.
    Free allocated working area in the error return path.
    Remove duplicated cleanup code by rewriting the logic.
    As a side-effect, fixes a scan-build warning.
    
    Change-Id: I80e3c0015be672778f916e998c8c2e4f23d7588c
    Signed-off-by: Andreas Fritiofson <andreas.fritiofson at gmail.com>
    Reviewed-on: http://openocd.zylin.com/117
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/target/armv7m.c b/src/target/armv7m.c
index 39a89b9..d9e63d7 100644
--- a/src/target/armv7m.c
+++ b/src/target/armv7m.c
@@ -626,17 +626,16 @@ int armv7m_checksum_memory(struct target *target,
 
 	uint32_t i;
 
-	if (target_alloc_working_area(target, sizeof(cortex_m3_crc_code), &crc_algorithm) != ERROR_OK)
-	{
-		return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
-	}
+	retval = target_alloc_working_area(target, sizeof(cortex_m3_crc_code), &crc_algorithm);
+	if (retval != ERROR_OK)
+		return retval;
 
 	/* convert flash writing code into a buffer in target endianness */
-	for (i = 0; i < ARRAY_SIZE(cortex_m3_crc_code); i++)
-		if ((retval = target_write_u16(target, crc_algorithm->address + i*sizeof(uint16_t), cortex_m3_crc_code[i])) != ERROR_OK)
-		{
-			return retval;
-		}
+	for (i = 0; i < ARRAY_SIZE(cortex_m3_crc_code); i++) {
+		retval = target_write_u16(target, crc_algorithm->address + i*sizeof(uint16_t), cortex_m3_crc_code[i]);
+		if (retval != ERROR_OK)
+			goto cleanup;
+	}
 
 	armv7m_info.common_magic = ARMV7M_COMMON_MAGIC;
 	armv7m_info.core_mode = ARMV7M_MODE_ANY;
@@ -649,24 +648,22 @@ int armv7m_checksum_memory(struct target *target,
 
 	int timeout = 20000 * (1 + (count / (1024 * 1024)));
 
-	if ((retval = target_run_algorithm(target, 0, NULL, 2, reg_params,
-		crc_algorithm->address, crc_algorithm->address + (sizeof(cortex_m3_crc_code)-6), timeout, &armv7m_info)) != ERROR_OK)
-	{
-		LOG_ERROR("error executing cortex_m3 crc algorithm");
-		destroy_reg_param(&reg_params[0]);
-		destroy_reg_param(&reg_params[1]);
-		target_free_working_area(target, crc_algorithm);
-		return retval;
-	}
+	retval = target_run_algorithm(target, 0, NULL, 2, reg_params, crc_algorithm->address,
+	                              crc_algorithm->address + (sizeof(cortex_m3_crc_code) - 6),
+	                              timeout, &armv7m_info);
 
-	*checksum = buf_get_u32(reg_params[0].value, 0, 32);
+	if (retval == ERROR_OK)
+		*checksum = buf_get_u32(reg_params[0].value, 0, 32);
+	else
+		LOG_ERROR("error executing cortex_m3 crc algorithm");
 
 	destroy_reg_param(&reg_params[0]);
 	destroy_reg_param(&reg_params[1]);
 
+cleanup:
 	target_free_working_area(target, crc_algorithm);
 
-	return ERROR_OK;
+	return retval;
 }
 
 /** Checks whether a memory region is zeroed. */
@@ -711,17 +708,12 @@ int armv7m_blank_check_memory(struct target *target,
 	init_reg_param(&reg_params[2], "r2", 32, PARAM_IN_OUT);
 	buf_set_u32(reg_params[2].value, 0, 32, 0xff);
 
-	if ((retval = target_run_algorithm(target, 0, NULL, 3, reg_params,
-			erase_check_algorithm->address, erase_check_algorithm->address + (sizeof(erase_check_code)-2), 10000, &armv7m_info)) != ERROR_OK)
-	{
-		destroy_reg_param(&reg_params[0]);
-		destroy_reg_param(&reg_params[1]);
-		destroy_reg_param(&reg_params[2]);
-		target_free_working_area(target, erase_check_algorithm);
-		return 0;
-	}
+	retval = target_run_algorithm(target, 0, NULL, 3, reg_params, erase_check_algorithm->address,
+	                              erase_check_algorithm->address + (sizeof(erase_check_code) - 2),
+	                              10000, &armv7m_info);
 
-	*blank = buf_get_u32(reg_params[2].value, 0, 32);
+	if (retval == ERROR_OK)
+		*blank = buf_get_u32(reg_params[2].value, 0, 32);
 
 	destroy_reg_param(&reg_params[0]);
 	destroy_reg_param(&reg_params[1]);
@@ -729,7 +721,7 @@ int armv7m_blank_check_memory(struct target *target,
 
 	target_free_working_area(target, erase_check_algorithm);
 
-	return ERROR_OK;
+	return retval;
 }
 
 int armv7m_maybe_skip_bkpt_inst(struct target *target, bool *inst_found)

-----------------------------------------------------------------------

Summary of changes:
 src/target/armv7m.c |   54 +++++++++++++++++++++-----------------------------
 1 files changed, 23 insertions(+), 31 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Tue Oct 25 07:16:33 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Tue, 25 Oct 2011 05:16:33 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-154-gf80ec2a
Message-ID: <mailman.231.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  f80ec2aa3723c59528198b275a348b6b8804929a (commit)
      from  8c6b95ed162ada54b1165ca0c9b46aa92f92975c (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit f80ec2aa3723c59528198b275a348b6b8804929a
Author: Andreas Fritiofson <andreas.fritiofson at gmail.com>
Date:   Tue Oct 25 00:36:24 2011 +0200

    armv7a: make local functions static
    
    Also fix a spelling error and remove the declaration for a non-existent
    function from the header.
    
    Change-Id: I13177e2d81aa167c05c1cc766f06924211e6d735
    Signed-off-by: Andreas Fritiofson <andreas.fritiofson at gmail.com>
    Reviewed-on: http://openocd.zylin.com/118
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/target/armv7a.c b/src/target/armv7a.c
index 0bac27f..d74b99b 100644
--- a/src/target/armv7a.c
+++ b/src/target/armv7a.c
@@ -87,7 +87,7 @@ done:
 	/* (void) */ dpm->finish(dpm);
 }
 
-int armv7a_read_ttbcr(struct target *target)
+static int armv7a_read_ttbcr(struct target *target)
 {
 	struct armv7a_common *armv7a = target_to_armv7a(target);
 	struct arm_dpm *dpm = armv7a->armv4_5_common.dpm;
@@ -454,7 +454,7 @@ static int armv7a_handle_l2x_cache_info_command(struct command_context *cmd_ctx,
 }
 
 
-int armv7a_l2x_cache_init(struct target *target, uint32_t base, uint32_t way)
+static int armv7a_l2x_cache_init(struct target *target, uint32_t base, uint32_t way)
 {
 	struct armv7a_l2x_cache *l2x_cache;
 	struct target_list *head = target->head;
@@ -542,7 +542,7 @@ int armv7a_handle_cache_info_command(struct command_context *cmd_ctx,
 
 
 /*  retrieve core id cluster id  */
-int arnv7a_read_mpidr(struct target *target)
+static int armv7a_read_mpidr(struct target *target)
 {
     int retval = ERROR_FAIL;
 	struct armv7a_common *armv7a = target_to_armv7a(target);
@@ -711,7 +711,7 @@ int armv7a_identify_cache(struct target *target)
 
 done:
 	dpm->finish(dpm);
-	 arnv7a_read_mpidr(target);
+	armv7a_read_mpidr(target);
 	return retval;
 
 }
diff --git a/src/target/armv7a.h b/src/target/armv7a.h
index dde1f23..6f54ce6 100644
--- a/src/target/armv7a.h
+++ b/src/target/armv7a.h
@@ -167,8 +167,6 @@ target_to_armv7a(struct target *target)
 
 int armv7a_arch_state(struct target *target);
 int armv7a_identify_cache(struct target *target);
-struct reg_cache *armv7a_build_reg_cache(struct target *target,
-		struct armv7a_common *armv7a_common);
 int armv7a_init_arch_info(struct target *target, struct armv7a_common *armv7a);
 int armv7a_mmu_translate_va_pa(struct target *target, uint32_t va,
 		uint32_t *val,int meminfo);

-----------------------------------------------------------------------

Summary of changes:
 src/target/armv7a.c |    8 ++++----
 src/target/armv7a.h |    2 --
 2 files changed, 4 insertions(+), 6 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Tue Oct 25 07:17:18 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Tue, 25 Oct 2011 05:17:18 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-155-g8f76ca0
Message-ID: <mailman.232.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  8f76ca05d998ad8bcebb3d634a09386ea8c54e5e (commit)
      from  f80ec2aa3723c59528198b275a348b6b8804929a (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 8f76ca05d998ad8bcebb3d634a09386ea8c54e5e
Author: Andreas Fritiofson <andreas.fritiofson at gmail.com>
Date:   Tue Oct 25 00:47:21 2011 +0200

    armv7a: fix scan-build warnings
    
    "Value stored to 'retval' is never read": Check and propagate error
    "Dereference of null pointer": Probably bogus, maybe triggered by the null
    check on armv7a, so remove the check since it can't be null anyway.
    
    Change-Id: I3bc44e52af1589ff40e6a42deda0ce7f3a25e397
    Signed-off-by: Andreas Fritiofson <andreas.fritiofson at gmail.com>
    Reviewed-on: http://openocd.zylin.com/119
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/target/armv7a.c b/src/target/armv7a.c
index d74b99b..67c563e 100644
--- a/src/target/armv7a.c
+++ b/src/target/armv7a.c
@@ -147,6 +147,8 @@ int armv7a_mmu_translate_va(struct target *target,  uint32_t va, uint32_t *val)
 	retval = dpm->instr_read_data_r0(dpm,
 			ARMV4_5_MRC(15, 0, 0, 2, 0, ttb),
 			&ttb);
+	if (retval != ERROR_OK)
+		return retval;
 	retval = armv7a->armv7a_mmu.read_physical_memory(target,
 			(ttb & 0xffffc000) | ((va & 0xfff00000) >> 18),
 			4, 1, (uint8_t*)&first_lvl_descriptor);
@@ -461,8 +463,6 @@ static int armv7a_l2x_cache_init(struct target *target, uint32_t base, uint32_t
 	struct target *curr;
 
 	struct armv7a_common *armv7a = target_to_armv7a(target);
-	if (armv7a == NULL)
-		LOG_ERROR("not an armv7a target");
 	l2x_cache = calloc(1, sizeof(struct armv7a_l2x_cache));
 	l2x_cache->base = base;
 	l2x_cache->way = way;
@@ -616,6 +616,7 @@ int armv7a_identify_cache(struct target *target)
 			2, 0,	/* op1, op2 */
 			0, 0,	/* CRn, CRm */
 			&cache_selected);
+	if (retval!=ERROR_OK) goto done;
 	/* select instruction cache*/
 	/*  MCR p15, 2,<Rd>, c0, c0, 0; Write CSSELR */
 	/*  [0]  : 1 instruction cache selection , 0 data cache selection */

-----------------------------------------------------------------------

Summary of changes:
 src/target/armv7a.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Tue Oct 25 22:09:26 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Tue, 25 Oct 2011 20:09:26 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-156-g5cca45d
Message-ID: <mailman.233.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  5cca45d5f9d3a6adeb81296c9b9d943b18a2ce8c (commit)
      from  8f76ca05d998ad8bcebb3d634a09386ea8c54e5e (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 5cca45d5f9d3a6adeb81296c9b9d943b18a2ce8c
Author: Marti Bolivar <mbolivar at leaflabs.com>
Date:   Tue Oct 25 15:52:10 2011 -0400

    stm3220g_eval.cfg: fix CHIPNAME.
    
    The STM3220G-EVAL board has an STM32F207IGH6. ("...H6", not "...T6").
    
    Change-Id: Iaf3dae6830c5c0685a1dcd1588d391434bc51be7
    Signed-off-by: Marti Bolivar <mbolivar at leaflabs.com>
    Reviewed-on: http://openocd.zylin.com/120
    Tested-by: jenkins
    Reviewed-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/tcl/board/stm3220g_eval.cfg b/tcl/board/stm3220g_eval.cfg
index 48b57c1..4728432 100644
--- a/tcl/board/stm3220g_eval.cfg
+++ b/tcl/board/stm3220g_eval.cfg
@@ -1,4 +1,4 @@
-# STM3220G-EVAL: This is an STM32F2 eval board with a single STM32F207IGT6
+# STM3220G-EVAL: This is an STM32F2 eval board with a single STM32F207IGH6
 # (128KB) chip.
 # http://www.st.com/internet/evalboard/product/250374.jsp
 
@@ -6,6 +6,6 @@
 set WORKAREASIZE 0x20000
 
 # chip name
-set CHIPNAME STM32F207IGT6
+set CHIPNAME STM32F207IGH6
 
 source [find target/stm32f2x.cfg]

-----------------------------------------------------------------------

Summary of changes:
 tcl/board/stm3220g_eval.cfg |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Wed Oct 26 22:31:34 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Wed, 26 Oct 2011 20:31:34 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-157-gbe17f6b
Message-ID: <mailman.234.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  be17f6b08ec89fafdecb1520619ae25191bd7077 (commit)
      from  5cca45d5f9d3a6adeb81296c9b9d943b18a2ce8c (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit be17f6b08ec89fafdecb1520619ae25191bd7077
Author: Jim Norris <u17263 at att.net>
Date:   Tue Oct 25 20:48:35 2011 -0500

    Add configuration for ATMEL SAM3N series.
    
    Change-Id: Iac498ab37e59127b989f29a1c4167ab29d625b05
    Signed-off-by: Jim Norris <u17263 at att.net>
    Reviewed-on: http://openocd.zylin.com/124
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/tcl/target/at91sam3nXX.cfg b/tcl/target/at91sam3nXX.cfg
new file mode 100644
index 0000000..29c5ddc
--- /dev/null
+++ b/tcl/target/at91sam3nXX.cfg
@@ -0,0 +1,24 @@
+
+#
+# Configuration for Atmel's SAM3N series
+#
+
+if { [info exists CHIPNAME] } {
+	set _CHIPNAME $CHIPNAME
+} else {
+	set _CHIPNAME at91sam3n
+}
+
+if { [info exists CPUTAPID ] } {
+	set _CPUTAPID $CPUTAPID
+} else {
+	set _CPUTAPID 0x4ba00477
+}
+
+jtag newtap $_CHIPNAME cpu -irlen 4 -ircapture 0x1 -irmask 0xf -expected-id $_CPUTAPID
+
+set _TARGETNAME $_CHIPNAME.cpu
+target create $_TARGETNAME cortex_m3 -endian $_ENDIAN -chain-position $_TARGETNAME
+
+set _FLASHNAME $_CHIPNAME.flash
+flash bank flash0 at91sam3 0x00400000 0 0 0 $_TARGETNAME

-----------------------------------------------------------------------

Summary of changes:
 tcl/target/at91sam3nXX.cfg |   24 ++++++++++++++++++++++++
 1 files changed, 24 insertions(+), 0 deletions(-)
 create mode 100644 tcl/target/at91sam3nXX.cfg


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Wed Oct 26 22:32:15 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Wed, 26 Oct 2011 20:32:15 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-158-g2036c2a
Message-ID: <mailman.235.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  2036c2aaae390996f55a8c0cdd8769fbc8933c5a (commit)
      from  be17f6b08ec89fafdecb1520619ae25191bd7077 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 2036c2aaae390996f55a8c0cdd8769fbc8933c5a
Author: Jim Norris <u17263 at att.net>
Date:   Tue Oct 25 20:49:12 2011 -0500

    Add configuration for ATMEL SAM3N-EK board.
    
    Change-Id: I525f6c346cace4e54f47659c5a7aceb29ee4baf2
    Signed-off-by: Jim Norris <u17263 at att.net>
    Reviewed-on: http://openocd.zylin.com/125
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/tcl/board/atmel_sam3n_ek.cfg b/tcl/board/atmel_sam3n_ek.cfg
new file mode 100644
index 0000000..2ae73eb
--- /dev/null
+++ b/tcl/board/atmel_sam3n_ek.cfg
@@ -0,0 +1,12 @@
+
+#
+# Board configuration for Atmel's SAM3N-EK
+#
+
+reset_config srst_only
+
+set CHIPNAME at91sam3n4c
+
+adapter_khz 32
+
+source [find target/at91sam3nXX.cfg]

-----------------------------------------------------------------------

Summary of changes:
 tcl/board/atmel_sam3n_ek.cfg |   12 ++++++++++++
 1 files changed, 12 insertions(+), 0 deletions(-)
 create mode 100644 tcl/board/atmel_sam3n_ek.cfg


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Wed Oct 26 22:36:33 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Wed, 26 Oct 2011 20:36:33 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-159-ge6d979e
Message-ID: <mailman.236.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  e6d979eefcc99aeb3f95fab67598af461ef234c1 (commit)
      from  2036c2aaae390996f55a8c0cdd8769fbc8933c5a (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit e6d979eefcc99aeb3f95fab67598af461ef234c1
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Wed Oct 26 22:26:44 2011 +0200

    clang: fix warning about use of unitialized variable
    
    this was a false positive, silence it.
    
    Change-Id: I432e0c466c94cf8fd6bbf0ea153c8501a8a261eb
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/126
    Tested-by: jenkins
    Reviewed-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/src/target/arm_simulator.c b/src/target/arm_simulator.c
index 0a34cfc..1723b43 100644
--- a/src/target/arm_simulator.c
+++ b/src/target/arm_simulator.c
@@ -519,7 +519,7 @@ static int arm_simulate_step_core(struct target *target,
 	/* load register instructions */
 	else if ((instruction.type >= ARM_LDR) && (instruction.type <= ARM_LDRSH))
 	{
-		uint32_t load_address = 0, modified_address = 0, load_value;
+		uint32_t load_address = 0, modified_address = 0, load_value = 0;
 		uint32_t Rn = sim->get_reg_mode(sim, instruction.info.load_store.Rn);
 
 		/* adjust Rn in case the PC is being read */

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm_simulator.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Thu Oct 27 02:47:57 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Thu, 27 Oct 2011 00:47:57 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-160-gd265fa7
Message-ID: <mailman.237.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  d265fa78c348b7148e417f5fd041d694c7ee51aa (commit)
      from  e6d979eefcc99aeb3f95fab67598af461ef234c1 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit d265fa78c348b7148e417f5fd041d694c7ee51aa
Author: Jim Norris <u17263 at att.net>
Date:   Wed Oct 26 19:30:20 2011 -0500

    Remove use of undefined variable.
    
    Change-Id: Id8fd345438c360b2a42857525f05360ce2794d21
    Signed-off-by: Jim Norris <u17263 at att.net>
    Reviewed-on: http://openocd.zylin.com/127
    Reviewed-by: Peter Stuge <peter at stuge.se>
    Tested-by: jenkins

diff --git a/tcl/target/at91sam3nXX.cfg b/tcl/target/at91sam3nXX.cfg
index 29c5ddc..5392824 100644
--- a/tcl/target/at91sam3nXX.cfg
+++ b/tcl/target/at91sam3nXX.cfg
@@ -18,7 +18,7 @@ if { [info exists CPUTAPID ] } {
 jtag newtap $_CHIPNAME cpu -irlen 4 -ircapture 0x1 -irmask 0xf -expected-id $_CPUTAPID
 
 set _TARGETNAME $_CHIPNAME.cpu
-target create $_TARGETNAME cortex_m3 -endian $_ENDIAN -chain-position $_TARGETNAME
+target create $_TARGETNAME cortex_m3 -endian little -chain-position $_TARGETNAME
 
 set _FLASHNAME $_CHIPNAME.flash
 flash bank flash0 at91sam3 0x00400000 0 0 0 $_TARGETNAME

-----------------------------------------------------------------------

Summary of changes:
 tcl/target/at91sam3nXX.cfg |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Thu Oct 27 19:39:20 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Thu, 27 Oct 2011 17:39:20 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-161-g7e81783
Message-ID: <mailman.238.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  7e817839f3f99601ff4c8c2f6eeb7983037e3c68 (commit)
      from  d265fa78c348b7148e417f5fd041d694c7ee51aa (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 7e817839f3f99601ff4c8c2f6eeb7983037e3c68
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Thu Oct 27 19:27:04 2011 +0200

    clang: fix warning about missing check for return value
    
    Change-Id: I0c6b6b8d1f0c30b6a503cb98df30584252bc0ee1
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/129
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/rtos/FreeRTOS.c b/src/rtos/FreeRTOS.c
index 10a9b8c..eeab134 100644
--- a/src/rtos/FreeRTOS.c
+++ b/src/rtos/FreeRTOS.c
@@ -231,7 +231,8 @@ static int FreeRTOS_update_threads( struct rtos *rtos )
 	// Find out how many lists are needed to be read from pxReadyTasksLists,
 	int64_t max_used_priority = 0;
 	retval = target_read_buffer( rtos->target, rtos->symbols[FreeRTOS_VAL_uxTopUsedPriority].address, param->pointer_width, (uint8_t *)&max_used_priority );
-
+	if (retval != ERROR_OK)
+	  return retval;
 
 	symbol_address_t* list_of_lists = (symbol_address_t *)malloc( sizeof( symbol_address_t ) * ( max_used_priority+1 + 5 ) );
 

-----------------------------------------------------------------------

Summary of changes:
 src/rtos/FreeRTOS.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Fri Oct 28 00:09:04 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Thu, 27 Oct 2011 22:09:04 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-162-g9780683
Message-ID: <mailman.239.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  97806831e25e8b75c02d61a30a98b18e090619f2 (commit)
      from  7e817839f3f99601ff4c8c2f6eeb7983037e3c68 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 97806831e25e8b75c02d61a30a98b18e090619f2
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Thu Oct 27 23:51:50 2011 +0200

    bugfixes: numerous bugs in error propagation found by clang
    
    Change-Id: I784068325b422d1918e28c08544bc5a1332d712f
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/130
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/target/target.c b/src/target/target.c
index d4cb577..bd15620 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -1863,11 +1863,9 @@ int target_write_u8(struct target *target, uint32_t address, uint8_t value)
 
 COMMAND_HANDLER(handle_targets_command)
 {
-	struct target *target = all_targets;
-
 	if (CMD_ARGC == 1)
 	{
-		target = get_target(CMD_ARGV[0]);
+		struct target *target = get_target(CMD_ARGV[0]);
 		if (target == NULL) {
 			command_print(CMD_CTX,"Target: %s is unknown, try one of:\n", CMD_ARGV[0]);
 			goto DumpTargets;
@@ -1882,9 +1880,9 @@ COMMAND_HANDLER(handle_targets_command)
 		CMD_CTX->current_target = target->target_number;
 		return ERROR_OK;
 	}
-DumpTargets:
+DumpTargets:;
 
-	target = all_targets;
+	struct target *target = all_targets;
 	command_print(CMD_CTX, "    TargetName         Type       Endian TapName            State       ");
 	command_print(CMD_CTX, "--  ------------------ ---------- ------ ------------------ ------------");
 	while (target)
@@ -2190,6 +2188,8 @@ COMMAND_HANDLER(handle_reg_command)
 		}
 	}
 
+	assert(reg != NULL); /* give clang a hint that we *know* reg is != NULL here */
+
 	/* display a register */
 	if ((CMD_ARGC == 1) || ((CMD_ARGC == 2) && !((CMD_ARGV[1][0] >= '0') && (CMD_ARGV[1][0] <= '9'))))
 	{
@@ -2210,6 +2210,8 @@ COMMAND_HANDLER(handle_reg_command)
 	if (CMD_ARGC == 2)
 	{
 		uint8_t *buf = malloc(DIV_ROUND_UP(reg->size, 8));
+		if (buf == NULL)
+			return ERROR_FAIL;
 		str_to_buf(CMD_ARGV[1], strlen(CMD_ARGV[1]), buf, reg->size, 0);
 
 		reg->type->set(reg, buf);
@@ -3414,9 +3416,9 @@ COMMAND_HANDLER(handle_profile_command)
 	/* hopefully it is safe to cache! We want to stop/restart as quickly as possible. */
 	struct reg *reg = register_get_by_name(target->reg_cache, "pc", 1);
 
+	int retval = ERROR_OK;
 	for (;;)
 	{
-		int retval;
 		target_poll(target);
 		if (target->state == TARGET_HALTED)
 		{
@@ -3469,7 +3471,7 @@ COMMAND_HANDLER(handle_profile_command)
 	}
 	free(samples);
 
-	return ERROR_OK;
+	return retval;
 }
 
 static int new_int_array_element(Jim_Interp * interp, const char *varname, int idx, uint32_t val)
@@ -3634,7 +3636,7 @@ static int target_mem2array(Jim_Interp *interp, struct target *target, int argc,
 			Jim_SetResult(interp, Jim_NewEmptyStringObj(interp));
 			Jim_AppendStrings(interp, Jim_GetResult(interp), "mem2array: cannot read memory", NULL);
 			e = JIM_ERR;
-			len = 0;
+			break;
 		} else {
 			v = 0; /* shut up gcc */
 			for (i = 0 ;i < count ;i++, n++) {
@@ -3659,7 +3661,7 @@ static int target_mem2array(Jim_Interp *interp, struct target *target, int argc,
 
 	Jim_SetResult(interp, Jim_NewEmptyStringObj(interp));
 
-	return JIM_OK;
+	return e;
 }
 
 static int get_int_array_element(Jim_Interp * interp, const char *varname, int idx, uint32_t *val)
@@ -3844,7 +3846,7 @@ static int target_array2mem(Jim_Interp *interp, struct target *target,
 			Jim_SetResult(interp, Jim_NewEmptyStringObj(interp));
 			Jim_AppendStrings(interp, Jim_GetResult(interp), "array2mem: cannot read memory", NULL);
 			e = JIM_ERR;
-			len = 0;
+			break;
 		}
 	}
 
@@ -3852,7 +3854,7 @@ static int target_array2mem(Jim_Interp *interp, struct target *target,
 
 	Jim_SetResult(interp, Jim_NewEmptyStringObj(interp));
 
-	return JIM_OK;
+	return e;
 }
 
 /* FIX? should we propagate errors here rather than printing them
@@ -4164,6 +4166,8 @@ static int target_configure(Jim_GetOptInfo *goi, struct target *target)
 					free((void *)(target->variant));
 				}
 				e = Jim_GetOpt_String(goi, &cp, NULL);
+				if (e != JIM_OK)
+					return e;
 				target->variant = strdup(cp);
 			} else {
 				if (goi->argc != 0) {
@@ -4889,6 +4893,8 @@ static int target_create(Jim_GetOptInfo *goi)
 
 	/* TYPE */
 	e = Jim_GetOpt_String(goi, &cp2, NULL);
+	if (e != JIM_OK)
+		return e;
 	cp = cp2;
 	/* now does target type exist */
 	for (x = 0 ; target_types[x] ; x++) {
@@ -5098,11 +5104,10 @@ static int jim_target_smp(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 	const char *targetname;
 	int retval,len;
 	struct target *target;
-	struct target_list *head, *curr, *new;
+	struct target_list *head, *curr;
     curr = (struct target_list*) NULL;
 	head = (struct target_list*) NULL;
-	new = (struct target_list*) NULL;
-
+	
 	retval = 0;
 	LOG_DEBUG("%d",argc);
 	/* argv[1] = target to associate in smp
@@ -5118,6 +5123,7 @@ static int jim_target_smp(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 		LOG_DEBUG("%s ",targetname);
 		if (target)
 		{
+			struct target_list *new;
 			new=malloc(sizeof(struct target_list));
 			new->target = target;
 			new->next = (struct target_list*)NULL;

-----------------------------------------------------------------------

Summary of changes:
 src/target/target.c |   34 ++++++++++++++++++++--------------
 1 files changed, 20 insertions(+), 14 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Fri Oct 28 17:25:20 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Fri, 28 Oct 2011 15:25:20 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-163-gaf51c69
Message-ID: <mailman.240.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  af51c69fbcc15a0dee678553adf5a864f54f58cc (commit)
      from  97806831e25e8b75c02d61a30a98b18e090619f2 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit af51c69fbcc15a0dee678553adf5a864f54f58cc
Author: Jonathan Dumaresq <jdumaresq at cimeq.qc.ca>
Date:   Fri Oct 28 11:08:19 2011 -0400

    Fixes comment typo for page size
    
    Change-Id: I6dd8aadcecd680c48e696aeec0daf74d2addbb05
    Signed-off-by: Jonathan Dumaresq <jdumaresq at cimeq.qc.ca>
    Reviewed-on: http://openocd.zylin.com/132
    Tested-by: jenkins
    Reviewed-by: Peter Stuge <peter at stuge.se>

diff --git a/src/flash/nor/stm32f1x.c b/src/flash/nor/stm32f1x.c
index a0520c7..6c419e9 100644
--- a/src/flash/nor/stm32f1x.c
+++ b/src/flash/nor/stm32f1x.c
@@ -1055,7 +1055,7 @@ static int stm32x_probe(struct flash_bank *bank)
 	}
 	else if ((device_id & 0x7ff) == 0x428)
 	{
-		/* value line density - we have 1k pages
+		/* value line High density - we have 2k pages
 		 * 4 pages for a protection area */
 		page_size = 2048;
 		stm32x_info->ppage_size = 4;

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/stm32f1x.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sat Oct 29 15:14:17 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sat, 29 Oct 2011 13:14:17 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-164-gfe2fd81
Message-ID: <mailman.241.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  fe2fd812fa6c20051781f842b9d8489cdb6b46cd (commit)
      from  af51c69fbcc15a0dee678553adf5a864f54f58cc (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit fe2fd812fa6c20051781f842b9d8489cdb6b46cd
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sat Oct 29 10:55:02 2011 +0200

    clang: fix warning by adding assert that shows that a variable is used
    
    Change-Id: I26e0ba9f1ae9d43c9a14c42c4225746782dc4d66
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/134
    Tested-by: jenkins
    Reviewed-by: ??yvind Harboe <oyvindharboe at gmail.com>

diff --git a/src/jtag/tcl.c b/src/jtag/tcl.c
index 468edf5..b634ac0 100644
--- a/src/jtag/tcl.c
+++ b/src/jtag/tcl.c
@@ -166,6 +166,8 @@ static int Jim_Command_drscan(Jim_Interp *interp, int argc, Jim_Obj *const *args
 		}
 	} /* validate args */
 
+	assert(e == JIM_OK);
+
 	tap = jtag_tap_by_jim_obj(interp, args[1]);
 	if (tap == NULL) {
 		return JIM_ERR;

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/tcl.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 30 02:58:24 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 30 Oct 2011 01:58:24 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-165-gabfd4b1
Message-ID: <mailman.242.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  abfd4b19a6b1c1e257aed343af5ab71709f41bcb (commit)
      from  fe2fd812fa6c20051781f842b9d8489cdb6b46cd (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit abfd4b19a6b1c1e257aed343af5ab71709f41bcb
Author: Uwe Hermann <uwe at hermann-uwe.de>
Date:   Sat Oct 29 22:58:12 2011 +0200

    config files: Drop incorrect comments.
    
    There are many "force an error till we get a good number" comments in
    target/board files. This refers to the use-case where a config script
    sets _CPUTAPID to 0xffffffff (which presumely gets overridden later):
    
     if { [info exists CPUTAPID ] } {
        set _CPUTAPID $CPUTAPID
     } else {
        # Force an error until we get a good number.
        set _CPUTAPID 0xffffffff
     }
    
    However, the same comment was also copy-pasted in many files which do
    _not_ set _CPUTAPID to 0xffffffff, where the comment doesn't make any
    sense at all. Drop those comments. Also, add one missing comment, and
    fix small whitespace and grammar issues.
    
    Change-Id: Ic4ba3b5ccba87ed40cea0d6a7d66609fbdfa3c71
    Signed-off-by: Uwe Hermann <uwe at hermann-uwe.de>
    Reviewed-on: http://openocd.zylin.com/136
    Tested-by: jenkins
    Reviewed-by: Peter Stuge <peter at stuge.se>

diff --git a/tcl/board/at91eb40a.cfg b/tcl/board/at91eb40a.cfg
index dc5aacb..b43dee3 100644
--- a/tcl/board/at91eb40a.cfg
+++ b/tcl/board/at91eb40a.cfg
@@ -19,7 +19,6 @@ if { [info exists ENDIAN] } {
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
 } else {
-  # force an error till we get a good number
    set _CPUTAPID 0x1f0f0f0f
 }
 
diff --git a/tcl/board/mini2440.cfg b/tcl/board/mini2440.cfg
index c5adac3..a034538 100644
--- a/tcl/board/mini2440.cfg
+++ b/tcl/board/mini2440.cfg
@@ -100,7 +100,6 @@ if { [info exists ENDIAN] } {
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
 } else {
-  # force an error till we get a good number
    set _CPUTAPID 0x0032409d
 }
 
diff --git a/tcl/target/at91sam7se512.cfg b/tcl/target/at91sam7se512.cfg
index c48afef..7273a06 100644
--- a/tcl/target/at91sam7se512.cfg
+++ b/tcl/target/at91sam7se512.cfg
@@ -18,7 +18,7 @@ if { [info exists ENDIAN] } {
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
 } else {
-  # force an error till we get a good number
+   # Force an error until we get a good number.
    set _CPUTAPID 0xffffffff
 }
 
diff --git a/tcl/target/at91sam9.cfg b/tcl/target/at91sam9.cfg
index ba0197d..08154ce 100644
--- a/tcl/target/at91sam9.cfg
+++ b/tcl/target/at91sam9.cfg
@@ -17,13 +17,11 @@ if { [info exists ENDIAN] } {
 if { [info exists CPUTAPID ] } {
 	set _CPUTAPID $CPUTAPID
 } else {
-	# force an error till we get a good number
 	set _CPUTAPID 0x0792603f
 }
 
 reset_config trst_and_srst separate trst_push_pull srst_open_drain
 
-#
 jtag newtap $_CHIPNAME cpu -irlen 4 -ircapture 0x1 -irmask 0xf -expected-id $_CPUTAPID
 
 adapter_nsrst_delay 300
diff --git a/tcl/target/avr32.cfg b/tcl/target/avr32.cfg
index 7fe98b2..1a2ea33 100644
--- a/tcl/target/avr32.cfg
+++ b/tcl/target/avr32.cfg
@@ -1,7 +1,6 @@
 set  _CHIPNAME avr32
 set  _ENDIAN big
 
-# force an error till we get a good number
 set _CPUTAPID  0x21e8203f
 
 jtag_nsrst_delay 100
diff --git a/tcl/target/dsp56321.cfg b/tcl/target/dsp56321.cfg
index 281c4dd..74279d9 100644
--- a/tcl/target/dsp56321.cfg
+++ b/tcl/target/dsp56321.cfg
@@ -17,7 +17,6 @@ if { [info exists ENDIAN] } {
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
 } else {
-  # force an error till we get a good number
    set _CPUTAPID 0x1181501d
 }
 
diff --git a/tcl/target/dsp568013.cfg b/tcl/target/dsp568013.cfg
index 80adc76..2b25ed7 100644
--- a/tcl/target/dsp568013.cfg
+++ b/tcl/target/dsp568013.cfg
@@ -16,7 +16,6 @@ if { [info exists ENDIAN] } {
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
 } else {
-  # force an error till we get a good number
    set _CPUTAPID 0x01f2401d
 }
 
diff --git a/tcl/target/dsp568037.cfg b/tcl/target/dsp568037.cfg
index 6089e9d..21eb0b7 100644
--- a/tcl/target/dsp568037.cfg
+++ b/tcl/target/dsp568037.cfg
@@ -16,7 +16,6 @@ if { [info exists ENDIAN] } {
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
 } else {
-  # force an error till we get a good number
    set _CPUTAPID 0x01f2801d
 }
 
diff --git a/tcl/target/epc9301.cfg b/tcl/target/epc9301.cfg
index d2dc7ec..6b67b9d 100644
--- a/tcl/target/epc9301.cfg
+++ b/tcl/target/epc9301.cfg
@@ -15,7 +15,7 @@ if { [info exists ENDIAN] } {
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
 } else {
-  # force an error till we get a good number
+   # Force an error until we get a good number.
    set _CPUTAPID 0xffffffff
 }
 
diff --git a/tcl/target/is5114.cfg b/tcl/target/is5114.cfg
index 64c0c8e..56b9b65 100644
--- a/tcl/target/is5114.cfg
+++ b/tcl/target/is5114.cfg
@@ -18,7 +18,7 @@ if { [info exists ENDIAN] } {
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
 } else {
-  # force an error till we get a good number
+   # Force an error until we get a good number.
    set _CPUTAPID 0xffffffff
 }
 
diff --git a/tcl/target/pic32mx.cfg b/tcl/target/pic32mx.cfg
index efffd04..0b3522e 100644
--- a/tcl/target/pic32mx.cfg
+++ b/tcl/target/pic32mx.cfg
@@ -14,7 +14,6 @@ if { [info exists ENDIAN] } {
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
 } else {
-   # force an error till we get a good number
    set _CPUTAPID 0x30938053
 }
 
diff --git a/tcl/target/samsung_s3c2410.cfg b/tcl/target/samsung_s3c2410.cfg
index 9682c4c..73d3b50 100644
--- a/tcl/target/samsung_s3c2410.cfg
+++ b/tcl/target/samsung_s3c2410.cfg
@@ -16,6 +16,7 @@ if { [info exists ENDIAN] } {
 if { [info exists CPUTAPID] } {
    set  _CPUTAPID $CPUTAPID
 } else {
+   # Force an error until we get a good number.
    set  _CPUTAPID 0xffffffff
 }
 
diff --git a/tcl/target/samsung_s3c2440.cfg b/tcl/target/samsung_s3c2440.cfg
index d3b665f..9cd27d1 100644
--- a/tcl/target/samsung_s3c2440.cfg
+++ b/tcl/target/samsung_s3c2440.cfg
@@ -19,7 +19,6 @@ if { [info exists ENDIAN] } {
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
 } else {
-  # force an error till we get a good number
    set _CPUTAPID 0x0032409d
 }
 
diff --git a/tcl/target/samsung_s3c2450.cfg b/tcl/target/samsung_s3c2450.cfg
index 0075426..164fe16 100644
--- a/tcl/target/samsung_s3c2450.cfg
+++ b/tcl/target/samsung_s3c2450.cfg
@@ -29,7 +29,6 @@ if { [info exists ENDIAN] } {
 if { [info exists CPUTAPID ] } {
   set _CPUTAPID $CPUTAPID
 } else {
- # force an error till we get a good number
   set _CPUTAPID 0x07926f0f
 }
 
diff --git a/tcl/target/samsung_s3c6410.cfg b/tcl/target/samsung_s3c6410.cfg
index f9738c2..eb95242 100644
--- a/tcl/target/samsung_s3c6410.cfg
+++ b/tcl/target/samsung_s3c6410.cfg
@@ -23,14 +23,12 @@ if { [info exists ENDIAN] } {
 if { [info exists ETBTAPID ] } {
    set _ETBTAPID $ETBTAPID
 } else {
-  # force an error till we get a good number
    set _ETBTAPID 0x2b900f0f
 }
 
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
 } else {
-  # force an error till we get a good number
    set _CPUTAPID 0x07b76f0f
 }
 
diff --git a/tcl/target/smp8634.cfg b/tcl/target/smp8634.cfg
index 4f3959d..dc9bf0b 100644
--- a/tcl/target/smp8634.cfg
+++ b/tcl/target/smp8634.cfg
@@ -15,7 +15,6 @@ if { [info exists ENDIAN] } {
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
 } else {
-   # force an error till we get a good number
    set _CPUTAPID 0x08630001
 }
 
diff --git a/tcl/target/tmpa900.cfg b/tcl/target/tmpa900.cfg
index cfb445e..dd5d177 100644
--- a/tcl/target/tmpa900.cfg
+++ b/tcl/target/tmpa900.cfg
@@ -14,7 +14,6 @@ set _ENDIAN little
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
 } else {
-  # force an error till we get a good number
    set _CPUTAPID 0x07926031
 }
 
diff --git a/tcl/target/tmpa910.cfg b/tcl/target/tmpa910.cfg
index 4d4d3fc..271ca57 100644
--- a/tcl/target/tmpa910.cfg
+++ b/tcl/target/tmpa910.cfg
@@ -14,7 +14,6 @@ set _ENDIAN little
 if { [info exists CPUTAPID ] } {
    set _CPUTAPID $CPUTAPID
 } else {
-  # force an error till we get a good number
    set _CPUTAPID 0x07926031
 }
 

-----------------------------------------------------------------------

Summary of changes:
 tcl/board/at91eb40a.cfg        |    1 -
 tcl/board/mini2440.cfg         |    1 -
 tcl/target/at91sam7se512.cfg   |    2 +-
 tcl/target/at91sam9.cfg        |    2 --
 tcl/target/avr32.cfg           |    1 -
 tcl/target/dsp56321.cfg        |    1 -
 tcl/target/dsp568013.cfg       |    1 -
 tcl/target/dsp568037.cfg       |    1 -
 tcl/target/epc9301.cfg         |    2 +-
 tcl/target/is5114.cfg          |    2 +-
 tcl/target/pic32mx.cfg         |    1 -
 tcl/target/samsung_s3c2410.cfg |    1 +
 tcl/target/samsung_s3c2440.cfg |    1 -
 tcl/target/samsung_s3c2450.cfg |    1 -
 tcl/target/samsung_s3c6410.cfg |    2 --
 tcl/target/smp8634.cfg         |    1 -
 tcl/target/tmpa900.cfg         |    1 -
 tcl/target/tmpa910.cfg         |    1 -
 18 files changed, 4 insertions(+), 19 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Sun Oct 30 03:06:33 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Sun, 30 Oct 2011 02:06:33 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-166-gc0e1bfa
Message-ID: <mailman.243.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  c0e1bfa8b4c8096666494be8fd99f2862bdf67a2 (commit)
      from  abfd4b19a6b1c1e257aed343af5ab71709f41bcb (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit c0e1bfa8b4c8096666494be8fd99f2862bdf67a2
Author: Uwe Hermann <uwe at hermann-uwe.de>
Date:   Sun Oct 30 01:45:11 2011 +0200

    interface configs: Fix whitespace and other issues.
    
    Change-Id: I98825c7fb9bdee75b69b06005ed12a3f64ec4db4
    Signed-off-by: Uwe Hermann <uwe at hermann-uwe.de>
    Reviewed-on: http://openocd.zylin.com/139
    Tested-by: jenkins
    Reviewed-by: Peter Stuge <peter at stuge.se>

diff --git a/tcl/interface/flashlink.cfg b/tcl/interface/flashlink.cfg
index 22abe7b..56dc35e 100644
--- a/tcl/interface/flashlink.cfg
+++ b/tcl/interface/flashlink.cfg
@@ -6,9 +6,9 @@
 #
 
 if { [info exists PARPORTADDR] } {
-   set  _PARPORTADDR $PARPORTADDR
+   set _PARPORTADDR $PARPORTADDR
 } else {
-   set  _PARPORTADDR 0
+   set _PARPORTADDR 0
 }
 
 interface parport
diff --git a/tcl/interface/flossjtag-noeeprom.cfg b/tcl/interface/flossjtag-noeeprom.cfg
index 4e3466e..66c010b 100644
--- a/tcl/interface/flossjtag-noeeprom.cfg
+++ b/tcl/interface/flossjtag-noeeprom.cfg
@@ -4,12 +4,12 @@
 # http://github.com/esden/floss-jtag
 #
 # This is the pre v0.3 Floss-JTAG compatible config file. It can also be used
-# for newer versions of Floss-JTAG with empty or not populated eeprom. If you
-# have several Floss-JTAG connected you have to use the usb id to select a
+# for newer versions of Floss-JTAG with empty or not populated EEPROM. If you
+# have several Floss-JTAG connected you have to use the USB ID to select a
 # specific one.
 #
-# If you have a Floss-JTAG WITH eeprom that is programmed use flossjtag.cfg
-# file.
+# If you have a Floss-JTAG WITH EEPROM that is programmed, use the
+# flossjtag.cfg file.
 #
 
 interface ft2232
diff --git a/tcl/interface/flossjtag.cfg b/tcl/interface/flossjtag.cfg
index 9511dd2..fbbabc1 100644
--- a/tcl/interface/flossjtag.cfg
+++ b/tcl/interface/flossjtag.cfg
@@ -4,11 +4,11 @@
 # http://github.com/esden/floss-jtag
 #
 # This is the v0.3 and v1.0 Floss-JTAG compatible config file. It relies on the
-# existence of an eeprom on Floss-JTAG containing a name. If you have several
+# existence of an EEPROM on Floss-JTAG containing a name. If you have several
 # Floss-JTAG adapters connected you can use the serial number to select a
 # specific device.
 #
-# If your Floss-JTAG does not have an eeprom or eeprom is empty use
+# If your Floss-JTAG does not have an EEPROM, or the EEPROM is empty, use the
 # flossjtag-noeeprom.cfg file.
 #
 
diff --git a/tcl/interface/parport.cfg b/tcl/interface/parport.cfg
index 326005a..f7cc23a 100644
--- a/tcl/interface/parport.cfg
+++ b/tcl/interface/parport.cfg
@@ -2,11 +2,12 @@
 # Parallel port wiggler (many clones available) on port 0x378
 #
 # Addresses: 0x378/LPT1 or 0x278/LPT2 ...
+#
 
 if { [info exists PARPORTADDR] } {
-   set  _PARPORTADDR $PARPORTADDR
+   set _PARPORTADDR $PARPORTADDR
 } else {
-   set  _PARPORTADDR 0x378
+   set _PARPORTADDR 0x378
 }
 
 interface parport
diff --git a/tcl/interface/parport_dlc5.cfg b/tcl/interface/parport_dlc5.cfg
index d0f183f..9834580 100644
--- a/tcl/interface/parport_dlc5.cfg
+++ b/tcl/interface/parport_dlc5.cfg
@@ -5,9 +5,9 @@
 #
 
 if { [info exists PARPORTADDR] } {
-   set  _PARPORTADDR $PARPORTADDR
+   set _PARPORTADDR $PARPORTADDR
 } else {
-   set  _PARPORTADDR 0
+   set _PARPORTADDR 0
 }
 
 interface parport
diff --git a/tcl/interface/usbprog.cfg b/tcl/interface/usbprog.cfg
index f0841b9..b4f0da3 100644
--- a/tcl/interface/usbprog.cfg
+++ b/tcl/interface/usbprog.cfg
@@ -5,6 +5,6 @@
 #
 
 interface usbprog
-# USBprog is broken w/short tms sequences, this is a workaround
+# USBprog is broken w/short TMS sequences, this is a workaround
 # until the C code can be fixed.
-tms_sequence long
\ No newline at end of file
+tms_sequence long

-----------------------------------------------------------------------

Summary of changes:
 tcl/interface/flashlink.cfg          |    4 ++--
 tcl/interface/flossjtag-noeeprom.cfg |    8 ++++----
 tcl/interface/flossjtag.cfg          |    4 ++--
 tcl/interface/parport.cfg            |    5 +++--
 tcl/interface/parport_dlc5.cfg       |    4 ++--
 tcl/interface/usbprog.cfg            |    4 ++--
 6 files changed, 15 insertions(+), 14 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Mon Oct 31 12:05:22 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Mon, 31 Oct 2011 11:05:22 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-167-gfc55332
Message-ID: <mailman.244.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  fc553327c0a40b3039388bf9139aad2f9dc8fdf1 (commit)
      from  c0e1bfa8b4c8096666494be8fd99f2862bdf67a2 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit fc553327c0a40b3039388bf9139aad2f9dc8fdf1
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sun Oct 30 18:36:47 2011 +0100

    dsp563xxx: fix missing error propagation found by clang
    
    Change-Id: I7380ce145b4942e21b174f2a810928a877c32bc7
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/140
    Tested-by: jenkins
    Reviewed-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/src/target/dsp563xx.c b/src/target/dsp563xx.c
index b7f23c7..a0e1206 100644
--- a/src/target/dsp563xx.c
+++ b/src/target/dsp563xx.c
@@ -1323,7 +1323,7 @@ static int dsp563xx_run_algorithm(struct target *target,
 		int timeout_ms, void *arch_info)
 {
 	int i;
-	int retvaltemp,retval = 0;
+	int retval = ERROR_OK;
 	struct dsp563xx_common *dsp563xx = target_to_dsp563xx(target);
 
 	if (target->state != TARGET_HALTED)
@@ -1376,10 +1376,12 @@ static int dsp563xx_run_algorithm(struct target *target,
 	for (i = 0; i < num_mem_params; i++)
 	{
 		if (mem_params[i].direction != PARAM_OUT)
-			if ((retvaltemp = target_read_buffer(target, mem_params[i].address, mem_params[i].size, mem_params[i].value)) != ERROR_OK)
-			{
-					retval = retvaltemp;
-			}
+			retval = target_read_buffer(target,
+					mem_params[i].address,
+					mem_params[i].size,
+					mem_params[i].value);
+			if (retval != ERROR_OK)
+				return retval;
 	}
 
 	for (i = 0; i < num_reg_params; i++)

-----------------------------------------------------------------------

Summary of changes:
 src/target/dsp563xx.c |   12 +++++++-----
 1 files changed, 7 insertions(+), 5 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Mon Oct 31 18:42:11 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Mon, 31 Oct 2011 17:42:11 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-168-g0881594
Message-ID: <mailman.245.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  08815946f64ace39b2734dc1a8597d22505f0436 (commit)
      from  fc553327c0a40b3039388bf9139aad2f9dc8fdf1 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 08815946f64ace39b2734dc1a8597d22505f0436
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Thu Oct 27 23:51:50 2011 +0200

    bugfixes: tinker a bit with the targets command
    
    return error when target can not be found instead of ERROR_OK,
    split fn.
    
    Change-Id: Iba5232d3862a490d0995c3bfece23685bd6856e3
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/131
    Tested-by: jenkins
    Reviewed-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/src/target/target.c b/src/target/target.c
index bd15620..4708a1d 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -1861,26 +1861,36 @@ int target_write_u8(struct target *target, uint32_t address, uint8_t value)
 	return retval;
 }
 
+static int find_target(struct command_context *cmd_ctx, const char *name)
+{
+	struct target *target = get_target(name);
+	if (target == NULL) {
+		LOG_ERROR("Target: %s is unknown, try one of:\n", name);
+		return ERROR_FAIL;
+	}
+	if (!target->tap->enabled) {
+		LOG_USER("Target: TAP %s is disabled, "
+			 "can't be the current target\n",
+			 target->tap->dotted_name);
+		return ERROR_FAIL;
+	}
+
+	cmd_ctx->current_target = target->target_number;
+	return ERROR_OK;
+}
+
+
 COMMAND_HANDLER(handle_targets_command)
 {
+	int retval = ERROR_OK;
 	if (CMD_ARGC == 1)
 	{
-		struct target *target = get_target(CMD_ARGV[0]);
-		if (target == NULL) {
-			command_print(CMD_CTX,"Target: %s is unknown, try one of:\n", CMD_ARGV[0]);
-			goto DumpTargets;
-		}
-		if (!target->tap->enabled) {
-			command_print(CMD_CTX,"Target: TAP %s is disabled, "
-					"can't be the current target\n",
-					target->tap->dotted_name);
-			return ERROR_FAIL;
+		retval = find_target(CMD_CTX, CMD_ARGV[0]);
+		if (retval == ERROR_OK) {
+			/* we're done! */
+			return retval;
 		}
-
-		CMD_CTX->current_target = target->target_number;
-		return ERROR_OK;
 	}
-DumpTargets:;
 
 	struct target *target = all_targets;
 	command_print(CMD_CTX, "    TargetName         Type       Endian TapName            State       ");
@@ -1899,19 +1909,20 @@ DumpTargets:;
 			marker = '*';
 
 		/* keep columns lined up to match the headers above */
-		command_print(CMD_CTX, "%2d%c %-18s %-10s %-6s %-18s %s",
-					  target->target_number,
-					  marker,
-					  target_name(target),
-					  target_type_name(target),
-					  Jim_Nvp_value2name_simple(nvp_target_endian,
-								target->endianness)->name,
-					  target->tap->dotted_name,
-					  state);
+		command_print(CMD_CTX,
+				"%2d%c %-18s %-10s %-6s %-18s %s",
+				target->target_number,
+				marker,
+				target_name(target),
+				target_type_name(target),
+				Jim_Nvp_value2name_simple(nvp_target_endian,
+					target->endianness)->name,
+				target->tap->dotted_name,
+				state);
 		target = target->next;
 	}
 
-	return ERROR_OK;
+	return retval;
 }
 
 /* every 300ms we check for reset & powerdropout and issue a "reset halt" if so. */

-----------------------------------------------------------------------

Summary of changes:
 src/target/target.c |   59 ++++++++++++++++++++++++++++++--------------------
 1 files changed, 35 insertions(+), 24 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Mon Oct 31 21:41:46 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Mon, 31 Oct 2011 20:41:46 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-169-g9933fa3
Message-ID: <mailman.246.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  9933fa334de551096674d4044ed7ac2152213e8b (commit)
      from  08815946f64ace39b2734dc1a8597d22505f0436 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 9933fa334de551096674d4044ed7ac2152213e8b
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Fri Oct 28 17:22:32 2011 +0200

    cfi: unsupported code paths now report and return error
    
    found by clang, would have done something undefined and mysterious
    later on.
    
    Change-Id: If7d7aca8514575d229ed0b17378bf8b1bbf347c4
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/133
    Tested-by: jenkins
    Reviewed-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/src/flash/nor/cfi.c b/src/flash/nor/cfi.c
index f75efac..62d2ae4 100644
--- a/src/flash/nor/cfi.c
+++ b/src/flash/nor/cfi.c
@@ -1897,13 +1897,15 @@ static int cfi_spansion_write_block(struct flash_bank *bank, uint8_t *buffer,
 		armv4_5_info.common_magic = ARMV7M_COMMON_MAGIC;
 		armv4_5_info.core_mode = ARMV7M_MODE_HANDLER;
 		armv4_5_info.core_state = ARM_STATE_ARM;
-	}
-	else
+	} else if (armv4_5_info.common_magic == ARM_COMMON_MAGIC)
 	{
 		/* All other ARM CPUs have 32 bit instructions */
 		armv4_5_info.common_magic = ARM_COMMON_MAGIC;
 		armv4_5_info.core_mode = ARM_MODE_SVC;
 		armv4_5_info.core_state = ARM_STATE_ARM;
+	} else {
+		LOG_ERROR("Unknown ARM architecture");
+		return ERROR_FAIL;
 	}
 
 	int target_code_size = 0;
@@ -1912,11 +1914,12 @@ static int cfi_spansion_write_block(struct flash_bank *bank, uint8_t *buffer,
 	switch (bank->bus_width)
 	{
 	case 1 :
-		if(armv4_5_info.common_magic == ARM_COMMON_MAGIC) /* armv4_5 target */
-		{
-			target_code_src = armv4_5_word_8_code;
-			target_code_size = sizeof(armv4_5_word_8_code);
+		if (armv4_5_info.common_magic != ARM_COMMON_MAGIC) {
+			LOG_ERROR("Unknown ARM architecture");
+			return ERROR_FAIL;
 		}
+		target_code_src = armv4_5_word_8_code;
+		target_code_size = sizeof(armv4_5_word_8_code);
 		break;
 	case 2 :
 		/* Check for DQ5 support */
@@ -1936,19 +1939,21 @@ static int cfi_spansion_write_block(struct flash_bank *bank, uint8_t *buffer,
 		else
 		{
 			/* No DQ5 support. Use DQ7 DATA# polling only. */
-			if(armv4_5_info.common_magic == ARM_COMMON_MAGIC) // armv4_5 target
-			{
-				target_code_src = armv4_5_word_16_code_dq7only;
-				target_code_size = sizeof(armv4_5_word_16_code_dq7only);
+			if (armv4_5_info.common_magic != ARM_COMMON_MAGIC) {
+				LOG_ERROR("Unknown ARM architecture");
+				return ERROR_FAIL;
 			}
+			target_code_src = armv4_5_word_16_code_dq7only;
+			target_code_size = sizeof(armv4_5_word_16_code_dq7only);
 		}
 		break;
 	case 4 :
-		if(armv4_5_info.common_magic == ARM_COMMON_MAGIC) // armv4_5 target
-		{
-			target_code_src = armv4_5_word_32_code;
-			target_code_size = sizeof(armv4_5_word_32_code);
+		if (armv4_5_info.common_magic != ARM_COMMON_MAGIC) {
+			LOG_ERROR("Unknown ARM architecture");
+			return ERROR_FAIL;
 		}
+		target_code_src = armv4_5_word_32_code;
+		target_code_size = sizeof(armv4_5_word_32_code);
 		break;
 	default:
 		LOG_ERROR("Unsupported bank buswidth %d, can't do block memory writes", bank->bus_width);

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/cfi.c |   33 +++++++++++++++++++--------------
 1 files changed, 19 insertions(+), 14 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Mon Oct 31 21:44:02 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Mon, 31 Oct 2011 20:44:02 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-170-g9b9092b
Message-ID: <mailman.247.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  9b9092b7faa5859dd1a14489a312465782e2bef1 (commit)
      from  9933fa334de551096674d4044ed7ac2152213e8b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 9b9092b7faa5859dd1a14489a312465782e2bef1
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Oct 31 21:21:35 2011 +0100

    warnings: null pointer check fix
    
    rewrite broken null pointer check code by reducing scope
    of variable.
    
    Change-Id: I8254f6849b187e5c9cd083053cdc11973c6fe339
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/142
    Tested-by: jenkins
    Reviewed-by: Spencer Oliver <spen at spen-soft.co.uk>

diff --git a/src/target/target_request.c b/src/target/target_request.c
index 3cdca5e..1fedfb2 100644
--- a/src/target/target_request.c
+++ b/src/target/target_request.c
@@ -194,11 +194,9 @@ static int add_debug_msg_receiver(struct command_context *cmd_ctx, struct target
 static struct debug_msg_receiver* find_debug_msg_receiver(struct command_context *cmd_ctx, struct target *target)
 {
 	int do_all_targets = 0;
-	struct debug_msg_receiver **p = &target->dbgmsg;
 
 	/* if no target has been specified search all of them */
-	if (target == NULL)
-	{
+	if (target == NULL) {
 		/* if no targets haven been specified */
 		if (all_targets == NULL)
 			return NULL;
@@ -207,8 +205,9 @@ static struct debug_msg_receiver* find_debug_msg_receiver(struct command_context
 		do_all_targets = 1;
 	}
 
-	do
-	{
+	/* so we target != null */
+	struct debug_msg_receiver **p = &target->dbgmsg;
+	do {
 		while (*p)
 		{
 			if ((*p)->cmd_ctx == cmd_ctx)

-----------------------------------------------------------------------

Summary of changes:
 src/target/target_request.c |    9 ++++-----
 1 files changed, 4 insertions(+), 5 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From openocd-gerrit at users.sourceforge.net  Mon Oct 31 22:13:00 2011
From: openocd-gerrit at users.sourceforge.net (OpenOCD-Gerrit)
Date: Mon, 31 Oct 2011 21:13:00 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.5.0-171-g01f461b
Message-ID: <mailman.248.1331736158.7625.openocd-svn@lists.berlios.de>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  01f461b20a707e3547def68f562701790ba99949 (commit)
      from  9b9092b7faa5859dd1a14489a312465782e2bef1 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 01f461b20a707e3547def68f562701790ba99949
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Oct 31 21:52:10 2011 +0100

    warning fix: remove senseless assignment before bailing out of fn w/error
    
    Change-Id: I822f3adce0eccb880007673d60c7eccf7d36b398
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>
    Reviewed-on: http://openocd.zylin.com/144
    Tested-by: jenkins
    Reviewed-by: Peter Stuge <peter at stuge.se>

diff --git a/src/target/mips32_pracc.c b/src/target/mips32_pracc.c
index 6b43479..7160f8e 100644
--- a/src/target/mips32_pracc.c
+++ b/src/target/mips32_pracc.c
@@ -183,7 +183,6 @@ static int mips32_pracc_exec_read(struct mips32_pracc_context *ctx, uint32_t add
 		/* TODO: send JMP 0xFF200000 instruction. Hopefully processor jump back
 		 * to start of debug vector */
 
-		data = 0;
 		LOG_ERROR("Error reading unexpected address 0x%8.8" PRIx32 "", address);
 		return ERROR_JTAG_DEVICE_ERROR;
 	}

-----------------------------------------------------------------------

Summary of changes:
 src/target/mips32_pracc.c |    1 -
 1 files changed, 0 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


