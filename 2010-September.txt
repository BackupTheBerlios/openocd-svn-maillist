From gowinex at users.sourceforge.net  Fri Sep  3 22:10:43 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Fri,  3 Sep 2010 20:10:43 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-499-gae80c35
Message-ID: <E1Orcb4-0003Dr-5K@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  ae80c3564a5693a5326ceac750ec6779efe3f523 (commit)
      from  3c69eee9ef481333eb08e72badc9404e607f861c (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit ae80c3564a5693a5326ceac750ec6779efe3f523
Author: Wookey <wookey at wookware.org>
Date:   Tue Aug 31 13:53:50 2010 +0100

    Numonyx M29W160ET patch
    
    Someone called David Carne popped up on IRC and offered a fix (as he's not
    on this list so can;t post here). I am just passing it on. (thanx David)
    
     10:54 < davidc__> Basically; the Numonyx M29W160ET has an incorrect CFI PRI
                 block; it describes the erase blocks backwards
     10:54 < davidc__> the linked patch has a fixup for that part [really trivial]:

diff --git a/src/flash/nor/cfi.c b/src/flash/nor/cfi.c
index 96aca48..9813d83 100644
--- a/src/flash/nor/cfi.c
+++ b/src/flash/nor/cfi.c
@@ -48,7 +48,7 @@ static struct cfi_unlock_addresses cfi_unlock_addresses[] =
 /* CFI fixups foward declarations */
 static void cfi_fixup_0002_erase_regions(struct flash_bank *flash, void *param);
 static void cfi_fixup_0002_unlock_addresses(struct flash_bank *flash, void *param);
-static void cfi_fixup_atmel_reversed_erase_regions(struct flash_bank *flash, void *param);
+static void cfi_fixup_reversed_erase_regions(struct flash_bank *flash, void *param);
 
 /* fixup after reading cmdset 0002 primary query table */
 static const struct cfi_fixup cfi_0002_fixups[] = {
@@ -57,7 +57,8 @@ static const struct cfi_fixup cfi_0002_fixups[] = {
 	{CFI_MFR_SST, 0x00D6, cfi_fixup_0002_unlock_addresses, &cfi_unlock_addresses[CFI_UNLOCK_5555_2AAA]},
 	{CFI_MFR_SST, 0x00D7, cfi_fixup_0002_unlock_addresses, &cfi_unlock_addresses[CFI_UNLOCK_5555_2AAA]},
 	{CFI_MFR_SST, 0x2780, cfi_fixup_0002_unlock_addresses, &cfi_unlock_addresses[CFI_UNLOCK_5555_2AAA]},
-	{CFI_MFR_ATMEL, 0x00C8, cfi_fixup_atmel_reversed_erase_regions, NULL},
+	{CFI_MFR_ATMEL, 0x00C8, cfi_fixup_reversed_erase_regions, NULL},
+	{CFI_MFR_ST,  0x22C4, cfi_fixup_reversed_erase_regions, NULL}, /* M29W160ET */
    {CFI_MFR_FUJITSU, 0x22ea, cfi_fixup_0002_unlock_addresses, &cfi_unlock_addresses[CFI_UNLOCK_555_2AA]},
 	{CFI_MFR_FUJITSU, 0x226b, cfi_fixup_0002_unlock_addresses, &cfi_unlock_addresses[CFI_UNLOCK_5555_2AAA]},
 	{CFI_MFR_AMIC, 0xb31a, cfi_fixup_0002_unlock_addresses, &cfi_unlock_addresses[CFI_UNLOCK_555_2AA]},
@@ -2214,7 +2215,7 @@ static int cfi_write(struct flash_bank *bank, uint8_t *buffer, uint32_t offset,
 	return cfi_reset(bank);
 }
 
-static void cfi_fixup_atmel_reversed_erase_regions(struct flash_bank *bank, void *param)
+static void cfi_fixup_reversed_erase_regions(struct flash_bank *bank, void *param)
 {
 	(void) param;
 	struct cfi_flash_bank *cfi_info = bank->driver_priv;

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/cfi.c |    7 ++++---
 1 files changed, 4 insertions(+), 3 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Fri Sep  3 22:17:50 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Fri,  3 Sep 2010 20:17:50 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-500-g35af12d
Message-ID: <E1Orchs-0004fX-OK@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  35af12d3e729e053b2e83cd0322f9347af652ef3 (commit)
      from  ae80c3564a5693a5326ceac750ec6779efe3f523 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 35af12d3e729e053b2e83cd0322f9347af652ef3
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Wed Sep 1 23:36:31 2010 +0200

    jtag: fix regression with dummy driver and when starting OpenOCD with target powered down
    
    Do not fail startup if communication with target is
    not possible.
    
    OpenOCD supports launching without a target connected
    or the target powered down.
    
    The user will typically power up the target and issue
    a "reset init" + load his application after OpenOCD
    is started then.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/jtag/core.c b/src/jtag/core.c
index 1068681..6f9d92a 100644
--- a/src/jtag/core.c
+++ b/src/jtag/core.c
@@ -1445,17 +1445,19 @@ int jtag_init_inner(struct command_context *cmd_ctx)
 	case ERROR_OK:
 		/* complete success */
 		break;
-	case ERROR_JTAG_INIT_SOFT_FAIL:
+	default:
 		/* For backward compatibility reasons, try coping with
 		 * configuration errors involving only ID mismatches.
 		 * We might be able to talk to the devices.
+		 *
+		 * Also the device might be powered down during startup.
+		 *
+		 * After OpenOCD starts, we can try to power on the device
+		 * and run a reset.
 		 */
 		LOG_ERROR("Trying to use configured scan chain anyway...");
 		issue_setup = false;
 		break;
-	default:
-		/* some hard error; already issued diagnostics */
-		return retval;
 	}
 
 	/* Now look at IR values.  Problems here will prevent real
@@ -1466,7 +1468,13 @@ int jtag_init_inner(struct command_context *cmd_ctx)
 	 */
 	retval = jtag_validate_ircapture();
 	if (retval != ERROR_OK)
-		return retval;
+	{
+		/* The target might be powered down. The user
+		 * can power it up and reset it after firing
+		 * up OpenOCD.
+		 */
+		issue_setup = false;
+	}
 
 	if (issue_setup)
 		jtag_notify_event(JTAG_TAP_EVENT_SETUP);

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/core.c |   18 +++++++++++++-----
 1 files changed, 13 insertions(+), 5 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Sep  7 18:41:25 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue,  7 Sep 2010 16:41:25 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-501-g98a66c4
Message-ID: <E1Ot1Ef-0008MP-Cj@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  98a66c48091be6c081f1b2fee04ef47e7f1c2070 (commit)
      from  35af12d3e729e053b2e83cd0322f9347af652ef3 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 98a66c48091be6c081f1b2fee04ef47e7f1c2070
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Tue Sep 7 18:38:06 2010 +0200

    warning: fix silly -O3 warning
    
    Some versions of GCC don't pick up that local variables
    are set in all code paths.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/jtag/core.c b/src/jtag/core.c
index 6f9d92a..dd3a2a6 100644
--- a/src/jtag/core.c
+++ b/src/jtag/core.c
@@ -1634,7 +1634,7 @@ int jtag_config_rclk(unsigned fallback_speed_khz)
 
 int jtag_get_speed(void)
 {
-	int speed;
+	int speed = 0; /* avoid -O3 warning */
 	switch(clock_mode)
 	{
 		case CLOCK_MODE_SPEED:

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/core.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Wed Sep  8 10:36:15 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Wed,  8 Sep 2010 08:36:15 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-502-ga40f12d
Message-ID: <E1OtG8l-0005bx-Ea@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  a40f12d62693042415c46bcc95b0bd86d9eaea81 (commit)
      from  98a66c48091be6c081f1b2fee04ef47e7f1c2070 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit a40f12d62693042415c46bcc95b0bd86d9eaea81
Author: Alexander Stein <alexander.stein at informatik.tu-chemnitz.de>
Date:   Wed Sep 8 10:17:54 2010 +0200

    Remove duplicated initialization
    
    I a mail conversation with ??yvind we stated that speed may not be set at
    all on case CLOCK_MODE_KHZ and CLOCK_MODE_RCLK. Also there isn't proper
    error propagation adapter_khz_to_speed or jtag_rclk_to_speed.
    So jtag_get_speed may need some rewrite for error propagation.
    
    CC: ??yvind Harboe <oyvind.harboe at zylin.com>
    Signed-off-by: Alexander Stein <alexander.stein at informatik.tu-chemnitz.de>
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/jtag/core.c b/src/jtag/core.c
index dd3a2a6..c1b64bb 100644
--- a/src/jtag/core.c
+++ b/src/jtag/core.c
@@ -1648,7 +1648,6 @@ int jtag_get_speed(void)
 			break;
 		default:
 			LOG_ERROR("BUG: unknown jtag clock mode");
-			speed = 0;
 			break;
 	}
 	return speed;

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/core.c |    1 -
 1 files changed, 0 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Thu Sep  9 09:23:35 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Thu,  9 Sep 2010 07:23:35 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-503-ge1c6f67
Message-ID: <E1OtbTz-0005i7-3W@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  e1c6f6783d68f0dcc766b3e6317348e3838a3856 (commit)
      from  a40f12d62693042415c46bcc95b0bd86d9eaea81 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit e1c6f6783d68f0dcc766b3e6317348e3838a3856
Author: Mike Dunn <mikedunn at newsguy.com>
Date:   Wed Sep 8 19:13:14 2010 -0700

    xscale: mark xscale registers invalid on debug entry
    
    Hi everyone,
    
    This simple patch fixes a problem I noticed on the xscale where incorrect values
    are sometimes reported by the reg command.  The problem can occur when
    requesting the value of registers in the xscale-specific register cache.  With a
    couple of exceptions, none of the registers in the xscale register cache are
    automatically retrieved on debug entry.  This is probably fine, as they are
    unlikely to be needed on a regular basis during a typical debug session, and
    they can be retrieved when explicitly requested by name using the reg command.
    The problem is that once this is done, the register remains marked as valid for
    the remainder of the OpenOCD session, and the reg command will henceforth always
    report the same value because it is obtained from the cache and is never again
    retrieved from the debug handler on the target.
    
    The fix is to mark all registers in the xscale register cache as invalid on
    debug entry (before the two exceptions are retrieved), thus forcing retrieval
    (when requested) from the target across resumptions in execution, and avoiding
    the reporting of stale values.
    
    Small addition change by ??yvind: change 'i' to unsigned to fix compiler
    warning for xscale_debug_entry() fn.
    
    Signed-off-by: Mike Dunn <mikedunn at newsguy.com>
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/xscale.c b/src/target/xscale.c
index 44358bc..2b8bff1 100644
--- a/src/target/xscale.c
+++ b/src/target/xscale.c
@@ -895,7 +895,7 @@ static int xscale_debug_entry(struct target *target)
 	struct arm *armv4_5 = &xscale->armv4_5_common;
 	uint32_t pc;
 	uint32_t buffer[10];
-	int i;
+	unsigned i;
 	int retval;
 	uint32_t moe;
 
@@ -964,6 +964,11 @@ static int xscale_debug_entry(struct target *target)
 		r->valid = true;
 	}
 
+	/* mark xscale regs invalid to ensure they are retrieved from the
+	 * debug handler if requested  */
+	for (i = 0; i < xscale->reg_cache->num_regs; i++)
+	   xscale->reg_cache->reg_list[i].valid = 0;
+
 	/* examine debug reason */
 	xscale_read_dcsr(target);
 	moe = buf_get_u32(xscale->reg_cache->reg_list[XSCALE_DCSR].value, 2, 3);

-----------------------------------------------------------------------

Summary of changes:
 src/target/xscale.c |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Sat Sep 11 10:40:25 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Sat, 11 Sep 2010 08:40:25 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-505-g8c21659
Message-ID: <E1OuLdQ-0005Gh-BM@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  8c21659d2a81912c2d591d3889893040d1aa9028 (commit)
       via  ef92da3315b13ab8ee3b509f2b05c15194140b92 (commit)
      from  e1c6f6783d68f0dcc766b3e6317348e3838a3856 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 8c21659d2a81912c2d591d3889893040d1aa9028
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Fri Sep 10 10:22:14 2010 +0200

    cfi: random crash in cfi_probe() fixed
    
    for non_cfi cfi chips free() was invoked on rodata.
    
    The mystery is why this bug has survived for so long.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nor/non_cfi.c b/src/flash/nor/non_cfi.c
index e0ea568..569ffc5 100644
--- a/src/flash/nor/non_cfi.c
+++ b/src/flash/nor/non_cfi.c
@@ -486,7 +486,11 @@ void cfi_fixup_non_cfi(struct flash_bank *bank)
 	cfi_info->max_buf_write_size = non_cfi->max_buf_write_size;
 	cfi_info->status_poll_mask = non_cfi->status_poll_mask;
 	cfi_info->num_erase_regions = non_cfi->num_erase_regions;
-	cfi_info->erase_region_info = non_cfi->erase_region_info;
+	size_t erase_region_info_size = sizeof(*cfi_info->erase_region_info) *
+			cfi_info->num_erase_regions;
+	cfi_info->erase_region_info = malloc(erase_region_info_size);
+	memcpy(cfi_info->erase_region_info,
+			non_cfi->erase_region_info, erase_region_info_size);
 	cfi_info->dev_size = non_cfi->dev_size;
 
 	if (cfi_info->pri_id == 0x2)

commit ef92da3315b13ab8ee3b509f2b05c15194140b92
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Fri Sep 10 10:20:06 2010 +0200

    cfi: tighten up type usage a bit
    
    sizeof() is a bit less scary than seing assumption
    about size of type, no bug as such.
    
    Use NULL instead of 0 for pointers. More obvious that
    it is a pointer from code inspection.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nor/cfi.c b/src/flash/nor/cfi.c
index 9813d83..5b5b4da 100644
--- a/src/flash/nor/cfi.c
+++ b/src/flash/nor/cfi.c
@@ -805,7 +805,7 @@ FLASH_BANK_COMMAND_HANDLER(cfi_flash_bank_command)
 
 	cfi_info = malloc(sizeof(struct cfi_flash_bank));
 	cfi_info->probed = 0;
-	cfi_info->erase_region_info = 0;
+	cfi_info->erase_region_info = NULL;
 	cfi_info->pri_ext = NULL;
 	bank->driver_priv = cfi_info;
 
@@ -2494,7 +2494,8 @@ static int cfi_probe(struct flash_bank *bank)
 
 		if (cfi_info->num_erase_regions)
 		{
-			cfi_info->erase_region_info = malloc(4 * cfi_info->num_erase_regions);
+			cfi_info->erase_region_info = malloc(sizeof(*cfi_info->erase_region_info)
+					* cfi_info->num_erase_regions);
 			for (i = 0; i < cfi_info->num_erase_regions; i++)
 			{
 				retval = cfi_query_u32(bank, 0, 0x2d + (4 * i), &cfi_info->erase_region_info[i]);

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/cfi.c     |    5 +++--
 src/flash/nor/non_cfi.c |    6 +++++-
 2 files changed, 8 insertions(+), 3 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Sun Sep 12 18:24:08 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Sun, 12 Sep 2010 16:24:08 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-507-g505d463
Message-ID: <E1OupLe-0007lK-7c@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  505d4633cd7a4e8623ef70932cd7edc9f22e71d4 (commit)
       via  ac86f4ccba49a671034a7607a7e14bc4b5e86ac6 (commit)
      from  8c21659d2a81912c2d591d3889893040d1aa9028 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 505d4633cd7a4e8623ef70932cd7edc9f22e71d4
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Fri Sep 10 13:16:13 2010 +0200

    version command: make it scriptable
    
    you can now set a variable in a script like set version [version].
    
    Also version takes an optional argument "git" to show git version
    of source. If git is not installed during the build, then this
    will yield an error that is ignored during the build and "version git"
    returns an empty string.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/Makefile.am b/src/Makefile.am
index a566b4d..56385f7 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -44,6 +44,7 @@ libopenocd_la_CPPFLAGS += -DRELSTR=\"\"
 else
 libopenocd_la_CPPFLAGS += -DRELSTR=\"`$(top_srcdir)/guess-rev.sh $(top_srcdir)`\"
 endif
+libopenocd_la_CPPFLAGS += -DGITVERSION=\"`cd $(top_srcdir) && git describe`\"
 
 # add default CPPFLAGS
 libopenocd_la_CPPFLAGS += $(AM_CPPFLAGS) $(CPPFLAGS)
diff --git a/src/openocd.c b/src/openocd.c
index 69ed760..5f890db 100644
--- a/src/openocd.c
+++ b/src/openocd.c
@@ -2,7 +2,7 @@
  *   Copyright (C) 2005 by Dominic Rath                                    *
  *   Dominic.Rath at gmx.de                                                   *
  *                                                                         *
- *   Copyright (C) 2007,2008 ??yvind Harboe                                 *
+ *   Copyright (C) 2007-2010 ??yvind Harboe                                 *
  *   oyvind.harboe at zylin.com                                               *
  *                                                                         *
  *   Copyright (C) 2008 Richard Missenden                                  *
@@ -52,15 +52,29 @@
 #define OPENOCD_VERSION \
 		"Open On-Chip Debugger " VERSION RELSTR " (" PKGBLDDATE ")"
 
-/* Give TELNET a way to find out what version this is */
-COMMAND_HANDLER(handle_version_command)
+/* Give scripts and TELNET a way to find out what version this is */
+static int jim_version_command(Jim_Interp *interp, int argc,
+		Jim_Obj * const *argv)
 {
-	if (CMD_ARGC != 0)
-		return ERROR_COMMAND_SYNTAX_ERROR;
-
-	command_print(CMD_CTX, OPENOCD_VERSION);
+	if (argc > 2)
+	{
+		return JIM_ERR;
+	}
+	const char *str = "";
+	char * version_str;
+	version_str = OPENOCD_VERSION;
+	
+	if (argc == 2)
+		str = Jim_GetString(argv[1], NULL);
+
+	if (strcmp("git", str) == 0)
+	{
+		version_str = GITVERSION;
+	} 
+	
+	Jim_SetResult(interp, Jim_NewStringObj(interp, version_str, -1));
 
-	return ERROR_OK;
+	return JIM_OK;
 }
 
 static int log_target_callback_event_handler(struct target *target, enum target_event event, void *priv)
@@ -174,7 +188,7 @@ COMMAND_HANDLER(handle_add_script_search_dir_command)
 static const struct command_registration openocd_command_handlers[] = {
 	{
 		.name = "version",
-		.handler = &handle_version_command,
+		.jim_handler = jim_version_command,
 		.mode = COMMAND_ANY,
 		.help = "show program version",
 	},

commit ac86f4ccba49a671034a7607a7e14bc4b5e86ac6
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Fri Sep 10 19:28:11 2010 +0200

    command: capture command now handles both types commands
    
    Commands that output progress output and no return value
    will have the progress output captured.
    
    Commands that do not output progress output(tcl commands)
    will return the tcl return value instead.
    
    The advantage here is that it is no longer necessary to
    consider which command one is capturing, it works for
    either.
    
    Example #1: capture progress output:
    
    set foo [capture help]
    
    Example #2: capture tcl return value
    
    set foo [capture {set abc def}]
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/helper/command.c b/src/helper/command.c
index ea768b2..086b03d 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -84,14 +84,36 @@ static struct log_capture_state *command_log_capture_start(Jim_Interp *interp)
 	return state;
 }
 
-static void command_log_capture_finish(struct log_capture_state *state)
+/* Classic openocd commands provide progress output which we
+ * will capture and return as a Tcl return value.
+ *
+ * However, if a non-openocd command has been invoked, then it
+ * makes sense to return the tcl return value from that command.
+ *
+ * The tcl return value is empty for openocd commands that provide
+ * progress output.
+ *
+ * Therefore we set the tcl return value only if we actually
+ * captured output.
+ */
+static void command_log_capture_finish(struct log_capture_state *state) 
 {
 	if (NULL == state)
 		return;
 
 	log_remove_callback(tcl_output, state);
 
-	Jim_SetResult(state->interp, state->output);
+	int length;
+	Jim_GetString(state->output, &length);
+
+	if (length > 0)
+	{
+		Jim_SetResult(state->interp, state->output);
+	} else
+	{
+		/* No output captured, use tcl return value (which could
+		 * be empty too). */
+	}
 	Jim_DecrRefCount(state->interp, state->output);
 
 	free(state);

-----------------------------------------------------------------------

Summary of changes:
 src/Makefile.am      |    1 +
 src/helper/command.c |   26 ++++++++++++++++++++++++--
 src/openocd.c        |   32 +++++++++++++++++++++++---------
 3 files changed, 48 insertions(+), 11 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Sun Sep 12 20:24:00 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Sun, 12 Sep 2010 18:24:00 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-509-g8afd230
Message-ID: <E1OurDm-0004lm-J4@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  8afd2309a4e18b222da189eb51f46339f17201d5 (commit)
       via  73e5dffdfd310bd09b5497f40db98f50eedeb31a (commit)
      from  505d4633cd7a4e8623ef70932cd7edc9f22e71d4 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 8afd2309a4e18b222da189eb51f46339f17201d5
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sun Sep 12 19:29:37 2010 +0200

    helper: add stacktrace command that returns error stacktrace
    
    Ability to access the stacktrace from a script is quite
    handy.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/openocd.c b/src/openocd.c
index 5f890db..7347cad 100644
--- a/src/openocd.c
+++ b/src/openocd.c
@@ -185,6 +185,29 @@ COMMAND_HANDLER(handle_add_script_search_dir_command)
 	return ERROR_OK;
 }
 
+
+static int jim_stacktrace_command(Jim_Interp *interp, int argc,
+		Jim_Obj * const *argv)
+{
+	if (argc != 1)
+	{
+		return JIM_ERR;
+	}
+	Jim_Obj * stacktrace = Jim_DuplicateObj(interp, interp->stackTrace);
+	
+	/* insert actual error site at beginning of list*/
+	Jim_Obj *procname = Jim_NewStringObj(interp, "", -1); /* Uhhh... don't know this one. */
+	Jim_ListInsertElements(interp, stacktrace, 0, 1, &procname);
+	Jim_Obj *filename = Jim_NewStringObj(interp, interp->errorFileName, -1);
+	Jim_ListInsertElements(interp, stacktrace, 1, 1, &filename);
+	Jim_Obj *line = Jim_NewIntObj(interp, interp->errorLine);
+	Jim_ListInsertElements(interp, stacktrace, 2, 1, &line);
+
+	Jim_SetResult(interp, stacktrace);
+
+	return JIM_OK;
+}
+
 static const struct command_registration openocd_command_handlers[] = {
 	{
 		.name = "version",
@@ -215,6 +238,14 @@ static const struct command_registration openocd_command_handlers[] = {
 		.help = "dir to search for config files and scripts",
 
 	},
+	{
+		.name = "stacktrace",
+		.jim_handler = jim_stacktrace_command,
+		.mode = COMMAND_ANY,
+		.help = "returns the stacktrace as a list of triples: proc, file, line."
+		"The stack trace is reset when a new stack trace is being built after "
+		"a new failure has occurred.",
+	},
 	COMMAND_REGISTRATION_DONE
 };
 

commit 73e5dffdfd310bd09b5497f40db98f50eedeb31a
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sun Sep 12 20:16:55 2010 +0200

    jim: fix crash when using Jim_ListInsertElements
    
    Jim_ListInsertElements was simply forgotten from the
    fn that registered all the APIs.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/helper/jim.c b/src/helper/jim.c
index 071e557..bb74838 100644
--- a/src/helper/jim.c
+++ b/src/helper/jim.c
@@ -9296,6 +9296,7 @@ void JimRegisterCoreApi(Jim_Interp *interp)
   JIM_REGISTER_API(CollectIfNeeded);
   JIM_REGISTER_API(GetIndex);
   JIM_REGISTER_API(NewListObj);
+  JIM_REGISTER_API(ListInsertElements);
   JIM_REGISTER_API(ListAppendElement);
   JIM_REGISTER_API(ListAppendList);
   JIM_REGISTER_API(ListLength);

-----------------------------------------------------------------------

Summary of changes:
 src/helper/jim.c |    1 +
 src/openocd.c    |   31 +++++++++++++++++++++++++++++++
 2 files changed, 32 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Sep 13 19:50:30 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 13 Sep 2010 17:50:30 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-510-g81e0d44
Message-ID: <E1OvDAs-0003qv-1M@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  81e0d4438ec4b4112e28a9e90ba2fc1fb548310b (commit)
      from  8afd2309a4e18b222da189eb51f46339f17201d5 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 81e0d4438ec4b4112e28a9e90ba2fc1fb548310b
Author: Mike Dunn <mikedunn at newsguy.com>
Date:   Sun Sep 12 12:05:07 2010 -0700

    propagate return status of set_breakpoint() up call chain
    
    Hi everyone,
    
    I figured since I was poking around in the breakpoint code on other arches, I'd
    add this change to those arches that don't do it already.  This patch propagates
    the return code of <arch>_set_breakpoint() up the call stack.  This ensures that
    the higher layer breakpoint infrastructure is aware that an error ocurred, in
    which case the breakpoint is not recorded.
    
    Normally I wouldn't touch code that I can't test, but the code is very
    uniform across architectures, and the change is rather benign, so I figured
    after careful inspection that it is safe.  If the maintainers or others think
    this is imprudent, the patch can be dropped.
    
    Also changed the error code to something more appropriate in two cases where
    hardware resources are unavailable.
    
    Comments and criticisms of course gratefully received.
    
    Mike
    
    Signed-off-by: Mike Dunn <mikedunn at newsguy.com>
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/cortex_a8.c b/src/target/cortex_a8.c
index 9b3521a..8b4ced5 100644
--- a/src/target/cortex_a8.c
+++ b/src/target/cortex_a8.c
@@ -1230,7 +1230,7 @@ static int cortex_a8_set_breakpoint(struct target *target,
 		if (brp_i >= cortex_a8->brp_num)
 		{
 			LOG_ERROR("ERROR Can not find free Breakpoint Register Pair");
-			return ERROR_FAIL;
+			return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
 		}
 		breakpoint->set = brp_i + 1;
 		if (breakpoint->length == 2)
@@ -1360,9 +1360,8 @@ static int cortex_a8_add_breakpoint(struct target *target,
 
 	if (breakpoint->type == BKPT_HARD)
 		cortex_a8->brp_num_available--;
-	cortex_a8_set_breakpoint(target, breakpoint, 0x00); /* Exact match */
 
-	return ERROR_OK;
+	return cortex_a8_set_breakpoint(target, breakpoint, 0x00); /* Exact match */
 }
 
 static int cortex_a8_remove_breakpoint(struct target *target, struct breakpoint *breakpoint)
diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index f87c3e0..3011b59 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -1221,9 +1221,8 @@ cortex_m3_add_breakpoint(struct target *target, struct breakpoint *breakpoint)
 
 	if (breakpoint->type == BKPT_HARD)
 		cortex_m3->fp_code_available--;
-	cortex_m3_set_breakpoint(target, breakpoint);
 
-	return ERROR_OK;
+	return cortex_m3_set_breakpoint(target, breakpoint);
 }
 
 static int
diff --git a/src/target/mips_m4k.c b/src/target/mips_m4k.c
index 21ff0ba..62c484a 100644
--- a/src/target/mips_m4k.c
+++ b/src/target/mips_m4k.c
@@ -497,7 +497,7 @@ static int mips_m4k_set_breakpoint(struct target *target,
 		{
 			LOG_ERROR("Can not find free FP Comparator(bpid: %d)",
 					  breakpoint->unique_id );
-			return ERROR_FAIL;
+			return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
 		}
 		breakpoint->set = bp_num + 1;
 		comparator_list[bp_num].used = 1;
@@ -662,9 +662,7 @@ static int mips_m4k_add_breakpoint(struct target *target, struct breakpoint *bre
 		mips32->num_inst_bpoints_avail--;
 	}
 
-	mips_m4k_set_breakpoint(target, breakpoint);
-
-	return ERROR_OK;
+	return mips_m4k_set_breakpoint(target, breakpoint);
 }
 
 static int mips_m4k_remove_breakpoint(struct target *target,

-----------------------------------------------------------------------

Summary of changes:
 src/target/cortex_a8.c |    5 ++---
 src/target/cortex_m3.c |    3 +--
 src/target/mips_m4k.c  |    6 ++----
 3 files changed, 5 insertions(+), 9 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Sep 13 21:57:36 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 13 Sep 2010 19:57:36 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-511-g3569106
Message-ID: <E1OvF9l-0006rX-Vo@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  35691065f72110d4490df3a127467ea9c04c70ca (commit)
      from  81e0d4438ec4b4112e28a9e90ba2fc1fb548310b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 35691065f72110d4490df3a127467ea9c04c70ca
Author: Mike Dunn <mikedunn at newsguy.com>
Date:   Mon Sep 13 12:45:37 2010 -0700

    xscale: fix sw breakpoints for thumb; set bp immediately
    
    Hi everyone,
    
    Version 2 of this patch.  Code added to breakpoints.c was removed from previous
    patch, and item 3 added, per discussion with ??yvind regarding error reporting.
    Item 4 added, which I just noticed.
    
    I tried to use a software breakpoint in thumb code on the xscale for the first
    time recently, and was surprised to find that it didn't work.  The result was
    this patch, which does four things:
    
    1): fix trivial cut-n-paste error that caused thumb breakpoints to not work
    2): call xscale_set_breakpoint() from xscale_add_breakpoint()
    3): log error on data abort in xscale_write_memory()
    4): fixed incorrect error code returned by xscale_set_breakpoint() when no
        breakpoint register is available; added comment
    
    Item 2 not only makes the xscale breakpoint code consistent with other targets,
    but also alerts the user immediately if an error occurs when writing the
    breakpoint instruction to target memory (previously, xscale_set_breakpoint() was
    not called until execution resumed).  Also, calling xscale_breakpoint_set() as
    part of the call chain starting with handle_bp_command() and propagating the
    return status back up the chain avoids the situation where OpenOCD "thinks" the
    breakpoint is set when in reality an error ocurred.
    
    Item 3 provides a helpful message for a common reason for failure to set sw
    breakpoint.
    
    This was thoroughly tested, mindful of the fact that breakpoint management is
    somewhat dicey during single-stepping.
    
    Comments and criticisms of course gratefully received.
    
    Mike
    
    Signed-off-by: Mike Dunn <mikedunn at newsguy.com>
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/xscale.c b/src/target/xscale.c
index 2b8bff1..82b0f34 100644
--- a/src/target/xscale.c
+++ b/src/target/xscale.c
@@ -1979,6 +1979,7 @@ static int xscale_write_memory(struct target *target, uint32_t address,
 		if ((retval = xscale_send_u32(target, 0x60)) != ERROR_OK)
 			return retval;
 
+		LOG_ERROR("data abort writing memory");
 		return ERROR_TARGET_DATA_ABORT;
 	}
 
@@ -2141,9 +2142,9 @@ static int xscale_set_breakpoint(struct target *target,
 			breakpoint->set = 2;	/* breakpoint set on second breakpoint register */
 		}
 		else
-		{
+		{	/* bug: availability previously verified in xscale_add_breakpoint() */
 			LOG_ERROR("BUG: no hardware comparator available");
-			return ERROR_OK;
+			return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
 		}
 	}
 	else if (breakpoint->type == BKPT_SOFT)
@@ -2169,7 +2170,7 @@ static int xscale_set_breakpoint(struct target *target,
 				return retval;
 			}
 			/* write the bkpt instruction in target endianness (arm7_9->arm_bkpt is host endian) */
-			if ((retval = target_write_u32(target, breakpoint->address, xscale->thumb_bkpt)) != ERROR_OK)
+			if ((retval = target_write_u16(target, breakpoint->address, xscale->thumb_bkpt)) != ERROR_OK)
 			{
 				return retval;
 			}
@@ -2207,7 +2208,7 @@ static int xscale_add_breakpoint(struct target *target,
 		xscale->ibcr_available--;
 	}
 
-	return ERROR_OK;
+	return xscale_set_breakpoint(target, breakpoint);
 }
 
 static int xscale_unset_breakpoint(struct target *target,

-----------------------------------------------------------------------

Summary of changes:
 src/target/xscale.c |    9 +++++----
 1 files changed, 5 insertions(+), 4 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Sep 14 11:19:24 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue, 14 Sep 2010 09:19:24 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-512-g1b0f194
Message-ID: <E1OvRfn-0008Fn-Vm@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  1b0f194d90f38e363939b7f11260fc64680016e1 (commit)
      from  35691065f72110d4490df3a127467ea9c04c70ca (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 1b0f194d90f38e363939b7f11260fc64680016e1
Author: Tak??cs ??ron <takacs.aron at infracont.hu>
Date:   Tue Sep 14 11:15:35 2010 +0200

    board scripts: Marvell PXA270M processor has a new TAPID: 0x89265013
    
    the new Marvell PXA270M processor has a new TAPID: 0x89265013.
    Attached you will find a patch for target/pxa270.cfg that will handle this.
    
    I have also attached a board/colibri.cfg file to support the Colibri
    PXA270 module by Toradex.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/tcl/board/colibri.cfg b/tcl/board/colibri.cfg
new file mode 100644
index 0000000..7c1f1cb
--- /dev/null
+++ b/tcl/board/colibri.cfg
@@ -0,0 +1,13 @@
+# Toradex Colibri PXA270
+source [find target/pxa270.cfg]
+reset_config trst_and_srst srst_push_pull
+adapter_nsrst_assert_width 40
+
+# CS0 -- one bank of CFI flash, 32 MBytes
+# the bank is 32-bits wide, two 16-bit chips in parallel
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x00000000 0x02000000 2 4 $_TARGETNAME
+
+
+
+
diff --git a/tcl/target/pxa270.cfg b/tcl/target/pxa270.cfg
index 7aaef8c..f5d2c85 100644
--- a/tcl/target/pxa270.cfg
+++ b/tcl/target/pxa270.cfg
@@ -27,6 +27,12 @@ if { [info exists CPUTAPID2 ] } {
    set _CPUTAPID2 0x79265013
 }
 
+if { [info exists CPUTAPID3 ] } {
+   set _CPUTAPID2 $CPUTAPID3
+} else {
+  # set useful default
+   set _CPUTAPID3 0x89265013
+}
 
 # set adapter_nsrst_delay to the delay introduced by your reset circuit
 # the rest of the needed delays are built into the openocd program
@@ -36,7 +42,7 @@ adapter_nsrst_delay 260
 jtag_ntrst_delay 250
 
 set _TARGETNAME $_CHIPNAME.cpu
-jtag newtap $_CHIPNAME cpu -irlen 7 -ircapture 0x1 -irmask 0x7f -expected-id $_CPUTAPID -expected-id $_CPUTAPID2
+jtag newtap $_CHIPNAME cpu -irlen 7 -ircapture 0x1 -irmask 0x7f -expected-id $_CPUTAPID -expected-id $_CPUTAPID2 -expected-id $_CPUTAPID3
 
 target create $_TARGETNAME xscale -endian $_ENDIAN -chain-position $_TARGETNAME -variant pxa27x
 # maps to PXA internal RAM. If you are using a PXA255

-----------------------------------------------------------------------

Summary of changes:
 tcl/board/colibri.cfg |   13 +++++++++++++
 tcl/target/pxa270.cfg |    8 +++++++-
 2 files changed, 20 insertions(+), 1 deletions(-)
 create mode 100644 tcl/board/colibri.cfg


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Sep 14 16:29:54 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue, 14 Sep 2010 14:29:54 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-513-g4a47d87
Message-ID: <E1OvWWG-0004VP-4L@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  4a47d87e4791a00cab4f420e23cd7d85aee0342b (commit)
      from  1b0f194d90f38e363939b7f11260fc64680016e1 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 4a47d87e4791a00cab4f420e23cd7d85aee0342b
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Sep 13 21:59:39 2010 +0200

    breakpoints: fix error handling
    
    do not try to interpret "retval" into a string, just
    amend a bit about the context of the already reported
    error.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/breakpoints.c b/src/target/breakpoints.c
index dc44642..917dfc7 100644
--- a/src/target/breakpoints.c
+++ b/src/target/breakpoints.c
@@ -46,7 +46,6 @@ int breakpoint_add(struct target *target, uint32_t address, uint32_t length, enu
 {
 	struct breakpoint *breakpoint = target->breakpoints;
 	struct breakpoint **breakpoint_p = &target->breakpoints;
-	char *reason;
 	int retval;
 	int n;
 
@@ -77,19 +76,9 @@ int breakpoint_add(struct target *target, uint32_t address, uint32_t length, enu
 	(*breakpoint_p)->unique_id = bpwp_unique_id++;
 
 	retval = target_add_breakpoint(target, *breakpoint_p);
-	switch (retval) {
-	case ERROR_OK:
-		break;
-	case ERROR_TARGET_RESOURCE_NOT_AVAILABLE:
-		reason = "resource not available";
-		goto fail;
-	case ERROR_TARGET_NOT_HALTED:
-		reason = "target running";
-		goto fail;
-	default:
-		reason = "unknown reason";
-fail:
-		LOG_ERROR("can't add breakpoint: %s", reason);
+	if (retval != ERROR_OK)
+	{
+		LOG_ERROR("could not add breakpoint");
 		free((*breakpoint_p)->orig_instr);
 		free(*breakpoint_p);
 		*breakpoint_p = NULL;
@@ -185,7 +174,6 @@ int watchpoint_add(struct target *target, uint32_t address, uint32_t length,
 	struct watchpoint *watchpoint = target->watchpoints;
 	struct watchpoint **watchpoint_p = &target->watchpoints;
 	int retval;
-	char *reason;
 
 	while (watchpoint)
 	{
@@ -216,21 +204,11 @@ int watchpoint_add(struct target *target, uint32_t address, uint32_t length,
 	(*watchpoint_p)->unique_id = bpwp_unique_id++;
 
 	retval = target_add_watchpoint(target, *watchpoint_p);
-	switch (retval) {
-	case ERROR_OK:
-		break;
-	case ERROR_TARGET_RESOURCE_NOT_AVAILABLE:
-		reason = "resource not available";
-		goto bye;
-	case ERROR_TARGET_NOT_HALTED:
-		reason = "target running";
-		goto bye;
-	default:
-		reason = "unrecognized error";
-bye:
-		LOG_ERROR("can't add %s watchpoint at 0x%8.8" PRIx32 ", %s",
+	if (retval != ERROR_OK)
+	{
+		LOG_ERROR("can't add %s watchpoint at 0x%8.8" PRIx32,
 			 watchpoint_rw_strings[(*watchpoint_p)->rw],
-			 address, reason);
+			 address);
 		free (*watchpoint_p);
 		*watchpoint_p = NULL;
 		return retval;

-----------------------------------------------------------------------

Summary of changes:
 src/target/breakpoints.c |   36 +++++++-----------------------------
 1 files changed, 7 insertions(+), 29 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Wed Sep 15 11:39:17 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Wed, 15 Sep 2010 09:39:17 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-514-gc148523
Message-ID: <E1OvoSb-00055I-6P@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  c14852385fde55abc5d5ffb076510cd1814432e0 (commit)
      from  4a47d87e4791a00cab4f420e23cd7d85aee0342b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit c14852385fde55abc5d5ffb076510cd1814432e0
Author: Flemming Futtrup <ffu at deif.com>
Date:   Wed Sep 15 11:34:57 2010 +0200

    cfi: add sst39vf6401b
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nor/cfi.c b/src/flash/nor/cfi.c
index 5b5b4da..43e19b5 100644
--- a/src/flash/nor/cfi.c
+++ b/src/flash/nor/cfi.c
@@ -57,6 +57,7 @@ static const struct cfi_fixup cfi_0002_fixups[] = {
 	{CFI_MFR_SST, 0x00D6, cfi_fixup_0002_unlock_addresses, &cfi_unlock_addresses[CFI_UNLOCK_5555_2AAA]},
 	{CFI_MFR_SST, 0x00D7, cfi_fixup_0002_unlock_addresses, &cfi_unlock_addresses[CFI_UNLOCK_5555_2AAA]},
 	{CFI_MFR_SST, 0x2780, cfi_fixup_0002_unlock_addresses, &cfi_unlock_addresses[CFI_UNLOCK_5555_2AAA]},
+	{CFI_MFR_SST, 0x236d, cfi_fixup_0002_unlock_addresses, &cfi_unlock_addresses[CFI_UNLOCK_555_2AA]},
 	{CFI_MFR_ATMEL, 0x00C8, cfi_fixup_reversed_erase_regions, NULL},
 	{CFI_MFR_ST,  0x22C4, cfi_fixup_reversed_erase_regions, NULL}, /* M29W160ET */
    {CFI_MFR_FUJITSU, 0x22ea, cfi_fixup_0002_unlock_addresses, &cfi_unlock_addresses[CFI_UNLOCK_555_2AA]},
diff --git a/src/flash/nor/non_cfi.c b/src/flash/nor/non_cfi.c
index 569ffc5..c68ace6 100644
--- a/src/flash/nor/non_cfi.c
+++ b/src/flash/nor/non_cfi.c
@@ -230,6 +230,20 @@ static struct non_cfi non_cfi_flashes[] = {
 		}
 	},
 	{
+	.mfr = CFI_MFR_SST,
+ 	    .id = 0x236d,               /* SST39VF6401B */
+ 	    .pri_id = 0x02,
+ 	    .dev_size = 8*MB,
+ 	    .interface_desc = 0x2,      /* x8 or x16 device with nBYTE */
+ 	    .max_buf_write_size = 0x0,
+ 	    .status_poll_mask = CFI_STATUS_POLL_MASK_DQ6_DQ7,
+ 	    .num_erase_regions = 1,
+ 	    .erase_region_info =
+ 	    {
+ 	        ERASE_REGION(2048, 4*KB)
+ 	    }
+ 	},
+ 	{
 		.mfr = CFI_MFR_AMD,
 		.id = 0x22ab,				/* AM29F400BB */
 		.pri_id = 0x02,

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/cfi.c     |    1 +
 src/flash/nor/non_cfi.c |   14 ++++++++++++++
 2 files changed, 15 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Sep 20 09:19:16 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 20 Sep 2010 07:19:16 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-515-g60501bb
Message-ID: <E1Oxaej-0005bs-ST@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  60501bb0fb0cb69f66ebb3ce3b64b69f3cadf4ff (commit)
      from  c14852385fde55abc5d5ffb076510cd1814432e0 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 60501bb0fb0cb69f66ebb3ce3b64b69f3cadf4ff
Author: Karl Kurbjun <kkurbjun at gmail.com>
Date:   Sat Sep 18 09:55:29 2010 -0600

    AM/DM37x: Unify configuration scripts and add support for TI Beagleboard xM.

diff --git a/tcl/board/am3517evm.cfg b/tcl/board/am3517evm.cfg
index db76255..2bff512 100644
--- a/tcl/board/am3517evm.cfg
+++ b/tcl/board/am3517evm.cfg
@@ -10,88 +10,12 @@
 # http://processors.wiki.ti.com/index.php/Debug_Access_Port_(DAP)
 # http://processors.wiki.ti.com/index.php?title=How_to_Find_the_Silicon_Revision_of_your_OMAP35x
 
-# Slooow during startup
-adapter_khz 10
+set CHIPTYPE "am35x"
+source [find target/amdm37x.cfg]
 
+# The TI-14 JTAG connector does not have srst.  CPU reset is handled in
+# hardware.
+reset_config trst_only
 
-if { [info exists CHIPNAME] } {
-   set  _CHIPNAME $CHIPNAME
-} else {
-   set  _CHIPNAME am3517
-}
-
-set JRC_TAPID 0
-
-set DAP_TAPID 0x0b86802f
-
-# Subsidiary TAP: CoreSight Debug Access Port (DAP)
-if { [info exists DAP_TAPID ] } {
-   set _DAP_TAPID $DAP_TAPID
-} else {
-   set _DAP_TAPID 0x0b6d602f
-}
-
-
-# Primary TAP: ICEpick-C (JTAG route controller) and boundary scan
-if { [info exists JRC_TAPID ] } {
-   set _JRC_TAPID $JRC_TAPID
-} else {
-   set _JRC_TAPID 0x0b7ae02f
-}
-
-# ICEpick-C ... used to route Cortex, and more not shown here
-source [find target/icepick.cfg]
-
-
-jtag newtap $_CHIPNAME dap -irlen 4 -ircapture 0x1 -irmask 0xf \
-	-expected-id $_DAP_TAPID -disable
-jtag configure $_CHIPNAME.dap -event tap-enable \
-	"icepick_c_tapenable $_CHIPNAME.jrc 3"
-
-jtag newtap $_CHIPNAME jrc -irlen 6 -ircapture 0x1 -irmask 0x3f \
-	-expected-id $_JRC_TAPID
-
-
-
-# GDB target:  Cortex-A8, using DAP
-set _TARGETNAME $_CHIPNAME.cpu
-target create $_TARGETNAME cortex_a8 -chain-position $_CHIPNAME.dap
-
-# SRAM: 64K at 0x4020.0000; use the first 16K
-$_TARGETNAME configure -work-area-phys 0x40200000 -work-area-size 0x4000
-
-###################
-
-# the reset sequence is event-driven
-# and kind of finicky...
-
-# some TCK tycles are required to activate the DEBUG power domain
-jtag configure $_CHIPNAME.jrc -event post-reset "runtest 100"
-
-# have the DAP "always" be active
-jtag configure $_CHIPNAME.jrc -event setup "jtag tapenable $_CHIPNAME.dap"
-
-proc omap3_dbginit {target} {
-
-     # General Cortex A8 debug initialisation
-     cortex_a8 dbginit
-     # Enable DBGU signal for OMAP353x
-     $target mww phys 0x5401d030 0x00002000
-}
-
-# be absolutely certain the JTAG clock will work with the worst-case
-# 16.8MHz/2 = 8.4MHz core clock, even before a bootloader kicks in.
-# OK to speed up *after* PLL and clock tree setup.
-
-$_TARGETNAME configure -event "reset-start" { adapter_khz 10}
-
-# Assume SRST is unavailable (e.g. TI-14 JTAG), so we must assert reset
-# ourselves using PRM_RSTCTRL.  RST_GS (2) is a warm reset, like ICEpick
-# would issue.  RST_DPLL3 (4) is a cold reset.
-set PRM_RSTCTRL 0x48307250
-$_TARGETNAME configure -event reset-assert "$_TARGETNAME mww phys $PRM_RSTCTRL 2"
-
-$_TARGETNAME configure -event reset-assert-post "omap3_dbginit $_TARGETNAME; adapter_khz 1000"
-
+# "amdm37x_dbginit am35x.cpu" needs to be run after init.
 
-reset_config trst_only
diff --git a/tcl/board/ti_beagleboard_xm.cfg b/tcl/board/ti_beagleboard_xm.cfg
new file mode 100644
index 0000000..e4e93e3
--- /dev/null
+++ b/tcl/board/ti_beagleboard_xm.cfg
@@ -0,0 +1,12 @@
+# BeagleBoard xM (DM37x)
+#  http://beagleboard.org
+
+set CHIPTYPE "dm37x"
+source [find target/amdm37x.cfg]
+
+# The TI-14 JTAG connector does not have srst.  CPU reset is handled in
+# hardware.
+reset_config trst_only
+
+# "amdm37x_dbginit dm37x.cpu" needs to be run after init.
+
diff --git a/tcl/target/amdm37x.cfg b/tcl/target/amdm37x.cfg
new file mode 100644
index 0000000..ab18681
--- /dev/null
+++ b/tcl/target/amdm37x.cfg
@@ -0,0 +1,203 @@
+#
+# Copyright (C)   2010        by Karl Kurbjun
+# Copyright (C)   2009, 2010  by ??yvind Harboe
+# Copyright (C)   2009        by David Brownell
+# Copyright (C)   2009        by Magnus Lundin
+#
+# TI AM/DM37x
+#  http://www.ti.com/litv/pdf/sprugn4b
+#
+# This script is based on the AM3517 initialization.  It should be considered
+# preliminary since it needs more complete testing and only the basic
+# operations work.
+#
+
+###############################################################################
+# User modifiable parameters
+###############################################################################
+
+# This script uses the variable CHIPTYPE to determine whether this is an AM35x
+# or DM37x target. If CHIPTYPE is not set it will error out.
+if { [info exists CHIPTYPE] } {
+
+   if { [info exists CHIPNAME] } {
+      set  _CHIPNAME $CHIPNAME
+   } else {
+      set  _CHIPNAME $CHIPTYPE
+   }
+
+   switch $CHIPTYPE {
+      dm37x {
+         # Primary TAP: ICEpick-C (JTAG route controller) and boundary scan
+         set _JRC_TAPID 0x0b89102f
+      }
+      am35x {
+         # Primary TAP: ICEpick-C (JTAG route controller) and boundary scan
+         set _JRC_TAPID 0x0b7ae02f
+      }
+      default {
+         error "ERROR: CHIPTYPE was set, but it was not set to a valid value.  Acceptable values are \"dm37x\" or \"am35x\"."
+      }
+   }
+} else {
+  error "ERROR: CHIPTYPE was not defined. Please set CHIPTYPE to \"am35x\" for the AM35x or \"dm37x\" for the DM37x series in the board configuration."
+}
+
+# Run the adapter at the fastest acceptable speed with the slowest possible
+# core clock.
+adapter_khz 10
+
+###############################################################################
+# JTAG setup
+# The OpenOCD commands are described in the TAP Declaration section
+#  http://openocd.berlios.de/doc/html/TAP-Declaration.html
+###############################################################################
+
+# The AM/DM37x has an ICEpick module in it like many of TI's other devices. More
+#  can be read about this module in sprugn4b under chapter 27:  "Debug and
+#  Emulation".  The module is used to route the JTAG chain to the various
+#  subsystems in the chip.
+source [find target/icepick.cfg]
+
+# The TAP order should be described from the TDO connection in OpenOCD to the
+#  TDI pin.  The OpenOCD FAQ describes this in more detail:
+#  http://openocd.berlios.de/doc/html/FAQ.html
+
+# From SPRUGN4B CH27 the available secondary TAPs are in this order from TDO:
+#
+#  Device   |  TAP number
+#  ---------|------------
+#  DAP      |  3
+#  Sequencer|  2   Note: The sequencer is an ARM968
+#  DSP      |  1
+#  D2D      |  0
+#
+# Right now the only secondary tap enabled is the DAP so the rest are left
+# undescribed.
+
+######
+# Start of Chain Description
+# The Secondary TAPs all have enable functions defined for use with the ICEpick
+# Only the DAP is enabled.  The AM37xx does not have the Sequencer or DSP but
+# the TAP numbers for ICEpick do not change.
+#
+# TODO: A disable function should also be added.
+######
+
+# Secondary TAP: DAP is closest to the TDO output
+# The TAP enable event also needs to be described
+jtag newtap $_CHIPNAME dap -irlen 4 -ircapture 0x1 -irmask 0xf -disable
+jtag configure $_CHIPNAME.dap -event tap-enable \
+   "icepick_c_tapenable $_CHIPNAME.jrc 3"
+
+# These taps are only present in the DM37x series.
+if { $CHIPTYPE == "dm37x" } {
+   # Secondary TAP: Sequencer (ARM968) it is not in the chain by default
+   # The ICEpick can be used to enable it in the chain.
+   jtag newtap $_CHIPNAME arm2 -irlen 4 -ircapture 0x1 -irmask 0x0f -disable
+   jtag configure $_CHIPNAME.arm2 -event tap-enable \
+      "icepick_c_tapenable $_CHIPNAME.jrc 2"
+
+   # Secondary TAP: C64x+ DSP - it is not in the chain by default (-disable)
+   # The ICEpick can be used to enable it in the chain.
+   jtag newtap $_CHIPNAME dsp -irlen 38 -ircapture 0x25 -irmask 0x3f -disable
+   jtag configure $_CHIPNAME.dsp -event tap-enable \
+      "icepick_c_tapenable $_CHIPNAME.jrc 1"
+}
+
+# Secondary TAP: D2D it is not in the chain by default (-disable)
+# The ICEpick can be used to enable it in the chain.
+# This IRLEN is probably incorrect - not sure where the documentation is.
+jtag newtap $_CHIPNAME d2d -irlen 4 -ircapture 0x1 -irmask 0x0f -disable
+jtag configure $_CHIPNAME.d2d -event tap-enable \
+   "icepick_c_tapenable $_CHIPNAME.jrc 0"
+
+# Primary TAP: ICEpick - it is closest to TDI so last in the chain
+jtag newtap $_CHIPNAME jrc -irlen 6 -ircapture 0x1 -irmask 0x3f \
+   -expected-id $_JRC_TAPID
+	
+######
+# End of Chain Description
+######
+
+######
+# Start JTAG TAP events
+######
+
+# some TCK tycles are required to activate the DEBUG power domain
+jtag configure $_CHIPNAME.jrc -event post-reset "runtest 100"
+
+# Enable the DAP TAP
+jtag configure $_CHIPNAME.jrc -event setup "jtag tapenable $_CHIPNAME.dap"
+
+######
+# End JTAG TAP events
+######
+
+###############################################################################
+# Target Setup:
+# This section is described in the OpenOCD documentation under CPU Configuration
+#  http://openocd.berlios.de/doc/html/CPU-Configuration.html
+###############################################################################
+
+# Create the CPU target to be used with GDB:  Cortex-A8, using DAP
+set _TARGETNAME $_CHIPNAME.cpu
+target create $_TARGETNAME cortex_a8 -chain-position $_CHIPNAME.dap
+
+# The DM37x has 64K of SRAM starting at address 0x4020_0000.  Allow the first
+# 16K to be used as a scratchpad for OpenOCD.
+
+$_TARGETNAME configure -work-area-phys 0x40200000 -work-area-size 0x4000
+
+######
+# Start Target Reset Event Setup:
+######
+
+# Set the JTAG clock down to 10 kHz to be sure that it will work with the
+#  slowest possible core clock (16.8MHz/2 = 8.4MHz). It is OK to speed up 
+#  *after* PLL and clock tree setup.
+
+$_TARGETNAME configure -event "reset-start" { adapter_khz 10 }
+
+# Reset needs to be performed in in software.
+# The AM/DM37x TRM (sprugn4b) describes the software reset in detail.
+# PRM_RSTCTRL is described in table 3-425 on page 618.  We assert RST_GS
+# (bit 1 (in 31:0) ) to do a warm reset.
+
+# Create a vaiable for the register address
+set PRM_RSTCTRL 0x48307250
+
+# Describe the reset assert process: A value of 2 must be written 
+# (assert bit 1) to the physical address of PRM_RSTCTRL.
+
+$_TARGETNAME configure -event \
+   reset-assert "$_TARGETNAME mww phys $PRM_RSTCTRL 2"
+
+# After the reset is asserted we need to re-initialize debugging and speed up
+# the JTAG clock.
+
+$_TARGETNAME configure -event \
+   reset-assert-post "amdm37x_dbginit $_TARGETNAME; adapter_khz 1000"
+
+######
+# End Target Reset Event Setup:
+######
+
+###############################################################################
+# Target Functions
+# Add any functions needed for the target here
+###############################################################################
+
+# Run this to enable invasive debugging.  This is run automatically in the
+# reset sequence.
+proc amdm37x_dbginit {target} {
+   # General Cortex A8 debug initialisation
+   cortex_a8 dbginit
+   
+   # Enable DBGEN signal.  This signal is described in the ARM v7 TRM, but 
+   # access to the signal appears to be implementation specific.  TI does not
+   # describe this register much except a quick line that states DBGEM (sic) is
+   # at this address and this bit.
+   $target mww phys 0x5401d030 0x00002000
+}
+

-----------------------------------------------------------------------

Summary of changes:
 tcl/board/am3517evm.cfg         |   88 +----------------
 tcl/board/ti_beagleboard_xm.cfg |   12 +++
 tcl/target/amdm37x.cfg          |  203 +++++++++++++++++++++++++++++++++++++++
 3 files changed, 221 insertions(+), 82 deletions(-)
 create mode 100644 tcl/board/ti_beagleboard_xm.cfg
 create mode 100644 tcl/target/amdm37x.cfg


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Sep 20 09:22:54 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 20 Sep 2010 07:22:54 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-518-g103c1f9
Message-ID: <E1OxaiI-0004Lf-1a@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  103c1f9525436892b610b37d5efc4f2635f5a832 (commit)
       via  ebfb2f4f3715f264ae4474c1b2e78812d1625cdc (commit)
       via  7e888741d13e66b6b343b8f0839621107c5a2962 (commit)
      from  60501bb0fb0cb69f66ebb3ce3b64b69f3cadf4ff (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 103c1f9525436892b610b37d5efc4f2635f5a832
Author: Mike Dunn <mikedunn at newsguy.com>
Date:   Sun Sep 19 15:30:59 2010 -0700

    xscale: some wp detail added to user manual
    
    Hi everyone (again),
    
    Watchpoints on xscale are quirky, so I thought a little explanation in the
    user's manual was warranted.
    
    Comments gratefully received.
    
    Last one, ??yvind :-)
    
    Thanks,
    Mike
    
    Signed-off-by: Mike Dunn <mikedunn at newsguy.com>

diff --git a/doc/openocd.texi b/doc/openocd.texi
index bc026b9..230e47c 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -6390,6 +6390,15 @@ the @code{xscale debug_handler} command.  The allowed locations for the
 debug handler are either (0x800 - 0x1fef800) or (0xfe000800 -
 0xfffff800). The default value is 0xfe000800.
 
+XScale has resources to support two hardware breakpoints and two
+watchpoints.  However, the following restrictions on watchpoint
+functionality apply: (1) the value and mask arguments to the @code{wp}
+command are not supported, (2) the watchpoint length must be a
+power of two and not less than four, and can not be greater than the
+watchpoint address, and (3) a watchpoint with a length greater than
+four consumes all the watchpoint hardware resources.  This means that
+at any one time, you can have enabled either two watchpoints with a
+length of four, or one watchpoint with a length greater than four.
 
 These commands are available to XScale based CPUs,
 which are implementations of the ARMv5TE architecture.

commit ebfb2f4f3715f264ae4474c1b2e78812d1625cdc
Author: Mike Dunn <mikedunn at newsguy.com>
Date:   Sun Sep 19 14:48:51 2010 -0700

    xscale: check that wp length does not exceed address
    
    Hi everyone,
    
    A while back I sent in a patch that adds support for watchpoint lengths greater
    than four on xscale.  It's been working well, until the other day, when it
    caused an unexpected debug exception.  Looking into this I realized there is a
    case where it breaks: when the length arg is greater than the base address.
    This is a consequence of the way the hardware works.  Don't see a work-around,
    so I added code to xscale_add_watchpoint() to check for and disallow this
    combination.
    
    Some more detail... xscale watchpoint hardware does not support a length
    directly.  Instead, a mask value can be specified (not to be confused with the
    optional mask arg to the wp command, which xscale does not support).  Any bits
    set in the mask are ignored when the watchpoint hardware compares the access
    address to the watchpoint address.  So as long as the length is a power of two,
    setting the mask to length-1 effectively specifies the length.  Or so I thought,
    until I realized that if the length exceeds the base address, *all* bits of the
    base address are ignored by the comaparator, and the watchpoint range
    effectively becomes 0 .. length.
    
    Questions, comments, criticisms gratefully received.
    
    Thanks,
    Mike
    
    Signed-off-by: Mike Dunn <mikedunn at newsguy.com>

diff --git a/src/target/xscale.c b/src/target/xscale.c
index 77f0f1b..37a2438 100644
--- a/src/target/xscale.c
+++ b/src/target/xscale.c
@@ -2401,6 +2401,13 @@ static int xscale_add_watchpoint(struct target *target,
 	   return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
 	}
 	
+	if (watchpoint->length > watchpoint->address)
+	{
+	   LOG_ERROR("xscale does not support watchpoints with length "
+				 "greater than address");
+	   return ERROR_COMMAND_ARGUMENT_INVALID;
+	}
+	   
 	xscale->dbr_available = 0;
 	return ERROR_OK;
 }

commit 7e888741d13e66b6b343b8f0839621107c5a2962
Author: Mike Dunn <mikedunn at newsguy.com>
Date:   Sun Sep 19 14:35:46 2010 -0700

    xscale: bp/wp: additional LOG_ERROR on failure
    
    Hi everyone,
    
    Added more LOG_ERROR messsages to watchpoint and breakpoint code, given that the
    infrastructure no longer interprets returned error codes.  Also changed
    existing LOG_INFO and LOG_WARNING to LOG_ERROR for cases where an error is
    returned.
    
    Note that the check of the target state is superflous, since the infrastruture
    code currently checks this before calling target code.  Is this being
    reconsidered as well?  Also, should we stop returning anything other than
    ERROR_OK and ERROR_FAIL?
    
    Comments gratefully received.
    
    Thanks,
    Mike
    
    Signed-off-by: Mike Dunn <mikedunn at newsguy.com>

diff --git a/src/target/xscale.c b/src/target/xscale.c
index 82b0f34..77f0f1b 100644
--- a/src/target/xscale.c
+++ b/src/target/xscale.c
@@ -2193,13 +2193,13 @@ static int xscale_add_breakpoint(struct target *target,
 
 	if ((breakpoint->type == BKPT_HARD) && (xscale->ibcr_available < 1))
 	{
-		LOG_INFO("no breakpoint unit available for hardware breakpoint");
+		LOG_ERROR("no breakpoint unit available for hardware breakpoint");
 		return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
 	}
 
 	if ((breakpoint->length != 2) && (breakpoint->length != 4))
 	{
-		LOG_INFO("only breakpoints of two (Thumb) or four (ARM) bytes length supported");
+		LOG_ERROR("only breakpoints of two (Thumb) or four (ARM) bytes length supported");
 		return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
 	}
 
@@ -2277,7 +2277,7 @@ static int xscale_remove_breakpoint(struct target *target, struct breakpoint *br
 
 	if (target->state != TARGET_HALTED)
 	{
-		LOG_WARNING("target not halted");
+		LOG_ERROR("target not halted");
 		return ERROR_TARGET_NOT_HALTED;
 	}
 
@@ -2302,7 +2302,7 @@ static int xscale_set_watchpoint(struct target *target,
 
 	if (target->state != TARGET_HALTED)
 	{
-		LOG_WARNING("target not halted");
+		LOG_ERROR("target not halted");
 		return ERROR_TARGET_NOT_HALTED;
 	}
 
@@ -2371,7 +2371,8 @@ static int xscale_add_watchpoint(struct target *target,
 
 	if (xscale->dbr_available < 1)
 	{
-		return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
+	   LOG_ERROR("no more watchpoint registers available");
+	   return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
 	}
 
 	if (watchpoint->value)
@@ -2395,7 +2396,10 @@ static int xscale_add_watchpoint(struct target *target,
 
 	/* watchpoints across multiple words require both DBR registers */
 	if (xscale->dbr_available < 2)
+	{
+	   LOG_ERROR("insufficient watchpoint registers available");
 	   return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
+	}
 	
 	xscale->dbr_available = 0;
 	return ERROR_OK;
@@ -2450,7 +2454,7 @@ static int xscale_remove_watchpoint(struct target *target, struct watchpoint *wa
 
 	if (target->state != TARGET_HALTED)
 	{
-		LOG_WARNING("target not halted");
+		LOG_ERROR("target not halted");
 		return ERROR_TARGET_NOT_HALTED;
 	}
 

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi    |    9 +++++++++
 src/target/xscale.c |   23 +++++++++++++++++------
 2 files changed, 26 insertions(+), 6 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Sep 20 09:25:24 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 20 Sep 2010 07:25:24 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-519-gf613011
Message-ID: <E1Oxakg-0003LW-40@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  f613011aa0232d1cc8a9db1e739fa63ccf5ffcfa (commit)
      from  103c1f9525436892b610b37d5efc4f2635f5a832 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit f613011aa0232d1cc8a9db1e739fa63ccf5ffcfa
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Sep 20 09:23:24 2010 +0200

    tcl: remove incomplete unused tcl file
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/tcl/readable.tcl b/tcl/readable.tcl
deleted file mode 100644
index bd2dc7f..0000000
--- a/tcl/readable.tcl
+++ /dev/null
@@ -1,24 +0,0 @@
-proc iswithin { ADDRESS BASE LEN } {
-    return [expr ((($ADDRESS - $BASE) > 0) && (($ADDRESS - $BASE + $LEN) > 0))]
-}
-
-proc memorytype { ADDRESS } {
-    for { set chip 0 } { $chip < $N_CHIP } { incr chip } {
-	if { iswithin $ADDRESS $FLASH($chip,BASE) $FLASH($chip,LEN) } {
-	    return "flash"
-	}
-    }
-
-    for { set chip 0 } { $chip < $N_RAM } { incr chip } {
-	if { iswithin $ADDRESS $RAM($chip,BASE) $RAM($chip,LEN) } {
-	    return "ram"
-	}
-    }
-}
-
-# default to 32bit reads.
-proc isreadable { ADDRESS } {
-     return isreadable32 $ADDRESS
-}
-
-proc isreadable32 { ADDRESS } {

-----------------------------------------------------------------------

Summary of changes:
 tcl/readable.tcl |   24 ------------------------
 1 files changed, 0 insertions(+), 24 deletions(-)
 delete mode 100644 tcl/readable.tcl


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Sep 20 13:13:04 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 20 Sep 2010 11:13:04 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-520-g1dbb7ba
Message-ID: <E1OxeJ1-0003Zw-Kn@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  1dbb7ba47259f99905b590d6118771113edfc142 (commit)
      from  f613011aa0232d1cc8a9db1e739fa63ccf5ffcfa (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 1dbb7ba47259f99905b590d6118771113edfc142
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Tue Sep 7 20:22:38 2010 +0200

    zy1000: remove obsolete debug code
    
    Obsolete code clutter
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/jtag/zy1000/jtag_minidriver.h b/src/jtag/zy1000/jtag_minidriver.h
index 7e13f66..4e99d3c 100644
--- a/src/jtag/zy1000/jtag_minidriver.h
+++ b/src/jtag/zy1000/jtag_minidriver.h
@@ -25,15 +25,8 @@
 
 #include <cyg/hal/hal_io.h>             // low level i/o
 #include <cyg/hal/hal_intr.h>             // low level i/o
-
-#if 0
-int  diag_printf(const char *fmt, ...);
-#define ZY1000_POKE(a, b) HAL_WRITE_UINT32(a, b); diag_printf("poke 0x%08x,0x%08x\n", a, b)
-#define ZY1000_PEEK(a, b) HAL_READ_UINT32(a, b); diag_printf("peek 0x%08x = 0x%08x\n", a, b)
-#else
 #define ZY1000_PEEK(a, b) HAL_READ_UINT32(a, b)
 #define ZY1000_POKE(a, b) HAL_WRITE_UINT32(a, b)
-#endif
 
 #else
 

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/zy1000/jtag_minidriver.h |    7 -------
 1 files changed, 0 insertions(+), 7 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Sep 20 13:14:06 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 20 Sep 2010 11:14:06 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-521-g32ab98c
Message-ID: <E1OxeK5-0003V9-SB@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  32ab98c9e9672d0f1d8758c7dfb478b0316c13af (commit)
      from  1dbb7ba47259f99905b590d6118771113edfc142 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 32ab98c9e9672d0f1d8758c7dfb478b0316c13af
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Tue Sep 7 20:19:05 2010 +0200

    zy1000: split out configure option for eCos and JTAG master
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/configure.in b/configure.in
index 7f31e1d..a15b80a 100644
--- a/configure.in
+++ b/configure.in
@@ -408,6 +408,10 @@ AC_ARG_ENABLE(ecosboard,
   AS_HELP_STRING([--enable-ecosboard], [Enable building support for eCos based JTAG debugger]),
   [build_ecosboard=$enableval], [build_ecosboard=no])
 
+AC_ARG_ENABLE(zy1000_master,
+  AS_HELP_STRING([--enable-zy1000-master], [Use ZY1000 JTAG master registers]),
+  [build_zy1000_master=$enableval], [build_zy1000_master=no])
+
 AC_ARG_ENABLE(zy1000,
   AS_HELP_STRING([--enable-zy1000], [Enable ZY1000 interface]),
   [build_zy1000=$enableval], [build_zy1000=no])
@@ -626,6 +630,12 @@ else
   AC_DEFINE(BUILD_ZY1000, 0, [0 if you don't want ZY1000.])
 fi
 
+if test $build_zy1000_master = yes; then
+  AC_DEFINE(BUILD_ZY1000_MASTER, 1, [1 if you want ZY1000 JTAG master registers.])
+else
+  AC_DEFINE(BUILD_ZY1000_MASTER, 0, [0 if you don't want ZY1000 JTAG master registers.])
+fi
+
 if test $build_at91rm9200 = yes; then
   build_bitbang=yes
   AC_DEFINE(BUILD_AT91RM9200, 1, [1 if you want at91rm9200.])
@@ -1027,6 +1037,7 @@ AM_CONDITIONAL(GIVEIO, test x$parport_use_giveio = xyes)
 AM_CONDITIONAL(EP93XX, test $build_ep93xx = yes)
 AM_CONDITIONAL(ECOSBOARD, test $build_ecosboard = yes)
 AM_CONDITIONAL(ZY1000, test $build_zy1000 = yes)
+AM_CONDITIONAL(ZY1000_MASTER, test $build_zy1000_master = yes)
 AM_CONDITIONAL(IOUTIL, test $build_ioutil = yes)
 AM_CONDITIONAL(HTTPD, test $build_httpd = yes)
 AM_CONDITIONAL(AT91RM9200, test $build_at91rm9200 = yes)

-----------------------------------------------------------------------

Summary of changes:
 configure.in |   11 +++++++++++
 1 files changed, 11 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Sep 20 13:18:53 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 20 Sep 2010 11:18:53 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-522-gf6a3fc8
Message-ID: <E1OxeOc-00041T-KY@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  f6a3fc818bc6a24b6c5bbcc6057f72d2b0b2e2ab (commit)
      from  32ab98c9e9672d0f1d8758c7dfb478b0316c13af (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit f6a3fc818bc6a24b6c5bbcc6057f72d2b0b2e2ab
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Fri Sep 3 22:49:37 2010 +0200

    warnings: fix alignment warnings
    
    These warnings are for architectures that do not
    support non-aligned word access.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/mflash.c b/src/flash/mflash.c
index 4372128..26b85b1 100644
--- a/src/flash/mflash.c
+++ b/src/flash/mflash.c
@@ -1121,7 +1121,7 @@ static int mg_storage_config(void)
 			!= ERROR_OK)
 		return ret;
 
-	mg_gen_ataid((mg_io_type_drv_info *)buff);
+	mg_gen_ataid((mg_io_type_drv_info *)(void *)buff);
 
 	if ((ret = mg_mflash_do_write_sects(buff, 0, 1, mg_vcmd_update_stgdrvinfo))
 			!= ERROR_OK)
@@ -1149,7 +1149,7 @@ static int mg_boot_config(void)
 	buff[0] = mg_op_mode_snd;		/* operation mode */
 	buff[1] = MG_UNLOCK_OTP_AREA;
 	buff[2] = 4;				/* boot size */
-	*((uint32_t *)(buff + 4)) = 0;		/* XIP size */
+	*((uint32_t *)(void *)(buff + 4)) = 0;		/* XIP size */
 
 	if ((ret = mg_mflash_do_write_sects(buff, 0, 1, mg_vcmd_update_xipinfo))
 			!= ERROR_OK)
diff --git a/src/flash/nand/lpc3180.c b/src/flash/nand/lpc3180.c
index 93d00d5..d81443d 100644
--- a/src/flash/nand/lpc3180.c
+++ b/src/flash/nand/lpc3180.c
@@ -1119,9 +1119,9 @@ static int lpc3180_read_page(struct nand_device *nand, uint32_t page, uint8_t *d
                     target_read_memory(target, target_mem_base+SPARE_OFFS, 4, 16, ecc_flash_buffer);
                     target_read_memory(target, target_mem_base+ECC_OFFS, 4, 8, ecc_hw_buffer);
                     for(i=0;i<idx;i++){
-                        if( (0x00ffffff&*(uint32_t *)(ecc_hw_buffer+i*8)) != (0x00ffffff&*(uint32_t *)(ecc_flash_buffer+8+i*16)) )
+                        if( (0x00ffffff&*(uint32_t *)(void *)(ecc_hw_buffer+i*8)) != (0x00ffffff&*(uint32_t *)(void *)(ecc_flash_buffer+8+i*16)) )
                             LOG_WARNING("ECC mismatch at 256 bytes size block= %d at page= 0x%" PRIx32,i*2+1,page);
-                        if( (0x00ffffff&*(uint32_t *)(ecc_hw_buffer+4+i*8)) != (0x00ffffff&*(uint32_t *)(ecc_flash_buffer+12+i*16)) )
+                        if( (0x00ffffff&*(uint32_t *)(void *)(ecc_hw_buffer+4+i*8)) != (0x00ffffff&*(uint32_t *)(void *)(ecc_flash_buffer+12+i*16)) )
                             LOG_WARNING("ECC mismatch at 256 bytes size block= %d at page= 0x%" PRIx32,i*2+2,page);
                     }                
                 }
diff --git a/src/flash/nor/at91sam3.c b/src/flash/nor/at91sam3.c
index 221832c..8005fe0 100644
--- a/src/flash/nor/at91sam3.c
+++ b/src/flash/nor/at91sam3.c
@@ -1702,7 +1702,7 @@ sam3_get_reg_ptr(struct sam3_cfg *pCfg, const struct sam3_reg_list *pList)
 	// By using prototypes - we can detect what would
 	// be casting errors.
 
-	return ((uint32_t *)(((char *)(pCfg)) + pList->struct_offset));
+	return ((uint32_t *)(void *)(((char *)(pCfg)) + pList->struct_offset));
 }
 
 
@@ -1756,7 +1756,7 @@ sam3_GetReg(struct sam3_chip *pChip, uint32_t *goes_here)
 		// calculate where this one go..
 		// it is "possibly" this register.
 
-		pPossible = ((uint32_t *)(((char *)(&(pChip->cfg))) + pReg->struct_offset));
+		pPossible = ((uint32_t *)(void *)(((char *)(&(pChip->cfg))) + pReg->struct_offset));
 
 		// well? Is it this register
 		if (pPossible == goes_here) {
diff --git a/src/helper/types.h b/src/helper/types.h
index 1010dcd..04b0059 100644
--- a/src/helper/types.h
+++ b/src/helper/types.h
@@ -80,7 +80,7 @@ typedef bool _Bool;
  */
 #define container_of(ptr, type, member) ({			\
 	const typeof( ((type *)0)->member ) *__mptr = (ptr);	\
-	(type *)( (char *)__mptr - offsetof(type,member) );})
+	(type *)( (void *) ( (char *)__mptr - offsetof(type,member) ) );})
 
 
 /**
diff --git a/src/pld/virtex2.c b/src/pld/virtex2.c
index 1963736..f4657bc 100644
--- a/src/pld/virtex2.c
+++ b/src/pld/virtex2.c
@@ -78,7 +78,7 @@ static int virtex2_send_32(struct pld_device *pld_device,
 static __inline__ void virtexflip32(jtag_callback_data_t arg)
 {
   uint8_t *in = (uint8_t *)arg;
-	*((uint32_t *)in) = flip_u32(le_to_h_u32(in), 32);
+	*((uint32_t *)arg) = flip_u32(le_to_h_u32(in), 32);
 }
 
 static int virtex2_receive_32(struct pld_device *pld_device,
diff --git a/src/target/arm11.c b/src/target/arm11.c
index 85d45b0..9955143 100644
--- a/src/target/arm11.c
+++ b/src/target/arm11.c
@@ -901,7 +901,7 @@ static int arm11_read_memory_inner(struct target *target,
 		{
 		uint32_t instr = !arm11_config_memrw_no_increment ? 0xecb05e01 : 0xed905e00;
 		/** \todo TODO: buffer cast to uint32_t* causes alignment warnings */
-		uint32_t *words = (uint32_t *)buffer;
+		uint32_t *words = (uint32_t *)(void *)buffer;
 
 		/* LDC p14,c5,[R0],#4 */
 		/* LDC p14,c5,[R0] */
@@ -1023,7 +1023,7 @@ static int arm11_write_memory_inner(struct target *target,
 		uint32_t instr = !no_increment ? 0xeca05e01 : 0xed805e00;
 
 		/** \todo TODO: buffer cast to uint32_t* causes alignment warnings */
-		uint32_t *words = (uint32_t*)buffer;
+		uint32_t *words = (uint32_t*)(void *)buffer;
 
 		/* "burst" here just means trusting each instruction executes
 		 * fully before we run the next one:  per-word roundtrips, to
diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index b26175b..3414796 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -316,7 +316,7 @@ int mem_ap_write_buf_u32(struct adiv5_dap *dap, uint8_t *buffer, int count, uint
 		for (writecount = 0; writecount < blocksize; writecount++)
 		{
 			retval = dap_queue_ap_write(dap, AP_REG_DRW,
-				*(uint32_t *) (buffer + 4 * writecount));
+				*(uint32_t *) ((void *) (buffer + 4 * writecount)));
 			if (retval != ERROR_OK)
 				break;
 		}
diff --git a/src/target/arm_jtag.h b/src/target/arm_jtag.h
index f581278..e90abfe 100644
--- a/src/target/arm_jtag.h
+++ b/src/target/arm_jtag.h
@@ -77,13 +77,13 @@ int arm_jtag_setup_connection(struct arm_jtag *jtag_info);
 static __inline__ void arm7flip32(jtag_callback_data_t arg)
 {
   uint8_t *in = (uint8_t *)arg;
-  *((uint32_t *)in) = flip_u32(le_to_h_u32(in), 32);
+  *((uint32_t *)arg) = flip_u32(le_to_h_u32(in), 32);
 }
 
 static __inline__ void arm_le_to_h_u32(jtag_callback_data_t arg)
 {
   uint8_t *in = (uint8_t *)arg;
-  *((uint32_t *)in) = le_to_h_u32(in);
+  *((uint32_t *)arg) = le_to_h_u32(in);
 }
 
 
diff --git a/src/target/avr32_ap7k.c b/src/target/avr32_ap7k.c
index a5cdbe4..ed10847 100644
--- a/src/target/avr32_ap7k.c
+++ b/src/target/avr32_ap7k.c
@@ -499,10 +499,10 @@ static int avr32_ap7k_read_memory(struct target *target, uint32_t address,
 	switch (size)
 	{
 	case 4:
-		return avr32_jtag_read_memory32(&ap7k->jtag, address, count, (uint32_t*)buffer);
+		return avr32_jtag_read_memory32(&ap7k->jtag, address, count, (uint32_t*)(void *)buffer);
 		break;
 	case 2:
-		return avr32_jtag_read_memory16(&ap7k->jtag, address, count, (uint16_t*)buffer);
+		return avr32_jtag_read_memory16(&ap7k->jtag, address, count, (uint16_t*)(void *)buffer);
 		break;
 	case 1:
 		return avr32_jtag_read_memory8(&ap7k->jtag, address, count, buffer);
@@ -537,10 +537,10 @@ static int avr32_ap7k_write_memory(struct target *target, uint32_t address,
 	switch (size)
 	{
 	case 4:
-		return avr32_jtag_write_memory32(&ap7k->jtag, address, count, (uint32_t*)buffer);
+		return avr32_jtag_write_memory32(&ap7k->jtag, address, count, (uint32_t*)(void *)buffer);
 		break;
 	case 2:
-		return avr32_jtag_write_memory16(&ap7k->jtag, address, count, (uint16_t*)buffer);
+		return avr32_jtag_write_memory16(&ap7k->jtag, address, count, (uint16_t*)(void *)buffer);
 		break;
 	case 1:
 		return avr32_jtag_write_memory8(&ap7k->jtag, address, count, buffer);
diff --git a/src/target/avr32_mem.c b/src/target/avr32_mem.c
index 0767c55..fe6b8f0 100644
--- a/src/target/avr32_mem.c
+++ b/src/target/avr32_mem.c
@@ -112,7 +112,7 @@ int avr32_jtag_read_memory8(struct avr32_jtag *jtag_info,
 	if (addr & 3)
 	{
 		retval = avr32_jtag_mwa_read(jtag_info, SLAVE_HSB_UNCACHED,
-				addr + i, (uint32_t*)data);
+				addr + i, (uint32_t*)(void *)data);
 
 		if (retval != ERROR_OK)
 			return retval;
@@ -126,7 +126,7 @@ int avr32_jtag_read_memory8(struct avr32_jtag *jtag_info,
 	for (; i < (count & ~3); i+=4)
 	{
 		retval = avr32_jtag_mwa_read(jtag_info, SLAVE_HSB_UNCACHED,
-				addr + i, (uint32_t*)data);
+				addr + i, (uint32_t*)(void *)data);
 
 		if (retval != ERROR_OK)
 			return retval;
@@ -139,7 +139,7 @@ int avr32_jtag_read_memory8(struct avr32_jtag *jtag_info,
 	if (i < count)
 	{
 		retval = avr32_jtag_mwa_read(jtag_info, SLAVE_HSB_UNCACHED,
-				addr + i, (uint32_t*)data);
+				addr + i, (uint32_t*)(void *)data);
 
 		if (retval != ERROR_OK)
 			return retval;
diff --git a/src/target/etb.c b/src/target/etb.c
index ba47c39..489b9ed 100644
--- a/src/target/etb.c
+++ b/src/target/etb.c
@@ -166,7 +166,7 @@ static void etb_getbuf(jtag_callback_data_t arg)
 {
 	uint8_t *in = (uint8_t *)arg;
 
-	*((uint32_t *)in) = buf_get_u32(in, 0, 32);
+	*((uint32_t *)arg) = buf_get_u32(in, 0, 32);
 }
 
 
diff --git a/src/target/mips_m4k.c b/src/target/mips_m4k.c
index 62c484a..c0adc06 100644
--- a/src/target/mips_m4k.c
+++ b/src/target/mips_m4k.c
@@ -1000,7 +1000,7 @@ static int mips_m4k_bulk_write_memory(struct target *target, uint32_t address,
 	}
 
 	retval = mips32_pracc_fastdata_xfer(ejtag_info, source, write_t, address,
-			count, (uint32_t*) buffer);
+			count, (uint32_t*) (void *)buffer);
 	if (retval != ERROR_OK)
 	{
 		/* FASTDATA access failed, try normal memory write */
diff --git a/src/target/xscale.c b/src/target/xscale.c
index 37a2438..e0ce400 100644
--- a/src/target/xscale.c
+++ b/src/target/xscale.c
@@ -244,7 +244,7 @@ static int xscale_read_dcsr(struct target *target)
 static void xscale_getbuf(jtag_callback_data_t arg)
 {
 	uint8_t *in = (uint8_t *)arg;
-	*((uint32_t *)in) = buf_get_u32(in, 0, 32);
+	*((uint32_t *)arg) = buf_get_u32(in, 0, 32);
 }
 
 static int xscale_receive(struct target *target, uint32_t *buffer, int num_words)

-----------------------------------------------------------------------

Summary of changes:
 src/flash/mflash.c       |    4 ++--
 src/flash/nand/lpc3180.c |    4 ++--
 src/flash/nor/at91sam3.c |    4 ++--
 src/helper/types.h       |    2 +-
 src/pld/virtex2.c        |    2 +-
 src/target/arm11.c       |    4 ++--
 src/target/arm_adi_v5.c  |    2 +-
 src/target/arm_jtag.h    |    4 ++--
 src/target/avr32_ap7k.c  |    8 ++++----
 src/target/avr32_mem.c   |    6 +++---
 src/target/etb.c         |    2 +-
 src/target/mips_m4k.c    |    2 +-
 src/target/xscale.c      |    2 +-
 13 files changed, 23 insertions(+), 23 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Sep 20 13:52:48 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 20 Sep 2010 11:52:48 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-523-g549d974
Message-ID: <E1OxevS-0006Qz-FB@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  549d97481407b99a820033379d5a3d44931a5336 (commit)
      from  f6a3fc818bc6a24b6c5bbcc6057f72d2b0b2e2ab (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 549d97481407b99a820033379d5a3d44931a5336
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Sep 20 13:44:03 2010 +0200

    jtag: build jtag first because it generates header files
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/Makefile.am b/src/Makefile.am
index 56385f7..a2f8d77 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -1,6 +1,6 @@
 SUBDIRS = \
-	helper \
 	jtag \
+	helper \
 	target \
 	flash \
 	svf \

-----------------------------------------------------------------------

Summary of changes:
 src/Makefile.am |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Sep 21 07:45:14 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue, 21 Sep 2010 05:45:14 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-524-g6178055
Message-ID: <E1OxvfI-0003RX-DF@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  61780558e1654af0f3f20a332763b30bf533a912 (commit)
      from  549d97481407b99a820033379d5a3d44931a5336 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 61780558e1654af0f3f20a332763b30bf533a912
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Tue Sep 7 20:27:45 2010 +0200

    zy1000: add support for Linux host
    
    used /dev/mem and mmem() to memory map JTAG registers
    into user space and used new configure options to exclude
    eCos specific code.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/jtag/zy1000/jtag_minidriver.h b/src/jtag/zy1000/jtag_minidriver.h
index 4e99d3c..543fd9b 100644
--- a/src/jtag/zy1000/jtag_minidriver.h
+++ b/src/jtag/zy1000/jtag_minidriver.h
@@ -21,12 +21,19 @@
 #define TEST_MANUAL() 0
 #define VERBOSE(a)
 
-#if BUILD_ECOSBOARD
+#if BUILD_ZY1000_MASTER
 
+#if BUILD_ECOSBOARD
 #include <cyg/hal/hal_io.h>             // low level i/o
 #include <cyg/hal/hal_intr.h>             // low level i/o
 #define ZY1000_PEEK(a, b) HAL_READ_UINT32(a, b)
 #define ZY1000_POKE(a, b) HAL_WRITE_UINT32(a, b)
+#else
+#define ZY1000_PEEK(a, b) do {b = *( ( volatile uint32_t *)(a) );} while (0)
+#define ZY1000_POKE(a, b) do {*( ( volatile uint32_t *)(a) ) = b;} while (0)
+extern volatile void *zy1000_jtag_master;
+#define ZY1000_JTAG_BASE ((unsigned long)zy1000_jtag_master)
+#endif
 
 #else
 
@@ -41,7 +48,7 @@ extern uint32_t zy1000_tcpin(uint32_t address);
 
 
 
-#if BUILD_ECOSBOARD
+#if BUILD_ZY1000_MASTER
 // FIFO empty?
 static __inline__ void waitIdle(void)
 {
@@ -228,7 +235,7 @@ static __inline__ void interface_jtag_add_dr_out(struct jtag_tap *target_tap,
 	}
 }
 
-#if BUILD_ECOSBOARD
+#if BUILD_ZY1000_MASTER
 #define interface_jtag_add_callback(callback, in) callback(in)
 #define interface_jtag_add_callback4(callback, in, data1, data2, data3) jtag_set_error(callback(in, data1, data2, data3))
 #else
diff --git a/src/jtag/zy1000/zy1000.c b/src/jtag/zy1000/zy1000.c
index 3ecd0f9..c939d7f 100644
--- a/src/jtag/zy1000/zy1000.c
+++ b/src/jtag/zy1000/zy1000.c
@@ -321,7 +321,7 @@ COMMAND_HANDLER(handle_power_command)
 	return ERROR_OK;
 }
 
-#if !BUILD_ECOSBOARD
+#if !BUILD_ZY1000_MASTER
 static char *tcp_server = "notspecified";
 static int jim_zy1000_server(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 {
@@ -1002,6 +1002,7 @@ static const struct command_registration zy1000_commands[] = {
 			"With no arguments, prints status.",
 		.usage = "('on'|'off)",
 	},
+#if BUILD_ZY1000_MASTER
 #if BUILD_ECOSBOARD
 	{
 		.name = "zy1000_version",
@@ -1010,6 +1011,7 @@ static const struct command_registration zy1000_commands[] = {
 		.help = "Print version info for zy1000.",
 		.usage = "['openocd'|'zy1000'|'date'|'time'|'pcb'|'fpga']",
 	},
+#endif
 #else
 	{
 		.name = "zy1000_server",
@@ -1038,6 +1040,7 @@ static const struct command_registration zy1000_commands[] = {
 };
 
 
+#if !BUILD_ZY1000_MASTER || BUILD_ECOSBOARD
 static int tcp_ip = -1;
 
 /* Write large packets if we can */
@@ -1106,6 +1109,7 @@ static bool readLong(uint32_t *out_data)
 	*out_data = data;
 	return true;
 }
+#endif
 
 enum ZY1000_CMD
 {
@@ -1116,7 +1120,7 @@ enum ZY1000_CMD
 };
 
 
-#if !BUILD_ECOSBOARD
+#if !BUILD_ZY1000_MASTER
 
 #include <sys/socket.h> /* for socket(), connect(), send(), and recv() */
 #include <arpa/inet.h>  /* for sockaddr_in and inet_addr() */
@@ -1566,21 +1570,49 @@ static void watchdog_server(cyg_addrword_t data)
 }
 #endif
 
+#endif
+
+#if BUILD_ZY1000_MASTER
 int interface_jtag_add_sleep(uint32_t us)
 {
 	jtag_sleep(us);
 	return ERROR_OK;
 }
-
 #endif
 
+#if BUILD_ZY1000_MASTER && !BUILD_ECOSBOARD
+volatile void *zy1000_jtag_master;
+#include <sys/mman.h>
+#endif
 
 int zy1000_init(void)
 {
 #if BUILD_ECOSBOARD
 	LOG_USER("%s", ZYLIN_OPENOCD_VERSION);
+#else
+	int fd;
+ 	if((fd = open("/dev/mem", O_RDWR | O_SYNC)) == -1)
+ 	{
+ 		LOG_ERROR("No access to /dev/mem");
+ 		return ERROR_FAIL;
+ 	}
+#ifndef REGISTERS_BASE
+#define REGISTERS_BASE 0x9002000
+#define REGISTERS_SPAN 128
+#endif
+    
+    zy1000_jtag_master = mmap(0, REGISTERS_SPAN, PROT_READ | PROT_WRITE, MAP_SHARED, fd, REGISTERS_BASE);
+    
+    if(zy1000_jtag_master == (void *) -1) 
+    {
+	    close(fd);
+ 		LOG_ERROR("No access to /dev/mem");
+ 		return ERROR_FAIL;
+    } 
 #endif
 
+
+
 	ZY1000_POKE(ZY1000_JTAG_BASE + 0x10, 0x30); // Turn on LED1 & LED2
 
 	setPower(true); // on by default

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/zy1000/jtag_minidriver.h |   13 +++++++++--
 src/jtag/zy1000/zy1000.c          |   38 ++++++++++++++++++++++++++++++++++--
 2 files changed, 45 insertions(+), 6 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Sep 21 07:45:49 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue, 21 Sep 2010 05:45:49 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-525-g241fd0b
Message-ID: <E1Oxvfv-0001qB-Ok@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  241fd0b5a8a95e814395f79b5ea7715c1862f045 (commit)
      from  61780558e1654af0f3f20a332763b30bf533a912 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 241fd0b5a8a95e814395f79b5ea7715c1862f045
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sat Sep 18 01:37:42 2010 +0200

    logging: turn of stdout/stderr buffering
    
    with this buffering disabled fancier logging scripts will
    be able to process each line as it is output.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/main.c b/src/main.c
index a71977d..9c7191d 100644
--- a/src/main.c
+++ b/src/main.c
@@ -35,5 +35,9 @@
 
 int main(int argc, char *argv[])
 {
+	/* disable buffering otherwise piping to logs causes problems work */
+	setvbuf(stdout, NULL, _IONBF, 0);
+	setvbuf(stderr, NULL, _IONBF, 0);
+
 	return openocd_main(argc, argv);
 }

-----------------------------------------------------------------------

Summary of changes:
 src/main.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Sep 21 07:46:19 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue, 21 Sep 2010 05:46:19 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-526-g6000411
Message-ID: <E1OxvgL-0001oA-Nl@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  6000411dddd9930b99a4931bc363f425cc0fdcda (commit)
      from  241fd0b5a8a95e814395f79b5ea7715c1862f045 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 6000411dddd9930b99a4931bc363f425cc0fdcda
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Wed Sep 8 20:04:27 2010 +0200

    tcl_server: switch to ctrl-z
    
    by using ctrl-z instead of line end, multi-line tcl scripts
    can be handled.
    
    Testing: send ctrl-z a couple of times to make telnet enter the
    mode where it sends ctrl-z unencoded.
    
    Programs that talk to the tcl_server can send ctrl-z to
    indicate end of tcl-let to be executed without having
    to worry about telnet protocols.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/server/tcl_server.c b/src/server/tcl_server.c
index 7c8e130..06f67ab 100644
--- a/src/server/tcl_server.c
+++ b/src/server/tcl_server.c
@@ -1,5 +1,6 @@
 /***************************************************************************
- *   Copyright (C) 2008                                                    *
+ *   Copyright (C) 2010 ??yvind Harboe                                      *
+ *   oyvind.harboe at zylin.com                                               *
  *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
  *   it under the terms of the GNU General Public License as published by  *
@@ -104,13 +105,6 @@ static int tcl_input(struct connection *connection)
 	/* push as much data into the line as possible */
 	for (i = 0; i < rlen; i++)
 	{
-		if (!isprint(in[i]) && !isspace(in[i]))
-		{
-			/* drop this line */
-			tclc->tc_linedrop = 1;
-			continue;
-		}
-
 		/* buffer the data */
 		tclc->tc_line[tclc->tc_lineoffset] = in[i];
 		if (tclc->tc_lineoffset < TCL_MAX_LINE)
@@ -118,7 +112,11 @@ static int tcl_input(struct connection *connection)
 		else
 			tclc->tc_linedrop = 1;
 
-		if (in[i] != '\n')
+		/* ctrl-z is end of command. When testing from telnet, just
+		 * press ctrl-z a couple of times first to put telnet into the
+		 * mode where it will send 0x1a in response to pressing ctrl-z
+		 */
+		if (in[i] != '\x1a')
 			continue;
 
 		/* process the line */
@@ -131,13 +129,15 @@ static int tcl_input(struct connection *connection)
 		}
 		else {
 			tclc->tc_line[tclc->tc_lineoffset-1] = '\0';
+			LOG_DEBUG("Executing script:\n %s", tclc->tc_line);
 			retval = Jim_Eval_Named(interp, tclc->tc_line, "remote:connection",1);
+			LOG_DEBUG("Result: %d\n %s", retval, Jim_GetString(Jim_GetResult(interp), &reslen));
 			result = Jim_GetString(Jim_GetResult(interp), &reslen);
 			retval = tcl_output(connection, result, reslen);
 			if (retval != ERROR_OK)
 				return retval;
-			if (memchr(result, '\n', reslen) == NULL)
-				tcl_output(connection, "\n", 1);
+			/* Always output ctrl-d as end of line to allow multiline results */
+			tcl_output(connection, "\x1a", 1);
 		}
 
 		tclc->tc_lineoffset = 0;

-----------------------------------------------------------------------

Summary of changes:
 src/server/tcl_server.c |   22 +++++++++++-----------
 1 files changed, 11 insertions(+), 11 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Sep 21 07:46:59 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue, 21 Sep 2010 05:46:59 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-527-g1abc26d
Message-ID: <E1Oxvgz-0001qy-36@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  1abc26d7a2b7172184c64d2151bf4803699993da (commit)
      from  6000411dddd9930b99a4931bc363f425cc0fdcda (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 1abc26d7a2b7172184c64d2151bf4803699993da
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Sep 20 11:50:32 2010 +0200

    helper: fix flaky capture command
    
    capture of progress output would get polling
    results. This will break in the example below
    where polling output would override the tcl
    return value.
    
    capture {sleep 10000; set abc def}
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/helper/command.c b/src/helper/command.c
index 086b03d..1bd8c42 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -36,6 +36,7 @@
 #endif
 
 // @todo the inclusion of target.h here is a layering violation
+#include <jtag/jtag.h>
 #include <target/target.h>
 #include "command.h"
 #include "configuration.h"
@@ -867,6 +868,9 @@ static char* openocd_jim_fgets(char *s, int size, void *cookie)
 	return NULL;
 }
 
+/* Capture progress output and return as tcl return value. If the
+ * progress output was empty, return tcl return value.
+ */
 static int jim_capture(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 {
 	if (argc != 2)
@@ -874,9 +878,21 @@ static int jim_capture(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 
 	struct log_capture_state *state = command_log_capture_start(interp);
 
+	/* disable polling during capture. This avoids capturing output
+	 * from polling.
+	 *
+	 * This is necessary in order to avoid accidentially getting a non-empty
+	 * string for tcl fn's.
+	 */
+	bool save_poll = jtag_poll_get_enabled();
+
+	jtag_poll_set_enabled(false);
+
 	const char *str = Jim_GetString(argv[1], NULL);
 	int retcode = Jim_Eval_Named(interp, str, __THIS__FILE__, __LINE__);
 
+	jtag_poll_set_enabled(save_poll);
+
 	command_log_capture_finish(state);
 
 	return retcode;

-----------------------------------------------------------------------

Summary of changes:
 src/helper/command.c |   16 ++++++++++++++++
 1 files changed, 16 insertions(+), 0 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Sep 21 07:47:27 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue, 21 Sep 2010 05:47:27 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-528-gea48794
Message-ID: <E1OxvhQ-0001tF-VB@sfp-scmshell-2.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  ea48794210037699bdde44014238c10c9968a72d (commit)
      from  1abc26d7a2b7172184c64d2151bf4803699993da (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit ea48794210037699bdde44014238c10c9968a72d
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Fri Sep 10 11:42:12 2010 +0200

    startup: removed capture_catch
    
    not used.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/helper/startup.tcl b/src/helper/startup.tcl
index d1c73ef..4c71a9a 100644
--- a/src/helper/startup.tcl
+++ b/src/helper/startup.tcl
@@ -61,10 +61,3 @@ add_usage_text script "<file>"
 
 #########
 
-# catch any exceptions, capture output and return output
-proc capture_catch {a} {
-	catch {
-		capture {uplevel $a}
-	} result
-	return $result
-}

-----------------------------------------------------------------------

Summary of changes:
 src/helper/startup.tcl |    7 -------
 1 files changed, 0 insertions(+), 7 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Sep 21 12:27:54 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue, 21 Sep 2010 10:27:54 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-529-gedefee9
Message-ID: <E1Oy04r-0007fE-Rp@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  edefee988045558d5d306453ce352dc06bcb7a03 (commit)
      from  ea48794210037699bdde44014238c10c9968a72d (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit edefee988045558d5d306453ce352dc06bcb7a03
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Tue Sep 21 16:06:37 2010 +0800

    TCL scripts: collect duplicated procedures
    
    TCL procedures mrw and mmw, originally in DaVinci target code,
    are duplicated in other TCL scripts.
    Moved in a common helper file, and added help/usage description.
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/tcl/mem_helper.tcl b/tcl/mem_helper.tcl
new file mode 100644
index 0000000..d811490
--- /dev/null
+++ b/tcl/mem_helper.tcl
@@ -0,0 +1,22 @@
+# Helper for common memory read/modify/write procedures
+
+# mrw: "memory read word", returns value of $reg
+proc mrw {reg} {
+	set value ""
+	ocd_mem2array value 32 $reg 1
+	return $value(0)
+}
+
+add_usage_text mrw "address"
+add_help_text mrw "Returns value of word in memory."
+
+# mmw: "memory modify word", updates value of $reg
+#       $reg <== ((value & ~$clearbits) | $setbits)
+proc mmw {reg setbits clearbits} {
+	set old [mrw $reg]
+	set new [expr ($old & ~$clearbits) | $setbits]
+	mww $reg $new
+}
+
+add_usage_text mmw "address setbits clearbits"
+add_help_text mmw "Modify word in memory. new_val = (old_val & ~clearbits) | setbits;"
diff --git a/tcl/target/c100helper.tcl b/tcl/target/c100helper.tcl
index 45adc62..3251066 100644
--- a/tcl/target/c100helper.tcl
+++ b/tcl/target/c100helper.tcl
@@ -25,13 +25,7 @@ proc helpC100 {} {
     puts "22) flashUBOOT:        will prgram NOR sectors 0-3 with u-boot.bin"
 }
 
-# mrw,mmw from davinci.cfg
-# mrw: "memory read word", returns value of $reg
-proc mrw {reg} {
-    set value ""
-    mem2array value 32 $reg 1
-    return $value(0)
-}
+source [find mem_helper.tcl]
 
 # read a 64-bit register (memory mapped)
 proc mr64bit {reg} {
@@ -50,14 +44,6 @@ proc mw64bit {reg value} {
     mww [expr $reg+4] $high
 }
 
-# mmw: "memory modify word", updates value of $reg
-#	$reg <== ((value & ~$clearbits) | $setbits)
-proc mmw {reg setbits clearbits} {
-    set old [mrw $reg]
-    set new [expr ($old & ~$clearbits) | $setbits]
-    mww $reg $new
-}
-
 
 proc showNOR {} {
     puts "This is the current NOR setup"
diff --git a/tcl/target/davinci.cfg b/tcl/target/davinci.cfg
index 6e9091e..9e9369d 100644
--- a/tcl/target/davinci.cfg
+++ b/tcl/target/davinci.cfg
@@ -7,20 +7,7 @@ proc davinci_pinmux {soc reg value} {
 	mww [expr [dict get $soc sysbase] + 4 * $reg] $value
 }
 
-# mrw: "memory read word", returns value of $reg
-proc mrw {reg} {
-	set value ""
-	mem2array value 32 $reg 1
-	return $value(0)
-}
-
-# mmw: "memory modify word", updates value of $reg
-#	$reg <== ((value & ~$clearbits) | $setbits)
-proc mmw {reg setbits clearbits} {
-	set old [mrw $reg]
-	set new [expr ($old & ~$clearbits) | $setbits]
-	mww $reg $new
-}
+source [find mem_helper.tcl]
 
 #
 # pll_setup: initialize PLL
diff --git a/tcl/target/stellaris.cfg b/tcl/target/stellaris.cfg
index 6ba5f14..b663ce3 100644
--- a/tcl/target/stellaris.cfg
+++ b/tcl/target/stellaris.cfg
@@ -46,12 +46,7 @@ $_TARGETNAME configure -work-area-phys 0x20000000 -work-area-size $_WORKAREASIZE
 # this, if you're using a slower clock.
 adapter_khz 500
 
-# mrw: "memory read word", returns value of $reg
-proc mrw {reg} {
-	set value ""
-	mem2array value 32 $reg 1
-	return $value(0)
-}
+source [find mem_helper.tcl]
 
 $_TARGETNAME configure -event reset-start {
 	adapter_khz 500

-----------------------------------------------------------------------

Summary of changes:
 tcl/mem_helper.tcl        |   22 ++++++++++++++++++++++
 tcl/target/c100helper.tcl |   16 +---------------
 tcl/target/davinci.cfg    |   15 +--------------
 tcl/target/stellaris.cfg  |    7 +------
 4 files changed, 25 insertions(+), 35 deletions(-)
 create mode 100644 tcl/mem_helper.tcl


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Sep 21 22:21:46 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue, 21 Sep 2010 20:21:46 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-531-g22911a3
Message-ID: <E1Oy9Lf-0003AN-33@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  22911a3aedfa01c7a5643de9c21fbb94f6219c38 (commit)
       via  9aafd42853b4164ea72e6e2f89008ff84b1fac52 (commit)
      from  edefee988045558d5d306453ce352dc06bcb7a03 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 22911a3aedfa01c7a5643de9c21fbb94f6219c38
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Sep 20 09:22:46 2010 +0200

    flash: fix error handling
    
    sensible error must be reported at failure site
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nand/tcl.c b/src/flash/nand/tcl.c
index 7b84888..57bbe00 100644
--- a/src/flash/nand/tcl.c
+++ b/src/flash/nand/tcl.c
@@ -150,16 +150,8 @@ COMMAND_HANDLER(handle_nand_probe_command)
 		command_print(CMD_CTX, "NAND flash device '%s (%s)' found",
 				p->device->name, p->manufacturer->name);
 	}
-	else if (retval == ERROR_NAND_OPERATION_FAILED)
-	{
-		command_print(CMD_CTX, "probing failed for NAND flash device");
-	}
-	else
-	{
-		command_print(CMD_CTX, "unknown error when probing NAND flash device");
-	}
 
-	return ERROR_OK;
+	return retval;
 }
 
 COMMAND_HANDLER(handle_nand_erase_command)
@@ -206,16 +198,8 @@ COMMAND_HANDLER(handle_nand_erase_command)
 				offset, offset + length,
 				CMD_ARGV[0], p->device->name);
 	}
-	else if (retval == ERROR_NAND_OPERATION_FAILED)
-	{
-		command_print(CMD_CTX, "erase failed");
-	}
-	else
-	{
-		command_print(CMD_CTX, "unknown error when erasing NAND flash device");
-	}
 
-	return ERROR_OK;
+	return retval;
 }
 
 COMMAND_HANDLER(handle_nand_check_bad_blocks_command)
@@ -261,18 +245,8 @@ COMMAND_HANDLER(handle_nand_check_bad_blocks_command)
 		command_print(CMD_CTX, "checked NAND flash device for bad blocks, "
 				"use \"nand info\" command to list blocks");
 	}
-	else if (retval == ERROR_NAND_OPERATION_FAILED)
-	{
-		command_print(CMD_CTX, "error when checking for bad blocks on "
-				"NAND flash device");
-	}
-	else
-	{
-		command_print(CMD_CTX, "unknown error when checking for bad "
-				"blocks on NAND flash device");
-	}
 
-	return ERROR_OK;
+	return retval;
 }
 
 COMMAND_HANDLER(handle_nand_write_command)
diff --git a/src/flash/nor/tcl.c b/src/flash/nor/tcl.c
index 3dc6cff..8604b4b 100644
--- a/src/flash/nor/tcl.c
+++ b/src/flash/nor/tcl.c
@@ -132,23 +132,14 @@ COMMAND_HANDLER(handle_flash_probe_command)
 		{
 			command_print(CMD_CTX, "flash '%s' found at 0x%8.8" PRIx32, p->driver->name, p->base);
 		}
-		else if (retval == ERROR_FLASH_BANK_INVALID)
-		{
-			command_print(CMD_CTX, "probing failed for flash bank '#%s' at 0x%8.8" PRIx32,
-						  CMD_ARGV[0], p->base);
-		}
-		else
-		{
-			command_print(CMD_CTX, "unknown error when probing flash bank '#%s' at 0x%8.8" PRIx32,
-						  CMD_ARGV[0], p->base);
-		}
 	}
 	else
 	{
 		command_print(CMD_CTX, "flash bank '#%s' is out of bounds", CMD_ARGV[0]);
+		retval = ERROR_FAIL;
 	}
 
-	return ERROR_OK;
+	return retval;
 }
 
 COMMAND_HANDLER(handle_flash_erase_check_command)

commit 9aafd42853b4164ea72e6e2f89008ff84b1fac52
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Sep 20 09:40:09 2010 +0200

    embeddedice: fix error handling
    
    error is now reported at failure site.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nor/ocl.c b/src/flash/nor/ocl.c
index 9a295eb..6c60923 100644
--- a/src/flash/nor/ocl.c
+++ b/src/flash/nor/ocl.c
@@ -101,8 +101,6 @@ static int ocl_erase(struct flash_bank *bank, int first, int last)
 	/* wait for response, fixed timeout of 1 s */
 	if ((retval = embeddedice_handshake(ocl->jtag_info, EICE_COMM_CTRL_WBIT, 1000) != ERROR_OK))
 	{
-		if (retval == ERROR_TARGET_TIMEOUT)
-			LOG_ERROR("loader not responding");
 		return retval;
 	}
 
@@ -206,8 +204,6 @@ static int ocl_write(struct flash_bank *bank, uint8_t *buffer, uint32_t offset,
 		/* wait for response, fixed timeout of 1 s */
 		if ((retval = embeddedice_handshake(ocl->jtag_info, EICE_COMM_CTRL_WBIT, 1000) != ERROR_OK))
 		{
-			if (retval == ERROR_TARGET_TIMEOUT)
-				LOG_ERROR("loader not responding");
 			free(dcc_buffer);
 			return retval;
 		}
@@ -252,8 +248,6 @@ static int ocl_probe(struct flash_bank *bank)
 	/* wait for response, fixed timeout of 1 s */
 	if ((retval = embeddedice_handshake(ocl->jtag_info, EICE_COMM_CTRL_WBIT, 1000) != ERROR_OK))
 	{
-		if (retval == ERROR_TARGET_TIMEOUT)
-			LOG_ERROR("loader not responding");
 		return retval;
 	}
 
diff --git a/src/target/embeddedice.c b/src/target/embeddedice.c
index abc49d7..5502ad8 100644
--- a/src/target/embeddedice.c
+++ b/src/target/embeddedice.c
@@ -588,7 +588,10 @@ int embeddedice_handshake(struct arm_jtag *jtag_info, int hsbit, uint32_t timeou
 	else if (hsbit == EICE_COMM_CTRL_RBIT)
 		hsact = 0;
 	else
+	{
+		LOG_ERROR("Invalid arguments");
 		return ERROR_INVALID_ARGUMENTS;
+	}
 
 	retval = arm_jtag_scann(jtag_info, 0x2, TAP_IDLE);
 	if (retval != ERROR_OK)
@@ -625,6 +628,7 @@ int embeddedice_handshake(struct arm_jtag *jtag_info, int hsbit, uint32_t timeou
 	} while ((uint32_t)((now.tv_sec - lap.tv_sec) * 1000
 			+ (now.tv_usec - lap.tv_usec) / 1000) <= timeout);
 
+	LOG_ERROR("embeddedice handshake timeout");
 	return ERROR_TARGET_TIMEOUT;
 }
 

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nand/tcl.c     |   32 +++-----------------------------
 src/flash/nor/ocl.c      |    6 ------
 src/flash/nor/tcl.c      |   13 ++-----------
 src/target/embeddedice.c |    4 ++++
 4 files changed, 9 insertions(+), 46 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Sat Sep 25 11:38:07 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Sat, 25 Sep 2010 09:38:07 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-532-gcb0de21
Message-ID: <E1OzRCu-00024C-8e@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  cb0de21d0cb6b899be30b6ce9c48d93f75a6c345 (commit)
      from  22911a3aedfa01c7a5643de9c21fbb94f6219c38 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit cb0de21d0cb6b899be30b6ce9c48d93f75a6c345
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Tue Sep 21 22:13:09 2010 +0200

    jtagdp: remove #if 0'd kludges and explain why the code is correct
    
    short story: if the JTAG clock is too high, then the
    behavior will be flaky and kludging the code may
    seem to make things beter, but really it's just a red
    herring.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/target/adi_v5_jtag.c b/src/target/adi_v5_jtag.c
index 8731a1a..48b4a7b 100644
--- a/src/target/adi_v5_jtag.c
+++ b/src/target/adi_v5_jtag.c
@@ -191,22 +191,30 @@ static int jtagdp_transaction_endcheck(struct adiv5_dap *dap)
 
 	/* too expensive to call keep_alive() here */
 
-#if 0
-	/* Danger!!!! BROKEN!!!! */
-	adi_jtag_scan_inout_check_u32(dap, JTAG_DP_DPACC,
-			DP_CTRL_STAT, DPAP_READ, 0, &ctrlstat);
-	/* Danger!!!! BROKEN!!!! Why will jtag_execute_queue() fail here????
-	R956 introduced the check on return value here and now Michael Schwingen reports
-	that this code no longer works....
-
-	https://lists.berlios.de/pipermail/openocd-development/2008-September/003107.html
-	*/
-	if ((retval = jtag_execute_queue()) != ERROR_OK)
-	{
-		LOG_ERROR("BUG: Why does this fail the first time????");
-	}
-	/* Why??? second time it works??? */
-#endif
+	/* Here be dragons!
+	 *
+	 * It is easy to be in a JTAG clock range where the target
+	 * is not operating in a stable fashion. This happens
+	 * for a few reasons:
+	 *
+	 * - the user may construct a simple test case to try to see
+	 * if a higher JTAG clock works to eke out more performance.
+	 * This simple case may pass, but more complex situations can
+	 * fail.
+	 *
+	 * - The mostly works JTAG clock rate and the complete failure
+	 * JTAG clock rate may be as much as 2-4x apart. This seems
+	 * to be especially true on RC oscillator driven parts.
+	 *
+	 * So: even if calling adi_jtag_scan_inout_check_u32() multiple
+	 * times here seems to "make things better here", it is just
+	 * hiding problems with too high a JTAG clock.
+	 *
+	 * Note that even if some parts have RCLK/RTCK, that doesn't
+	 * mean that RCLK/RTCK is the *correct* rate to run the JTAG
+	 * interface at, i.e. RCLK/RTCK rates can be "too high", especially
+	 * before the RC oscillator phase is not yet complete.
+	 */
 
 	/* Post CTRL/STAT read; discard any previous posted read value
 	 * but collect its ACK status.

-----------------------------------------------------------------------

Summary of changes:
 src/target/adi_v5_jtag.c |   40 ++++++++++++++++++++++++----------------
 1 files changed, 24 insertions(+), 16 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Sun Sep 26 18:07:07 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Sun, 26 Sep 2010 16:07:07 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-533-g9f26aff
Message-ID: <E1Oztkw-0005AC-DF@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  9f26aff39c047d813047b4f4bae1f5de3cfc56b1 (commit)
      from  cb0de21d0cb6b899be30b6ce9c48d93f75a6c345 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 9f26aff39c047d813047b4f4bae1f5de3cfc56b1
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sun Sep 26 18:01:54 2010 +0200

    gdb: fix blank line at top
    
    snuck in at some point...
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index 1d1d836..76c3e36 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -1,4 +1,3 @@
-
 /***************************************************************************
  *   Copyright (C) 2005 by Dominic Rath                                    *
  *   Dominic.Rath at gmx.de                                                   *

-----------------------------------------------------------------------

Summary of changes:
 src/server/gdb_server.c |    1 -
 1 files changed, 0 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Sun Sep 26 22:40:20 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Sun, 26 Sep 2010 20:40:20 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-534-g6468c59
Message-ID: <E1Ozy1H-0000VI-0f@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  6468c593c7ece11aa7735d8d6aa9a546b9505cc3 (commit)
      from  9f26aff39c047d813047b4f4bae1f5de3cfc56b1 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 6468c593c7ece11aa7735d8d6aa9a546b9505cc3
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Sun Sep 26 20:37:53 2010 +0200

    zy1000: fix non-JTAG master build
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/jtag/zy1000/zy1000.c b/src/jtag/zy1000/zy1000.c
index c939d7f..c8bee2f 100644
--- a/src/jtag/zy1000/zy1000.c
+++ b/src/jtag/zy1000/zy1000.c
@@ -1589,7 +1589,7 @@ int zy1000_init(void)
 {
 #if BUILD_ECOSBOARD
 	LOG_USER("%s", ZYLIN_OPENOCD_VERSION);
-#else
+#elif BUILD_ZY1000_MASTER
 	int fd;
  	if((fd = open("/dev/mem", O_RDWR | O_SYNC)) == -1)
  	{

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/zy1000/zy1000.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From zwelch at users.sourceforge.net  Mon Sep 27 02:50:49 2010
From: zwelch at users.sourceforge.net (Zach Welch)
Date: Mon, 27 Sep 2010 00:50:49 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-535-g3bb4a6b
Message-ID: <E1P01vl-0004Cc-Te@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  3bb4a6ba14dba7441868dd28b6f56798523e8ad3 (commit)
      from  6468c593c7ece11aa7735d8d6aa9a546b9505cc3 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 3bb4a6ba14dba7441868dd28b6f56798523e8ad3
Author: Zachary T Welch <zwelch at codesourcery.com>
Date:   Fri Sep 24 16:13:04 2010 -0700

    Fix omap3_dbginit to write to physical memory.
    
    Setting the OMAP3530 DBGEN bit must be done in physical memory, so
    update omap3_dbginit callback to use the new 'mww phys' command syntax.

diff --git a/tcl/target/omap3530.cfg b/tcl/target/omap3530.cfg
index 74edd72..ba130a9 100644
--- a/tcl/target/omap3530.cfg
+++ b/tcl/target/omap3530.cfg
@@ -56,7 +56,7 @@ proc omap3_dbginit {target} {
      # General Cortex A8 debug initialisation
      cortex_a8 dbginit
      # Enable DBGU signal for OMAP353x
-     $target mww 0x5401d030 0x00002000
+     $target mww phys 0x5401d030 0x00002000
 }
 
 # be absolutely certain the JTAG clock will work with the worst-case

-----------------------------------------------------------------------

Summary of changes:
 tcl/target/omap3530.cfg |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Sep 27 16:35:06 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 27 Sep 2010 14:35:06 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-536-g19167a7
Message-ID: <E1P0EnO-0007T4-U2@sfp-scmshell-4.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  19167a7af6053f1eba0420509408731db007368c (commit)
      from  3bb4a6ba14dba7441868dd28b6f56798523e8ad3 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 19167a7af6053f1eba0420509408731db007368c
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Sep 27 16:29:08 2010 +0200

    image: fix spelling mistake
    
    struct imageection => struct imagesection
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nor/core.c b/src/flash/nor/core.c
index 84408e6..d200d8c 100644
--- a/src/flash/nor/core.c
+++ b/src/flash/nor/core.c
@@ -522,9 +522,9 @@ int flash_unlock_address_range(struct target *target, uint32_t addr, uint32_t le
 
 static int compare_section (const void * a, const void * b)
 {
-	struct imageection *b1, *b2;
-	b1=*((struct imageection **)a);
-	b2=*((struct imageection **)b);
+	struct imagesection *b1, *b2;
+	b1=*((struct imagesection **)a);
+	b2=*((struct imagesection **)b);
 
 	if (b1->base_address == b2->base_address)
 	{
@@ -568,7 +568,7 @@ int flash_write_unlock(struct target *target, struct image *image,
 
 	/* This fn requires all sections to be in ascending order of addresses,
 	 * whereas an image can have sections out of order. */
-	struct imageection **sections = malloc(sizeof(struct imageection *) *
+	struct imagesection **sections = malloc(sizeof(struct imagesection *) *
 			image->num_sections);
 	int i;
 	for (i = 0; i < image->num_sections; i++)
@@ -576,7 +576,7 @@ int flash_write_unlock(struct target *target, struct image *image,
 		sections[i] = &image->sections[i];
 	}
 
-	qsort(sections, image->num_sections, sizeof(struct imageection *),
+	qsort(sections, image->num_sections, sizeof(struct imagesection *),
 			compare_section);
 
 	/* loop until we reach end of the image */
@@ -696,7 +696,7 @@ int flash_write_unlock(struct target *target, struct image *image,
 			 * list of pointers to sections to invoke image_read_section()...
 			 */
 			intptr_t diff = (intptr_t)sections[section] - (intptr_t)image->sections;
-			int t_section_num = diff / sizeof(struct imageection);
+			int t_section_num = diff / sizeof(struct imagesection);
 
 			LOG_DEBUG("image_read_section: section = %d, t_section_num = %d, section_offset = %d, buffer_size = %d, size_read = %d",
 				 (int)section,
diff --git a/src/target/image.c b/src/target/image.c
index f8d0529..d36fbc3 100644
--- a/src/target/image.c
+++ b/src/target/image.c
@@ -147,7 +147,7 @@ static int identify_image_type(struct image *image, const char *type_string, con
 	return ERROR_OK;
 }
 
-static int image_ihex_buffer_complete_inner(struct image *image, char *lpszLine, struct imageection *section)
+static int image_ihex_buffer_complete_inner(struct image *image, char *lpszLine, struct imagesection *section)
 {
 	struct image_ihex *ihex = image->type_private;
 	struct fileio *fileio = &ihex->fileio;
@@ -230,7 +230,7 @@ static int image_ihex_buffer_complete_inner(struct image *image, char *lpszLine,
 			image->num_sections++;
 
 			/* copy section information */
-			image->sections = malloc(sizeof(struct imageection) * image->num_sections);
+			image->sections = malloc(sizeof(struct imagesection) * image->num_sections);
 			for (i = 0; i < image->num_sections; i++)
 			{
 				image->sections[i].private = section[i].private;
@@ -367,7 +367,7 @@ static int image_ihex_buffer_complete(struct image *image)
 		LOG_ERROR("Out of memory");
 		return ERROR_FAIL;
 	}
-	struct imageection *section = malloc(sizeof(struct imageection) * IMAGE_MAX_SECTIONS);
+	struct imagesection *section = malloc(sizeof(struct imagesection) * IMAGE_MAX_SECTIONS);
 	if (section == NULL)
 	{
 		free(lpszLine);
@@ -466,7 +466,7 @@ static int image_elf_read_headers(struct image *image)
 		if ((field32(elf, elf->segments[i].p_type) == PT_LOAD) && (field32(elf, elf->segments[i].p_filesz) != 0))
 			image->num_sections++;
 	/* alloc and fill sections array with loadable segments */
-	image->sections = malloc(image->num_sections * sizeof(struct imageection));
+	image->sections = malloc(image->num_sections * sizeof(struct imagesection));
 	for (i = 0,j = 0;i < elf->segment_count;i++)
 	{
 		if ((field32(elf, elf->segments[i].p_type) == PT_LOAD) && (field32(elf, elf->segments[i].p_filesz) != 0))
@@ -526,7 +526,7 @@ static int image_elf_read_section(struct image *image, int section, uint32_t off
 	return ERROR_OK;
 }
 
-static int image_mot_buffer_complete_inner(struct image *image, char *lpszLine, struct imageection *section)
+static int image_mot_buffer_complete_inner(struct image *image, char *lpszLine, struct imagesection *section)
 {
 	struct image_mot *mot = image->type_private;
 	struct fileio *fileio = &mot->fileio;
@@ -660,7 +660,7 @@ static int image_mot_buffer_complete_inner(struct image *image, char *lpszLine,
 			image->num_sections++;
 
 			/* copy section information */
-			image->sections = malloc(sizeof(struct imageection) * image->num_sections);
+			image->sections = malloc(sizeof(struct imagesection) * image->num_sections);
 			for (i = 0; i < image->num_sections; i++)
 			{
 				image->sections[i].private = section[i].private;
@@ -706,7 +706,7 @@ static int image_mot_buffer_complete(struct image *image)
 		LOG_ERROR("Out of memory");
 		return ERROR_FAIL;
 	}
-	struct imageection *section = malloc(sizeof(struct imageection) * IMAGE_MAX_SECTIONS);
+	struct imagesection *section = malloc(sizeof(struct imagesection) * IMAGE_MAX_SECTIONS);
 	if (section == NULL)
 	{
 		free(lpszLine);
@@ -745,7 +745,7 @@ int image_open(struct image *image, const char *url, const char *type_string)
 		}
 
 		image->num_sections = 1;
-		image->sections = malloc(sizeof(struct imageection));
+		image->sections = malloc(sizeof(struct imagesection));
 		image->sections[0].base_address = 0x0;
 		image->sections[0].size = image_binary->fileio.size;
 		image->sections[0].flags = 0;
@@ -798,7 +798,7 @@ int image_open(struct image *image, const char *url, const char *type_string)
 		struct image_memory *image_memory;
 
 		image->num_sections = 1;
-		image->sections = malloc(sizeof(struct imageection));
+		image->sections = malloc(sizeof(struct imagesection));
 		image->sections[0].base_address = 0x0;
 		image->sections[0].size = 0xffffffff;
 		image->sections[0].flags = 0;
@@ -954,7 +954,7 @@ int image_read_section(struct image *image, int section, uint32_t offset, uint32
 
 int image_add_section(struct image *image, uint32_t base, uint32_t size, int flags, uint8_t *data)
 {
-	struct imageection *section;
+	struct imagesection *section;
 
 	/* only image builder supports adding sections */
 	if (image->type != IMAGE_BUILDER)
@@ -978,7 +978,7 @@ int image_add_section(struct image *image, uint32_t base, uint32_t size, int fla
 
 	/* allocate new section */
 	image->num_sections++;
-	image->sections = realloc(image->sections, sizeof(struct imageection) * image->num_sections);
+	image->sections = realloc(image->sections, sizeof(struct imagesection) * image->num_sections);
 	section = &image->sections[image->num_sections - 1];
 	section->base_address = base;
 	section->size = size;
diff --git a/src/target/image.h b/src/target/image.h
index b096031..27f3186 100644
--- a/src/target/image.h
+++ b/src/target/image.h
@@ -47,7 +47,7 @@ enum image_type
 	IMAGE_BUILDER,	/* when building a new image */
 };
 
-struct imageection
+struct imagesection
 {
 	uint32_t base_address;
 	uint32_t size;
@@ -60,7 +60,7 @@ struct image
 	enum image_type type;		/* image type (plain, ihex, ...) */
 	void *type_private;		/* type private data */
 	int num_sections;		/* number of sections contained in the image */
-	struct imageection *sections;	/* array of sections */
+	struct imagesection *sections;	/* array of sections */
 	int base_address_set;	/* whether the image has a base address set (for relocation purposes) */
 	long long base_address;		/* base address, if one is set */
 	int start_address_set;	/* whether the image has a start address (entry point) associated */

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/core.c |   12 ++++++------
 src/target/image.c   |   22 +++++++++++-----------
 src/target/image.h   |    4 ++--
 3 files changed, 19 insertions(+), 19 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Mon Sep 27 22:25:13 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Mon, 27 Sep 2010 20:25:13 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-537-g45e5d1d
Message-ID: <E1P0KGK-0007yh-6n@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  45e5d1d90acaff8cf57f694e70ec41ece9bddfcd (commit)
      from  19167a7af6053f1eba0420509408731db007368c (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 45e5d1d90acaff8cf57f694e70ec41ece9bddfcd
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Mon Sep 27 16:45:25 2010 +0200

    flash: fix error handling
    
    memory leaks and missing check on memory allocation.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/nor/core.c b/src/flash/nor/core.c
index d200d8c..2c1d9de 100644
--- a/src/flash/nor/core.c
+++ b/src/flash/nor/core.c
@@ -601,7 +601,9 @@ int flash_write_unlock(struct target *target, struct image *image,
 		/* find the corresponding flash bank */
 		retval = get_flash_bank_by_addr(target, run_address, false, &c);
 		if (retval != ERROR_OK)
-			return retval;
+		{
+			goto done;
+		}
 		if (c == NULL)
 		{
 			section++; /* and skip it */
@@ -653,7 +655,8 @@ int flash_write_unlock(struct target *target, struct image *image,
 		if (run_address + run_size - 1 > c->base + c->size - 1)
 		{
 			LOG_ERROR("The image is too big for the flash");
-			return ERROR_FAIL;
+			retval = ERROR_FAIL;
+			goto done;
 		}
 
 		/* If we're applying any sector automagic, then pad this
@@ -679,6 +682,12 @@ int flash_write_unlock(struct target *target, struct image *image,
 
 		/* allocate buffer */
 		buffer = malloc(run_size);
+		if (buffer == NULL)
+		{
+			LOG_ERROR("Out of memory for flash bank buffer");
+			retval = ERROR_FAIL;
+			goto done;
+		}
 		buffer_size = 0;
 
 		/* read sections to the buffer */

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nor/core.c |   13 +++++++++++--
 1 files changed, 11 insertions(+), 2 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Tue Sep 28 10:47:32 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Tue, 28 Sep 2010 08:47:32 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-538-gecad760
Message-ID: <E1P0Vqg-0005Va-Tt@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  ecad76061f6edff5db67ad05e6514dff6cd6efc7 (commit)
      from  45e5d1d90acaff8cf57f694e70ec41ece9bddfcd (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit ecad76061f6edff5db67ad05e6514dff6cd6efc7
Author: Antonio Borneo <borneo.antonio at gmail.com>
Date:   Tue Sep 28 16:37:19 2010 +0800

    TCL scripts: fix ocd_mem2array/mem2array
    
    In previous patch, I have introduced again the symbol
    "ocd_mem2array", now replaced by "mem2array".
    Fix the error.
    
    Signed-off-by: Antonio Borneo <borneo.antonio at gmail.com>

diff --git a/tcl/mem_helper.tcl b/tcl/mem_helper.tcl
index d811490..a3d92cb 100644
--- a/tcl/mem_helper.tcl
+++ b/tcl/mem_helper.tcl
@@ -3,7 +3,7 @@
 # mrw: "memory read word", returns value of $reg
 proc mrw {reg} {
 	set value ""
-	ocd_mem2array value 32 $reg 1
+	mem2array value 32 $reg 1
 	return $value(0)
 }
 

-----------------------------------------------------------------------

Summary of changes:
 tcl/mem_helper.tcl |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Wed Sep 29 08:46:54 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Wed, 29 Sep 2010 06:46:54 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-539-g3a693ef
Message-ID: <E1P0qRR-0005w9-Tq@sfp-scmshell-1.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  3a693ef526575633cc350a69aa1a5d1f08e64c46 (commit)
      from  ecad76061f6edff5db67ad05e6514dff6cd6efc7 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 3a693ef526575633cc350a69aa1a5d1f08e64c46
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Tue Sep 28 15:37:56 2010 +0200

    fileio: refactor struct fileio to be an opaque structure
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/mflash.c b/src/flash/mflash.c
index 26b85b1..272127b 100644
--- a/src/flash/mflash.c
+++ b/src/flash/mflash.c
@@ -726,8 +726,8 @@ COMMAND_HANDLER(mg_write_cmd)
 		return ERROR_FAIL;
 	}
 
-	cnt = fileio.size / MG_FILEIO_CHUNK;
-	res = fileio.size % MG_FILEIO_CHUNK;
+	cnt = fileio_size(&fileio) / MG_FILEIO_CHUNK;
+	res = fileio_size(&fileio) % MG_FILEIO_CHUNK;
 
 	struct duration bench;
 	duration_start(&bench);
@@ -752,8 +752,8 @@ COMMAND_HANDLER(mg_write_cmd)
 	if (duration_measure(&bench) == ERROR_OK)
 	{
 		command_print(CMD_CTX, "wrote %ld bytes from file %s "
-				"in %fs (%0.3f kB/s)", (long)fileio.size, CMD_ARGV[1],
-				duration_elapsed(&bench), duration_kbps(&bench, fileio.size));
+				"in %fs (%0.3f kB/s)", (long)fileio_size(&fileio), CMD_ARGV[1],
+				duration_elapsed(&bench), duration_kbps(&bench, fileio_size(&fileio)));
 	}
 
 	free(buffer);
diff --git a/src/flash/nand/fileio.c b/src/flash/nand/fileio.c
index 3e397eb..0a006fc 100644
--- a/src/flash/nand/fileio.c
+++ b/src/flash/nand/fileio.c
@@ -180,7 +180,7 @@ COMMAND_HELPER(nand_fileio_parse_args, struct nand_fileio_state *state,
 		return retval;
 
 	if (!need_size)
-		state->size = state->fileio.size;
+		state->size = fileio_size(&state->fileio);
 
 	*dev = nand;
 
diff --git a/src/flash/nand/tcl.c b/src/flash/nand/tcl.c
index 57bbe00..a54f8ea 100644
--- a/src/flash/nand/tcl.c
+++ b/src/flash/nand/tcl.c
@@ -389,8 +389,8 @@ COMMAND_HANDLER(handle_nand_dump_command)
 	if (nand_fileio_finish(&s) == ERROR_OK)
 	{
 		command_print(CMD_CTX, "dumped %ld bytes in %fs (%0.3f KiB/s)",
-				(long)s.fileio.size, duration_elapsed(&s.bench),
-				duration_kbps(&s.bench, s.fileio.size));
+				(long)fileio_size(&s.fileio), duration_elapsed(&s.bench),
+				duration_kbps(&s.bench, fileio_size(&s.fileio)));
 	}
 	return ERROR_OK;
 }
diff --git a/src/flash/nor/tcl.c b/src/flash/nor/tcl.c
index 8604b4b..f36ab7d 100644
--- a/src/flash/nor/tcl.c
+++ b/src/flash/nor/tcl.c
@@ -604,9 +604,9 @@ COMMAND_HANDLER(handle_flash_write_bank_command)
 		return ERROR_OK;
 	}
 
-	buffer = malloc(fileio.size);
+	buffer = malloc(fileio_size(&fileio));
 	size_t buf_cnt;
-	if (fileio_read(&fileio, fileio.size, buffer, &buf_cnt) != ERROR_OK)
+	if (fileio_read(&fileio, fileio_size(&fileio), buffer, &buf_cnt) != ERROR_OK)
 	{
 		free(buffer);
 		fileio_close(&fileio);
@@ -622,8 +622,8 @@ COMMAND_HANDLER(handle_flash_write_bank_command)
 	{
 		command_print(CMD_CTX, "wrote %ld bytes from file %s to flash bank %u"
 				" at offset 0x%8.8" PRIx32 " in %fs (%0.3f KiB/s)",
-				(long)fileio.size, CMD_ARGV[1], p->bank_number, offset,
-				duration_elapsed(&bench), duration_kbps(&bench, fileio.size));
+				(long)fileio_size(&fileio), CMD_ARGV[1], p->bank_number, offset,
+				duration_elapsed(&bench), duration_kbps(&bench, fileio_size(&fileio)));
 	}
 
 	fileio_close(&fileio);
diff --git a/src/helper/fileio.c b/src/helper/fileio.c
index ba62397..7c862e4 100644
--- a/src/helper/fileio.c
+++ b/src/helper/fileio.c
@@ -31,7 +31,16 @@
 #include "configuration.h"
 #include "fileio.h"
 
-static inline int fileio_open_local(struct fileio *fileio)
+struct fileio_internal {
+	const char *url;
+	ssize_t size;
+	enum fileio_type type;
+	enum fileio_access access;
+	FILE *file;
+};
+
+static inline int fileio_close_local(struct fileio_internal *fileio);
+static inline int fileio_open_local(struct fileio_internal *fileio)
 {
 	char file_access[4];
 
@@ -86,7 +95,7 @@ static inline int fileio_open_local(struct fileio *fileio)
 
 		if ((fileio->size < 0)||(result < 0)||(result2 < 0))
 		{
-			fileio_close(fileio);
+			fileio_close_local(fileio);
 			return ERROR_FILEIO_OPERATION_FAILED;
 		}
 	}
@@ -98,10 +107,13 @@ static inline int fileio_open_local(struct fileio *fileio)
 	return ERROR_OK;
 }
 
-int fileio_open(struct fileio *fileio, const char *url, enum fileio_access access_type,	enum fileio_type type)
+int fileio_open(struct fileio *fileio_p, const char *url, enum fileio_access access_type,	enum fileio_type type)
 {
 	int retval = ERROR_OK;
 
+	struct fileio_internal *fileio = malloc(sizeof(struct fileio_internal));
+	fileio_p->fp = fileio;
+
 	fileio->type = type;
 	fileio->access = access_type;
 	fileio->url = strdup(url);
@@ -111,7 +123,7 @@ int fileio_open(struct fileio *fileio, const char *url, enum fileio_access acces
 	return retval;
 }
 
-static inline int fileio_close_local(struct fileio *fileio)
+static inline int fileio_close_local(struct fileio_internal *fileio)
 {
 	int retval;
 	if ((retval = fclose(fileio->file)) != 0)
@@ -131,21 +143,26 @@ static inline int fileio_close_local(struct fileio *fileio)
 	return ERROR_OK;
 }
 
-int fileio_close(struct fileio *fileio)
+int fileio_close(struct fileio *fileio_p)
 {
 	int retval;
+	struct fileio_internal *fileio = fileio_p->fp;
 
 	retval = fileio_close_local(fileio);
 
 	free((void*)fileio->url);
 	fileio->url = NULL;
 
+	free(fileio);
+	fileio_p->fp = NULL;
+
 	return retval;
 }
 
-int fileio_seek(struct fileio *fileio, size_t position)
+int fileio_seek(struct fileio *fileio_p, size_t position)
 {
 	int retval;
+	struct fileio_internal *fileio = fileio_p->fp;
 	if ((retval = fseek(fileio->file, position, SEEK_SET)) != 0)
 	{
 		LOG_ERROR("couldn't seek file %s: %s", fileio->url, strerror(errno));
@@ -155,7 +172,7 @@ int fileio_seek(struct fileio *fileio, size_t position)
 	return ERROR_OK;
 }
 
-static int fileio_local_read(struct fileio *fileio,
+static int fileio_local_read(struct fileio_internal *fileio,
 		size_t size, void *buffer, size_t *size_read)
 {
 	ssize_t retval = fread(buffer, 1, size, fileio->file);
@@ -163,16 +180,18 @@ static int fileio_local_read(struct fileio *fileio,
 	return (retval < 0) ? retval : ERROR_OK;
 }
 
-int fileio_read(struct fileio *fileio, size_t size, void *buffer,
+int fileio_read(struct fileio *fileio_p, size_t size, void *buffer,
 		size_t *size_read)
 {
+	struct fileio_internal *fileio = fileio_p->fp;
 	return fileio_local_read(fileio, size, buffer, size_read);
 }
 
-int fileio_read_u32(struct fileio *fileio, uint32_t *data)
+int fileio_read_u32(struct fileio *fileio_p, uint32_t *data)
 {
 	uint8_t buf[4];
 	size_t size_read;
+	struct fileio_internal *fileio = fileio_p->fp;
 	int retval = fileio_local_read(fileio, sizeof(uint32_t), buf, &size_read);
 	if (ERROR_OK == retval && sizeof(uint32_t) != size_read)
 		retval = -EIO;
@@ -181,7 +200,7 @@ int fileio_read_u32(struct fileio *fileio, uint32_t *data)
 	return retval;
 }
 
-static int fileio_local_fgets(struct fileio *fileio,
+static int fileio_local_fgets(struct fileio_internal *fileio,
 		size_t size, void *buffer)
 {
 	if (fgets(buffer, size, fileio->file) == NULL)
@@ -190,12 +209,13 @@ static int fileio_local_fgets(struct fileio *fileio,
 	return ERROR_OK;
 }
 
-int fileio_fgets(struct fileio *fileio, size_t size, void *buffer)
+int fileio_fgets(struct fileio *fileio_p, size_t size, void *buffer)
 {
+	struct fileio_internal *fileio = fileio_p->fp;
 	return fileio_local_fgets(fileio, size, buffer);
 }
 
-static int fileio_local_write(struct fileio *fileio,
+static int fileio_local_write(struct fileio_internal *fileio,
 		size_t size, const void *buffer, size_t *size_written)
 {
 	ssize_t retval = fwrite(buffer, 1, size, fileio->file);
@@ -203,24 +223,30 @@ static int fileio_local_write(struct fileio *fileio,
 	return (retval < 0) ? retval : ERROR_OK;
 }
 
-int fileio_write(struct fileio *fileio,
+int fileio_write(struct fileio *fileio_p,
 		size_t size, const void *buffer, size_t *size_written)
 {
+	struct fileio_internal *fileio = fileio_p->fp;
 	int retval = fileio_local_write(fileio, size, buffer, size_written);
 	if (retval == ERROR_OK)
 		fileio->size += *size_written;
 	return retval;
 }
 
-int fileio_write_u32(struct fileio *fileio, uint32_t data)
+int fileio_write_u32(struct fileio *fileio_p, uint32_t data)
 {
 	uint8_t buf[4];
 	h_u32_to_be(buf, data);
-
 	size_t size_written;
-	int retval = fileio_write(fileio, 4, buf, &size_written);
+	int retval = fileio_write(fileio_p, 4, buf, &size_written);
 	if (ERROR_OK == retval && size_written != sizeof(uint32_t))
 		retval = -EIO;
 
 	return retval;
 }
+
+int fileio_size(struct fileio *fileio_p)
+{
+	struct fileio_internal *fileio = fileio_p->fp;
+	return fileio->size;
+}
diff --git a/src/helper/fileio.h b/src/helper/fileio.h
index 597bafc..40c4ef0 100644
--- a/src/helper/fileio.h
+++ b/src/helper/fileio.h
@@ -46,12 +46,10 @@ enum fileio_access
 	FILEIO_APPENDREAD,	/* open for writing, position at end, allow reading */
 };
 
-struct fileio {
-	const char *url;
-	ssize_t size;
-	enum fileio_type type;
-	enum fileio_access access;
-	FILE *file;
+struct fileio
+{
+	/* The structure is opaque */
+	struct fileio_internal *fp;
 };
 
 int fileio_open(struct fileio *fileio,
@@ -68,6 +66,7 @@ int fileio_write(struct fileio *fileio,
 
 int fileio_read_u32(struct fileio *fileio, uint32_t *data);
 int fileio_write_u32(struct fileio *fileio, uint32_t data);
+int fileio_size(struct fileio *fileio);
 
 #define ERROR_FILEIO_LOCATION_UNKNOWN	(-1200)
 #define ERROR_FILEIO_NOT_FOUND			(-1201)
diff --git a/src/target/etm.c b/src/target/etm.c
index 9da6955..c71c5d1 100644
--- a/src/target/etm.c
+++ b/src/target/etm.c
@@ -1897,7 +1897,7 @@ COMMAND_HANDLER(handle_etm_load_command)
 		return ERROR_FAIL;
 	}
 
-	if (file.size % 4)
+	if (fileio_size(&file) % 4)
 	{
 		command_print(CMD_CTX, "size isn't a multiple of 4, no valid trace data");
 		fileio_close(&file);
diff --git a/src/target/image.c b/src/target/image.c
index d36fbc3..e77e190 100644
--- a/src/target/image.c
+++ b/src/target/image.c
@@ -158,7 +158,7 @@ static int image_ihex_buffer_complete_inner(struct image *image, char *lpszLine,
 	/* we can't determine the number of sections that we'll have to create ahead of time,
 	 * so we locally hold them until parsing is finished */
 
-	ihex->buffer = malloc(fileio->size >> 1);
+	ihex->buffer = malloc(fileio_size(fileio) >> 1);
 	cooked_bytes = 0x0;
 	image->num_sections = 0;
 	section[image->num_sections].private = &ihex->buffer[cooked_bytes];
@@ -537,7 +537,7 @@ static int image_mot_buffer_complete_inner(struct image *image, char *lpszLine,
 	/* we can't determine the number of sections that we'll have to create ahead of time,
 	 * so we locally hold them until parsing is finished */
 
-	mot->buffer = malloc(fileio->size >> 1);
+	mot->buffer = malloc(fileio_size(fileio) >> 1);
 	cooked_bytes = 0x0;
 	image->num_sections = 0;
 	section[image->num_sections].private = &mot->buffer[cooked_bytes];
@@ -747,7 +747,7 @@ int image_open(struct image *image, const char *url, const char *type_string)
 		image->num_sections = 1;
 		image->sections = malloc(sizeof(struct imagesection));
 		image->sections[0].base_address = 0x0;
-		image->sections[0].size = image_binary->fileio.size;
+		image->sections[0].size = fileio_size(&image_binary->fileio);
 		image->sections[0].flags = 0;
 	}
 	else if (image->type == IMAGE_IHEX)
diff --git a/src/target/target.c b/src/target/target.c
index c37432a..fcdcc36 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -2649,8 +2649,8 @@ COMMAND_HANDLER(handle_dump_image_command)
 	if ((ERROR_OK == retval) && (duration_measure(&bench) == ERROR_OK))
 	{
 		command_print(CMD_CTX,
-				"dumped %ld bytes in %fs (%0.3f KiB/s)", (long)fileio.size,
-				duration_elapsed(&bench), duration_kbps(&bench, fileio.size));
+				"dumped %ld bytes in %fs (%0.3f KiB/s)", (long)fileio_size(&fileio),
+				duration_elapsed(&bench), duration_kbps(&bench, fileio_size(&fileio)));
 	}
 
 	return retval;

-----------------------------------------------------------------------

Summary of changes:
 src/flash/mflash.c      |    8 +++---
 src/flash/nand/fileio.c |    2 +-
 src/flash/nand/tcl.c    |    4 +-
 src/flash/nor/tcl.c     |    8 +++---
 src/helper/fileio.c     |   58 ++++++++++++++++++++++++++++++++++-------------
 src/helper/fileio.h     |   11 ++++-----
 src/target/etm.c        |    2 +-
 src/target/image.c      |    6 ++--
 src/target/target.c     |    4 +-
 9 files changed, 64 insertions(+), 39 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


From gowinex at users.sourceforge.net  Wed Sep 29 19:01:10 2010
From: gowinex at users.sourceforge.net (Øyvind Harboe)
Date: Wed, 29 Sep 2010 17:01:10 +0000
Subject: [openocd-svn] Main OpenOCD repository branch, master,
	updated. v0.4.0-540-g3931b99
Message-ID: <E1P101w-0002Wa-37@sfp-scmshell-3.v30.ch3.sourceforge.com>

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project "Main OpenOCD repository".

The branch, master has been updated
       via  3931b99d142d337ea6558fd09aad2e0812c04507 (commit)
      from  3a693ef526575633cc350a69aa1a5d1f08e64c46 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 3931b99d142d337ea6558fd09aad2e0812c04507
Author: ??yvind Harboe <oyvind.harboe at zylin.com>
Date:   Wed Sep 29 09:11:01 2010 +0200

    fileio: fileio_size() can now fail
    
    Part of making the fileio API more robust.
    
    Signed-off-by: ??yvind Harboe <oyvind.harboe at zylin.com>

diff --git a/src/flash/mflash.c b/src/flash/mflash.c
index 272127b..ba34422 100644
--- a/src/flash/mflash.c
+++ b/src/flash/mflash.c
@@ -720,14 +720,20 @@ COMMAND_HANDLER(mg_write_cmd)
 	if (ret != ERROR_OK)
 		return ret;
 
+	int filesize;
 	buffer = malloc(MG_FILEIO_CHUNK);
 	if (!buffer) {
 		fileio_close(&fileio);
 		return ERROR_FAIL;
 	}
+	int retval = fileio_size(&fileio, &filesize);
+	if (retval != ERROR_OK) {
+		fileio_close(&fileio);
+		return retval;
+	}
 
-	cnt = fileio_size(&fileio) / MG_FILEIO_CHUNK;
-	res = fileio_size(&fileio) % MG_FILEIO_CHUNK;
+	cnt = filesize / MG_FILEIO_CHUNK;
+	res = filesize % MG_FILEIO_CHUNK;
 
 	struct duration bench;
 	duration_start(&bench);
@@ -752,8 +758,8 @@ COMMAND_HANDLER(mg_write_cmd)
 	if (duration_measure(&bench) == ERROR_OK)
 	{
 		command_print(CMD_CTX, "wrote %ld bytes from file %s "
-				"in %fs (%0.3f kB/s)", (long)fileio_size(&fileio), CMD_ARGV[1],
-				duration_elapsed(&bench), duration_kbps(&bench, fileio_size(&fileio)));
+				"in %fs (%0.3f kB/s)", (long)filesize, CMD_ARGV[1],
+				duration_elapsed(&bench), duration_kbps(&bench, filesize));
 	}
 
 	free(buffer);
diff --git a/src/flash/nand/fileio.c b/src/flash/nand/fileio.c
index 0a006fc..c7515e2 100644
--- a/src/flash/nand/fileio.c
+++ b/src/flash/nand/fileio.c
@@ -180,7 +180,13 @@ COMMAND_HELPER(nand_fileio_parse_args, struct nand_fileio_state *state,
 		return retval;
 
 	if (!need_size)
-		state->size = fileio_size(&state->fileio);
+	{
+		int filesize;
+		retval = fileio_size(&state->fileio, &filesize);
+		if (retval != ERROR_OK)
+			return retval;
+		state->size = filesize;
+	}
 
 	*dev = nand;
 
diff --git a/src/flash/nand/tcl.c b/src/flash/nand/tcl.c
index a54f8ea..15cf179 100644
--- a/src/flash/nand/tcl.c
+++ b/src/flash/nand/tcl.c
@@ -388,9 +388,14 @@ COMMAND_HANDLER(handle_nand_dump_command)
 
 	if (nand_fileio_finish(&s) == ERROR_OK)
 	{
+		int filesize;
+		retval = fileio_size(&s.fileio, &filesize);
+		if (retval != ERROR_OK)
+			return retval;
+
 		command_print(CMD_CTX, "dumped %ld bytes in %fs (%0.3f KiB/s)",
-				(long)fileio_size(&s.fileio), duration_elapsed(&s.bench),
-				duration_kbps(&s.bench, fileio_size(&s.fileio)));
+				(long)filesize, duration_elapsed(&s.bench),
+				duration_kbps(&s.bench, filesize));
 	}
 	return ERROR_OK;
 }
diff --git a/src/flash/nor/tcl.c b/src/flash/nor/tcl.c
index f36ab7d..142f31f 100644
--- a/src/flash/nor/tcl.c
+++ b/src/flash/nor/tcl.c
@@ -604,9 +604,23 @@ COMMAND_HANDLER(handle_flash_write_bank_command)
 		return ERROR_OK;
 	}
 
-	buffer = malloc(fileio_size(&fileio));
+	int filesize;
+	retval = fileio_size(&fileio, &filesize);
+	if (retval != ERROR_OK)
+	{
+		fileio_close(&fileio);
+		return retval;
+	}
+
+	buffer = malloc(filesize);
+	if (buffer == NULL)
+	{
+		fileio_close(&fileio);
+		LOG_ERROR("Out of memory");
+		return ERROR_FAIL;
+	}
 	size_t buf_cnt;
-	if (fileio_read(&fileio, fileio_size(&fileio), buffer, &buf_cnt) != ERROR_OK)
+	if (fileio_read(&fileio, filesize, buffer, &buf_cnt) != ERROR_OK)
 	{
 		free(buffer);
 		fileio_close(&fileio);
@@ -622,8 +636,8 @@ COMMAND_HANDLER(handle_flash_write_bank_command)
 	{
 		command_print(CMD_CTX, "wrote %ld bytes from file %s to flash bank %u"
 				" at offset 0x%8.8" PRIx32 " in %fs (%0.3f KiB/s)",
-				(long)fileio_size(&fileio), CMD_ARGV[1], p->bank_number, offset,
-				duration_elapsed(&bench), duration_kbps(&bench, fileio_size(&fileio)));
+				(long)filesize, CMD_ARGV[1], p->bank_number, offset,
+				duration_elapsed(&bench), duration_kbps(&bench, filesize));
 	}
 
 	fileio_close(&fileio);
diff --git a/src/helper/fileio.c b/src/helper/fileio.c
index 7c862e4..9ae0134 100644
--- a/src/helper/fileio.c
+++ b/src/helper/fileio.c
@@ -245,8 +245,18 @@ int fileio_write_u32(struct fileio *fileio_p, uint32_t data)
 	return retval;
 }
 
-int fileio_size(struct fileio *fileio_p)
+/**
+ * FIX!!!!
+ *
+ * For now this can not fail, but that's because a seek was executed
+ * on startup.
+ *
+ * Avoiding the seek on startup opens up for using streams.
+ *
+ */
+int fileio_size(struct fileio *fileio_p, int *size)
 {
 	struct fileio_internal *fileio = fileio_p->fp;
-	return fileio->size;
+	*size = fileio->size;
+	return ERROR_OK;
 }
diff --git a/src/helper/fileio.h b/src/helper/fileio.h
index 40c4ef0..fa499ab 100644
--- a/src/helper/fileio.h
+++ b/src/helper/fileio.h
@@ -66,7 +66,7 @@ int fileio_write(struct fileio *fileio,
 
 int fileio_read_u32(struct fileio *fileio, uint32_t *data);
 int fileio_write_u32(struct fileio *fileio, uint32_t data);
-int fileio_size(struct fileio *fileio);
+int fileio_size(struct fileio *fileio, int *size);
 
 #define ERROR_FILEIO_LOCATION_UNKNOWN	(-1200)
 #define ERROR_FILEIO_NOT_FOUND			(-1201)
diff --git a/src/target/etm.c b/src/target/etm.c
index c71c5d1..9f7bc83 100644
--- a/src/target/etm.c
+++ b/src/target/etm.c
@@ -1897,7 +1897,15 @@ COMMAND_HANDLER(handle_etm_load_command)
 		return ERROR_FAIL;
 	}
 
-	if (fileio_size(&file) % 4)
+	int filesize;
+	int retval = fileio_size(&file, &filesize);
+	if (retval != ERROR_OK)
+	{
+		fileio_close(&file);
+		return retval;
+	}
+
+	if (filesize % 4)
 	{
 		command_print(CMD_CTX, "size isn't a multiple of 4, no valid trace data");
 		fileio_close(&file);
diff --git a/src/target/image.c b/src/target/image.c
index e77e190..b0d957f 100644
--- a/src/target/image.c
+++ b/src/target/image.c
@@ -158,7 +158,13 @@ static int image_ihex_buffer_complete_inner(struct image *image, char *lpszLine,
 	/* we can't determine the number of sections that we'll have to create ahead of time,
 	 * so we locally hold them until parsing is finished */
 
-	ihex->buffer = malloc(fileio_size(fileio) >> 1);
+	int filesize;
+	int retval;
+	retval = fileio_size(fileio, &filesize);
+	if (retval != ERROR_OK)
+		return retval;
+
+	ihex->buffer = malloc(filesize >> 1);
 	cooked_bytes = 0x0;
 	image->num_sections = 0;
 	section[image->num_sections].private = &ihex->buffer[cooked_bytes];
@@ -537,7 +543,13 @@ static int image_mot_buffer_complete_inner(struct image *image, char *lpszLine,
 	/* we can't determine the number of sections that we'll have to create ahead of time,
 	 * so we locally hold them until parsing is finished */
 
-	mot->buffer = malloc(fileio_size(fileio) >> 1);
+	int retval;
+	int filesize;
+	retval = fileio_size(fileio, &filesize);
+	if (retval != ERROR_OK)
+		return retval;
+
+	mot->buffer = malloc(filesize >> 1);
 	cooked_bytes = 0x0;
 	image->num_sections = 0;
 	section[image->num_sections].private = &mot->buffer[cooked_bytes];
@@ -743,11 +755,18 @@ int image_open(struct image *image, const char *url, const char *type_string)
 		{
 			return retval;
 		}
+		int filesize;
+		retval = fileio_size(&image_binary->fileio, &filesize);
+		if (retval != ERROR_OK)
+		{
+			fileio_close(&image_binary->fileio);
+			return retval;
+		}
 
 		image->num_sections = 1;
 		image->sections = malloc(sizeof(struct imagesection));
 		image->sections[0].base_address = 0x0;
-		image->sections[0].size = fileio_size(&image_binary->fileio);
+		image->sections[0].size = filesize;
 		image->sections[0].flags = 0;
 	}
 	else if (image->type == IMAGE_IHEX)
diff --git a/src/target/target.c b/src/target/target.c
index fcdcc36..82cbbff 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -2648,9 +2648,13 @@ COMMAND_HANDLER(handle_dump_image_command)
 
 	if ((ERROR_OK == retval) && (duration_measure(&bench) == ERROR_OK))
 	{
+		int filesize;
+		retval = fileio_size(&fileio, &filesize);
+		if (retval != ERROR_OK)
+			return retval;
 		command_print(CMD_CTX,
-				"dumped %ld bytes in %fs (%0.3f KiB/s)", (long)fileio_size(&fileio),
-				duration_elapsed(&bench), duration_kbps(&bench, fileio_size(&fileio)));
+				"dumped %ld bytes in %fs (%0.3f KiB/s)", (long)filesize,
+				duration_elapsed(&bench), duration_kbps(&bench, filesize));
 	}
 
 	return retval;

-----------------------------------------------------------------------

Summary of changes:
 src/flash/mflash.c      |   14 ++++++++++----
 src/flash/nand/fileio.c |    8 +++++++-
 src/flash/nand/tcl.c    |    9 +++++++--
 src/flash/nor/tcl.c     |   22 ++++++++++++++++++----
 src/helper/fileio.c     |   14 ++++++++++++--
 src/helper/fileio.h     |    2 +-
 src/target/etm.c        |   10 +++++++++-
 src/target/image.c      |   25 ++++++++++++++++++++++---
 src/target/target.c     |    8 ++++++--
 9 files changed, 92 insertions(+), 20 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository


