<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-695-g093ec66
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openocd-svn/2011-January/index.html" >
   <LINK REL="made" HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.4.0-695-g093ec66&In-Reply-To=%3CE1PZT6g-0003Sq-HK%40sfp-scmshell-4.v30.ch3.sourceforge.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002482.html">
   <LINK REL="Next"  HREF="002484.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-695-g093ec66</H1>
    <B>&#216;yvind Harboe</B> 
    <A HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.4.0-695-g093ec66&In-Reply-To=%3CE1PZT6g-0003Sq-HK%40sfp-scmshell-4.v30.ch3.sourceforge.com%3E"
       TITLE="[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-695-g093ec66">gowinex at users.sourceforge.net
       </A><BR>
    <I>Sun Jan  2 19:56:41 CET 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="002482.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-686-g21a1c6e
</A></li>
        <LI>Next message: <A HREF="002484.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-697-gd356034
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2483">[ date ]</a>
              <a href="thread.html#2483">[ thread ]</a>
              <a href="subject.html#2483">[ subject ]</a>
              <a href="author.html#2483">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Main OpenOCD repository&quot;.

The branch, master has been updated
       via  093ec6656ab7fb523b8a811f4bd628e3b50f8367 (commit)
       via  f49283a062192800a3263dcef620911010ffc718 (commit)
       via  5e27647e2227368d3a81bb682dd736c575e55568 (commit)
       via  457556b146c30fe485f21a7b3d9a198a3450bb04 (commit)
       via  b7b9ad755eb2cd81513247abcc7f6f1d434d8d2c (commit)
       via  35c30e9ee73aac7a07ff897cce746660caf9fc65 (commit)
       via  3db34f844764e9f7f80cbe957170fae75d9e68be (commit)
       via  2e1f2b50fdac6ece0d9d1cfd99cfedc36615d574 (commit)
       via  5f3603b8ef732311516dcdad43261ca668e20626 (commit)
      from  21a1c6ec33f87b6285e47ad6597cd49ad89a9485 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 093ec6656ab7fb523b8a811f4bd628e3b50f8367
Author: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;
Date:   Fri Dec 31 19:46:09 2010 +0800

    NAND/S3CXXXX: remove private &quot;target&quot; copy
    
    Remove &quot;target&quot; form private data, and use
    common one in struct nand_block.
    
    Signed-off-by: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;

diff --git a/src/flash/nand/s3c2410.c b/src/flash/nand/s3c2410.c
index 1827c74..e998f65 100644
--- a/src/flash/nand/s3c2410.c
+++ b/src/flash/nand/s3c2410.c
@@ -46,8 +46,7 @@ NAND_DEVICE_COMMAND_HANDLER(s3c2410_nand_device_command)
 
 static int s3c2410_init(struct nand_device *nand)
 {
-	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	target_write_u32(target, S3C2410_NFCONF,
 			 S3C2410_NFCONF_EN | S3C2410_NFCONF_TACLS(3) |
@@ -58,8 +57,7 @@ static int s3c2410_init(struct nand_device *nand)
 
 static int s3c2410_write_data(struct nand_device *nand, uint16_t data)
 {
-	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED) {
 		LOG_ERROR(&quot;target must be halted to use S3C24XX NAND flash controller&quot;);
@@ -72,8 +70,7 @@ static int s3c2410_write_data(struct nand_device *nand, uint16_t data)
 
 static int s3c2410_read_data(struct nand_device *nand, void *data)
 {
-	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED) {
 		LOG_ERROR(&quot;target must be halted to use S3C24XX NAND flash controller&quot;);
@@ -86,8 +83,7 @@ static int s3c2410_read_data(struct nand_device *nand, void *data)
 
 static int s3c2410_nand_ready(struct nand_device *nand, int timeout)
 {
-	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	uint8_t status;
 
 	if (target-&gt;state != TARGET_HALTED) {
diff --git a/src/flash/nand/s3c2412.c b/src/flash/nand/s3c2412.c
index f43f8a6..7f4357e 100644
--- a/src/flash/nand/s3c2412.c
+++ b/src/flash/nand/s3c2412.c
@@ -46,8 +46,7 @@ NAND_DEVICE_COMMAND_HANDLER(s3c2412_nand_device_command)
 
 static int s3c2412_init(struct nand_device *nand)
 {
-	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	target_write_u32(target, S3C2410_NFCONF,
 			 S3C2440_NFCONF_TACLS(3) |
diff --git a/src/flash/nand/s3c2440.c b/src/flash/nand/s3c2440.c
index 797ce24..4221f3d 100644
--- a/src/flash/nand/s3c2440.c
+++ b/src/flash/nand/s3c2440.c
@@ -47,8 +47,7 @@ NAND_DEVICE_COMMAND_HANDLER(s3c2440_nand_device_command)
 
 static int s3c2440_init(struct nand_device *nand)
 {
-	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	target_write_u32(target, S3C2410_NFCONF,
 			 S3C2440_NFCONF_TACLS(3) |
@@ -64,7 +63,7 @@ static int s3c2440_init(struct nand_device *nand)
 int s3c2440_nand_ready(struct nand_device *nand, int timeout)
 {
 	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	uint8_t status;
 
 	if (target-&gt;state != TARGET_HALTED) {
@@ -90,7 +89,7 @@ int s3c2440_nand_ready(struct nand_device *nand, int timeout)
 int s3c2440_read_block_data(struct nand_device *nand, uint8_t *data, int data_size)
 {
 	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	uint32_t nfdata = s3c24xx_info-&gt;data;
 	uint32_t tmp;
 
@@ -126,7 +125,7 @@ int s3c2440_read_block_data(struct nand_device *nand, uint8_t *data, int data_si
 int s3c2440_write_block_data(struct nand_device *nand, uint8_t *data, int data_size)
 {
 	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	uint32_t nfdata = s3c24xx_info-&gt;data;
 	uint32_t tmp;
 
diff --git a/src/flash/nand/s3c2443.c b/src/flash/nand/s3c2443.c
index 5fb2d92..8ad044c 100644
--- a/src/flash/nand/s3c2443.c
+++ b/src/flash/nand/s3c2443.c
@@ -47,8 +47,7 @@ NAND_DEVICE_COMMAND_HANDLER(s3c2443_nand_device_command)
 
 static int s3c2443_init(struct nand_device *nand)
 {
-	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	target_write_u32(target, S3C2410_NFCONF,
 			 S3C2440_NFCONF_TACLS(3) |
diff --git a/src/flash/nand/s3c24xx.c b/src/flash/nand/s3c24xx.c
index e3b5c2e..eb20f35 100644
--- a/src/flash/nand/s3c24xx.c
+++ b/src/flash/nand/s3c24xx.c
@@ -43,13 +43,6 @@ S3C24XX_DEVICE_COMMAND()
 	}
 
 	nand-&gt;controller_priv = s3c24xx_info;
-
-	s3c24xx_info-&gt;target = get_target(CMD_ARGV[1]);
-	if (s3c24xx_info-&gt;target == NULL) {
-		LOG_ERROR(&quot;target '%s' not defined&quot;, CMD_ARGV[1]);
-		return ERROR_COMMAND_SYNTAX_ERROR;
-	}
-
 	*info = s3c24xx_info;
 
 	return ERROR_OK;
@@ -58,7 +51,7 @@ S3C24XX_DEVICE_COMMAND()
 int s3c24xx_reset(struct nand_device *nand)
 {
 	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED) {
 		LOG_ERROR(&quot;target must be halted to use S3C24XX NAND flash controller&quot;);
@@ -73,7 +66,7 @@ int s3c24xx_reset(struct nand_device *nand)
 int s3c24xx_command(struct nand_device *nand, uint8_t command)
 {
 	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED) {
 		LOG_ERROR(&quot;target must be halted to use S3C24XX NAND flash controller&quot;);
@@ -88,7 +81,7 @@ int s3c24xx_command(struct nand_device *nand, uint8_t command)
 int s3c24xx_address(struct nand_device *nand, uint8_t address)
 {
 	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED) {
 		LOG_ERROR(&quot;target must be halted to use S3C24XX NAND flash controller&quot;);
@@ -102,7 +95,7 @@ int s3c24xx_address(struct nand_device *nand, uint8_t address)
 int s3c24xx_write_data(struct nand_device *nand, uint16_t data)
 {
 	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED) {
 		LOG_ERROR(&quot;target must be halted to use S3C24XX NAND flash controller&quot;);
@@ -116,7 +109,7 @@ int s3c24xx_write_data(struct nand_device *nand, uint16_t data)
 int s3c24xx_read_data(struct nand_device *nand, void *data)
 {
 	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED) {
 		LOG_ERROR(&quot;target must be halted to use S3C24XX NAND flash controller&quot;);
diff --git a/src/flash/nand/s3c24xx.h b/src/flash/nand/s3c24xx.h
index 059c84d..1535dec 100644
--- a/src/flash/nand/s3c24xx.h
+++ b/src/flash/nand/s3c24xx.h
@@ -33,8 +33,6 @@
 
 struct s3c24xx_nand_controller
 {
-	struct target *target;
-
 	/* register addresses */
 	uint32_t		 cmd;
 	uint32_t		 addr;
diff --git a/src/flash/nand/s3c6400.c b/src/flash/nand/s3c6400.c
index 960447d..a6f8043 100644
--- a/src/flash/nand/s3c6400.c
+++ b/src/flash/nand/s3c6400.c
@@ -43,8 +43,7 @@ NAND_DEVICE_COMMAND_HANDLER(s3c6400_nand_device_command)
 
 static int s3c6400_init(struct nand_device *nand)
 {
-	struct s3c24xx_nand_controller *s3c24xx_info = nand-&gt;controller_priv;
-	struct target *target = s3c24xx_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	target_write_u32(target, S3C2410_NFCONF,
 			 S3C2440_NFCONF_TACLS(3) |

commit f49283a062192800a3263dcef620911010ffc718
Author: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;
Date:   Fri Dec 31 19:46:08 2010 +0800

    NAND/ORION: remove private &quot;target&quot; copy
    
    Remove &quot;target&quot; form private data, and use
    common one in struct nand_block.
    
    Signed-off-by: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;

diff --git a/src/flash/nand/orion.c b/src/flash/nand/orion.c
index 3ab2364..00c9519 100644
--- a/src/flash/nand/orion.c
+++ b/src/flash/nand/orion.c
@@ -33,8 +33,6 @@
 
 struct orion_nand_controller
 {
-	struct target	*target;
-
 	struct arm_nand_data	io;
 
 	uint32_t		cmd;
@@ -53,7 +51,7 @@ struct orion_nand_controller
 static int orion_nand_command(struct nand_device *nand, uint8_t command)
 {
 	struct orion_nand_controller *hw = nand-&gt;controller_priv;
-	struct target *target = hw-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	CHECK_HALTED;
 	target_write_u8(target, hw-&gt;cmd, command);
@@ -63,7 +61,7 @@ static int orion_nand_command(struct nand_device *nand, uint8_t command)
 static int orion_nand_address(struct nand_device *nand, uint8_t address)
 {
 	struct orion_nand_controller *hw = nand-&gt;controller_priv;
-	struct target *target = hw-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	CHECK_HALTED;
 	target_write_u8(target, hw-&gt;addr, address);
@@ -73,7 +71,7 @@ static int orion_nand_address(struct nand_device *nand, uint8_t address)
 static int orion_nand_read(struct nand_device *nand, void *data)
 {
 	struct orion_nand_controller *hw = nand-&gt;controller_priv;
-	struct target *target = hw-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	CHECK_HALTED;
 	target_read_u8(target, hw-&gt;data, data);
@@ -83,7 +81,7 @@ static int orion_nand_read(struct nand_device *nand, void *data)
 static int orion_nand_write(struct nand_device *nand, uint16_t data)
 {
 	struct orion_nand_controller *hw = nand-&gt;controller_priv;
-	struct target *target = hw-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	CHECK_HALTED;
 	target_write_u8(target, hw-&gt;data, data);
@@ -134,12 +132,6 @@ NAND_DEVICE_COMMAND_HANDLER(orion_nand_device_command)
 	}
 
 	nand-&gt;controller_priv = hw;
-	hw-&gt;target = get_target(CMD_ARGV[1]);
-	if (!hw-&gt;target) {
-		LOG_ERROR(&quot;target '%s' not defined&quot;, CMD_ARGV[1]);
-		free(hw);
-		return ERROR_NAND_DEVICE_INVALID;
-	}
 
 	COMMAND_PARSE_NUMBER(u32, CMD_ARGV[2], base);
 	cle = 0;
@@ -149,7 +141,7 @@ NAND_DEVICE_COMMAND_HANDLER(orion_nand_device_command)
 	hw-&gt;cmd = base + (1 &lt;&lt; cle);
 	hw-&gt;addr = base + (1 &lt;&lt; ale);
 
-	hw-&gt;io.target = hw-&gt;target;
+	hw-&gt;io.target = nand-&gt;target;
 	hw-&gt;io.data = hw-&gt;data;
 	hw-&gt;io.op = ARM_NAND_NONE;
 

commit 5e27647e2227368d3a81bb682dd736c575e55568
Author: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;
Date:   Fri Dec 31 19:46:07 2010 +0800

    NAND/NUC910: remove private &quot;target&quot; copy
    
    Remove &quot;target&quot; form private data, and use
    common one in struct nand_block.
    
    Signed-off-by: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;

diff --git a/src/flash/nand/nuc910.c b/src/flash/nand/nuc910.c
index 26d377f..e7e7855 100644
--- a/src/flash/nand/nuc910.c
+++ b/src/flash/nand/nuc910.c
@@ -33,14 +33,12 @@
 
 struct nuc910_nand_controller
 {
-	struct target *target;
 	struct arm_nand_data io;
 };
 
 static int validate_target_state(struct nand_device *nand)
 {
-	struct nuc910_nand_controller *nuc910_nand = nand-&gt;controller_priv;
-	struct target *target = nuc910_nand-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED) {
 		LOG_ERROR(&quot;Target not halted&quot;);
@@ -52,8 +50,7 @@ static int validate_target_state(struct nand_device *nand)
 
 static int nuc910_nand_command(struct nand_device *nand, uint8_t command)
 {
-	struct nuc910_nand_controller *nuc910_nand = nand-&gt;controller_priv;
-	struct target *target = nuc910_nand-&gt;target;
+	struct target *target = nand-&gt;target;
 	int result;
 
 	if ((result = validate_target_state(nand)) != ERROR_OK)
@@ -65,8 +62,7 @@ static int nuc910_nand_command(struct nand_device *nand, uint8_t command)
 
 static int nuc910_nand_address(struct nand_device *nand, uint8_t address)
 {
-	struct nuc910_nand_controller *nuc910_nand = nand-&gt;controller_priv;
-	struct target *target = nuc910_nand-&gt;target;
+	struct target *target = nand-&gt;target;
 	int result;
 
 	if ((result = validate_target_state(nand)) != ERROR_OK)
@@ -78,8 +74,7 @@ static int nuc910_nand_address(struct nand_device *nand, uint8_t address)
 
 static int nuc910_nand_read(struct nand_device *nand, void *data)
 {
-	struct nuc910_nand_controller *nuc910_nand = nand-&gt;controller_priv;
-	struct target *target = nuc910_nand-&gt;target;
+	struct target *target = nand-&gt;target;
 	int result;
 
 	if ((result = validate_target_state(nand)) != ERROR_OK)
@@ -91,8 +86,7 @@ static int nuc910_nand_read(struct nand_device *nand, void *data)
 
 static int nuc910_nand_write(struct nand_device *nand, uint16_t data)
 {
-	struct nuc910_nand_controller *nuc910_nand = nand-&gt;controller_priv;
-	struct target *target = nuc910_nand-&gt;target;
+	struct target *target = nand-&gt;target;
 	int result;
 
 	if ((result = validate_target_state(nand)) != ERROR_OK)
@@ -155,8 +149,7 @@ static int nuc910_nand_reset(struct nand_device *nand)
 
 static int nuc910_nand_ready(struct nand_device *nand, int timeout)
 {
-	struct nuc910_nand_controller *nuc910_nand = nand-&gt;controller_priv;
-	struct target *target = nuc910_nand-&gt;target;
+	struct target *target = nand-&gt;target;
 	uint32_t status;
 
 	do {
@@ -181,20 +174,13 @@ NAND_DEVICE_COMMAND_HANDLER(nuc910_nand_device_command)
 	}
 
 	nand-&gt;controller_priv = nuc910_nand;
-	nuc910_nand-&gt;target = get_target(CMD_ARGV[1]);
-	if (!nuc910_nand-&gt;target) {
-		LOG_ERROR(&quot;target '%s' not defined&quot;, CMD_ARGV[1]);
-		free(nuc910_nand);
-		return ERROR_NAND_DEVICE_INVALID;
-	}
-
 	return ERROR_OK;
 }
 
 static int nuc910_nand_init(struct nand_device *nand)
 {
 	struct nuc910_nand_controller *nuc910_nand = nand-&gt;controller_priv;
-	struct target *target = nuc910_nand-&gt;target;
+	struct target *target = nand-&gt;target;
 	int bus_width = nand-&gt;bus_width ? : 8;
 	int result;
 

commit 457556b146c30fe485f21a7b3d9a198a3450bb04
Author: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;
Date:   Fri Dec 31 19:46:06 2010 +0800

    NAND/MX3: remove private &quot;target&quot; copy
    
    Remove &quot;target&quot; form private data, and use
    common one in struct nand_block.
    
    Signed-off-by: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;

diff --git a/src/flash/nand/mx3.c b/src/flash/nand/mx3.c
index 7676d1b..41f08b5 100644
--- a/src/flash/nand/mx3.c
+++ b/src/flash/nand/mx3.c
@@ -74,12 +74,6 @@ NAND_DEVICE_COMMAND_HANDLER(imx31_nand_device_command)
 
 	nand-&gt;controller_priv = mx3_nf_info;
 
-	mx3_nf_info-&gt;target = get_target (CMD_ARGV[1]);
-	if (mx3_nf_info-&gt;target == NULL)
-	{
-	    LOG_ERROR (&quot;target '%s' not defined&quot;, CMD_ARGV[1]);
-	    return ERROR_FAIL;
-	}
 	if (CMD_ARGC &lt; 3)
 	{
 	    LOG_ERROR (&quot;use \&quot;nand device imx31 target noecc|hwecc\&quot;&quot;);
@@ -104,7 +98,7 @@ NAND_DEVICE_COMMAND_HANDLER(imx31_nand_device_command)
 	mx3_nf_info-&gt;optype = MX3_NF_DATAOUT_PAGE;
 	mx3_nf_info-&gt;fin = MX3_NF_FIN_NONE;
 	mx3_nf_info-&gt;flags.target_little_endian =
-	(mx3_nf_info-&gt;target-&gt;endianness == TARGET_LITTLE_ENDIAN);
+	(nand-&gt;target-&gt;endianness == TARGET_LITTLE_ENDIAN);
 	/*
 	* testing host endianess
 	*/
@@ -125,7 +119,7 @@ NAND_DEVICE_COMMAND_HANDLER(imx31_nand_device_command)
 static int imx31_init (struct nand_device *nand)
 {
 	struct mx3_nf_controller *mx3_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx3_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	{
 	/*
@@ -267,8 +261,7 @@ static int imx31_init (struct nand_device *nand)
 
 static int imx31_read_data (struct nand_device *nand, void *data)
 {
-	struct mx3_nf_controller *mx3_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx3_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	{
 	/*
 	 * validate target state
@@ -329,7 +322,7 @@ static int imx31_reset (struct nand_device *nand)
 static int imx31_command (struct nand_device *nand, uint8_t command)
 {
 	struct mx3_nf_controller *mx3_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx3_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	{
 	/*
 	 * validate target state
@@ -402,8 +395,7 @@ static int imx31_command (struct nand_device *nand, uint8_t command)
 
 static int imx31_address (struct nand_device *nand, uint8_t address)
 {
-	struct mx3_nf_controller *mx3_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx3_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	{
 	/*
 	 * validate target state
@@ -435,8 +427,7 @@ static int imx31_address (struct nand_device *nand, uint8_t address)
 static int imx31_nand_ready (struct nand_device *nand, int tout)
 {
 	uint16_t poll_complete_status;
-	struct mx3_nf_controller *mx3_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx3_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	{
 	/*
@@ -468,7 +459,7 @@ static int imx31_write_page (struct nand_device *nand, uint32_t page,
 			     uint32_t oob_size)
 {
 	struct mx3_nf_controller *mx3_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx3_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (data_size % 2)
 	{
@@ -574,8 +565,7 @@ static int imx31_read_page (struct nand_device *nand, uint32_t page,
 			    uint8_t * data, uint32_t data_size, uint8_t * oob,
 			    uint32_t oob_size)
 {
-	struct mx3_nf_controller *mx3_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx3_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (data_size % 2)
 	{
@@ -650,7 +640,7 @@ static int test_iomux_settings (struct target * target, uint32_t address,
 static int initialize_nf_controller (struct nand_device *nand)
 {
 	struct mx3_nf_controller *mx3_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx3_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	/*
 	* resets NAND flash controller in zero time ? I dont know.
 	*/
@@ -778,7 +768,7 @@ static int poll_for_complete_op (struct target * target, const char *text)
 static int validate_target_state (struct nand_device *nand)
 {
 	struct mx3_nf_controller *mx3_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx3_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -800,7 +790,7 @@ static int validate_target_state (struct nand_device *nand)
 static int do_data_output (struct nand_device *nand)
 {
 	struct mx3_nf_controller *mx3_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx3_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	switch (mx3_nf_info-&gt;fin)
 	{
 	    case MX3_NF_FIN_DATAOUT:
diff --git a/src/flash/nand/mx3.h b/src/flash/nand/mx3.h
index f37fc32..c0a6184 100644
--- a/src/flash/nand/mx3.h
+++ b/src/flash/nand/mx3.h
@@ -109,7 +109,6 @@ struct mx3_nf_flags
 
 struct mx3_nf_controller
 {
-	struct target *target;
 	enum mx_dataout_type optype;
 	enum mx_nf_finalize_action fin;
 	struct mx3_nf_flags flags;

commit b7b9ad755eb2cd81513247abcc7f6f1d434d8d2c
Author: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;
Date:   Fri Dec 31 19:46:05 2010 +0800

    NAND/MX2: remove private &quot;target&quot; copy
    
    Remove &quot;target&quot; form private data, and use
    common one in struct nand_block.
    
    Signed-off-by: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;

diff --git a/src/flash/nand/mx2.c b/src/flash/nand/mx2.c
index 42bb072..6bad4aa 100644
--- a/src/flash/nand/mx2.c
+++ b/src/flash/nand/mx2.c
@@ -86,11 +86,6 @@ NAND_DEVICE_COMMAND_HANDLER(imx27_nand_device_command)
 	}
 
 	nand-&gt;controller_priv = mx2_nf_info;
-	mx2_nf_info-&gt;target = get_target(CMD_ARGV[1]);
-	if (mx2_nf_info-&gt;target == NULL) {
-		LOG_ERROR(&quot;target '%s' not defined&quot;, CMD_ARGV[1]);
-		return ERROR_FAIL;
-	}
 	if (CMD_ARGC &lt; 3) {
 		LOG_ERROR(&quot;use \&quot;nand device imx27 target noecc|hwecc\&quot;&quot;);
 		return ERROR_FAIL;
@@ -108,7 +103,7 @@ NAND_DEVICE_COMMAND_HANDLER(imx27_nand_device_command)
 	mx2_nf_info-&gt;optype = MX2_NF_DATAOUT_PAGE;
 	mx2_nf_info-&gt;fin = MX2_NF_FIN_NONE;
 	mx2_nf_info-&gt;flags.target_little_endian =
-	(mx2_nf_info-&gt;target-&gt;endianness == TARGET_LITTLE_ENDIAN);
+	(nand-&gt;target-&gt;endianness == TARGET_LITTLE_ENDIAN);
 	/*
 	 * testing host endianess
 	 */
@@ -123,7 +118,7 @@ NAND_DEVICE_COMMAND_HANDLER(imx27_nand_device_command)
 static int imx27_init(struct nand_device *nand)
 {
 	struct mx2_nf_controller *mx2_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx2_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	int validate_target_result;
 	uint16_t buffsize_register_content;
@@ -193,8 +188,7 @@ static int imx27_init(struct nand_device *nand)
 
 static int imx27_read_data(struct nand_device *nand, void *data)
 {
-	struct mx2_nf_controller *mx2_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx2_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	int validate_target_result;
 	int try_data_output_from_nand_chip;
 	/*
@@ -244,7 +238,7 @@ static int imx27_reset(struct nand_device *nand)
 static int imx27_command(struct nand_device *nand, uint8_t command)
 {
 	struct mx2_nf_controller *mx2_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx2_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	int validate_target_result;
 	int poll_result;
 	/*
@@ -313,8 +307,7 @@ static int imx27_command(struct nand_device *nand, uint8_t command)
 
 static int imx27_address(struct nand_device *nand, uint8_t address)
 {
-	struct mx2_nf_controller *mx2_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx2_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	int validate_target_result;
 	int poll_result;
 	/*
@@ -339,8 +332,7 @@ static int imx27_address(struct nand_device *nand, uint8_t address)
 static int imx27_nand_ready(struct nand_device *nand, int tout)
 {
 	uint16_t poll_complete_status;
-	struct mx2_nf_controller *mx2_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx2_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	int validate_target_result;
 
 	/*
@@ -366,7 +358,7 @@ static int imx27_write_page(struct nand_device *nand, uint32_t page,
 			     uint32_t oob_size)
 {
 	struct mx2_nf_controller *mx2_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx2_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	int retval;
 	uint16_t nand_status_content;
 	uint16_t swap1, swap2, new_swap1;
@@ -489,7 +481,7 @@ static int imx27_read_page(struct nand_device *nand, uint32_t page,
 			    uint32_t oob_size)
 {
 	struct mx2_nf_controller *mx2_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx2_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	int retval;
 	uint16_t swap1, swap2, new_swap1;
 	if (data_size % 2) {
@@ -575,7 +567,7 @@ static int imx27_read_page(struct nand_device *nand, uint32_t page,
 static int initialize_nf_controller(struct nand_device *nand)
 {
 	struct mx2_nf_controller *mx2_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx2_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	uint16_t work_mode;
 	uint16_t temp;
 	/*
@@ -689,7 +681,7 @@ static int poll_for_complete_op(struct target * target, const char *text)
 static int validate_target_state(struct nand_device *nand)
 {
 	struct mx2_nf_controller *mx2_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx2_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED) {
 		LOG_ERROR(target_not_halted_err_msg);
@@ -709,7 +701,7 @@ static int validate_target_state(struct nand_device *nand)
 static int do_data_output(struct nand_device *nand)
 {
 	struct mx2_nf_controller *mx2_nf_info = nand-&gt;controller_priv;
-	struct target *target = mx2_nf_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	int poll_result;
 	uint16_t ecc_status;
 	switch(mx2_nf_info-&gt;fin) {
diff --git a/src/flash/nand/mx2.h b/src/flash/nand/mx2.h
index 5d0b942..c3e4583 100644
--- a/src/flash/nand/mx2.h
+++ b/src/flash/nand/mx2.h
@@ -113,7 +113,6 @@ struct mx2_nf_flags
 
 struct mx2_nf_controller
 {
-	struct target *target;
 	enum mx_dataout_type optype;
 	enum mx_nf_finalize_action fin;
 	struct mx2_nf_flags flags;

commit 35c30e9ee73aac7a07ff897cce746660caf9fc65
Author: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;
Date:   Fri Dec 31 19:46:04 2010 +0800

    NAND/LPC3180: remove private &quot;target&quot; copy
    
    Remove &quot;target&quot; form private data, and use
    common one in struct nand_block.
    
    Signed-off-by: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;

diff --git a/src/flash/nand/lpc3180.c b/src/flash/nand/lpc3180.c
index 3285c42..4cd4c6f 100644
--- a/src/flash/nand/lpc3180.c
+++ b/src/flash/nand/lpc3180.c
@@ -49,13 +49,6 @@ NAND_DEVICE_COMMAND_HANDLER(lpc3180_nand_device_command)
 		return ERROR_FLASH_BANK_INVALID;
 	}
 
-	struct target *target = get_target(CMD_ARGV[1]);
-	if (NULL == target)
-	{
-		LOG_ERROR(&quot;target '%s' not defined&quot;, CMD_ARGV[1]);
-		return ERROR_NAND_DEVICE_INVALID;
-	}
-
 	uint32_t osc_freq;
 	COMMAND_PARSE_NUMBER(u32, CMD_ARGV[2], osc_freq);
 
@@ -63,7 +56,6 @@ NAND_DEVICE_COMMAND_HANDLER(lpc3180_nand_device_command)
 	lpc3180_info = malloc(sizeof(struct lpc3180_nand_controller));
 	nand-&gt;controller_priv = lpc3180_info;
 
-	lpc3180_info-&gt;target = target;
 	lpc3180_info-&gt;osc_freq = osc_freq;
 
 	if ((lpc3180_info-&gt;osc_freq &lt; 1000) || (lpc3180_info-&gt;osc_freq &gt; 20000))
@@ -106,9 +98,10 @@ static int lpc3180_pll(int fclkin, uint32_t pll_ctrl)
 		return (m / (2 * p)) * (fclkin / n);
 }
 
-static float lpc3180_cycle_time(struct lpc3180_nand_controller *lpc3180_info)
+static float lpc3180_cycle_time(struct nand_device *nand)
 {
-	struct target *target = lpc3180_info-&gt;target;
+	struct lpc3180_nand_controller *lpc3180_info = nand-&gt;controller_priv;
+	struct target *target = nand-&gt;target;
 	uint32_t sysclk_ctrl, pwr_ctrl, hclkdiv_ctrl, hclkpll_ctrl;
 	int sysclk;
 	int hclk;
@@ -159,7 +152,7 @@ static float lpc3180_cycle_time(struct lpc3180_nand_controller *lpc3180_info)
 static int lpc3180_init(struct nand_device *nand)
 {
 	struct lpc3180_nand_controller *lpc3180_info = nand-&gt;controller_priv;
-	struct target *target = lpc3180_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	int bus_width = nand-&gt;bus_width ? : 8;
 	int address_cycles = nand-&gt;address_cycles ? : 3;
 	int page_size = nand-&gt;page_size ? : 512;
@@ -234,7 +227,7 @@ static int lpc3180_init(struct nand_device *nand)
 		target_write_u32(target, 0x200b8030, mlc_icr_value);
 
 		/* calculate NAND controller timings */
-		cycle = lpc3180_cycle_time(lpc3180_info);
+		cycle = lpc3180_cycle_time(nand);
 
 		twp = ((40 / cycle) + 1);
 		twh = ((20 / cycle) + 1);
@@ -280,7 +273,7 @@ static int lpc3180_init(struct nand_device *nand)
             
 
 		/* calculate NAND controller timings */
-		cycle = lpc3180_cycle_time(lpc3180_info);
+		cycle = lpc3180_cycle_time(nand);
 
 		r_setup = w_setup = 0;
 		r_hold = w_hold = 10 / cycle;
@@ -301,7 +294,7 @@ static int lpc3180_init(struct nand_device *nand)
 static int lpc3180_reset(struct nand_device *nand)
 {
 	struct lpc3180_nand_controller *lpc3180_info = nand-&gt;controller_priv;
-	struct target *target = lpc3180_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -343,7 +336,7 @@ static int lpc3180_reset(struct nand_device *nand)
 static int lpc3180_command(struct nand_device *nand, uint8_t command)
 {
 	struct lpc3180_nand_controller *lpc3180_info = nand-&gt;controller_priv;
-	struct target *target = lpc3180_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -373,7 +366,7 @@ static int lpc3180_command(struct nand_device *nand, uint8_t command)
 static int lpc3180_address(struct nand_device *nand, uint8_t address)
 {
 	struct lpc3180_nand_controller *lpc3180_info = nand-&gt;controller_priv;
-	struct target *target = lpc3180_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -403,7 +396,7 @@ static int lpc3180_address(struct nand_device *nand, uint8_t address)
 static int lpc3180_write_data(struct nand_device *nand, uint16_t data)
 {
 	struct lpc3180_nand_controller *lpc3180_info = nand-&gt;controller_priv;
-	struct target *target = lpc3180_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -433,7 +426,7 @@ static int lpc3180_write_data(struct nand_device *nand, uint16_t data)
 static int lpc3180_read_data(struct nand_device *nand, void *data)
 {
 	struct lpc3180_nand_controller *lpc3180_info = nand-&gt;controller_priv;
-	struct target *target = lpc3180_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -495,7 +488,7 @@ static int lpc3180_read_data(struct nand_device *nand, void *data)
 static int lpc3180_write_page(struct nand_device *nand, uint32_t page, uint8_t *data, uint32_t data_size, uint8_t *oob, uint32_t oob_size)
 {
 	struct lpc3180_nand_controller *lpc3180_info = nand-&gt;controller_priv;
-	struct target *target = lpc3180_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	int retval;
 	uint8_t status;
 	uint8_t *page_buffer;
@@ -831,7 +824,7 @@ static int lpc3180_write_page(struct nand_device *nand, uint32_t page, uint8_t *
 static int lpc3180_read_page(struct nand_device *nand, uint32_t page, uint8_t *data, uint32_t data_size, uint8_t *oob, uint32_t oob_size)
 {
 	struct lpc3180_nand_controller *lpc3180_info = nand-&gt;controller_priv;
-	struct target *target = lpc3180_info-&gt;target;
+	struct target *target = nand-&gt;target;
 	uint8_t *page_buffer;
 
 	if (target-&gt;state != TARGET_HALTED)
@@ -1146,7 +1139,7 @@ static int lpc3180_read_page(struct nand_device *nand, uint32_t page, uint8_t *d
 static int lpc3180_controller_ready(struct nand_device *nand, int timeout)
 {
 	struct lpc3180_nand_controller *lpc3180_info = nand-&gt;controller_priv;
-	struct target *target = lpc3180_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -1194,7 +1187,7 @@ static int lpc3180_controller_ready(struct nand_device *nand, int timeout)
 static int lpc3180_nand_ready(struct nand_device *nand, int timeout)
 {
 	struct lpc3180_nand_controller *lpc3180_info = nand-&gt;controller_priv;
-	struct target *target = lpc3180_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -1242,7 +1235,7 @@ static int lpc3180_nand_ready(struct nand_device *nand, int timeout)
 static int lpc3180_tc_ready(struct nand_device *nand, int timeout)
 {
 	struct lpc3180_nand_controller *lpc3180_info = nand-&gt;controller_priv;
-	struct target *target = lpc3180_info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
diff --git a/src/flash/nand/lpc3180.h b/src/flash/nand/lpc3180.h
index 88280f3..d524cfe 100644
--- a/src/flash/nand/lpc3180.h
+++ b/src/flash/nand/lpc3180.h
@@ -29,7 +29,6 @@ enum lpc3180_selected_controller
 
 struct lpc3180_nand_controller
 {
-	struct target *target;
 	int osc_freq;
 	enum lpc3180_selected_controller selected_controller;
 	int is_bulk;

commit 3db34f844764e9f7f80cbe957170fae75d9e68be
Author: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;
Date:   Fri Dec 31 19:46:03 2010 +0800

    NAND/DAVINCI: remove private &quot;target&quot; copy
    
    Remove &quot;target&quot; form private data, and use
    common one in struct nand_block.
    
    Signed-off-by: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;

diff --git a/src/flash/nand/davinci.c b/src/flash/nand/davinci.c
index 90219c6..af39dbf 100644
--- a/src/flash/nand/davinci.c
+++ b/src/flash/nand/davinci.c
@@ -39,8 +39,6 @@ enum ecc {
 };
 
 struct davinci_nand {
-	struct target	*target;
-
 	uint8_t		chipsel;	/* chipselect 0..3 == CS2..CS5 */
 	uint8_t		eccmode;
 
@@ -82,7 +80,7 @@ static int halted(struct target *target, const char *label)
 static int davinci_init(struct nand_device *nand)
 {
 	struct davinci_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 	uint32_t nandfcr;
 
 	if (!halted(target, &quot;init&quot;))
@@ -112,7 +110,7 @@ static int davinci_reset(struct nand_device *nand)
 static int davinci_nand_ready(struct nand_device *nand, int timeout)
 {
 	struct davinci_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 	uint32_t nandfsr;
 
 	/* NOTE: return code is zero/error, else success; not ERROR_* */
@@ -135,7 +133,7 @@ static int davinci_nand_ready(struct nand_device *nand, int timeout)
 static int davinci_command(struct nand_device *nand, uint8_t command)
 {
 	struct davinci_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (!halted(target, &quot;command&quot;))
 		return ERROR_NAND_OPERATION_FAILED;
@@ -147,7 +145,7 @@ static int davinci_command(struct nand_device *nand, uint8_t command)
 static int davinci_address(struct nand_device *nand, uint8_t address)
 {
 	struct davinci_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (!halted(target, &quot;address&quot;))
 		return ERROR_NAND_OPERATION_FAILED;
@@ -159,7 +157,7 @@ static int davinci_address(struct nand_device *nand, uint8_t address)
 static int davinci_write_data(struct nand_device *nand, uint16_t data)
 {
 	struct davinci_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (!halted(target, &quot;write_data&quot;))
 		return ERROR_NAND_OPERATION_FAILED;
@@ -171,7 +169,7 @@ static int davinci_write_data(struct nand_device *nand, uint16_t data)
 static int davinci_read_data(struct nand_device *nand, void *data)
 {
 	struct davinci_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (!halted(target, &quot;read_data&quot;))
 		return ERROR_NAND_OPERATION_FAILED;
@@ -186,7 +184,7 @@ static int davinci_read_block_data(struct nand_device *nand,
 		uint8_t *data, int data_size)
 {
 	struct davinci_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 	uint32_t nfdata = info-&gt;data;
 	uint32_t tmp;
 
@@ -219,7 +217,7 @@ static int davinci_write_block_data(struct nand_device *nand,
 		uint8_t *data, int data_size)
 {
 	struct davinci_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 	uint32_t nfdata = info-&gt;data;
 	uint32_t tmp;
 	int status;
@@ -260,7 +258,7 @@ static int davinci_write_page(struct nand_device *nand, uint32_t page,
 
 	if (!nand-&gt;device)
 		return ERROR_NAND_DEVICE_NOT_PROBED;
-	if (!halted(info-&gt;target, &quot;write_page&quot;))
+	if (!halted(nand-&gt;target, &quot;write_page&quot;))
 		return ERROR_NAND_OPERATION_FAILED;
 
 	/* Always write both data and OOB ... we are not &quot;raw&quot; I/O! */
@@ -309,7 +307,7 @@ static int davinci_read_page(struct nand_device *nand, uint32_t page,
 
 	if (!nand-&gt;device)
 		return ERROR_NAND_DEVICE_NOT_PROBED;
-	if (!halted(info-&gt;target, &quot;read_page&quot;))
+	if (!halted(nand-&gt;target, &quot;read_page&quot;))
 		return ERROR_NAND_OPERATION_FAILED;
 
 	return info-&gt;read_page(nand, page, data, data_size, oob, oob_size);
@@ -318,7 +316,7 @@ static int davinci_read_page(struct nand_device *nand, uint32_t page,
 static void davinci_write_pagecmd(struct nand_device *nand, uint8_t cmd, uint32_t page)
 {
 	struct davinci_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 	int page3 = nand-&gt;address_cycles - (nand-&gt;page_size == 512);
 
 	/* write command ({page,otp}x{read,program} */
@@ -341,7 +339,7 @@ static void davinci_write_pagecmd(struct nand_device *nand, uint8_t cmd, uint32_
 static int davinci_seek_column(struct nand_device *nand, uint16_t column)
 {
 	struct davinci_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	/* Random read, we must have issued a page read already */
 	target_write_u8(target, info-&gt;cmd, NAND_CMD_RNDOUT);
@@ -363,7 +361,7 @@ static int davinci_writepage_tail(struct nand_device *nand,
 		uint8_t *oob, uint32_t oob_size)
 {
 	struct davinci_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 	uint8_t status;
 
 	if (oob_size)
@@ -396,7 +394,7 @@ static int davinci_write_page_ecc1(struct nand_device *nand, uint32_t page,
 {
 	unsigned oob_offset;
 	struct davinci_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 	const uint32_t fcr_addr = info-&gt;aemif + NANDFCR;
 	const uint32_t ecc1_addr = info-&gt;aemif + NANDFECC + (4 * info-&gt;chipsel);
 	uint32_t fcr, ecc1;
@@ -484,7 +482,7 @@ static int davinci_write_page_ecc4(struct nand_device *nand, uint32_t page,
 
 	struct davinci_nand *info = nand-&gt;controller_priv;
 	const uint8_t *l;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 	const uint32_t fcr_addr = info-&gt;aemif + NANDFCR;
 	const uint32_t ecc4_addr = info-&gt;aemif + NAND4BITECC;
 	uint32_t fcr, ecc4;
@@ -564,7 +562,7 @@ static int davinci_write_page_ecc4infix(struct nand_device *nand, uint32_t page,
 		uint8_t *data, uint32_t data_size, uint8_t *oob, uint32_t oob_size)
 {
 	struct davinci_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 	const uint32_t fcr_addr = info-&gt;aemif + NANDFCR;
 	const uint32_t ecc4_addr = info-&gt;aemif + NAND4BITECC;
 	uint32_t fcr, ecc4;
@@ -678,7 +676,6 @@ static int davinci_read_page_ecc4infix(struct nand_device *nand, uint32_t page,
 NAND_DEVICE_COMMAND_HANDLER(davinci_nand_device_command)
 {
 	struct davinci_nand *info;
-	struct target *target;
 	unsigned long chip, aemif;
 	enum ecc eccmode;
 	int chipsel;
@@ -698,12 +695,6 @@ NAND_DEVICE_COMMAND_HANDLER(davinci_nand_device_command)
 		goto fail;
 	}
 
-	target = get_target(CMD_ARGV[1]);
-	if (!target) {
-		LOG_ERROR(&quot;invalid target %s&quot;, CMD_ARGV[1]);
-		goto fail;
-	}
-
 	COMMAND_PARSE_NUMBER(ulong, CMD_ARGV[2], chip);
 	if (chip == 0) {
 		LOG_ERROR(&quot;Invalid NAND chip address %s&quot;, CMD_ARGV[2]);
@@ -749,7 +740,6 @@ NAND_DEVICE_COMMAND_HANDLER(davinci_nand_device_command)
 	if (info == NULL)
 		goto fail;
 
-	info-&gt;target = target;
 	info-&gt;eccmode = eccmode;
 	info-&gt;chipsel = chipsel;
 	info-&gt;aemif = aemif;
@@ -759,7 +749,7 @@ NAND_DEVICE_COMMAND_HANDLER(davinci_nand_device_command)
 
 	nand-&gt;controller_priv = info;
 
-	info-&gt;io.target = target;
+	info-&gt;io.target = nand-&gt;target;
 	info-&gt;io.data = info-&gt;data;
 	info-&gt;io.op = ARM_NAND_NONE;
 

commit 2e1f2b50fdac6ece0d9d1cfd99cfedc36615d574
Author: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;
Date:   Fri Dec 31 19:46:02 2010 +0800

    NAND/AT91SAM9: remove private &quot;target&quot; copy
    
    Remove &quot;target&quot; form private data, and use
    common one in struct nand_block.
    
    Signed-off-by: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;

diff --git a/src/flash/nand/at91sam9.c b/src/flash/nand/at91sam9.c
index 92ab047..d118f6c 100644
--- a/src/flash/nand/at91sam9.c
+++ b/src/flash/nand/at91sam9.c
@@ -38,9 +38,6 @@
  * Representation of a pin on an AT91SAM9 chip.
  */
 struct at91sam9_pin {
-	/** Target this pin is on. */
-	struct target *target;
-
 	/** Address of the PIO controller. */
 	uint32_t pioc;
 
@@ -52,9 +49,6 @@ struct at91sam9_pin {
  * Private data for the controller that is stored in the NAND device structure.
  */
 struct at91sam9_nand {
-	/** Target the NAND is attached to. */
-	struct target *target;
-
 	/** Address of the ECC controller for NAND. */
 	uint32_t ecc;
 
@@ -101,8 +95,7 @@ static int at91sam9_halted(struct target *target, const char *label)
  */
 static int at91sam9_init(struct nand_device *nand)
 {
-	struct at91sam9_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (!at91sam9_halted(target, &quot;init&quot;)) {
 		return ERROR_NAND_OPERATION_FAILED;
@@ -117,9 +110,10 @@ static int at91sam9_init(struct nand_device *nand)
  * @param info NAND controller information for controlling NAND device.
  * @return Success or failure of the enabling.
  */
-static int at91sam9_enable(struct at91sam9_nand *info)
+static int at91sam9_enable(struct nand_device *nand)
 {
-	struct target *target = info-&gt;target;
+	struct at91sam9_nand *info = nand-&gt;controller_priv;
+	struct target *target = nand-&gt;target;
 
 	return target_write_u32(target, info-&gt;ce.pioc + AT91C_PIOx_CODR, 1 &lt;&lt; info-&gt;ce.num);
 }
@@ -130,9 +124,10 @@ static int at91sam9_enable(struct at91sam9_nand *info)
  * @param info NAND controller information for controlling NAND device.
  * @return Success or failure of the disabling.
  */
-static int at91sam9_disable(struct at91sam9_nand *info)
+static int at91sam9_disable(struct nand_device *nand)
 {
-	struct target *target = info-&gt;target;
+	struct at91sam9_nand *info = nand-&gt;controller_priv;
+	struct target *target = nand-&gt;target;
 
 	return target_write_u32(target, info-&gt;ce.pioc + AT91C_PIOx_SODR, 1 &lt;&lt; info-&gt;ce.num);
 }
@@ -147,13 +142,13 @@ static int at91sam9_disable(struct at91sam9_nand *info)
 static int at91sam9_command(struct nand_device *nand, uint8_t command)
 {
 	struct at91sam9_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (!at91sam9_halted(target, &quot;command&quot;)) {
 		return ERROR_NAND_OPERATION_FAILED;
 	}
 
-	at91sam9_enable(info);
+	at91sam9_enable(nand);
 
 	return target_write_u8(target, info-&gt;cmd, command);
 }
@@ -166,13 +161,11 @@ static int at91sam9_command(struct nand_device *nand, uint8_t command)
  */
 static int at91sam9_reset(struct nand_device *nand)
 {
-	struct at91sam9_nand *info = nand-&gt;controller_priv;
-
-	if (!at91sam9_halted(info-&gt;target, &quot;reset&quot;)) {
+	if (!at91sam9_halted(nand-&gt;target, &quot;reset&quot;)) {
 		return ERROR_NAND_OPERATION_FAILED;
 	}
 
-	return at91sam9_disable(info);
+	return at91sam9_disable(nand);
 }
 
 /**
@@ -185,9 +178,9 @@ static int at91sam9_reset(struct nand_device *nand)
 static int at91sam9_address(struct nand_device *nand, uint8_t address)
 {
 	struct at91sam9_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 
-	if (!at91sam9_halted(info-&gt;target, &quot;address&quot;)) {
+	if (!at91sam9_halted(nand-&gt;target, &quot;address&quot;)) {
 		return ERROR_NAND_OPERATION_FAILED;
 	}
 
@@ -205,9 +198,9 @@ static int at91sam9_address(struct nand_device *nand, uint8_t address)
 static int at91sam9_read_data(struct nand_device *nand, void *data)
 {
 	struct at91sam9_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 
-	if (!at91sam9_halted(info-&gt;target, &quot;read data&quot;)) {
+	if (!at91sam9_halted(nand-&gt;target, &quot;read data&quot;)) {
 		return ERROR_NAND_OPERATION_FAILED;
 	}
 
@@ -225,7 +218,7 @@ static int at91sam9_read_data(struct nand_device *nand, void *data)
 static int at91sam9_write_data(struct nand_device *nand, uint16_t data)
 {
 	struct at91sam9_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 
 	if (!at91sam9_halted(target, &quot;write data&quot;)) {
 		return ERROR_NAND_OPERATION_FAILED;
@@ -244,7 +237,7 @@ static int at91sam9_write_data(struct nand_device *nand, uint16_t data)
 static int at91sam9_nand_ready(struct nand_device *nand, int timeout)
 {
 	struct at91sam9_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 	uint32_t status;
 
 	if (!at91sam9_halted(target, &quot;nand ready&quot;)) {
@@ -279,7 +272,7 @@ static int at91sam9_read_block_data(struct nand_device *nand, uint8_t *data, int
 	struct arm_nand_data *io = &amp;info-&gt;io;
 	int status;
 
-	if (!at91sam9_halted(info-&gt;target, &quot;read block&quot;)) {
+	if (!at91sam9_halted(nand-&gt;target, &quot;read block&quot;)) {
 		return ERROR_NAND_OPERATION_FAILED;
 	}
 
@@ -304,7 +297,7 @@ static int at91sam9_write_block_data(struct nand_device *nand, uint8_t *data, in
 	struct arm_nand_data *io = &amp;info-&gt;io;
 	int status;
 
-	if (!at91sam9_halted(info-&gt;target, &quot;write block&quot;)) {
+	if (!at91sam9_halted(nand-&gt;target, &quot;write block&quot;)) {
 		return ERROR_NAND_OPERATION_FAILED;
 	}
 
@@ -381,7 +374,7 @@ static int at91sam9_read_page(struct nand_device *nand, uint32_t page,
 {
 	int retval;
 	struct at91sam9_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 	uint8_t *oob_data;
 	uint32_t status;
 
@@ -458,7 +451,7 @@ static int at91sam9_write_page(struct nand_device *nand, uint32_t page,
 		uint8_t *data, uint32_t data_size, uint8_t *oob, uint32_t oob_size)
 {
 	struct at91sam9_nand *info = nand-&gt;controller_priv;
-	struct target *target = info-&gt;target;
+	struct target *target = nand-&gt;target;
 	int retval;
 	uint8_t *oob_data = oob;
 	uint32_t parity, nparity;
@@ -517,7 +510,6 @@ static int at91sam9_write_page(struct nand_device *nand, uint32_t page,
  */
 NAND_DEVICE_COMMAND_HANDLER(at91sam9_nand_device_command)
 {
-	struct target *target = NULL;
 	unsigned long chip = 0, ecc = 0;
 	struct at91sam9_nand *info = NULL;
 
@@ -528,12 +520,6 @@ NAND_DEVICE_COMMAND_HANDLER(at91sam9_nand_device_command)
 		return ERROR_NAND_OPERATION_FAILED;
 	}
 
-	target = get_target(CMD_ARGV[1]);
-	if (!target) {
-		LOG_ERROR(&quot;invalid target: %s&quot;, CMD_ARGV[1]);
-		return ERROR_NAND_OPERATION_FAILED;
-	}
-
 	COMMAND_PARSE_NUMBER(ulong, CMD_ARGV[2], chip);
 	if (chip == 0) {
 		LOG_ERROR(&quot;invalid NAND chip address: %s&quot;, CMD_ARGV[2]);
@@ -554,14 +540,13 @@ NAND_DEVICE_COMMAND_HANDLER(at91sam9_nand_device_command)
 		return ERROR_NAND_OPERATION_FAILED;
 	}
 
-	info-&gt;target = target;
 	info-&gt;data = chip;
 	info-&gt;cmd = chip | (1 &lt;&lt; 22);
 	info-&gt;addr = chip | (1 &lt;&lt; 21);
 	info-&gt;ecc = ecc;
 
 	nand-&gt;controller_priv = info;
-	info-&gt;io.target = target;
+	info-&gt;io.target = nand-&gt;target;
 	info-&gt;io.data = info-&gt;data;
 	info-&gt;io.op = ARM_NAND_NONE;
 

commit 5f3603b8ef732311516dcdad43261ca668e20626
Author: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;
Date:   Fri Dec 31 19:46:01 2010 +0800

    NAND/TCL: prepare for common &quot;target&quot; reference
    
    Every NAND driver keeps private copy of &quot;target&quot;
    structure.
    Prepare infostructure to move private &quot;target&quot;
    copy in common/shared struct nand_device.
    
    Signed-off-by: Antonio Borneo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">borneo.antonio at gmail.com</A>&gt;

diff --git a/src/flash/nand/core.h b/src/flash/nand/core.h
index 709c37b..73fd0ed 100644
--- a/src/flash/nand/core.h
+++ b/src/flash/nand/core.h
@@ -60,6 +60,7 @@ struct nand_ecclayout {
 struct nand_device
 {
 	const char *name;
+	struct target *target;
 	struct nand_flash_controller *controller;
 	void *controller_priv;
 	struct nand_manufacturer *manufacturer;
diff --git a/src/flash/nand/tcl.c b/src/flash/nand/tcl.c
index 70584ff..e4bfb4d 100644
--- a/src/flash/nand/tcl.c
+++ b/src/flash/nand/tcl.c
@@ -27,6 +27,7 @@
 #include &quot;core.h&quot;
 #include &quot;imp.h&quot;
 #include &quot;fileio.h&quot;
+#include &lt;target/target.h&gt;
 
 // to be removed
 extern struct nand_device *nand_devices;
@@ -537,16 +538,37 @@ COMMAND_HANDLER(handle_nand_list_drivers)
 static COMMAND_HELPER(create_nand_device, const char *bank_name,
 		struct nand_flash_controller *controller)
 {
+	struct nand_device *c;
+	struct target *target;
+	int retval;
+
+	if (CMD_ARGC &lt; 2)
+	{
+		LOG_ERROR(&quot;missing target&quot;);
+		return ERROR_COMMAND_ARGUMENT_INVALID;
+	}
+	target = get_target(CMD_ARGV[1]);
+	if (!target) {
+		LOG_ERROR(&quot;invalid target %s&quot;, CMD_ARGV[1]);
+		return ERROR_COMMAND_ARGUMENT_INVALID;
+	}
+
 	if (NULL != controller-&gt;commands)
 	{
-		int retval = register_commands(CMD_CTX, NULL,
+		retval = register_commands(CMD_CTX, NULL,
 				controller-&gt;commands);
 		if (ERROR_OK != retval)
 			return retval;
 	}
-	struct nand_device *c = malloc(sizeof(struct nand_device));
+	c = malloc(sizeof(struct nand_device));
+	if (c == NULL)
+	{
+		LOG_ERROR(&quot;End of memory&quot;);
+		return ERROR_FAIL;
+	}
 
 	c-&gt;name = strdup(bank_name);
+	c-&gt;target = target;
 	c-&gt;controller = controller;
 	c-&gt;controller_priv = NULL;
 	c-&gt;manufacturer = NULL;
@@ -557,7 +579,7 @@ static COMMAND_HELPER(create_nand_device, const char *bank_name,
 	c-&gt;use_raw = 0;
 	c-&gt;next = NULL;
 
-	int retval = CALL_COMMAND_HANDLER(controller-&gt;nand_device_command, c);
+	retval = CALL_COMMAND_HANDLER(controller-&gt;nand_device_command, c);
 	if (ERROR_OK != retval)
 	{
 		LOG_ERROR(&quot;'%s' driver rejected nand flash&quot;, controller-&gt;name);

-----------------------------------------------------------------------

Summary of changes:
 src/flash/nand/at91sam9.c |   59 ++++++++++++++++----------------------------
 src/flash/nand/core.h     |    1 +
 src/flash/nand/davinci.c  |   44 +++++++++++++--------------------
 src/flash/nand/lpc3180.c  |   39 ++++++++++++-----------------
 src/flash/nand/lpc3180.h  |    1 -
 src/flash/nand/mx2.c      |   30 ++++++++--------------
 src/flash/nand/mx2.h      |    1 -
 src/flash/nand/mx3.c      |   32 ++++++++----------------
 src/flash/nand/mx3.h      |    1 -
 src/flash/nand/nuc910.c   |   28 +++++----------------
 src/flash/nand/orion.c    |   18 ++++----------
 src/flash/nand/s3c2410.c  |   12 +++------
 src/flash/nand/s3c2412.c  |    3 +-
 src/flash/nand/s3c2440.c  |    9 +++----
 src/flash/nand/s3c2443.c  |    3 +-
 src/flash/nand/s3c24xx.c  |   17 ++++---------
 src/flash/nand/s3c24xx.h  |    2 -
 src/flash/nand/s3c6400.c  |    3 +-
 src/flash/nand/tcl.c      |   28 +++++++++++++++++++--
 19 files changed, 131 insertions(+), 200 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002482.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-686-g21a1c6e
</A></li>
	<LI>Next message: <A HREF="002484.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-697-gd356034
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2483">[ date ]</a>
              <a href="thread.html#2483">[ thread ]</a>
              <a href="subject.html#2483">[ subject ]</a>
              <a href="author.html#2483">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openocd-svn">More information about the openocd-svn
mailing list</a><br>
</body></html>
