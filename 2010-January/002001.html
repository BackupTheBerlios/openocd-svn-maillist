<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-rc1-51-g9d83df7
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openocd-svn/2010-January/index.html" >
   <LINK REL="made" HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.4.0-rc1-51-g9d83df7&In-Reply-To=%3CE1NSFV5-00058W-Rz%40sfp-scmshell-2.v30.ch3.sourceforge.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002000.html">
   <LINK REL="Next"  HREF="002002.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-rc1-51-g9d83df7</H1>
    <B>Spencer Oliver</B> 
    <A HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.4.0-rc1-51-g9d83df7&In-Reply-To=%3CE1NSFV5-00058W-Rz%40sfp-scmshell-2.v30.ch3.sourceforge.com%3E"
       TITLE="[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-rc1-51-g9d83df7">ntfreak at users.sourceforge.net
       </A><BR>
    <I>Tue Jan  5 20:55:30 CET 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002000.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-rc1-46-g95f86e8
</A></li>
        <LI>Next message: <A HREF="002002.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-rc1-53-gfccb812
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2001">[ date ]</a>
              <a href="thread.html#2001">[ thread ]</a>
              <a href="subject.html#2001">[ subject ]</a>
              <a href="author.html#2001">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Main OpenOCD repository&quot;.

The branch, master has been updated
       via  9d83df72dcbfc791b470b12949890df3f2d1508d (commit)
       via  ba96fc3e9de935708cd5fa7c38e547dc7598087d (commit)
       via  f6412d9c7b22ab25caec6be19317f0fc4a840fdd (commit)
       via  faad9e59233306e608a3a01388a38099ece9688b (commit)
       via  03e8649bc699053ccdbbd4a3c2eaf05241e22a5b (commit)
      from  95f86e8e0525fc93093cc2bc060df5017d2f504e (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 9d83df72dcbfc791b470b12949890df3f2d1508d
Author: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;
Date:   Tue Jan 5 17:43:29 2010 +0000

    MIPS: pracc access tweaks
    
    reorder the pracc access so we can save a few access cycles
    
    Signed-off-by: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;

diff --git a/src/target/mips32_pracc.c b/src/target/mips32_pracc.c
index 4bd1da7..26d5a6b 100644
--- a/src/target/mips32_pracc.c
+++ b/src/target/mips32_pracc.c
@@ -319,9 +319,8 @@ int mips32_pracc_read_mem32(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_B(NEG16(27)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_B(NEG16(28)),								/* b start */
-		MIPS32_NOP,
 	};
 
 	int retval = ERROR_OK;
@@ -422,9 +421,8 @@ int mips32_pracc_read_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
-		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_B(NEG16(28)),								/* b start */
-		MIPS32_NOP,
+		MIPS32_B(NEG16(27)),								/* b start */
+		MIPS32_MFC0(15,30,0),								/* move COP0 DeSave to $15 */
 	};
 
 	/* TODO remove array */
@@ -500,9 +498,8 @@ int mips32_pracc_read_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int cou
 		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_B(NEG16(27)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_B(NEG16(28)),								/* b start */
-		MIPS32_NOP,
 	};
 
 	/* TODO remove array */
@@ -677,9 +674,8 @@ int mips32_pracc_write_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int c
 		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_B(NEG16(26)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_B(NEG16(27)),								/* b start */
-		MIPS32_NOP,
 	};
 
 	/* TODO remove array */
@@ -736,9 +732,8 @@ int mips32_pracc_write_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
+		MIPS32_B(NEG16(26)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_B(NEG16(27)),								/* b start */
-		MIPS32_NOP,
 	};
 
 	/* TODO remove array */
@@ -819,9 +814,8 @@ int mips32_pracc_write_regs(struct mips_ejtag *ejtag_info, uint32_t *regs)
 
 		MIPS32_LW(2,2*4,1), 							/* lw $2,2*4($1) */
 		MIPS32_LW(1,0,15), 								/* lw $1,($15) */
+		MIPS32_B(NEG16(53)),							/* b start */
 		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-		MIPS32_B(NEG16(54)),							/* b start */
-		MIPS32_NOP,
 	};
 
 	int retval;
@@ -895,9 +889,8 @@ int mips32_pracc_read_regs(struct mips_ejtag *ejtag_info, uint32_t *regs)
 
 		MIPS32_LW(2,0,15), 								/* lw $2,($15) */
 		MIPS32_LW(1,0,15), 								/* lw $1,($15) */
+		MIPS32_B(NEG16(58)),							/* b start */
 		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-		MIPS32_B(NEG16(59)),							/* b start */
-		MIPS32_NOP,
 	};
 
 	int retval;

commit ba96fc3e9de935708cd5fa7c38e547dc7598087d
Author: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;
Date:   Mon Dec 21 17:23:09 2009 +0000

    PIC32: enable ram execution
    
    add reset-init script to allow ram execution from reset, this is required for ejtag fastdata access.
    
    Signed-off-by: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;

diff --git a/tcl/target/pic32mx.cfg b/tcl/target/pic32mx.cfg
index e0ebdc2..1561d73 100644
--- a/tcl/target/pic32mx.cfg
+++ b/tcl/target/pic32mx.cfg
@@ -31,7 +31,23 @@ jtag newtap $_CHIPNAME cpu -irlen 5  -ircapture 0x1 -irmask 0x1f -expected-id $_
 set _TARGETNAME $_CHIPNAME.cpu
 target create $_TARGETNAME mips_m4k -endian $_ENDIAN -chain-position $_TARGETNAME
 
-$_TARGETNAME configure -work-area-phys 0xa0000000 -work-area-size 16384 -work-area-backup 0
+$_TARGETNAME configure -work-area-phys 0xa0000800 -work-area-size 16384 -work-area-backup 0
+
+$_TARGETNAME configure -event reset-init {
+	#
+	# from reset the pic32 cannot execute code in ram - enable ram execution
+	# minimum offset from start of ram is 2k
+	#
+
+	# BMXCON
+	mww 0xbf882000 0x001f0040
+	# BMXDKPBA: 0xa0000800
+	mww 0xbf882010 0x00000800
+	# BMXDUDBA
+	mww 0xbf882020 0x00004000
+	# BMXDUPBA
+	mww 0xbf882030 0x00004000
+}
 
 set _FLASHNAME $_CHIPNAME.flash
 flash bank $_FLASHNAME pic32mx 0xbd000000 0 0 0 $_TARGETNAME

commit f6412d9c7b22ab25caec6be19317f0fc4a840fdd
Author: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;
Date:   Mon Dec 21 16:33:03 2009 +0000

    MIPS: optimize pracc access
    
    remove unnecessary nops when accessing ejtag pracc
    general fastdata patch cleanup
    
    Signed-off-by: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;

diff --git a/src/target/mips32_pracc.c b/src/target/mips32_pracc.c
index 34794f3..4bd1da7 100644
--- a/src/target/mips32_pracc.c
+++ b/src/target/mips32_pracc.c
@@ -33,7 +33,6 @@ instruction after a branch instruction (one delay slot).
 
 For example:
 
-
     LW $2, ($5 +10)
     B foo
     LW $1, ($2 +100)
@@ -129,7 +128,7 @@ static int mips32_pracc_exec_read(struct mips32_pracc_context *ctx, uint32_t add
 		data = ctx-&gt;local_oparam[offset];
 	}
 	else if ((address &gt;= MIPS32_PRACC_TEXT)
-		&amp;&amp; (address &lt;= MIPS32_PRACC_TEXT + ctx-&gt;code_len*4))
+		&amp;&amp; (address &lt;= MIPS32_PRACC_TEXT + ctx-&gt;code_len * 4))
 	{
 		offset = (address - MIPS32_PRACC_TEXT) / 4;
 		data = ctx-&gt;code[offset];
@@ -145,7 +144,7 @@ static int mips32_pracc_exec_read(struct mips32_pracc_context *ctx, uint32_t add
 		 * to start of debug vector */
 
 		data = 0;
-		LOG_ERROR(&quot;Error reading unexpected address %8.8&quot; PRIx32 &quot;&quot;, address);
+		LOG_ERROR(&quot;Error reading unexpected address 0x%8.8&quot; PRIx32 &quot;&quot;, address);
 		return ERROR_JTAG_DEVICE_ERROR;
 	}
 
@@ -154,7 +153,6 @@ static int mips32_pracc_exec_read(struct mips32_pracc_context *ctx, uint32_t add
 	mips_ejtag_drscan_32(ctx-&gt;ejtag_info, &amp;data);
 
 	/* Clear the access pending bit (let the processor eat!) */
-
 	ejtag_ctrl = ejtag_info-&gt;ejtag_ctrl &amp; ~EJTAG_CTRL_PRACC;
 	mips_ejtag_set_instr(ctx-&gt;ejtag_info, EJTAG_INST_CONTROL, NULL);
 	mips_ejtag_drscan_32(ctx-&gt;ejtag_info, &amp;ejtag_ctrl);
@@ -201,7 +199,7 @@ static int mips32_pracc_exec_write(struct mips32_pracc_context *ctx, uint32_t ad
 	}
 	else
 	{
-		LOG_ERROR(&quot;Error writing unexpected address %8.8&quot; PRIx32 &quot;&quot;, address);
+		LOG_ERROR(&quot;Error writing unexpected address 0x%8.8&quot; PRIx32 &quot;&quot;, address);
 		return ERROR_JTAG_DEVICE_ERROR;
 	}
 
@@ -234,8 +232,6 @@ int mips32_pracc_exec(struct mips_ejtag *ejtag_info, int code_len, const uint32_
 		mips_ejtag_set_instr(ejtag_info, EJTAG_INST_ADDRESS, NULL);
 		mips_ejtag_drscan_32(ejtag_info, &amp;address);
 
-//		printf(&quot;Adres: %.8x\n&quot;, address);
-
 		/* Check for read or write */
 		if (ejtag_ctrl &amp; EJTAG_CTRL_PRNW)
 		{
@@ -305,9 +301,8 @@ int mips32_pracc_read_mem32(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(10,4,8),									/* $10 = mem[$8 + 4]; read count */
 		MIPS32_LUI(11,UPPER16(MIPS32_PRACC_PARAM_OUT)), 	/* $11 = MIPS32_PRACC_PARAM_OUT */
 		MIPS32_ORI(11,11,LOWER16(MIPS32_PRACC_PARAM_OUT)),
-		MIPS32_NOP,
 															/* loop: */
-		MIPS32_BEQ(0,10,9),									/* beq 0, $10, end */
+		MIPS32_BEQ(0,10,8),									/* beq 0, $10, end */
 		MIPS32_NOP,
 
 		MIPS32_LW(8,0,9), 									/* lw $8,0($9), Load $8 with the word @mem[$9] */
@@ -317,8 +312,7 @@ int mips32_pracc_read_mem32(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_ADDI(9,9,4), 								/* $1 += 4 */
 		MIPS32_ADDI(11,11,4), 								/* $11 += 4 */
 
-		MIPS32_NOP,
-		MIPS32_B(NEG16(9)),									/* b loop */
+		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
 															/* end: */
 		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
@@ -326,8 +320,7 @@ int mips32_pracc_read_mem32(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(31)),								/* b start */
+		MIPS32_B(NEG16(28)),								/* b start */
 		MIPS32_NOP,
 	};
 
@@ -370,15 +363,14 @@ int mips32_pracc_read_u32(struct mips_ejtag *ejtag_info, uint32_t addr, uint32_t
 		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_STACK)),
 		MIPS32_SW(8,0,15), 									/* sw $8,($15) */
 
-		MIPS32_LW(8,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN), 15),  //load R8 @ param_in[0] = address
+		MIPS32_LW(8,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN),15), /* load R8 @ param_in[0] = address */
 
 		MIPS32_LW(8,0,8), 									/* lw $8,0($8), Load $8 with the word @mem[$8] */
-		MIPS32_SW(8,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_OUT),15), 									/* sw $8,0($9) */
+		MIPS32_SW(8,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_OUT),15), /* store R8 @ param_out[0] */
 
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
-		MIPS32_B(NEG16(9)),	//was 17							/* b start */
-		MIPS32_MFC0(15,31,0),   //this instruction will be executed (MIPS executes instruction after jump)							/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
+		MIPS32_B(NEG16(9)),									/* b start */
+		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
 	};
 
 	int retval = ERROR_OK;
@@ -387,7 +379,7 @@ int mips32_pracc_read_u32(struct mips_ejtag *ejtag_info, uint32_t addr, uint32_t
 	param_in[0] = addr;
 
 	if ((retval = mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code,
-		ARRAY_SIZE(param_in), param_in, sizeof(uint32_t), buf, 1)) != ERROR_OK)
+		ARRAY_SIZE(param_in), param_in, 1, buf, 1)) != ERROR_OK)
 	{
 		return retval;
 	}
@@ -413,9 +405,8 @@ int mips32_pracc_read_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(10,4,8),									/* $10 = mem[$8 + 4]; read count */
 		MIPS32_LUI(11,UPPER16(MIPS32_PRACC_PARAM_OUT)),		/* $11 = MIPS32_PRACC_PARAM_OUT */
 		MIPS32_ORI(11,11,LOWER16(MIPS32_PRACC_PARAM_OUT)),
-		MIPS32_NOP,
 															/* loop: */
-		MIPS32_BEQ(0,10,9), 								/* beq 0, $10, end */
+		MIPS32_BEQ(0,10,8), 								/* beq 0, $10, end */
 		MIPS32_NOP,
 
 		MIPS32_LHU(8,0,9), 									/* lw $8,0($9), Load $8 with the halfword @mem[$9] */
@@ -424,21 +415,19 @@ int mips32_pracc_read_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_ADDI(10,10,NEG16(1)), 						/* $10-- */
 		MIPS32_ADDI(9,9,2), 								/* $9 += 2 */
 		MIPS32_ADDI(11,11,4), 								/* $11 += 4 */
+		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
-		MIPS32_B(NEG16(9)),									/* b loop */
-		MIPS32_NOP,
-
+															/* end: */
 		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
 		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(31)),								/* b start */
+		MIPS32_B(NEG16(28)),								/* b start */
 		MIPS32_NOP,
 	};
 
-//	/* TODO remove array */
+	/* TODO remove array */
 	uint32_t *param_out = malloc(count * sizeof(uint32_t));
 	int i;
 
@@ -494,9 +483,8 @@ int mips32_pracc_read_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int cou
 		MIPS32_LW(10,4,8), 									/* $10 = mem[$8 + 4]; read count */
 		MIPS32_LUI(11,UPPER16(MIPS32_PRACC_PARAM_OUT)), 	/* $11 = MIPS32_PRACC_PARAM_OUT */
 		MIPS32_ORI(11,11,LOWER16(MIPS32_PRACC_PARAM_OUT)),
-		MIPS32_NOP,
 															/* loop: */
-		MIPS32_BEQ(0,10,9), 								/* beq 0, $10, end */
+		MIPS32_BEQ(0,10,8), 								/* beq 0, $10, end */
 		MIPS32_NOP,
 
 		MIPS32_LBU(8,0,9), 									/* lw $8,0($9), Load t4 with the byte @mem[t1] */
@@ -505,8 +493,7 @@ int mips32_pracc_read_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int cou
 		MIPS32_ADDI(10,10,NEG16(1)), 						/* $10-- */
 		MIPS32_ADDI(9,9,1), 								/* $9 += 1 */
 		MIPS32_ADDI(11,11,4), 								/* $11 += 4 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(9)),									/* b loop */
+		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
 															/* end: */
 		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
@@ -514,12 +501,11 @@ int mips32_pracc_read_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int cou
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(31)),								/* b start */
+		MIPS32_B(NEG16(28)),								/* b start */
 		MIPS32_NOP,
 	};
 
-//	/* TODO remove array */
+	/* TODO remove array */
 	uint32_t *param_out = malloc(count * sizeof(uint32_t));
 	int i;
 
@@ -577,8 +563,6 @@ int mips32_pracc_write_mem(struct mips_ejtag *ejtag_info, uint32_t addr, int siz
 
 int mips32_pracc_write_mem32(struct mips_ejtag *ejtag_info, uint32_t addr, int count, uint32_t *buf)
 {
-
-//NC: use destination pointer as loop counter (last address is in $10)
 	static const uint32_t code[] = {
 															/* start: */
 		MIPS32_MTC0(15,31,0),								/* move $15 to COP0 DeSave */
@@ -589,32 +573,32 @@ int mips32_pracc_write_mem32(struct mips_ejtag *ejtag_info, uint32_t addr, int c
 		MIPS32_SW(10,0,15), 								/* sw $10,($15) */
 		MIPS32_SW(11,0,15), 								/* sw $11,($15) */
 
-		MIPS32_ADDI(8,15,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN)),  //$8= MIPS32_PRACC_PARAM_IN
+		MIPS32_ADDI(8,15,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN)),  /* $8= MIPS32_PRACC_PARAM_IN */
 		MIPS32_LW(9,0,8), 									/* Load write addr to $9 */
-		MIPS32_LW(10,4,8),	//last address 									/* Load write count to $10 */
-		MIPS32_ADDI(8,8,8), 	// $8 += 8 beginning of data
+		MIPS32_LW(10,4,8),									/* Load write count to $10 */
+		MIPS32_ADDI(8,8,8),									/* $8 += 8 beginning of data */
 
-//loop:
+															/* loop: */
 		MIPS32_LW(11,0,8), 									/* lw $11,0($8), Load $11 with the word @mem[$8] */
 		MIPS32_SW(11,0,9), 									/* sw $11,0($9) */
 
 		MIPS32_ADDI(9,9,4), 								/* $9 += 4 */
-		MIPS32_BNE(10,9,NEG16(4)),  //was 9 BNE $10, 9, loop									/* b loop */
-		MIPS32_ADDI(8,8,4),  //this instruction is part of the loop (one delay slot)!	/* $8 += 4 */
+		MIPS32_BNE(10,9,NEG16(4)),							/* bne $10, $9, loop */
+		MIPS32_ADDI(8,8,4),									/* $8 += 4 */
+
 															/* end: */
 		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
 		MIPS32_LW(10,0,15), 								/* lw $10,($15) */
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
-		MIPS32_B(NEG16(21)),	 //was 30							/* b start */
+		MIPS32_B(NEG16(21)),								/* b start */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_NOP, //this one will not be executed
 	};
 
 	/* TODO remove array */
 	uint32_t *param_in = malloc((count + 2) * sizeof(uint32_t));
 	param_in[0] = addr;
-	param_in[1] = addr + count * sizeof(uint32_t);	//last address
+	param_in[1] = addr + (count * sizeof(uint32_t));	/* last address */
 
 	memcpy(&amp;param_in[2], buf, count * sizeof(uint32_t));
 
@@ -636,16 +620,15 @@ int mips32_pracc_write_u32(struct mips_ejtag *ejtag_info, uint32_t addr, uint32_
 		MIPS32_SW(8,0,15), 									/* sw $8,($15) */
 		MIPS32_SW(9,0,15), 									/* sw $9,($15) */
 
-		MIPS32_LW(8,NEG16((MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN)-4), 15),  //load R8 @ param_in[1] = data
-		MIPS32_LW(9,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN), 15),  //load R9 @ param_in[0] = address
+		MIPS32_LW(8,NEG16((MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN)-4), 15),	/* load R8 @ param_in[1] = data */
+		MIPS32_LW(9,NEG16(MIPS32_PRACC_STACK-MIPS32_PRACC_PARAM_IN), 15),		/* load R9 @ param_in[0] = address */
 
 		MIPS32_SW(8,0,9), 									/* sw $8,0($9) */
 
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
 		MIPS32_B(NEG16(11)),								/* b start */
-		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
+		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
 	};
 
 	/* TODO remove array */
@@ -654,7 +637,7 @@ int mips32_pracc_write_u32(struct mips_ejtag *ejtag_info, uint32_t addr, uint32_
 	param_in[1] = *buf;
 
 	mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code, \
-		ARRAY_SIZE(param_in),param_in, 0, NULL, 1);
+		ARRAY_SIZE(param_in), param_in, 0, NULL, 1);
 
 	return ERROR_OK;
 }
@@ -676,9 +659,8 @@ int mips32_pracc_write_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int c
 		MIPS32_LW(9,0,8), 									/* Load write addr to $9 */
 		MIPS32_LW(10,4,8), 									/* Load write count to $10 */
 		MIPS32_ADDI(8,8,8), 								/* $8 += 8 */
-		MIPS32_NOP,
 															/* loop: */
-		MIPS32_BEQ(0,10,9),									/* beq $0, $10, end */
+		MIPS32_BEQ(0,10,8),									/* beq $0, $10, end */
 		MIPS32_NOP,
 
 		MIPS32_LW(11,0,8), 									/* lw $11,0($8), Load $11 with the word @mem[$8] */
@@ -688,8 +670,7 @@ int mips32_pracc_write_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int c
 		MIPS32_ADDI(9,9,2), 								/* $9 += 2 */
 		MIPS32_ADDI(8,8,4), 								/* $8 += 4 */
 
-		MIPS32_NOP,
-		MIPS32_B(NEG16(9)),									/* b loop */
+		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
 															/* end: */
 		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
@@ -697,8 +678,7 @@ int mips32_pracc_write_mem16(struct mips_ejtag *ejtag_info, uint32_t addr, int c
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(30)),								/* b start */
+		MIPS32_B(NEG16(27)),								/* b start */
 		MIPS32_NOP,
 	};
 
@@ -738,9 +718,8 @@ int mips32_pracc_write_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(9,0,8), 									/* Load write addr to $9 */
 		MIPS32_LW(10,4,8), 									/* Load write count to $10 */
 		MIPS32_ADDI(8,8,8), 								/* $8 += 8 */
-		MIPS32_NOP,
 															/* loop: */
-		MIPS32_BEQ(0,10,9),									/* beq $0, $10, end */
+		MIPS32_BEQ(0,10,8),									/* beq $0, $10, end */
 		MIPS32_NOP,
 
 		MIPS32_LW(11,0,8), 									/* lw $11,0($8), Load $11 with the word @mem[$8] */
@@ -750,8 +729,7 @@ int mips32_pracc_write_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_ADDI(9,9,1), 								/* $9 += 1 */
 		MIPS32_ADDI(8,8,4), 								/* $8 += 4 */
 
-		MIPS32_NOP,
-		MIPS32_B(NEG16(9)),									/* b loop */
+		MIPS32_B(NEG16(8)),									/* b loop */
 		MIPS32_NOP,
 															/* end: */
 		MIPS32_LW(11,0,15), 								/* lw $11,($15) */
@@ -759,8 +737,7 @@ int mips32_pracc_write_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 		MIPS32_LW(9,0,15), 									/* lw $9,($15) */
 		MIPS32_LW(8,0,15), 									/* lw $8,($15) */
 		MIPS32_MFC0(15,31,0),								/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(30)),								/* b start */
+		MIPS32_B(NEG16(27)),								/* b start */
 		MIPS32_NOP,
 	};
 
@@ -777,7 +754,7 @@ int mips32_pracc_write_mem8(struct mips_ejtag *ejtag_info, uint32_t addr, int co
 	}
 
 	retval = mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code, \
-		count +2, param_in, 0, NULL, 1);
+		count + 2, param_in, 0, NULL, 1);
 
 	free(param_in);
 
@@ -843,15 +820,14 @@ int mips32_pracc_write_regs(struct mips_ejtag *ejtag_info, uint32_t *regs)
 		MIPS32_LW(2,2*4,1), 							/* lw $2,2*4($1) */
 		MIPS32_LW(1,0,15), 								/* lw $1,($15) */
 		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(55)),							/* b start */
+		MIPS32_B(NEG16(54)),							/* b start */
 		MIPS32_NOP,
 	};
 
 	int retval;
 
 	retval = mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code, \
-		38, regs, 0, NULL, 1);
+			MIPS32NUMCOREREGS, regs, 0, NULL, 1);
 
 	return retval;
 }
@@ -920,15 +896,14 @@ int mips32_pracc_read_regs(struct mips_ejtag *ejtag_info, uint32_t *regs)
 		MIPS32_LW(2,0,15), 								/* lw $2,($15) */
 		MIPS32_LW(1,0,15), 								/* lw $1,($15) */
 		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
-		MIPS32_B(NEG16(60)),							/* b start */
+		MIPS32_B(NEG16(59)),							/* b start */
 		MIPS32_NOP,
 	};
 
 	int retval;
 
 	retval = mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code, \
-		0, NULL, 38, regs, 1);
+		0, NULL, MIPS32NUMCOREREGS, regs, 1);
 
 	return retval;
 }
@@ -970,7 +945,6 @@ int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_are
 		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_TEXT)),
 		MIPS32_JR(15),									/* jr start */
 		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-		MIPS32_NOP,
 	};
 
 	uint32_t jmp_code[] = {
@@ -981,9 +955,6 @@ int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_are
 		MIPS32_NOP,
 	};
 
-#define JMP_CODE_SIZE (sizeof(jmp_code)/sizeof(jmp_code[0]))
-#define HANDLER_CODE_SIZE sizeof(handler_code)/sizeof(handler_code[0])
-
 	int retval, i;
 	uint32_t val, ejtag_ctrl, address;
 
@@ -1002,7 +973,7 @@ int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_are
 	}
 
 	/* write program into RAM */
-	mips32_pracc_write_mem32(ejtag_info, source-&gt;address, HANDLER_CODE_SIZE, handler_code);
+	mips32_pracc_write_mem32(ejtag_info, source-&gt;address, ARRAY_SIZE(handler_code), handler_code);
 
 	/* quick verify RAM is working */
 	mips32_pracc_read_u32(ejtag_info, source-&gt;address, &amp;val);
@@ -1017,7 +988,7 @@ int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_are
 	jmp_code[1] |= UPPER16(source-&gt;address);
 	jmp_code[2] |= LOWER16(source-&gt;address);
 
-	for (i = 0; i &lt; (int) JMP_CODE_SIZE; i++)
+	for (i = 0; i &lt; (int) ARRAY_SIZE(jmp_code); i++)
 	{
 		if ((retval = wait_for_pracc_rw(ejtag_info, &amp;ejtag_ctrl)) != ERROR_OK)
 			return retval;
@@ -1026,7 +997,6 @@ int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_are
 		mips_ejtag_drscan_32(ejtag_info, &amp;jmp_code[i]);
 
 		/* Clear the access pending bit (let the processor eat!) */
-
 		ejtag_ctrl = ejtag_info-&gt;ejtag_ctrl &amp; ~EJTAG_CTRL_PRACC;
 		mips_ejtag_set_instr(ejtag_info, EJTAG_INST_CONTROL, NULL);
 		mips_ejtag_drscan_32(ejtag_info, &amp;ejtag_ctrl);
diff --git a/src/target/mips32_pracc.h b/src/target/mips32_pracc.h
index 41a7325..a914686 100644
--- a/src/target/mips32_pracc.h
+++ b/src/target/mips32_pracc.h
@@ -28,7 +28,6 @@
 #define MIPS32_PRACC_FASTDATA_AREA		0xFF200000
 #define MIPS32_PRACC_FASTDATA_SIZE		16
 #define MIPS32_PRACC_TEXT			0xFF200200
-//#define MIPS32_PRACC_STACK			0xFF2FFFFC
 #define MIPS32_PRACC_STACK			0xFF204000
 #define MIPS32_PRACC_PARAM_IN		0xFF201000
 #define MIPS32_PRACC_PARAM_IN_SIZE	0x1000
diff --git a/src/target/mips_ejtag.c b/src/target/mips_ejtag.c
index 6f7baf0..bebad9a 100644
--- a/src/target/mips_ejtag.c
+++ b/src/target/mips_ejtag.c
@@ -139,10 +139,8 @@ int mips_ejtag_step_enable(struct mips_ejtag *ejtag_info)
 			MIPS32_MFC0(1,23,0),			/* move COP0 Debug to $1 */
 			MIPS32_ORI(1,1,0x0100),			/* set SSt bit in debug reg */
 			MIPS32_MTC0(1,23,0),			/* move $1 to COP0 Debug */
+			MIPS32_B(NEG16(5)),
 			MIPS32_MFC0(1,31,0),			/* move COP0 DeSave to $1 */
-			MIPS32_NOP,
-			MIPS32_B(NEG16(7)),
-			MIPS32_NOP,
 	};
 
 	mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code, \
@@ -165,10 +163,8 @@ int mips_ejtag_step_disable(struct mips_ejtag *ejtag_info)
 			MIPS32_MTC0(1,23,0),							/* move $1 to COP0 Debug */
 			MIPS32_LW(2,0,15),
 			MIPS32_LW(1,0,15),
+			MIPS32_B(NEG16(13)),
 			MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-			MIPS32_NOP,
-			MIPS32_B(NEG16(15)),
-			MIPS32_NOP,
 	};
 
 	mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code, \
@@ -230,10 +226,8 @@ int mips_ejtag_read_debug(struct mips_ejtag *ejtag_info, uint32_t* debug_reg)
 			MIPS32_SW(2,0,1),
 			MIPS32_LW(2,0,15),
 			MIPS32_LW(1,0,15),
+			MIPS32_B(NEG16(12)),
 			MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
-			MIPS32_NOP,
-			MIPS32_B(NEG16(14)),
-			MIPS32_NOP,
 	};
 
 	mips32_pracc_exec(ejtag_info, ARRAY_SIZE(code), code, \
diff --git a/src/target/mips_m4k.c b/src/target/mips_m4k.c
index f3191ae..4adc1f1 100644
--- a/src/target/mips_m4k.c
+++ b/src/target/mips_m4k.c
@@ -993,14 +993,14 @@ int mips_m4k_bulk_write_memory(struct target *target, uint32_t address, uint32_t
 	if (target-&gt;endianness == TARGET_BIG_ENDIAN)
 	{
 		uint32_t i, t32;
-		for(i = 0; i &lt; (count*4); i+=4)
+		for(i = 0; i &lt; (count * 4); i += 4)
 		{
 			t32 = be_to_h_u32((uint8_t *) &amp;buffer[i]);
 			h_u32_to_le(&amp;buffer[i], t32);
 		}
 	}
 
-	retval = mips32_pracc_fastdata_xfer(ejtag_info, source, write, address, count, (uint32_t *) buffer);
+	retval = mips32_pracc_fastdata_xfer(ejtag_info, source, write, address, count, (uint32_t*) buffer);
 
 	if (source)
 		target_free_working_area(target, source);

commit faad9e59233306e608a3a01388a38099ece9688b
Author: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;
Date:   Thu Dec 17 11:53:39 2009 +0000

    parport: output port as hex rather than dec
    
    Signed-off-by: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;

diff --git a/src/jtag/drivers/parport.c b/src/jtag/drivers/parport.c
index 2e6b9ed..b280d04 100644
--- a/src/jtag/drivers/parport.c
+++ b/src/jtag/drivers/parport.c
@@ -424,7 +424,7 @@ COMMAND_HANDLER(parport_handle_parport_port_command)
 		}
 	}
 
-	command_print(CMD_CTX, &quot;parport port = %u&quot;, parport_port);
+	command_print(CMD_CTX, &quot;parport port = 0x%&quot; PRIx16 &quot;&quot;, parport_port);
 
 	return ERROR_OK;
 }

commit 03e8649bc699053ccdbbd4a3c2eaf05241e22a5b
Author: David Claffey &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dnclaffey at gmail.com</A>&gt;
Date:   Wed Dec 16 11:23:52 2009 +0000

    MIPS: merge mips fast_data patch from David N. Claffey
    
    Signed-off-by: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;

diff --git a/src/target/mips32.c b/src/target/mips32.c
index e8ea541..0f6f9b0 100644
--- a/src/target/mips32.c
+++ b/src/target/mips32.c
@@ -29,7 +29,6 @@
 #include &quot;mips32.h&quot;
 #include &quot;register.h&quot;
 
-
 char* mips32_core_reg_list[] =
 {
 	&quot;zero&quot;, &quot;at&quot;, &quot;v0&quot;, &quot;v1&quot;, &quot;a0&quot;, &quot;a1&quot;, &quot;a2&quot;, &quot;a3&quot;,
diff --git a/src/target/mips32.h b/src/target/mips32.h
index 7d1928e..9ad5293 100644
--- a/src/target/mips32.h
+++ b/src/target/mips32.h
@@ -77,6 +77,7 @@ struct mips32_core_reg
 #define MIPS32_OP_ADDI	0x08
 #define MIPS32_OP_AND	0x24
 #define MIPS32_OP_COP0	0x10
+#define MIPS32_OP_JR	0x08
 #define MIPS32_OP_LUI	0x0F
 #define MIPS32_OP_LW	0x23
 #define MIPS32_OP_LBU	0x24
@@ -103,6 +104,7 @@ struct mips32_core_reg
 #define MIPS32_B(off)				MIPS32_BEQ(0, 0, off)
 #define MIPS32_BEQ(src,tar,off)		MIPS32_I_INST(MIPS32_OP_BEQ, src, tar, off)
 #define MIPS32_BNE(src,tar,off)		MIPS32_I_INST(MIPS32_OP_BNE, src, tar, off)
+#define MIPS32_JR(reg)				MIPS32_R_INST(0, reg, 0, 0, 0, MIPS32_OP_JR)
 #define MIPS32_MFC0(gpr, cpr, sel)	MIPS32_R_INST(MIPS32_OP_COP0, MIPS32_COP0_MF, gpr, cpr, 0, sel)
 #define MIPS32_MTC0(gpr,cpr, sel)	MIPS32_R_INST(MIPS32_OP_COP0, MIPS32_COP0_MT, gpr, cpr, 0, sel)
 #define MIPS32_LBU(reg, off, base)	MIPS32_I_INST(MIPS32_OP_LBU, base, reg, off)
diff --git a/src/target/mips32_pracc.c b/src/target/mips32_pracc.c
index 604d34e..34794f3 100644
--- a/src/target/mips32_pracc.c
+++ b/src/target/mips32_pracc.c
@@ -4,6 +4,8 @@
  *                                                                         *
  *   Copyright (C) 2008 by David T.L. Wong                                 *
  *                                                                         *
+ *   Copyright (C) 2009 by David N. Claffey &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dnclaffey at gmail.com</A>&gt;          *
+ *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
  *   it under the terms of the GNU General Public License as published by  *
  *   the Free Software Foundation; either version 2 of the License, or     *
@@ -69,7 +71,6 @@ OpenOCD is used as a flash programmer or as a debug tool.
 Nico Coesel
 */
 
-
 #ifdef HAVE_CONFIG_H
 #include &quot;config.h&quot;
 #endif
@@ -161,7 +162,6 @@ static int mips32_pracc_exec_read(struct mips32_pracc_context *ctx, uint32_t add
 	jtag_add_clocks(5);
 	jtag_execute_queue();
 
-
 	return ERROR_OK;
 }
 
@@ -254,7 +254,6 @@ int mips32_pracc_exec(struct mips_ejtag *ejtag_info, int code_len, const uint32_
 
 			if ((retval = mips32_pracc_exec_read(&amp;ctx, address)) != ERROR_OK)
 				return retval;
-
 		}
 
 		if (cycle == 0)
@@ -933,3 +932,149 @@ int mips32_pracc_read_regs(struct mips_ejtag *ejtag_info, uint32_t *regs)
 
 	return retval;
 }
+
+/* fastdata upload/download requires an initialized working area
+ * to load the download code; it should not be called otherwise
+ * fetch order from the fastdata area
+ * 1. start addr
+ * 2. end addr
+ * 3. data ...
+ */
+int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_area *source,
+								int write, uint32_t addr, int count, uint32_t *buf)
+{
+	uint32_t handler_code[] = {
+		/* caution when editing, table is modified below */
+		/* r15 points to the start of this code */
+		MIPS32_SW(8,MIPS32_FASTDATA_HANDLER_SIZE - 4,15),
+		MIPS32_SW(9,MIPS32_FASTDATA_HANDLER_SIZE - 8,15),
+		MIPS32_SW(10,MIPS32_FASTDATA_HANDLER_SIZE - 12,15),
+		MIPS32_SW(11,MIPS32_FASTDATA_HANDLER_SIZE - 16,15),
+		/* start of fastdata area in t0 */
+		MIPS32_LUI(8,UPPER16(MIPS32_PRACC_FASTDATA_AREA)),
+		MIPS32_ORI(8,8,LOWER16(MIPS32_PRACC_FASTDATA_AREA)),
+		MIPS32_LW(9,0,8),								/* start addr in t1 */
+		MIPS32_LW(10,0,8),								/* end addr to t2 */
+														/* loop: */
+		/* 8 */ MIPS32_LW(11,0,0),						/* lw t3,[t8 | r9] */
+		/* 9 */ MIPS32_SW(11,0,0),						/* sw t3,[r9 | r8] */
+		MIPS32_BNE(10,9,NEG16(3)),						/* bne $t2,t1,loop */
+		MIPS32_ADDI(9,9,4),								/* addi t1,t1,4 */
+
+		MIPS32_LW(8,MIPS32_FASTDATA_HANDLER_SIZE - 4,15),
+		MIPS32_LW(9,MIPS32_FASTDATA_HANDLER_SIZE - 8,15),
+		MIPS32_LW(10,MIPS32_FASTDATA_HANDLER_SIZE - 12,15),
+		MIPS32_LW(11,MIPS32_FASTDATA_HANDLER_SIZE - 16,15),
+
+		MIPS32_LUI(15,UPPER16(MIPS32_PRACC_TEXT)),
+		MIPS32_ORI(15,15,LOWER16(MIPS32_PRACC_TEXT)),
+		MIPS32_JR(15),									/* jr start */
+		MIPS32_MFC0(15,31,0),							/* move COP0 DeSave to $15 */
+		MIPS32_NOP,
+	};
+
+	uint32_t jmp_code[] = {
+		MIPS32_MTC0(15,31,0),			/* move $15 to COP0 DeSave */
+		/* 1 */ MIPS32_LUI(15,0),		/* addr of working area added below */
+		/* 2 */ MIPS32_ORI(15,15,0),	/* addr of working area added below */
+		MIPS32_JR(15),					/* jump to ram program */
+		MIPS32_NOP,
+	};
+
+#define JMP_CODE_SIZE (sizeof(jmp_code)/sizeof(jmp_code[0]))
+#define HANDLER_CODE_SIZE sizeof(handler_code)/sizeof(handler_code[0])
+
+	int retval, i;
+	uint32_t val, ejtag_ctrl, address;
+
+	if (source-&gt;size &lt; MIPS32_FASTDATA_HANDLER_SIZE)
+		return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
+
+	if (write)
+	{
+		handler_code[8] = MIPS32_LW(11,0,8);	/* load data from probe at fastdata area */
+		handler_code[9] = MIPS32_SW(11,0,9);	/* store data to RAM @ r9 */
+	}
+	else
+	{
+		handler_code[8] = MIPS32_LW(11,0,9);	/* load data from RAM @ r9 */
+		handler_code[9] = MIPS32_SW(11,0,8);	/* store data to probe at fastdata area */
+	}
+
+	/* write program into RAM */
+	mips32_pracc_write_mem32(ejtag_info, source-&gt;address, HANDLER_CODE_SIZE, handler_code);
+
+	/* quick verify RAM is working */
+	mips32_pracc_read_u32(ejtag_info, source-&gt;address, &amp;val);
+	if (val != handler_code[0])
+	{
+		LOG_ERROR(&quot;fastdata handler verify failed\n&quot;);
+		return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
+	}
+
+	LOG_INFO(&quot;%s using 0x%.8x for write handler\n&quot;, __func__, source-&gt;address);
+
+	jmp_code[1] |= UPPER16(source-&gt;address);
+	jmp_code[2] |= LOWER16(source-&gt;address);
+
+	for (i = 0; i &lt; (int) JMP_CODE_SIZE; i++)
+	{
+		if ((retval = wait_for_pracc_rw(ejtag_info, &amp;ejtag_ctrl)) != ERROR_OK)
+			return retval;
+
+		mips_ejtag_set_instr(ejtag_info, EJTAG_INST_DATA, NULL);
+		mips_ejtag_drscan_32(ejtag_info, &amp;jmp_code[i]);
+
+		/* Clear the access pending bit (let the processor eat!) */
+
+		ejtag_ctrl = ejtag_info-&gt;ejtag_ctrl &amp; ~EJTAG_CTRL_PRACC;
+		mips_ejtag_set_instr(ejtag_info, EJTAG_INST_CONTROL, NULL);
+		mips_ejtag_drscan_32(ejtag_info, &amp;ejtag_ctrl);
+	}
+
+	if ((retval = wait_for_pracc_rw(ejtag_info, &amp;ejtag_ctrl)) != ERROR_OK)
+		return retval;
+
+	/* next fetch to dmseg should be in FASTDATA_AREA, check */
+	address = 0;
+	mips_ejtag_set_instr(ejtag_info, EJTAG_INST_ADDRESS, NULL);
+	mips_ejtag_drscan_32(ejtag_info, &amp;address);
+
+	if (address != MIPS32_PRACC_FASTDATA_AREA)
+		return ERROR_FAIL;
+
+	/* Send the load start address */
+	val = addr;
+	mips_ejtag_set_instr(ejtag_info, EJTAG_INST_FASTDATA, NULL);
+	mips_ejtag_fastdata_scan(ejtag_info, 1, &amp;val);
+
+	/* Send the load end address */
+	val = addr + (count - 1) * 4;
+	mips_ejtag_set_instr(ejtag_info, EJTAG_INST_FASTDATA, NULL);
+	mips_ejtag_fastdata_scan(ejtag_info, 1, &amp;val);
+
+	for (i = 0; i &lt; count; i++)
+	{
+		/* Send the data out using fastdata (clears the access pending bit) */
+		if ((retval = mips_ejtag_fastdata_scan(ejtag_info, write, buf++)) != ERROR_OK)
+			return retval;
+	}
+
+	if ((retval = jtag_execute_queue()) != ERROR_OK)
+	{
+		LOG_ERROR(&quot;fastdata load failed&quot;);
+		return retval;
+	}
+
+	if ((retval = wait_for_pracc_rw(ejtag_info, &amp;ejtag_ctrl)) != ERROR_OK)
+		return retval;
+
+	address = 0;
+	mips_ejtag_set_instr(ejtag_info, EJTAG_INST_ADDRESS, NULL);
+	mips_ejtag_drscan_32(ejtag_info, &amp;address);
+
+	if (address != MIPS32_PRACC_TEXT)
+		LOG_ERROR(&quot;mini program did not return to start\n&quot;);
+
+	return retval;
+}
diff --git a/src/target/mips32_pracc.h b/src/target/mips32_pracc.h
index 5d1cf3d..41a7325 100644
--- a/src/target/mips32_pracc.h
+++ b/src/target/mips32_pracc.h
@@ -22,8 +22,11 @@
 #ifndef MIPS32_PRACC_H
 #define MIPS32_PRACC_H
 
-#include &quot;mips_ejtag.h&quot;
+#include &lt;target/mips32.h&gt;
+#include &lt;target/mips_ejtag.h&gt;
 
+#define MIPS32_PRACC_FASTDATA_AREA		0xFF200000
+#define MIPS32_PRACC_FASTDATA_SIZE		16
 #define MIPS32_PRACC_TEXT			0xFF200200
 //#define MIPS32_PRACC_STACK			0xFF2FFFFC
 #define MIPS32_PRACC_STACK			0xFF204000
@@ -32,6 +35,7 @@
 #define MIPS32_PRACC_PARAM_OUT		(MIPS32_PRACC_PARAM_IN + MIPS32_PRACC_PARAM_IN_SIZE)
 #define MIPS32_PRACC_PARAM_OUT_SIZE	0x1000
 
+#define MIPS32_FASTDATA_HANDLER_SIZE	0x80
 #define UPPER16(uint32_t) (uint32_t &gt;&gt; 16)
 #define LOWER16(uint32_t) (uint32_t &amp; 0xFFFF)
 #define NEG16(v) (((~(v)) + 1) &amp; 0xFFFF)
@@ -41,6 +45,8 @@ int mips32_pracc_read_mem(struct mips_ejtag *ejtag_info,
 		uint32_t addr, int size, int count, void *buf);
 int mips32_pracc_write_mem(struct mips_ejtag *ejtag_info,
 		uint32_t addr, int size, int count, void *buf);
+int mips32_pracc_fastdata_xfer(struct mips_ejtag *ejtag_info, struct working_area *source,
+		int write, uint32_t addr, int count, uint32_t *buf);
 
 int mips32_pracc_read_mem8(struct mips_ejtag *ejtag_info,
 		uint32_t addr, int count, uint8_t *buf);
diff --git a/src/target/mips_ejtag.c b/src/target/mips_ejtag.c
index 68a39fa..6f7baf0 100644
--- a/src/target/mips_ejtag.c
+++ b/src/target/mips_ejtag.c
@@ -4,6 +4,8 @@
  *                                                                         *
  *   Copyright (C) 2008 by David T.L. Wong                                 *
  *                                                                         *
+ *   Copyright (C) 2009 by David N. Claffey &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dnclaffey at gmail.com</A>&gt;          *
+ *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
  *   it under the terms of the GNU General Public License as published by  *
  *   the Free Software Foundation; either version 2 of the License, or     *
@@ -286,3 +288,42 @@ int mips_ejtag_init(struct mips_ejtag *ejtag_info)
 
 	return ERROR_OK;
 }
+
+int mips_ejtag_fastdata_scan(struct mips_ejtag *ejtag_info, int write, uint32_t *data)
+{
+	struct jtag_tap *tap;
+	tap = ejtag_info-&gt;tap;
+
+	if (tap == NULL)
+		return ERROR_FAIL;
+
+	struct scan_field fields[2];
+	uint8_t spracc = 0;
+	uint8_t t[4] = {0, 0, 0, 0};
+
+	/* fastdata 1-bit register */
+	fields[0].tap = tap;
+	fields[0].num_bits = 1;
+	fields[0].out_value = &spracc;
+	fields[0].in_value = NULL;
+
+	/* processor access data register 32 bit */
+	fields[1].tap = tap;
+	fields[1].num_bits = 32;
+	fields[1].out_value = t;
+
+	if (write)
+	{
+		fields[1].in_value = NULL;
+		buf_set_u32(t, 0, 32, *data);
+	}
+	else
+	{
+		fields[1].in_value = (uint8_t *) data;
+	}
+
+	jtag_add_dr_scan(2, fields, jtag_get_end_state());
+	keep_alive();
+
+	return ERROR_OK;
+}
diff --git a/src/target/mips_ejtag.h b/src/target/mips_ejtag.h
index 93b4a6a..eb42d67 100644
--- a/src/target/mips_ejtag.h
+++ b/src/target/mips_ejtag.h
@@ -118,6 +118,7 @@ int mips_ejtag_exit_debug(struct mips_ejtag *ejtag_info);
 int mips_ejtag_get_impcode(struct mips_ejtag *ejtag_info, uint32_t *impcode);
 int mips_ejtag_get_idcode(struct mips_ejtag *ejtag_info, uint32_t *idcode);
 int mips_ejtag_drscan_32(struct mips_ejtag *ejtag_info, uint32_t *data);
+int mips_ejtag_fastdata_scan(struct mips_ejtag *ejtag_info, int write, uint32_t *data);
 
 int mips_ejtag_init(struct mips_ejtag *ejtag_info);
 int mips_ejtag_config_step(struct mips_ejtag *ejtag_info, int enable_step);
diff --git a/src/target/mips_m4k.c b/src/target/mips_m4k.c
index a83217f..f3191ae 100644
--- a/src/target/mips_m4k.c
+++ b/src/target/mips_m4k.c
@@ -4,6 +4,8 @@
  *                                                                         *
  *   Copyright (C) 2008 by David T.L. Wong                                 *
  *                                                                         *
+ *   Copyright (C) 2009 by David N. Claffey &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dnclaffey at gmail.com</A>&gt;          *
+ *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
  *   it under the terms of the GNU General Public License as published by  *
  *   the Free Software Foundation; either version 2 of the License, or     *
@@ -30,7 +32,6 @@
 #include &quot;target_type.h&quot;
 #include &quot;register.h&quot;
 
-
 /* cli handling */
 
 /* forward declarations */
@@ -962,7 +963,49 @@ int mips_m4k_examine(struct target *target)
 
 int mips_m4k_bulk_write_memory(struct target *target, uint32_t address, uint32_t count, uint8_t *buffer)
 {
-	return mips_m4k_write_memory(target, address, 4, count, buffer);
+	struct mips32_common *mips32 = target-&gt;arch_info;
+	struct mips_ejtag *ejtag_info = &amp;mips32-&gt;ejtag_info;
+	struct working_area *source;
+	int retval;
+	int write = 1;
+
+	LOG_DEBUG(&quot;address: 0x%8.8x, count: 0x%8.8x&quot;, address, count);
+
+	if (target-&gt;state != TARGET_HALTED)
+	{
+		LOG_WARNING(&quot;target not halted&quot;);
+		return ERROR_TARGET_NOT_HALTED;
+	}
+
+	/* check alignment */
+	if (address &amp; 0x3u)
+		return ERROR_TARGET_UNALIGNED_ACCESS;
+
+	/* Get memory for block write handler */
+	retval = target_alloc_working_area(target, MIPS32_FASTDATA_HANDLER_SIZE, &amp;source);
+	if (retval != ERROR_OK)
+	{
+		LOG_WARNING(&quot;No working area available, falling back to non-bulk write&quot;);
+		return mips_m4k_write_memory(target, address, 4, count, buffer);
+	}
+
+	/* TAP data register is loaded LSB first (little endian) */
+	if (target-&gt;endianness == TARGET_BIG_ENDIAN)
+	{
+		uint32_t i, t32;
+		for(i = 0; i &lt; (count*4); i+=4)
+		{
+			t32 = be_to_h_u32((uint8_t *) &amp;buffer[i]);
+			h_u32_to_le(&amp;buffer[i], t32);
+		}
+	}
+
+	retval = mips32_pracc_fastdata_xfer(ejtag_info, source, write, address, count, (uint32_t *) buffer);
+
+	if (source)
+		target_free_working_area(target, source);
+
+	return retval;
 }
 
 int mips_m4k_checksum_memory(struct target *target, uint32_t address, uint32_t size, uint32_t *checksum)

-----------------------------------------------------------------------

Summary of changes:
 src/jtag/drivers/parport.c |    2 +-
 src/target/mips32.c        |    1 -
 src/target/mips32.h        |    2 +
 src/target/mips32_pracc.c  |  268 +++++++++++++++++++++++++++++++-------------
 src/target/mips32_pracc.h  |    9 +-
 src/target/mips_ejtag.c    |   53 +++++++--
 src/target/mips_ejtag.h    |    1 +
 src/target/mips_m4k.c      |   47 ++++++++-
 tcl/target/pic32mx.cfg     |   18 +++-
 9 files changed, 305 insertions(+), 96 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002000.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-rc1-46-g95f86e8
</A></li>
	<LI>Next message: <A HREF="002002.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-rc1-53-gfccb812
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2001">[ date ]</a>
              <a href="thread.html#2001">[ thread ]</a>
              <a href="subject.html#2001">[ subject ]</a>
              <a href="author.html#2001">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openocd-svn">More information about the openocd-svn
mailing list</a><br>
</body></html>
