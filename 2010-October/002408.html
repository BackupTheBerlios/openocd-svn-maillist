<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-548-g96a56ba
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openocd-svn/2010-October/index.html" >
   <LINK REL="made" HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.4.0-548-g96a56ba&In-Reply-To=%3CE1P1azj-0006yQ-0M%40sfp-scmshell-4.v30.ch3.sourceforge.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002407.html">
   <LINK REL="Next"  HREF="002409.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-548-g96a56ba</H1>
    <B>&#216;yvind Harboe</B> 
    <A HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.4.0-548-g96a56ba&In-Reply-To=%3CE1P1azj-0006yQ-0M%40sfp-scmshell-4.v30.ch3.sourceforge.com%3E"
       TITLE="[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-548-g96a56ba">gowinex at users.sourceforge.net
       </A><BR>
    <I>Fri Oct  1 10:29:29 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002407.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-541-gfb7235f
</A></li>
        <LI>Next message: <A HREF="002409.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-549-gd543aa0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2408">[ date ]</a>
              <a href="thread.html#2408">[ thread ]</a>
              <a href="subject.html#2408">[ subject ]</a>
              <a href="author.html#2408">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Main OpenOCD repository&quot;.

The branch, master has been updated
       via  96a56ba086ec94e577e4b3562010710abb2087c6 (commit)
       via  50d5441e2a615fb2c44b41a777e4373901f7a2e6 (commit)
       via  6c137a2fc0bf53b9c0b8eda51e6f5361552b0112 (commit)
       via  cb2dba2c1257e0aa80edc9a171a9c5cd7b2822f8 (commit)
       via  5a41435e45ae18c0823780382c214fb7324dbe7d (commit)
       via  a60a57d8ed1cb28de1eca0e2d6d78d70bd873663 (commit)
       via  d623832685a20d8283ccfd5ede5185a48a256883 (commit)
      from  fb7235f12ad9590ac28f7fa8147c3ade4ce8b460 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 96a56ba086ec94e577e4b3562010710abb2087c6
Author: &#195;&#152;yvind Harboe &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>&gt;
Date:   Mon Sep 27 22:55:30 2010 +0200

    pipes: add documentation for pipes
    
    Stick with the name &quot;gdb_port&quot; even if this command
    can be used for other things(disable, named pipes,
    anonymous stdin/out pipe). &quot;port&quot; is correct for
    probably more than 90% of use cases, if not more.
    
    Signed-off-by: &#195;&#152;yvind Harboe &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>&gt;

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 77a0ad3..5387082 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -1910,12 +1910,29 @@ use the command line @option{-pipe} option.
 
 @deffn {Command} gdb_port [number]
 @cindex GDB server
-Specify or query the first port used for incoming GDB connections.
-The GDB port for the
-first target will be gdb_port, the second target will listen on gdb_port + 1, and so on.
+Normally gdb listens to a TCP/IP port, but GDB can also
+communicate via pipes(stdin/out or named pipes). The name
+&quot;gdb_port&quot; stuck because it covers probably more than 90% of
+the normal use cases.
+
+No arguments reports GDB port. &quot;pipe&quot; means listen to stdin 
+output to stdout, an integer is base port number, &quot;disable&quot;
+disables the gdb server.
+
+When using &quot;pipe&quot;, also use log_output to redirect the log
+output to a file so as not to flood the stdin/out pipes.
+
+The -p/--pipe option is deprecated and a warning is printed
+as it is equivalent to passing in -c &quot;gdb_port pipe; log_output openocd.log&quot;.
+
+Any other string is interpreted as named pipe to listen to. 
+Output pipe is the same name as input pipe, but with 'o' appended,
+e.g. /var/gdb, /var/gdbo.
+				
+The GDB port for the first target will be the base port, the 
+second target will listen on gdb_port + 1, and so on.
 When not specified during the configuration stage,
 the port @var{number} defaults to 3333.
-When specified as zero, GDB remote access ports are not activated.
 @end deffn
 
 @deffn {Command} tcl_port [number]
@@ -1925,7 +1942,7 @@ output from the Tcl engine.
 Intended as a machine interface.
 When not specified during the configuration stage,
 the port @var{number} defaults to 6666.
-When specified as zero, this port is not activated.
+
 @end deffn
 
 @deffn {Command} telnet_port [number]
diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index 7026ff2..5180902 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -2545,9 +2545,13 @@ static const struct command_registration gdb_command_handlers[] = {
 		.name = &quot;gdb_port&quot;,
 		.handler = handle_gdb_port_command,
 		.mode = COMMAND_ANY,
-		.help = &quot;Display or specify base port on which to listen &quot;
-			&quot;for incoming GDB connections.  &quot;
-			&quot;No arguments reports GDB port; zero disables.&quot;,
+		.help = &quot;Normally gdb listens to a TCP/IP port. Each subsequent GDB &quot;
+				&quot;server listens for the next port number after the &quot;
+				&quot;base port number specified. &quot;
+				&quot;No arguments reports GDB port. \&quot;pipe\&quot; means listen to stdin &quot;
+				&quot;output to stdout, an integer is base port number, \&quot;disable\&quot; disables &quot;
+				&quot;port. Any other string is are interpreted as named pipe to listen to. &quot;
+				&quot;Output pipe is the same name as input pipe, but with 'o' appended.&quot;,
 		.usage = &quot;[port_num]&quot;,
 	},
 	{
diff --git a/src/server/tcl_server.c b/src/server/tcl_server.c
index 613eb23..1671086 100644
--- a/src/server/tcl_server.c
+++ b/src/server/tcl_server.c
@@ -183,7 +183,7 @@ static const struct command_registration tcl_command_handlers[] = {
 		.mode = COMMAND_CONFIG,
 		.help = &quot;Specify port on which to listen &quot;
 			&quot;for incoming Tcl syntax.  &quot;
-			&quot;No arguments reports Tcl port; zero disables.&quot;,
+			&quot;Read help on 'gdb_port'.&quot;,
 		.usage = &quot;[port_num]&quot;,
 	},
 	COMMAND_REGISTRATION_DONE
diff --git a/src/server/telnet_server.c b/src/server/telnet_server.c
index 00b4b5d..98e8616 100644
--- a/src/server/telnet_server.c
+++ b/src/server/telnet_server.c
@@ -619,7 +619,7 @@ static const struct command_registration telnet_command_handlers[] = {
 		.mode = COMMAND_ANY,
 		.help = &quot;Specify port on which to listen &quot;
 			&quot;for incoming telnet connections.  &quot;
-			&quot;No arguments reports telnet port; zero disables.&quot;,
+			&quot;Read help on 'gdb_port'.&quot;,
 		.usage = &quot;[port_num]&quot;,
 	},
 	COMMAND_REGISTRATION_DONE

commit 50d5441e2a615fb2c44b41a777e4373901f7a2e6
Author: &#195;&#152;yvind Harboe &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>&gt;
Date:   Mon Sep 27 08:50:49 2010 +0200

    server: add support for pipes
    
    -p/--pipe is now deprecated. Use '-c &quot;gdb_port pipe;log_output openocd.log&quot;'
    instead. Warning logged.
    
    Signed-off-by: &#195;&#152;yvind Harboe &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>&gt;

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 230e47c..77a0ad3 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -574,7 +574,6 @@ bash$ openocd --help
 --debug      | -d       set debug level &lt;0-3&gt;
 --log_output | -l       redirect log output to file &lt;name&gt;
 --command    | -c       run &lt;command&gt;
---pipe       | -p       use pipes when talking to gdb
 @end verbatim
 
 If you don't give any @option{-f} or @option{-c} options,
@@ -7052,11 +7051,12 @@ This would cause GDB to connect to the gdbserver on the local pc using port 3333
 @item
 A pipe connection is typically started as follows:
 @example
-target remote | openocd --pipe
+target remote | openocd -c &quot;gdb_port pipe; log_output openocd.log&quot;
 @end example
 This would cause GDB to run OpenOCD and communicate using pipes (stdin/stdout).
 Using this method has the advantage of GDB starting/stopping OpenOCD for the debug
-session.
+session. log_output sends the log output to a file to ensure that the pipe is
+not saturated when using higher debug level outputs.
 @end enumerate
 
 To list the available OpenOCD commands type @command{monitor help} on the
diff --git a/src/helper/options.c b/src/helper/options.c
index 3a95df4..df4676d 100644
--- a/src/helper/options.c
+++ b/src/helper/options.c
@@ -2,7 +2,7 @@
  *   Copyright (C) 2004, 2005 by Dominic Rath                              *
  *   <A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">Dominic.Rath at gmx.de</A>                                                   *
  *                                                                         *
- *   Copyright (C) 2007,2008 &#195;&#152;yvind Harboe                                 *
+ *   Copyright (C) 2007-2010 &#195;&#152;yvind Harboe                                 *
  *   <A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>                                               *
  *                                                                         *
  *   This program is free software; you can redistribute it and/or modify  *
@@ -177,13 +177,9 @@ int parse_cmdline_args(struct command_context *cmd_ctx, int argc, char *argv[])
 					add_config_command(optarg);
 				}
 				break;
-			case 'p':	/* --pipe | -p */
-#if BUILD_ECOSBOARD == 1
-				/* pipes unsupported on hosted platforms */
-				LOG_WARNING(&quot;pipes not supported on this platform&quot;);
-#else
-				server_use_pipes = 1;
-#endif
+			case 'p':
+				LOG_WARNING(&quot;deprecated option: -p/--pipe. Use '-c \&quot;gdb_port pipe; log_output openocd.log\&quot;' instead.&quot;);
+				add_config_command(&quot;gdb_port pipe; log_output openocd.log&quot;);
 				break;
 		}
 	}
@@ -198,7 +194,6 @@ int parse_cmdline_args(struct command_context *cmd_ctx, int argc, char *argv[])
 		LOG_OUTPUT(&quot;--debug      | -d\tset debug level &lt;0-3&gt;\n&quot;);
 		LOG_OUTPUT(&quot;--log_output | -l\tredirect log output to file &lt;name&gt;\n&quot;);
 		LOG_OUTPUT(&quot;--command    | -c\trun &lt;command&gt;\n&quot;);
-		LOG_OUTPUT(&quot;--pipe       | -p\tuse pipes for gdb communication\n&quot;);
 		exit(-1);
 	}
 
diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index 5489958..7026ff2 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -2387,42 +2387,22 @@ static int gdb_input(struct connection *connection)
 	return ERROR_OK;
 }
 
-static int gdb_target_start(struct target *target, uint16_t port)
+static int gdb_target_start(struct target *target, const char *port)
 {
-	bool use_pipes = 0 == port;
 	struct gdb_service *gdb_service = malloc(sizeof(struct gdb_service));
 	if (NULL == gdb_service)
 		return -ENOMEM;
 
 	gdb_service-&gt;target = target;
 
-	add_service(&quot;gdb&quot;, use_pipes ? CONNECTION_PIPE : CONNECTION_TCP,
+	return add_service(&quot;gdb&quot;,
 			port, 1, &amp;gdb_new_connection, &amp;gdb_input,
 			&amp;gdb_connection_closed, gdb_service);
-
-	const char *name = target_name(target);
-	if (use_pipes)
-		LOG_DEBUG(&quot;gdb service for target '%s' using pipes&quot;, name);
-	else
-		LOG_DEBUG(&quot;gdb service for target '%s' on TCP port %u&quot;, name, port);
-	return ERROR_OK;
 }
 
 static int gdb_target_add_one(struct target *target)
 {
-	long portnumber_parsed;
-	/* If we can parse the port number
-	 * then we increment the port number for the next target.
-	 */
-	char *end_parse;
-	portnumber_parsed = strtol(gdb_port_next, &amp;end_parse, 0);
-	if (!*end_parse)
-	{
-		LOG_ERROR(&quot;Illegal port number&quot;);
-		return ERROR_FAIL;
-	}
-
-	int retval = gdb_target_start(target, portnumber_parsed);
+	int retval = gdb_target_start(target, gdb_port_next);
 	if (retval == ERROR_OK)
 	{
 		long portnumber;
diff --git a/src/server/server.c b/src/server/server.c
index 435ddbb..c7e1e40 100644
--- a/src/server/server.c
+++ b/src/server/server.c
@@ -45,9 +45,6 @@ static struct service *services = NULL;
 /* shutdown_openocd == 1: exit the main event loop, and quit the debugger */
 static int shutdown_openocd = 0;
 
-/* set when using pipes rather than tcp */
-int server_use_pipes = 0;
-
 static int add_connection(struct service *service, struct command_context *cmd_ctx)
 {
 	socklen_t address_size;
@@ -80,7 +77,7 @@ static int add_connection(struct service *service, struct command_context *cmd_c
 				(char *)&amp;flag,		/* the cast is historical cruft */
 				sizeof(int));		/* length of option value */
 
-		LOG_INFO(&quot;accepting '%s' connection from %i&quot;, service-&gt;name, service-&gt;port);
+		LOG_INFO(&quot;accepting '%s' connection from %s&quot;, service-&gt;name, service-&gt;port);
 		if ((retval = service-&gt;new_connection(c)) != ERROR_OK)
 		{
 			close_socket(c-&gt;fd);
@@ -88,8 +85,7 @@ static int add_connection(struct service *service, struct command_context *cmd_c
 			free(c);
 			return retval;
 		}
-	}
-	else if (service-&gt;type == CONNECTION_PIPE)
+	} else if (service-&gt;type == CONNECTION_STDINOUT)
 	{
 		c-&gt;fd = service-&gt;fd;
 		c-&gt;fd_out = fileno(stdout);
@@ -97,10 +93,29 @@ static int add_connection(struct service *service, struct command_context *cmd_c
 		/* do not check for new connections again on stdin */
 		service-&gt;fd = -1;
 
+		LOG_INFO(&quot;accepting '%s' connection from pipe&quot;, service-&gt;name);
+		if ((retval = service-&gt;new_connection(c)) != ERROR_OK)
+		{
+			LOG_ERROR(&quot;attempted '%s' connection rejected&quot;, service-&gt;name);
+			free(c);
+			return retval;
+		}
+	} else if (service-&gt;type == CONNECTION_PIPE)
+	{
+		c-&gt;fd = service-&gt;fd;
 		/* do not check for new connections again on stdin */
 		service-&gt;fd = -1;
 
-		LOG_INFO(&quot;accepting '%s' connection from pipe&quot;, service-&gt;name);
+		char * out_file = alloc_printf(&quot;%so&quot;, service-&gt;port);
+		c-&gt;fd_out = open(out_file, O_WRONLY);
+		free(out_file);
+		if (c-&gt;fd_out == -1)
+		{
+			LOG_ERROR(&quot;could not open %s&quot;, service-&gt;port);
+			exit(1);
+		}
+
+		LOG_INFO(&quot;accepting '%s' connection from pipe %s&quot;, service-&gt;name, service-&gt;port);
 		if ((retval = service-&gt;new_connection(c)) != ERROR_OK)
 		{
 			LOG_ERROR(&quot;attempted '%s' connection rejected&quot;, service-&gt;name);
@@ -130,7 +145,14 @@ static int remove_connection(struct service *service, struct connection *connect
 		{
 			service-&gt;connection_closed(c);
 			if (service-&gt;type == CONNECTION_TCP)
+			{
 				close_socket(c-&gt;fd);
+			} else if (service-&gt;type == CONNECTION_PIPE)
+			{
+				/* The service will listen to the pipe again */
+				c-&gt;service-&gt;fd = c-&gt;fd;
+			}
+
 			command_done(c-&gt;cmd_ctx);
 
 			/* delete connection */
@@ -148,7 +170,8 @@ static int remove_connection(struct service *service, struct connection *connect
 	return ERROR_OK;
 }
 
-int add_service(char *name, enum connection_type type, unsigned short port, int max_connections, new_connection_handler_t new_connection_handler, input_handler_t input_handler, connection_closed_handler_t connection_closed_handler, void *priv)
+/* FIX! make service return error instead of invoking exit() */
+int add_service(char *name, const char *port, int max_connections, new_connection_handler_t new_connection_handler, input_handler_t input_handler, connection_closed_handler_t connection_closed_handler, void *priv)
 {
 	struct service *c, **p;
 	int so_reuseaddr_option = 1;
@@ -156,9 +179,8 @@ int add_service(char *name, enum connection_type type, unsigned short port, int
 	c = malloc(sizeof(struct service));
 
 	c-&gt;name = strdup(name);
-	c-&gt;type = type;
-	c-&gt;port = port;
-	c-&gt;max_connections = max_connections;
+	c-&gt;port = strdup(port);
+	c-&gt;max_connections = 1; /* Only TCP/IP ports can support more than one connection */
 	c-&gt;fd = -1;
 	c-&gt;connections = NULL;
 	c-&gt;new_connection = new_connection_handler;
@@ -166,9 +188,28 @@ int add_service(char *name, enum connection_type type, unsigned short port, int
 	c-&gt;connection_closed = connection_closed_handler;
 	c-&gt;priv = priv;
 	c-&gt;next = NULL;
+	long portnumber;
+	if (strcmp(c-&gt;port, &quot;pipe&quot;) == 0)
+	{
+		c-&gt;type = CONNECTION_STDINOUT;
+	} else
+	{
+		char *end;
+		strtol(c-&gt;port, &amp;end, 0);
+		if (!*end &amp;&amp; (parse_long(c-&gt;port, &amp;portnumber) == ERROR_OK))
+		{
+			c-&gt;portnumber = portnumber;
+			c-&gt;type = CONNECTION_TCP;
+		} else
+		{
+			c-&gt;type = CONNECTION_PIPE;
+		}
+	}
 
-	if (type == CONNECTION_TCP)
+	if (c-&gt;type == CONNECTION_TCP)
 	{
+		c-&gt;max_connections = max_connections;
+
 		if ((c-&gt;fd = socket(AF_INET, SOCK_STREAM, 0)) == -1)
 		{
 			LOG_ERROR(&quot;error creating socket: %s&quot;, strerror(errno));
@@ -182,7 +223,7 @@ int add_service(char *name, enum connection_type type, unsigned short port, int
 		memset(&amp;c-&gt;sin, 0, sizeof(c-&gt;sin));
 		c-&gt;sin.sin_family = AF_INET;
 		c-&gt;sin.sin_addr.s_addr = INADDR_ANY;
-		c-&gt;sin.sin_port = htons(port);
+		c-&gt;sin.sin_port = htons(c-&gt;portnumber);
 
 		if (bind(c-&gt;fd, (struct sockaddr *)&amp;c-&gt;sin, sizeof(c-&gt;sin)) == -1)
 		{
@@ -209,7 +250,7 @@ int add_service(char *name, enum connection_type type, unsigned short port, int
 			exit(-1);
 		}
 	}
-	else if (type == CONNECTION_PIPE)
+	else if (c-&gt;type == CONNECTION_STDINOUT)
 	{
 		c-&gt;fd = fileno(stdin);
 
@@ -225,10 +266,15 @@ int add_service(char *name, enum connection_type type, unsigned short port, int
 		socket_nonblock(c-&gt;fd);
 #endif
 	}
-	else
+	else if (c-&gt;type == CONNECTION_PIPE)
 	{
-		LOG_ERROR(&quot;unknown connection type: %d&quot;, type);
-		exit(1);
+		/* Pipe we're reading from */
+		c-&gt;fd = open(c-&gt;port, O_RDONLY | O_NONBLOCK);
+		if (c-&gt;fd == -1)
+		{
+			LOG_ERROR(&quot;could not open %s&quot;, c-&gt;port);
+			exit(1);
+		}
 	}
 
 	/* add to the end of linked list */
@@ -238,29 +284,6 @@ int add_service(char *name, enum connection_type type, unsigned short port, int
 	return ERROR_OK;
 }
 
-int add_service_pipe(char *name, const char *port, int max_connections,
-		new_connection_handler_t new_connection_handler, input_handler_t input_handler,
-		connection_closed_handler_t connection_closed_handler, void *priv)
-{
-	enum connection_type type = CONNECTION_TCP;
-	long portnumber;
-	char *end;
-	strtol(port, &amp;end, 0);
-	if (!*end)
-	{
-		if ((parse_long(port, &amp;portnumber) == ERROR_OK) &amp;&amp; (portnumber == 0))
-		{
-			type = CONNECTION_PIPE;
-		}
-	} else
-	{
-		LOG_ERROR(&quot;Illegal port number %s&quot;, port);
-		return ERROR_FAIL;
-	}
-	return add_service(name, type, portnumber, max_connections, new_connection_handler,
-			input_handler, connection_closed_handler, priv);
-}
-
 static int remove_services(void)
 {
 	struct service *c = services;
@@ -278,6 +301,8 @@ static int remove_services(void)
 			if (c-&gt;fd != -1)
 				close(c-&gt;fd);
 		}
+		if (c-&gt;port)
+			free((void *)c-&gt;port);
 
 		if (c-&gt;priv)
 			free(c-&gt;priv);
diff --git a/src/server/server.h b/src/server/server.h
index 2c9ed44..face138 100644
--- a/src/server/server.h
+++ b/src/server/server.h
@@ -35,7 +35,8 @@
 enum connection_type
 {
 	CONNECTION_TCP,
-	CONNECTION_PIPE
+	CONNECTION_PIPE,
+	CONNECTION_STDINOUT
 };
 
 struct connection
@@ -58,7 +59,8 @@ struct service
 {
 	char *name;
 	enum connection_type type;
-	unsigned short port;
+	const char *port;
+	unsigned short portnumber;
 	int fd;
 	struct sockaddr_in sin;
 	int max_connections;
@@ -70,12 +72,7 @@ struct service
 	struct service *next;
 };
 
-int add_service(char *name, enum connection_type type, unsigned short port,
-		int max_connections, new_connection_handler_t new_connection_handler,
-		input_handler_t in_handler, connection_closed_handler_t close_handler,
-		void *priv);
-
-int add_service_pipe(char *name, const char *port,
+int add_service(char *name, const char *port,
 		int max_connections, new_connection_handler_t new_connection_handler,
 		input_handler_t in_handler, connection_closed_handler_t close_handler,
 		void *priv);
@@ -115,8 +112,6 @@ SERVER_PIPE_COMMAND();
 
 SERVER_PORT_COMMAND();
 
-extern int server_use_pipes;
-
 #define ERROR_SERVER_REMOTE_CLOSED	(-400)
 #define ERROR_CONNECTION_REJECTED	(-401)
 
diff --git a/src/server/tcl_server.c b/src/server/tcl_server.c
index f82cafe..613eb23 100644
--- a/src/server/tcl_server.c
+++ b/src/server/tcl_server.c
@@ -166,7 +166,7 @@ int tcl_init(void)
 		return ERROR_OK;
 	}
 
-	return add_service_pipe(&quot;tcl&quot;, tcl_port, 1,
+	return add_service(&quot;tcl&quot;, tcl_port, 1,
 			&amp;tcl_new_connection, &amp;tcl_input,
 			&amp;tcl_closed, NULL);
 }
diff --git a/src/server/telnet_server.c b/src/server/telnet_server.c
index 420f5d7..00b4b5d 100644
--- a/src/server/telnet_server.c
+++ b/src/server/telnet_server.c
@@ -592,9 +592,7 @@ int telnet_init(char *banner)
 
 	telnet_service-&gt;banner = banner;
 
-	add_service_pipe(&quot;telnet&quot;, telnet_port, 1, telnet_new_connection, telnet_input, telnet_connection_closed, telnet_service);
-
-	return ERROR_OK;
+	return add_service(&quot;telnet&quot;, telnet_port, 1, telnet_new_connection, telnet_input, telnet_connection_closed, telnet_service);
 }
 
 /* daemon configuration command telnet_port */

commit 6c137a2fc0bf53b9c0b8eda51e6f5361552b0112
Author: &#195;&#152;yvind Harboe &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>&gt;
Date:   Mon Sep 27 08:48:31 2010 +0200

    server: specify port as a string
    
    This will allow switching to using named pipes.
    
    Split this out as a seperate commit to make changes
    easier to follow.
    
    Signed-off-by: &#195;&#152;yvind Harboe &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>&gt;

diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index 170dadc..5489958 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -80,8 +80,8 @@ static int gdb_breakpoint_override;
 static enum breakpoint_type gdb_breakpoint_override_type;
 
 static int gdb_error(struct connection *connection, int retval);
-static unsigned short gdb_port = 3333;
-static unsigned short gdb_port_next = 0;
+static const char *gdb_port;
+static const char *gdb_port_next;
 static const char DIGITS[16] = &quot;0123456789abcdef&quot;;
 
 static void gdb_log_callback(void *priv, const char *file, unsigned line,
@@ -2410,32 +2410,37 @@ static int gdb_target_start(struct target *target, uint16_t port)
 
 static int gdb_target_add_one(struct target *target)
 {
-	if (gdb_port == 0 &amp;&amp; server_use_pipes == 0)
-	{
-		LOG_INFO(&quot;gdb port disabled&quot;);
-		return ERROR_OK;
-	}
-	if (0 == gdb_port_next)
-		gdb_port_next = gdb_port;
-
-	bool use_pipes = server_use_pipes;
-	static bool server_started_with_pipes = false;
-	if (server_started_with_pipes)
+	long portnumber_parsed;
+	/* If we can parse the port number
+	 * then we increment the port number for the next target.
+	 */
+	char *end_parse;
+	portnumber_parsed = strtol(gdb_port_next, &amp;end_parse, 0);
+	if (!*end_parse)
 	{
-		LOG_WARNING(&quot;gdb service permits one target when using pipes&quot;);
-		if (0 == gdb_port)
-			return ERROR_OK;
-
-		use_pipes = false;
+		LOG_ERROR(&quot;Illegal port number&quot;);
+		return ERROR_FAIL;
 	}
 
-	int e = gdb_target_start(target, use_pipes ? 0 : gdb_port_next);
-	if (ERROR_OK == e)
+	int retval = gdb_target_start(target, portnumber_parsed);
+	if (retval == ERROR_OK)
 	{
-		server_started_with_pipes |= use_pipes;
-		gdb_port_next++;
+		long portnumber;
+		/* If we can parse the port number
+		 * then we increment the port number for the next target.
+		 */
+		char *end;
+		strtol(gdb_port_next, &amp;end, 0);
+		if (!*end)
+		{
+			if (parse_long(gdb_port_next, &amp;portnumber) == ERROR_OK)
+			{
+				free((void *)gdb_port_next);
+				gdb_port_next = alloc_printf(&quot;%d&quot;, portnumber+1);
+			}
+		}
 	}
-	return e;
+	return retval;
 }
 
 int gdb_target_add_all(struct target *target)
@@ -2480,9 +2485,9 @@ COMMAND_HANDLER(handle_gdb_sync_command)
 /* daemon configuration command gdb_port */
 COMMAND_HANDLER(handle_gdb_port_command)
 {
-	int retval = CALL_COMMAND_HANDLER(server_port_command, &amp;gdb_port);
+	int retval = CALL_COMMAND_HANDLER(server_pipe_command, &amp;gdb_port);
 	if (ERROR_OK == retval)
-		gdb_port_next = gdb_port;
+		gdb_port_next = strdup(gdb_port);
 	return retval;
 }
 
@@ -2599,5 +2604,7 @@ static const struct command_registration gdb_command_handlers[] = {
 
 int gdb_register_commands(struct command_context *cmd_ctx)
 {
+	gdb_port = strdup(&quot;3333&quot;);
+	gdb_port_next = strdup(&quot;3333&quot;);
 	return register_commands(cmd_ctx, NULL, gdb_command_handlers);
 }
diff --git a/src/server/server.c b/src/server/server.c
index 1c55663..435ddbb 100644
--- a/src/server/server.c
+++ b/src/server/server.c
@@ -238,6 +238,29 @@ int add_service(char *name, enum connection_type type, unsigned short port, int
 	return ERROR_OK;
 }
 
+int add_service_pipe(char *name, const char *port, int max_connections,
+		new_connection_handler_t new_connection_handler, input_handler_t input_handler,
+		connection_closed_handler_t connection_closed_handler, void *priv)
+{
+	enum connection_type type = CONNECTION_TCP;
+	long portnumber;
+	char *end;
+	strtol(port, &amp;end, 0);
+	if (!*end)
+	{
+		if ((parse_long(port, &amp;portnumber) == ERROR_OK) &amp;&amp; (portnumber == 0))
+		{
+			type = CONNECTION_PIPE;
+		}
+	} else
+	{
+		LOG_ERROR(&quot;Illegal port number %s&quot;, port);
+		return ERROR_FAIL;
+	}
+	return add_service(name, type, portnumber, max_connections, new_connection_handler,
+			input_handler, connection_closed_handler, priv);
+}
+
 static int remove_services(void)
 {
 	struct service *c = services;
@@ -250,6 +273,12 @@ static int remove_services(void)
 		if (c-&gt;name)
 			free(c-&gt;name);
 
+		if (c-&gt;type == CONNECTION_PIPE)
+		{
+			if (c-&gt;fd != -1)
+				close(c-&gt;fd);
+		}
+
 		if (c-&gt;priv)
 			free(c-&gt;priv);
 
@@ -591,3 +620,23 @@ SERVER_PORT_COMMAND()
 	}
 	return ERROR_OK;
 }
+
+SERVER_PIPE_COMMAND()
+{
+	switch (CMD_ARGC) {
+	case 0:
+		command_print(CMD_CTX, &quot;%s&quot;, *out);
+		break;
+	case 1:
+	{
+		const char * t = strdup(CMD_ARGV[0]);
+		free((void *)*out);
+		*out = t;
+		break;
+	}
+	default:
+		return ERROR_INVALID_ARGUMENTS;
+	}
+	return ERROR_OK;
+}
+
diff --git a/src/server/server.h b/src/server/server.h
index 46188bb..2c9ed44 100644
--- a/src/server/server.h
+++ b/src/server/server.h
@@ -75,6 +75,11 @@ int add_service(char *name, enum connection_type type, unsigned short port,
 		input_handler_t in_handler, connection_closed_handler_t close_handler,
 		void *priv);
 
+int add_service_pipe(char *name, const char *port,
+		int max_connections, new_connection_handler_t new_connection_handler,
+		input_handler_t in_handler, connection_closed_handler_t close_handler,
+		void *priv);
+
 int server_preinit(void);
 int server_init(struct command_context *cmd_ctx);
 int server_quit(void);
@@ -101,6 +106,10 @@ void openocd_sleep_postlude(void);
  * Call server_port like a normal COMMAND_HANDLER with an extra @a out parameter
  * to receive the specified port number.
  */
+#define SERVER_PIPE_COMMAND() \
+		COMMAND_HELPER(server_pipe_command, const char **out)
+SERVER_PIPE_COMMAND();
+
 #define SERVER_PORT_COMMAND() \
 		COMMAND_HELPER(server_port_command, unsigned short *out)
 
diff --git a/src/server/tcl_server.c b/src/server/tcl_server.c
index 7d84de7..f82cafe 100644
--- a/src/server/tcl_server.c
+++ b/src/server/tcl_server.c
@@ -35,7 +35,7 @@ struct tcl_connection {
 	int tc_outerror; /* flag an output error */
 };
 
-static unsigned short tcl_port = 6666;
+static const char *tcl_port;
 
 /* handlers */
 static int tcl_new_connection(struct connection *connection);
@@ -160,23 +160,20 @@ static int tcl_closed(struct connection *connection)
 
 int tcl_init(void)
 {
-	int retval;
-
-	if (tcl_port == 0)
+	if (strcmp(tcl_port, &quot;disabled&quot;) == 0)
 	{
-		LOG_INFO(&quot;tcl port disabled&quot;);
+		LOG_INFO(&quot;tcl server disabled&quot;);
 		return ERROR_OK;
 	}
 
-	retval = add_service(&quot;tcl&quot;, CONNECTION_TCP, tcl_port, 1,
+	return add_service_pipe(&quot;tcl&quot;, tcl_port, 1,
 			&amp;tcl_new_connection, &amp;tcl_input,
 			&amp;tcl_closed, NULL);
-	return retval;
 }
 
 COMMAND_HANDLER(handle_tcl_port_command)
 {
-	return CALL_COMMAND_HANDLER(server_port_command, &amp;tcl_port);
+	return CALL_COMMAND_HANDLER(server_pipe_command, &amp;tcl_port);
 }
 
 static const struct command_registration tcl_command_handlers[] = {
@@ -194,5 +191,6 @@ static const struct command_registration tcl_command_handlers[] = {
 
 int tcl_register_commands(struct command_context *cmd_ctx)
 {
+	tcl_port = strdup(&quot;6666&quot;);
 	return register_commands(cmd_ctx, NULL, tcl_command_handlers);
 }
diff --git a/src/server/telnet_server.c b/src/server/telnet_server.c
index ee8d3b1..420f5d7 100644
--- a/src/server/telnet_server.c
+++ b/src/server/telnet_server.c
@@ -30,7 +30,7 @@
 #include &quot;telnet_server.h&quot;
 #include &lt;target/target_request.h&gt;
 
-static unsigned short telnet_port = 4444;
+static const char *telnet_port;
 
 static char *negotiate =
 		&quot;\xFF\xFB\x03&quot;		/* IAC WILL Suppress Go Ahead */
@@ -582,18 +582,17 @@ static int telnet_connection_closed(struct connection *connection)
 
 int telnet_init(char *banner)
 {
-	struct telnet_service *telnet_service = malloc(sizeof(struct telnet_service));
-
-	if (telnet_port == 0)
+	if (strcmp(telnet_port, &quot;disabled&quot;) == 0)
 	{
-		LOG_INFO(&quot;telnet port disabled&quot;);
-		free(telnet_service);
+		LOG_INFO(&quot;telnet server disabled&quot;);
 		return ERROR_OK;
 	}
 
+	struct telnet_service *telnet_service = malloc(sizeof(struct telnet_service));
+
 	telnet_service-&gt;banner = banner;
 
-	add_service(&quot;telnet&quot;, CONNECTION_TCP, telnet_port, 1, telnet_new_connection, telnet_input, telnet_connection_closed, telnet_service);
+	add_service_pipe(&quot;telnet&quot;, telnet_port, 1, telnet_new_connection, telnet_input, telnet_connection_closed, telnet_service);
 
 	return ERROR_OK;
 }
@@ -601,7 +600,7 @@ int telnet_init(char *banner)
 /* daemon configuration command telnet_port */
 COMMAND_HANDLER(handle_telnet_port_command)
 {
-	return CALL_COMMAND_HANDLER(server_port_command, &amp;telnet_port);
+	return CALL_COMMAND_HANDLER(server_pipe_command, &amp;telnet_port);
 }
 
 COMMAND_HANDLER(handle_exit_command)
@@ -630,5 +629,6 @@ static const struct command_registration telnet_command_handlers[] = {
 
 int telnet_register_commands(struct command_context *cmd_ctx)
 {
+	telnet_port = strdup(&quot;4444&quot;);
 	return register_commands(cmd_ctx, NULL, telnet_command_handlers);
 }

commit cb2dba2c1257e0aa80edc9a171a9c5cd7b2822f8
Author: &#195;&#152;yvind Harboe &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>&gt;
Date:   Mon Sep 27 09:24:51 2010 +0200

    server: read/write now goes through connection fn's
    
    depending on whether the connection is over a socket
    or pipe, the read is done differently.
    
    pipes can return -1 when writing 0 bytes, make 0 byte
    writes a successful no-op. 0 byte writes falls out
    naturally of tcl server code.
    
    Signed-off-by: &#195;&#152;yvind Harboe &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>&gt;

diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index 7343b87..170dadc 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -328,7 +328,7 @@ static int gdb_write(struct connection *connection, void *data, int len)
 	if (gdb_con-&gt;closed)
 		return ERROR_SERVER_REMOTE_CLOSED;
 
-	if (write_socket(connection-&gt;fd_out, data, len) == len)
+	if (connection_write(connection, data, len) == len)
 	{
 		return ERROR_OK;
 	}
diff --git a/src/server/server.c b/src/server/server.c
index e67be13..1c55663 100644
--- a/src/server/server.c
+++ b/src/server/server.c
@@ -513,6 +513,33 @@ int server_quit(void)
 	return ERROR_OK;
 }
 
+int connection_write(struct connection *connection, const void *data, int len)
+{
+	if (len == 0)
+	{
+		/* successful no-op. Sockets and pipes behave differently here... */
+		return 0;
+	}
+	if (connection-&gt;service-&gt;type == CONNECTION_TCP)
+	{
+		return write_socket(connection-&gt;fd_out, data, len);
+	} else
+	{
+		return write(connection-&gt;fd_out, data, len);
+	}
+}
+
+int connection_read(struct connection *connection, void *data, int len)
+{
+	if (connection-&gt;service-&gt;type == CONNECTION_TCP)
+	{
+		return read_socket(connection-&gt;fd, data, len);
+	} else
+	{
+		return read(connection-&gt;fd, data, len);
+	}
+}
+
 /* tell the server we want to shut down */
 COMMAND_HANDLER(handle_shutdown_command)
 {
diff --git a/src/server/server.h b/src/server/server.h
index b13baaa..46188bb 100644
--- a/src/server/server.h
+++ b/src/server/server.h
@@ -83,6 +83,9 @@ int server_loop(struct command_context *command_context);
 
 int server_register_commands(struct command_context *context);
 
+int connection_write(struct connection *connection, const void *data, int len);
+int connection_read(struct connection *connection, void *data, int len);
+
 /**
  * Used by server_loop(), defined in server_stubs.c, httpd.c, or ecosboard.c
  */
diff --git a/src/server/tcl_server.c b/src/server/tcl_server.c
index 9aaee5c..7d84de7 100644
--- a/src/server/tcl_server.c
+++ b/src/server/tcl_server.c
@@ -57,7 +57,7 @@ int tcl_output(struct connection *connection, const void *data, ssize_t len)
 	if (tclc-&gt;tc_outerror)
 		return ERROR_SERVER_REMOTE_CLOSED;
 
-	wlen = write_socket(connection-&gt;fd, data, len);
+	wlen = connection_write(connection, data, len);
 
 	if (wlen == len)
 		return ERROR_OK;
@@ -92,7 +92,7 @@ static int tcl_input(struct connection *connection)
 	struct tcl_connection *tclc;
 	unsigned char in[256];
 
-	rlen = read_socket(connection-&gt;fd, &amp;in, sizeof(in));
+	rlen = connection_read(connection, &amp;in, sizeof(in));
 	if (rlen &lt;= 0) {
 		if (rlen &lt; 0)
 			LOG_ERROR(&quot;error during read: %s&quot;, strerror(errno));
diff --git a/src/server/telnet_server.c b/src/server/telnet_server.c
index 92052ae..ee8d3b1 100644
--- a/src/server/telnet_server.c
+++ b/src/server/telnet_server.c
@@ -51,7 +51,7 @@ static int telnet_write(struct connection *connection, const void *data,
 	if (t_con-&gt;closed)
 		return ERROR_SERVER_REMOTE_CLOSED;
 
-	if (write_socket(connection-&gt;fd_out, data, len) == len)
+	if (connection_write(connection, data, len) == len)
 	{
 		return ERROR_OK;
 	}
@@ -204,7 +204,7 @@ static int telnet_input(struct connection *connection)
 	struct telnet_connection *t_con = connection-&gt;priv;
 	struct command_context *command_context = connection-&gt;cmd_ctx;
 
-	bytes_read = read_socket(connection-&gt;fd, buffer, TELNET_BUFFER_SIZE);
+	bytes_read = connection_read(connection, buffer, TELNET_BUFFER_SIZE);
 
 	if (bytes_read == 0)
 		return ERROR_SERVER_REMOTE_CLOSED;

commit 5a41435e45ae18c0823780382c214fb7324dbe7d
Author: &#195;&#152;yvind Harboe &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>&gt;
Date:   Mon Sep 27 08:26:31 2010 +0200

    server: split file descriptors in in/out fd's
    
    pipes have different fd's for in/out. This makes the
    code more orthogonal and prepares for adding pipes.
    
    Signed-off-by: &#195;&#152;yvind Harboe &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>&gt;

diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index 76c3e36..7343b87 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -176,7 +176,7 @@ static int gdb_get_char_inner(struct connection *connection, int* next_char)
 #endif
 	for (;;)
 	{
-		if (connection-&gt;service-&gt;type == CONNECTION_PIPE)
+		if (connection-&gt;service-&gt;type != CONNECTION_TCP)
 		{
 			gdb_con-&gt;buf_cnt = read(connection-&gt;fd, gdb_con-&gt;buffer, GDB_BUFFER_SIZE);
 		}
@@ -328,20 +328,9 @@ static int gdb_write(struct connection *connection, void *data, int len)
 	if (gdb_con-&gt;closed)
 		return ERROR_SERVER_REMOTE_CLOSED;
 
-	if (connection-&gt;service-&gt;type == CONNECTION_PIPE)
+	if (write_socket(connection-&gt;fd_out, data, len) == len)
 	{
-		/* write to stdout */
-		if (write(STDOUT_FILENO, data, len) == len)
-		{
-			return ERROR_OK;
-		}
-	}
-	else
-	{
-		if (write_socket(connection-&gt;fd, data, len) == len)
-		{
-			return ERROR_OK;
-		}
+		return ERROR_OK;
 	}
 	gdb_con-&gt;closed = 1;
 	return ERROR_SERVER_REMOTE_CLOSED;
diff --git a/src/server/server.c b/src/server/server.c
index 3c85cd1..e67be13 100644
--- a/src/server/server.c
+++ b/src/server/server.c
@@ -57,6 +57,7 @@ static int add_connection(struct service *service, struct command_context *cmd_c
 
 	c = malloc(sizeof(struct connection));
 	c-&gt;fd = -1;
+	c-&gt;fd_out = -1;
 	memset(&amp;c-&gt;sin, 0, sizeof(c-&gt;sin));
 	c-&gt;cmd_ctx = copy_command_context(cmd_ctx);
 	c-&gt;service = service;
@@ -69,6 +70,7 @@ static int add_connection(struct service *service, struct command_context *cmd_c
 		address_size = sizeof(c-&gt;sin);
 
 		c-&gt;fd = accept(service-&gt;fd, (struct sockaddr *)&amp;service-&gt;sin, &amp;address_size);
+		c-&gt;fd_out = c-&gt;fd;
 
 		/* This increases performance dramatically for e.g. GDB load which
 		 * does not have a sliding window protocol. */
@@ -90,6 +92,10 @@ static int add_connection(struct service *service, struct command_context *cmd_c
 	else if (service-&gt;type == CONNECTION_PIPE)
 	{
 		c-&gt;fd = service-&gt;fd;
+		c-&gt;fd_out = fileno(stdout);
+
+		/* do not check for new connections again on stdin */
+		service-&gt;fd = -1;
 
 		/* do not check for new connections again on stdin */
 		service-&gt;fd = -1;
@@ -205,8 +211,7 @@ int add_service(char *name, enum connection_type type, unsigned short port, int
 	}
 	else if (type == CONNECTION_PIPE)
 	{
-		/* use stdin */
-		c-&gt;fd = STDIN_FILENO;
+		c-&gt;fd = fileno(stdin);
 
 #ifdef _WIN32
 		/* for win32 set stdin/stdout to binary mode */
@@ -384,7 +389,7 @@ int server_loop(struct command_context *command_context)
 				}
 				else
 				{
-					if (service-&gt;type != CONNECTION_PIPE)
+					if (service-&gt;type == CONNECTION_TCP)
 					{
 						struct sockaddr_in sin;
 						socklen_t address_size = sizeof(sin);
diff --git a/src/server/server.h b/src/server/server.h
index a25920e..b13baaa 100644
--- a/src/server/server.h
+++ b/src/server/server.h
@@ -41,6 +41,7 @@ enum connection_type
 struct connection
 {
 	int fd;
+	int fd_out; /* When using pipes we're writing to a different fd */
 	struct sockaddr_in sin;
 	struct command_context *cmd_ctx;
 	struct service *service;
diff --git a/src/server/tcl_server.c b/src/server/tcl_server.c
index 06f67ab..9aaee5c 100644
--- a/src/server/tcl_server.c
+++ b/src/server/tcl_server.c
@@ -58,6 +58,7 @@ int tcl_output(struct connection *connection, const void *data, ssize_t len)
 		return ERROR_SERVER_REMOTE_CLOSED;
 
 	wlen = write_socket(connection-&gt;fd, data, len);
+
 	if (wlen == len)
 		return ERROR_OK;
 
diff --git a/src/server/telnet_server.c b/src/server/telnet_server.c
index 10caee3..92052ae 100644
--- a/src/server/telnet_server.c
+++ b/src/server/telnet_server.c
@@ -2,7 +2,7 @@
  *   Copyright (C) 2005 by Dominic Rath                                    *
  *   <A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">Dominic.Rath at gmx.de</A>                                                   *
  *                                                                         *
- *   Copyright (C) 2007,2008 &#195;&#152;yvind Harboe                                 *
+ *   Copyright (C) 2007-2010 &#195;&#152;yvind Harboe                                 *
  *   <A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>                                               *
  *                                                                         *
  *   Copyright (C) 2008 by Spencer Oliver                                  *
@@ -51,7 +51,7 @@ static int telnet_write(struct connection *connection, const void *data,
 	if (t_con-&gt;closed)
 		return ERROR_SERVER_REMOTE_CLOSED;
 
-	if (write_socket(connection-&gt;fd, data, len) == len)
+	if (write_socket(connection-&gt;fd_out, data, len) == len)
 	{
 		return ERROR_OK;
 	}

commit a60a57d8ed1cb28de1eca0e2d6d78d70bd873663
Author: &#195;&#152;yvind Harboe &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>&gt;
Date:   Sun Sep 26 19:30:31 2010 +0200

    server: rely on ctrl-c to stop openocd
    
    there was special support to support pressing 'x' to quit
    openocd. ctrl-c is sufficient. The main server loop is already
    complicated enough.
    
    Signed-off-by: &#195;&#152;yvind Harboe &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>&gt;

diff --git a/src/server/server.c b/src/server/server.c
index 7d8ad51..3c85cd1 100644
--- a/src/server/server.c
+++ b/src/server/server.c
@@ -2,7 +2,7 @@
  *   Copyright (C) 2005 by Dominic Rath                                    *
  *   <A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">Dominic.Rath at gmx.de</A>                                                   *
  *                                                                         *
- *   Copyright (C) 2007,2008 &#195;&#152;yvind Harboe                                 *
+ *   Copyright (C) 2007-2010 &#195;&#152;yvind Harboe                                 *
  *   <A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>                                               *
  *                                                                         *
  *   Copyright (C) 2008 by Spencer Oliver                                  *
@@ -310,16 +310,6 @@ int server_loop(struct command_context *command_context)
 			}
 		}
 
-#ifndef _WIN32
-#if BUILD_ECOSBOARD == 0
-		if (server_use_pipes == 0)
-		{
-			/* add STDIN to read_fds */
-			FD_SET(fileno(stdin), &amp;read_fds);
-		}
-#endif
-#endif
-
 		struct timeval tv;
 		tv.tv_sec = 0;
 		if (poll_ok)
@@ -434,21 +424,7 @@ int server_loop(struct command_context *command_context)
 			}
 		}
 
-#ifndef _WIN32
-#if BUILD_ECOSBOARD == 0
-		/* check for data on stdin if not using pipes */
-		if (server_use_pipes == 0)
-		{
-			if (FD_ISSET(fileno(stdin), &amp;read_fds))
-			{
-				if (getc(stdin) == 'x')
-				{
-					shutdown_openocd = 1;
-				}
-			}
-		}
-#endif
-#else
+#ifdef _WIN32
 		MSG msg;
 		while (PeekMessage(&amp;msg,NULL,0,0,PM_REMOVE))
 		{

commit d623832685a20d8283ccfd5ede5185a48a256883
Author: &#195;&#152;yvind Harboe &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>&gt;
Date:   Sun Sep 26 18:24:36 2010 +0200

    log: remove hack to redirect logs when pipes are in use
    
    There is an explicit command &quot;log_output&quot; that can
    be used to redirect log output to a file, no need
    for a hack in the first place.
    
    Before enabling pipes, use &quot;log_output foo&quot; to redirect
    log output to the &quot;foo&quot; files.
    
    Signed-off-by: &#195;&#152;yvind Harboe &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>&gt;

diff --git a/src/helper/log.c b/src/helper/log.c
index da227bd..b6fab01 100644
--- a/src/helper/log.c
+++ b/src/helper/log.c
@@ -2,7 +2,7 @@
  *   Copyright (C) 2005 by Dominic Rath                                    *
  *   <A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">Dominic.Rath at gmx.de</A>                                                   *
  *                                                                         *
- *   Copyright (C) 2007,2008 &#195;&#152;yvind Harboe                                 *
+ *   Copyright (C) 2007-2010 &#195;&#152;yvind Harboe                                 *
  *   <A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">oyvind.harboe at zylin.com</A>                                               *
  *                                                                         *
  *   Copyright (C) 2008 by Spencer Oliver                                  *
@@ -159,7 +159,7 @@ static void log_puts(enum log_levels level, const char *file, int line, const ch
 #endif
 					string);
 		}
-		else if (server_use_pipes == 0)
+		else
 		{
 			/* if we are using gdb through pipes then we do not want any output
 			 * to the pipe otherwise we get repeated strings */
@@ -241,21 +241,6 @@ COMMAND_HANDLER(handle_debug_level_command)
 	else if (CMD_ARGC &gt; 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
 
-	if (debug_level &gt;= LOG_LVL_DEBUG &amp;&amp; server_use_pipes == 1)
-	{
-		/* if we are enabling debug info then we need to write to a
-		 * log file otherwise the pipe will get full and cause issues
-		 * with gdb
-		 */
-		FILE* file = fopen(&quot;openocd.log&quot;, &quot;w&quot;);
-		if (file)
-		{
-			log_output = file;
-			LOG_WARNING(&quot;enabling logfile output because &quot;
-				&quot;we are using pipes to talk to GDB.&quot;);
-		}
-	}
-
 	command_print(CMD_CTX, &quot;debug_level: %i&quot;, debug_level);
 
 	return ERROR_OK;

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi           |   33 +++++++--
 src/helper/log.c           |   19 +-----
 src/helper/options.c       |   13 +---
 src/server/gdb_server.c    |   90 +++++++++--------------
 src/server/server.c        |  172 ++++++++++++++++++++++++++++++++------------
 src/server/server.h        |   18 ++++--
 src/server/tcl_server.c    |   21 +++---
 src/server/telnet_server.c |   26 +++----
 8 files changed, 228 insertions(+), 164 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002407.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-541-gfb7235f
</A></li>
	<LI>Next message: <A HREF="002409.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-549-gd543aa0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2408">[ date ]</a>
              <a href="thread.html#2408">[ thread ]</a>
              <a href="subject.html#2408">[ subject ]</a>
              <a href="author.html#2408">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openocd-svn">More information about the openocd-svn
mailing list</a><br>
</body></html>
