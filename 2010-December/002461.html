<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-651-gc6e0705
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openocd-svn/2010-December/index.html" >
   <LINK REL="made" HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.4.0-651-gc6e0705&In-Reply-To=%3CE1PR3DO-0001my-MA%40sfp-scmshell-2.v30.ch3.sourceforge.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002460.html">
   <LINK REL="Next"  HREF="002462.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-651-gc6e0705</H1>
    <B>Spencer Oliver</B> 
    <A HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.4.0-651-gc6e0705&In-Reply-To=%3CE1PR3DO-0001my-MA%40sfp-scmshell-2.v30.ch3.sourceforge.com%3E"
       TITLE="[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-651-gc6e0705">ntfreak at users.sourceforge.net
       </A><BR>
    <I>Fri Dec 10 14:40:48 CET 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002460.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-644-gb8c42b9
</A></li>
        <LI>Next message: <A HREF="002462.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-653-gcbf48be
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2461">[ date ]</a>
              <a href="thread.html#2461">[ thread ]</a>
              <a href="subject.html#2461">[ subject ]</a>
              <a href="author.html#2461">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Main OpenOCD repository&quot;.

The branch, master has been updated
       via  c6e07051e6de439f21cb722e542e69e8bd3854c3 (commit)
       via  ae68ddc25e11a88edee09aa547c2816231a9e636 (commit)
       via  26ba6ea51113ddf2e2962f5f6edabe56fd532eb5 (commit)
       via  fe4fe623d540993d9769615a8631c732b5f3c9ea (commit)
       via  b4ee2864e45d8de2cabe35fc2de95a34c61282a4 (commit)
       via  6165f14ee2c56c5cce51663d700d888fc2d96fdb (commit)
       via  b3052b614c80b08ff7353ce5d1f765ca8420cadb (commit)
      from  b8c42b985d725ed92b97f8c6cb871a90425b9fa8 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit c6e07051e6de439f21cb722e542e69e8bd3854c3
Author: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;
Date:   Wed Dec 8 17:15:42 2010 +0000

    stm32: add STM32E-EVAL external memory config script
    
    Signed-off-by: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;

diff --git a/tcl/board/stm3210e_eval.cfg b/tcl/board/stm3210e_eval.cfg
index 83ce488..e9ba48d 100644
--- a/tcl/board/stm3210e_eval.cfg
+++ b/tcl/board/stm3210e_eval.cfg
@@ -6,3 +6,59 @@
 set WORKAREASIZE 32768
 
 source [find target/stm32.cfg]
+
+#
+# configure FSMC Bank 1 (NOR/PSRAM Bank 2) NOR flash
+# M29W128GL70ZA6E
+#
+
+set _FLASHNAME $_CHIPNAME.norflash
+flash bank $_FLASHNAME cfi 0x64000000 0x01000000 2 2 $_TARGETNAME
+
+proc stm32_enable_fsmc {} {
+
+	echo &quot;Enabling FSMC Bank 1 (NOR/PSRAM Bank 2)&quot;
+	
+	# enable gpio (defg) clocks for fsmc
+	# RCC_APB2ENR
+	mww 0x40021018 0x000001E0
+	
+	# enable fsmc clock
+	# RCC_AHBENR
+	mww 0x40021014 0x00000114
+
+	# configure gpio to alternate function
+	# GPIOD_CRL
+	mww 0x40011400 0x44BB44BB
+	# GPIOD_CRH
+	mww 0x40011404 0xBBBBBBBB
+	
+	# GPIOE_CRL
+	mww 0x40011800 0xBBBBB444
+	# GPIOE_CRH
+	mww 0x40011804 0xBBBBBBBB
+	
+	# GPIOF_CRL
+	mww 0x40011C00 0x44BBBBBB
+	# GPIOF_CRH
+	mww 0x40011C04 0xBBBB4444
+	
+	# GPIOG_CRL
+	mww 0x40012000 0x44BBBBBB
+	# GPIOG_CRH
+	mww 0x40012004 0x444444B4
+	
+	# setup fsmc timings
+	# FSMC_BCR1
+	mww 0xA0000008 0x00001058
+	
+	# FSMC_BTR1
+	mww 0xA000000C 0x10000502
+	
+	# FSMC_BCR1 - enable fsmc
+	mww 0xA0000008 0x00001059
+}
+
+$_TARGETNAME configure -event reset-init {
+	stm32_enable_fsmc
+}

commit ae68ddc25e11a88edee09aa547c2816231a9e636
Author: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;
Date:   Wed Dec 8 17:11:07 2010 +0000

    cfi: disable buffer writes for M29W128G
    
    For some reason buffer writes for the M29W128G do not work reliably,
    so disable them.
    
    See:
    <A HREF="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commitdiff;h=504a3e72208fc6a65924426ff5693982590bccdc">http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commitdiff;h=504a3e72208fc6a65924426ff5693982590bccdc</A>
    
    Signed-off-by: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;

diff --git a/src/flash/nor/cfi.c b/src/flash/nor/cfi.c
index 09caa2e..4165166 100644
--- a/src/flash/nor/cfi.c
+++ b/src/flash/nor/cfi.c
@@ -46,9 +46,10 @@ static struct cfi_unlock_addresses cfi_unlock_addresses[] =
 };
 
 /* CFI fixups foward declarations */
-static void cfi_fixup_0002_erase_regions(struct flash_bank *flash, void *param);
-static void cfi_fixup_0002_unlock_addresses(struct flash_bank *flash, void *param);
-static void cfi_fixup_reversed_erase_regions(struct flash_bank *flash, void *param);
+static void cfi_fixup_0002_erase_regions(struct flash_bank *bank, void *param);
+static void cfi_fixup_0002_unlock_addresses(struct flash_bank *bank, void *param);
+static void cfi_fixup_reversed_erase_regions(struct flash_bank *bank, void *param);
+static void cfi_fixup_0002_write_buffer(struct flash_bank *bank, void *param);
 
 /* fixup after reading cmdset 0002 primary query table */
 static const struct cfi_fixup cfi_0002_fixups[] = {
@@ -59,13 +60,14 @@ static const struct cfi_fixup cfi_0002_fixups[] = {
 	{CFI_MFR_SST, 0x2780, cfi_fixup_0002_unlock_addresses, &amp;cfi_unlock_addresses[CFI_UNLOCK_5555_2AAA]},
 	{CFI_MFR_SST, 0x236d, cfi_fixup_0002_unlock_addresses, &amp;cfi_unlock_addresses[CFI_UNLOCK_555_2AA]},
 	{CFI_MFR_ATMEL, 0x00C8, cfi_fixup_reversed_erase_regions, NULL},
-	{CFI_MFR_ST,  0x22C4, cfi_fixup_reversed_erase_regions, NULL}, /* M29W160ET */
+	{CFI_MFR_ST, 0x22C4, cfi_fixup_reversed_erase_regions, NULL}, /* M29W160ET */
 	{CFI_MFR_FUJITSU, 0x22ea, cfi_fixup_0002_unlock_addresses, &amp;cfi_unlock_addresses[CFI_UNLOCK_555_2AA]},
 	{CFI_MFR_FUJITSU, 0x226b, cfi_fixup_0002_unlock_addresses, &amp;cfi_unlock_addresses[CFI_UNLOCK_5555_2AAA]},
 	{CFI_MFR_AMIC, 0xb31a, cfi_fixup_0002_unlock_addresses, &amp;cfi_unlock_addresses[CFI_UNLOCK_555_2AA]},
 	{CFI_MFR_MX, 0x225b, cfi_fixup_0002_unlock_addresses, &amp;cfi_unlock_addresses[CFI_UNLOCK_555_2AA]},
 	{CFI_MFR_AMD, 0x225b, cfi_fixup_0002_unlock_addresses, &amp;cfi_unlock_addresses[CFI_UNLOCK_555_2AA]},
 	{CFI_MFR_ANY, CFI_ID_ANY, cfi_fixup_0002_erase_regions, NULL},
+	{CFI_MFR_ST, 0x227E, cfi_fixup_0002_write_buffer, NULL}, /* M29W128G */
 	{0, 0, NULL, NULL}
 };
 
@@ -2528,6 +2530,7 @@ static int cfi_probe(struct flash_bank *bank)
 		retval = cfi_query_u8(bank, 0, 0x1e, &amp;cfi_info-&gt;vpp_max);
 		if (retval != ERROR_OK)
 			return retval;
+
 		retval = cfi_query_u8(bank, 0, 0x1f, &amp;cfi_info-&gt;word_write_timeout_typ);
 		if (retval != ERROR_OK)
 			return retval;
@@ -2924,6 +2927,14 @@ static int get_cfi_info(struct flash_bank *bank, char *buf, int buf_size)
 	return ERROR_OK;
 }
 
+static void cfi_fixup_0002_write_buffer(struct flash_bank *bank, void *param)
+{
+	struct cfi_flash_bank *cfi_info = bank-&gt;driver_priv;
+
+	/* disable write buffer for M29W128G */
+	cfi_info-&gt;buf_write_timeout_typ = 0;
+}
+
 struct flash_driver cfi_flash = {
 	.name = &quot;cfi&quot;,
 	.flash_bank_command = cfi_flash_bank_command,
diff --git a/src/flash/nor/cfi.h b/src/flash/nor/cfi.h
index 099a613..34807ee 100644
--- a/src/flash/nor/cfi.h
+++ b/src/flash/nor/cfi.h
@@ -150,7 +150,7 @@ struct cfi_fixup
 {
 	uint16_t mfr;
 	uint16_t id;
-	void (*fixup)(struct flash_bank *flash, void *param);
+	void (*fixup)(struct flash_bank *bank, void *param);
 	void *param;
 };
 

commit 26ba6ea51113ddf2e2962f5f6edabe56fd532eb5
Author: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;
Date:   Wed Dec 8 17:07:08 2010 +0000

    cfi: allow optional buffer write support
    
    Some flash's do not support buffer writes, so we now check
    they are supported before trying to use them.
    
    Signed-off-by: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;

diff --git a/src/flash/common.h b/src/flash/common.h
index c78f24c..528b9cf 100644
--- a/src/flash/common.h
+++ b/src/flash/common.h
@@ -25,9 +25,9 @@
  * Parses the optional '.index' portion of a flash bank identifier.
  * @param name The desired driver name, passed by the user.
  * @returns The parsed index request, or 0 if not present.  If the
- * name provides a suffix but it does not parse as an unsigned integer, 
+ * name provides a suffix but it does not parse as an unsigned integer,
  * the routine returns ~0U.  This will prevent further matching.
- */ 
+ */
 unsigned get_flash_name_index(const char *name);
 /**
  * Attempt to match the @c expected name with the @c name of a driver.
@@ -44,5 +44,6 @@ bool flash_driver_name_matches(const char *name, const char *expected);
 #define ERROR_FLASH_BUSY                 (-905)
 #define ERROR_FLASH_SECTOR_NOT_ERASED    (-906)
 #define ERROR_FLASH_BANK_NOT_PROBED      (-907)
+#define ERROR_FLASH_OPER_UNSUPPORTED     (-908)
 
 #endif // FLASH_COMMON_H
diff --git a/src/flash/nor/cfi.c b/src/flash/nor/cfi.c
index 7f2d0a5..09caa2e 100644
--- a/src/flash/nor/cfi.c
+++ b/src/flash/nor/cfi.c
@@ -2051,6 +2051,13 @@ static int cfi_write_words(struct flash_bank *bank, uint8_t *word,
 {
 	struct cfi_flash_bank *cfi_info = bank-&gt;driver_priv;
 
+	if (cfi_info-&gt;buf_write_timeout_typ == 0)
+	{
+		/* buffer writes are not supported */
+		LOG_DEBUG(&quot;Buffer Writes Not Supported&quot;);
+		return ERROR_FLASH_OPER_UNSUPPORTED;
+	}
+
 	switch (cfi_info-&gt;pri_id)
 	{
 		case 1:
@@ -2241,6 +2248,8 @@ static int cfi_write(struct flash_bank *bank, uint8_t *buffer, uint32_t offset,
 						count -= buffersize;
 						fallback = 0;
 					}
+					else if (retval != ERROR_FLASH_OPER_UNSUPPORTED)
+						return retval;
 				}
 				/* try the slow way? */
 				if (fallback)

commit fe4fe623d540993d9769615a8631c732b5f3c9ea
Author: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;
Date:   Wed Dec 8 17:04:23 2010 +0000

    cfi: calculate correct timeouts
    
    The existing code used incorrect timeout values for the various cfi
    operations. We now calculate the timeouts and convert to
    msecs if necessary.
    
    Signed-off-by: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;

diff --git a/src/flash/nor/cfi.c b/src/flash/nor/cfi.c
index 477fefc..7f2d0a5 100644
--- a/src/flash/nor/cfi.c
+++ b/src/flash/nor/cfi.c
@@ -880,8 +880,7 @@ static int cfi_intel_erase(struct flash_bank *bank, int first, int last)
 		}
 
 		uint8_t status;
-		retval = cfi_intel_wait_status_busy(bank, 1000 * (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ),
-				&amp;status);
+		retval = cfi_intel_wait_status_busy(bank, cfi_info-&gt;block_erase_timeout, &amp;status);
 		if (retval != ERROR_OK)
 			return retval;
 
@@ -947,8 +946,7 @@ static int cfi_spansion_erase(struct flash_bank *bank, int first, int last)
 			return retval;
 		}
 
-		if (cfi_spansion_wait_status_busy(bank,
-				1000 * (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ)) == ERROR_OK)
+		if (cfi_spansion_wait_status_busy(bank, cfi_info-&gt;block_erase_timeout) == ERROR_OK)
 		{
 			bank-&gt;sectors[i].is_erased = 1;
 		}
@@ -1787,8 +1785,7 @@ static int cfi_intel_write_word(struct flash_bank *bank, uint8_t *word, uint32_t
 	}
 
 	uint8_t status;
-	retval = cfi_intel_wait_status_busy(bank, 1000 * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_max),
-			&amp;status);
+	retval = cfi_intel_wait_status_busy(bank, cfi_info-&gt;word_write_timeout, &amp;status);
 	if (retval != 0x80)
 	{
 		if ((retval = cfi_send_command(bank, 0xff, flash_address(bank, 0, 0x0))) != ERROR_OK)
@@ -1844,8 +1841,7 @@ static int cfi_intel_write_words(struct flash_bank *bank, uint8_t *word,
 		return retval;
 	}
 	uint8_t status;
-	retval = cfi_intel_wait_status_busy(bank,
-			1000 * (1 &lt;&lt; cfi_info-&gt;buf_write_timeout_max), &amp;status);
+	retval = cfi_intel_wait_status_busy(bank, cfi_info-&gt;buf_write_timeout, &amp;status);
 	if (retval != ERROR_OK)
 		return retval;
 	if (status != 0x80)
@@ -1878,8 +1874,7 @@ static int cfi_intel_write_words(struct flash_bank *bank, uint8_t *word,
 		return retval;
 	}
 
-	retval = cfi_intel_wait_status_busy(bank,
-			1000 * (1 &lt;&lt; cfi_info-&gt;buf_write_timeout_max), &amp;status);
+	retval = cfi_intel_wait_status_busy(bank, cfi_info-&gt;buf_write_timeout, &amp;status);
 	if (retval != ERROR_OK)
 		return retval;
 
@@ -1930,8 +1925,7 @@ static int cfi_spansion_write_word(struct flash_bank *bank, uint8_t *word, uint3
 		return retval;
 	}
 
-	if (cfi_spansion_wait_status_busy(bank,
-			1000 * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_max)) != ERROR_OK)
+	if (cfi_spansion_wait_status_busy(bank, cfi_info-&gt;word_write_timeout) != ERROR_OK)
 	{
 		if ((retval = cfi_send_command(bank, 0xf0, flash_address(bank, 0, 0x0))) != ERROR_OK)
 		{
@@ -1998,8 +1992,7 @@ static int cfi_spansion_write_words(struct flash_bank *bank, uint8_t *word,
 	}
 
 	/* Write buffer wordcount-1 and data words */
-	if ((retval = cfi_send_command(bank,
-			bufferwsize-1, address)) != ERROR_OK)
+	if ((retval = cfi_send_command(bank, bufferwsize-1, address)) != ERROR_OK)
 	{
 		return retval;
 	}
@@ -2016,8 +2009,7 @@ static int cfi_spansion_write_words(struct flash_bank *bank, uint8_t *word,
 		return retval;
 	}
 
-	if (cfi_spansion_wait_status_busy(bank,
-			1000 * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_max)) != ERROR_OK)
+	if (cfi_spansion_wait_status_busy(bank, cfi_info-&gt;buf_write_timeout) != ERROR_OK)
 	{
 		if ((retval = cfi_send_command(bank, 0xf0,
 				flash_address(bank, 0, 0x0))) != ERROR_OK)
@@ -2570,6 +2562,21 @@ static int cfi_probe(struct flash_bank *bank)
 				(1 &lt;&lt; cfi_info-&gt;block_erase_timeout_max) * (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ),
 				(1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_max) * (1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_typ));
 
+		/* convert timeouts to real values in ms */
+		cfi_info-&gt;word_write_timeout = DIV_ROUND_UP((1 &lt;&lt; cfi_info-&gt;word_write_timeout_typ) *
+						(1 &lt;&lt; cfi_info-&gt;word_write_timeout_max), 1000);
+		cfi_info-&gt;buf_write_timeout = DIV_ROUND_UP((1 &lt;&lt; cfi_info-&gt;buf_write_timeout_typ) *
+				(1 &lt;&lt; cfi_info-&gt;buf_write_timeout_max), 1000);
+		cfi_info-&gt;block_erase_timeout = (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ) *
+				(1 &lt;&lt; cfi_info-&gt;block_erase_timeout_max);
+		cfi_info-&gt;chip_erase_timeout = (1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_typ) *
+				(1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_max);
+
+		LOG_DEBUG(&quot;calculated word write timeout: %u ms, buf write timeout: %u ms, &quot;
+				&quot;block erase timeout: %u ms, chip erase timeout: %u ms&quot;,
+				cfi_info-&gt;word_write_timeout, cfi_info-&gt;buf_write_timeout,
+				cfi_info-&gt;block_erase_timeout, cfi_info-&gt;chip_erase_timeout);
+
 		uint8_t data;
 		retval = cfi_query_u8(bank, 0, 0x27, &amp;data);
 		if (retval != ERROR_OK)
diff --git a/src/flash/nor/cfi.h b/src/flash/nor/cfi.h
index e2ff808..099a613 100644
--- a/src/flash/nor/cfi.h
+++ b/src/flash/nor/cfi.h
@@ -68,6 +68,12 @@ struct cfi_flash_bank
 
 	void *pri_ext;
 	void *alt_ext;
+
+	/* calculated timeouts */
+	unsigned word_write_timeout;
+	unsigned buf_write_timeout;
+	unsigned block_erase_timeout;
+	unsigned chip_erase_timeout;
 };
 
 /* Intel primary extended query table

commit b4ee2864e45d8de2cabe35fc2de95a34c61282a4
Author: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;
Date:   Wed Dec 8 16:57:44 2010 +0000

    cfi: prefix string hex output
    
    Add hex prefix so we know output is not decimal.
    
    Signed-off-by: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;

diff --git a/src/flash/nor/cfi.c b/src/flash/nor/cfi.c
index 9a1e8d7..477fefc 100644
--- a/src/flash/nor/cfi.c
+++ b/src/flash/nor/cfi.c
@@ -1796,7 +1796,7 @@ static int cfi_intel_write_word(struct flash_bank *bank, uint8_t *word, uint32_t
 			return retval;
 		}
 
-		LOG_ERROR(&quot;couldn't write word at base 0x%&quot; PRIx32 &quot;, address %&quot; PRIx32,
+		LOG_ERROR(&quot;couldn't write word at base 0x%&quot; PRIx32 &quot;, address 0x%&quot; PRIx32,
 				bank-&gt;base, address);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
@@ -1821,7 +1821,7 @@ static int cfi_intel_write_words(struct flash_bank *bank, uint8_t *word,
 	/* Check for valid range */
 	if (address &amp; buffermask)
 	{
-		LOG_ERROR(&quot;Write address at base 0x%&quot; PRIx32 &quot;, address %&quot; PRIx32
+		LOG_ERROR(&quot;Write address at base 0x%&quot; PRIx32 &quot;, address 0x%&quot; PRIx32
 				&quot; not aligned to 2^%d boundary&quot;,
 				bank-&gt;base, address, cfi_info-&gt;max_buf_write_size);
 		return ERROR_FLASH_OPERATION_FAILED;
@@ -1855,7 +1855,7 @@ static int cfi_intel_write_words(struct flash_bank *bank, uint8_t *word,
 			return retval;
 		}
 
-		LOG_ERROR(&quot;couldn't start buffer write operation at base 0x%&quot; PRIx32 &quot;, address %&quot; PRIx32,
+		LOG_ERROR(&quot;couldn't start buffer write operation at base 0x%&quot; PRIx32 &quot;, address 0x%&quot; PRIx32,
 				bank-&gt;base, address);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
@@ -1892,7 +1892,7 @@ static int cfi_intel_write_words(struct flash_bank *bank, uint8_t *word,
 		}
 
 		LOG_ERROR(&quot;Buffer write at base 0x%&quot; PRIx32
-				&quot;, address %&quot; PRIx32 &quot; failed.&quot;, bank-&gt;base, address);
+				&quot;, address 0x%&quot; PRIx32 &quot; failed.&quot;, bank-&gt;base, address);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
 
@@ -1939,7 +1939,7 @@ static int cfi_spansion_write_word(struct flash_bank *bank, uint8_t *word, uint3
 		}
 
 		LOG_ERROR(&quot;couldn't write word at base 0x%&quot; PRIx32
-				&quot;, address %&quot; PRIx32 , bank-&gt;base, address);
+				&quot;, address 0x%&quot; PRIx32 , bank-&gt;base, address);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
 
@@ -1965,7 +1965,7 @@ static int cfi_spansion_write_words(struct flash_bank *bank, uint8_t *word,
 	if (address &amp; buffermask)
 	{
 		LOG_ERROR(&quot;Write address at base 0x%&quot; PRIx32
-				&quot;, address %&quot; PRIx32 &quot; not aligned to 2^%d boundary&quot;,
+				&quot;, address 0x%&quot; PRIx32 &quot; not aligned to 2^%d boundary&quot;,
 				bank-&gt;base, address, cfi_info-&gt;max_buf_write_size);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
@@ -1978,7 +1978,7 @@ static int cfi_spansion_write_words(struct flash_bank *bank, uint8_t *word,
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
 
-	// Unlock
+	/* Unlock */
 	if ((retval = cfi_send_command(bank, 0xaa,
 			flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
 	{
@@ -1991,7 +1991,7 @@ static int cfi_spansion_write_words(struct flash_bank *bank, uint8_t *word,
 		return retval;
 	}
 
-	// Buffer load command
+	/* Buffer load command */
 	if ((retval = cfi_send_command(bank, 0x25, address)) != ERROR_OK)
 	{
 		return retval;
@@ -2026,7 +2026,7 @@ static int cfi_spansion_write_words(struct flash_bank *bank, uint8_t *word,
 		}
 
 		LOG_ERROR(&quot;couldn't write block at base 0x%&quot; PRIx32
-				&quot;, address %&quot; PRIx32 &quot;, size %&quot; PRIx32, bank-&gt;base, address, bufferwsize);
+				&quot;, address 0x%&quot; PRIx32 &quot;, size 0x%&quot; PRIx32, bank-&gt;base, address, bufferwsize);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
 
@@ -2235,7 +2235,7 @@ static int cfi_write(struct flash_bank *bank, uint8_t *buffer, uint32_t offset,
 				int fallback;
 				if ((write_p &amp; 0xff) == 0)
 				{
-					LOG_INFO(&quot;Programming at %08&quot; PRIx32 &quot;, count %08&quot;
+					LOG_INFO(&quot;Programming at 0x%08&quot; PRIx32 &quot;, count 0x%08&quot;
 							PRIx32 &quot; bytes remaining&quot;, write_p, count);
 				}
 				fallback = 1;
@@ -2586,7 +2586,7 @@ static int cfi_probe(struct flash_bank *bank)
 		if (retval != ERROR_OK)
 			return retval;
 
-		LOG_DEBUG(&quot;size: 0x%&quot; PRIx32 &quot;, interface desc: %i, max buffer write size: %x&quot;,
+		LOG_DEBUG(&quot;size: 0x%&quot; PRIx32 &quot;, interface desc: %i, max buffer write size: 0x%x&quot;,
 				cfi_info-&gt;dev_size, cfi_info-&gt;interface_desc, (1 &lt;&lt; cfi_info-&gt;max_buf_write_size));
 
 		if (cfi_info-&gt;num_erase_regions)
@@ -2883,7 +2883,7 @@ static int get_cfi_info(struct flash_bank *bank, char *buf, int buf_size)
 		buf_size -= printed;
 
 		printed = snprintf(buf, buf_size, &quot;size: 0x%&quot; PRIx32 &quot;, interface desc: %i, &quot;
-				&quot;max buffer write size: %x\n&quot;,
+				&quot;max buffer write size: 0x%x\n&quot;,
 				cfi_info-&gt;dev_size,
 				cfi_info-&gt;interface_desc,
 				1 &lt;&lt; cfi_info-&gt;max_buf_write_size);

commit 6165f14ee2c56c5cce51663d700d888fc2d96fdb
Author: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;
Date:   Wed Dec 8 10:57:36 2010 +0000

    cfi: add time format to cfi query output
    
    Signed-off-by: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;

diff --git a/src/flash/nor/cfi.c b/src/flash/nor/cfi.c
index 01fffd7..9a1e8d7 100644
--- a/src/flash/nor/cfi.c
+++ b/src/flash/nor/cfi.c
@@ -2558,13 +2558,13 @@ static int cfi_probe(struct flash_bank *bank)
 			(cfi_info-&gt;vpp_min &amp; 0xf0) &gt;&gt; 4, cfi_info-&gt;vpp_min &amp; 0x0f,
 			(cfi_info-&gt;vpp_max &amp; 0xf0) &gt;&gt; 4, cfi_info-&gt;vpp_max &amp; 0x0f);
 
-		LOG_DEBUG(&quot;typ. word write timeout: %u, typ. buf write timeout: %u, &quot;
-				&quot;typ. block erase timeout: %u, typ. chip erase timeout: %u&quot;,
+		LOG_DEBUG(&quot;typ. word write timeout: %u us, typ. buf write timeout: %u us, &quot;
+				&quot;typ. block erase timeout: %u ms, typ. chip erase timeout: %u ms&quot;,
 				1 &lt;&lt; cfi_info-&gt;word_write_timeout_typ, 1 &lt;&lt; cfi_info-&gt;buf_write_timeout_typ,
 				1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ, 1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_typ);
 
-		LOG_DEBUG(&quot;max. word write timeout: %u, max. buf write timeout: %u, &quot;
-				&quot;max. block erase timeout: %u, max. chip erase timeout: %u&quot;,
+		LOG_DEBUG(&quot;max. word write timeout: %u us, max. buf write timeout: %u us, &quot;
+				&quot;max. block erase timeout: %u ms, max. chip erase timeout: %u ms&quot;,
 				(1 &lt;&lt; cfi_info-&gt;word_write_timeout_max) * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_typ),
 				(1 &lt;&lt; cfi_info-&gt;buf_write_timeout_max) * (1 &lt;&lt; cfi_info-&gt;buf_write_timeout_typ),
 				(1 &lt;&lt; cfi_info-&gt;block_erase_timeout_max) * (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ),
@@ -2861,8 +2861,10 @@ static int get_cfi_info(struct flash_bank *bank, char *buf, int buf_size)
 		buf += printed;
 		buf_size -= printed;
 
-		printed = snprintf(buf, buf_size, &quot;typ. word write timeout: %u, &quot;
-				&quot;typ. buf write timeout: %u, typ. block erase timeout: %u, typ. chip erase timeout: %u\n&quot;,
+		printed = snprintf(buf, buf_size, &quot;typ. word write timeout: %u us, &quot;
+				&quot;typ. buf write timeout: %u us, &quot;
+				&quot;typ. block erase timeout: %u ms, &quot;
+				&quot;typ. chip erase timeout: %u ms\n&quot;,
 				1 &lt;&lt; cfi_info-&gt;word_write_timeout_typ,
 				1 &lt;&lt; cfi_info-&gt;buf_write_timeout_typ,
 				1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ,
@@ -2870,8 +2872,9 @@ static int get_cfi_info(struct flash_bank *bank, char *buf, int buf_size)
 		buf += printed;
 		buf_size -= printed;
 
-		printed = snprintf(buf, buf_size, &quot;max. word write timeout: %u, &quot;
-				&quot;max. buf write timeout: %u, max. block erase timeout: %u, max. chip erase timeout: %u\n&quot;,
+		printed = snprintf(buf, buf_size, &quot;max. word write timeout: %u us, &quot;
+				&quot;max. buf write timeout: %u us, max. &quot;
+				&quot;block erase timeout: %u ms, max. chip erase timeout: %u ms\n&quot;,
 				(1 &lt;&lt; cfi_info-&gt;word_write_timeout_max) * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_typ),
 				(1 &lt;&lt; cfi_info-&gt;buf_write_timeout_max) * (1 &lt;&lt; cfi_info-&gt;buf_write_timeout_typ),
 				(1 &lt;&lt; cfi_info-&gt;block_erase_timeout_max) * (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ),

commit b3052b614c80b08ff7353ce5d1f765ca8420cadb
Author: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;
Date:   Wed Dec 8 10:14:15 2010 +0000

    cfi: whitespace and long line cleanup
    
    Signed-off-by: Spencer Oliver &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">ntfreak at users.sourceforge.net</A>&gt;

diff --git a/src/flash/nor/cfi.c b/src/flash/nor/cfi.c
index 43e19b5..01fffd7 100644
--- a/src/flash/nor/cfi.c
+++ b/src/flash/nor/cfi.c
@@ -60,7 +60,7 @@ static const struct cfi_fixup cfi_0002_fixups[] = {
 	{CFI_MFR_SST, 0x236d, cfi_fixup_0002_unlock_addresses, &amp;cfi_unlock_addresses[CFI_UNLOCK_555_2AA]},
 	{CFI_MFR_ATMEL, 0x00C8, cfi_fixup_reversed_erase_regions, NULL},
 	{CFI_MFR_ST,  0x22C4, cfi_fixup_reversed_erase_regions, NULL}, /* M29W160ET */
-   {CFI_MFR_FUJITSU, 0x22ea, cfi_fixup_0002_unlock_addresses, &amp;cfi_unlock_addresses[CFI_UNLOCK_555_2AA]},
+	{CFI_MFR_FUJITSU, 0x22ea, cfi_fixup_0002_unlock_addresses, &amp;cfi_unlock_addresses[CFI_UNLOCK_555_2AA]},
 	{CFI_MFR_FUJITSU, 0x226b, cfi_fixup_0002_unlock_addresses, &amp;cfi_unlock_addresses[CFI_UNLOCK_5555_2AAA]},
 	{CFI_MFR_AMIC, 0xb31a, cfi_fixup_0002_unlock_addresses, &amp;cfi_unlock_addresses[CFI_UNLOCK_555_2AA]},
 	{CFI_MFR_MX, 0x225b, cfi_fixup_0002_unlock_addresses, &amp;cfi_unlock_addresses[CFI_UNLOCK_555_2AA]},
@@ -138,10 +138,10 @@ static void cfi_command(struct flash_bank *bank, uint8_t cmd, uint8_t *cmd_buf)
 
 static int cfi_send_command(struct flash_bank *bank, uint8_t cmd, uint32_t address)
 {
-    uint8_t command[CFI_MAX_BUS_WIDTH];
+	uint8_t command[CFI_MAX_BUS_WIDTH];
 
-    cfi_command(bank, cmd, command);
-    return target_write_memory(bank-&gt;target, address, bank-&gt;bus_width, 1, command);
+	cfi_command(bank, cmd, command);
+	return target_write_memory(bank-&gt;target, address, bank-&gt;bus_width, 1, command);
 }
 
 /* read unsigned 8-bit value from the bank
@@ -154,7 +154,8 @@ static int cfi_query_u8(struct flash_bank *bank, int sector, uint32_t offset, ui
 	uint8_t data[CFI_MAX_BUS_WIDTH];
 
 	int retval;
-	retval = target_read_memory(target, flash_address(bank, sector, offset), bank-&gt;bus_width, 1, data);
+	retval = target_read_memory(target, flash_address(bank, sector, offset),
+			bank-&gt;bus_width, 1, data);
 	if (retval != ERROR_OK)
 		return retval;
 
@@ -177,7 +178,8 @@ static int cfi_get_u8(struct flash_bank *bank, int sector, uint32_t offset, uint
 	int i;
 
 	int retval;
-	retval = target_read_memory(target, flash_address(bank, sector, offset), bank-&gt;bus_width, 1, data);
+	retval = target_read_memory(target, flash_address(bank, sector, offset),
+			bank-&gt;bus_width, 1, data);
 	if (retval != ERROR_OK)
 		return retval;
 
@@ -211,14 +213,15 @@ static int cfi_query_u16(struct flash_bank *bank, int sector, uint32_t offset, u
 		uint8_t i;
 		for (i = 0;i &lt; 2;i++)
 		{
-			retval = target_read_memory(target, flash_address(bank, sector, offset + i), bank-&gt;bus_width, 1,
-				&amp;data[i*bank-&gt;bus_width]);
+			retval = target_read_memory(target, flash_address(bank, sector, offset + i),
+					bank-&gt;bus_width, 1, &amp;data[i * bank-&gt;bus_width]);
 			if (retval != ERROR_OK)
 				return retval;
 		}
 	} else
 	{
-		retval = target_read_memory(target, flash_address(bank, sector, offset), bank-&gt;bus_width, 2, data);
+		retval = target_read_memory(target, flash_address(bank, sector, offset),
+				bank-&gt;bus_width, 2, data);
 		if (retval != ERROR_OK)
 			return retval;
 	}
@@ -243,21 +246,23 @@ static int cfi_query_u32(struct flash_bank *bank, int sector, uint32_t offset, u
 		uint8_t i;
 		for (i = 0;i &lt; 4;i++)
 		{
-			retval = target_read_memory(target, flash_address(bank, sector, offset + i), bank-&gt;bus_width, 1,
-				&amp;data[i*bank-&gt;bus_width]);
+			retval = target_read_memory(target, flash_address(bank, sector, offset + i),
+					bank-&gt;bus_width, 1, &amp;data[i * bank-&gt;bus_width]);
 			if (retval != ERROR_OK)
 				return retval;
 		}
 	}
 	else
 	{
-		retval = target_read_memory(target, flash_address(bank, sector, offset), bank-&gt;bus_width, 4, data);
+		retval = target_read_memory(target, flash_address(bank, sector, offset),
+				bank-&gt;bus_width, 4, data);
 		if (retval != ERROR_OK)
 			return retval;
 	}
 
 	if (bank-&gt;target-&gt;endianness == TARGET_LITTLE_ENDIAN)
-		*val = data[0] | data[bank-&gt;bus_width] &lt;&lt; 8 | data[bank-&gt;bus_width * 2] &lt;&lt; 16 | data[bank-&gt;bus_width * 3] &lt;&lt; 24;
+		*val = data[0] | data[bank-&gt;bus_width] &lt;&lt; 8 |
+				data[bank-&gt;bus_width * 2] &lt;&lt; 16 | data[bank-&gt;bus_width * 3] &lt;&lt; 24;
 	else
 		*val = data[bank-&gt;bus_width - 1] | data[(2* bank-&gt;bus_width) - 1] &lt;&lt; 8 |
 				data[(3 * bank-&gt;bus_width) - 1] &lt;&lt; 16 | data[(4 * bank-&gt;bus_width) - 1] &lt;&lt; 24;
@@ -317,8 +322,8 @@ static int cfi_intel_wait_status_busy(struct flash_bank *bank, int timeout, uint
 	{
 		if (timeout-- &lt; 0)
 		{
-		  LOG_ERROR(&quot;timeout while waiting for WSM to become ready&quot;);
-		  return ERROR_FAIL;
+			LOG_ERROR(&quot;timeout while waiting for WSM to become ready&quot;);
+			return ERROR_FAIL;
 		}
 
 		retval = cfi_get_u8(bank, 0, 0x0, &amp;status);
@@ -451,7 +456,8 @@ static int cfi_read_intel_pri_ext(struct flash_bank *bank)
 	if (retval != ERROR_OK)
 		return retval;
 
-	LOG_DEBUG(&quot;pri: '%c%c%c', version: %c.%c&quot;, pri_ext-&gt;pri[0], pri_ext-&gt;pri[1], pri_ext-&gt;pri[2], pri_ext-&gt;major_version, pri_ext-&gt;minor_version);
+	LOG_DEBUG(&quot;pri: '%c%c%c', version: %c.%c&quot;, pri_ext-&gt;pri[0], pri_ext-&gt;pri[1],
+			pri_ext-&gt;pri[2], pri_ext-&gt;major_version, pri_ext-&gt;minor_version);
 
 	retval = cfi_query_u32(bank, 0, cfi_info-&gt;pri_addr + 5, &amp;pri_ext-&gt;feature_support);
 	if (retval != ERROR_OK)
@@ -463,10 +469,11 @@ static int cfi_read_intel_pri_ext(struct flash_bank *bank)
 	if (retval != ERROR_OK)
 		return retval;
 
-	LOG_DEBUG(&quot;feature_support: 0x%&quot; PRIx32 &quot;, suspend_cmd_support: 0x%x, blk_status_reg_mask: 0x%x&quot;,
-		  pri_ext-&gt;feature_support,
-		  pri_ext-&gt;suspend_cmd_support,
-		  pri_ext-&gt;blk_status_reg_mask);
+	LOG_DEBUG(&quot;feature_support: 0x%&quot; PRIx32 &quot;, suspend_cmd_support: &quot;
+			&quot;0x%x, blk_status_reg_mask: 0x%x&quot;,
+			pri_ext-&gt;feature_support,
+			pri_ext-&gt;suspend_cmd_support,
+			pri_ext-&gt;blk_status_reg_mask);
 
 	retval = cfi_query_u8(bank, 0, cfi_info-&gt;pri_addr + 0xc, &amp;pri_ext-&gt;vcc_optimal);
 	if (retval != ERROR_OK)
@@ -476,15 +483,16 @@ static int cfi_read_intel_pri_ext(struct flash_bank *bank)
 		return retval;
 
 	LOG_DEBUG(&quot;Vcc opt: %x.%x, Vpp opt: %u.%x&quot;,
-		  (pri_ext-&gt;vcc_optimal &amp; 0xf0) &gt;&gt; 4, pri_ext-&gt;vcc_optimal &amp; 0x0f,
-		  (pri_ext-&gt;vpp_optimal &amp; 0xf0) &gt;&gt; 4, pri_ext-&gt;vpp_optimal &amp; 0x0f);
+			(pri_ext-&gt;vcc_optimal &amp; 0xf0) &gt;&gt; 4, pri_ext-&gt;vcc_optimal &amp; 0x0f,
+			(pri_ext-&gt;vpp_optimal &amp; 0xf0) &gt;&gt; 4, pri_ext-&gt;vpp_optimal &amp; 0x0f);
 
 	retval = cfi_query_u8(bank, 0, cfi_info-&gt;pri_addr + 0xe, &amp;pri_ext-&gt;num_protection_fields);
 	if (retval != ERROR_OK)
 		return retval;
 	if (pri_ext-&gt;num_protection_fields != 1)
 	{
-		LOG_WARNING(&quot;expected one protection register field, but found %i&quot;, pri_ext-&gt;num_protection_fields);
+		LOG_WARNING(&quot;expected one protection register field, but found %i&quot;,
+				pri_ext-&gt;num_protection_fields);
 	}
 
 	retval = cfi_query_u16(bank, 0, cfi_info-&gt;pri_addr + 0xf, &amp;pri_ext-&gt;prot_reg_addr);
@@ -497,7 +505,10 @@ static int cfi_read_intel_pri_ext(struct flash_bank *bank)
 	if (retval != ERROR_OK)
 		return retval;
 
-	LOG_DEBUG(&quot;protection_fields: %i, prot_reg_addr: 0x%x, factory pre-programmed: %i, user programmable: %i&quot;, pri_ext-&gt;num_protection_fields, pri_ext-&gt;prot_reg_addr, 1 &lt;&lt; pri_ext-&gt;fact_prot_reg_size, 1 &lt;&lt; pri_ext-&gt;user_prot_reg_size);
+	LOG_DEBUG(&quot;protection_fields: %i, prot_reg_addr: 0x%x, &quot;
+			&quot;factory pre-programmed: %i, user programmable: %i&quot;,
+			pri_ext-&gt;num_protection_fields, pri_ext-&gt;prot_reg_addr,
+			1 &lt;&lt; pri_ext-&gt;fact_prot_reg_size, 1 &lt;&lt; pri_ext-&gt;user_prot_reg_size);
 
 	return ERROR_OK;
 }
@@ -546,7 +557,8 @@ static int cfi_read_spansion_pri_ext(struct flash_bank *bank)
 	if (retval != ERROR_OK)
 		return retval;
 
-	LOG_DEBUG(&quot;pri: '%c%c%c', version: %c.%c&quot;, pri_ext-&gt;pri[0], pri_ext-&gt;pri[1], pri_ext-&gt;pri[2], pri_ext-&gt;major_version, pri_ext-&gt;minor_version);
+	LOG_DEBUG(&quot;pri: '%c%c%c', version: %c.%c&quot;, pri_ext-&gt;pri[0], pri_ext-&gt;pri[1],
+			pri_ext-&gt;pri[2], pri_ext-&gt;major_version, pri_ext-&gt;minor_version);
 
 	retval = cfi_query_u8(bank, 0, cfi_info-&gt;pri_addr + 5, &amp;pri_ext-&gt;SiliconRevision);
 	if (retval != ERROR_OK)
@@ -582,11 +594,12 @@ static int cfi_read_spansion_pri_ext(struct flash_bank *bank)
 	if (retval != ERROR_OK)
 		return retval;
 
-	LOG_DEBUG(&quot;Silicon Revision: 0x%x, Erase Suspend: 0x%x, Block protect: 0x%x&quot;, pri_ext-&gt;SiliconRevision,
-	      pri_ext-&gt;EraseSuspend, pri_ext-&gt;BlkProt);
+	LOG_DEBUG(&quot;Silicon Revision: 0x%x, Erase Suspend: 0x%x, Block protect: 0x%x&quot;,
+			pri_ext-&gt;SiliconRevision, pri_ext-&gt;EraseSuspend, pri_ext-&gt;BlkProt);
 
-	LOG_DEBUG(&quot;Temporary Unprotect: 0x%x, Block Protect Scheme: 0x%x, Simultaneous Ops: 0x%x&quot;, pri_ext-&gt;TmpBlkUnprotect,
-	      pri_ext-&gt;BlkProtUnprot, pri_ext-&gt;SimultaneousOps);
+	LOG_DEBUG(&quot;Temporary Unprotect: 0x%x, Block Protect Scheme: 0x%x, &quot;
+			&quot;Simultaneous Ops: 0x%x&quot;, pri_ext-&gt;TmpBlkUnprotect,
+			pri_ext-&gt;BlkProtUnprot, pri_ext-&gt;SimultaneousOps);
 
 	LOG_DEBUG(&quot;Burst Mode: 0x%x, Page Mode: 0x%x, &quot;, pri_ext-&gt;BurstMode, pri_ext-&gt;PageMode);
 
@@ -641,7 +654,8 @@ static int cfi_read_atmel_pri_ext(struct flash_bank *bank)
 	if (retval != ERROR_OK)
 		return retval;
 
-	if ((atmel_pri_ext.pri[0] != 'P') || (atmel_pri_ext.pri[1] != 'R') || (atmel_pri_ext.pri[2] != 'I'))
+	if ((atmel_pri_ext.pri[0] != 'P') || (atmel_pri_ext.pri[1] != 'R')
+			|| (atmel_pri_ext.pri[2] != 'I'))
 	{
 		if ((retval = cfi_send_command(bank, 0xf0, flash_address(bank, 0, 0x0))) != ERROR_OK)
 		{
@@ -662,7 +676,9 @@ static int cfi_read_atmel_pri_ext(struct flash_bank *bank)
 	if (retval != ERROR_OK)
 		return retval;
 
-	LOG_DEBUG(&quot;pri: '%c%c%c', version: %c.%c&quot;, atmel_pri_ext.pri[0], atmel_pri_ext.pri[1], atmel_pri_ext.pri[2], atmel_pri_ext.major_version, atmel_pri_ext.minor_version);
+	LOG_DEBUG(&quot;pri: '%c%c%c', version: %c.%c&quot;, atmel_pri_ext.pri[0],
+			atmel_pri_ext.pri[1], atmel_pri_ext.pri[2],
+			atmel_pri_ext.major_version, atmel_pri_ext.minor_version);
 
 	pri_ext-&gt;major_version = atmel_pri_ext.major_version;
 	pri_ext-&gt;minor_version = atmel_pri_ext.minor_version;
@@ -681,7 +697,8 @@ static int cfi_read_atmel_pri_ext(struct flash_bank *bank)
 		return retval;
 
 	LOG_DEBUG(&quot;features: 0x%2.2x, bottom_boot: 0x%2.2x, burst_mode: 0x%2.2x, page_mode: 0x%2.2x&quot;,
-		atmel_pri_ext.features, atmel_pri_ext.bottom_boot, atmel_pri_ext.burst_mode, atmel_pri_ext.page_mode);
+		atmel_pri_ext.features, atmel_pri_ext.bottom_boot,
+		atmel_pri_ext.burst_mode, atmel_pri_ext.page_mode);
 
 	if (atmel_pri_ext.features &amp; 0x02)
 		pri_ext-&gt;EraseSuspend = 2;
@@ -722,26 +739,26 @@ static int cfi_spansion_info(struct flash_bank *bank, char *buf, int buf_size)
 	buf_size -= printed;
 
 	printed = snprintf(buf, buf_size, &quot;pri: '%c%c%c', version: %c.%c\n&quot;, pri_ext-&gt;pri[0],
-			   pri_ext-&gt;pri[1], pri_ext-&gt;pri[2],
-			   pri_ext-&gt;major_version, pri_ext-&gt;minor_version);
+			pri_ext-&gt;pri[1], pri_ext-&gt;pri[2],
+			pri_ext-&gt;major_version, pri_ext-&gt;minor_version);
 	buf += printed;
 	buf_size -= printed;
 
 	printed = snprintf(buf, buf_size, &quot;Silicon Rev.: 0x%x, Address Sensitive unlock: 0x%x\n&quot;,
-			   (pri_ext-&gt;SiliconRevision) &gt;&gt; 2,
-			   (pri_ext-&gt;SiliconRevision) &amp; 0x03);
+			(pri_ext-&gt;SiliconRevision) &gt;&gt; 2,
+			(pri_ext-&gt;SiliconRevision) &amp; 0x03);
 	buf += printed;
 	buf_size -= printed;
 
 	printed = snprintf(buf, buf_size, &quot;Erase Suspend: 0x%x, Sector Protect: 0x%x\n&quot;,
-			   pri_ext-&gt;EraseSuspend,
-			   pri_ext-&gt;BlkProt);
+			pri_ext-&gt;EraseSuspend,
+			pri_ext-&gt;BlkProt);
 	buf += printed;
 	buf_size -= printed;
 
 	printed = snprintf(buf, buf_size, &quot;VppMin: %u.%x, VppMax: %u.%x\n&quot;,
-		(pri_ext-&gt;VppMin &amp; 0xf0) &gt;&gt; 4, pri_ext-&gt;VppMin &amp; 0x0f,
-		(pri_ext-&gt;VppMax &amp; 0xf0) &gt;&gt; 4, pri_ext-&gt;VppMax &amp; 0x0f);
+			(pri_ext-&gt;VppMin &amp; 0xf0) &gt;&gt; 4, pri_ext-&gt;VppMin &amp; 0x0f,
+			(pri_ext-&gt;VppMax &amp; 0xf0) &gt;&gt; 4, pri_ext-&gt;VppMax &amp; 0x0f);
 
 	return ERROR_OK;
 }
@@ -756,21 +773,27 @@ static int cfi_intel_info(struct flash_bank *bank, char *buf, int buf_size)
 	buf += printed;
 	buf_size -= printed;
 
-	printed = snprintf(buf, buf_size, &quot;pri: '%c%c%c', version: %c.%c\n&quot;, pri_ext-&gt;pri[0], pri_ext-&gt;pri[1], pri_ext-&gt;pri[2], pri_ext-&gt;major_version, pri_ext-&gt;minor_version);
+	printed = snprintf(buf, buf_size, &quot;pri: '%c%c%c', version: %c.%c\n&quot;, pri_ext-&gt;pri[0],
+			pri_ext-&gt;pri[1], pri_ext-&gt;pri[2], pri_ext-&gt;major_version, pri_ext-&gt;minor_version);
 	buf += printed;
 	buf_size -= printed;
 
-	printed = snprintf(buf, buf_size, &quot;feature_support: 0x%&quot; PRIx32 &quot;, suspend_cmd_support: 0x%x, blk_status_reg_mask: 0x%x\n&quot;, pri_ext-&gt;feature_support, pri_ext-&gt;suspend_cmd_support, pri_ext-&gt;blk_status_reg_mask);
+	printed = snprintf(buf, buf_size, &quot;feature_support: 0x%&quot; PRIx32 &quot;, &quot;
+			&quot;suspend_cmd_support: 0x%x, blk_status_reg_mask: 0x%x\n&quot;,
+			pri_ext-&gt;feature_support, pri_ext-&gt;suspend_cmd_support, pri_ext-&gt;blk_status_reg_mask);
 	buf += printed;
 	buf_size -= printed;
 
 	printed = snprintf(buf, buf_size, &quot;Vcc opt: %x.%x, Vpp opt: %u.%x\n&quot;,
-		(pri_ext-&gt;vcc_optimal &amp; 0xf0) &gt;&gt; 4, pri_ext-&gt;vcc_optimal &amp; 0x0f,
-		(pri_ext-&gt;vpp_optimal &amp; 0xf0) &gt;&gt; 4, pri_ext-&gt;vpp_optimal &amp; 0x0f);
+			(pri_ext-&gt;vcc_optimal &amp; 0xf0) &gt;&gt; 4, pri_ext-&gt;vcc_optimal &amp; 0x0f,
+			(pri_ext-&gt;vpp_optimal &amp; 0xf0) &gt;&gt; 4, pri_ext-&gt;vpp_optimal &amp; 0x0f);
 	buf += printed;
 	buf_size -= printed;
 
-	printed = snprintf(buf, buf_size, &quot;protection_fields: %i, prot_reg_addr: 0x%x, factory pre-programmed: %i, user programmable: %i\n&quot;, pri_ext-&gt;num_protection_fields, pri_ext-&gt;prot_reg_addr, 1 &lt;&lt; pri_ext-&gt;fact_prot_reg_size, 1 &lt;&lt; pri_ext-&gt;user_prot_reg_size);
+	printed = snprintf(buf, buf_size, &quot;protection_fields: %i, prot_reg_addr: 0x%x, &quot;
+			&quot;factory pre-programmed: %i, user programmable: %i\n&quot;,
+			pri_ext-&gt;num_protection_fields, pri_ext-&gt;prot_reg_addr,
+			1 &lt;&lt; pri_ext-&gt;fact_prot_reg_size, 1 &lt;&lt; pri_ext-&gt;user_prot_reg_size);
 
 	return ERROR_OK;
 }
@@ -857,7 +880,8 @@ static int cfi_intel_erase(struct flash_bank *bank, int first, int last)
 		}
 
 		uint8_t status;
-		retval = cfi_intel_wait_status_busy(bank, 1000 * (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ), &amp;status);
+		retval = cfi_intel_wait_status_busy(bank, 1000 * (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ),
+				&amp;status);
 		if (retval != ERROR_OK)
 			return retval;
 
@@ -887,46 +911,57 @@ static int cfi_spansion_erase(struct flash_bank *bank, int first, int last)
 
 	for (i = first; i &lt;= last; i++)
 	{
-		if ((retval = cfi_send_command(bank, 0xaa, flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
+		if ((retval = cfi_send_command(bank, 0xaa,
+				flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
 		{
 			return retval;
 		}
 
-		if ((retval = cfi_send_command(bank, 0x55, flash_address(bank, 0, pri_ext-&gt;_unlock2))) != ERROR_OK)
+		if ((retval = cfi_send_command(bank, 0x55,
+				flash_address(bank, 0, pri_ext-&gt;_unlock2))) != ERROR_OK)
 		{
 			return retval;
 		}
 
-		if ((retval = cfi_send_command(bank, 0x80, flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
+		if ((retval = cfi_send_command(bank, 0x80,
+				flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
 		{
 			return retval;
 		}
 
-		if ((retval = cfi_send_command(bank, 0xaa, flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
+		if ((retval = cfi_send_command(bank, 0xaa,
+				flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
 		{
 			return retval;
 		}
 
-		if ((retval = cfi_send_command(bank, 0x55, flash_address(bank, 0, pri_ext-&gt;_unlock2))) != ERROR_OK)
+		if ((retval = cfi_send_command(bank, 0x55,
+				flash_address(bank, 0, pri_ext-&gt;_unlock2))) != ERROR_OK)
 		{
 			return retval;
 		}
 
-		if ((retval = cfi_send_command(bank, 0x30, flash_address(bank, i, 0x0))) != ERROR_OK)
+		if ((retval = cfi_send_command(bank, 0x30,
+				flash_address(bank, i, 0x0))) != ERROR_OK)
 		{
 			return retval;
 		}
 
-		if (cfi_spansion_wait_status_busy(bank, 1000 * (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ)) == ERROR_OK)
+		if (cfi_spansion_wait_status_busy(bank,
+				1000 * (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ)) == ERROR_OK)
+		{
 			bank-&gt;sectors[i].is_erased = 1;
+		}
 		else
 		{
-			if ((retval = cfi_send_command(bank, 0xf0, flash_address(bank, 0, 0x0))) != ERROR_OK)
+			if ((retval = cfi_send_command(bank, 0xf0,
+					flash_address(bank, 0, 0x0))) != ERROR_OK)
 			{
 				return retval;
 			}
 
-			LOG_ERROR(&quot;couldn't erase block %i of flash bank at base 0x%&quot; PRIx32, i, bank-&gt;base);
+			LOG_ERROR(&quot;couldn't erase block %i of flash bank at base 0x%&quot;
+					PRIx32, i, bank-&gt;base);
 			return ERROR_FLASH_OPERATION_FAILED;
 		}
 	}
@@ -1034,8 +1069,10 @@ static int cfi_intel_protect(struct flash_bank *bank, int set, int first, int la
 
 			if ((block_status &amp; 0x1) != set)
 			{
-				LOG_ERROR(&quot;couldn't change block lock status (set = %i, block_status = 0x%2.2x)&quot;, set, block_status);
-				if ((retval = cfi_send_command(bank, 0x70, flash_address(bank, 0, 0x55))) != ERROR_OK)
+				LOG_ERROR(&quot;couldn't change block lock status (set = %i, block_status = 0x%2.2x)&quot;,
+						set, block_status);
+				if ((retval = cfi_send_command(bank, 0x70,
+						flash_address(bank, 0, 0x55))) != ERROR_OK)
 				{
 					return retval;
 				}
@@ -1077,12 +1114,14 @@ static int cfi_intel_protect(struct flash_bank *bank, int set, int first, int la
 			{
 				cfi_intel_clear_status_register(bank);
 
-				if ((retval = cfi_send_command(bank, 0x60, flash_address(bank, i, 0x0))) != ERROR_OK)
+				if ((retval = cfi_send_command(bank, 0x60,
+						flash_address(bank, i, 0x0))) != ERROR_OK)
 				{
 					return retval;
 				}
 
-				if ((retval = cfi_send_command(bank, 0x01, flash_address(bank, i, 0x0))) != ERROR_OK)
+				if ((retval = cfi_send_command(bank, 0x01,
+						flash_address(bank, i, 0x0))) != ERROR_OK)
 				{
 					return retval;
 				}
@@ -1131,7 +1170,8 @@ static int cfi_protect(struct flash_bank *bank, int set, int first, int last)
 
 /* Convert code image to target endian */
 /* FIXME create general block conversion fcts in target.c?) */
-static void cfi_fix_code_endian(struct target *target, uint8_t *dest, const uint32_t *src, uint32_t count)
+static void cfi_fix_code_endian(struct target *target, uint8_t *dest,
+		const uint32_t *src, uint32_t count)
 {
 	uint32_t i;
 	for (i = 0; i&lt; count; i++)
@@ -1165,7 +1205,8 @@ static uint32_t cfi_command_val(struct flash_bank *bank, uint8_t cmd)
 	}
 }
 
-static int cfi_intel_write_block(struct flash_bank *bank, uint8_t *buffer, uint32_t address, uint32_t count)
+static int cfi_intel_write_block(struct flash_bank *bank, uint8_t *buffer,
+		uint32_t address, uint32_t count)
 {
 	struct cfi_flash_bank *cfi_info = bank-&gt;driver_priv;
 	struct target *target = bank-&gt;target;
@@ -1279,7 +1320,8 @@ static int cfi_intel_write_block(struct flash_bank *bank, uint8_t *buffer, uint3
 	{
 		if (target_code_size &gt; sizeof(target_code))
 		{
-			LOG_WARNING(&quot;Internal error - target code buffer to small. Increase CFI_MAX_INTEL_CODESIZE and recompile.&quot;);
+			LOG_WARNING(&quot;Internal error - target code buffer to small. &quot;
+					&quot;Increase CFI_MAX_INTEL_CODESIZE and recompile.&quot;);
 			return ERROR_TARGET_RESOURCE_NOT_AVAILABLE;
 		}
 		cfi_fix_code_endian(target, target_code, target_code_src, target_code_size / 4);
@@ -1293,7 +1335,8 @@ static int cfi_intel_write_block(struct flash_bank *bank, uint8_t *buffer, uint3
 		};
 
 		/* write algorithm code to working area */
-		retval = target_write_buffer(target, cfi_info-&gt;write_algorithm-&gt;address, target_code_size, target_code);
+		retval = target_write_buffer(target, cfi_info-&gt;write_algorithm-&gt;address,
+				target_code_size, target_code);
 		if (retval != ERROR_OK)
 		{
 			LOG_ERROR(&quot;Unable to write block write code to target&quot;);
@@ -1329,7 +1372,8 @@ static int cfi_intel_write_block(struct flash_bank *bank, uint8_t *buffer, uint3
 	busy_pattern_val  = cfi_command_val(bank, 0x80);
 	error_pattern_val = cfi_command_val(bank, 0x7e);
 
-	LOG_DEBUG(&quot;Using target buffer at 0x%08&quot; PRIx32 &quot; and of size 0x%04&quot; PRIx32, source-&gt;address, buffer_size);
+	LOG_DEBUG(&quot;Using target buffer at 0x%08&quot; PRIx32 &quot; and of size 0x%04&quot; PRIx32,
+			source-&gt;address, buffer_size);
 
 	/* Programming main loop */
 	while (count &gt; 0)
@@ -1337,7 +1381,8 @@ static int cfi_intel_write_block(struct flash_bank *bank, uint8_t *buffer, uint3
 		uint32_t thisrun_count = (count &gt; buffer_size) ? buffer_size : count;
 		uint32_t wsm_error;
 
-		if ((retval = target_write_buffer(target, source-&gt;address, thisrun_count, buffer)) != ERROR_OK)
+		if ((retval = target_write_buffer(target, source-&gt;address,
+				thisrun_count, buffer)) != ERROR_OK)
 		{
 			goto cleanup;
 		}
@@ -1367,7 +1412,7 @@ static int cfi_intel_write_block(struct flash_bank *bank, uint8_t *buffer, uint3
 			retval = ERROR_FLASH_OPERATION_FAILED;
 			/* retval = ERROR_TARGET_RESOURCE_NOT_AVAILABLE; */
 			/* FIXME To allow fall back or recovery, we must save the actual status
-			   somewhere, so that a higher level code can start recovery. */
+			 * somewhere, so that a higher level code can start recovery. */
 			goto cleanup;
 		}
 
@@ -1412,7 +1457,8 @@ cleanup:
 	return retval;
 }
 
-static int cfi_spansion_write_block(struct flash_bank *bank, uint8_t *buffer, uint32_t address, uint32_t count)
+static int cfi_spansion_write_block(struct flash_bank *bank, uint8_t *buffer,
+		uint32_t address, uint32_t count)
 {
 	struct cfi_flash_bank *cfi_info = bank-&gt;driver_priv;
 	struct cfi_spansion_pri_ext *pri_ext = cfi_info-&gt;pri_ext;
@@ -1444,128 +1490,128 @@ static int cfi_spansion_write_block(struct flash_bank *bank, uint8_t *buffer, ui
 	static const uint32_t word_32_code[] = {
 						/* 00008100 &lt;sp_32_code&gt;:		*/
 		0xe4905004,		/* ldr	r5, [r0], #4			*/
-		0xe5889000, 	/* str	r9, [r8]				*/
-		0xe58ab000, 	/* str	r11, [r10]				*/
-		0xe5883000, 	/* str	r3, [r8]				*/
-		0xe5815000, 	/* str	r5, [r1]				*/
-		0xe1a00000, 	/* nop							*/
+		0xe5889000,		/* str	r9, [r8]				*/
+		0xe58ab000,		/* str	r11, [r10]				*/
+		0xe5883000,		/* str	r3, [r8]				*/
+		0xe5815000,		/* str	r5, [r1]				*/
+		0xe1a00000,		/* nop							*/
 						/*								*/
 						/* 00008110 &lt;sp_32_busy&gt;:		*/
-		0xe5916000, 	/* ldr	r6, [r1]				*/
-		0xe0257006, 	/* eor	r7, r5, r6				*/
-		0xe0147007, 	/* ands	r7, r4, r7				*/
-		0x0a000007, 	/* beq	8140 &lt;sp_32_cont&gt; ; b if DQ7 == Data7 */
-		0xe0166124, 	/* ands	r6, r6, r4, lsr #2		*/
-		0x0afffff9, 	/* beq	8110 &lt;sp_32_busy&gt; ;	b if DQ5 low */
-		0xe5916000, 	/* ldr	r6, [r1]				*/
-		0xe0257006, 	/* eor	r7, r5, r6				*/
-		0xe0147007, 	/* ands	r7, r4, r7				*/
-		0x0a000001, 	/* beq	8140 &lt;sp_32_cont&gt; ; b if DQ7 == Data7 */
-		0xe3a05000, 	/* mov	r5, #0	; 0x0 - return 0x00, error */
-		0x1a000004, 	/* bne	8154 &lt;sp_32_done&gt;		*/
+		0xe5916000,		/* ldr	r6, [r1]				*/
+		0xe0257006,		/* eor	r7, r5, r6				*/
+		0xe0147007,		/* ands	r7, r4, r7				*/
+		0x0a000007,		/* beq	8140 &lt;sp_32_cont&gt; ; b if DQ7 == Data7 */
+		0xe0166124,		/* ands	r6, r6, r4, lsr #2		*/
+		0x0afffff9,		/* beq	8110 &lt;sp_32_busy&gt; ;	b if DQ5 low */
+		0xe5916000,		/* ldr	r6, [r1]				*/
+		0xe0257006,		/* eor	r7, r5, r6				*/
+		0xe0147007,		/* ands	r7, r4, r7				*/
+		0x0a000001,		/* beq	8140 &lt;sp_32_cont&gt; ; b if DQ7 == Data7 */
+		0xe3a05000,		/* mov	r5, #0	; 0x0 - return 0x00, error */
+		0x1a000004,		/* bne	8154 &lt;sp_32_done&gt;		*/
 						/*								*/
-				/* 00008140 &lt;sp_32_cont&gt;:				*/
-		0xe2522001, 	/* subs	r2, r2, #1	; 0x1		*/
-		0x03a05080, 	/* moveq	r5, #128	; 0x80	*/
-		0x0a000001, 	/* beq	8154 &lt;sp_32_done&gt;		*/
-		0xe2811004, 	/* add	r1, r1, #4	; 0x4		*/
-		0xeaffffe8, 	/* b	8100 &lt;sp_32_code&gt;		*/
+						/* 00008140 &lt;sp_32_cont&gt;:		*/
+		0xe2522001,		/* subs	r2, r2, #1	; 0x1		*/
+		0x03a05080,		/* moveq	r5, #128	; 0x80	*/
+		0x0a000001,		/* beq	8154 &lt;sp_32_done&gt;		*/
+		0xe2811004,		/* add	r1, r1, #4	; 0x4		*/
+		0xeaffffe8,		/* b	8100 &lt;sp_32_code&gt;		*/
 						/*								*/
 						/* 00008154 &lt;sp_32_done&gt;:		*/
 		0xeafffffe		/* b	8154 &lt;sp_32_done&gt;		*/
 		};
 
 		static const uint32_t word_16_code[] = {
-				/* 00008158 &lt;sp_16_code&gt;:              */
-		0xe0d050b2, 	/* ldrh	r5, [r0], #2		   */
-		0xe1c890b0, 	/* strh	r9, [r8]				*/
-		0xe1cab0b0, 	/* strh	r11, [r10]				*/
-		0xe1c830b0, 	/* strh	r3, [r8]				*/
-		0xe1c150b0, 	/* strh	r5, [r1]		       */
-		0xe1a00000, 	/* nop			(mov r0,r0)    */
-				/* 				       */
-				/* 00008168 &lt;sp_16_busy&gt;:	       */
-		0xe1d160b0, 	/* ldrh	r6, [r1]		       */
-		0xe0257006, 	/* eor	r7, r5, r6		       */
-		0xe0147007, 	/* ands	r7, r4, r7		       */
-		0x0a000007, 	/* beq	8198 &lt;sp_16_cont&gt;	       */
-		0xe0166124, 	/* ands	r6, r6, r4, lsr #2	       */
-		0x0afffff9, 	/* beq	8168 &lt;sp_16_busy&gt;	       */
-		0xe1d160b0, 	/* ldrh	r6, [r1]		       */
-		0xe0257006, 	/* eor	r7, r5, r6		       */
-		0xe0147007, 	/* ands	r7, r4, r7		       */
-		0x0a000001, 	/* beq	8198 &lt;sp_16_cont&gt;	       */
-		0xe3a05000, 	/* mov	r5, #0	; 0x0		       */
-		0x1a000004, 	/* bne	81ac &lt;sp_16_done&gt;	       */
-				/* 				       */
-				/* 00008198 &lt;sp_16_cont&gt;:	       */
-		0xe2522001, 	/* subs	r2, r2, #1	; 0x1	       */
-		0x03a05080, 	/* moveq	r5, #128	; 0x80 */
-		0x0a000001, 	/* beq	81ac &lt;sp_16_done&gt;	       */
-		0xe2811002, 	/* add	r1, r1, #2	; 0x2	       */
-		0xeaffffe8, 	/* b	8158 &lt;sp_16_code&gt;	       */
-				/* 				       */
-				/* 000081ac &lt;sp_16_done&gt;:	       */
-		0xeafffffe 	/* b	81ac &lt;sp_16_done&gt;              */
+						/* 00008158 &lt;sp_16_code&gt;:		*/
+		0xe0d050b2,		/* ldrh	r5, [r0], #2			*/
+		0xe1c890b0,		/* strh	r9, [r8]				*/
+		0xe1cab0b0,		/* strh	r11, [r10]				*/
+		0xe1c830b0,		/* strh	r3, [r8]				*/
+		0xe1c150b0,		/* strh	r5, [r1]				*/
+		0xe1a00000,		/* nop			(mov r0,r0)		*/
+						/*								*/
+						/* 00008168 &lt;sp_16_busy&gt;:		*/
+		0xe1d160b0,		/* ldrh	r6, [r1]				*/
+		0xe0257006,		/* eor	r7, r5, r6				*/
+		0xe0147007,		/* ands	r7, r4, r7				*/
+		0x0a000007,		/* beq	8198 &lt;sp_16_cont&gt;		*/
+		0xe0166124,		/* ands	r6, r6, r4, lsr #2		*/
+		0x0afffff9,		/* beq	8168 &lt;sp_16_busy&gt;		*/
+		0xe1d160b0,		/* ldrh	r6, [r1]				*/
+		0xe0257006,		/* eor	r7, r5, r6				*/
+		0xe0147007,		/* ands	r7, r4, r7				*/
+		0x0a000001,		/* beq	8198 &lt;sp_16_cont&gt;		*/
+		0xe3a05000,		/* mov	r5, #0	; 0x0			*/
+		0x1a000004,		/* bne	81ac &lt;sp_16_done&gt;		*/
+						/*								*/
+						/* 00008198 &lt;sp_16_cont&gt;:		*/
+		0xe2522001, 	/* subs	r2, r2, #1	; 0x1		*/
+		0x03a05080, 	/* moveq	r5, #128	; 0x80	*/
+		0x0a000001, 	/* beq	81ac &lt;sp_16_done&gt;		*/
+		0xe2811002, 	/* add	r1, r1, #2	; 0x2		*/
+		0xeaffffe8, 	/* b	8158 &lt;sp_16_code&gt;		*/
+						/* 								*/
+						/* 000081ac &lt;sp_16_done&gt;:		*/
+		0xeafffffe		/* b	81ac &lt;sp_16_done&gt;		*/
 		};
 
 		static const uint32_t word_16_code_dq7only[] = {
-				/* &lt;sp_16_code&gt;:                       */
-		0xe0d050b2, 	/* ldrh r5, [r0], #2                   */
-		0xe1c890b0, 	/* strh r9, [r8]                       */
-		0xe1cab0b0, 	/* strh	r11, [r10]				*/
-		0xe1c830b0, 	/* strh	r3, [r8]				*/
-		0xe1c150b0, 	/* strh	r5, [r1]		       */
-		0xe1a00000, 	/* nop			(mov r0,r0)    */
-				/* 				       */
-				/* &lt;sp_16_busy&gt;:                       */
-		0xe1d160b0, 	/* ldrh	r6, [r1]		       */
-		0xe0257006, 	/* eor	r7, r5, r6		       */
-		0xe2177080, 	/* ands	r7, #0x80                      */
-		0x1afffffb, 	/* bne	8168 &lt;sp_16_busy&gt;	       */
-				/* 				       */
-		0xe2522001, 	/* subs	r2, r2, #1	; 0x1	       */
-		0x03a05080, 	/* moveq	r5, #128	; 0x80 */
-		0x0a000001, 	/* beq	81ac &lt;sp_16_done&gt;	       */
-		0xe2811002, 	/* add	r1, r1, #2	; 0x2	       */
-		0xeafffff0, 	/* b	8158 &lt;sp_16_code&gt;	       */
-				/* 				       */
-				/* 000081ac &lt;sp_16_done&gt;:	       */
-		0xeafffffe 	/* b	81ac &lt;sp_16_done&gt;              */
+						/* &lt;sp_16_code&gt;:				*/
+		0xe0d050b2,		/* ldrh r5, [r0], #2			*/
+		0xe1c890b0,		/* strh r9, [r8]				*/
+		0xe1cab0b0,		/* strh	r11, [r10]				*/
+		0xe1c830b0,		/* strh	r3, [r8]				*/
+		0xe1c150b0,		/* strh	r5, [r1]				*/
+		0xe1a00000,		/* nop			(mov r0,r0)		*/
+						/*								*/
+						/* &lt;sp_16_busy&gt;:				*/
+		0xe1d160b0,		/* ldrh	r6, [r1]				*/
+		0xe0257006,		/* eor	r7, r5, r6				*/
+		0xe2177080,		/* ands	r7, #0x80				*/
+		0x1afffffb,		/* bne	8168 &lt;sp_16_busy&gt;		*/
+						/*								*/
+		0xe2522001,		/* subs	r2, r2, #1	; 0x1		*/
+		0x03a05080,		/* moveq	r5, #128	; 0x80	*/
+		0x0a000001,		/* beq	81ac &lt;sp_16_done&gt;		*/
+		0xe2811002,		/* add	r1, r1, #2	; 0x2		*/
+		0xeafffff0,		/* b	8158 &lt;sp_16_code&gt;		*/
+						/* 								*/
+						/* 000081ac &lt;sp_16_done&gt;:		*/
+		0xeafffffe		/* b	81ac &lt;sp_16_done&gt;		*/
 		};
 
 		static const uint32_t word_8_code[] = {
-				/* 000081b0 &lt;sp_16_code_end&gt;:          */
-		0xe4d05001, 	/* ldrb	r5, [r0], #1		       */
-		0xe5c89000, 	/* strb	r9, [r8]				*/
-		0xe5cab000, 	/* strb	r11, [r10]				*/
-		0xe5c83000, 	/* strb	r3, [r8]				*/
-		0xe5c15000, 	/* strb	r5, [r1]		       */
-		0xe1a00000, 	/* nop			(mov r0,r0)    */
-				/* 				       */
-				/* 000081c0 &lt;sp_8_busy&gt;:	       */
-		0xe5d16000, 	/* ldrb	r6, [r1]		       */
-		0xe0257006, 	/* eor	r7, r5, r6		       */
-		0xe0147007, 	/* ands	r7, r4, r7		       */
-		0x0a000007, 	/* beq	81f0 &lt;sp_8_cont&gt;	       */
-		0xe0166124, 	/* ands	r6, r6, r4, lsr #2	       */
-		0x0afffff9, 	/* beq	81c0 &lt;sp_8_busy&gt;	       */
-		0xe5d16000, 	/* ldrb	r6, [r1]		       */
-		0xe0257006, 	/* eor	r7, r5, r6		       */
-		0xe0147007, 	/* ands	r7, r4, r7		       */
-		0x0a000001, 	/* beq	81f0 &lt;sp_8_cont&gt;	       */
-		0xe3a05000, 	/* mov	r5, #0	; 0x0		       */
-		0x1a000004, 	/* bne	8204 &lt;sp_8_done&gt;	       */
-				/* 				       */
-				/* 000081f0 &lt;sp_8_cont&gt;:	       */
-		0xe2522001, 	/* subs	r2, r2, #1	; 0x1	       */
-		0x03a05080, 	/* moveq	r5, #128	; 0x80 */
-		0x0a000001, 	/* beq	8204 &lt;sp_8_done&gt;	       */
-		0xe2811001, 	/* add	r1, r1, #1	; 0x1	       */
-		0xeaffffe8, 	/* b	81b0 &lt;sp_16_code_end&gt;	       */
-				/* 				       */
-				/* 00008204 &lt;sp_8_done&gt;:	       */
-		0xeafffffe 	/* b	8204 &lt;sp_8_done&gt;               */
+						/* 000081b0 &lt;sp_16_code_end&gt;:	*/
+		0xe4d05001,		/* ldrb	r5, [r0], #1			*/
+		0xe5c89000,		/* strb	r9, [r8]				*/
+		0xe5cab000,		/* strb	r11, [r10]				*/
+		0xe5c83000,		/* strb	r3, [r8]				*/
+		0xe5c15000,		/* strb	r5, [r1]				*/
+		0xe1a00000,		/* nop			(mov r0,r0)		*/
+						/*								*/
+						/* 000081c0 &lt;sp_8_busy&gt;:		*/
+		0xe5d16000,		/* ldrb	r6, [r1]				*/
+		0xe0257006,		/* eor	r7, r5, r6				*/
+		0xe0147007,		/* ands	r7, r4, r7				*/
+		0x0a000007,		/* beq	81f0 &lt;sp_8_cont&gt;		*/
+		0xe0166124,		/* ands	r6, r6, r4, lsr #2		*/
+		0x0afffff9,		/* beq	81c0 &lt;sp_8_busy&gt;		*/
+		0xe5d16000,		/* ldrb	r6, [r1]				*/
+		0xe0257006,		/* eor	r7, r5, r6				*/
+		0xe0147007,		/* ands	r7, r4, r7				*/
+		0x0a000001,		/* beq	81f0 &lt;sp_8_cont&gt;		*/
+		0xe3a05000,		/* mov	r5, #0	; 0x0			*/
+		0x1a000004,		/* bne	8204 &lt;sp_8_done&gt;		*/
+						/*								*/
+						/* 000081f0 &lt;sp_8_cont&gt;:		*/
+		0xe2522001,		/* subs	r2, r2, #1	; 0x1		*/
+		0x03a05080,		/* moveq	r5, #128	; 0x80	*/
+		0x0a000001,		/* beq	8204 &lt;sp_8_done&gt;		*/
+		0xe2811001,		/* add	r1, r1, #1	; 0x1		*/
+		0xeaffffe8,		/* b	81b0 &lt;sp_16_code_end&gt;	*/
+						/*								*/
+						/* 00008204 &lt;sp_8_done&gt;:		*/
+		0xeafffffe		/* b	8204 &lt;sp_8_done&gt;		*/
 	};
 
 	armv4_5_info.common_magic = ARM_COMMON_MAGIC;
@@ -1629,7 +1675,7 @@ static int cfi_spansion_write_block(struct flash_bank *bank, uint8_t *buffer, ui
 
 		/* write algorithm code to working area */
 		if ((retval = target_write_buffer(target, cfi_info-&gt;write_algorithm-&gt;address,
-		                    target_code_size, target_code)) != ERROR_OK)
+				target_code_size, target_code)) != ERROR_OK)
 		{
 			free(target_code);
 			return retval;
@@ -1644,7 +1690,8 @@ static int cfi_spansion_write_block(struct flash_bank *bank, uint8_t *buffer, ui
 		buffer_size /= 2;
 		if (buffer_size &lt;= 256)
 		{
-			/* if we already allocated the writing code, but failed to get a buffer, free the algorithm */
+			/* if we already allocated the writing code, but failed to get a
+			 * buffer, free the algorithm */
 			if (cfi_info-&gt;write_algorithm)
 				target_free_working_area(target, cfi_info-&gt;write_algorithm);
 
@@ -1685,9 +1732,9 @@ static int cfi_spansion_write_block(struct flash_bank *bank, uint8_t *buffer, ui
 		buf_set_u32(reg_params[9].value, 0, 32, 0x55555555);
 
 		retval = target_run_algorithm(target, 0, NULL, 10, reg_params,
-						     cfi_info-&gt;write_algorithm-&gt;address,
-						     cfi_info-&gt;write_algorithm-&gt;address + ((target_code_size) - 4),
-						     10000, &amp;armv4_5_info);
+				cfi_info-&gt;write_algorithm-&gt;address,
+				cfi_info-&gt;write_algorithm-&gt;address + ((target_code_size) - 4),
+				10000, &amp;armv4_5_info);
 		if (retval != ERROR_OK)
 		{
 			break;
@@ -1740,7 +1787,8 @@ static int cfi_intel_write_word(struct flash_bank *bank, uint8_t *word, uint32_t
 	}
 
 	uint8_t status;
-	retval = cfi_intel_wait_status_busy(bank, 1000 * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_max), &amp;status);
+	retval = cfi_intel_wait_status_busy(bank, 1000 * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_max),
+			&amp;status);
 	if (retval != 0x80)
 	{
 		if ((retval = cfi_send_command(bank, 0xff, flash_address(bank, 0, 0x0))) != ERROR_OK)
@@ -1748,14 +1796,16 @@ static int cfi_intel_write_word(struct flash_bank *bank, uint8_t *word, uint32_t
 			return retval;
 		}
 
-		LOG_ERROR(&quot;couldn't write word at base 0x%&quot; PRIx32 &quot;, address %&quot; PRIx32 , bank-&gt;base, address);
+		LOG_ERROR(&quot;couldn't write word at base 0x%&quot; PRIx32 &quot;, address %&quot; PRIx32,
+				bank-&gt;base, address);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
 
 	return ERROR_OK;
 }
 
-static int cfi_intel_write_words(struct flash_bank *bank, uint8_t *word, uint32_t wordcount, uint32_t address)
+static int cfi_intel_write_words(struct flash_bank *bank, uint8_t *word,
+		uint32_t wordcount, uint32_t address)
 {
 	int retval;
 	struct cfi_flash_bank *cfi_info = bank-&gt;driver_priv;
@@ -1771,15 +1821,17 @@ static int cfi_intel_write_words(struct flash_bank *bank, uint8_t *word, uint32_
 	/* Check for valid range */
 	if (address &amp; buffermask)
 	{
-		LOG_ERROR(&quot;Write address at base 0x%&quot; PRIx32 &quot;, address %&quot; PRIx32 &quot; not aligned to 2^%d boundary&quot;,
-			  bank-&gt;base, address, cfi_info-&gt;max_buf_write_size);
+		LOG_ERROR(&quot;Write address at base 0x%&quot; PRIx32 &quot;, address %&quot; PRIx32
+				&quot; not aligned to 2^%d boundary&quot;,
+				bank-&gt;base, address, cfi_info-&gt;max_buf_write_size);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
 
 	/* Check for valid size */
 	if (wordcount &gt; bufferwsize)
 	{
-		LOG_ERROR(&quot;Number of data words %&quot; PRId32 &quot; exceeds available buffersize %&quot; PRId32 , wordcount, buffersize);
+		LOG_ERROR(&quot;Number of data words %&quot; PRId32 &quot; exceeds available buffersize %&quot; PRId32,
+				wordcount, buffersize);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
 
@@ -1792,7 +1844,8 @@ static int cfi_intel_write_words(struct flash_bank *bank, uint8_t *word, uint32_
 		return retval;
 	}
 	uint8_t status;
-	retval = cfi_intel_wait_status_busy(bank, 1000 * (1 &lt;&lt; cfi_info-&gt;buf_write_timeout_max), &amp;status);
+	retval = cfi_intel_wait_status_busy(bank,
+			1000 * (1 &lt;&lt; cfi_info-&gt;buf_write_timeout_max), &amp;status);
 	if (retval != ERROR_OK)
 		return retval;
 	if (status != 0x80)
@@ -1802,7 +1855,8 @@ static int cfi_intel_write_words(struct flash_bank *bank, uint8_t *word, uint32_
 			return retval;
 		}
 
-		LOG_ERROR(&quot;couldn't start buffer write operation at base 0x%&quot; PRIx32 &quot;, address %&quot; PRIx32 , bank-&gt;base, address);
+		LOG_ERROR(&quot;couldn't start buffer write operation at base 0x%&quot; PRIx32 &quot;, address %&quot; PRIx32,
+				bank-&gt;base, address);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
 
@@ -1812,7 +1866,8 @@ static int cfi_intel_write_words(struct flash_bank *bank, uint8_t *word, uint32_
 		return retval;
 	}
 
-	if ((retval = target_write_memory(target, address, bank-&gt;bus_width, bufferwsize, word)) != ERROR_OK)
+	if ((retval = target_write_memory(target,
+			address, bank-&gt;bus_width, bufferwsize, word)) != ERROR_OK)
 	{
 		return retval;
 	}
@@ -1823,18 +1878,21 @@ static int cfi_intel_write_words(struct flash_bank *bank, uint8_t *word, uint32_
 		return retval;
 	}
 
-	retval = cfi_intel_wait_status_busy(bank, 1000 * (1 &lt;&lt; cfi_info-&gt;buf_write_timeout_max), &amp;status);
+	retval = cfi_intel_wait_status_busy(bank,
+			1000 * (1 &lt;&lt; cfi_info-&gt;buf_write_timeout_max), &amp;status);
 	if (retval != ERROR_OK)
 		return retval;
 
 	if (status != 0x80)
 	{
-		if ((retval = cfi_send_command(bank, 0xff, flash_address(bank, 0, 0x0))) != ERROR_OK)
+		if ((retval = cfi_send_command(bank, 0xff,
+				flash_address(bank, 0, 0x0))) != ERROR_OK)
 		{
 			return retval;
 		}
 
-		LOG_ERROR(&quot;Buffer write at base 0x%&quot; PRIx32 &quot;, address %&quot; PRIx32 &quot; failed.&quot;, bank-&gt;base, address);
+		LOG_ERROR(&quot;Buffer write at base 0x%&quot; PRIx32
+				&quot;, address %&quot; PRIx32 &quot; failed.&quot;, bank-&gt;base, address);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
 
@@ -1848,41 +1906,48 @@ static int cfi_spansion_write_word(struct flash_bank *bank, uint8_t *word, uint3
 	struct cfi_spansion_pri_ext *pri_ext = cfi_info-&gt;pri_ext;
 	struct target *target = bank-&gt;target;
 
-	if ((retval = cfi_send_command(bank, 0xaa, flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
+	if ((retval = cfi_send_command(bank, 0xaa,
+			flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
 	{
 		return retval;
 	}
 
-	if ((retval = cfi_send_command(bank, 0x55, flash_address(bank, 0, pri_ext-&gt;_unlock2))) != ERROR_OK)
+	if ((retval = cfi_send_command(bank, 0x55,
+			flash_address(bank, 0, pri_ext-&gt;_unlock2))) != ERROR_OK)
 	{
 		return retval;
 	}
 
-	if ((retval = cfi_send_command(bank, 0xa0, flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
+	if ((retval = cfi_send_command(bank, 0xa0,
+			flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
 	{
 		return retval;
 	}
 
-	if ((retval = target_write_memory(target, address, bank-&gt;bus_width, 1, word)) != ERROR_OK)
+	if ((retval = target_write_memory(target,
+			address, bank-&gt;bus_width, 1, word)) != ERROR_OK)
 	{
 		return retval;
 	}
 
-	if (cfi_spansion_wait_status_busy(bank, 1000 * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_max)) != ERROR_OK)
+	if (cfi_spansion_wait_status_busy(bank,
+			1000 * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_max)) != ERROR_OK)
 	{
 		if ((retval = cfi_send_command(bank, 0xf0, flash_address(bank, 0, 0x0))) != ERROR_OK)
 		{
 			return retval;
 		}
 
-		LOG_ERROR(&quot;couldn't write word at base 0x%&quot; PRIx32 &quot;, address %&quot; PRIx32 , bank-&gt;base, address);
+		LOG_ERROR(&quot;couldn't write word at base 0x%&quot; PRIx32
+				&quot;, address %&quot; PRIx32 , bank-&gt;base, address);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
 
 	return ERROR_OK;
 }
 
-static int cfi_spansion_write_words(struct flash_bank *bank, uint8_t *word, uint32_t wordcount, uint32_t address)
+static int cfi_spansion_write_words(struct flash_bank *bank, uint8_t *word,
+		uint32_t wordcount, uint32_t address)
 {
 	int retval;
 	struct cfi_flash_bank *cfi_info = bank-&gt;driver_priv;
@@ -1899,24 +1964,29 @@ static int cfi_spansion_write_words(struct flash_bank *bank, uint8_t *word, uint
 	/* Check for valid range */
 	if (address &amp; buffermask)
 	{
-		LOG_ERROR(&quot;Write address at base 0x%&quot; PRIx32 &quot;, address %&quot; PRIx32 &quot; not aligned to 2^%d boundary&quot;, bank-&gt;base, address, cfi_info-&gt;max_buf_write_size);
+		LOG_ERROR(&quot;Write address at base 0x%&quot; PRIx32
+				&quot;, address %&quot; PRIx32 &quot; not aligned to 2^%d boundary&quot;,
+				bank-&gt;base, address, cfi_info-&gt;max_buf_write_size);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
 
 	/* Check for valid size */
 	if (wordcount &gt; bufferwsize)
 	{
-		LOG_ERROR(&quot;Number of data words %&quot; PRId32 &quot; exceeds available buffersize %&quot; PRId32, wordcount, buffersize);
+		LOG_ERROR(&quot;Number of data words %&quot; PRId32 &quot; exceeds available buffersize %&quot;
+				PRId32, wordcount, buffersize);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
 
 	// Unlock
-	if ((retval = cfi_send_command(bank, 0xaa, flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
+	if ((retval = cfi_send_command(bank, 0xaa,
+			flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
 	{
 		return retval;
 	}
 
-	if ((retval = cfi_send_command(bank, 0x55, flash_address(bank, 0, pri_ext-&gt;_unlock2))) != ERROR_OK)
+	if ((retval = cfi_send_command(bank, 0x55,
+			flash_address(bank, 0, pri_ext-&gt;_unlock2))) != ERROR_OK)
 	{
 		return retval;
 	}
@@ -1928,12 +1998,14 @@ static int cfi_spansion_write_words(struct flash_bank *bank, uint8_t *word, uint
 	}
 
 	/* Write buffer wordcount-1 and data words */
-	if ((retval = cfi_send_command(bank, bufferwsize-1, address)) != ERROR_OK)
+	if ((retval = cfi_send_command(bank,
+			bufferwsize-1, address)) != ERROR_OK)
 	{
 		return retval;
 	}
 
-	if ((retval = target_write_memory(target, address, bank-&gt;bus_width, bufferwsize, word)) != ERROR_OK)
+	if ((retval = target_write_memory(target,
+			address, bank-&gt;bus_width, bufferwsize, word)) != ERROR_OK)
 	{
 		return retval;
 	}
@@ -1944,14 +2016,17 @@ static int cfi_spansion_write_words(struct flash_bank *bank, uint8_t *word, uint
 		return retval;
 	}
 
-	if (cfi_spansion_wait_status_busy(bank, 1000 * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_max)) != ERROR_OK)
+	if (cfi_spansion_wait_status_busy(bank,
+			1000 * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_max)) != ERROR_OK)
 	{
-		if ((retval = cfi_send_command(bank, 0xf0, flash_address(bank, 0, 0x0))) != ERROR_OK)
+		if ((retval = cfi_send_command(bank, 0xf0,
+				flash_address(bank, 0, 0x0))) != ERROR_OK)
 		{
 			return retval;
 		}
 
-		LOG_ERROR(&quot;couldn't write block at base 0x%&quot; PRIx32 &quot;, address %&quot; PRIx32 &quot;, size %&quot; PRIx32 , bank-&gt;base, address, bufferwsize);
+		LOG_ERROR(&quot;couldn't write block at base 0x%&quot; PRIx32
+				&quot;, address %&quot; PRIx32 &quot;, size %&quot; PRIx32, bank-&gt;base, address, bufferwsize);
 		return ERROR_FLASH_OPERATION_FAILED;
 	}
 
@@ -1979,7 +2054,8 @@ static int cfi_write_word(struct flash_bank *bank, uint8_t *word, uint32_t addre
 	return ERROR_FLASH_OPERATION_FAILED;
 }
 
-static int cfi_write_words(struct flash_bank *bank, uint8_t *word, uint32_t wordcount, uint32_t address)
+static int cfi_write_words(struct flash_bank *bank, uint8_t *word,
+		uint32_t wordcount, uint32_t address)
 {
 	struct cfi_flash_bank *cfi_info = bank-&gt;driver_priv;
 
@@ -2033,7 +2109,8 @@ static int cfi_read(struct flash_bank *bank, uint8_t *buffer, uint32_t offset, u
 		LOG_INFO(&quot;Fixup %d unaligned read head bytes&quot;, align);
 
 		/* read a complete word from flash */
-		if ((retval = target_read_memory(target, read_p, bank-&gt;bus_width, 1, current_word)) != ERROR_OK)
+		if ((retval = target_read_memory(target, read_p,
+				bank-&gt;bus_width, 1, current_word)) != ERROR_OK)
 			return retval;
 
 		/* take only bytes we need */
@@ -2046,7 +2123,8 @@ static int cfi_read(struct flash_bank *bank, uint8_t *buffer, uint32_t offset, u
 	align = count / bank-&gt;bus_width;
 	if (align)
 	{
-		if ((retval = target_read_memory(target, read_p, bank-&gt;bus_width, align, buffer)) != ERROR_OK)
+		if ((retval = target_read_memory(target, read_p,
+				bank-&gt;bus_width, align, buffer)) != ERROR_OK)
 			return retval;
 
 		read_p += align * bank-&gt;bus_width;
@@ -2059,7 +2137,8 @@ static int cfi_read(struct flash_bank *bank, uint8_t *buffer, uint32_t offset, u
 		LOG_INFO(&quot;Fixup %d unaligned read tail bytes&quot;, count);
 
 		/* read a complete word from flash */
-		if ((retval = target_read_memory(target, read_p, bank-&gt;bus_width, 1, current_word)) != ERROR_OK)
+		if ((retval = target_read_memory(target, read_p,
+				bank-&gt;bus_width, 1, current_word)) != ERROR_OK)
 			return retval;
 
 		/* take only bytes we need */
@@ -2101,7 +2180,8 @@ static int cfi_write(struct flash_bank *bank, uint8_t *buffer, uint32_t offset,
 		LOG_INFO(&quot;Fixup %d unaligned head bytes&quot;, align);
 
 		/* read a complete word from flash */
-		if ((retval = target_read_memory(target, write_p, bank-&gt;bus_width, 1, current_word)) != ERROR_OK)
+		if ((retval = target_read_memory(target, write_p,
+				bank-&gt;bus_width, 1, current_word)) != ERROR_OK)
 			return retval;
 
 		/* replace only bytes that must be written */
@@ -2155,7 +2235,8 @@ static int cfi_write(struct flash_bank *bank, uint8_t *buffer, uint32_t offset,
 				int fallback;
 				if ((write_p &amp; 0xff) == 0)
 				{
-					LOG_INFO(&quot;Programming at %08&quot; PRIx32 &quot;, count %08&quot; PRIx32 &quot; bytes remaining&quot;, write_p, count);
+					LOG_INFO(&quot;Programming at %08&quot; PRIx32 &quot;, count %08&quot;
+							PRIx32 &quot; bytes remaining&quot;, write_p, count);
 				}
 				fallback = 1;
 				if ((bufferwsize &gt; 0) &amp;&amp; (count &gt;= buffersize) &amp;&amp; !(write_p &amp; buffermask))
@@ -2200,7 +2281,8 @@ static int cfi_write(struct flash_bank *bank, uint8_t *buffer, uint32_t offset,
 		LOG_INFO(&quot;Fixup %&quot; PRId32 &quot; unaligned tail bytes&quot;, count);
 
 		/* read a complete word from flash */
-		if ((retval = target_read_memory(target, write_p, bank-&gt;bus_width, 1, current_word)) != ERROR_OK)
+		if ((retval = target_read_memory(target, write_p,
+				bank-&gt;bus_width, 1, current_word)) != ERROR_OK)
 			return retval;
 
 		/* replace only bytes that must be written */
@@ -2279,7 +2361,8 @@ static int cfi_query_string(struct flash_bank *bank, int address)
 	if (retval != ERROR_OK)
 		return retval;
 
-	LOG_DEBUG(&quot;CFI qry returned: 0x%2.2x 0x%2.2x 0x%2.2x&quot;, cfi_info-&gt;qry[0], cfi_info-&gt;qry[1], cfi_info-&gt;qry[2]);
+	LOG_DEBUG(&quot;CFI qry returned: 0x%2.2x 0x%2.2x 0x%2.2x&quot;,
+			cfi_info-&gt;qry[0], cfi_info-&gt;qry[1], cfi_info-&gt;qry[2]);
 
 	if ((cfi_info-&gt;qry[0] != 'Q') || (cfi_info-&gt;qry[1] != 'R') || (cfi_info-&gt;qry[2] != 'Y'))
 	{
@@ -2347,11 +2430,13 @@ static int cfi_probe(struct flash_bank *bank)
 		return retval;
 	}
 
-	if ((retval = target_read_memory(target, flash_address(bank, 0, 0x00), bank-&gt;bus_width, 1, value_buf0)) != ERROR_OK)
+	if ((retval = target_read_memory(target, flash_address(bank, 0, 0x00),
+			bank-&gt;bus_width, 1, value_buf0)) != ERROR_OK)
 	{
 		return retval;
 	}
-	if ((retval = target_read_memory(target, flash_address(bank, 0, 0x01), bank-&gt;bus_width, 1, value_buf1)) != ERROR_OK)
+	if ((retval = target_read_memory(target, flash_address(bank, 0, 0x01),
+			bank-&gt;bus_width, 1, value_buf1)) != ERROR_OK)
 	{
 		return retval;
 	}
@@ -2373,7 +2458,8 @@ static int cfi_probe(struct flash_bank *bank)
 			return ERROR_FLASH_OPERATION_FAILED;
 	}
 
-	LOG_INFO(&quot;Flash Manufacturer/Device: 0x%04x 0x%04x&quot;, cfi_info-&gt;manufacturer, cfi_info-&gt;device_id);
+	LOG_INFO(&quot;Flash Manufacturer/Device: 0x%04x 0x%04x&quot;,
+			cfi_info-&gt;manufacturer, cfi_info-&gt;device_id);
 	/* switch back to read array mode */
 	if ((retval = cfi_reset(bank)) != ERROR_OK)
 	{
@@ -2424,7 +2510,10 @@ static int cfi_probe(struct flash_bank *bank)
 		if (retval != ERROR_OK)
 			return retval;
 
-		LOG_DEBUG(&quot;qry: '%c%c%c', pri_id: 0x%4.4x, pri_addr: 0x%4.4x, alt_id: 0x%4.4x, alt_addr: 0x%4.4x&quot;, cfi_info-&gt;qry[0], cfi_info-&gt;qry[1], cfi_info-&gt;qry[2], cfi_info-&gt;pri_id, cfi_info-&gt;pri_addr, cfi_info-&gt;alt_id, cfi_info-&gt;alt_addr);
+		LOG_DEBUG(&quot;qry: '%c%c%c', pri_id: 0x%4.4x, pri_addr: 0x%4.4x, alt_id: &quot;
+				&quot;0x%4.4x, alt_addr: 0x%4.4x&quot;, cfi_info-&gt;qry[0], cfi_info-&gt;qry[1],
+				cfi_info-&gt;qry[2], cfi_info-&gt;pri_id, cfi_info-&gt;pri_addr,
+				cfi_info-&gt;alt_id, cfi_info-&gt;alt_addr);
 
 		retval = cfi_query_u8(bank, 0, 0x1b, &amp;cfi_info-&gt;vcc_min);
 		if (retval != ERROR_OK)
@@ -2468,12 +2557,18 @@ static int cfi_probe(struct flash_bank *bank)
 			(cfi_info-&gt;vcc_max &amp; 0xf0) &gt;&gt; 4, cfi_info-&gt;vcc_max &amp; 0x0f,
 			(cfi_info-&gt;vpp_min &amp; 0xf0) &gt;&gt; 4, cfi_info-&gt;vpp_min &amp; 0x0f,
 			(cfi_info-&gt;vpp_max &amp; 0xf0) &gt;&gt; 4, cfi_info-&gt;vpp_max &amp; 0x0f);
-		LOG_DEBUG(&quot;typ. word write timeout: %u, typ. buf write timeout: %u, typ. block erase timeout: %u, typ. chip erase timeout: %u&quot;, 1 &lt;&lt; cfi_info-&gt;word_write_timeout_typ, 1 &lt;&lt; cfi_info-&gt;buf_write_timeout_typ,
-			1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ, 1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_typ);
-		LOG_DEBUG(&quot;max. word write timeout: %u, max. buf write timeout: %u, max. block erase timeout: %u, max. chip erase timeout: %u&quot;, (1 &lt;&lt; cfi_info-&gt;word_write_timeout_max) * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_typ),
-			(1 &lt;&lt; cfi_info-&gt;buf_write_timeout_max) * (1 &lt;&lt; cfi_info-&gt;buf_write_timeout_typ),
-			(1 &lt;&lt; cfi_info-&gt;block_erase_timeout_max) * (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ),
-			(1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_max) * (1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_typ));
+
+		LOG_DEBUG(&quot;typ. word write timeout: %u, typ. buf write timeout: %u, &quot;
+				&quot;typ. block erase timeout: %u, typ. chip erase timeout: %u&quot;,
+				1 &lt;&lt; cfi_info-&gt;word_write_timeout_typ, 1 &lt;&lt; cfi_info-&gt;buf_write_timeout_typ,
+				1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ, 1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_typ);
+
+		LOG_DEBUG(&quot;max. word write timeout: %u, max. buf write timeout: %u, &quot;
+				&quot;max. block erase timeout: %u, max. chip erase timeout: %u&quot;,
+				(1 &lt;&lt; cfi_info-&gt;word_write_timeout_max) * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_typ),
+				(1 &lt;&lt; cfi_info-&gt;buf_write_timeout_max) * (1 &lt;&lt; cfi_info-&gt;buf_write_timeout_typ),
+				(1 &lt;&lt; cfi_info-&gt;block_erase_timeout_max) * (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ),
+				(1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_max) * (1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_typ));
 
 		uint8_t data;
 		retval = cfi_query_u8(bank, 0, 0x27, &amp;data);
@@ -2491,7 +2586,8 @@ static int cfi_probe(struct flash_bank *bank)
 		if (retval != ERROR_OK)
 			return retval;
 
-		LOG_DEBUG(&quot;size: 0x%&quot; PRIx32 &quot;, interface desc: %i, max buffer write size: %x&quot;, cfi_info-&gt;dev_size, cfi_info-&gt;interface_desc, (1 &lt;&lt; cfi_info-&gt;max_buf_write_size));
+		LOG_DEBUG(&quot;size: 0x%&quot; PRIx32 &quot;, interface desc: %i, max buffer write size: %x&quot;,
+				cfi_info-&gt;dev_size, cfi_info-&gt;interface_desc, (1 &lt;&lt; cfi_info-&gt;max_buf_write_size));
 
 		if (cfi_info-&gt;num_erase_regions)
 		{
@@ -2502,10 +2598,9 @@ static int cfi_probe(struct flash_bank *bank)
 				retval = cfi_query_u32(bank, 0, 0x2d + (4 * i), &amp;cfi_info-&gt;erase_region_info[i]);
 				if (retval != ERROR_OK)
 					return retval;
-				LOG_DEBUG(&quot;erase region[%i]: %&quot; PRIu32 &quot; blocks of size 0x%&quot; PRIx32 &quot;&quot;,
-					  i,
-					  (cfi_info-&gt;erase_region_info[i] &amp; 0xffff) + 1,
-					  (cfi_info-&gt;erase_region_info[i] &gt;&gt; 16) * 256);
+				LOG_DEBUG(&quot;erase region[%i]: %&quot; PRIu32 &quot; blocks of size 0x%&quot; PRIx32 &quot;&quot;, i,
+						(cfi_info-&gt;erase_region_info[i] &amp; 0xffff) + 1,
+						(cfi_info-&gt;erase_region_info[i] &gt;&gt; 16) * 256);
 			}
 		}
 		else
@@ -2561,7 +2656,8 @@ static int cfi_probe(struct flash_bank *bank)
 
 	if ((cfi_info-&gt;dev_size * bank-&gt;bus_width / bank-&gt;chip_width) != bank-&gt;size)
 	{
-		LOG_WARNING(&quot;configuration specifies 0x%&quot; PRIx32 &quot; size, but a 0x%&quot; PRIx32 &quot; size flash was found&quot;, bank-&gt;size, cfi_info-&gt;dev_size);
+		LOG_WARNING(&quot;configuration specifies 0x%&quot; PRIx32 &quot; size, but a 0x%&quot; PRIx32
+				&quot; size flash was found&quot;, bank-&gt;size, cfi_info-&gt;dev_size);
 	}
 
 	if (cfi_info-&gt;num_erase_regions == 0)
@@ -2593,7 +2689,8 @@ static int cfi_probe(struct flash_bank *bank)
 			for (j = 0; j &lt; (cfi_info-&gt;erase_region_info[i] &amp; 0xffff) + 1; j++)
 			{
 				bank-&gt;sectors[sector].offset = offset;
-				bank-&gt;sectors[sector].size = ((cfi_info-&gt;erase_region_info[i] &gt;&gt; 16) * 256) * bank-&gt;bus_width / bank-&gt;chip_width;
+				bank-&gt;sectors[sector].size = ((cfi_info-&gt;erase_region_info[i] &gt;&gt; 16) * 256)
+						* bank-&gt;bus_width / bank-&gt;chip_width;
 				offset += bank-&gt;sectors[sector].size;
 				bank-&gt;sectors[sector].is_erased = -1;
 				bank-&gt;sectors[sector].is_protected = -1;
@@ -2659,17 +2756,20 @@ static int cfi_spansion_protect_check(struct flash_bank *bank)
 	struct cfi_spansion_pri_ext *pri_ext = cfi_info-&gt;pri_ext;
 	int i;
 
-	if ((retval = cfi_send_command(bank, 0xaa, flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
+	if ((retval = cfi_send_command(bank, 0xaa,
+			flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
 	{
 		return retval;
 	}
 
-	if ((retval = cfi_send_command(bank, 0x55, flash_address(bank, 0, pri_ext-&gt;_unlock2))) != ERROR_OK)
+	if ((retval = cfi_send_command(bank, 0x55,
+			flash_address(bank, 0, pri_ext-&gt;_unlock2))) != ERROR_OK)
 	{
 		return retval;
 	}
 
-	if ((retval = cfi_send_command(bank, 0x90, flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
+	if ((retval = cfi_send_command(bank, 0x90,
+			flash_address(bank, 0, pri_ext-&gt;_unlock1))) != ERROR_OK)
 	{
 		return retval;
 	}
@@ -2745,54 +2845,61 @@ static int get_cfi_info(struct flash_bank *bank, char *buf, int buf_size)
 
 	if (cfi_info-&gt;not_cfi == 0)
 	{
-	printed = snprintf(buf, buf_size, &quot;qry: '%c%c%c', pri_id: 0x%4.4x, pri_addr: 0x%4.4x, alt_id: 0x%4.4x, alt_addr: 0x%4.4x\n&quot;, cfi_info-&gt;qry[0], cfi_info-&gt;qry[1], cfi_info-&gt;qry[2], cfi_info-&gt;pri_id, cfi_info-&gt;pri_addr, cfi_info-&gt;alt_id, cfi_info-&gt;alt_addr);
-	buf += printed;
-	buf_size -= printed;
-
-		printed = snprintf(buf, buf_size, &quot;Vcc min: %x.%x, Vcc max: %x.%x, Vpp min: %u.%x, Vpp max: %u.%x\n&quot;,
-		                   (cfi_info-&gt;vcc_min &amp; 0xf0) &gt;&gt; 4, cfi_info-&gt;vcc_min &amp; 0x0f,
-	(cfi_info-&gt;vcc_max &amp; 0xf0) &gt;&gt; 4, cfi_info-&gt;vcc_max &amp; 0x0f,
-	(cfi_info-&gt;vpp_min &amp; 0xf0) &gt;&gt; 4, cfi_info-&gt;vpp_min &amp; 0x0f,
-	(cfi_info-&gt;vpp_max &amp; 0xf0) &gt;&gt; 4, cfi_info-&gt;vpp_max &amp; 0x0f);
-	buf += printed;
-	buf_size -= printed;
-
-		printed = snprintf(buf, buf_size, &quot;typ. word write timeout: %u, typ. buf write timeout: %u, typ. block erase timeout: %u, typ. chip erase timeout: %u\n&quot;,
-		                   1 &lt;&lt; cfi_info-&gt;word_write_timeout_typ,
-		                   1 &lt;&lt; cfi_info-&gt;buf_write_timeout_typ,
-		                   1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ,
-		                   1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_typ);
-	buf += printed;
-	buf_size -= printed;
-
-		printed = snprintf(buf, buf_size, &quot;max. word write timeout: %u, max. buf write timeout: %u, max. block erase timeout: %u, max. chip erase timeout: %u\n&quot;,
-		                   (1 &lt;&lt; cfi_info-&gt;word_write_timeout_max) * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_typ),
-		  (1 &lt;&lt; cfi_info-&gt;buf_write_timeout_max) * (1 &lt;&lt; cfi_info-&gt;buf_write_timeout_typ),
-		  (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_max) * (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ),
-		  (1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_max) * (1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_typ));
-	buf += printed;
-	buf_size -= printed;
-
-		printed = snprintf(buf, buf_size, &quot;size: 0x%&quot; PRIx32 &quot;, interface desc: %i, max buffer write size: %x\n&quot;,
-		                   cfi_info-&gt;dev_size,
-		                   cfi_info-&gt;interface_desc,
-		                   1 &lt;&lt; cfi_info-&gt;max_buf_write_size);
-	buf += printed;
-	buf_size -= printed;
+		printed = snprintf(buf, buf_size, &quot;qry: '%c%c%c', pri_id: 0x%4.4x, pri_addr: &quot;
+				&quot;0x%4.4x, alt_id: 0x%4.4x, alt_addr: 0x%4.4x\n&quot;,
+				cfi_info-&gt;qry[0], cfi_info-&gt;qry[1], cfi_info-&gt;qry[2],
+				cfi_info-&gt;pri_id, cfi_info-&gt;pri_addr, cfi_info-&gt;alt_id, cfi_info-&gt;alt_addr);
+		buf += printed;
+		buf_size -= printed;
+
+		printed = snprintf(buf, buf_size, &quot;Vcc min: %x.%x, Vcc max: %x.%x, &quot;
+				&quot;Vpp min: %u.%x, Vpp max: %u.%x\n&quot;,
+				(cfi_info-&gt;vcc_min &amp; 0xf0) &gt;&gt; 4, cfi_info-&gt;vcc_min &amp; 0x0f,
+				(cfi_info-&gt;vcc_max &amp; 0xf0) &gt;&gt; 4, cfi_info-&gt;vcc_max &amp; 0x0f,
+				(cfi_info-&gt;vpp_min &amp; 0xf0) &gt;&gt; 4, cfi_info-&gt;vpp_min &amp; 0x0f,
+				(cfi_info-&gt;vpp_max &amp; 0xf0) &gt;&gt; 4, cfi_info-&gt;vpp_max &amp; 0x0f);
+		buf += printed;
+		buf_size -= printed;
+
+		printed = snprintf(buf, buf_size, &quot;typ. word write timeout: %u, &quot;
+				&quot;typ. buf write timeout: %u, typ. block erase timeout: %u, typ. chip erase timeout: %u\n&quot;,
+				1 &lt;&lt; cfi_info-&gt;word_write_timeout_typ,
+				1 &lt;&lt; cfi_info-&gt;buf_write_timeout_typ,
+				1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ,
+				1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_typ);
+		buf += printed;
+		buf_size -= printed;
+
+		printed = snprintf(buf, buf_size, &quot;max. word write timeout: %u, &quot;
+				&quot;max. buf write timeout: %u, max. block erase timeout: %u, max. chip erase timeout: %u\n&quot;,
+				(1 &lt;&lt; cfi_info-&gt;word_write_timeout_max) * (1 &lt;&lt; cfi_info-&gt;word_write_timeout_typ),
+				(1 &lt;&lt; cfi_info-&gt;buf_write_timeout_max) * (1 &lt;&lt; cfi_info-&gt;buf_write_timeout_typ),
+				(1 &lt;&lt; cfi_info-&gt;block_erase_timeout_max) * (1 &lt;&lt; cfi_info-&gt;block_erase_timeout_typ),
+				(1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_max) * (1 &lt;&lt; cfi_info-&gt;chip_erase_timeout_typ));
+		buf += printed;
+		buf_size -= printed;
+
+		printed = snprintf(buf, buf_size, &quot;size: 0x%&quot; PRIx32 &quot;, interface desc: %i, &quot;
+				&quot;max buffer write size: %x\n&quot;,
+				cfi_info-&gt;dev_size,
+				cfi_info-&gt;interface_desc,
+				1 &lt;&lt; cfi_info-&gt;max_buf_write_size);
+		buf += printed;
+		buf_size -= printed;
 
-	switch (cfi_info-&gt;pri_id)
-	{
-		case 1:
-		case 3:
-			cfi_intel_info(bank, buf, buf_size);
-			break;
-		case 2:
-			cfi_spansion_info(bank, buf, buf_size);
-			break;
-		default:
-			LOG_ERROR(&quot;cfi primary command set %i unsupported&quot;, cfi_info-&gt;pri_id);
-			break;
-	}
+		switch (cfi_info-&gt;pri_id)
+		{
+			case 1:
+			case 3:
+				cfi_intel_info(bank, buf, buf_size);
+				break;
+			case 2:
+				cfi_spansion_info(bank, buf, buf_size);
+				break;
+			default:
+				LOG_ERROR(&quot;cfi primary command set %i unsupported&quot;, cfi_info-&gt;pri_id);
+				break;
+		}
 	}
 
 	return ERROR_OK;

-----------------------------------------------------------------------

Summary of changes:
 src/flash/common.h          |    5 +-
 src/flash/nor/cfi.c         |  711 ++++++++++++++++++++++++++-----------------
 src/flash/nor/cfi.h         |    8 +-
 tcl/board/stm3210e_eval.cfg |   56 ++++
 4 files changed, 490 insertions(+), 290 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002460.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-644-gb8c42b9
</A></li>
	<LI>Next message: <A HREF="002462.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.4.0-653-gcbf48be
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2461">[ date ]</a>
              <a href="thread.html#2461">[ thread ]</a>
              <a href="subject.html#2461">[ subject ]</a>
              <a href="author.html#2461">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openocd-svn">More information about the openocd-svn
mailing list</a><br>
</body></html>
