<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-494-g4b18ef1
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openocd-svn/2009-November/index.html" >
   <LINK REL="made" HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.3.0-494-g4b18ef1&In-Reply-To=%3CE1NBFcy-00028h-Aq%40fxgxhf1.ch3.sourceforge.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001826.html">
   <LINK REL="Next"  HREF="001828.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-494-g4b18ef1</H1>
    <B>Zach Welch</B> 
    <A HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.3.0-494-g4b18ef1&In-Reply-To=%3CE1NBFcy-00028h-Aq%40fxgxhf1.ch3.sourceforge.com%3E"
       TITLE="[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-494-g4b18ef1">zwelch at users.sourceforge.net
       </A><BR>
    <I>Thu Nov 19 23:37:23 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001826.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-485-g8f446fc
</A></li>
        <LI>Next message: <A HREF="001828.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-495-g31fb778
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1827">[ date ]</a>
              <a href="thread.html#1827">[ thread ]</a>
              <a href="subject.html#1827">[ subject ]</a>
              <a href="author.html#1827">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Main OpenOCD repository&quot;.

The branch, master has been updated
       via  4b18ef15a36a8b618c18ab18d0ed8596ecf9eaaa (commit)
       via  3e1f5e7c64ea545f6e87b5fa1adb0c00358be505 (commit)
       via  664ba309d5dac2532c83fed441d14f93c7381d62 (commit)
       via  59d4466b551e89077e41b0dba21c7a95db9c7b0a (commit)
       via  2dfa5e9c844a5a3f8aaca146c874f13570b8f667 (commit)
       via  fd654c8a3e3dbd5ab97eb6b3834ee462dd509a66 (commit)
       via  dd44ae18b49f6cb54a4c361e9fab70f4d0fafeec (commit)
       via  ff25e76bad7e57da4ebd363f1b35d4af04acaa67 (commit)
       via  870b8c04557f0b7441cc502debaf537984d77e2a (commit)
      from  8f446fcf676e9cd13cf53d9946f0cae5d29a10ec (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 4b18ef15a36a8b618c18ab18d0ed8596ecf9eaaa
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Wed Nov 18 03:16:37 2009 -0800

    document new flash syntax
    
    Updates the user documentation with the new syntax for defining
    flash and nand banks.

diff --git a/doc/openocd.texi b/doc/openocd.texi
index 2767d78..0253dc0 100644
--- a/doc/openocd.texi
+++ b/doc/openocd.texi
@@ -3540,7 +3540,7 @@ board by (re)installing working boot firmware.
 @section Flash Configuration Commands
 @cindex flash configuration
 
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">- at deffn</A> {Config Command} {flash bank} driver base size chip_width bus_width target [driver_options]
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at deffn</A> {Config Command} {flash bank} name driver base size chip_width bus_width target [driver_options]
 Configures a flash bank which provides persistent storage
 for addresses from @math{base} to @math{base + size - 1}.
 These banks will often be visible to GDB through the target's memory map.
@@ -3548,6 +3548,8 @@ In some cases, configuring a flash bank will activate extra commands;
 see the driver-specific documentation.
 
 @itemize @bullet
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at item</A> @var{name} ... may be used to reference the flash bank
+in other flash commands.
 @item @var{driver} ... identifies the controller driver
 associated with the flash bank being declared.
 This is usually @code{cfi} for external flash, or else
@@ -4456,7 +4458,7 @@ NAND chips must be declared in configuration scripts,
 plus some additional configuration that's done after
 OpenOCD has initialized.
 
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">- at deffn</A> {Config Command} {nand device} controller target [configparams...]
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at deffn</A> {Config Command} {nand device} name controller target [configparams...]
 Declares a NAND device, which can be read and written to
 after it has been configured through @command{nand probe}.
 In OpenOCD, devices are single chips; this is unlike some
@@ -4470,6 +4472,8 @@ initialization has completed.  Use it in board specific
 configuration files, not interactively.
 
 @itemize @bullet
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at item</A> @var{name} ... may be used to reference the NAND bank
+in other commands.
 @item @var{controller} ... identifies the controller driver
 associated with the NAND device being declared.
 @xref{NAND Driver List}.

commit 3e1f5e7c64ea545f6e87b5fa1adb0c00358be505
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Wed Nov 18 02:19:35 2009 -0800

    update 'nand device' usage in scripts
    
    Add $_FLASHNAME variable to update 'nand device' command syntax.

diff --git a/tcl/board/dm355evm.cfg b/tcl/board/dm355evm.cfg
index 8b126fa..1f814b2 100644
--- a/tcl/board/dm355evm.cfg
+++ b/tcl/board/dm355evm.cfg
@@ -191,8 +191,10 @@ proc dm355evm_init {} {
 # you either (a) have 'new' DM355 chips, with boot ROMs that don't need to
 # use &quot;hwecc4_infix&quot; for the UBL; or else (b) aren't updating anything that
 # needs infix layout ... like an old UBL, old U-Boot, old MVL kernel, etc.
-nand device davinci $_TARGETNAME 0x02000000 hwecc4 0x01e10000
-nand device davinci $_TARGETNAME 0x02004000 hwecc4 0x01e10000
+set _FLASHNAME $_CHIPNAME.boot
+nand device $_FLASHNAME davinci $_TARGETNAME 0x02000000 hwecc4 0x01e10000
+set _FLASHNAME $_CHIPNAME.flash
+nand device $_FLASHNAME davinci $_TARGETNAME 0x02004000 hwecc4 0x01e10000
 
 # FIXME
 #  - support writing UBL with its header (new layout only with new ROMs)
diff --git a/tcl/board/openrd.cfg b/tcl/board/openrd.cfg
index a77dcdb..e8784d4 100644
--- a/tcl/board/openrd.cfg
+++ b/tcl/board/openrd.cfg
@@ -11,7 +11,8 @@ $_TARGETNAME configure \
 arm7_9 dcc_downloads enable
 
 # this assumes the hardware default peripherals location before u-Boot moves it
-nand device orion 0 0xd8000000
+set _FLASHNAME $_CHIPNAME.flash
+nand device $_FLASHNAME orion 0 0xd8000000
 
 proc openrd_init { } {
 
diff --git a/tcl/board/sheevaplug.cfg b/tcl/board/sheevaplug.cfg
index 62b78ee..afd621a 100644
--- a/tcl/board/sheevaplug.cfg
+++ b/tcl/board/sheevaplug.cfg
@@ -11,7 +11,8 @@ $_TARGETNAME configure \
 arm7_9 dcc_downloads enable
 
 # this assumes the hardware default peripherals location before u-Boot moves it
-nand device orion 0 0xd8000000
+set _FLASHNAME $_CHIPNAME.flash
+nand device $_FLASHNAME orion 0 0xd8000000
 
 proc sheevaplug_init { } {
 

commit 664ba309d5dac2532c83fed441d14f93c7381d62
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 17 14:11:24 2009 -0800

    add support for naming NAND banks
    
    Requires users to name their nand banks, allowing them to be used
    instead of bank numbers in script commands.

diff --git a/src/flash/nand.c b/src/flash/nand.c
index 70b14b0..2085028 100644
--- a/src/flash/nand.c
+++ b/src/flash/nand.c
@@ -212,7 +212,7 @@ COMMAND_HANDLER(handle_nand_list_drivers)
 	return ERROR_OK;
 }
 
-static COMMAND_HELPER(create_nand_device,
+static COMMAND_HELPER(create_nand_device, const char *bank_name,
 		struct nand_flash_controller *controller)
 {
 	int retval = controller-&gt;register_commands(CMD_CTX);
@@ -221,9 +221,9 @@ static COMMAND_HELPER(create_nand_device,
 		LOG_ERROR(&quot;couldn't register '%s' commands&quot;, controller-&gt;name);
 		return retval;
 	}
-
 	struct nand_device *c = malloc(sizeof(struct nand_device));
 
+	c-&gt;name = strdup(bank_name);
 	c-&gt;controller = controller;
 	c-&gt;controller_priv = NULL;
 	c-&gt;manufacturer = NULL;
@@ -260,6 +260,10 @@ COMMAND_HANDLER(handle_nand_device_command)
 		return ERROR_FLASH_BANK_INVALID;
 	}
 
+	// save name and increment (for compatibility) with drivers
+	const char *bank_name = *CMD_ARGV++;
+	CMD_ARGC--;
+
 	const char *driver_name = CMD_ARGV[0];
 	for (unsigned i = 0; nand_flash_controllers[i]; i++)
 	{
@@ -267,7 +271,8 @@ COMMAND_HANDLER(handle_nand_device_command)
 		if (strcmp(driver_name, controller-&gt;name) != 0)
 			continue;
 
-		return CALL_COMMAND_HANDLER(create_nand_device, controller);
+		return CALL_COMMAND_HANDLER(create_nand_device,
+				bank_name, controller);
 	}
 
 	LOG_ERROR(&quot;No valid NAND flash driver found (%s)&quot;, driver_name);
@@ -297,6 +302,8 @@ struct nand_device *get_nand_device_by_name(const char *name)
 	struct nand_device *nand;
 	for (nand = nand_devices; NULL != nand; nand = nand-&gt;next)
 	{
+		if (strcmp(nand-&gt;name, name) == 0)
+			return nand;
 		if (!flash_driver_name_matches(nand-&gt;controller-&gt;name, name))
 			continue;
 		if (++found &lt; requested)
diff --git a/src/flash/nand.h b/src/flash/nand.h
index d38ed67..af52c77 100644
--- a/src/flash/nand.h
+++ b/src/flash/nand.h
@@ -75,6 +75,7 @@ struct nand_ecclayout {
 
 struct nand_device
 {
+	char *name;
 	struct nand_flash_controller *controller;
 	void *controller_priv;
 	struct nand_manufacturer *manufacturer;

commit 59d4466b551e89077e41b0dba21c7a95db9c7b0a
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 17 15:14:03 2009 -0800

    refactor handle_nand_device_command
    
    Move bulk of for-loop to a new static command helper function.
    
    Adds handle_nand_list_drivers command handler, registered as
    'nand drivers'.
    
    Improves command help text and error reporting.

diff --git a/src/flash/nand.c b/src/flash/nand.c
index 3518056..70b14b0 100644
--- a/src/flash/nand.c
+++ b/src/flash/nand.c
@@ -204,87 +204,87 @@ static struct nand_ecclayout nand_oob_64 = {
 		 .length = 38}}
 };
 
-/* nand device &lt;nand_controller&gt; [controller options]
- */
-COMMAND_HANDLER(handle_nand_device_command)
+COMMAND_HANDLER(handle_nand_list_drivers)
 {
-	int i;
-	int retval;
+	command_print(CMD_CTX, &quot;Available NAND flash controller drivers:&quot;);
+	for (unsigned i = 0; nand_flash_controllers[i]; i++)
+		command_print(CMD_CTX, &quot;  %s&quot;, nand_flash_controllers[i]-&gt;name);
+	return ERROR_OK;
+}
 
-	if (CMD_ARGC &lt; 1)
+static COMMAND_HELPER(create_nand_device,
+		struct nand_flash_controller *controller)
+{
+	int retval = controller-&gt;register_commands(CMD_CTX);
+	if (ERROR_OK != retval)
 	{
-		LOG_WARNING(&quot;incomplete flash device nand configuration&quot;);
-		return ERROR_FLASH_BANK_INVALID;
+		LOG_ERROR(&quot;couldn't register '%s' commands&quot;, controller-&gt;name);
+		return retval;
 	}
 
-	for (i = 0; nand_flash_controllers[i]; i++)
-	{
-		struct nand_device *p, *c;
+	struct nand_device *c = malloc(sizeof(struct nand_device));
 
-		if (strcmp(CMD_ARGV[0], nand_flash_controllers[i]-&gt;name) == 0)
-		{
-			/* register flash specific commands */
-			if ((retval = nand_flash_controllers[i]-&gt;register_commands(CMD_CTX)) != ERROR_OK)
-			{
-				LOG_ERROR(&quot;couldn't register '%s' commands&quot;, CMD_ARGV[0]);
-				return retval;
-			}
+	c-&gt;controller = controller;
+	c-&gt;controller_priv = NULL;
+	c-&gt;manufacturer = NULL;
+	c-&gt;device = NULL;
+	c-&gt;bus_width = 0;
+	c-&gt;address_cycles = 0;
+	c-&gt;page_size = 0;
+	c-&gt;use_raw = 0;
+	c-&gt;next = NULL;
 
-			c = malloc(sizeof(struct nand_device));
+	retval = CALL_COMMAND_HANDLER(controller-&gt;nand_device_command, c);
+	if (ERROR_OK != retval)
+	{
+		LOG_ERROR(&quot;'%s' driver rejected nand flash&quot;, controller-&gt;name);
+		free(c);
+		return ERROR_OK;
+	}
 
-			c-&gt;controller = nand_flash_controllers[i];
-			c-&gt;controller_priv = NULL;
-			c-&gt;manufacturer = NULL;
-			c-&gt;device = NULL;
-			c-&gt;bus_width = 0;
-			c-&gt;address_cycles = 0;
-			c-&gt;page_size = 0;
-			c-&gt;use_raw = 0;
-			c-&gt;next = NULL;
+	if (nand_devices) {
+		struct nand_device *p = nand_devices;
+		while (p &amp;&amp; p-&gt;next) p = p-&gt;next;
+		p-&gt;next = c;
+	} else
+		nand_devices = c;
 
-			retval = CALL_COMMAND_HANDLER(nand_flash_controllers[i]-&gt;nand_device_command, c);
-			if (ERROR_OK != retval)
-			{
-				LOG_ERROR(&quot;'%s' driver rejected nand flash&quot;, c-&gt;controller-&gt;name);
-				free(c);
-				return ERROR_OK;
-			}
-
-			/* put NAND device in linked list */
-			if (nand_devices)
-			{
-				/* find last flash device */
-				for (p = nand_devices; p &amp;&amp; p-&gt;next; p = p-&gt;next);
-				if (p)
-					p-&gt;next = c;
-			}
-			else
-			{
-				nand_devices = c;
-			}
+	return ERROR_OK;
+}
 
-			return ERROR_OK;
-		}
+COMMAND_HANDLER(handle_nand_device_command)
+{
+	if (CMD_ARGC &lt; 1)
+	{
+		LOG_ERROR(&quot;incomplete nand device configuration&quot;);
+		return ERROR_FLASH_BANK_INVALID;
 	}
 
-	/* no valid NAND controller was found (i.e. the configuration option,
-	 * didn't match one of the compiled-in controllers)
-	 */
-	LOG_ERROR(&quot;No valid NAND flash controller found (%s)&quot;, CMD_ARGV[0]);
-	LOG_ERROR(&quot;compiled-in NAND flash controllers:&quot;);
-	for (i = 0; nand_flash_controllers[i]; i++)
+	const char *driver_name = CMD_ARGV[0];
+	for (unsigned i = 0; nand_flash_controllers[i]; i++)
 	{
-		LOG_ERROR(&quot;%i: %s&quot;, i, nand_flash_controllers[i]-&gt;name);
+		struct nand_flash_controller *controller = nand_flash_controllers[i];
+		if (strcmp(driver_name, controller-&gt;name) != 0)
+			continue;
+
+		return CALL_COMMAND_HANDLER(create_nand_device, controller);
 	}
 
-	return ERROR_OK;
+	LOG_ERROR(&quot;No valid NAND flash driver found (%s)&quot;, driver_name);
+	return CALL_COMMAND_HANDLER(handle_nand_list_drivers);
 }
 
 int nand_register_commands(struct command_context *cmd_ctx)
 {
-	nand_cmd = register_command(cmd_ctx, NULL, &quot;nand&quot;, NULL, COMMAND_ANY, &quot;NAND specific commands&quot;);
-
-	register_command(cmd_ctx, nand_cmd, &quot;device&quot;, handle_nand_device_command, COMMAND_CONFIG, NULL);
+	nand_cmd = register_command(cmd_ctx, NULL, &quot;nand&quot;,
+			NULL, COMMAND_ANY, &quot;NAND specific commands&quot;);
+
+	register_command(cmd_ctx, nand_cmd, &quot;device&quot;,
+			&amp;handle_nand_device_command, COMMAND_CONFIG,
+			&quot;defines a new NAND bank&quot;);
+	register_command(cmd_ctx, nand_cmd, &quot;drivers&quot;,
+			&amp;handle_nand_list_drivers, COMMAND_ANY,
+			&quot;lists available NAND drivers&quot;);
 
 	return ERROR_OK;
 }

commit 2dfa5e9c844a5a3f8aaca146c874f13570b8f667
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Wed Nov 18 02:15:52 2009 -0800

    update 'flash bank' usage in scripts
    
    Sets $_FLASHNAME to &quot;$_CHIPNAME.flash&quot; and passes it as the
    first argument to 'flash bank'.

diff --git a/tcl/board/balloon3-cpu.cfg b/tcl/board/balloon3-cpu.cfg
index 8a646b7..ecb1a28 100644
--- a/tcl/board/balloon3-cpu.cfg
+++ b/tcl/board/balloon3-cpu.cfg
@@ -10,4 +10,5 @@ reset_config trst_and_srst separate
 
 # flash bank &lt;driver&gt; &lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt;
 # 29LV650 64Mbit Flash
-flash bank cfi 0x00000000 0x800000 2 2 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x00000000 0x800000 2 2 0
diff --git a/tcl/board/crossbow_tech_imote2.cfg b/tcl/board/crossbow_tech_imote2.cfg
index a7d1215..88d4aa7 100644
--- a/tcl/board/crossbow_tech_imote2.cfg
+++ b/tcl/board/crossbow_tech_imote2.cfg
@@ -9,4 +9,5 @@ jtag_nsrst_delay 800
 reset_config trst_and_srst separate
 
 # works for P30 flash
-flash bank cfi 0x00000000 0x2000000 2 2 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x00000000 0x2000000 2 2 $_TARGETNAME
diff --git a/tcl/board/csb337.cfg b/tcl/board/csb337.cfg
index c2c4789..de19660 100644
--- a/tcl/board/csb337.cfg
+++ b/tcl/board/csb337.cfg
@@ -4,7 +4,8 @@
 source [find target/at91rm9200.cfg]
 
 # boots from NOR on CS0:  8 MBytes CFI flash, 16-bit bus
-flash bank cfi 0x10000000 0x00800000 2 2 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x10000000 0x00800000 2 2 $_TARGETNAME
 
 # ETM9 trace port connector present on this board, 16 data pins.
 if { [info exists ETM_DRIVER] } {
diff --git a/tcl/board/digi_connectcore_wi-9c.cfg b/tcl/board/digi_connectcore_wi-9c.cfg
index e6d17bd..3bc26ad 100644
--- a/tcl/board/digi_connectcore_wi-9c.cfg
+++ b/tcl/board/digi_connectcore_wi-9c.cfg
@@ -122,4 +122,5 @@ $_TARGETNAME configure -work-area-phys 0x00000000 -work-area-size 0x1000 -work-a
 
 #M29DW323DB - not working
 #flash bank cfi &lt;base&gt; &lt;size&gt; &lt;chip width&gt; &lt;bus width&gt; &lt;target#&gt;
-flash bank cfi 0x50000000 0x0400000 2 2 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x50000000 0x0400000 2 2 0
diff --git a/tcl/board/hammer.cfg b/tcl/board/hammer.cfg
index ed83803..d366a45 100644
--- a/tcl/board/hammer.cfg
+++ b/tcl/board/hammer.cfg
@@ -33,4 +33,5 @@ $_TARGETNAME configure -event reset-init {
 
 #flash configuration
 #flash bank &lt;driver&gt; &lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt; [driver_options ...]
-flash bank cfi 0x00000000 0x1000000 2 2 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x00000000 0x1000000 2 2 0
diff --git a/tcl/board/hitex_lpc2929.cfg b/tcl/board/hitex_lpc2929.cfg
index d0b2864..7d06f74 100644
--- a/tcl/board/hitex_lpc2929.cfg
+++ b/tcl/board/hitex_lpc2929.cfg
@@ -28,7 +28,8 @@ $_TARGETNAME configure -event reset-start {
 }
 
 # External 16-bit flash at chip select CS7 (SST39VF3201-70, 4 MiB)
-flash bank cfi 0x5C000000 0x400000 2 2 $_TARGETNAME jedec_probe
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x5C000000 0x400000 2 2 $_TARGETNAME jedec_probe
 
 
 $_TARGETNAME configure -event reset-init {
diff --git a/tcl/board/hitex_str9-comstick.cfg b/tcl/board/hitex_str9-comstick.cfg
index e7b7961..968d80e 100644
--- a/tcl/board/hitex_str9-comstick.cfg
+++ b/tcl/board/hitex_str9-comstick.cfg
@@ -68,5 +68,7 @@ $_TARGETNAME configure -event reset-init {
 $_TARGETNAME configure -work-area-phys 0x50000000 -work-area-size 16384 -work-area-backup 0
 
 #flash bank &lt;driver&gt; &lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt;
-flash bank str9x 0x00000000 0x00080000 0 0 0
-flash bank str9x 0x00080000 0x00008000 0 0 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME str9x 0x00000000 0x00080000 0 0 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME str9x 0x00080000 0x00008000 0 0 0
diff --git a/tcl/board/lubbock.cfg b/tcl/board/lubbock.cfg
index 63cc2a4..32af386 100644
--- a/tcl/board/lubbock.cfg
+++ b/tcl/board/lubbock.cfg
@@ -12,8 +12,10 @@ jtag_ntrst_delay 250
 
 # CS0, CS1 -- two banks of CFI flash, 32 MBytes each
 # each bank is 32-bits wide, two 16-bit chips in parallel
-flash bank cfi 0x00000000 0x02000000 2 4 $_TARGETNAME
-flash bank cfi 0x04000000 0x02000000 2 4 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x00000000 0x02000000 2 4 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x04000000 0x02000000 2 4 $_TARGETNAME
 
 # CS2 low -- FPGA registers
 # CS2 high -- 1 MByte SRAM at 0x0a00.0000 ... last 64K for scratch
diff --git a/tcl/board/omap2420_h4.cfg b/tcl/board/omap2420_h4.cfg
index c2190b5..12efa05 100644
--- a/tcl/board/omap2420_h4.cfg
+++ b/tcl/board/omap2420_h4.cfg
@@ -8,5 +8,7 @@ reset_config trst_and_srst separate
 # Board configs can vary a *LOT* ... parts, jumpers, etc.
 # This GP board boots from cs0 using NOR (2x32M), and also
 # has 64M NAND on cs6.
-flash bank cfi 0x04000000 0x02000000 2 2 $_TARGETNAME
-flash bank cfi 0x06000000 0x02000000 2 2 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x04000000 0x02000000 2 2 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x06000000 0x02000000 2 2 $_TARGETNAME
diff --git a/tcl/board/osk5912.cfg b/tcl/board/osk5912.cfg
index d78c6ef..c33ae28 100644
--- a/tcl/board/osk5912.cfg
+++ b/tcl/board/osk5912.cfg
@@ -19,8 +19,10 @@ etm_dummy config $_TARGETNAME
 
 # standard boards populate two 16 MB chips, but manufacturing
 # options or an expansion board could change this config.
-flash bank cfi 0x00000000 0x01000000 2 2 $_TARGETNAME
-flash bank cfi 0x01000000 0x01000000 2 2 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x00000000 0x01000000 2 2 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x01000000 0x01000000 2 2 $_TARGETNAME
 
 proc osk5912_init {} {
 	omap5912_reset
diff --git a/tcl/board/pxa255_sst.cfg b/tcl/board/pxa255_sst.cfg
index 8bc691b..ce90387 100644
--- a/tcl/board/pxa255_sst.cfg
+++ b/tcl/board/pxa255_sst.cfg
@@ -13,7 +13,8 @@ source [find target/pxa255.cfg]
 $_TARGETNAME configure -work-area-phys 0x4000000 -work-area-size 0x4000 -work-area-backup 0
 
 # flash bank &lt;driver&gt; &lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt; &lt;target&gt; [options]
-flash bank cfi 0x00000000 0x80000 2 2 $_TARGETNAME jedec_probe
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x00000000 0x80000 2 2 $_TARGETNAME jedec_probe
 
 proc pxa255_sst_init {} {
 	xscale cp15   15      0x00002001  #Enable CP0 and CP13 access
diff --git a/tcl/board/str910-eval.cfg b/tcl/board/str910-eval.cfg
index fa872a9..0cf794a 100644
--- a/tcl/board/str910-eval.cfg
+++ b/tcl/board/str910-eval.cfg
@@ -54,8 +54,10 @@ $_TARGETNAME configure -event reset-init {
 }
 
 #flash bank str9x &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt; &lt;variant&gt;
-flash bank str9x 0x00000000 0x00080000 0 0 0
-flash bank str9x 0x00080000 0x00008000 0 0 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME str9x 0x00000000 0x00080000 0 0 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME str9x 0x00080000 0x00008000 0 0 0
 
 # For more information about the configuration files, take a look at:
 # openocd.texi
diff --git a/tcl/board/telo.cfg b/tcl/board/telo.cfg
index c4e5d67..0cbdb81 100644
--- a/tcl/board/telo.cfg
+++ b/tcl/board/telo.cfg
@@ -54,7 +54,8 @@ proc srst_deasserted {} { puts &quot;Sensed nSRST deasserted. No action.&quot; }
 # boots from NOR on CS0:  8 MBytes CFI flash, 16-bit bus
 # it's really 16MB but the upper 8mb is controller via gpio
 # openocd does not support 'complex reads/writes' to NOR
-flash bank cfi 0x20000000 0x01000000 2 2 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x20000000 0x01000000 2 2 $_TARGETNAME
 
 # writing data to memory does not work without this
 memwrite burst disable
\ No newline at end of file
diff --git a/tcl/board/topas910.cfg b/tcl/board/topas910.cfg
index ce7c87a..ae72c4b 100644
--- a/tcl/board/topas910.cfg
+++ b/tcl/board/topas910.cfg
@@ -115,4 +115,5 @@ arm7_9 dcc_downloads enable       # Enable faster DCC downloads
 #####################
 
 #flash bank cfi &lt;base&gt; &lt;size&gt; &lt;chip width&gt; &lt;bus width&gt; &lt;target#&gt;
-flash bank cfi 0x20000000 0x2000000 2 2 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x20000000 0x2000000 2 2 0
diff --git a/tcl/board/topasa900.cfg b/tcl/board/topasa900.cfg
index a8a6caf..5984f81 100644
--- a/tcl/board/topasa900.cfg
+++ b/tcl/board/topasa900.cfg
@@ -121,5 +121,6 @@ arm7_9 dcc_downloads enable       # Enable faster DCC downloads
 #####################
 
 #flash bank cfi &lt;base&gt; &lt;size&gt; &lt;chip width&gt; &lt;bus width&gt; &lt;target#&gt;
-flash bank cfi 0x20000000 0x1000000 2 2 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x20000000 0x1000000 2 2 0
 
diff --git a/tcl/board/unknown_at91sam9260.cfg b/tcl/board/unknown_at91sam9260.cfg
index 2abd367..ad7b13c 100644
--- a/tcl/board/unknown_at91sam9260.cfg
+++ b/tcl/board/unknown_at91sam9260.cfg
@@ -91,6 +91,7 @@ $_TARGETNAME configure -event reset-init {
 #####################
 
 #flash bank cfi &lt;base&gt; &lt;size&gt; &lt;chip width&gt; &lt;bus width&gt; &lt;target#&gt;
-flash bank cfi 0x10000000 0x01000000 2 2 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x10000000 0x01000000 2 2 0
 
 
diff --git a/tcl/board/x300t.cfg b/tcl/board/x300t.cfg
index 3b09493..d914180 100644
--- a/tcl/board/x300t.cfg
+++ b/tcl/board/x300t.cfg
@@ -8,7 +8,8 @@ $_TARGETNAME configure -event reset-init { x300t_init }
 
 # 1MB CFI capable flash
 # flash bank &lt;driver&gt; &lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt;
-flash bank cfi 0xac000000 0x100000 2 2 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0xac000000 0x100000 2 2 0
 
 proc x300t_init { } {
 	# Setup SDRAM config and flash mapping
diff --git a/tcl/board/zy1000.cfg b/tcl/board/zy1000.cfg
index 54bb7bb..3f526d0 100644
--- a/tcl/board/zy1000.cfg
+++ b/tcl/board/zy1000.cfg
@@ -38,7 +38,8 @@ target create $_TARGETNAME arm7tdmi -endian $_ENDIAN -chain-position $_TARGETNAM
 arm7_9 fast_memory_access enable
 arm7_9 dcc_downloads enable
 
-flash bank ecosflash 0x01000000 0x200000 2 2 $_TARGETNAME ecos/at91eb40a.elf
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME ecosflash 0x01000000 0x200000 2 2 $_TARGETNAME ecos/at91eb40a.elf
 $_TARGETNAME configure -event reset-init {
 	# Set up chip selects &amp; timings
 	mww 0xFFE00000 0x0100273D
diff --git a/tcl/target/aduc702x.cfg b/tcl/target/aduc702x.cfg
index b60c967..58cc9b9 100644
--- a/tcl/target/aduc702x.cfg
+++ b/tcl/target/aduc702x.cfg
@@ -35,7 +35,8 @@ $_TARGETNAME configure -work-area-phys 0x10000 -work-area-size 0x2000
 
 ## flash configuration
 # only target number is needed
-flash bank aduc702x 0 0 0 0 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME aduc702x 0 0 0 0 0
 
 ## If you use the watchdog, the following code makes sure that the board
 ## doesn't reboot when halted via JTAG.  Yes, on the older generation
diff --git a/tcl/target/at91eb40a.cfg b/tcl/target/at91eb40a.cfg
index 8b3a9ec..e78ccea 100644
--- a/tcl/target/at91eb40a.cfg
+++ b/tcl/target/at91eb40a.cfg
@@ -42,7 +42,8 @@ arm7_9 fast_memory_access enable
 arm7_9 dcc_downloads enable
 
 #flash driver
-flash bank ecosflash 0x01000000 0x200000 2 2 0 ecos/at91eb40a.elf
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME ecosflash 0x01000000 0x200000 2 2 0 ecos/at91eb40a.elf
 
 # required for usable performance. Used for lots of
 # other things than flash programming.
diff --git a/tcl/target/at91r40008.cfg b/tcl/target/at91r40008.cfg
index e8710f7..9069ae5 100644
--- a/tcl/target/at91r40008.cfg
+++ b/tcl/target/at91r40008.cfg
@@ -45,7 +45,8 @@ $_TARGETNAME configure -event gdb-flash-erase-start {
 
 $_TARGETNAME configure -work-area-phys 0x3C000 -work-area-size 0x4000 -work-area-backup 0
 
-flash bank cfi 0x10000000 0x400000 2 2 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x10000000 0x400000 2 2 $_TARGETNAME
 
 # For more information about the configuration files, take a look at:
 # openocd.texi
diff --git a/tcl/target/at91sam3u1c.cfg b/tcl/target/at91sam3u1c.cfg
index d338f30..47c227b 100644
--- a/tcl/target/at91sam3u1c.cfg
+++ b/tcl/target/at91sam3u1c.cfg
@@ -2,6 +2,7 @@
 source [find target/at91sam3uxx.cfg]
 
 # size is automatically &quot;calculated&quot; by probing
-flash bank at91sam3 0x000080000 0 1 1 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME at91sam3 0x000080000 0 1 1 $_TARGETNAME
 
 
diff --git a/tcl/target/at91sam3u1e.cfg b/tcl/target/at91sam3u1e.cfg
index d338f30..47c227b 100644
--- a/tcl/target/at91sam3u1e.cfg
+++ b/tcl/target/at91sam3u1e.cfg
@@ -2,6 +2,7 @@
 source [find target/at91sam3uxx.cfg]
 
 # size is automatically &quot;calculated&quot; by probing
-flash bank at91sam3 0x000080000 0 1 1 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME at91sam3 0x000080000 0 1 1 $_TARGETNAME
 
 
diff --git a/tcl/target/at91sam3u2c.cfg b/tcl/target/at91sam3u2c.cfg
index d338f30..47c227b 100644
--- a/tcl/target/at91sam3u2c.cfg
+++ b/tcl/target/at91sam3u2c.cfg
@@ -2,6 +2,7 @@
 source [find target/at91sam3uxx.cfg]
 
 # size is automatically &quot;calculated&quot; by probing
-flash bank at91sam3 0x000080000 0 1 1 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME at91sam3 0x000080000 0 1 1 $_TARGETNAME
 
 
diff --git a/tcl/target/at91sam3u2e.cfg b/tcl/target/at91sam3u2e.cfg
index d338f30..47c227b 100644
--- a/tcl/target/at91sam3u2e.cfg
+++ b/tcl/target/at91sam3u2e.cfg
@@ -2,6 +2,7 @@
 source [find target/at91sam3uxx.cfg]
 
 # size is automatically &quot;calculated&quot; by probing
-flash bank at91sam3 0x000080000 0 1 1 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME at91sam3 0x000080000 0 1 1 $_TARGETNAME
 
 
diff --git a/tcl/target/at91sam3u4c.cfg b/tcl/target/at91sam3u4c.cfg
index e8fdaba..e281287 100644
--- a/tcl/target/at91sam3u4c.cfg
+++ b/tcl/target/at91sam3u4c.cfg
@@ -2,8 +2,10 @@
 source [find target/at91sam3uxx.cfg]
 
 # size is automatically &quot;calculated&quot; by probing
-flash bank at91sam3 0x000080000 0 1 1 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME at91sam3 0x000080000 0 1 1 $_TARGETNAME
 # This is a 256K chip, it has the 2nd bank
-flash bank at91sam3 0x000100000 0 1 1 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME at91sam3 0x000100000 0 1 1 $_TARGETNAME
 
 
diff --git a/tcl/target/at91sam3u4e.cfg b/tcl/target/at91sam3u4e.cfg
index 9477ad0..242b53e 100644
--- a/tcl/target/at91sam3u4e.cfg
+++ b/tcl/target/at91sam3u4e.cfg
@@ -2,8 +2,10 @@
 source [find target/at91sam3uxx.cfg]
 
 # size is automatically &quot;calculated&quot; by probing
-flash bank at91sam3 0x000080000 0 1 1 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME at91sam3 0x000080000 0 1 1 $_TARGETNAME
 # This is a 256K chip - it has the 2nd bank
-flash bank at91sam3 0x000100000 0 1 1 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME at91sam3 0x000100000 0 1 1 $_TARGETNAME
 
 
diff --git a/tcl/target/at91sam7sx.cfg b/tcl/target/at91sam7sx.cfg
index 2a7f90c..f3cc88e 100644
--- a/tcl/target/at91sam7sx.cfg
+++ b/tcl/target/at91sam7sx.cfg
@@ -49,7 +49,8 @@ $_TARGETNAME configure -event reset-init {
 $_TARGETNAME configure -work-area-phys 0x00200000 -work-area-size 0x4000 -work-area-backup 0
 
 #flash bank &lt;driver&gt; &lt;base_addr&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt; &lt;target_number&gt; [&lt;target_name&gt; &lt;banks&gt; &lt;sectors_per_bank&gt; &lt;pages_per_sector&gt; &lt;page_size&gt; &lt;num_nvmbits&gt; &lt;ext_freq_khz&gt;]
-flash bank at91sam7 0 0 0 0 0 0 0 0 0 0 0 0 18432
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME at91sam7 0 0 0 0 0 0 0 0 0 0 0 0 18432
 
 # For more information about the configuration files, take a look at:
 # openocd.texi
diff --git a/tcl/target/at91sam9260_ext_RAM_ext_flash.cfg b/tcl/target/at91sam9260_ext_RAM_ext_flash.cfg
index de7e9ab..690406b 100644
--- a/tcl/target/at91sam9260_ext_RAM_ext_flash.cfg
+++ b/tcl/target/at91sam9260_ext_RAM_ext_flash.cfg
@@ -55,7 +55,8 @@ $_TARGETNAME configure -event reset-deassert-post {at91sam_init}
 
 # Flash configuration
 #flash bank cfi &lt;base&gt; &lt;size&gt; &lt;chip width&gt; &lt;bus width&gt; &lt;target#&gt;
-flash bank cfi 0x10000000 0x01000000 2 2 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x10000000 0x01000000 2 2 $_TARGETNAME
 
 
 proc at91sam_init { } {
diff --git a/tcl/target/epc9301.cfg b/tcl/target/epc9301.cfg
index eaf4ee9..7e4599d 100644
--- a/tcl/target/epc9301.cfg
+++ b/tcl/target/epc9301.cfg
@@ -28,4 +28,5 @@ target create $_TARGETNAME arm920t -endian $_ENDIAN -chain-position $_TARGETNAME
 
 #flash configuration
 #flash bank &lt;driver&gt; &lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt; [driver_options ...]
-flash bank cfi 0x60000000 0x1000000 2 2 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x60000000 0x1000000 2 2 $_TARGETNAME
diff --git a/tcl/target/faux.cfg b/tcl/target/faux.cfg
index cc09ee3..6fe0cd7 100644
--- a/tcl/target/faux.cfg
+++ b/tcl/target/faux.cfg
@@ -26,4 +26,5 @@ set _TARGETNAME $_CHIPNAME.cpu
 target create $_TARGETNAME arm7tdmi -endian $_ENDIAN -chain-position $_TARGETNAME -variant arm7tdmi-s_r4
 
 #dummy flash driver
-flash bank faux 0x01000000 0x200000 2 2 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME faux 0x01000000 0x200000 2 2 0
diff --git a/tcl/target/lm3s1968.cfg b/tcl/target/lm3s1968.cfg
index e54bbfe..330bb56 100644
--- a/tcl/target/lm3s1968.cfg
+++ b/tcl/target/lm3s1968.cfg
@@ -25,4 +25,5 @@ target create $_TARGETNAME cortex_m3 -chain-position $_CHIPNAME.cpu -variant lm3
 $_TARGETNAME configure -work-area-phys 0x20000000 -work-area-size 0x2000
 
 #flash configuration
-flash bank stellaris 0 0 0 0 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME stellaris 0 0 0 0 $_TARGETNAME
diff --git a/tcl/target/lm3s3748.cfg b/tcl/target/lm3s3748.cfg
index 5317a6d..274377a 100644
--- a/tcl/target/lm3s3748.cfg
+++ b/tcl/target/lm3s3748.cfg
@@ -25,4 +25,5 @@ target create $_TARGETNAME cortex_m3 -chain-position $_CHIPNAME.cpu -variant lm3
 $_TARGETNAME configure -work-area-phys 0x20000000 -work-area-size 0x2000
 
 # flash configuration -- one bank of 128K
-flash bank stellaris 0 0 0 0 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME stellaris 0 0 0 0 $_TARGETNAME
diff --git a/tcl/target/lm3s6965.cfg b/tcl/target/lm3s6965.cfg
index f0eb6b0..02d85d4 100644
--- a/tcl/target/lm3s6965.cfg
+++ b/tcl/target/lm3s6965.cfg
@@ -34,4 +34,5 @@ target create $_TARGETNAME cortex_m3 -chain-position $_CHIPNAME.cpu -variant lm3
 $_TARGETNAME configure -work-area-phys 0x20000000 -work-area-size 0x2000
 
 #flash configuration
-flash bank stellaris 0 0 0 0 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME stellaris 0 0 0 0 $_TARGETNAME
diff --git a/tcl/target/lm3s811.cfg b/tcl/target/lm3s811.cfg
index 8210696..49879d0 100644
--- a/tcl/target/lm3s811.cfg
+++ b/tcl/target/lm3s811.cfg
@@ -25,4 +25,5 @@ target create $_TARGETNAME cortex_m3 -chain-position $_CHIPNAME.cpu -variant lm3
 $_TARGETNAME configure -work-area-phys 0x20000000 -work-area-size 0x2000
 
 #flash configuration
-flash bank stellaris 0 0 0 0 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME stellaris 0 0 0 0 $_TARGETNAME
diff --git a/tcl/target/lm3s9b9x.cfg b/tcl/target/lm3s9b9x.cfg
index e822bb2..a727251 100644
--- a/tcl/target/lm3s9b9x.cfg
+++ b/tcl/target/lm3s9b9x.cfg
@@ -29,4 +29,5 @@ target create $_TARGETNAME cortex_m3 -chain-position $_CHIPNAME.cpu -variant lm3
 $_TARGETNAME configure -work-area-phys 0x20000000 -work-area-size 0x4000
 
 #flash configuration
-flash bank stellaris 0 0 0 0 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME stellaris 0 0 0 0 $_TARGETNAME
diff --git a/tcl/target/lpc1768.cfg b/tcl/target/lpc1768.cfg
index 0b07d51..9a813f5 100644
--- a/tcl/target/lpc1768.cfg
+++ b/tcl/target/lpc1768.cfg
@@ -44,7 +44,8 @@ $_TARGETNAME configure -event reset-init {
 # LPC1768 has 512kB of user-available FLASH (bootloader is located in separate dedicated region).
 # flash bank lpc1700 &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt; &lt;variant&gt; &lt;cclk&gt; [calc_checksum]
 
-flash bank lpc2000 0x0 0x80000 0 0 $_TARGETNAME lpc1700 12000 calc_checksum
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME lpc2000 0x0 0x80000 0 0 $_TARGETNAME lpc1700 12000 calc_checksum
 
 # 4MHz / 6 = 666kHz, so use 500
 jtag_khz 500
diff --git a/tcl/target/lpc2103.cfg b/tcl/target/lpc2103.cfg
index 0aadee8..13535f5 100644
--- a/tcl/target/lpc2103.cfg
+++ b/tcl/target/lpc2103.cfg
@@ -35,4 +35,5 @@ $_TARGETNAME configure -work-area-phys 0x40000000 -work-area-size 0x2000 -work-a
 
 # 32kB of internal Flash, core clocked with 12MHz crystal
 # flash bank lpc2000 &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt; &lt;variant&gt; &lt;clock&gt; [calc_checksum]
-flash bank lpc2000 0x0 0x8000 0 0 $_TARGETNAME lpc2000_v2 12000 calc_checksum
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME lpc2000 0x0 0x8000 0 0 $_TARGETNAME lpc2000_v2 12000 calc_checksum
diff --git a/tcl/target/lpc2124.cfg b/tcl/target/lpc2124.cfg
index 471286b..9a27aec 100644
--- a/tcl/target/lpc2124.cfg
+++ b/tcl/target/lpc2124.cfg
@@ -39,4 +39,5 @@ $_TARGETNAME configure -work-area-phys 0x40000000 -work-area-size 0x4000 -work-a
 
 
 #flash bank &lt;driver&gt; &lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt;
-flash bank lpc2000 0x0 0x40000 0 0 $_TARGETNAME lpc2000_v1 14745 calc_checksum
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME lpc2000 0x0 0x40000 0 0 $_TARGETNAME lpc2000_v1 14745 calc_checksum
diff --git a/tcl/target/lpc2129.cfg b/tcl/target/lpc2129.cfg
index a686a47..287fa5d 100644
--- a/tcl/target/lpc2129.cfg
+++ b/tcl/target/lpc2129.cfg
@@ -38,4 +38,5 @@ target create $_TARGETNAME arm7tdmi -endian $_ENDIAN -chain-position $_TARGETNAM
 $_TARGETNAME configure -work-area-phys 0x40000000 -work-area-size 0x4000 -work-area-backup 0
 
 #flash bank &lt;driver&gt; &lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt;
-flash bank lpc2000 0x0 0x40000 0 0 $_TARGETNAME lpc2000_v1 14765 calc_checksum
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME lpc2000 0x0 0x40000 0 0 $_TARGETNAME lpc2000_v1 14765 calc_checksum
diff --git a/tcl/target/lpc2148.cfg b/tcl/target/lpc2148.cfg
index 1f833e7..cf6287c 100644
--- a/tcl/target/lpc2148.cfg
+++ b/tcl/target/lpc2148.cfg
@@ -52,4 +52,5 @@ $_TARGETNAME configure -event reset-init {
 }
 
 # flash bank lpc2000 &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt; &lt;variant&gt; &lt;clock&gt; [calc_checksum]
-flash bank lpc2000 0x0 0x7d000 0 0 $_TARGETNAME lpc2000_v2 14765 calc_checksum
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME lpc2000 0x0 0x7d000 0 0 $_TARGETNAME lpc2000_v2 14765 calc_checksum
diff --git a/tcl/target/lpc2294.cfg b/tcl/target/lpc2294.cfg
index a34940e..d43d740 100644
--- a/tcl/target/lpc2294.cfg
+++ b/tcl/target/lpc2294.cfg
@@ -32,7 +32,8 @@ $_TARGETNAME configure -work-area-phys 0x40000000 -work-area-size 0x4000 -work-a
 
 #flash configuration
 #flash bank lpc2000 &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt; &lt;variant&gt;
-flash bank lpc2000 0x0 0x40000 0 0 $_TARGETNAME lpc2000_v1 14765 calc_checksum
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME lpc2000 0x0 0x40000 0 0 $_TARGETNAME lpc2000_v1 14765 calc_checksum
 
 # For more information about the configuration files, take a look at:
 # openocd.texi
diff --git a/tcl/target/lpc2378.cfg b/tcl/target/lpc2378.cfg
index aa3fad2..4e50ac5 100644
--- a/tcl/target/lpc2378.cfg
+++ b/tcl/target/lpc2378.cfg
@@ -43,7 +43,8 @@ $_TARGETNAME configure -event reset-init {
 # LPC2378 has 512kB of FLASH, but upper 8kB are occupied by bootloader.
 # After reset the chip uses its internal 4MHz RC oscillator
 #flash bank lpc2000 &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt; &lt;variant&gt;
-flash bank lpc2000 0x0 0x0007D000 0 0 $_TARGETNAME lpc2000_v2 4000 calc_checksum
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME lpc2000 0x0 0x0007D000 0 0 $_TARGETNAME lpc2000_v2 4000 calc_checksum
 
 # 4MHz / 6 = 666kHz, so use 500
 jtag_khz 500
diff --git a/tcl/target/lpc2478.cfg b/tcl/target/lpc2478.cfg
index b0af4c0..d0bff1a 100644
--- a/tcl/target/lpc2478.cfg
+++ b/tcl/target/lpc2478.cfg
@@ -43,7 +43,8 @@ $_TARGETNAME configure -event reset-init {
 # LPC2378 has 512kB of FLASH, but upper 8kB are occupied by bootloader.
 # After reset the chip uses its internal 4MHz RC oscillator.
 # flash bank lpc2000 &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt; &lt;variant&gt; &lt;clock&gt; [calc checksum]
-flash bank lpc2000 0x0 0x7D000 0 0 $_TARGETNAME lpc2000_v2 12000 calc_checksum
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME lpc2000 0x0 0x7D000 0 0 $_TARGETNAME lpc2000_v2 12000 calc_checksum
 
 # Try to use RCLK, if RCLK is not available use &quot;normal&quot; mode. 4MHz / 6 = 666kHz, so use 500.
 jtag_rclk 500
diff --git a/tcl/target/lpc2900.cfg b/tcl/target/lpc2900.cfg
index fa5bd5b..2371dd7 100644
--- a/tcl/target/lpc2900.cfg
+++ b/tcl/target/lpc2900.cfg
@@ -62,4 +62,5 @@ arm7_9 dcc_downloads enable
 # Flash bank configuration:
 # Flash:   flash bank lpc2900 0 0 0 0 &lt;target#&gt; &lt;flash clock (CLK_SYS_FMC) in kHz&gt;
 # Flash base address, total flash size, and number of sectors are all configured automatically.
-flash bank lpc2900         0 0 0 0 $_TARGETNAME $FLASH_CLOCK
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME lpc2900         0 0 0 0 $_TARGETNAME $FLASH_CLOCK
diff --git a/tcl/target/mega128.cfg b/tcl/target/mega128.cfg
index e444889..2bc2294 100644
--- a/tcl/target/mega128.cfg
+++ b/tcl/target/mega128.cfg
@@ -22,7 +22,8 @@ target create $_TARGETNAME avr -endian $_ENDIAN -chain-position $_TARGETNAME
 
 #$_TARGETNAME configure -work-area-phys 0x20000000 -work-area-size 16384 -work-area-backup 0
 
-flash bank avr 0 0 0 0 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME avr 0 0 0 0 0
 
 #to use it, script will be like:
 #init
diff --git a/tcl/target/pic32mx.cfg b/tcl/target/pic32mx.cfg
index 6127a54..a346c47 100644
--- a/tcl/target/pic32mx.cfg
+++ b/tcl/target/pic32mx.cfg
@@ -33,8 +33,10 @@ target create $_TARGETNAME mips_m4k -endian $_ENDIAN -chain-position $_TARGETNAM
 
 $_TARGETNAME configure -work-area-phys 0xa0000000 -work-area-size 16384 -work-area-backup 0
 
-flash bank pic32mx 0xbd000000 0 0 0 0
-flash bank pic32mx 0xbfc00000 0 0 0 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME pic32mx 0xbd000000 0 0 0 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME pic32mx 0xbfc00000 0 0 0 0
 
 # For more information about the configuration files, take a look at:
 # openocd.texi
diff --git a/tcl/target/sam7se512.cfg b/tcl/target/sam7se512.cfg
index 0f1e412..d255067 100644
--- a/tcl/target/sam7se512.cfg
+++ b/tcl/target/sam7se512.cfg
@@ -35,5 +35,6 @@ target create $_TARGETNAME arm7tdmi -endian $_ENDIAN -chain-position $_TARGETNAM
 $_TARGETNAME configure -work-area-phys 0x00200000 -work-area-size 0x4000 -work-area-backup 0
 
 #flash bank &lt;driver&gt; &lt;base_addr&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt; &lt;target_number&gt; [&lt;target_name&gt; &lt;banks&gt; &lt;sectors_per_bank&gt; &lt;pages_per_sector&gt; &lt;page_size&gt; &lt;num_nvmbits&gt; &lt;ext_freq_khz&gt;]
-flash bank at91sam7 0 0 0 0 0 0 0 0 0 0 0 0 18432
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME at91sam7 0 0 0 0 0 0 0 0 0 0 0 0 18432
 
diff --git a/tcl/target/sam7x256.cfg b/tcl/target/sam7x256.cfg
index c3f7cd9..5bab642 100644
--- a/tcl/target/sam7x256.cfg
+++ b/tcl/target/sam7x256.cfg
@@ -46,7 +46,8 @@ $_TARGETNAME configure -event reset-init {
 $_TARGETNAME configure -work-area-phys 0x00200000 -work-area-size 0x4000 -work-area-backup 0
 
 #flash bank &lt;driver&gt; &lt;base_addr&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt; &lt;target_number&gt; [&lt;target_name&gt; &lt;banks&gt; &lt;sectors_per_bank&gt; &lt;pages_per_sector&gt; &lt;page_size&gt; &lt;num_nvmbits&gt; &lt;ext_freq_khz&gt;]
-flash bank at91sam7 0 0 0 0 0 0 0 0 0 0 0 0 18432
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME at91sam7 0 0 0 0 0 0 0 0 0 0 0 0 18432
 
 # For more information about the configuration files, take a look at:
 # openocd.texi
diff --git a/tcl/target/smdk6410.cfg b/tcl/target/smdk6410.cfg
index 7f15f8b..dd8bf87 100644
--- a/tcl/target/smdk6410.cfg
+++ b/tcl/target/smdk6410.cfg
@@ -5,4 +5,5 @@
 
 source [find target/samsung_s3c6410.cfg]
 
-flash bank cfi 0x00000000 0x00100000 2 2 $_TARGETNAME jedec_probe
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x00000000 0x00100000 2 2 $_TARGETNAME jedec_probe
diff --git a/tcl/target/stm32.cfg b/tcl/target/stm32.cfg
index 242bbbe..463a85c 100644
--- a/tcl/target/stm32.cfg
+++ b/tcl/target/stm32.cfg
@@ -62,7 +62,8 @@ target create $_TARGETNAME cortex_m3 -endian $_ENDIAN -chain-position $_TARGETNA
 
 $_TARGETNAME configure -work-area-phys 0x20000000 -work-area-size $_WORKAREASIZE -work-area-backup 0
 
-flash bank stm32x 0 0 0 0 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME stm32x 0 0 0 0 $_TARGETNAME
 
 # For more information about the configuration files, take a look at:
 # openocd.texi
diff --git a/tcl/target/str710.cfg b/tcl/target/str710.cfg
index 8e5d36f..395a26c 100644
--- a/tcl/target/str710.cfg
+++ b/tcl/target/str710.cfg
@@ -39,8 +39,10 @@ $_TARGETNAME configure -event gdb-flash-erase-start {
 $_TARGETNAME configure -work-area-phys 0x2000C000 -work-area-size 0x4000 -work-area-backup 0
 
 #flash bank str7x &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt; &lt;variant&gt;
-flash bank str7x 0x40000000 0x00040000 0 0 0 STR71x
-flash bank str7x 0x400C0000 0x00004000 0 0 0 STR71x
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME str7x 0x40000000 0x00040000 0 0 0 STR71x
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME str7x 0x400C0000 0x00004000 0 0 0 STR71x
 
 # For more information about the configuration files, take a look at:
 # openocd.texi
diff --git a/tcl/target/str730.cfg b/tcl/target/str730.cfg
index c98d56c..6432d15 100644
--- a/tcl/target/str730.cfg
+++ b/tcl/target/str730.cfg
@@ -42,5 +42,6 @@ $_TARGETNAME configure -event gdb-flash-erase-start {
 $_TARGETNAME configure -work-area-phys 0x40000000 -work-area-size 0x4000 -work-area-backup 0
 
 #flash bank &lt;driver&gt; &lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt;
-flash bank str7x 0x20000000 0x00040000 0 0 0 STR3x
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME str7x 0x20000000 0x00040000 0 0 0 STR3x
 
diff --git a/tcl/target/str750.cfg b/tcl/target/str750.cfg
index 5439c33..496c4e3 100644
--- a/tcl/target/str750.cfg
+++ b/tcl/target/str750.cfg
@@ -45,6 +45,8 @@ $_TARGETNAME configure -event gdb-flash-erase-start {
 $_TARGETNAME configure -work-area-phys 0x40000000 -work-area-size 0x4000 -work-area-backup 0
 
 #flash bank &lt;driver&gt; &lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt;
-flash bank str7x 0x20000000 0x00040000 0 0 0 STR75x
-flash bank str7x 0x200C0000 0x00004000 0 0 0 STR75x
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME str7x 0x20000000 0x00040000 0 0 0 STR75x
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME str7x 0x200C0000 0x00004000 0 0 0 STR75x
 
diff --git a/tcl/target/str912.cfg b/tcl/target/str912.cfg
index 0dd6848..d844584 100644
--- a/tcl/target/str912.cfg
+++ b/tcl/target/str912.cfg
@@ -63,8 +63,10 @@ $_TARGETNAME configure -event reset-init {
 $_TARGETNAME configure -work-area-phys 0x50000000 -work-area-size 16384 -work-area-backup 0
 
 #flash bank str9x &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt; &lt;variant&gt;
-flash bank str9x 0x00000000 0x00080000 0 0 0
-flash bank str9x 0x00080000 0x00008000 0 0 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME str9x 0x00000000 0x00080000 0 0 0
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME str9x 0x00080000 0x00008000 0 0 0
 
 # For more information about the configuration files, take a look at:
 # openocd.texi
diff --git a/tcl/target/telo.cfg b/tcl/target/telo.cfg
index c4e5d67..0cbdb81 100644
--- a/tcl/target/telo.cfg
+++ b/tcl/target/telo.cfg
@@ -54,7 +54,8 @@ proc srst_deasserted {} { puts &quot;Sensed nSRST deasserted. No action.&quot; }
 # boots from NOR on CS0:  8 MBytes CFI flash, 16-bit bus
 # it's really 16MB but the upper 8mb is controller via gpio
 # openocd does not support 'complex reads/writes' to NOR
-flash bank cfi 0x20000000 0x01000000 2 2 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x20000000 0x01000000 2 2 $_TARGETNAME
 
 # writing data to memory does not work without this
 memwrite burst disable
\ No newline at end of file
diff --git a/tcl/target/xba_revA3.cfg b/tcl/target/xba_revA3.cfg
index 9d258a5..fb02c68 100644
--- a/tcl/target/xba_revA3.cfg
+++ b/tcl/target/xba_revA3.cfg
@@ -79,7 +79,8 @@ $_TARGETNAME configure -event reset-init {
 $_TARGETNAME configure -work-area-phys 0x20010000 -work-area-size 0x8060 -work-area-backup 0
 
 
-flash bank cfi 0x50000000 0x400000 2 2 $_TARGETNAME
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME cfi 0x50000000 0x400000 2 2 $_TARGETNAME
 
 init
 reset init
diff --git a/tcl/test/syntax1.cfg b/tcl/test/syntax1.cfg
index 40a7c1d..c3d8ed9 100644
--- a/tcl/test/syntax1.cfg
+++ b/tcl/test/syntax1.cfg
@@ -25,5 +25,6 @@ mvb 0xE01FC040 0x01
 
 
 
-flash bank lpc2000 0x0 0x7d000 0 0 0 lpc2000_v2 14765
+set _FLASHNAME $_CHIPNAME.flash
+flash bank $_FLASHNAME lpc2000 0x0 0x7d000 0 0 0 lpc2000_v2 14765
 

commit fd654c8a3e3dbd5ab97eb6b3834ee462dd509a66
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 17 14:04:25 2009 -0800

    add support for naming flash banks
    
    Requires users to name their flash banks, allowing them to be used
    instead of bank numbers in script commands.

diff --git a/src/flash/flash.c b/src/flash/flash.c
index e93aa63..ef6c6da 100644
--- a/src/flash/flash.c
+++ b/src/flash/flash.c
@@ -189,6 +189,8 @@ struct flash_bank *get_flash_bank_by_name(const char *name)
 	struct flash_bank *bank;
 	for (bank = flash_banks; NULL != bank; bank = bank-&gt;next)
 	{
+		if (strcmp(bank-&gt;name, name) == 0)
+			return bank;
 		if (!flash_driver_name_matches(bank-&gt;driver-&gt;name, name))
 			continue;
 		if (++found &lt; requested)
@@ -239,12 +241,15 @@ COMMAND_HELPER(flash_command_get_bank, unsigned name_index,
 
 COMMAND_HANDLER(handle_flash_bank_command)
 {
-	if (CMD_ARGC &lt; 6)
+	if (CMD_ARGC &lt; 7)
 	{
-		LOG_ERROR(&quot;usage: flash bank &lt;driver&gt; &quot;
+		LOG_ERROR(&quot;usage: flash bank &lt;name&gt; &lt;driver&gt; &quot;
 				&quot;&lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt;&quot;);
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
+	// save bank name and advance arguments for compatibility
+	const char *bank_name = *CMD_ARGV++;
+	CMD_ARGC--;
 
 	struct target *target;
 	if ((target = get_target(CMD_ARGV[5])) == NULL)
@@ -269,6 +274,7 @@ COMMAND_HANDLER(handle_flash_bank_command)
 		}
 
 		c = malloc(sizeof(struct flash_bank));
+		c-&gt;name = strdup(bank_name);
 		c-&gt;target = target;
 		c-&gt;driver = flash_drivers[i];
 		c-&gt;driver_priv = NULL;
diff --git a/src/flash/flash.h b/src/flash/flash.h
index 1235a41..ac1600e 100644
--- a/src/flash/flash.h
+++ b/src/flash/flash.h
@@ -240,6 +240,8 @@ struct flash_driver
  */
 struct flash_bank
 {
+	char *name;
+
 	struct target *target; /**&lt; Target to which this bank belongs. */
 
 	struct flash_driver *driver; /**&lt; Driver for this bank. */

commit dd44ae18b49f6cb54a4c361e9fab70f4d0fafeec
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 17 13:52:43 2009 -0800

    refactor handle_flash_bank_command
    
    Move variables to point of first use, reducing their scope.
    Add driver_name temporary to help arguments be changed later.
    
    Eliminates the useless 'found' variable, changing the code to terminate
    the loop immediate and return its success.

diff --git a/src/flash/flash.c b/src/flash/flash.c
index b960c64..e93aa63 100644
--- a/src/flash/flash.c
+++ b/src/flash/flash.c
@@ -239,25 +239,24 @@ COMMAND_HELPER(flash_command_get_bank, unsigned name_index,
 
 COMMAND_HANDLER(handle_flash_bank_command)
 {
-	int retval;
-	int i;
-	int found = 0;
-	struct target *target;
-
 	if (CMD_ARGC &lt; 6)
 	{
+		LOG_ERROR(&quot;usage: flash bank &lt;driver&gt; &quot;
+				&quot;&lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt;&quot;);
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
+	struct target *target;
 	if ((target = get_target(CMD_ARGV[5])) == NULL)
 	{
 		LOG_ERROR(&quot;target '%s' not defined&quot;, CMD_ARGV[5]);
 		return ERROR_FAIL;
 	}
 
-	for (i = 0; flash_drivers[i]; i++)
+	const char *driver_name = CMD_ARGV[0];
+	for (unsigned i = 0; flash_drivers[i]; i++)
 	{
-		if (strcmp(CMD_ARGV[0], flash_drivers[i]-&gt;name) != 0)
+		if (strcmp(driver_name, flash_drivers[i]-&gt;name) != 0)
 			continue;
 
 		struct flash_bank *p, *c;
@@ -265,7 +264,7 @@ COMMAND_HANDLER(handle_flash_bank_command)
 		/* register flash specific commands */
 		if (flash_drivers[i]-&gt;register_commands(CMD_CTX) != ERROR_OK)
 		{
-			LOG_ERROR(&quot;couldn't register '%s' commands&quot;, CMD_ARGV[0]);
+			LOG_ERROR(&quot;couldn't register '%s' commands&quot;, driver_name);
 			return ERROR_FAIL;
 		}
 
@@ -281,10 +280,12 @@ COMMAND_HANDLER(handle_flash_bank_command)
 		c-&gt;sectors = NULL;
 		c-&gt;next = NULL;
 
+		int retval;
 		retval = CALL_COMMAND_HANDLER(flash_drivers[i]-&gt;flash_bank_command, c);
 		if (ERROR_OK != retval)
 		{
-			LOG_ERROR(&quot;'%s' driver rejected flash bank at 0x%8.8&quot; PRIx32 , CMD_ARGV[0], c-&gt;base);
+			LOG_ERROR(&quot;'%s' driver rejected flash bank at 0x%8.8&quot; PRIx32,
+					driver_name, c-&gt;base);
 			free(c);
 			return retval;
 		}
@@ -305,17 +306,12 @@ COMMAND_HANDLER(handle_flash_bank_command)
 			c-&gt;bank_number = 0;
 		}
 
-		found = 1;
+		return ERROR_OK;
 	}
 
 	/* no matching flash driver found */
-	if (!found)
-	{
-		LOG_ERROR(&quot;flash driver '%s' not found&quot;, CMD_ARGV[0]);
-		return ERROR_FAIL;
-	}
-
-	return ERROR_OK;
+	LOG_ERROR(&quot;flash driver '%s' not found&quot;, driver_name);
+	return ERROR_FAIL;
 }
 
 COMMAND_HANDLER(handle_flash_info_command)

commit ff25e76bad7e57da4ebd363f1b35d4af04acaa67
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 17 13:07:36 2009 -0800

    rename flash and nand command helpers
    
    After adding support for referencing banks by name, renames
    the COMMAND_HELPERs appropriately:
    flash_command_get_bank_by_num  -&gt; flash_command_get_bank
    nand_command_get_device_by_num -&gt; flash_command_get_device

diff --git a/src/flash/avrf.c b/src/flash/avrf.c
index 20c619d..356c404 100644
--- a/src/flash/avrf.c
+++ b/src/flash/avrf.c
@@ -426,7 +426,7 @@ COMMAND_HANDLER(avrf_handle_mass_erase_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
diff --git a/src/flash/flash.c b/src/flash/flash.c
index 071503f..b960c64 100644
--- a/src/flash/flash.c
+++ b/src/flash/flash.c
@@ -216,7 +216,7 @@ struct flash_bank *get_flash_bank_by_num(int num)
 	return p;
 }
 
-COMMAND_HELPER(flash_command_get_bank_by_num, unsigned name_index,
+COMMAND_HELPER(flash_command_get_bank, unsigned name_index,
 		struct flash_bank **bank)
 {
 	const char *name = CMD_ARGV[name_index];
@@ -425,7 +425,7 @@ COMMAND_HANDLER(handle_flash_erase_check_command)
 	}
 
 	struct flash_bank *p;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;p);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;p);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -513,7 +513,7 @@ COMMAND_HANDLER(handle_flash_protect_check_command)
 		return ERROR_COMMAND_SYNTAX_ERROR;
 
 	struct flash_bank *p;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;p);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;p);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -837,7 +837,7 @@ COMMAND_HANDLER(handle_flash_write_bank_command)
 	duration_start(&amp;bench);
 
 	struct flash_bank *p;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;p);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;p);
 	if (ERROR_OK != retval)
 		return retval;
 
diff --git a/src/flash/flash.h b/src/flash/flash.h
index fb88c35..1235a41 100644
--- a/src/flash/flash.h
+++ b/src/flash/flash.h
@@ -333,7 +333,7 @@ struct flash_bank *get_flash_bank_by_num(int num);
  * @param bank On output, contians a pointer to the bank or NULL.
  * @returns ERROR_OK on success, or an error indicating the problem.
  */
-COMMAND_HELPER(flash_command_get_bank_by_num, unsigned name_index,
+COMMAND_HELPER(flash_command_get_bank, unsigned name_index,
 		struct flash_bank **bank);
 /**
  * Returns the flash bank like get_flash_bank_by_num(), without probing.
diff --git a/src/flash/lpc2000.c b/src/flash/lpc2000.c
index 5442e71..b60c6cf 100644
--- a/src/flash/lpc2000.c
+++ b/src/flash/lpc2000.c
@@ -749,7 +749,7 @@ COMMAND_HANDLER(lpc2000_handle_part_id_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
diff --git a/src/flash/lpc2900.c b/src/flash/lpc2900.c
index 1d5abd9..465d776 100644
--- a/src/flash/lpc2900.c
+++ b/src/flash/lpc2900.c
@@ -544,7 +544,7 @@ COMMAND_HANDLER(lpc2900_handle_signature_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -589,7 +589,7 @@ COMMAND_HANDLER(lpc2900_handle_read_custom_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -660,7 +660,7 @@ COMMAND_HANDLER(lpc2900_handle_password_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -695,7 +695,7 @@ COMMAND_HANDLER(lpc2900_handle_write_custom_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -806,7 +806,7 @@ COMMAND_HANDLER(lpc2900_handle_secure_sector_command)
 
 	/* Get the bank descriptor */
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -905,7 +905,7 @@ COMMAND_HANDLER(lpc2900_handle_secure_jtag_command)
 
 	/* Get the bank descriptor */
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
diff --git a/src/flash/nand.c b/src/flash/nand.c
index d812805..3518056 100644
--- a/src/flash/nand.c
+++ b/src/flash/nand.c
@@ -322,7 +322,7 @@ struct nand_device *get_nand_device_by_num(int num)
 	return NULL;
 }
 
-COMMAND_HELPER(nand_command_get_device_by_num, unsigned name_index,
+COMMAND_HELPER(nand_command_get_device, unsigned name_index,
 		struct nand_device **nand)
 {
 	const char *str = CMD_ARGV[name_index];
@@ -1100,7 +1100,7 @@ COMMAND_HANDLER(handle_nand_info_command)
 	int last = -1;
 
 	struct nand_device *p;
-	int retval = CALL_COMMAND_HANDLER(nand_command_get_device_by_num, 0, &amp;p);
+	int retval = CALL_COMMAND_HANDLER(nand_command_get_device, 0, &amp;p);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -1175,7 +1175,7 @@ COMMAND_HANDLER(handle_nand_probe_command)
 	}
 
 	struct nand_device *p;
-	int retval = CALL_COMMAND_HANDLER(nand_command_get_device_by_num, 0, &amp;p);
+	int retval = CALL_COMMAND_HANDLER(nand_command_get_device, 0, &amp;p);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -1204,7 +1204,7 @@ COMMAND_HANDLER(handle_nand_erase_command)
 	}
 
 	struct nand_device *p;
-	int retval = CALL_COMMAND_HANDLER(nand_command_get_device_by_num, 0, &amp;p);
+	int retval = CALL_COMMAND_HANDLER(nand_command_get_device, 0, &amp;p);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -1263,7 +1263,7 @@ COMMAND_HANDLER(handle_nand_check_bad_blocks_command)
 	}
 
 	struct nand_device *p;
-	int retval = CALL_COMMAND_HANDLER(nand_command_get_device_by_num, 0, &amp;p);
+	int retval = CALL_COMMAND_HANDLER(nand_command_get_device, 0, &amp;p);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -1415,7 +1415,7 @@ static COMMAND_HELPER(nand_fileio_parse_args, struct nand_fileio_state *state,
 		return ERROR_COMMAND_SYNTAX_ERROR;
 
 	struct nand_device *nand;
-	int retval = CALL_COMMAND_HANDLER(nand_command_get_device_by_num, 0, &amp;nand);
+	int retval = CALL_COMMAND_HANDLER(nand_command_get_device, 0, &amp;nand);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -1674,7 +1674,7 @@ COMMAND_HANDLER(handle_nand_raw_access_command)
 	}
 
 	struct nand_device *p;
-	int retval = CALL_COMMAND_HANDLER(nand_command_get_device_by_num, 0, &amp;p);
+	int retval = CALL_COMMAND_HANDLER(nand_command_get_device, 0, &amp;p);
 	if (ERROR_OK != retval)
 		return retval;
 
diff --git a/src/flash/nand.h b/src/flash/nand.h
index a108771..d38ed67 100644
--- a/src/flash/nand.h
+++ b/src/flash/nand.h
@@ -239,7 +239,7 @@ int nand_register_commands(struct command_context *cmd_ctx);
 int nand_init(struct command_context *cmd_ctx);
 
 /// helper for parsing a nand device command argument string
-COMMAND_HELPER(nand_command_get_device_by_num, unsigned name_index,
+COMMAND_HELPER(nand_command_get_device, unsigned name_index,
 		struct nand_device **nand);
 
 
diff --git a/src/flash/pic32mx.c b/src/flash/pic32mx.c
index 4bfe91b..fa5a4d6 100644
--- a/src/flash/pic32mx.c
+++ b/src/flash/pic32mx.c
@@ -684,7 +684,7 @@ COMMAND_HANDLER(pic32mx_handle_lock_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -730,7 +730,7 @@ COMMAND_HANDLER(pic32mx_handle_unlock_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -820,7 +820,7 @@ COMMAND_HANDLER(pic32mx_handle_chip_erase_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -858,7 +858,7 @@ COMMAND_HANDLER(pic32mx_handle_pgm_word_command)
 	COMMAND_PARSE_NUMBER(u32, CMD_ARGV[1], value);
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 2, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 2, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
diff --git a/src/flash/stellaris.c b/src/flash/stellaris.c
index a18c99b..32fa415 100644
--- a/src/flash/stellaris.c
+++ b/src/flash/stellaris.c
@@ -1139,7 +1139,7 @@ COMMAND_HANDLER(stellaris_handle_mass_erase_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
diff --git a/src/flash/stm32x.c b/src/flash/stm32x.c
index 4db338d..c96b49d 100644
--- a/src/flash/stm32x.c
+++ b/src/flash/stm32x.c
@@ -905,7 +905,7 @@ COMMAND_HANDLER(stm32x_handle_lock_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -951,7 +951,7 @@ COMMAND_HANDLER(stm32x_handle_unlock_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -995,7 +995,7 @@ COMMAND_HANDLER(stm32x_handle_options_read_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -1051,7 +1051,7 @@ COMMAND_HANDLER(stm32x_handle_options_write_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -1160,7 +1160,7 @@ COMMAND_HANDLER(stm32x_handle_mass_erase_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
diff --git a/src/flash/str7x.c b/src/flash/str7x.c
index da1899d..b79dd17 100644
--- a/src/flash/str7x.c
+++ b/src/flash/str7x.c
@@ -618,7 +618,7 @@ COMMAND_HANDLER(str7x_handle_disable_jtag_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
diff --git a/src/flash/str9x.c b/src/flash/str9x.c
index 50cddaf..3bb8970 100644
--- a/src/flash/str9x.c
+++ b/src/flash/str9x.c
@@ -642,7 +642,7 @@ COMMAND_HANDLER(str9x_handle_flash_config_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
diff --git a/src/flash/str9xpec.c b/src/flash/str9xpec.c
index de222fb..f7c705e 100644
--- a/src/flash/str9xpec.c
+++ b/src/flash/str9xpec.c
@@ -738,7 +738,7 @@ COMMAND_HANDLER(str9xpec_handle_part_id_command)
 		return ERROR_COMMAND_SYNTAX_ERROR;
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -789,7 +789,7 @@ COMMAND_HANDLER(str9xpec_handle_flash_options_read_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -905,7 +905,7 @@ COMMAND_HANDLER(str9xpec_handle_flash_options_write_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -928,7 +928,7 @@ COMMAND_HANDLER(str9xpec_handle_flash_options_cmap_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -957,7 +957,7 @@ COMMAND_HANDLER(str9xpec_handle_flash_options_lvdthd_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -986,7 +986,7 @@ COMMAND_HANDLER(str9xpec_handle_flash_options_lvdsel_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -1015,7 +1015,7 @@ COMMAND_HANDLER(str9xpec_handle_flash_options_lvdwarn_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -1044,7 +1044,7 @@ COMMAND_HANDLER(str9xpec_handle_flash_lock_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -1067,7 +1067,7 @@ COMMAND_HANDLER(str9xpec_handle_flash_unlock_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -1093,7 +1093,7 @@ COMMAND_HANDLER(str9xpec_handle_flash_enable_turbo_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 
@@ -1140,7 +1140,7 @@ COMMAND_HANDLER(str9xpec_handle_flash_disable_turbo_command)
 	}
 
 	struct flash_bank *bank;
-	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank_by_num, 0, &amp;bank);
+	int retval = CALL_COMMAND_HANDLER(flash_command_get_bank, 0, &amp;bank);
 	if (ERROR_OK != retval)
 		return retval;
 

commit 870b8c04557f0b7441cc502debaf537984d77e2a
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 17 13:04:49 2009 -0800

    allow flash/nand banks commands to accept names
    
    Add get_flash_bank_by_name (and get_nand_device_by_name) helpers
    to retrieves struct flash_bank * (struct nand_device *) given a
    driver name and an (optional) driver-specific bank index.
    
    These are used to extend flash_command_get_bank_by_num (and
    nand_command_get_device_by_num) to allow all flash (nand) commands to
    reference defined banks by name, not just by number.
    
    To avoid some code duplication, add the flash/common.[ch] files to hold
    functionality common to both types driver.  The first two methods are
    helpers for the above routines to find a bank specified by a &quot;name&quot; or
    &quot;name.index&quot; string.  get_flash_name_index() finds the '.index' portion,
    while flash_driver_name_matches() performs the string portion matching.

diff --git a/src/flash/Makefile.am b/src/flash/Makefile.am
index b687182..8403230 100644
--- a/src/flash/Makefile.am
+++ b/src/flash/Makefile.am
@@ -11,6 +11,7 @@ libflash_la_SOURCES = \
 	mflash.c
 
 FLASH_SRCS = \
+	common.c \
 	cfi.c \
 	non_cfi.c \
 	faux.c \
@@ -60,6 +61,7 @@ noinst_HEADERS = \
 	at91sam3.h \
 	avrf.h \
 	cfi.h \
+	common.h \
 	flash.h \
 	lpc2000.h \
 	lpc288x.h \
diff --git a/src/flash/common.c b/src/flash/common.c
new file mode 100644
index 0000000..253ed9d
--- /dev/null
+++ b/src/flash/common.c
@@ -0,0 +1,46 @@
+/***************************************************************************
+ *   Copyright (C) 2009 by Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;          *
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ *   This program is distributed in the hope that it will be useful,       *
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
+ *   GNU General Public License for more details.                          *
+ *                                                                         *
+ *   You should have received a copy of the GNU General Public License     *
+ *   along with this program; if not, write to the                         *
+ *   Free Software Foundation, Inc.,                                       *
+ *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
+ ***************************************************************************/
+#ifdef HAVE_CONFIG_H
+#include &quot;config.h&quot;
+#endif
+
+#include &quot;common.h&quot;
+#include &quot;log.h&quot;
+
+unsigned get_flash_name_index(const char *name)
+{
+	const char *index = strchr(name, '.');
+	if (NULL == index)
+		return 0;
+	unsigned requested;
+	int retval = parse_uint(index + 1, &amp;requested);
+	// detect parsing error by forcing past end of bank list
+	return (ERROR_OK == retval) ? requested : ~0U;
+}
+
+bool flash_driver_name_matches(const char *name, const char *expected)
+{
+	unsigned blen = strlen(name);
+	// only match up to the length of the driver name...
+	if (strncmp(name, expected, blen) != 0)
+		return false;
+
+	// ...then check that name terminates at this spot.
+	return expected[blen] == '.' || expected[blen] == '\0';
+}
diff --git a/src/flash/common.h b/src/flash/common.h
new file mode 100644
index 0000000..1fd0d77
--- /dev/null
+++ b/src/flash/common.h
@@ -0,0 +1,39 @@
+/***************************************************************************
+ *   Copyright (C) 2009 by Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;          *
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ *   This program is distributed in the hope that it will be useful,       *
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
+ *   GNU General Public License for more details.                          *
+ *                                                                         *
+ *   You should have received a copy of the GNU General Public License     *
+ *   along with this program; if not, write to the                         *
+ *   Free Software Foundation, Inc.,                                       *
+ *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
+ ***************************************************************************/
+#ifndef FLASH_COMMON_H
+#define FLASH_COMMON_H
+
+#include &quot;types.h&quot;
+
+/**
+ * Parses the optional '.index' portion of a flash bank identifier.
+ * @param name The desired driver name, passed by the user.
+ * @returns The parsed index request, or 0 if not present.  If the
+ * name provides a suffix but it does not parse as an unsigned integer, 
+ * the routine returns ~0U.  This will prevent further matching.
+ */ 
+unsigned get_flash_name_index(const char *name);
+/**
+ * Attempt to match the @c expected name with the @c name of a driver.
+ * @param name The name of the driver (from the bank's device structure).
+ * @param expected The expected driver name, passed by the user.
+ */
+bool flash_driver_name_matches(const char *name, const char *expected);
+
+#endif // FLASH_COMMON_H
diff --git a/src/flash/flash.c b/src/flash/flash.c
index 98e5ee0..071503f 100644
--- a/src/flash/flash.c
+++ b/src/flash/flash.c
@@ -28,6 +28,7 @@
 #endif
 
 #include &quot;flash.h&quot;
+#include &quot;common.h&quot;
 #include &quot;image.h&quot;
 #include &quot;time_support.h&quot;
 
@@ -180,6 +181,23 @@ int flash_get_bank_count(void)
 	return i;
 }
 
+struct flash_bank *get_flash_bank_by_name(const char *name)
+{
+	unsigned requested = get_flash_name_index(name);
+	unsigned found = 0;
+
+	struct flash_bank *bank;
+	for (bank = flash_banks; NULL != bank; bank = bank-&gt;next)
+	{
+		if (!flash_driver_name_matches(bank-&gt;driver-&gt;name, name))
+			continue;
+		if (++found &lt; requested)
+			continue;
+		return bank;
+	}
+	return NULL;
+}
+
 struct flash_bank *get_flash_bank_by_num(int num)
 {
 	struct flash_bank *p = get_flash_bank_by_num_noprobe(num);
@@ -198,10 +216,14 @@ struct flash_bank *get_flash_bank_by_num(int num)
 	return p;
 }
 
-COMMAND_HELPER(flash_command_get_bank_by_num,
-	unsigned name_index, struct flash_bank **bank)
+COMMAND_HELPER(flash_command_get_bank_by_num, unsigned name_index,
+		struct flash_bank **bank)
 {
 	const char *name = CMD_ARGV[name_index];
+	*bank = get_flash_bank_by_name(name);
+	if (*bank)
+		return ERROR_OK;
+
 	unsigned bank_num;
 	COMMAND_PARSE_NUMBER(uint, name, bank_num);
 
diff --git a/src/flash/flash.h b/src/flash/flash.h
index 23a7b81..fb88c35 100644
--- a/src/flash/flash.h
+++ b/src/flash/flash.h
@@ -310,6 +310,14 @@ int default_flash_blank_check(struct flash_bank *bank);
 int default_flash_mem_blank_check(struct flash_bank *bank);
 
 /**
+ * Returns the flash bank specified by @a name, which matches the
+ * driver name and a suffix (option) specify the driver-specific
+ * bank number. The suffix consists of the '.' and the driver-specific
+ * bank number: when two str9x banks are defined, then 'str9x.1' refers
+ * to the second.
+ */
+struct flash_bank *get_flash_bank_by_name(const char *name);
+/**
  * Returns a flash bank by the specified flash_bank_s bank_number, @a num.
  * @param num The flash bank number.
  * @returns A struct flash_bank for flash bank @a num, or NULL
@@ -317,7 +325,9 @@ int default_flash_mem_blank_check(struct flash_bank *bank);
 struct flash_bank *get_flash_bank_by_num(int num);
 /**
  * Retreives @a bank from a command argument, reporting errors parsing
- * the bank identifier or retreiving the specified bank.
+ * the bank identifier or retreiving the specified bank.  The bank
+ * may be identified by its bank number or by @c name.instance, where
+ * @a instance is driver-specific.
  * @param name_index The index to the string in args containing the
  * bank identifier.
  * @param bank On output, contians a pointer to the bank or NULL.
diff --git a/src/flash/nand.c b/src/flash/nand.c
index 53b6531..d812805 100644
--- a/src/flash/nand.c
+++ b/src/flash/nand.c
@@ -25,6 +25,7 @@
 #endif
 
 #include &quot;nand.h&quot;
+#include &quot;common.h&quot;
 #include &quot;time_support.h&quot;
 #include &quot;fileio.h&quot;
 
@@ -288,6 +289,23 @@ int nand_register_commands(struct command_context *cmd_ctx)
 	return ERROR_OK;
 }
 
+struct nand_device *get_nand_device_by_name(const char *name)
+{
+	unsigned requested = get_flash_name_index(name);
+	unsigned found = 0;
+
+	struct nand_device *nand;
+	for (nand = nand_devices; NULL != nand; nand = nand-&gt;next)
+	{
+		if (!flash_driver_name_matches(nand-&gt;controller-&gt;name, name))
+			continue;
+		if (++found &lt; requested)
+			continue;
+		return nand;
+	}
+	return NULL;
+}
+
 struct nand_device *get_nand_device_by_num(int num)
 {
 	struct nand_device *p;
@@ -308,11 +326,15 @@ COMMAND_HELPER(nand_command_get_device_by_num, unsigned name_index,
 		struct nand_device **nand)
 {
 	const char *str = CMD_ARGV[name_index];
+	*nand = get_nand_device_by_name(str);
+	if (*nand)
+		return ERROR_OK;
+
 	unsigned num;
 	COMMAND_PARSE_NUMBER(uint, str, num);
 	*nand = get_nand_device_by_num(num);
 	if (!*nand) {
-		command_print(CMD_CTX, &quot;NAND flash device '#%s' is out of bounds&quot;, str);
+		command_print(CMD_CTX, &quot;NAND flash device '%s' not found&quot;, str);
 		return ERROR_INVALID_ARGUMENTS;
 	}
 	return ERROR_OK;
diff --git a/src/flash/nand.h b/src/flash/nand.h
index ddc4520..a108771 100644
--- a/src/flash/nand.h
+++ b/src/flash/nand.h
@@ -212,6 +212,15 @@ enum oob_formats
 };
 
 
+/**
+ * Returns the flash bank specified by @a name, which matches the
+ * driver name and a suffix (option) specify the driver-specific
+ * bank number. The suffix consists of the '.' and the driver-specific
+ * bank number: when two davinci banks are defined, then 'davinci.1' refers
+ * to the second (e.g. DM355EVM).
+ */
+struct nand_device *get_nand_device_by_name(const char *name);
+
 struct nand_device *get_nand_device_by_num(int num);
 
 int nand_read_page_raw(struct nand_device *nand, uint32_t page,

-----------------------------------------------------------------------

Summary of changes:
 doc/openocd.texi                             |    8 +-
 src/flash/Makefile.am                        |    2 +
 src/flash/avrf.c                             |    2 +-
 src/{openocd.h =&gt; flash/common.c}            |   44 ++++---
 src/{openocd.h =&gt; flash/common.h}            |   37 +++---
 src/flash/flash.c                            |   70 +++++++----
 src/flash/flash.h                            |   16 ++-
 src/flash/lpc2000.c                          |    2 +-
 src/flash/lpc2900.c                          |   12 +-
 src/flash/nand.c                             |  169 +++++++++++++++-----------
 src/flash/nand.h                             |   12 ++-
 src/flash/pic32mx.c                          |    8 +-
 src/flash/stellaris.c                        |    2 +-
 src/flash/stm32x.c                           |   10 +-
 src/flash/str7x.c                            |    2 +-
 src/flash/str9x.c                            |    2 +-
 src/flash/str9xpec.c                         |   22 ++--
 tcl/board/balloon3-cpu.cfg                   |    3 +-
 tcl/board/crossbow_tech_imote2.cfg           |    3 +-
 tcl/board/csb337.cfg                         |    3 +-
 tcl/board/digi_connectcore_wi-9c.cfg         |    3 +-
 tcl/board/dm355evm.cfg                       |    6 +-
 tcl/board/hammer.cfg                         |    3 +-
 tcl/board/hitex_lpc2929.cfg                  |    3 +-
 tcl/board/hitex_str9-comstick.cfg            |    6 +-
 tcl/board/lubbock.cfg                        |    6 +-
 tcl/board/omap2420_h4.cfg                    |    6 +-
 tcl/board/openrd.cfg                         |    3 +-
 tcl/board/osk5912.cfg                        |    6 +-
 tcl/board/pxa255_sst.cfg                     |    3 +-
 tcl/board/sheevaplug.cfg                     |    3 +-
 tcl/board/str910-eval.cfg                    |    6 +-
 tcl/board/telo.cfg                           |    3 +-
 tcl/board/topas910.cfg                       |    3 +-
 tcl/board/topasa900.cfg                      |    3 +-
 tcl/board/unknown_at91sam9260.cfg            |    3 +-
 tcl/board/x300t.cfg                          |    3 +-
 tcl/board/zy1000.cfg                         |    3 +-
 tcl/target/aduc702x.cfg                      |    3 +-
 tcl/target/at91eb40a.cfg                     |    3 +-
 tcl/target/at91r40008.cfg                    |    3 +-
 tcl/target/at91sam3u1c.cfg                   |    3 +-
 tcl/target/at91sam3u1e.cfg                   |    3 +-
 tcl/target/at91sam3u2c.cfg                   |    3 +-
 tcl/target/at91sam3u2e.cfg                   |    3 +-
 tcl/target/at91sam3u4c.cfg                   |    6 +-
 tcl/target/at91sam3u4e.cfg                   |    6 +-
 tcl/target/at91sam7sx.cfg                    |    3 +-
 tcl/target/at91sam9260_ext_RAM_ext_flash.cfg |    3 +-
 tcl/target/epc9301.cfg                       |    3 +-
 tcl/target/faux.cfg                          |    3 +-
 tcl/target/lm3s1968.cfg                      |    3 +-
 tcl/target/lm3s3748.cfg                      |    3 +-
 tcl/target/lm3s6965.cfg                      |    3 +-
 tcl/target/lm3s811.cfg                       |    3 +-
 tcl/target/lm3s9b9x.cfg                      |    3 +-
 tcl/target/lpc1768.cfg                       |    3 +-
 tcl/target/lpc2103.cfg                       |    3 +-
 tcl/target/lpc2124.cfg                       |    3 +-
 tcl/target/lpc2129.cfg                       |    3 +-
 tcl/target/lpc2148.cfg                       |    3 +-
 tcl/target/lpc2294.cfg                       |    3 +-
 tcl/target/lpc2378.cfg                       |    3 +-
 tcl/target/lpc2478.cfg                       |    3 +-
 tcl/target/lpc2900.cfg                       |    3 +-
 tcl/target/mega128.cfg                       |    3 +-
 tcl/target/pic32mx.cfg                       |    6 +-
 tcl/target/sam7se512.cfg                     |    3 +-
 tcl/target/sam7x256.cfg                      |    3 +-
 tcl/target/smdk6410.cfg                      |    3 +-
 tcl/target/stm32.cfg                         |    3 +-
 tcl/target/str710.cfg                        |    6 +-
 tcl/target/str730.cfg                        |    3 +-
 tcl/target/str750.cfg                        |    6 +-
 tcl/target/str912.cfg                        |    6 +-
 tcl/target/telo.cfg                          |    3 +-
 tcl/target/xba_revA3.cfg                     |    3 +-
 tcl/test/syntax1.cfg                         |    3 +-
 78 files changed, 397 insertions(+), 242 deletions(-)
 copy src/{openocd.h =&gt; flash/common.c} (65%)
 copy src/{openocd.h =&gt; flash/common.h} (64%)


hooks/post-receive
-- 
Main OpenOCD repository

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001826.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-485-g8f446fc
</A></li>
	<LI>Next message: <A HREF="001828.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-495-g31fb778
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1827">[ date ]</a>
              <a href="thread.html#1827">[ thread ]</a>
              <a href="subject.html#1827">[ subject ]</a>
              <a href="author.html#1827">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openocd-svn">More information about the openocd-svn
mailing list</a><br>
</body></html>
