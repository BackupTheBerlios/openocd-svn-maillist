<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-87-g6a0af06
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openocd-svn/2009-November/index.html" >
   <LINK REL="made" HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.3.0-87-g6a0af06&In-Reply-To=%3CE1N6I4e-0000UD-2U%40cxgxhf1.ch3.sourceforge.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001731.html">
   <LINK REL="Next"  HREF="001733.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-87-g6a0af06</H1>
    <B>David Brownell</B> 
    <A HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.3.0-87-g6a0af06&In-Reply-To=%3CE1N6I4e-0000UD-2U%40cxgxhf1.ch3.sourceforge.com%3E"
       TITLE="[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-87-g6a0af06">dbrownell at users.sourceforge.net
       </A><BR>
    <I>Fri Nov  6 07:13:27 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001731.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-74-gb7e4c26
</A></li>
        <LI>Next message: <A HREF="001733.html">[openocd-svn] Main OpenOCD repository annotated tag, v0.1.0,	created. v0.1.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1732">[ date ]</a>
              <a href="thread.html#1732">[ thread ]</a>
              <a href="subject.html#1732">[ subject ]</a>
              <a href="author.html#1732">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Main OpenOCD repository&quot;.

The branch, master has been updated
       via  6a0af06bd9f66780d2c3e9f69c40f2b89ad90605 (commit)
       via  03ac53a2cfdb7d0715f7060cecf8719068f6fae1 (commit)
       via  a81df55f393478cdef9197c248a1b64d26465589 (commit)
       via  fec3c4763ad4cf2996fa138c4fd0f555e32e5e9f (commit)
       via  11fe2ec62e30e4b580ace6821ac4293ed91d53f1 (commit)
       via  6cf956fa9d0d0a0eddaf0c8878f25c549c005c62 (commit)
       via  178c7580960b4d84fe83ef579250fba1d6ac4f2d (commit)
       via  865ed6ed819888910f198f0584cc1b78d1e6e363 (commit)
       via  1fcb351de6912148aa3ef567aa2de2c74e3b05f3 (commit)
       via  6e08573efd78b8f38fbe05f4feee2615a90fa41c (commit)
       via  9be533566ea077c32bf57eb0441c8a4ae2a7c9cc (commit)
       via  da739aa25733b5a252a2b0b8ad76a3dc886f1132 (commit)
       via  db116b1ea3c77a3c5850fccbce9e0795faa21dda (commit)
      from  b7e4c26b9bb10e6e0ebfb07e5d43f0d62526cde2 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 6a0af06bd9f66780d2c3e9f69c40f2b89ad90605
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Thu Nov 5 22:04:25 2009 -0800

    ARM: shrink offsets
    
    Move various embedded target structs to the beginnings of
    their containers ... pretty much the way C++ or Obj-C
    would for single inheritance.
    
    This shrinks code that accesses those embedded structs by
    letting common offsets use smaller instructions.  Sample
    before/after sizes (on amd64):
    
      17181	    312	      0	  17493	   4455	arm920t.o
      16810	    312	      0	  17122	   42e2	arm920t.o
    
    Where the &quot;after&quot; is the smaller number, with this patch
    over the ones leveraging that embedding knowledge.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/arm720t.h b/src/target/arm720t.h
index 0689e44..c10cbe1 100644
--- a/src/target/arm720t.h
+++ b/src/target/arm720t.h
@@ -27,9 +27,9 @@
 
 typedef struct arm720t_common_s
 {
+	arm7tdmi_common_t arm7tdmi_common;
 	uint32_t common_magic;
 	armv4_5_mmu_common_t armv4_5_mmu;
-	arm7tdmi_common_t arm7tdmi_common;
 	uint32_t cp15_control_reg;
 	uint32_t fsr_reg;
 	uint32_t far_reg;
diff --git a/src/target/arm7_9_common.h b/src/target/arm7_9_common.h
index 9eafc1d..9c42b6b 100644
--- a/src/target/arm7_9_common.h
+++ b/src/target/arm7_9_common.h
@@ -39,6 +39,7 @@
  */
 typedef struct arm7_9_common_s
 {
+	armv4_5_common_t armv4_5_common;
 	uint32_t common_magic;
 
 	arm_jtag_t jtag_info; /**&lt; JTAG information for target */
@@ -107,7 +108,6 @@ typedef struct arm7_9_common_s
 	void (*pre_restore_context)(target_t *target); /**&lt; Callback function called before restoring the processor context */
 	void (*post_restore_context)(target_t *target); /**&lt; Callback function called after restoring the processor context */
 
-	armv4_5_common_t armv4_5_common;
 
 } arm7_9_common_t;
 
diff --git a/src/target/arm920t.h b/src/target/arm920t.h
index eb66eaa..af0f982 100644
--- a/src/target/arm920t.h
+++ b/src/target/arm920t.h
@@ -27,9 +27,9 @@
 
 typedef struct arm920t_common_s
 {
+	arm9tdmi_common_t arm9tdmi_common;
 	uint32_t common_magic;
 	armv4_5_mmu_common_t armv4_5_mmu;
-	arm9tdmi_common_t arm9tdmi_common;
 	uint32_t cp15_control_reg;
 	uint32_t d_fsr;
 	uint32_t i_fsr;
diff --git a/src/target/arm926ejs.h b/src/target/arm926ejs.h
index ff811e3..01e3c09 100644
--- a/src/target/arm926ejs.h
+++ b/src/target/arm926ejs.h
@@ -27,9 +27,9 @@
 
 typedef struct arm926ejs_common_s
 {
+	arm9tdmi_common_t arm9tdmi_common;
 	uint32_t common_magic;
 	armv4_5_mmu_common_t armv4_5_mmu;
-	arm9tdmi_common_t arm9tdmi_common;
 	int (*read_cp15)(target_t *target, uint32_t op1, uint32_t op2, uint32_t CRn, uint32_t CRm, uint32_t *value);
 	int (*write_cp15)(target_t *target, uint32_t op1, uint32_t op2, uint32_t CRn, uint32_t CRm, uint32_t value);
 	uint32_t cp15_control_reg;
diff --git a/src/target/arm966e.h b/src/target/arm966e.h
index 710f207..e8346f9 100644
--- a/src/target/arm966e.h
+++ b/src/target/arm966e.h
@@ -29,8 +29,8 @@
 
 typedef struct arm966e_common_s
 {
-	int common_magic;
 	arm9tdmi_common_t arm9tdmi_common;
+	int common_magic;
 	uint32_t cp15_control_reg;
 } arm966e_common_t;
 
diff --git a/src/target/xscale.h b/src/target/xscale.h
index 56db181..433ecfc 100644
--- a/src/target/xscale.h
+++ b/src/target/xscale.h
@@ -80,6 +80,9 @@ typedef struct xscale_trace_s
 
 typedef struct xscale_common_s
 {
+	/* armv4/5 common stuff */
+	armv4_5_common_t armv4_5_common;
+
 	int common_magic;
 
 	/* XScale registers (CP15, DBG) */
@@ -121,9 +124,6 @@ typedef struct xscale_common_s
 
 	int arch_debug_reason;
 
-	/* armv4/5 common stuff */
-	armv4_5_common_t armv4_5_common;
-
 	/* MMU/Caches */
 	armv4_5_mmu_common_t armv4_5_mmu;
 	uint32_t cp15_control_reg;

commit 03ac53a2cfdb7d0715f7060cecf8719068f6fae1
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Thu Nov 5 22:04:22 2009 -0800

    ARM: other code uses the new inheritance/nesting scheme
    
    Remove most remaining uses of target-&gt;arch_info from ARM
    infrastructure, where it hasn't already been updated.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/arm7_9_common.c b/src/target/arm7_9_common.c
index 21c5c7a..2a0aefc 100644
--- a/src/target/arm7_9_common.c
+++ b/src/target/arm7_9_common.c
@@ -172,8 +172,7 @@ static int arm7_9_set_software_breakpoints(arm7_9_common_t *arm7_9)
  */
 int arm7_9_setup(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 
 	return arm7_9_clear_watchpoints(arm7_9);
 }
@@ -192,18 +191,18 @@ int arm7_9_setup(target_t *target)
  */
 int arm7_9_get_arch_pointers(target_t *target, armv4_5_common_t **armv4_5_p, arm7_9_common_t **arm7_9_p)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 
+	/* FIXME stop using this routine; just target_to_arm7_9() and
+	 * verify the resulting pointer using a replacement routine
+	 * that emits a usage message.
+	 */
 	if (armv4_5-&gt;common_magic != ARMV4_5_COMMON_MAGIC)
-	{
-		return -1;
-	}
+		return ERROR_TARGET_INVALID;
 
 	if (arm7_9-&gt;common_magic != ARM7_9_COMMON_MAGIC)
-	{
-		return -1;
-	}
+		return ERROR_TARGET_INVALID;
 
 	*armv4_5_p = armv4_5;
 	*arm7_9_p = arm7_9;
@@ -224,8 +223,7 @@ int arm7_9_get_arch_pointers(target_t *target, armv4_5_common_t **armv4_5_p, arm
  */
 int arm7_9_set_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	int retval = ERROR_OK;
 
 	LOG_DEBUG(&quot;BPID: %d, Address: 0x%08&quot; PRIx32 &quot;, Type: %d&quot; ,
@@ -355,9 +353,7 @@ int arm7_9_set_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 int arm7_9_unset_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 {
 	int retval = ERROR_OK;
-
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 
 	LOG_DEBUG(&quot;BPID: %d, Address: 0x%08&quot; PRIx32,
 			  breakpoint-&gt;unique_id,
@@ -451,8 +447,7 @@ int arm7_9_unset_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
  */
 int arm7_9_add_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -503,8 +498,7 @@ int arm7_9_add_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 int arm7_9_remove_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 {
 	int retval = ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 
 	if ((retval = arm7_9_unset_breakpoint(target, breakpoint)) != ERROR_OK)
 	{
@@ -540,8 +534,7 @@ int arm7_9_remove_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 int arm7_9_set_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 {
 	int retval = ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	int rw_mask = 1;
 	uint32_t mask;
 
@@ -612,8 +605,7 @@ int arm7_9_set_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 int arm7_9_unset_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 {
 	int retval = ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -660,8 +652,7 @@ int arm7_9_unset_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
  */
 int arm7_9_add_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -695,8 +686,7 @@ int arm7_9_add_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 int arm7_9_remove_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 {
 	int retval = ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 
 	if (watchpoint-&gt;set)
 	{
@@ -723,9 +713,7 @@ int arm7_9_remove_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 int arm7_9_execute_sys_speed(struct target_s *target)
 {
 	int retval;
-
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	reg_t *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 
@@ -778,8 +766,7 @@ int arm7_9_execute_fast_sys_speed(struct target_s *target)
 	static int set = 0;
 	static uint8_t check_value[4], check_mask[4];
 
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	reg_t *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 
@@ -820,8 +807,7 @@ int arm7_9_execute_fast_sys_speed(struct target_s *target)
  */
 int arm7_9_target_request_data(target_t *target, uint32_t size, uint8_t *buffer)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	uint32_t *data;
 	int retval = ERROR_OK;
@@ -857,8 +843,7 @@ int arm7_9_handle_target_request(void *priv)
 	target_t *target = priv;
 	if (!target_was_examined(target))
 		return ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	reg_t *dcc_control = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_COMMS_CTRL];
 
@@ -916,8 +901,7 @@ int arm7_9_handle_target_request(void *priv)
 int arm7_9_poll(target_t *target)
 {
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	reg_t *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 
 	/* read debug status register */
@@ -1009,8 +993,8 @@ int arm7_9_poll(target_t *target)
  */
 int arm7_9_assert_reset(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+
 	LOG_DEBUG(&quot;target-&gt;state: %s&quot;,
 		  target_state_name(target));
 
@@ -1141,8 +1125,7 @@ int arm7_9_deassert_reset(target_t *target)
  */
 int arm7_9_clear_halt(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	reg_t *dbg_ctrl = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_CTRL];
 
 	/* we used DBGRQ only if we didn't come out of reset */
@@ -1199,8 +1182,8 @@ int arm7_9_clear_halt(target_t *target)
  */
 int arm7_9_soft_reset_halt(struct target_s *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	reg_t *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 	reg_t *dbg_ctrl = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_CTRL];
 	int i;
@@ -1318,8 +1301,7 @@ int arm7_9_halt(target_t *target)
 		return ERROR_OK;
 	}
 
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	reg_t *dbg_ctrl = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_CTRL];
 
 	LOG_DEBUG(&quot;target-&gt;state: %s&quot;,
@@ -1381,9 +1363,8 @@ int arm7_9_debug_entry(target_t *target)
 	uint32_t r0_thumb, pc_thumb;
 	uint32_t cpsr;
 	int retval;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	reg_t *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 	reg_t *dbg_ctrl = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_CTRL];
 
@@ -1536,8 +1517,8 @@ int arm7_9_full_context(target_t *target)
 {
 	int i;
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 
 	LOG_DEBUG(&quot;-&quot;);
 
@@ -1627,8 +1608,8 @@ int arm7_9_full_context(target_t *target)
  */
 int arm7_9_restore_context(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	reg_t *reg;
 	armv4_5_core_reg_t *reg_arch_info;
 	enum armv4_5_mode current_mode = armv4_5-&gt;core_mode;
@@ -1777,8 +1758,7 @@ int arm7_9_restore_context(target_t *target)
  */
 int arm7_9_restart_core(struct target_s *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* set RESTART instruction */
@@ -1831,8 +1811,8 @@ void arm7_9_enable_breakpoints(struct target_s *target)
 
 int arm7_9_resume(struct target_s *target, int current, uint32_t address, int handle_breakpoints, int debug_execution)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	breakpoint_t *breakpoint = target-&gt;breakpoints;
 	reg_t *dbg_ctrl = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_CTRL];
 	int err, retval = ERROR_OK;
@@ -1991,9 +1971,8 @@ int arm7_9_resume(struct target_s *target, int current, uint32_t address, int ha
 
 void arm7_9_enable_eice_step(target_t *target, uint32_t next_pc)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	uint32_t current_pc;
 	current_pc = buf_get_u32(armv4_5-&gt;core_cache-&gt;reg_list[15].value, 0, 32);
 
@@ -2029,8 +2008,7 @@ void arm7_9_enable_eice_step(target_t *target, uint32_t next_pc)
 
 void arm7_9_disable_eice_step(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 
 	embeddedice_store_reg(&amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_W0_ADDR_MASK]);
 	embeddedice_store_reg(&amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_W0_DATA_MASK]);
@@ -2045,8 +2023,8 @@ void arm7_9_disable_eice_step(target_t *target)
 
 int arm7_9_step(struct target_s *target, int current, uint32_t address, int handle_breakpoints)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	breakpoint_t *breakpoint = NULL;
 	int err, retval;
 
@@ -2141,8 +2119,8 @@ int arm7_9_read_core_reg(struct target_s *target, int num, enum armv4_5_mode mod
 	uint32_t* reg_p[16];
 	uint32_t value;
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 
 	if (armv4_5_mode_to_number(armv4_5-&gt;core_mode)==-1)
 		return ERROR_FAIL;
@@ -2205,8 +2183,8 @@ int arm7_9_read_core_reg(struct target_s *target, int num, enum armv4_5_mode mod
 int arm7_9_write_core_reg(struct target_s *target, int num, enum armv4_5_mode mode, uint32_t value)
 {
 	uint32_t reg[16];
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 
 	if (armv4_5_mode_to_number(armv4_5-&gt;core_mode)==-1)
 		return ERROR_FAIL;
@@ -2265,9 +2243,8 @@ int arm7_9_write_core_reg(struct target_s *target, int num, enum armv4_5_mode mo
 
 int arm7_9_read_memory(struct target_s *target, uint32_t address, uint32_t size, uint32_t count, uint8_t *buffer)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	uint32_t reg[16];
 	uint32_t num_accesses = 0;
 	int thisrun_accesses;
@@ -2441,8 +2418,8 @@ int arm7_9_read_memory(struct target_s *target, uint32_t address, uint32_t size,
 
 int arm7_9_write_memory(struct target_s *target, uint32_t address, uint32_t size, uint32_t count, uint8_t *buffer)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	reg_t *dbg_ctrl = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_CTRL];
 
 	uint32_t reg[16];
@@ -2628,8 +2605,7 @@ static uint8_t *dcc_buffer;
 static int arm7_9_dcc_completion(struct target_s *target, uint32_t exit_point, int timeout_ms, void *arch_info)
 {
 	int retval = ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 
 	if ((retval = target_wait_state(target, TARGET_DEBUG_RUNNING, 500)) != ERROR_OK)
 		return retval;
@@ -2694,8 +2670,7 @@ int armv4_5_run_algorithm_inner(struct target_s *target, int num_mem_params, mem
 int arm7_9_bulk_write_memory(target_t *target, uint32_t address, uint32_t count, uint8_t *buffer)
 {
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	int i;
 
 	if (!arm7_9-&gt;dcc_downloads)
diff --git a/src/target/arm7_9_common.h b/src/target/arm7_9_common.h
index d86ac24..9eafc1d 100644
--- a/src/target/arm7_9_common.h
+++ b/src/target/arm7_9_common.h
@@ -108,7 +108,6 @@ typedef struct arm7_9_common_s
 	void (*post_restore_context)(target_t *target); /**&lt; Callback function called after restoring the processor context */
 
 	armv4_5_common_t armv4_5_common;
-	void *arch_info;
 
 } arm7_9_common_t;
 
diff --git a/src/target/arm_simulator.c b/src/target/arm_simulator.c
index 27957b2..2d35af9 100644
--- a/src/target/arm_simulator.c
+++ b/src/target/arm_simulator.c
@@ -825,21 +825,19 @@ static enum armv4_5_mode armv4_5_get_mode(struct arm_sim_interface *sim)
 
 int arm_simulate_step(target_t *target, uint32_t *dry_run_pc)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 	struct arm_sim_interface sim;
 
-	sim.user_data=armv4_5;
-	sim.get_reg=&amp;armv4_5_get_reg;
-	sim.set_reg=&amp;armv4_5_set_reg;
-	sim.get_reg_mode=&amp;armv4_5_get_reg_mode;
-	sim.set_reg_mode=&amp;armv4_5_set_reg_mode;
-	sim.get_cpsr=&amp;armv4_5_get_cpsr;
-	sim.get_mode=&amp;armv4_5_get_mode;
-	sim.get_state=&amp;armv4_5_get_state;
-	sim.set_state=&amp;armv4_5_set_state;
+	sim.user_data = armv4_5;
+	sim.get_reg = &amp;armv4_5_get_reg;
+	sim.set_reg = &amp;armv4_5_set_reg;
+	sim.get_reg_mode = &amp;armv4_5_get_reg_mode;
+	sim.set_reg_mode = &amp;armv4_5_set_reg_mode;
+	sim.get_cpsr = &amp;armv4_5_get_cpsr;
+	sim.get_mode = &amp;armv4_5_get_mode;
+	sim.get_state = &amp;armv4_5_get_state;
+	sim.set_state = &amp;armv4_5_set_state;
 
 	return arm_simulate_step_core(target, dry_run_pc, &amp;sim);
-
 }
 
diff --git a/src/target/armv4_5.c b/src/target/armv4_5.c
index 9d942ae..0fe9ee4 100644
--- a/src/target/armv4_5.c
+++ b/src/target/armv4_5.c
@@ -189,7 +189,7 @@ int armv4_5_set_core_reg(reg_t *reg, uint8_t *buf)
 {
 	armv4_5_core_reg_t *armv4_5 = reg-&gt;arch_info;
 	target_t *target = armv4_5-&gt;target;
-	armv4_5_common_t *armv4_5_target = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5_target = target_to_armv4_5(target);
 	uint32_t value = buf_get_u32(buf, 0, 32);
 
 	if (target-&gt;state != TARGET_HALTED)
@@ -237,7 +237,7 @@ int armv4_5_set_core_reg(reg_t *reg, uint8_t *buf)
 
 int armv4_5_invalidate_core_regs(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 	int i;
 
 	for (i = 0; i &lt; 37; i++)
@@ -289,7 +289,7 @@ reg_cache_t* armv4_5_build_reg_cache(target_t *target, armv4_5_common_t *armv4_5
 
 int armv4_5_arch_state(struct target_s *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 
 	if (armv4_5-&gt;common_magic != ARMV4_5_COMMON_MAGIC)
 	{
@@ -313,7 +313,7 @@ int handle_armv4_5_reg_command(struct command_context_s *cmd_ctx, char *cmd, cha
 	int output_len;
 	int mode, num;
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 
 	if (armv4_5-&gt;common_magic != ARMV4_5_COMMON_MAGIC)
 	{
@@ -362,7 +362,7 @@ int handle_armv4_5_reg_command(struct command_context_s *cmd_ctx, char *cmd, cha
 int handle_armv4_5_core_state_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 
 	if (armv4_5-&gt;common_magic != ARMV4_5_COMMON_MAGIC)
 	{
@@ -393,7 +393,7 @@ handle_armv4_5_disassemble_command(struct command_context_s *cmd_ctx,
 {
 	int retval = ERROR_OK;
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 	uint32_t address;
 	int count = 1;
 	int i;
@@ -487,7 +487,7 @@ int armv4_5_register_commands(struct command_context_s *cmd_ctx)
 
 int armv4_5_get_gdb_reg_list(target_t *target, reg_t **reg_list[], int *reg_list_size)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 	int i;
 
 	if (armv4_5_mode_to_number(armv4_5-&gt;core_mode)==-1)
@@ -516,7 +516,7 @@ int armv4_5_get_gdb_reg_list(target_t *target, reg_t **reg_list[], int *reg_list
 static int armv4_5_run_algorithm_completion(struct target_s *target, uint32_t exit_point, int timeout_ms, void *arch_info)
 {
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 
 	if ((retval = target_wait_state(target, TARGET_HALTED, timeout_ms)) != ERROR_OK)
 	{
@@ -547,7 +547,7 @@ static int armv4_5_run_algorithm_completion(struct target_s *target, uint32_t ex
 
 int armv4_5_run_algorithm_inner(struct target_s *target, int num_mem_params, mem_param_t *mem_params, int num_reg_params, reg_param_t *reg_params, uint32_t entry_point, uint32_t exit_point, int timeout_ms, void *arch_info, int (*run_it)(struct target_s *target, uint32_t exit_point, int timeout_ms, void *arch_info))
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 	armv4_5_algorithm_t *armv4_5_algorithm_info = arch_info;
 	enum armv4_5_state core_state = armv4_5-&gt;core_state;
 	enum armv4_5_mode core_mode = armv4_5-&gt;core_mode;
diff --git a/src/target/embeddedice.c b/src/target/embeddedice.c
index 9909084..faeef38 100644
--- a/src/target/embeddedice.c
+++ b/src/target/embeddedice.c
@@ -276,10 +276,13 @@ reg_cache_t* embeddedice_build_reg_cache(target_t *target, arm7_9_common_t *arm7
 int embeddedice_setup(target_t *target)
 {
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 
-	/* explicitly disable monitor mode */
+	/* Explicitly disable monitor mode.  For now we only support halting
+	 * debug ... we don't know how to talk with a resident debug monitor
+	 * that manages break requests.  ARM's &quot;Angel Debug Monitor&quot; is one
+	 * common example of such code.
+	 */
 	if (arm7_9-&gt;has_monitor_mode)
 	{
 		reg_t *dbg_ctrl = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_CTRL];
diff --git a/src/target/etm.c b/src/target/etm.c
index 8229bb0..21087b2 100644
--- a/src/target/etm.c
+++ b/src/target/etm.c
@@ -410,8 +410,7 @@ int etm_setup(target_t *target)
 {
 	int retval;
 	uint32_t etm_ctrl_value;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	etm_context_t *etm_ctx = arm7_9-&gt;etm_ctx;
 	reg_t *etm_ctrl_reg;
 

commit a81df55f393478cdef9197c248a1b64d26465589
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Thu Nov 5 22:04:13 2009 -0800

    Cortex-A8: use the new inheritance/nesting scheme
    
    Use target_to_armv7a() etc, replacing needless pointer traversals.
    Stop using X-&gt;arch_info scheme in most ARMv7-A and Cortex-A8 code.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/armv7a.c b/src/target/armv7a.c
index 1583e99..6dfbb16 100644
--- a/src/target/armv7a.c
+++ b/src/target/armv7a.c
@@ -176,10 +176,7 @@ reg_t armv7a_gdb_dummy_fp_reg =
 void armv7a_show_fault_registers(target_t *target)
 {
 	uint32_t dfsr, ifsr, dfar, ifar;
-
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 
 	armv7a-&gt;read_cp15(target, 0, 0, 5, 0, &amp;dfsr);
 	armv7a-&gt;read_cp15(target, 0, 1, 5, 0, &amp;ifsr);
@@ -200,8 +197,8 @@ int armv7a_arch_state(struct target_s *target)
 		&quot;disabled&quot;, &quot;enabled&quot;
 	};
 
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
+	struct armv4_5_common_s *armv4_5 = &amp;armv7a-&gt;armv4_5_common;
 
 	if (armv4_5-&gt;common_magic != ARMV4_5_COMMON_MAGIC)
 	{
@@ -237,8 +234,7 @@ static int handle_dap_baseaddr_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	return dap_baseaddr_command(cmd_ctx, swjdp, args, argc);
@@ -248,8 +244,7 @@ static int handle_dap_memaccess_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	return dap_memaccess_command(cmd_ctx, swjdp, args, argc);
@@ -259,8 +254,7 @@ static int handle_dap_apsel_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	return dap_apsel_command(cmd_ctx, swjdp, args, argc);
@@ -270,8 +264,7 @@ static int handle_dap_apid_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	return dap_apid_command(cmd_ctx, swjdp, args, argc);
@@ -281,8 +274,7 @@ static int handle_dap_info_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 	uint32_t apsel;
 
@@ -305,7 +297,7 @@ handle_armv7a_disassemble_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 	int thumb = 0;
 	int count = 1;
 	uint32_t address;
@@ -342,7 +334,7 @@ handle_armv7a_disassemble_command(struct command_context_s *cmd_ctx,
 	default:
 usage:
 		command_print(cmd_ctx,
-			&quot;usage: armv4_5 disassemble &lt;address&gt; [&lt;count&gt; ['thumb']]&quot;);
+			&quot;usage: armv7a disassemble &lt;address&gt; [&lt;count&gt; ['thumb']]&quot;);
 		return ERROR_OK;
 	}
 
diff --git a/src/target/armv7a.h b/src/target/armv7a.h
index 3fc97f1..2ad0321 100644
--- a/src/target/armv7a.h
+++ b/src/target/armv7a.h
@@ -107,7 +107,6 @@ typedef struct armv7a_common_s
 	/* Cache and Memory Management Unit */
 	armv4_5_mmu_common_t armv4_5_mmu;
 	armv4_5_common_t armv4_5_common;
-	void *arch_info;
 
 //	int (*full_context)(struct target_s *target);
 //	int (*read_core_reg)(struct target_s *target, int num, enum armv7a_mode mode);
diff --git a/src/target/cortex_a8.c b/src/target/cortex_a8.c
index 29fffae..141b439 100644
--- a/src/target/cortex_a8.c
+++ b/src/target/cortex_a8.c
@@ -128,9 +128,7 @@ target_type_t cortexa8_target =
  */
 int cortex_a8_init_debug_access(target_t *target)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	int retval;
@@ -160,9 +158,7 @@ int cortex_a8_exec_opcode(target_t *target, uint32_t opcode)
 {
 	uint32_t dscr;
 	int retval;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	LOG_DEBUG(&quot;exec opcode 0x%08&quot; PRIx32, opcode);
@@ -203,9 +199,7 @@ int cortex_a8_read_regs_through_mem(target_t *target, uint32_t address,
 		uint32_t * regfile)
 {
 	int retval = ERROR_OK;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	cortex_a8_dap_read_coreregister_u32(target, regfile, 0);
@@ -222,9 +216,7 @@ int cortex_a8_read_cp(target_t *target, uint32_t *value, uint8_t CP,
 		uint8_t op1, uint8_t CRn, uint8_t CRm, uint8_t op2)
 {
 	int retval;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	cortex_a8_exec_opcode(target, ARMV4_5_MRC(CP, op1, 0, CRn, CRm, op2));
@@ -243,10 +235,7 @@ int cortex_a8_write_cp(target_t *target, uint32_t value,
 {
 	int retval;
 	uint32_t dscr;
-
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	LOG_DEBUG(&quot;CP%i, CRn %i, value 0x%08&quot; PRIx32, CP, CRn, value);
@@ -310,10 +299,7 @@ int cortex_a8_dap_read_coreregister_u32(target_t *target,
 	int retval = ERROR_OK;
 	uint8_t reg = regnum&amp;0xFF;
 	uint32_t dscr;
-
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	if (reg &gt; 16)
@@ -354,10 +340,7 @@ int cortex_a8_dap_write_coreregister_u32(target_t *target, uint32_t value, int r
 	int retval = ERROR_OK;
 	uint8_t Rd = regnum&amp;0xFF;
 	uint32_t dscr;
-
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	LOG_DEBUG(&quot;register %i, value 0x%08&quot; PRIx32, regnum, value);
@@ -404,10 +387,7 @@ int cortex_a8_dap_write_coreregister_u32(target_t *target, uint32_t value, int r
 int cortex_a8_dap_write_memap_register_u32(target_t *target, uint32_t address, uint32_t value)
 {
 	int retval;
-
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	retval = mem_ap_write_atomic_u32(swjdp, address, value);
@@ -423,16 +403,12 @@ int cortex_a8_poll(target_t *target)
 {
 	int retval = ERROR_OK;
 	uint32_t dscr;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
-	cortex_a8_common_t *cortex_a8 = armv7a-&gt;arch_info;
+	struct cortex_a8_common_s *cortex_a8 = target_to_cortex_a8(target);
+	struct armv7a_common_s *armv7a = &amp;cortex_a8-&gt;armv7a_common;
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
-
-
 	enum target_state prev_target_state = target-&gt;state;
-
 	uint8_t saved_apsel = dap_ap_get_select(swjdp);
+
 	dap_ap_select(swjdp, swjdp_debugap);
 	retval = mem_ap_read_atomic_u32(swjdp,
 			armv7a-&gt;debug_base + CPUDBG_DSCR, &amp;dscr);
@@ -492,12 +468,8 @@ int cortex_a8_halt(target_t *target)
 {
 	int retval = ERROR_OK;
 	uint32_t dscr;
-
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
-
 	uint8_t saved_apsel = dap_ap_get_select(swjdp);
 	dap_ap_select(swjdp, swjdp_debugap);
 
@@ -533,9 +505,8 @@ out:
 int cortex_a8_resume(struct target_s *target, int current,
 		uint32_t address, int handle_breakpoints, int debug_execution)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
+	struct armv4_5_common_s *armv4_5 = &amp;armv7a-&gt;armv4_5_common;
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 //	breakpoint_t *breakpoint = NULL;
@@ -658,11 +629,9 @@ int cortex_a8_debug_entry(target_t *target)
 	uint32_t regfile[16], pc, cpsr, dscr;
 	int retval = ERROR_OK;
 	working_area_t *regfile_working_area = NULL;
-
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
-	cortex_a8_common_t *cortex_a8 = armv7a-&gt;arch_info;
+	struct cortex_a8_common_s *cortex_a8 = target_to_cortex_a8(target);
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
+	struct armv4_5_common_s *armv4_5 = &amp;armv7a-&gt;armv4_5_common;
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	LOG_DEBUG(&quot;dscr = 0x%08&quot; PRIx32, cortex_a8-&gt;cpudbg_dscr);
@@ -785,10 +754,8 @@ int cortex_a8_debug_entry(target_t *target)
 
 void cortex_a8_post_debug_entry(target_t *target)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
-	cortex_a8_common_t *cortex_a8 = armv7a-&gt;arch_info;
+	struct cortex_a8_common_s *cortex_a8 = target_to_cortex_a8(target);
+	struct armv7a_common_s *armv7a = &amp;cortex_a8-&gt;armv7a_common;
 
 //	cortex_a8_read_cp(target, &amp;cp15_control_register, 15, 0, 1, 0, 0);
 	/* examine cp15 control reg */
@@ -820,9 +787,8 @@ void cortex_a8_post_debug_entry(target_t *target)
 int cortex_a8_step(struct target_s *target, int current, uint32_t address,
 		int handle_breakpoints)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
+	struct armv4_5_common_s *armv4_5 = &amp;armv7a-&gt;armv4_5_common;
 	breakpoint_t *breakpoint = NULL;
 	breakpoint_t stepbreakpoint;
 
@@ -901,10 +867,8 @@ int cortex_a8_restore_context(target_t *target)
 {
 	int i;
 	uint32_t value;
-
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
+	struct armv4_5_common_s *armv4_5 = &amp;armv7a-&gt;armv4_5_common;
 
 	LOG_DEBUG(&quot; &quot;);
 
@@ -939,8 +903,7 @@ int cortex_a8_load_core_reg_u32(struct target_s *target, int num,
 		armv4_5_mode_t mode, uint32_t * value)
 {
 	int retval;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 
 	if ((num &lt;= ARM_CPSR))
 	{
@@ -978,9 +941,7 @@ int cortex_a8_store_core_reg_u32(struct target_s *target, int num,
 {
 	int retval;
 //	uint32_t reg;
-
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 
 #ifdef ARMV7_GDB_HACKS
 	/* If the LR register is being modified, make sure it will put us
@@ -1021,7 +982,8 @@ int cortex_a8_read_core_reg(struct target_s *target, int num,
 {
 	uint32_t value;
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+
 	cortex_a8_dap_read_coreregister_u32(target, &amp;value, num);
 
 	if ((retval = jtag_execute_queue()) != ERROR_OK)
@@ -1041,7 +1003,7 @@ int cortex_a8_write_core_reg(struct target_s *target, int num,
 		enum armv4_5_mode mode, uint32_t value)
 {
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 
 	cortex_a8_dap_write_coreregister_u32(target, value, num);
 	if ((retval = jtag_execute_queue()) != ERROR_OK)
@@ -1068,12 +1030,8 @@ int cortex_a8_set_breakpoint(struct target_s *target,
 	int brp_i=0;
 	uint32_t control;
 	uint8_t byte_addr_select = 0x0F;
-
-
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
-	cortex_a8_common_t *cortex_a8 = armv7a-&gt;arch_info;
+	struct cortex_a8_common_s *cortex_a8 = target_to_cortex_a8(target);
+	struct armv7a_common_s *armv7a = &amp;cortex_a8-&gt;armv7a_common;
 	cortex_a8_brp_t * brp_list = cortex_a8-&gt;brp_list;
 
 	if (breakpoint-&gt;set)
@@ -1143,10 +1101,8 @@ int cortex_a8_set_breakpoint(struct target_s *target,
 int cortex_a8_unset_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 {
 	int retval;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
-	cortex_a8_common_t *cortex_a8 = armv7a-&gt;arch_info;
+	struct cortex_a8_common_s *cortex_a8 = target_to_cortex_a8(target);
+	struct armv7a_common_s *armv7a = &amp;cortex_a8-&gt;armv7a_common;
 	cortex_a8_brp_t * brp_list = cortex_a8-&gt;brp_list;
 
 	if (!breakpoint-&gt;set)
@@ -1202,10 +1158,7 @@ int cortex_a8_unset_breakpoint(struct target_s *target, breakpoint_t *breakpoint
 
 int cortex_a8_add_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
-	cortex_a8_common_t *cortex_a8 = armv7a-&gt;arch_info;
+	struct cortex_a8_common_s *cortex_a8 = target_to_cortex_a8(target);
 
 	if ((breakpoint-&gt;type == BKPT_HARD) &amp;&amp; (cortex_a8-&gt;brp_num_available &lt; 1))
 	{
@@ -1222,10 +1175,7 @@ int cortex_a8_add_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 
 int cortex_a8_remove_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
-	cortex_a8_common_t *cortex_a8 = armv7a-&gt;arch_info;
+	struct cortex_a8_common_s *cortex_a8 = target_to_cortex_a8(target);
 
 #if 0
 /* It is perfectly possible to remove brakpoints while the taget is running */
@@ -1291,9 +1241,7 @@ int cortex_a8_deassert_reset(target_t *target)
 int cortex_a8_read_memory(struct target_s *target, uint32_t address,
 		uint32_t size, uint32_t count, uint8_t *buffer)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	int retval = ERROR_OK;
@@ -1328,9 +1276,7 @@ int cortex_a8_read_memory(struct target_s *target, uint32_t address,
 int cortex_a8_write_memory(struct target_s *target, uint32_t address,
 		uint32_t size, uint32_t count, uint8_t *buffer)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 	int retval;
@@ -1416,11 +1362,9 @@ int cortex_a8_handle_target_request(void *priv)
 	target_t *target = priv;
 	if (!target-&gt;type-&gt;examined)
 		return ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
-
 	if (!target-&gt;dbg_msg_enabled)
 		return ERROR_OK;
 
@@ -1457,13 +1401,9 @@ int cortex_a8_handle_target_request(void *priv)
 
 int cortex_a8_examine(struct target_s *target)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
-	cortex_a8_common_t *cortex_a8 = armv7a-&gt;arch_info;
+	struct cortex_a8_common_s *cortex_a8 = target_to_cortex_a8(target);
+	struct armv7a_common_s *armv7a = &amp;cortex_a8-&gt;armv7a_common;
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
-
-
 	int i;
 	int retval = ERROR_OK;
 	uint32_t didr, ctypr, ttypr, cpuid;
@@ -1559,8 +1499,7 @@ int cortex_a8_examine(struct target_s *target)
 void cortex_a8_build_reg_cache(target_t *target)
 {
 	reg_cache_t **cache_p = register_get_last_cache_p(&amp;target-&gt;reg_cache);
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 
 	(*cache_p) = armv4_5_build_reg_cache(target, armv4_5);
 	armv4_5-&gt;core_cache = (*cache_p);
@@ -1586,8 +1525,6 @@ int cortex_a8_init_arch_info(target_t *target,
 
 	/* Setup cortex_a8_common_t */
 	cortex_a8-&gt;common_magic = CORTEX_A8_COMMON_MAGIC;
-	cortex_a8-&gt;arch_info = NULL;
-	armv7a-&gt;arch_info = cortex_a8;
 	armv4_5-&gt;arch_info = armv7a;
 
 	armv4_5_init_arch_info(target, armv4_5);
@@ -1656,8 +1593,7 @@ static int cortex_a8_handle_cache_info_command(struct command_context_s *cmd_ctx
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	armv7a_common_t *armv7a = armv4_5-&gt;arch_info;
+	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 
 	return armv4_5_handle_cache_info_command(cmd_ctx,
 			&amp;armv7a-&gt;armv4_5_mmu.armv4_5_cache);
diff --git a/src/target/cortex_a8.h b/src/target/cortex_a8.h
index b98a7de..b4cb327 100644
--- a/src/target/cortex_a8.h
+++ b/src/target/cortex_a8.h
@@ -134,7 +134,6 @@ typedef struct cortex_a8_common_s
 	int fast_reg_read;
 
 	armv7a_common_t armv7a_common;
-	void *arch_info;
 } cortex_a8_common_t;
 
 static inline struct cortex_a8_common_s *

commit fec3c4763ad4cf2996fa138c4fd0f555e32e5e9f
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Thu Nov 5 22:04:04 2009 -0800

    ARM7TDMI uses the new inheritance/nesting scheme
    
    Use target_to_arm7_9(), replacing needless pointer traversals.
    
    Also:  remove now-useless contents of arm7tdmi struct; it's
    almost ready to be removed.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/arm7tdmi.c b/src/target/arm7tdmi.c
index 27a8337..8b929d4 100644
--- a/src/target/arm7tdmi.c
+++ b/src/target/arm7tdmi.c
@@ -44,9 +44,7 @@
 static int arm7tdmi_examine_debug_reason(target_t *target)
 {
 	int retval = ERROR_OK;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 
 	/* only check the debug reason if we don't know it already */
 	if ((target-&gt;debug_reason != DBG_REASON_DBGRQ)
@@ -268,9 +266,7 @@ static int arm7tdmi_clock_data_in_endianness(arm_jtag_t *jtag_info,
 static void arm7tdmi_change_to_arm(target_t *target,
 		uint32_t *r0, uint32_t *pc)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* save r0 before using it and put system in ARM state
@@ -327,9 +323,7 @@ static void arm7tdmi_read_core_regs(target_t *target,
 		uint32_t mask, uint32_t* core_regs[16])
 {
 	int i;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* STMIA r0-15, [r0] at debug speed
@@ -354,9 +348,7 @@ static void arm7tdmi_read_core_regs_target_buffer(target_t *target,
 		uint32_t mask, void* buffer, int size)
 {
 	int i;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	int be = (target-&gt;endianness == TARGET_BIG_ENDIAN) ? 1 : 0;
 	uint32_t *buf_u32 = buffer;
@@ -396,9 +388,7 @@ static void arm7tdmi_read_core_regs_target_buffer(target_t *target,
 
 static void arm7tdmi_read_xpsr(target_t *target, uint32_t *xpsr, int spsr)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* MRS r0, cpsr */
@@ -416,9 +406,7 @@ static void arm7tdmi_read_xpsr(target_t *target, uint32_t *xpsr, int spsr)
 
 static void arm7tdmi_write_xpsr(target_t *target, uint32_t xpsr, int spsr)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	LOG_DEBUG(&quot;xpsr: %8.8&quot; PRIx32 &quot;, spsr: %i&quot;, xpsr, spsr);
@@ -448,9 +436,7 @@ static void arm7tdmi_write_xpsr(target_t *target, uint32_t xpsr, int spsr)
 static void arm7tdmi_write_xpsr_im8(target_t *target,
 		uint8_t xpsr_im, int rot, int spsr)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	LOG_DEBUG(&quot;xpsr_im: %2.2x, rot: %i, spsr: %i&quot;, xpsr_im, rot, spsr);
@@ -469,9 +455,7 @@ static void arm7tdmi_write_core_regs(target_t *target,
 		uint32_t mask, uint32_t core_regs[16])
 {
 	int i;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* LDMIA r0-15, [r0] at debug speed
@@ -495,9 +479,7 @@ static void arm7tdmi_write_core_regs(target_t *target,
 
 static void arm7tdmi_load_word_regs(target_t *target, uint32_t mask)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* put system-speed load-multiple into the pipeline */
@@ -508,9 +490,7 @@ static void arm7tdmi_load_word_regs(target_t *target, uint32_t mask)
 
 static void arm7tdmi_load_hword_reg(target_t *target, int num)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* put system-speed load half-word into the pipeline */
@@ -521,9 +501,7 @@ static void arm7tdmi_load_hword_reg(target_t *target, int num)
 
 static void arm7tdmi_load_byte_reg(target_t *target, int num)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* put system-speed load byte into the pipeline */
@@ -534,9 +512,7 @@ static void arm7tdmi_load_byte_reg(target_t *target, int num)
 
 static void arm7tdmi_store_word_regs(target_t *target, uint32_t mask)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* put system-speed store-multiple into the pipeline */
@@ -547,9 +523,7 @@ static void arm7tdmi_store_word_regs(target_t *target, uint32_t mask)
 
 static void arm7tdmi_store_hword_reg(target_t *target, int num)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* put system-speed store half-word into the pipeline */
@@ -560,9 +534,7 @@ static void arm7tdmi_store_hword_reg(target_t *target, int num)
 
 static void arm7tdmi_store_byte_reg(target_t *target, int num)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* put system-speed store byte into the pipeline */
@@ -573,9 +545,7 @@ static void arm7tdmi_store_byte_reg(target_t *target, int num)
 
 static void arm7tdmi_write_pc(target_t *target, uint32_t pc)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* LDMIA r0-15, [r0] at debug speed
@@ -600,9 +570,7 @@ static void arm7tdmi_write_pc(target_t *target, uint32_t pc)
 
 static void arm7tdmi_branch_resume(target_t *target)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	arm7tdmi_clock_out(jtag_info, ARMV4_5_NOP, NULL, 1);
@@ -611,14 +579,13 @@ static void arm7tdmi_branch_resume(target_t *target)
 
 static void arm7tdmi_branch_resume_thumb(target_t *target)
 {
-	LOG_DEBUG(&quot;-&quot;);
-
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	reg_t *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 
+	LOG_DEBUG(&quot;-&quot;);
+
 	/* LDMIA r0, [r0] at debug speed
 	 * register values will start to appear on 4th DCLK
 	 */
@@ -673,8 +640,7 @@ static void arm7tdmi_branch_resume_thumb(target_t *target)
 static void arm7tdmi_build_reg_cache(target_t *target)
 {
 	reg_cache_t **cache_p = register_get_last_cache_p(&amp;target-&gt;reg_cache);
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 
 	(*cache_p) = armv4_5_build_reg_cache(target, armv4_5);
 	armv4_5-&gt;core_cache = (*cache_p);
@@ -682,9 +648,10 @@ static void arm7tdmi_build_reg_cache(target_t *target)
 
 int arm7tdmi_examine(struct target_s *target)
 {
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+
+
 	if (!target_was_examined(target))
 	{
 		/* get pointers to arch-specific information */
@@ -725,11 +692,7 @@ int arm7tdmi_init_target(struct command_context_s *cmd_ctx, struct target_s *tar
 
 int arm7tdmi_init_arch_info(target_t *target, arm7tdmi_common_t *arm7tdmi, jtag_tap_t *tap)
 {
-	armv4_5_common_t *armv4_5;
-	arm7_9_common_t *arm7_9;
-
-	arm7_9 = &amp;arm7tdmi-&gt;arm7_9_common;
-	armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm7_9_common_s *arm7_9 = &amp;arm7tdmi-&gt;arm7_9_common;
 
 	/* prepare JTAG information for the new target */
 	arm7_9-&gt;jtag_info.tap = tap;
@@ -771,10 +734,6 @@ int arm7tdmi_init_arch_info(target_t *target, arm7tdmi_common_t *arm7tdmi, jtag_
 	arm7_9-&gt;thumb_bkpt = 0xdeee;
 
 	arm7_9-&gt;dbgreq_adjust_pc = 2;
-	arm7_9-&gt;arch_info = arm7tdmi;
-
-	arm7tdmi-&gt;arch_info = NULL;
-	arm7tdmi-&gt;common_magic = ARM7TDMI_COMMON_MAGIC;
 
 	arm7_9_init_arch_info(target, arm7_9);
 
diff --git a/src/target/arm7tdmi.h b/src/target/arm7tdmi.h
index da5c040..f69ba49 100644
--- a/src/target/arm7tdmi.h
+++ b/src/target/arm7tdmi.h
@@ -25,12 +25,11 @@
 
 #include &quot;embeddedice.h&quot;
 
-#define	ARM7TDMI_COMMON_MAGIC 0x00a700a7
-
+/* FIXME we don't really need a separate arm7tdmi struct any more...
+ * remove it, the arm7/arm9 common struct suffices.
+ */
 typedef struct arm7tdmi_common_s
 {
-	int common_magic;
-	void *arch_info;
 	arm7_9_common_t arm7_9_common;
 } arm7tdmi_common_t;
 

commit 11fe2ec62e30e4b580ace6821ac4293ed91d53f1
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Thu Nov 5 22:03:56 2009 -0800

    ARM720 uses the new inheritance/nesting scheme
    
    Use target_to_arm720(), replacing needless pointer traversals
    and simplifying a bunch of nasty code.  Stop setting arch_info
    for arm720 type parts, it's not used any longer.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/arm720t.c b/src/target/arm720t.c
index cb21d5f..673296e 100644
--- a/src/target/arm720t.c
+++ b/src/target/arm720t.c
@@ -41,14 +41,15 @@
 static int arm720t_scan_cp15(target_t *target,
 		uint32_t out, uint32_t *in, int instruction, int clock)
 {
-	int retval = ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
+	int retval;
+	struct arm720t_common_s *arm720t = target_to_arm720(target);
+	arm_jtag_t *jtag_info;
 	scan_field_t fields[2];
 	uint8_t out_buf[4];
 	uint8_t instruction_buf = instruction;
 
+	jtag_info = &amp;arm720t-&gt;arm7tdmi_common.arm7_9_common.jtag_info;
+
 	buf_set_u32(out_buf, 0, 32, flip_u32(out, 32));
 
 	jtag_set_end_state(TAP_DRPAUSE);
@@ -184,10 +185,7 @@ static void arm720t_enable_mmu_caches(target_t *target,
 
 static void arm720t_post_debug_entry(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm7tdmi_common_t *arm7tdmi = arm7_9-&gt;arch_info;
-	arm720t_common_t *arm720t = arm7tdmi-&gt;arch_info;
+	struct arm720t_common_s *arm720t = target_to_arm720(target);
 
 	/* examine cp15 control reg */
 	arm720t_read_cp15(target, 0xee110f10, &amp;arm720t-&gt;cp15_control_reg);
@@ -206,68 +204,35 @@ static void arm720t_post_debug_entry(target_t *target)
 
 static void arm720t_pre_restore_context(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm7tdmi_common_t *arm7tdmi = arm7_9-&gt;arch_info;
-	arm720t_common_t *arm720t = arm7tdmi-&gt;arch_info;
+	struct arm720t_common_s *arm720t = target_to_arm720(target);
 
 	/* restore i/d fault status and address register */
 	arm720t_write_cp15(target, 0xee050f10, arm720t-&gt;fsr_reg);
 	arm720t_write_cp15(target, 0xee060f10, arm720t-&gt;far_reg);
 }
 
-static int arm720t_get_arch_pointers(target_t *target,
-		armv4_5_common_t **armv4_5_p, arm7_9_common_t **arm7_9_p,
-		arm7tdmi_common_t **arm7tdmi_p, arm720t_common_t **arm720t_p)
+static int arm720t_verify_pointer(struct command_context_s *cmd_ctx,
+		struct arm720t_common_s *arm720t)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9;
-	arm7tdmi_common_t *arm7tdmi;
-	arm720t_common_t *arm720t;
-
-	if (armv4_5-&gt;common_magic != ARMV4_5_COMMON_MAGIC)
-	{
-		return -1;
-	}
-
-	arm7_9 = armv4_5-&gt;arch_info;
-	if (arm7_9-&gt;common_magic != ARM7_9_COMMON_MAGIC)
-	{
-		return -1;
-	}
-
-	arm7tdmi = arm7_9-&gt;arch_info;
-	if (arm7tdmi-&gt;common_magic != ARM7TDMI_COMMON_MAGIC)
-	{
-		return -1;
-	}
-
-	arm720t = arm7tdmi-&gt;arch_info;
-	if (arm720t-&gt;common_magic != ARM720T_COMMON_MAGIC)
-	{
-		return -1;
+	if (arm720t-&gt;common_magic != ARM720T_COMMON_MAGIC) {
+		command_print(cmd_ctx, &quot;target is not an ARM720&quot;);
+		return ERROR_TARGET_INVALID;
 	}
-
-	*armv4_5_p = armv4_5;
-	*arm7_9_p = arm7_9;
-	*arm7tdmi_p = arm7tdmi;
-	*arm720t_p = arm720t;
-
 	return ERROR_OK;
 }
 
 static int arm720t_arch_state(struct target_s *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm7tdmi_common_t *arm7tdmi = arm7_9-&gt;arch_info;
-	arm720t_common_t *arm720t = arm7tdmi-&gt;arch_info;
+	struct arm720t_common_s *arm720t = target_to_arm720(target);
+	struct armv4_5_common_s *armv4_5;
 
 	static const char *state[] =
 	{
 		&quot;disabled&quot;, &quot;enabled&quot;
 	};
 
+	armv4_5 = &amp;arm720t-&gt;arm7tdmi_common.arm7_9_common.armv4_5_common;
+
 	LOG_USER(&quot;target halted in %s state due to %s, current mode: %s\n&quot;
 			&quot;cpsr: 0x%8.8&quot; PRIx32 &quot; pc: 0x%8.8&quot; PRIx32 &quot;\n&quot;
 			&quot;MMU: %s, Cache: %s&quot;,
@@ -286,10 +251,7 @@ static int arm720t_read_memory(struct target_s *target,
 		uint32_t address, uint32_t size, uint32_t count, uint8_t *buffer)
 {
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm7tdmi_common_t *arm7tdmi = arm7_9-&gt;arch_info;
-	arm720t_common_t *arm720t = arm7tdmi-&gt;arch_info;
+	struct arm720t_common_s *arm720t = target_to_arm720(target);
 
 	/* disable cache, but leave MMU enabled */
 	if (arm720t-&gt;armv4_5_mmu.armv4_5_cache.d_u_cache_enabled)
@@ -306,10 +268,7 @@ static int arm720t_read_memory(struct target_s *target,
 static int arm720t_read_phys_memory(struct target_s *target,
 		uint32_t address, uint32_t size, uint32_t count, uint8_t *buffer)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm7tdmi_common_t *arm7tdmi = arm7_9-&gt;arch_info;
-	arm720t_common_t *arm720t = arm7tdmi-&gt;arch_info;
+	struct arm720t_common_s *arm720t = target_to_arm720(target);
 
 	return armv4_5_mmu_read_physical(target, &amp;arm720t-&gt;armv4_5_mmu, address, size, count, buffer);
 }
@@ -317,10 +276,7 @@ static int arm720t_read_phys_memory(struct target_s *target,
 static int arm720t_write_phys_memory(struct target_s *target,
 		uint32_t address, uint32_t size, uint32_t count, uint8_t *buffer)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm7tdmi_common_t *arm7tdmi = arm7_9-&gt;arch_info;
-	arm720t_common_t *arm720t = arm7tdmi-&gt;arch_info;
+	struct arm720t_common_s *arm720t = target_to_arm720(target);
 
 	return armv4_5_mmu_write_physical(target, &amp;arm720t-&gt;armv4_5_mmu, address, size, count, buffer);
 }
@@ -328,11 +284,11 @@ static int arm720t_write_phys_memory(struct target_s *target,
 static int arm720t_soft_reset_halt(struct target_s *target)
 {
 	int retval = ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm7tdmi_common_t *arm7tdmi = arm7_9-&gt;arch_info;
-	arm720t_common_t *arm720t = arm7tdmi-&gt;arch_info;
-	reg_t *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
+	struct arm720t_common_s *arm720t = target_to_arm720(target);
+	reg_t *dbg_stat = &amp;arm720t-&gt;arm7tdmi_common.arm7_9_common
+			.eice_cache-&gt;reg_list[EICE_DBG_STAT];
+	struct armv4_5_common_s *armv4_5 = &amp;arm720t-&gt;arm7tdmi_common
+			.arm7_9_common.armv4_5_common;
 
 	if ((retval = target_halt(target)) != ERROR_OK)
 	{
@@ -409,7 +365,6 @@ static int arm720t_init_arch_info(target_t *target,
 
 	arm7tdmi_init_arch_info(target, arm7tdmi, tap);
 
-	arm7tdmi-&gt;arch_info = arm720t;
 	arm720t-&gt;common_magic = ARM720T_COMMON_MAGIC;
 
 	arm7_9-&gt;post_debug_entry = arm720t_post_debug_entry;
@@ -429,7 +384,7 @@ static int arm720t_init_arch_info(target_t *target,
 
 static int arm720t_target_create(struct target_s *target, Jim_Interp *interp)
 {
-	arm720t_common_t *arm720t = calloc(1,sizeof(arm720t_common_t));
+	struct arm720t_common_s *arm720t = target_to_arm720(target);
 
 	return arm720t_init_arch_info(target, arm720t, target-&gt;tap);
 }
@@ -439,19 +394,14 @@ static int arm720t_handle_cp15_command(struct command_context_s *cmd_ctx,
 {
 	int retval;
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	arm7_9_common_t *arm7_9;
-	arm7tdmi_common_t *arm7tdmi;
-	arm720t_common_t *arm720t;
+	struct arm720t_common_s *arm720t = target_to_arm720(target);
 	arm_jtag_t *jtag_info;
 
-	if (arm720t_get_arch_pointers(target, &amp;armv4_5, &amp;arm7_9, &amp;arm7tdmi, &amp;arm720t) != ERROR_OK)
-	{
-		command_print(cmd_ctx, &quot;current target isn't an ARM720t target&quot;);
-		return ERROR_OK;
-	}
+	retval = arm720t_verify_pointer(cmd_ctx, arm720t);
+	if (retval != ERROR_OK)
+		return retval;
 
-	jtag_info = &amp;arm7_9-&gt;jtag_info;
+	jtag_info = &amp;arm720t-&gt;arm7tdmi_common.arm7_9_common.jtag_info;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{

commit 6cf956fa9d0d0a0eddaf0c8878f25c549c005c62
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Thu Nov 5 22:03:45 2009 -0800

    XScale uses the new inheritance/nesting scheme
    
    Use target_to_xscale(), replacing needless pointer traversals
    and simplifying a bunch of code.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/xscale.c b/src/target/xscale.c
index 78c2124..0dc18f0 100644
--- a/src/target/xscale.c
+++ b/src/target/xscale.c
@@ -144,28 +144,15 @@ static int xscale_set_reg_u32(reg_t *reg, uint32_t value)
 	return xscale_set_reg(reg, buf);
 }
 
+static const char xscale_not[] = &quot;target is not an XScale&quot;;
 
-static int xscale_get_arch_pointers(target_t *target,
-		armv4_5_common_t **armv4_5_p, xscale_common_t **xscale_p)
+static int xscale_verify_pointer(struct command_context_s *cmd_ctx,
+		struct xscale_common_s *xscale)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
-
-	if (armv4_5-&gt;common_magic != ARMV4_5_COMMON_MAGIC)
-	{
-		LOG_ERROR(&quot;target isn't an XScale target&quot;);
-		return -1;
-	}
-
-	if (xscale-&gt;common_magic != XSCALE_COMMON_MAGIC)
-	{
-		LOG_ERROR(&quot;target isn't an XScale target&quot;);
-		return -1;
+	if (xscale-&gt;common_magic != XSCALE_COMMON_MAGIC) {
+		command_print(cmd_ctx, xscale_not);
+		return ERROR_TARGET_INVALID;
 	}
-
-	*armv4_5_p = armv4_5;
-	*xscale_p = xscale;
-
 	return ERROR_OK;
 }
 
@@ -193,8 +180,7 @@ static int xscale_jtag_set_instr(jtag_tap_t *tap, uint32_t new_instr)
 
 static int xscale_read_dcsr(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	int retval;
 	scan_field_t fields[3];
 	uint8_t field0 = 0x0;
@@ -371,8 +357,7 @@ static int xscale_receive(target_t *target, uint32_t *buffer, int num_words)
 
 static int xscale_read_tx(target_t *target, int consume)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	tap_state_t path[3];
 	tap_state_t noconsume_path[6];
 	int retval;
@@ -470,8 +455,7 @@ static int xscale_read_tx(target_t *target, int consume)
 
 static int xscale_write_rx(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	int retval;
 	struct timeval timeout, now;
 	scan_field_t fields[3];
@@ -620,8 +604,7 @@ static int xscale_send(target_t *target, uint8_t *buffer, int count, int size)
 
 static int xscale_send_u32(target_t *target, uint32_t value)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 
 	buf_set_u32(xscale-&gt;reg_cache-&gt;reg_list[XSCALE_RX].value, 0, 32, value);
 	return xscale_write_rx(target);
@@ -629,8 +612,7 @@ static int xscale_send_u32(target_t *target, uint32_t value)
 
 static int xscale_write_dcsr(target_t *target, int hold_rst, int ext_dbg_brk)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	int retval;
 	scan_field_t fields[3];
 	uint8_t field0 = 0x0;
@@ -786,8 +768,7 @@ static int xscale_invalidate_ic_line(target_t *target, uint32_t va)
 
 static int xscale_update_vectors(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	int i;
 	int retval;
 
@@ -851,8 +832,8 @@ static int xscale_update_vectors(target_t *target)
 
 static int xscale_arch_state(struct target_s *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
+	struct armv4_5_common_s *armv4_5 = &amp;xscale-&gt;armv4_5_common;
 
 	static const char *state[] =
 	{
@@ -929,13 +910,12 @@ static int xscale_poll(target_t *target)
 
 static int xscale_debug_entry(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
+	struct armv4_5_common_s *armv4_5 = &amp;xscale-&gt;armv4_5_common;
 	uint32_t pc;
 	uint32_t buffer[10];
 	int i;
 	int retval;
-
 	uint32_t moe;
 
 	/* clear external dbg break (will be written on next DCSR read) */
@@ -1110,8 +1090,7 @@ static int xscale_debug_entry(target_t *target)
 
 static int xscale_halt(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 
 	LOG_DEBUG(&quot;target-&gt;state: %s&quot;,
 		  target_state_name(target));
@@ -1145,8 +1124,7 @@ static int xscale_halt(target_t *target)
 
 static int xscale_enable_single_step(struct target_s *target, uint32_t next_pc)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale= armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	reg_t *ibcr0 = &amp;xscale-&gt;reg_cache-&gt;reg_list[XSCALE_IBCR0];
 	int retval;
 
@@ -1173,8 +1151,7 @@ static int xscale_enable_single_step(struct target_s *target, uint32_t next_pc)
 
 static int xscale_disable_single_step(struct target_s *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale= armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	reg_t *ibcr0 = &amp;xscale-&gt;reg_cache-&gt;reg_list[XSCALE_IBCR0];
 	int retval;
 
@@ -1212,12 +1189,10 @@ static void xscale_enable_breakpoints(struct target_s *target)
 static int xscale_resume(struct target_s *target, int current,
 		uint32_t address, int handle_breakpoints, int debug_execution)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale= armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
+	struct armv4_5_common_s *armv4_5 = &amp;xscale-&gt;armv4_5_common;
 	breakpoint_t *breakpoint = target-&gt;breakpoints;
-
 	uint32_t current_pc;
-
 	int retval;
 	int i;
 
@@ -1367,9 +1342,8 @@ static int xscale_resume(struct target_s *target, int current,
 static int xscale_step_inner(struct target_s *target, int current,
 		uint32_t address, int handle_breakpoints)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
-
+	struct xscale_common_s *xscale = target_to_xscale(target);
+	struct armv4_5_common_s *armv4_5 = &amp;xscale-&gt;armv4_5_common;
 	uint32_t next_pc;
 	int retval;
 	int i;
@@ -1448,7 +1422,7 @@ static int xscale_step_inner(struct target_s *target, int current,
 static int xscale_step(struct target_s *target, int current,
 		uint32_t address, int handle_breakpoints)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 	breakpoint_t *breakpoint = target-&gt;breakpoints;
 
 	uint32_t current_pc;
@@ -1502,8 +1476,7 @@ static int xscale_step(struct target_s *target, int current,
 
 static int xscale_assert_reset(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 
 	LOG_DEBUG(&quot;target-&gt;state: %s&quot;,
 		  target_state_name(target));
@@ -1544,8 +1517,7 @@ static int xscale_assert_reset(target_t *target)
 
 static int xscale_deassert_reset(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	breakpoint_t *breakpoint = target-&gt;breakpoints;
 
 	LOG_DEBUG(&quot;-&quot;);
@@ -1693,7 +1665,7 @@ static int xscale_write_core_reg(struct target_s *target, int num,
 
 static int xscale_full_context(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 
 	uint32_t *buffer;
 
@@ -1769,7 +1741,7 @@ static int xscale_full_context(target_t *target)
 
 static int xscale_restore_context(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 
 	int i, j;
 
@@ -1837,8 +1809,7 @@ static int xscale_restore_context(target_t *target)
 static int xscale_read_memory(struct target_s *target, uint32_t address,
 		uint32_t size, uint32_t count, uint8_t *buffer)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	uint32_t *buf32;
 	uint32_t i;
 	int retval;
@@ -1917,8 +1888,7 @@ static int xscale_read_memory(struct target_s *target, uint32_t address,
 static int xscale_write_memory(struct target_s *target, uint32_t address,
 		uint32_t size, uint32_t count, uint8_t *buffer)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	int retval;
 
 	LOG_DEBUG(&quot;address: 0x%8.8&quot; PRIx32 &quot;, size: 0x%8.8&quot; PRIx32 &quot;, count: 0x%8.8&quot; PRIx32, address, size, count);
@@ -2001,8 +1971,7 @@ static int xscale_bulk_write_memory(target_t *target, uint32_t address,
 
 static uint32_t xscale_get_ttb(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	uint32_t ttb;
 
 	xscale_get_reg(&amp;xscale-&gt;reg_cache-&gt;reg_list[XSCALE_TTB]);
@@ -2014,8 +1983,7 @@ static uint32_t xscale_get_ttb(target_t *target)
 static void xscale_disable_mmu_caches(target_t *target, int mmu,
 		int d_u_cache, int i_cache)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	uint32_t cp15_control;
 
 	/* read cp15 control register */
@@ -2054,8 +2022,7 @@ static void xscale_disable_mmu_caches(target_t *target, int mmu,
 static void xscale_enable_mmu_caches(target_t *target, int mmu,
 		int d_u_cache, int i_cache)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	uint32_t cp15_control;
 
 	/* read cp15 control register */
@@ -2082,8 +2049,7 @@ static int xscale_set_breakpoint(struct target_s *target,
 		breakpoint_t *breakpoint)
 {
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -2155,8 +2121,7 @@ static int xscale_set_breakpoint(struct target_s *target,
 static int xscale_add_breakpoint(struct target_s *target,
 		breakpoint_t *breakpoint)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -2188,8 +2153,7 @@ static int xscale_unset_breakpoint(struct target_s *target,
 		breakpoint_t *breakpoint)
 {
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -2242,8 +2206,7 @@ static int xscale_unset_breakpoint(struct target_s *target,
 
 static int xscale_remove_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -2265,8 +2228,7 @@ static int xscale_remove_breakpoint(struct target_s *target, breakpoint_t *break
 static int xscale_set_watchpoint(struct target_s *target,
 		watchpoint_t *watchpoint)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	uint8_t enable = 0;
 	reg_t *dbcon = &amp;xscale-&gt;reg_cache-&gt;reg_list[XSCALE_DBCON];
 	uint32_t dbcon_value = buf_get_u32(dbcon-&gt;value, 0, 32);
@@ -2322,8 +2284,7 @@ static int xscale_set_watchpoint(struct target_s *target,
 static int xscale_add_watchpoint(struct target_s *target,
 		watchpoint_t *watchpoint)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -2349,8 +2310,7 @@ static int xscale_add_watchpoint(struct target_s *target,
 static int xscale_unset_watchpoint(struct target_s *target,
 		watchpoint_t *watchpoint)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	reg_t *dbcon = &amp;xscale-&gt;reg_cache-&gt;reg_list[XSCALE_DBCON];
 	uint32_t dbcon_value = buf_get_u32(dbcon-&gt;value, 0, 32);
 
@@ -2385,8 +2345,7 @@ static int xscale_unset_watchpoint(struct target_s *target,
 
 static int xscale_remove_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -2408,8 +2367,7 @@ static int xscale_get_reg(reg_t *reg)
 {
 	xscale_reg_t *arch_info = reg-&gt;arch_info;
 	target_t *target = arch_info-&gt;target;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 
 	/* DCSR, TX and RX are accessible via JTAG */
 	if (strcmp(reg-&gt;name, &quot;XSCALE_DCSR&quot;) == 0)
@@ -2454,8 +2412,7 @@ static int xscale_set_reg(reg_t *reg, uint8_t* buf)
 {
 	xscale_reg_t *arch_info = reg-&gt;arch_info;
 	target_t *target = arch_info-&gt;target;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	uint32_t value = buf_get_u32(buf, 0, 32);
 
 	/* DCSR, TX and RX are accessible via JTAG */
@@ -2497,9 +2454,7 @@ static int xscale_set_reg(reg_t *reg, uint8_t* buf)
 
 static int xscale_write_dcsr_sw(target_t *target, uint32_t value)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	reg_t *dcsr = &amp;xscale-&gt;reg_cache-&gt;reg_list[XSCALE_DCSR];
 	xscale_reg_t *dcsr_arch_info = dcsr-&gt;arch_info;
 
@@ -2518,9 +2473,8 @@ static int xscale_write_dcsr_sw(target_t *target, uint32_t value)
 
 static int xscale_read_trace(target_t *target)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
+	struct armv4_5_common_s *armv4_5 = &amp;xscale-&gt;armv4_5_common;
 	xscale_trace_data_t **trace_data_p;
 
 	/* 258 words from debug handler
@@ -2598,9 +2552,7 @@ static int xscale_read_trace(target_t *target)
 static int xscale_read_instruction(target_t *target,
 		arm_instruction_t *instruction)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	int i;
 	int section = -1;
 	uint32_t size_read;
@@ -2680,9 +2632,7 @@ static int xscale_branch_address(xscale_trace_data_t *trace_data,
 
 static int xscale_analyze_trace(target_t *target, command_context_t *cmd_ctx)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	int next_pc_ok = 0;
 	uint32_t next_pc = 0x0;
 	xscale_trace_data_t *trace_data = xscale-&gt;trace.data;
@@ -2869,10 +2819,8 @@ static int xscale_analyze_trace(target_t *target, command_context_t *cmd_ctx)
 
 static void xscale_build_reg_cache(target_t *target)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
-
+	struct xscale_common_s *xscale = target_to_xscale(target);
+	struct armv4_5_common_s *armv4_5 = &amp;xscale-&gt;armv4_5_common;
 	reg_cache_t **cache_p = register_get_last_cache_p(&amp;target-&gt;reg_cache);
 	xscale_reg_t *arch_info = malloc(sizeof(xscale_reg_arch_info));
 	int i;
@@ -2929,7 +2877,6 @@ static int xscale_init_arch_info(target_t *target,
 	armv4_5 = &amp;xscale-&gt;armv4_5_common;
 
 	/* store architecture specfic data (none so far) */
-	xscale-&gt;arch_info = NULL;
 	xscale-&gt;common_magic = XSCALE_COMMON_MAGIC;
 
 	/* we don't really *need* variant info ... */
@@ -3047,9 +2994,8 @@ xscale_handle_debug_handler_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = NULL;
-	armv4_5_common_t *armv4_5;
 	xscale_common_t *xscale;
-
+	int retval;
 	uint32_t handler_address;
 
 	if (argc &lt; 2)
@@ -3064,10 +3010,10 @@ xscale_handle_debug_handler_command(struct command_context_s *cmd_ctx,
 		return ERROR_FAIL;
 	}
 
-	if (xscale_get_arch_pointers(target, &amp;armv4_5, &amp;xscale) != ERROR_OK)
-	{
-		return ERROR_FAIL;
-	}
+	xscale = target_to_xscale(target);
+	retval = xscale_verify_pointer(cmd_ctx, xscale);
+	if (retval != ERROR_OK)
+		return retval;
 
 	COMMAND_PARSE_NUMBER(u32, args[1], handler_address);
 
@@ -3090,9 +3036,8 @@ xscale_handle_cache_clean_address_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = NULL;
-	armv4_5_common_t *armv4_5;
 	xscale_common_t *xscale;
-
+	int retval;
 	uint32_t cache_clean_address;
 
 	if (argc &lt; 2)
@@ -3106,11 +3051,10 @@ xscale_handle_cache_clean_address_command(struct command_context_s *cmd_ctx,
 		LOG_ERROR(&quot;target '%s' not defined&quot;, args[0]);
 		return ERROR_FAIL;
 	}
-
-	if (xscale_get_arch_pointers(target, &amp;armv4_5, &amp;xscale) != ERROR_OK)
-	{
-		return ERROR_FAIL;
-	}
+	xscale = target_to_xscale(target);
+	retval = xscale_verify_pointer(cmd_ctx, xscale);
+	if (retval != ERROR_OK)
+		return retval;
 
 	COMMAND_PARSE_NUMBER(u32, args[1], cache_clean_address);
 
@@ -3131,13 +3075,12 @@ xscale_handle_cache_info_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	xscale_common_t *xscale;
+	struct xscale_common_s *xscale = target_to_xscale(target);
+	int retval;
 
-	if (xscale_get_arch_pointers(target, &amp;armv4_5, &amp;xscale) != ERROR_OK)
-	{
-		return ERROR_OK;
-	}
+	retval = xscale_verify_pointer(cmd_ctx, xscale);
+	if (retval != ERROR_OK)
+		return retval;
 
 	return armv4_5_handle_cache_info_command(cmd_ctx, &amp;xscale-&gt;armv4_5_mmu.armv4_5_cache);
 }
@@ -3145,18 +3088,17 @@ xscale_handle_cache_info_command(struct command_context_s *cmd_ctx,
 static int xscale_virt2phys(struct target_s *target,
 		uint32_t virtual, uint32_t *physical)
 {
-	armv4_5_common_t *armv4_5;
-	xscale_common_t *xscale;
-	int retval;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	int type;
 	uint32_t cb;
 	int domain;
 	uint32_t ap;
 
-	if ((retval = xscale_get_arch_pointers(target, &amp;armv4_5, &amp;xscale)) != ERROR_OK)
-	{
-		return retval;
+	if (xscale-&gt;common_magic != XSCALE_COMMON_MAGIC) {
+		LOG_ERROR(xscale_not);
+		return ERROR_TARGET_INVALID;
 	}
+
 	uint32_t ret = armv4_5_mmu_translate_va(target, &amp;xscale-&gt;armv4_5_mmu, virtual, &amp;type, &amp;cb, &amp;domain, &amp;ap);
 	if (type == -1)
 	{
@@ -3168,8 +3110,7 @@ static int xscale_virt2phys(struct target_s *target,
 
 static int xscale_mmu(struct target_s *target, int *enabled)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	xscale_common_t *xscale = armv4_5-&gt;arch_info;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -3184,13 +3125,12 @@ static int xscale_handle_mmu_command(command_context_t *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	xscale_common_t *xscale;
+	struct xscale_common_s *xscale = target_to_xscale(target);
+	int retval;
 
-	if (xscale_get_arch_pointers(target, &amp;armv4_5, &amp;xscale) != ERROR_OK)
-	{
-		return ERROR_OK;
-	}
+	retval = xscale_verify_pointer(cmd_ctx, xscale);
+	if (retval != ERROR_OK)
+		return retval;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -3221,14 +3161,13 @@ static int xscale_handle_idcache_command(command_context_t *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	xscale_common_t *xscale;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	int icache = 0, dcache = 0;
+	int retval;
 
-	if (xscale_get_arch_pointers(target, &amp;armv4_5, &amp;xscale) != ERROR_OK)
-	{
-		return ERROR_OK;
-	}
+	retval = xscale_verify_pointer(cmd_ctx, xscale);
+	if (retval != ERROR_OK)
+		return retval;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -3276,13 +3215,12 @@ static int xscale_handle_vector_catch_command(command_context_t *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	xscale_common_t *xscale;
+	struct xscale_common_s *xscale = target_to_xscale(target);
+	int retval;
 
-	if (xscale_get_arch_pointers(target, &amp;armv4_5, &amp;xscale) != ERROR_OK)
-	{
-		return ERROR_OK;
-	}
+	retval = xscale_verify_pointer(cmd_ctx, xscale);
+	if (retval != ERROR_OK)
+		return retval;
 
 	if (argc &lt; 1)
 	{
@@ -3305,14 +3243,13 @@ static int xscale_handle_vector_table_command(command_context_t *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	xscale_common_t *xscale;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	int err = 0;
+	int retval;
 
-	if (xscale_get_arch_pointers(target, &amp;armv4_5, &amp;xscale) != ERROR_OK)
-	{
-		return ERROR_OK;
-	}
+	retval = xscale_verify_pointer(cmd_ctx, xscale);
+	if (retval != ERROR_OK)
+		return retval;
 
 	if (argc == 0) /* print current settings */
 	{
@@ -3366,14 +3303,14 @@ xscale_handle_trace_buffer_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	xscale_common_t *xscale;
+	struct xscale_common_s *xscale = target_to_xscale(target);
+	struct armv4_5_common_s *armv4_5 = &amp;xscale-&gt;armv4_5_common;
 	uint32_t dcsr_value;
+	int retval;
 
-	if (xscale_get_arch_pointers(target, &amp;armv4_5, &amp;xscale) != ERROR_OK)
-	{
-		return ERROR_OK;
-	}
+	retval = xscale_verify_pointer(cmd_ctx, xscale);
+	if (retval != ERROR_OK)
+		return retval;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -3446,9 +3383,9 @@ static int
 xscale_handle_trace_image_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
-	target_t *target;
-	armv4_5_common_t *armv4_5;
-	xscale_common_t *xscale;
+	target_t *target = get_current_target(cmd_ctx);
+	struct xscale_common_s *xscale = target_to_xscale(target);
+	int retval;
 
 	if (argc &lt; 1)
 	{
@@ -3456,12 +3393,9 @@ xscale_handle_trace_image_command(struct command_context_s *cmd_ctx,
 		return ERROR_OK;
 	}
 
-	target = get_current_target(cmd_ctx);
-
-	if (xscale_get_arch_pointers(target, &amp;armv4_5, &amp;xscale) != ERROR_OK)
-	{
-		return ERROR_OK;
-	}
+	retval = xscale_verify_pointer(cmd_ctx, xscale);
+	if (retval != ERROR_OK)
+		return retval;
 
 	if (xscale-&gt;trace.image)
 	{
@@ -3499,15 +3433,14 @@ static int xscale_handle_dump_trace_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	xscale_common_t *xscale;
+	struct xscale_common_s *xscale = target_to_xscale(target);
 	xscale_trace_data_t *trace_data;
 	fileio_t file;
+	int retval;
 
-	if (xscale_get_arch_pointers(target, &amp;armv4_5, &amp;xscale) != ERROR_OK)
-	{
-		return ERROR_OK;
-	}
+	retval = xscale_verify_pointer(cmd_ctx, xscale);
+	if (retval != ERROR_OK)
+		return retval;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -3559,13 +3492,12 @@ xscale_handle_analyze_trace_buffer_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	xscale_common_t *xscale;
+	struct xscale_common_s *xscale = target_to_xscale(target);
+	int retval;
 
-	if (xscale_get_arch_pointers(target, &amp;armv4_5, &amp;xscale) != ERROR_OK)
-	{
-		return ERROR_OK;
-	}
+	retval = xscale_verify_pointer(cmd_ctx, xscale);
+	if (retval != ERROR_OK)
+		return retval;
 
 	xscale_analyze_trace(target, cmd_ctx);
 
@@ -3576,13 +3508,12 @@ static int xscale_handle_cp15(command_context_t *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	xscale_common_t *xscale;
+	struct xscale_common_s *xscale = target_to_xscale(target);
+	int retval;
 
-	if (xscale_get_arch_pointers(target, &amp;armv4_5, &amp;xscale) != ERROR_OK)
-	{
-		return ERROR_OK;
-	}
+	retval = xscale_verify_pointer(cmd_ctx, xscale);
+	if (retval != ERROR_OK)
+		return retval;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
diff --git a/src/target/xscale.h b/src/target/xscale.h
index a1f3d46..56db181 100644
--- a/src/target/xscale.h
+++ b/src/target/xscale.h
@@ -128,9 +128,6 @@ typedef struct xscale_common_s
 	armv4_5_mmu_common_t armv4_5_mmu;
 	uint32_t cp15_control_reg;
 
-	/* possible future enhancements that go beyond XScale common stuff */
-	void *arch_info;
-
 	int fast_memory_access;
 } xscale_common_t;
 

commit 178c7580960b4d84fe83ef579250fba1d6ac4f2d
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Thu Nov 5 22:03:40 2009 -0800

    ARM9TDMI uses the new inheritance/nesting scheme
    
    Replace needless pointer traversals and simplify.  Also remove most
    remaining contents from arm9tdmi struct; it's almost removable.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/arm9tdmi.c b/src/target/arm9tdmi.c
index 3110f95..9455c05 100644
--- a/src/target/arm9tdmi.c
+++ b/src/target/arm9tdmi.c
@@ -60,9 +60,7 @@ static const arm9tdmi_vector_t arm9tdmi_vectors[] =
 int arm9tdmi_examine_debug_reason(target_t *target)
 {
 	int retval = ERROR_OK;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 
 	/* only check the debug reason if we don't know it already */
 	if ((target-&gt;debug_reason != DBG_REASON_DBGRQ)
@@ -331,9 +329,7 @@ static void arm9tdmi_change_to_arm(target_t *target,
 		uint32_t *r0, uint32_t *pc)
 {
 	int retval = ERROR_OK;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* save r0 before using it and put system in ARM state
@@ -387,9 +383,7 @@ void arm9tdmi_read_core_regs(target_t *target,
 		uint32_t mask, uint32_t* core_regs[16])
 {
 	int i;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* STMIA r0-15, [r0] at debug speed
@@ -414,9 +408,7 @@ static void arm9tdmi_read_core_regs_target_buffer(target_t *target,
 		uint32_t mask, void* buffer, int size)
 {
 	int i;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	int be = (target-&gt;endianness == TARGET_BIG_ENDIAN) ? 1 : 0;
 	uint32_t *buf_u32 = buffer;
@@ -454,9 +446,7 @@ static void arm9tdmi_read_core_regs_target_buffer(target_t *target,
 
 static void arm9tdmi_read_xpsr(target_t *target, uint32_t *xpsr, int spsr)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* MRS r0, cpsr */
@@ -478,9 +468,7 @@ static void arm9tdmi_read_xpsr(target_t *target, uint32_t *xpsr, int spsr)
 
 static void arm9tdmi_write_xpsr(target_t *target, uint32_t xpsr, int spsr)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	LOG_DEBUG(&quot;xpsr: %8.8&quot; PRIx32 &quot;, spsr: %i&quot;, xpsr, spsr);
@@ -515,9 +503,7 @@ static void arm9tdmi_write_xpsr(target_t *target, uint32_t xpsr, int spsr)
 static void arm9tdmi_write_xpsr_im8(target_t *target,
 		uint8_t xpsr_im, int rot, int spsr)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	LOG_DEBUG(&quot;xpsr_im: %2.2x, rot: %i, spsr: %i&quot;, xpsr_im, rot, spsr);
@@ -543,9 +529,7 @@ void arm9tdmi_write_core_regs(target_t *target,
 		uint32_t mask, uint32_t core_regs[16])
 {
 	int i;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* LDMIA r0-15, [r0] at debug speed
@@ -569,9 +553,7 @@ void arm9tdmi_write_core_regs(target_t *target,
 
 void arm9tdmi_load_word_regs(target_t *target, uint32_t mask)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* put system-speed load-multiple into the pipeline */
@@ -581,9 +563,7 @@ void arm9tdmi_load_word_regs(target_t *target, uint32_t mask)
 
 void arm9tdmi_load_hword_reg(target_t *target, int num)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* put system-speed load half-word into the pipeline */
@@ -593,9 +573,7 @@ void arm9tdmi_load_hword_reg(target_t *target, int num)
 
 void arm9tdmi_load_byte_reg(target_t *target, int num)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* put system-speed load byte into the pipeline */
@@ -605,9 +583,7 @@ void arm9tdmi_load_byte_reg(target_t *target, int num)
 
 void arm9tdmi_store_word_regs(target_t *target, uint32_t mask)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* put system-speed store-multiple into the pipeline */
@@ -617,9 +593,7 @@ void arm9tdmi_store_word_regs(target_t *target, uint32_t mask)
 
 void arm9tdmi_store_hword_reg(target_t *target, int num)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* put system-speed store half-word into the pipeline */
@@ -629,9 +603,7 @@ void arm9tdmi_store_hword_reg(target_t *target, int num)
 
 void arm9tdmi_store_byte_reg(target_t *target, int num)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* put system-speed store byte into the pipeline */
@@ -641,9 +613,7 @@ void arm9tdmi_store_byte_reg(target_t *target, int num)
 
 static void arm9tdmi_write_pc(target_t *target, uint32_t pc)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* LDMIA r0-15, [r0] at debug speed
@@ -667,9 +637,7 @@ static void arm9tdmi_write_pc(target_t *target, uint32_t pc)
 
 void arm9tdmi_branch_resume(target_t *target)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	arm9tdmi_clock_out(jtag_info, ARMV4_5_B(0xfffffc, 0), 0, NULL, 0);
@@ -680,9 +648,8 @@ static void arm9tdmi_branch_resume_thumb(target_t *target)
 {
 	LOG_DEBUG(&quot;-&quot;);
 
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	reg_t *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 
@@ -738,9 +705,7 @@ static void arm9tdmi_branch_resume_thumb(target_t *target)
 
 void arm9tdmi_enable_single_step(target_t *target, uint32_t next_pc)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 
 	if (arm7_9-&gt;has_single_step)
 	{
@@ -755,9 +720,7 @@ void arm9tdmi_enable_single_step(target_t *target, uint32_t next_pc)
 
 void arm9tdmi_disable_single_step(target_t *target)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 
 	if (arm7_9-&gt;has_single_step)
 	{
@@ -773,8 +736,7 @@ void arm9tdmi_disable_single_step(target_t *target)
 static void arm9tdmi_build_reg_cache(target_t *target)
 {
 	reg_cache_t **cache_p = register_get_last_cache_p(&amp;target-&gt;reg_cache);
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 
 	(*cache_p) = armv4_5_build_reg_cache(target, armv4_5);
 	armv4_5-&gt;core_cache = (*cache_p);
@@ -782,10 +744,9 @@ static void arm9tdmi_build_reg_cache(target_t *target)
 
 int arm9tdmi_examine(struct target_s *target)
 {
-	/* get pointers to arch-specific information */
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+
 	if (!target_was_examined(target))
 	{
 		reg_cache_t **cache_p = register_get_last_cache_p(&amp;target-&gt;reg_cache);
@@ -872,10 +833,6 @@ int arm9tdmi_init_arch_info(target_t *target, arm9tdmi_common_t *arm9tdmi, jtag_
 	arm7_9-&gt;thumb_bkpt = 0xdeee;
 
 	arm7_9-&gt;dbgreq_adjust_pc = 3;
-	arm7_9-&gt;arch_info = arm9tdmi;
-
-	arm9tdmi-&gt;common_magic = ARM9TDMI_COMMON_MAGIC;
-	arm9tdmi-&gt;arch_info = NULL;
 
 	arm7_9_init_arch_info(target, arm7_9);
 
@@ -888,38 +845,6 @@ int arm9tdmi_init_arch_info(target_t *target, arm9tdmi_common_t *arm9tdmi, jtag_
 	return ERROR_OK;
 }
 
-static int arm9tdmi_get_arch_pointers(target_t *target,
-		armv4_5_common_t **armv4_5_p, arm7_9_common_t **arm7_9_p,
-		arm9tdmi_common_t **arm9tdmi_p)
-{
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9;
-	arm9tdmi_common_t *arm9tdmi;
-
-	if (armv4_5-&gt;common_magic != ARMV4_5_COMMON_MAGIC)
-	{
-		return -1;
-	}
-
-	arm7_9 = armv4_5-&gt;arch_info;
-	if (arm7_9-&gt;common_magic != ARM7_9_COMMON_MAGIC)
-	{
-		return -1;
-	}
-
-	arm9tdmi = arm7_9-&gt;arch_info;
-	if (arm9tdmi-&gt;common_magic != ARM9TDMI_COMMON_MAGIC)
-	{
-		return -1;
-	}
-
-	*armv4_5_p = armv4_5;
-	*arm7_9_p = arm7_9;
-	*arm9tdmi_p = arm9tdmi;
-
-	return ERROR_OK;
-}
-
 static int arm9tdmi_target_create(struct target_s *target, Jim_Interp *interp)
 {
 	arm9tdmi_common_t *arm9tdmi = calloc(1,sizeof(arm9tdmi_common_t));
@@ -934,17 +859,17 @@ static int handle_arm9tdmi_catch_vectors_command(
 	struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	arm7_9_common_t *arm7_9;
-	arm9tdmi_common_t *arm9tdmi;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	reg_t *vector_catch;
 	uint32_t vector_catch_value;
 	int i, j;
 
-	if (arm9tdmi_get_arch_pointers(target, &amp;armv4_5, &amp;arm7_9, &amp;arm9tdmi) != ERROR_OK)
-	{
-		command_print(cmd_ctx, &quot;current target isn't an ARM9 based target&quot;);
-		return ERROR_OK;
+	/* it's uncommon, but some ARM7 chips can support this */
+	if (arm7_9-&gt;common_magic != ARM7_9_COMMON_MAGIC
+			|| !arm7_9-&gt;has_vector_catch) {
+		command_print(cmd_ctx, &quot;target doesn't have EmbeddedICE &quot;
+				&quot;with vector_catch&quot;);
+		return ERROR_TARGET_INVALID;
 	}
 
 	vector_catch = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_VEC_CATCH];
diff --git a/src/target/arm9tdmi.h b/src/target/arm9tdmi.h
index 8f89316..8bf2713 100644
--- a/src/target/arm9tdmi.h
+++ b/src/target/arm9tdmi.h
@@ -25,12 +25,11 @@
 
 #include &quot;embeddedice.h&quot;
 
-#define	ARM9TDMI_COMMON_MAGIC 0x00a900a9
-
+/* FIXME we don't really need a separate arm9tdmi struct any more...
+ * remove it, the arm7/arm9 common struct suffices.
+ */
 typedef struct arm9tdmi_common_s
 {
-	int common_magic;
-	void *arch_info;
 	arm7_9_common_t arm7_9_common;
 } arm9tdmi_common_t;
 

commit 865ed6ed819888910f198f0584cc1b78d1e6e363
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Thu Nov 5 22:03:33 2009 -0800

    ARM966 uses the new inheritance/nesting scheme
    
    Use target_to_arm966(), replacing needless pointer traversals.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/arm966e.c b/src/target/arm966e.c
index 30927f0..5b464ef 100644
--- a/src/target/arm966e.c
+++ b/src/target/arm966e.c
@@ -39,7 +39,6 @@ int arm966e_init_arch_info(target_t *target, arm966e_common_t *arm966e, jtag_tap
 
 	arm9tdmi_init_arch_info(target, arm9tdmi, tap);
 
-	arm9tdmi-&gt;arch_info = arm966e;
 	arm966e-&gt;common_magic = ARM966E_COMMON_MAGIC;
 
 	/* The ARM966E-S implements the ARMv5TE architecture which
@@ -58,51 +57,20 @@ static int arm966e_target_create(struct target_s *target, Jim_Interp *interp)
 	return arm966e_init_arch_info(target, arm966e, target-&gt;tap);
 }
 
-static int arm966e_get_arch_pointers(target_t *target,
-		armv4_5_common_t **armv4_5_p, arm7_9_common_t **arm7_9_p,
-		arm9tdmi_common_t **arm9tdmi_p, arm966e_common_t **arm966e_p)
+static int arm966e_verify_pointer(struct command_context_s *cmd_ctx,
+		struct arm966e_common_s *arm966e)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9;
-	arm9tdmi_common_t *arm9tdmi;
-	arm966e_common_t *arm966e;
-
-	if (armv4_5-&gt;common_magic != ARMV4_5_COMMON_MAGIC)
-	{
-		return -1;
-	}
-
-	arm7_9 = armv4_5-&gt;arch_info;
-	if (arm7_9-&gt;common_magic != ARM7_9_COMMON_MAGIC)
-	{
-		return -1;
-	}
-
-	arm9tdmi = arm7_9-&gt;arch_info;
-	if (arm9tdmi-&gt;common_magic != ARM9TDMI_COMMON_MAGIC)
-	{
-		return -1;
-	}
-
-	arm966e = arm9tdmi-&gt;arch_info;
-	if (arm966e-&gt;common_magic != ARM966E_COMMON_MAGIC)
-	{
-		return -1;
+	if (arm966e-&gt;common_magic != ARM966E_COMMON_MAGIC) {
+		command_print(cmd_ctx, &quot;target is not an ARM966&quot;);
+		return ERROR_TARGET_INVALID;
 	}
-
-	*armv4_5_p = armv4_5;
-	*arm7_9_p = arm7_9;
-	*arm9tdmi_p = arm9tdmi;
-	*arm966e_p = arm966e;
-
 	return ERROR_OK;
 }
 
 static int arm966e_read_cp15(target_t *target, int reg_addr, uint32_t *value)
 {
 	int retval = ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	scan_field_t fields[3];
 	uint8_t reg_addr_buf = reg_addr &amp; 0x3f;
@@ -154,8 +122,7 @@ static int arm966e_read_cp15(target_t *target, int reg_addr, uint32_t *value)
 int arm966e_write_cp15(target_t *target, int reg_addr, uint32_t value)
 {
 	int retval = ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	scan_field_t fields[3];
 	uint8_t reg_addr_buf = reg_addr &amp; 0x3f;
@@ -200,19 +167,11 @@ static int arm966e_handle_cp15_command(struct command_context_s *cmd_ctx,
 {
 	int retval;
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	arm7_9_common_t *arm7_9;
-	arm9tdmi_common_t *arm9tdmi;
-	arm966e_common_t *arm966e;
-	arm_jtag_t *jtag_info;
+	struct arm966e_common_s *arm966e = target_to_arm966(target);
 
-	if (arm966e_get_arch_pointers(target, &amp;armv4_5, &amp;arm7_9, &amp;arm9tdmi, &amp;arm966e) != ERROR_OK)
-	{
-		command_print(cmd_ctx, &quot;current target isn't an ARM966e target&quot;);
-		return ERROR_OK;
-	}
-
-	jtag_info = &amp;arm7_9-&gt;jtag_info;
+	retval = arm966e_verify_pointer(cmd_ctx, arm966e);
+	if (retval != ERROR_OK)
+		return retval;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{

commit 1fcb351de6912148aa3ef567aa2de2c74e3b05f3
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Thu Nov 5 22:03:30 2009 -0800

    ARM926 uses the new inheritance/nesting scheme
    
    Use target_to_arm926(), replacing needless pointer traversals
    and simplifying a bunch of code.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/arm926ejs.c b/src/target/arm926ejs.c
index 7147dbf..316f127 100644
--- a/src/target/arm926ejs.c
+++ b/src/target/arm926ejs.c
@@ -51,8 +51,7 @@ static int arm926ejs_cp15_read(target_t *target, uint32_t op1, uint32_t op2,
 		uint32_t CRn, uint32_t CRm, uint32_t *value)
 {
 	int retval = ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	uint32_t address = ARM926EJS_CP15_ADDR(op1, op2, CRn, CRm);
 	scan_field_t fields[4];
@@ -144,8 +143,7 @@ static int arm926ejs_cp15_write(target_t *target, uint32_t op1, uint32_t op2,
 		uint32_t CRn, uint32_t CRm, uint32_t value)
 {
 	int retval = ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	uint32_t address = ARM926EJS_CP15_ADDR(op1, op2, CRn, CRm);
 	scan_field_t fields[4];
@@ -233,8 +231,7 @@ static int arm926ejs_mcr(target_t *target, int cpnum, uint32_t op1,
 
 static int arm926ejs_examine_debug_reason(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	reg_t *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 	int debug_reason;
 	int retval;
@@ -337,10 +334,7 @@ static int arm926ejs_examine_debug_reason(target_t *target)
 
 static uint32_t arm926ejs_get_ttb(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm926ejs_common_t *arm926ejs = arm9tdmi-&gt;arch_info;
+	struct arm926ejs_common_s *arm926ejs = target_to_arm926(target);
 	int retval;
 	uint32_t ttb = 0x0;
 
@@ -353,10 +347,7 @@ static uint32_t arm926ejs_get_ttb(target_t *target)
 static void arm926ejs_disable_mmu_caches(target_t *target, int mmu,
 		int d_u_cache, int i_cache)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm926ejs_common_t *arm926ejs = arm9tdmi-&gt;arch_info;
+	struct arm926ejs_common_s *arm926ejs = target_to_arm926(target);
 	uint32_t cp15_control;
 
 	/* read cp15 control register */
@@ -405,10 +396,7 @@ static void arm926ejs_disable_mmu_caches(target_t *target, int mmu,
 static void arm926ejs_enable_mmu_caches(target_t *target, int mmu,
 		int d_u_cache, int i_cache)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm926ejs_common_t *arm926ejs = arm9tdmi-&gt;arch_info;
+	struct arm926ejs_common_s *arm926ejs = target_to_arm926(target);
 	uint32_t cp15_control;
 
 	/* read cp15 control register */
@@ -429,10 +417,7 @@ static void arm926ejs_enable_mmu_caches(target_t *target, int mmu,
 
 static void arm926ejs_post_debug_entry(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm926ejs_common_t *arm926ejs = arm9tdmi-&gt;arch_info;
+	struct arm926ejs_common_s *arm926ejs = target_to_arm926(target);
 
 	/* examine cp15 control reg */
 	arm926ejs-&gt;read_cp15(target, 0, 0, 1, 0, &amp;arm926ejs-&gt;cp15_control_reg);
@@ -471,10 +456,7 @@ static void arm926ejs_post_debug_entry(target_t *target)
 
 static void arm926ejs_pre_restore_context(target_t *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm926ejs_common_t *arm926ejs = arm9tdmi-&gt;arch_info;
+	struct arm926ejs_common_s *arm926ejs = target_to_arm926(target);
 
 	/* restore i/d fault status and address register */
 	arm926ejs-&gt;write_cp15(target, 0, 0, 5, 0, arm926ejs-&gt;d_fsr);
@@ -490,69 +472,38 @@ static void arm926ejs_pre_restore_context(target_t *target)
 	arm926ejs-&gt;write_cp15(target, 7, 0, 15, 0, cache_dbg_ctrl);
 }
 
-static int arm926ejs_get_arch_pointers(target_t *target,
-		armv4_5_common_t **armv4_5_p,
-		arm7_9_common_t **arm7_9_p,
-		arm9tdmi_common_t **arm9tdmi_p,
-		arm926ejs_common_t **arm926ejs_p)
-{
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9;
-	arm9tdmi_common_t *arm9tdmi;
-	arm926ejs_common_t *arm926ejs;
-
-	if (armv4_5-&gt;common_magic != ARMV4_5_COMMON_MAGIC)
-	{
-		return -1;
-	}
-
-	arm7_9 = armv4_5-&gt;arch_info;
-	if (arm7_9-&gt;common_magic != ARM7_9_COMMON_MAGIC)
-	{
-		return -1;
-	}
-
-	arm9tdmi = arm7_9-&gt;arch_info;
-	if (arm9tdmi-&gt;common_magic != ARM9TDMI_COMMON_MAGIC)
-	{
-		return -1;
-	}
+static const char arm926_not[] = &quot;target is not an ARM926&quot;;
 
-	arm926ejs = arm9tdmi-&gt;arch_info;
-	if (arm926ejs-&gt;common_magic != ARM926EJS_COMMON_MAGIC)
-	{
-		return -1;
+static int arm926ejs_verify_pointer(struct command_context_s *cmd_ctx,
+		struct arm926ejs_common_s *arm926)
+{
+	if (arm926-&gt;common_magic != ARM926EJS_COMMON_MAGIC) {
+		command_print(cmd_ctx, arm926_not);
+		return ERROR_TARGET_INVALID;
 	}
-
-	*armv4_5_p = armv4_5;
-	*arm7_9_p = arm7_9;
-	*arm9tdmi_p = arm9tdmi;
-	*arm926ejs_p = arm926ejs;
-
 	return ERROR_OK;
 }
 
 /** Logs summary of ARM926 state for a halted target. */
 int arm926ejs_arch_state(struct target_s *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm926ejs_common_t *arm926ejs = arm9tdmi-&gt;arch_info;
-
-	char *state[] =
+	static const char *state[] =
 	{
 		&quot;disabled&quot;, &quot;enabled&quot;
 	};
 
-	if (armv4_5-&gt;common_magic != ARMV4_5_COMMON_MAGIC)
+	struct arm926ejs_common_s *arm926ejs = target_to_arm926(target);
+	struct armv4_5_common_s *armv4_5;
+
+	if (arm926ejs-&gt;common_magic != ARM926EJS_COMMON_MAGIC)
 	{
-		LOG_ERROR(&quot;BUG: called for a non-ARMv4/5 target&quot;);
-		exit(-1);
+		LOG_ERROR(&quot;BUG: %s&quot;, arm926_not);
+		return ERROR_TARGET_INVALID;
 	}
 
-	LOG_USER(
-			&quot;target halted in %s state due to %s, current mode: %s\n&quot;
+	armv4_5 = &amp;arm926ejs-&gt;arm9tdmi_common.arm7_9_common.armv4_5_common;
+
+	LOG_USER(&quot;target halted in %s state due to %s, current mode: %s\n&quot;
 			&quot;cpsr: 0x%8.8&quot; PRIx32 &quot; pc: 0x%8.8&quot; PRIx32 &quot;\n&quot;
 			&quot;MMU: %s, D-Cache: %s, I-Cache: %s&quot;,
 			 armv4_5_state_strings[armv4_5-&gt;core_state],
@@ -570,10 +521,9 @@ int arm926ejs_arch_state(struct target_s *target)
 int arm926ejs_soft_reset_halt(struct target_s *target)
 {
 	int retval = ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm926ejs_common_t *arm926ejs = arm9tdmi-&gt;arch_info;
+	struct arm926ejs_common_s *arm926ejs = target_to_arm926(target);
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	reg_t *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 
 	if ((retval = target_halt(target)) != ERROR_OK)
@@ -639,10 +589,7 @@ int arm926ejs_write_memory(struct target_s *target, uint32_t address,
 		uint32_t size, uint32_t count, uint8_t *buffer)
 {
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm926ejs_common_t *arm926ejs = arm9tdmi-&gt;arch_info;
+	struct arm926ejs_common_s *arm926ejs = target_to_arm926(target);
 
 	/* FIX!!!! this should be cleaned up and made much more general. The
 	 * plan is to write up and test on arm926ejs specifically and
@@ -703,24 +650,20 @@ static int arm926ejs_write_phys_memory(struct target_s *target,
 		uint32_t address, uint32_t size,
 		uint32_t count, uint8_t *buffer)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm926ejs_common_t *arm926ejs = arm9tdmi-&gt;arch_info;
+	struct arm926ejs_common_s *arm926ejs = target_to_arm926(target);
 
-	return armv4_5_mmu_write_physical(target, &amp;arm926ejs-&gt;armv4_5_mmu, address, size, count, buffer);
+	return armv4_5_mmu_write_physical(target, &amp;arm926ejs-&gt;armv4_5_mmu,
+			address, size, count, buffer);
 }
 
 static int arm926ejs_read_phys_memory(struct target_s *target,
 		uint32_t address, uint32_t size,
 		uint32_t count, uint8_t *buffer)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm926ejs_common_t *arm926ejs = arm9tdmi-&gt;arch_info;
+	struct arm926ejs_common_s *arm926ejs = target_to_arm926(target);
 
-	return armv4_5_mmu_read_physical(target, &amp;arm926ejs-&gt;armv4_5_mmu, address, size, count, buffer);
+	return armv4_5_mmu_read_physical(target, &amp;arm926ejs-&gt;armv4_5_mmu,
+			address, size, count, buffer);
 }
 
 int arm926ejs_init_arch_info(target_t *target, arm926ejs_common_t *arm926ejs,
@@ -733,7 +676,6 @@ int arm926ejs_init_arch_info(target_t *target, arm926ejs_common_t *arm926ejs,
 	 */
 	arm9tdmi_init_arch_info(target, arm9tdmi, tap);
 
-	arm9tdmi-&gt;arch_info = arm926ejs;
 	arm926ejs-&gt;common_magic = ARM926EJS_COMMON_MAGIC;
 
 	arm7_9-&gt;post_debug_entry = arm926ejs_post_debug_entry;
@@ -776,10 +718,7 @@ static int arm926ejs_handle_cp15_command(struct command_context_s *cmd_ctx,
 {
 	int retval;
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	arm7_9_common_t *arm7_9;
-	arm9tdmi_common_t *arm9tdmi;
-	arm926ejs_common_t *arm926ejs;
+	struct arm926ejs_common_s *arm926ejs = target_to_arm926(target);
 	int opcode_1;
 	int opcode_2;
 	int CRn;
@@ -796,11 +735,9 @@ static int arm926ejs_handle_cp15_command(struct command_context_s *cmd_ctx,
 	COMMAND_PARSE_NUMBER(int, args[2], CRn);
 	COMMAND_PARSE_NUMBER(int, args[3], CRm);
 
-	if (arm926ejs_get_arch_pointers(target, &amp;armv4_5, &amp;arm7_9, &amp;arm9tdmi, &amp;arm926ejs) != ERROR_OK)
-	{
-		command_print(cmd_ctx, &quot;current target isn't an ARM926EJ-S target&quot;);
-		return ERROR_OK;
-	}
+	retval = arm926ejs_verify_pointer(cmd_ctx, arm926ejs);
+	if (retval != ERROR_OK)
+		return retval;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -842,38 +779,25 @@ static int
 arm926ejs_handle_cache_info_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
+	int retval;
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	arm7_9_common_t *arm7_9;
-	arm9tdmi_common_t *arm9tdmi;
-	arm926ejs_common_t *arm926ejs;
+	struct arm926ejs_common_s *arm926ejs = target_to_arm926(target);
 
-	if (arm926ejs_get_arch_pointers(target, &amp;armv4_5, &amp;arm7_9, &amp;arm9tdmi, &amp;arm926ejs) != ERROR_OK)
-	{
-		command_print(cmd_ctx, &quot;current target isn't an ARM926EJ-S target&quot;);
-		return ERROR_OK;
-	}
+	retval = arm926ejs_verify_pointer(cmd_ctx, arm926ejs);
+	if (retval != ERROR_OK)
+		return retval;
 
 	return armv4_5_handle_cache_info_command(cmd_ctx, &amp;arm926ejs-&gt;armv4_5_mmu.armv4_5_cache);
 }
 
 static int arm926ejs_virt2phys(struct target_s *target, uint32_t virtual, uint32_t *physical)
 {
-	int retval;
 	int type;
 	uint32_t cb;
 	int domain;
 	uint32_t ap;
+	struct arm926ejs_common_s *arm926ejs = target_to_arm926(target);
 
-	armv4_5_common_t *armv4_5;
-	arm7_9_common_t *arm7_9;
-	arm9tdmi_common_t *arm9tdmi;
-	arm926ejs_common_t *arm926ejs;
-	retval= arm926ejs_get_arch_pointers(target, &amp;armv4_5, &amp;arm7_9, &amp;arm9tdmi, &amp;arm926ejs);
-	if (retval != ERROR_OK)
-	{
-		return retval;
-	}
 	uint32_t ret = armv4_5_mmu_translate_va(target, &amp;arm926ejs-&gt;armv4_5_mmu, virtual, &amp;type, &amp;cb, &amp;domain, &amp;ap);
 	if (type == -1)
 	{
@@ -885,10 +809,7 @@ static int arm926ejs_virt2phys(struct target_s *target, uint32_t virtual, uint32
 
 static int arm926ejs_mmu(struct target_s *target, int *enabled)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm926ejs_common_t *arm926ejs = arm9tdmi-&gt;arch_info;
+	struct arm926ejs_common_s *arm926ejs = target_to_arm926(target);
 
 	if (target-&gt;state != TARGET_HALTED)
 	{

commit 6e08573efd78b8f38fbe05f4feee2615a90fa41c
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Thu Nov 5 22:03:24 2009 -0800

    FA526 uses the new inheritance/nesting scheme
    
    Replace needless pointer traversals, simplify.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/fa526.c b/src/target/fa526.c
index 3bd0225..1a204b1 100644
--- a/src/target/fa526.c
+++ b/src/target/fa526.c
@@ -43,9 +43,7 @@ static void fa526_read_core_regs(target_t *target,
 		uint32_t mask, uint32_t* core_regs[16])
 {
 	int i;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* STMIA r0-15, [r0] at debug speed
@@ -72,9 +70,7 @@ static void fa526_read_core_regs_target_buffer(target_t *target,
 		uint32_t mask, void* buffer, int size)
 {
 	int i;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	int be = (target-&gt;endianness == TARGET_BIG_ENDIAN) ? 1 : 0;
 	uint32_t *buf_u32 = buffer;
@@ -114,9 +110,7 @@ static void fa526_read_core_regs_target_buffer(target_t *target,
 
 static void fa526_read_xpsr(target_t *target, uint32_t *xpsr, int spsr)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* MRS r0, cpsr */
@@ -141,9 +135,7 @@ static void fa526_read_xpsr(target_t *target, uint32_t *xpsr, int spsr)
 
 static void fa526_write_xpsr(target_t *target, uint32_t xpsr, int spsr)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	LOG_DEBUG(&quot;xpsr: %8.8&quot; PRIx32 &quot;, spsr: %i&quot;, xpsr, spsr);
@@ -180,9 +172,7 @@ static void fa526_write_xpsr(target_t *target, uint32_t xpsr, int spsr)
 static void fa526_write_xpsr_im8(target_t *target,
 		uint8_t xpsr_im, int rot, int spsr)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	LOG_DEBUG(&quot;xpsr_im: %2.2x, rot: %i, spsr: %i&quot;, xpsr_im, rot, spsr);
@@ -210,9 +200,7 @@ static void fa526_write_core_regs(target_t *target,
 		uint32_t mask, uint32_t core_regs[16])
 {
 	int i;
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* LDMIA r0-15, [r0] at debug speed
@@ -238,9 +226,7 @@ static void fa526_write_core_regs(target_t *target,
 
 static void fa526_write_pc(target_t *target, uint32_t pc)
 {
-	/* get pointers to arch-specific information */
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	/* LDMIA r0-15, [r0] at debug speed
@@ -272,11 +258,9 @@ static void fa526_branch_resume_thumb(target_t *target)
 static int fa526_init_arch_info_2(target_t *target,
 		arm9tdmi_common_t *arm9tdmi, jtag_tap_t *tap)
 {
-	armv4_5_common_t *armv4_5;
 	arm7_9_common_t *arm7_9;
 
 	arm7_9 = &amp;arm9tdmi-&gt;arm7_9_common;
-	armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 
 	/* prepare JTAG information for the new target */
 	arm7_9-&gt;jtag_info.tap = tap;
@@ -318,9 +302,6 @@ static int fa526_init_arch_info_2(target_t *target,
 	arm7_9-&gt;thumb_bkpt = 0xdeee;
 
 	arm7_9-&gt;dbgreq_adjust_pc = 3;
-	arm7_9-&gt;arch_info = arm9tdmi;
-
-	arm9tdmi-&gt;common_magic = ARM9TDMI_COMMON_MAGIC;
 
 	arm7_9_init_arch_info(target, arm7_9);
 

commit 9be533566ea077c32bf57eb0441c8a4ae2a7c9cc
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Thu Nov 5 22:03:13 2009 -0800

    ARM920 uses the new inheritance/nesting scheme
    
    Use target_to_arm920(), replacing needless pointer traversals
    and simplifying.  Stop setting arm9tdmi-&gt;arch_info for arm920
    type parts, it's not used any longer.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/arm920t.c b/src/target/arm920t.c
index 1c63327..dd9fae3 100644
--- a/src/target/arm920t.c
+++ b/src/target/arm920t.c
@@ -54,14 +54,15 @@
 static int arm920t_read_cp15_physical(target_t *target,
 		int reg_addr, uint32_t *value)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
+	struct arm920t_common_s *arm920t = target_to_arm920(target);
+	arm_jtag_t *jtag_info;
 	scan_field_t fields[4];
 	uint8_t access_type_buf = 1;
 	uint8_t reg_addr_buf = reg_addr &amp; 0x3f;
 	uint8_t nr_w_buf = 0;
 
+	jtag_info = &amp;arm920t-&gt;arm9tdmi_common.arm7_9_common.jtag_info;
+
 	jtag_set_end_state(TAP_IDLE);
 	arm_jtag_scann(jtag_info, 0xf);
 	arm_jtag_set_instr(jtag_info, jtag_info-&gt;intest_instr, NULL);
@@ -105,15 +106,16 @@ static int arm920t_read_cp15_physical(target_t *target,
 static int arm920t_write_cp15_physical(target_t *target,
 		int reg_addr, uint32_t value)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
+	struct arm920t_common_s *arm920t = target_to_arm920(target);
+	arm_jtag_t *jtag_info;
 	scan_field_t fields[4];
 	uint8_t access_type_buf = 1;
 	uint8_t reg_addr_buf = reg_addr &amp; 0x3f;
 	uint8_t nr_w_buf = 1;
 	uint8_t value_buf[4];
 
+	jtag_info = &amp;arm920t-&gt;arm9tdmi_common.arm7_9_common.jtag_info;
+
 	buf_set_u32(value_buf, 0, 32, value);
 
 	jtag_set_end_state(TAP_IDLE);
@@ -153,15 +155,16 @@ static int arm920t_execute_cp15(target_t *target, uint32_t cp15_opcode,
 		uint32_t arm_opcode)
 {
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm_jtag_t *jtag_info = &amp;arm7_9-&gt;jtag_info;
+	struct arm920t_common_s *arm920t = target_to_arm920(target);
+	arm_jtag_t *jtag_info;
 	scan_field_t fields[4];
 	uint8_t access_type_buf = 0;		/* interpreted access */
 	uint8_t reg_addr_buf = 0x0;
 	uint8_t nr_w_buf = 0;
 	uint8_t cp15_opcode_buf[4];
 
+	jtag_info = &amp;arm920t-&gt;arm9tdmi_common.arm7_9_common.jtag_info;
+
 	jtag_set_end_state(TAP_IDLE);
 	arm_jtag_scann(jtag_info, 0xf);
 	arm_jtag_set_instr(jtag_info, jtag_info-&gt;intest_instr, NULL);
@@ -198,7 +201,7 @@ static int arm920t_execute_cp15(target_t *target, uint32_t cp15_opcode,
 
 	if ((retval = jtag_execute_queue()) != ERROR_OK)
 	{
-		LOG_ERROR(&quot;failed executing JTAG queue, exiting&quot;);
+		LOG_ERROR(&quot;failed executing JTAG queue&quot;);
 		return retval;
 	}
 
@@ -208,7 +211,7 @@ static int arm920t_execute_cp15(target_t *target, uint32_t cp15_opcode,
 static int arm920t_read_cp15_interpreted(target_t *target,
 		uint32_t cp15_opcode, uint32_t address, uint32_t *value)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 	uint32_t* regs_p[1];
 	uint32_t regs[2];
 	uint32_t cp15c15 = 0x0;
@@ -254,7 +257,7 @@ int arm920t_write_cp15_interpreted(target_t *target,
 		uint32_t cp15_opcode, uint32_t value, uint32_t address)
 {
 	uint32_t cp15c15 = 0x0;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
+	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
 	uint32_t regs[2];
 
 	/* load value, address into R0, R1 */
@@ -347,10 +350,7 @@ void arm920t_enable_mmu_caches(target_t *target, int mmu, int d_u_cache, int i_c
 void arm920t_post_debug_entry(target_t *target)
 {
 	uint32_t cp15c15;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm920t_common_t *arm920t = arm9tdmi-&gt;arch_info;
+	struct arm920t_common_s *arm920t = target_to_arm920(target);
 
 	/* examine cp15 control reg */
 	arm920t_read_cp15_physical(target, 0x2, &amp;arm920t-&gt;cp15_control_reg);
@@ -394,10 +394,7 @@ void arm920t_post_debug_entry(target_t *target)
 void arm920t_pre_restore_context(target_t *target)
 {
 	uint32_t cp15c15;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm920t_common_t *arm920t = arm9tdmi-&gt;arch_info;
+	struct arm920t_common_s *arm920t = target_to_arm920(target);
 
 	/* restore i/d fault status and address register */
 	arm920t_write_cp15_interpreted(target, 0xee050f10, arm920t-&gt;d_fsr, 0x0);
@@ -416,65 +413,38 @@ void arm920t_pre_restore_context(target_t *target)
 	}
 }
 
-static int arm920t_get_arch_pointers(target_t *target,
-	armv4_5_common_t **armv4_5_p, arm7_9_common_t **arm7_9_p,
-	arm9tdmi_common_t **arm9tdmi_p, arm920t_common_t **arm920t_p)
-{
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9;
-	arm9tdmi_common_t *arm9tdmi;
-	arm920t_common_t *arm920t;
-
-	if (armv4_5-&gt;common_magic != ARMV4_5_COMMON_MAGIC)
-	{
-		return -1;
-	}
-
-	arm7_9 = armv4_5-&gt;arch_info;
-	if (arm7_9-&gt;common_magic != ARM7_9_COMMON_MAGIC)
-	{
-		return -1;
-	}
-
-	arm9tdmi = arm7_9-&gt;arch_info;
-	if (arm9tdmi-&gt;common_magic != ARM9TDMI_COMMON_MAGIC)
-	{
-		return -1;
-	}
+static const char arm920_not[] = &quot;target is not an ARM920&quot;;
 
-	arm920t = arm9tdmi-&gt;arch_info;
-	if (arm920t-&gt;common_magic != ARM920T_COMMON_MAGIC)
-	{
-		return -1;
+static int arm920t_verify_pointer(struct command_context_s *cmd_ctx,
+		struct arm920t_common_s *arm920t)
+{
+	if (arm920t-&gt;common_magic != ARM920T_COMMON_MAGIC) {
+		command_print(cmd_ctx, arm920_not);
+		return ERROR_TARGET_INVALID;
 	}
 
-	*armv4_5_p = armv4_5;
-	*arm7_9_p = arm7_9;
-	*arm9tdmi_p = arm9tdmi;
-	*arm920t_p = arm920t;
-
 	return ERROR_OK;
 }
 
 /** Logs summary of ARM920 state for a halted target. */
 int arm920t_arch_state(struct target_s *target)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm920t_common_t *arm920t = arm9tdmi-&gt;arch_info;
-
-	char *state[] =
+	static const char *state[] =
 	{
 		&quot;disabled&quot;, &quot;enabled&quot;
 	};
 
-	if (armv4_5-&gt;common_magic != ARMV4_5_COMMON_MAGIC)
+	struct arm920t_common_s *arm920t = target_to_arm920(target);
+	struct armv4_5_common_s *armv4_5;
+
+	if (arm920t-&gt;common_magic != ARM920T_COMMON_MAGIC)
 	{
-		LOG_ERROR(&quot;BUG: called for a non-ARMv4/5 target&quot;);
-		exit(-1);
+		LOG_ERROR(&quot;BUG: %s&quot;, arm920_not);
+		return ERROR_TARGET_INVALID;
 	}
 
+	armv4_5 = &amp;arm920t-&gt;arm9tdmi_common.arm7_9_common.armv4_5_common;
+
 	LOG_USER(&quot;target halted in %s state due to %s, current mode: %s\n&quot;
 			&quot;cpsr: 0x%8.8&quot; PRIx32 &quot; pc: 0x%8.8&quot; PRIx32 &quot;\n&quot;
 			&quot;MMU: %s, D-Cache: %s, I-Cache: %s&quot;,
@@ -505,10 +475,7 @@ static int arm920t_read_phys_memory(struct target_s *target,
 		uint32_t address, uint32_t size,
 		uint32_t count, uint8_t *buffer)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm920t_common_t *arm920t = arm9tdmi-&gt;arch_info;
+	struct arm920t_common_s *arm920t = target_to_arm920(target);
 
 	return armv4_5_mmu_read_physical(target, &amp;arm920t-&gt;armv4_5_mmu,
 			address, size, count, buffer);
@@ -518,10 +485,7 @@ static int arm920t_write_phys_memory(struct target_s *target,
 		uint32_t address, uint32_t size,
 		uint32_t count, uint8_t *buffer)
 {
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm920t_common_t *arm920t = arm9tdmi-&gt;arch_info;
+	struct arm920t_common_s *arm920t = target_to_arm920(target);
 
 	return armv4_5_mmu_write_physical(target, &amp;arm920t-&gt;armv4_5_mmu,
 			address, size, count, buffer);
@@ -532,18 +496,18 @@ static int arm920t_write_phys_memory(struct target_s *target,
 int arm920t_write_memory(struct target_s *target, uint32_t address, uint32_t size, uint32_t count, uint8_t *buffer)
 {
 	int retval;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm920t_common_t *arm920t = arm9tdmi-&gt;arch_info;
 
 	if ((retval = arm7_9_write_memory(target, address, size, count, buffer)) != ERROR_OK)
 		return retval;
 
-	/* This fn is used to write breakpoints, so we need to make sure that the
-	 * datacache is flushed and the instruction cache is invalidated */
+	/* This fn is used to write breakpoints, so we need to make sure
+	 * that the data cache is flushed and the instruction cache is
+	 * invalidated
+	 */
 	if (((size == 4) || (size == 2)) &amp;&amp; (count == 1))
 	{
+		struct arm920t_common_s *arm920t = target_to_arm920(target);
+
 		if (arm920t-&gt;armv4_5_mmu.armv4_5_cache.d_u_cache_enabled)
 		{
 			LOG_DEBUG(&quot;D-Cache enabled, flush and invalidate cache line&quot;);
@@ -569,10 +533,9 @@ int arm920t_write_memory(struct target_s *target, uint32_t address, uint32_t siz
 int arm920t_soft_reset_halt(struct target_s *target)
 {
 	int retval = ERROR_OK;
-	armv4_5_common_t *armv4_5 = target-&gt;arch_info;
-	arm7_9_common_t *arm7_9 = armv4_5-&gt;arch_info;
-	arm9tdmi_common_t *arm9tdmi = arm7_9-&gt;arch_info;
-	arm920t_common_t *arm920t = arm9tdmi-&gt;arch_info;
+	struct arm920t_common_s *arm920t = target_to_arm920(target);
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	reg_t *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 
 	if ((retval = target_halt(target)) != ERROR_OK)
@@ -647,7 +610,6 @@ int arm920t_init_arch_info(target_t *target, arm920t_common_t *arm920t, jtag_tap
 	 */
 	arm9tdmi_init_arch_info(target, arm9tdmi, tap);
 
-	arm9tdmi-&gt;arch_info = arm920t;
 	arm920t-&gt;common_magic = ARM920T_COMMON_MAGIC;
 
 	arm7_9-&gt;post_debug_entry = arm920t_post_debug_entry;
@@ -686,11 +648,9 @@ static int arm920t_handle_read_cache_command(struct command_context_s *cmd_ctx,
 {
 	int retval = ERROR_OK;
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	arm7_9_common_t *arm7_9;
-	arm9tdmi_common_t *arm9tdmi;
-	arm920t_common_t *arm920t;
-	arm_jtag_t *jtag_info;
+	struct arm920t_common_s *arm920t = target_to_arm920(target);
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	uint32_t cp15c15;
 	uint32_t cp15_ctrl, cp15_ctrl_saved;
 	uint32_t regs[16];
@@ -701,6 +661,10 @@ static int arm920t_handle_read_cache_command(struct command_context_s *cmd_ctx,
 	arm920t_cache_line_t d_cache[8][64], i_cache[8][64];
 	int segment, index;
 
+	retval = arm920t_verify_pointer(cmd_ctx, arm920t);
+	if (retval != ERROR_OK)
+		return retval;
+
 	if (argc != 1)
 	{
 		command_print(cmd_ctx, &quot;usage: arm920t read_cache &lt;filename&gt;&quot;);
@@ -716,14 +680,6 @@ static int arm920t_handle_read_cache_command(struct command_context_s *cmd_ctx,
 	for (i = 0; i &lt; 16; i++)
 		regs_p[i] = &amp;regs[i];
 
-	if (arm920t_get_arch_pointers(target, &amp;armv4_5, &amp;arm7_9, &amp;arm9tdmi, &amp;arm920t) != ERROR_OK)
-	{
-		command_print(cmd_ctx, &quot;current target isn't an ARM920t target&quot;);
-		return ERROR_OK;
-	}
-
-	jtag_info = &amp;arm7_9-&gt;jtag_info;
-
 	/* disable MMU and Caches */
 	arm920t_read_cp15_physical(target, ARM920T_CP15_PHYS_ADDR(0, 0x1, 0), &amp;cp15_ctrl);
 	if ((retval = jtag_execute_queue()) != ERROR_OK)
@@ -939,11 +895,9 @@ static int arm920t_handle_read_mmu_command(struct command_context_s *cmd_ctx,
 {
 	int retval = ERROR_OK;
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	arm7_9_common_t *arm7_9;
-	arm9tdmi_common_t *arm9tdmi;
-	arm920t_common_t *arm920t;
-	arm_jtag_t *jtag_info;
+	struct arm920t_common_s *arm920t = target_to_arm920(target);
+	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
+	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	uint32_t cp15c15;
 	uint32_t cp15_ctrl, cp15_ctrl_saved;
 	uint32_t regs[16];
@@ -954,6 +908,10 @@ static int arm920t_handle_read_mmu_command(struct command_context_s *cmd_ctx,
 	arm920t_tlb_entry_t d_tlb[64], i_tlb[64];
 	int victim;
 
+	retval = arm920t_verify_pointer(cmd_ctx, arm920t);
+	if (retval != ERROR_OK)
+		return retval;
+
 	if (argc != 1)
 	{
 		command_print(cmd_ctx, &quot;usage: arm920t read_mmu &lt;filename&gt;&quot;);
@@ -969,14 +927,6 @@ static int arm920t_handle_read_mmu_command(struct command_context_s *cmd_ctx,
 	for (i = 0; i &lt; 16; i++)
 		regs_p[i] = &amp;regs[i];
 
-	if (arm920t_get_arch_pointers(target, &amp;armv4_5, &amp;arm7_9, &amp;arm9tdmi, &amp;arm920t) != ERROR_OK)
-	{
-		command_print(cmd_ctx, &quot;current target isn't an ARM920t target&quot;);
-		return ERROR_OK;
-	}
-
-	jtag_info = &amp;arm7_9-&gt;jtag_info;
-
 	/* disable MMU and Caches */
 	arm920t_read_cp15_physical(target, ARM920T_CP15_PHYS_ADDR(0, 0x1, 0), &amp;cp15_ctrl);
 	if ((retval = jtag_execute_queue()) != ERROR_OK)
@@ -1229,19 +1179,11 @@ static int arm920t_handle_cp15_command(struct command_context_s *cmd_ctx,
 {
 	int retval;
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	arm7_9_common_t *arm7_9;
-	arm9tdmi_common_t *arm9tdmi;
-	arm920t_common_t *arm920t;
-	arm_jtag_t *jtag_info;
+	struct arm920t_common_s *arm920t = target_to_arm920(target);
 
-	if (arm920t_get_arch_pointers(target, &amp;armv4_5, &amp;arm7_9, &amp;arm9tdmi, &amp;arm920t) != ERROR_OK)
-	{
-		command_print(cmd_ctx, &quot;current target isn't an ARM920t target&quot;);
-		return ERROR_OK;
-	}
-
-	jtag_info = &amp;arm7_9-&gt;jtag_info;
+	retval = arm920t_verify_pointer(cmd_ctx, arm920t);
+	if (retval != ERROR_OK)
+		return retval;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -1291,19 +1233,12 @@ static int arm920t_handle_cp15i_command(struct command_context_s *cmd_ctx,
 {
 	int retval;
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	arm7_9_common_t *arm7_9;
-	arm9tdmi_common_t *arm9tdmi;
-	arm920t_common_t *arm920t;
-	arm_jtag_t *jtag_info;
+	struct arm920t_common_s *arm920t = target_to_arm920(target);
 
-	if (arm920t_get_arch_pointers(target, &amp;armv4_5, &amp;arm7_9, &amp;arm9tdmi, &amp;arm920t) != ERROR_OK)
-	{
-		command_print(cmd_ctx, &quot;current target isn't an ARM920t target&quot;);
-		return ERROR_OK;
-	}
+	retval = arm920t_verify_pointer(cmd_ctx, arm920t);
+	if (retval != ERROR_OK)
+		return retval;
 
-	jtag_info = &amp;arm7_9-&gt;jtag_info;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -1364,17 +1299,13 @@ static int arm920t_handle_cp15i_command(struct command_context_s *cmd_ctx,
 static int arm920t_handle_cache_info_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
+	int retval;
 	target_t *target = get_current_target(cmd_ctx);
-	armv4_5_common_t *armv4_5;
-	arm7_9_common_t *arm7_9;
-	arm9tdmi_common_t *arm9tdmi;
-	arm920t_common_t *arm920t;
+	struct arm920t_common_s *arm920t = target_to_arm920(target);
 
-	if (arm920t_get_arch_pointers(target, &amp;armv4_5, &amp;arm7_9, &amp;arm9tdmi, &amp;arm920t) != ERROR_OK)
-	{
-		command_print(cmd_ctx, &quot;current target isn't an ARM920t target&quot;);
-		return ERROR_OK;
-	}
+	retval = arm920t_verify_pointer(cmd_ctx, arm920t);
+	if (retval != ERROR_OK)
+		return retval;
 
 	return armv4_5_handle_cache_info_command(cmd_ctx, &amp;arm920t-&gt;armv4_5_mmu.armv4_5_cache);
 }
diff --git a/src/target/fa526.c b/src/target/fa526.c
index 53efaae..3bd0225 100644
--- a/src/target/fa526.c
+++ b/src/target/fa526.c
@@ -321,7 +321,6 @@ static int fa526_init_arch_info_2(target_t *target,
 	arm7_9-&gt;arch_info = arm9tdmi;
 
 	arm9tdmi-&gt;common_magic = ARM9TDMI_COMMON_MAGIC;
-	arm9tdmi-&gt;arch_info = NULL;
 
 	arm7_9_init_arch_info(target, arm7_9);
 
@@ -344,7 +343,6 @@ static int fa526_init_arch_info(target_t *target,
 	 */
 	fa526_init_arch_info_2(target, arm9tdmi, tap);
 
-	arm9tdmi-&gt;arch_info = arm920t;
 	arm920t-&gt;common_magic = ARM920T_COMMON_MAGIC;
 
 	arm7_9-&gt;post_debug_entry = arm920t_post_debug_entry;

commit da739aa25733b5a252a2b0b8ad76a3dc886f1132
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Thu Nov 5 21:59:45 2009 -0800

    Cortex-M3: use the new inheritance/nesting scheme
    
    Use new target_to_cm3() and target_to_armv7m() inlines,
    instead of a series of x-&gt;arch_info conversions.  Remove
    arch_info, since nothing uses it.
    
    Also fix an omission:  the Cortex-M3 commands didn't verify
    that they were operating on that kind of target.  Add comment
    about the ARMv7M version of that omission.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/armv7m.c b/src/target/armv7m.c
index 49e50f4..0fcee31 100644
--- a/src/target/armv7m.c
+++ b/src/target/armv7m.c
@@ -136,9 +136,7 @@ static int armv7m_core_reg_arch_type = -1;
 int armv7m_restore_context(target_t *target)
 {
 	int i;
-
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 
 	LOG_DEBUG(&quot; &quot;);
 
@@ -185,14 +183,14 @@ static int armv7m_get_core_reg(reg_t *reg)
 	int retval;
 	armv7m_core_reg_t *armv7m_reg = reg-&gt;arch_info;
 	target_t *target = armv7m_reg-&gt;target;
-	armv7m_common_t *armv7m_target = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
 		return ERROR_TARGET_NOT_HALTED;
 	}
 
-	retval = armv7m_target-&gt;read_core_reg(target, armv7m_reg-&gt;num);
+	retval = armv7m-&gt;read_core_reg(target, armv7m_reg-&gt;num);
 
 	return retval;
 }
@@ -220,9 +218,7 @@ static int armv7m_read_core_reg(struct target_s *target, int num)
 	uint32_t reg_value;
 	int retval;
 	armv7m_core_reg_t * armv7m_core_reg;
-
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 
 	if ((num &lt; 0) || (num &gt;= ARMV7M_NUM_REGS))
 		return ERROR_INVALID_ARGUMENTS;
@@ -241,9 +237,7 @@ static int armv7m_write_core_reg(struct target_s *target, int num)
 	int retval;
 	uint32_t reg_value;
 	armv7m_core_reg_t *armv7m_core_reg;
-
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 
 	if ((num &lt; 0) || (num &gt;= ARMV7M_NUM_REGS))
 		return ERROR_INVALID_ARGUMENTS;
@@ -267,8 +261,7 @@ static int armv7m_write_core_reg(struct target_s *target, int num)
 /** Invalidates cache of core registers set up by armv7m_build_reg_cache(). */
 int armv7m_invalidate_core_regs(target_t *target)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	int i;
 
 	for (i = 0; i &lt; armv7m-&gt;core_cache-&gt;num_regs; i++)
@@ -288,8 +281,7 @@ int armv7m_invalidate_core_regs(target_t *target)
  */
 int armv7m_get_gdb_reg_list(target_t *target, reg_t **reg_list[], int *reg_list_size)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	int i;
 
 	*reg_list_size = 26;
@@ -370,8 +362,7 @@ int armv7m_run_algorithm(struct target_s *target,
 	uint32_t entry_point, uint32_t exit_point,
 	int timeout_ms, void *arch_info)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	armv7m_algorithm_t *armv7m_algorithm_info = arch_info;
 	enum armv7m_mode core_mode = armv7m-&gt;core_mode;
 	int retval = ERROR_OK;
@@ -512,8 +503,7 @@ int armv7m_run_algorithm(struct target_s *target,
 /** Logs summary of ARMv7-M state for a halted target. */
 int armv7m_arch_state(struct target_s *target)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	uint32_t ctrl, sp;
 
 	ctrl = buf_get_u32(armv7m-&gt;core_cache-&gt;reg_list[ARMV7M_CONTROL].value, 0, 32);
@@ -536,9 +526,7 @@ int armv7m_arch_state(struct target_s *target)
 /** Builds cache of architecturally defined registers.  */
 reg_cache_t *armv7m_build_reg_cache(target_t *target)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	int num_regs = ARMV7M_NUM_REGS;
 	reg_cache_t **cache_p = register_get_last_cache_p(&amp;target-&gt;reg_cache);
 	reg_cache_t *cache = malloc(sizeof(reg_cache_t));
@@ -743,6 +731,16 @@ int armv7m_blank_check_memory(struct target_s *target,
 	return ERROR_OK;
 }
 
+/*--------------------------------------------------------------------------*/
+
+/*
+ * Only stuff below this line should need to verify that its target
+ * is an ARMv7-M node.
+ *
+ * FIXME yet none of it _does_ verify target types yet!
+ */
+
+
 /*
  * Return the debug ap baseaddress in hexadecimal;
  * no extra output to simplify script processing
@@ -751,7 +749,7 @@ static int handle_dap_baseaddr_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 	uint32_t apsel, apselsave, baseaddr;
 	int retval;
@@ -789,7 +787,7 @@ static int handle_dap_apid_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 
 	return dap_apid_command(cmd_ctx, swjdp, args, argc);
@@ -799,7 +797,7 @@ static int handle_dap_apsel_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 
 	return dap_apsel_command(cmd_ctx, swjdp, args, argc);
@@ -809,7 +807,7 @@ static int handle_dap_memaccess_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 
 	return dap_memaccess_command(cmd_ctx, swjdp, args, argc);
@@ -820,7 +818,7 @@ static int handle_dap_info_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 	uint32_t apsel;
 
diff --git a/src/target/armv7m.h b/src/target/armv7m.h
index 487d6fd..217f0e3 100644
--- a/src/target/armv7m.h
+++ b/src/target/armv7m.h
@@ -99,7 +99,6 @@ typedef struct armv7m_common_s
 	int exception_number;
 	swjdp_common_t swjdp_info;
 
-
 	/* Direct processor core register read and writes */
 	int (*load_core_reg_u32)(struct target_s *target, enum armv7m_regtype type, uint32_t num, uint32_t *value);
 	int (*store_core_reg_u32)(struct target_s *target, enum armv7m_regtype type, uint32_t num, uint32_t value);
@@ -112,8 +111,6 @@ typedef struct armv7m_common_s
 
 	void (*pre_restore_context)(target_t *target);
 	void (*post_restore_context)(target_t *target);
-
-	void *arch_info;
 } armv7m_common_t;
 
 static inline struct armv7m_common_s *
diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index a1d1cbc..e157805 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -37,6 +37,10 @@
 #include &quot;arm_disassembler.h&quot;
 
 
+/* NOTE:  most of this should work fine for the Cortex-M1 and
+ * Cortex-M0 cores too, although they're ARMv6-M not ARMv7-M.
+ */
+
 #define ARRAY_SIZE(x)	((int)(sizeof(x)/sizeof((x)[0])))
 
 
@@ -123,10 +127,8 @@ static int cortexm3_dap_write_coreregister_u32(swjdp_common_t *swjdp,
 static int cortex_m3_write_debug_halt_mask(target_t *target,
 		uint32_t mask_on, uint32_t mask_off)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
-	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
+	struct swjdp_common_s *swjdp = &amp;cortex_m3-&gt;armv7m.swjdp_info;
 
 	/* mask off status bits */
 	cortex_m3-&gt;dcb_dhcsr &amp;= ~((0xFFFF &lt;&lt; 16) | mask_off);
@@ -138,10 +140,8 @@ static int cortex_m3_write_debug_halt_mask(target_t *target,
 
 static int cortex_m3_clear_halt(target_t *target)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
-	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
+	struct swjdp_common_s *swjdp = &amp;cortex_m3-&gt;armv7m.swjdp_info;
 
 	/* clear step if any */
 	cortex_m3_write_debug_halt_mask(target, C_HALT, C_STEP);
@@ -157,10 +157,8 @@ static int cortex_m3_clear_halt(target_t *target)
 
 static int cortex_m3_single_step_core(target_t *target)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
-	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
+	struct swjdp_common_s *swjdp = &amp;cortex_m3-&gt;armv7m.swjdp_info;
 	uint32_t dhcsr_save;
 
 	/* backup dhcsr reg */
@@ -183,11 +181,8 @@ static int cortex_m3_endreset_event(target_t *target)
 {
 	int i;
 	uint32_t dcb_demcr;
-
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
-	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
+	struct swjdp_common_s *swjdp = &amp;cortex_m3-&gt;armv7m.swjdp_info;
 	cortex_m3_fp_comparator_t *fp_list = cortex_m3-&gt;fp_comparator_list;
 	cortex_m3_dwt_comparator_t *dwt_list = cortex_m3-&gt;dwt_comparator_list;
 
@@ -242,9 +237,7 @@ static int cortex_m3_endreset_event(target_t *target)
 
 static int cortex_m3_examine_debug_reason(target_t *target)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
 
 	/* THIS IS NOT GOOD, TODO - better logic for detection of debug state reason */
 	/* only check the debug reason if we don't know it already */
@@ -272,9 +265,7 @@ static int cortex_m3_examine_debug_reason(target_t *target)
 static int cortex_m3_examine_exception_reason(target_t *target)
 {
 	uint32_t shcsr, except_sr, cfsr = -1, except_ar = -1;
-
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 
 	mem_ap_read_u32(swjdp, NVIC_SHCSR, &amp;shcsr);
@@ -324,10 +315,8 @@ static int cortex_m3_debug_entry(target_t *target)
 	int i;
 	uint32_t xPSR;
 	int retval;
-
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
+	struct armv7m_common_s *armv7m = &amp;cortex_m3-&gt;armv7m;
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 
 	LOG_DEBUG(&quot; &quot;);
@@ -397,11 +386,8 @@ static int cortex_m3_poll(target_t *target)
 {
 	int retval;
 	enum target_state prev_target_state = target-&gt;state;
-
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
-	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
+	struct swjdp_common_s *swjdp = &amp;cortex_m3-&gt;armv7m.swjdp_info;
 
 	/* Read from Debug Halting Control and Status Register */
 	retval = mem_ap_read_atomic_u32(swjdp, DCB_DHCSR, &amp;cortex_m3-&gt;dcb_dhcsr);
@@ -514,10 +500,8 @@ static int cortex_m3_halt(target_t *target)
 
 static int cortex_m3_soft_reset_halt(struct target_s *target)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
-	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
+	struct swjdp_common_s *swjdp = &amp;cortex_m3-&gt;armv7m.swjdp_info;
 	uint32_t dcb_dhcsr = 0;
 	int retval, timeout = 0;
 
@@ -569,8 +553,7 @@ static void cortex_m3_enable_breakpoints(struct target_s *target)
 static int cortex_m3_resume(struct target_s *target, int current,
 		uint32_t address, int handle_breakpoints, int debug_execution)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	breakpoint_t *breakpoint = NULL;
 	uint32_t resume_pc;
 
@@ -658,9 +641,8 @@ static int cortex_m3_resume(struct target_s *target, int current,
 static int cortex_m3_step(struct target_s *target, int current,
 		uint32_t address, int handle_breakpoints)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
+	struct armv7m_common_s *armv7m = &amp;cortex_m3-&gt;armv7m;
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 	breakpoint_t *breakpoint = NULL;
 
@@ -672,12 +654,16 @@ static int cortex_m3_step(struct target_s *target, int current,
 
 	/* current = 1: continue on current pc, otherwise continue at &lt;address&gt; */
 	if (!current)
-		buf_set_u32(armv7m-&gt;core_cache-&gt;reg_list[15].value, 0, 32, address);
+		buf_set_u32(cortex_m3-&gt;armv7m.core_cache-&gt;reg_list[15].value,
+				0, 32, address);
 
 	/* the front-end may request us not to handle breakpoints */
-	if (handle_breakpoints)
-		if ((breakpoint = breakpoint_find(target, buf_get_u32(armv7m-&gt;core_cache-&gt;reg_list[15].value, 0, 32))))
+	if (handle_breakpoints) {
+		breakpoint = breakpoint_find(target, buf_get_u32(armv7m
+				-&gt;core_cache-&gt;reg_list[15].value, 0, 32));
+		if (breakpoint)
 			cortex_m3_unset_breakpoint(target, breakpoint);
+	}
 
 	target-&gt;debug_reason = DBG_REASON_SINGLESTEP;
 
@@ -706,9 +692,8 @@ static int cortex_m3_step(struct target_s *target, int current,
 
 static int cortex_m3_assert_reset(target_t *target)
 {
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
-	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
+	struct swjdp_common_s *swjdp = &amp;cortex_m3-&gt;armv7m.swjdp_info;
 	int assert_srst = 1;
 
 	LOG_DEBUG(&quot;target-&gt;state: %s&quot;,
@@ -859,12 +844,8 @@ cortex_m3_set_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 	int retval;
 	int fp_num = 0;
 	uint32_t hilo;
-
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
-
-	cortex_m3_fp_comparator_t * comparator_list = cortex_m3-&gt;fp_comparator_list;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
+	cortex_m3_fp_comparator_t *comparator_list = cortex_m3-&gt;fp_comparator_list;
 
 	if (breakpoint-&gt;set)
 	{
@@ -928,9 +909,7 @@ static int
 cortex_m3_unset_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 {
 	int retval;
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
 	cortex_m3_fp_comparator_t * comparator_list = cortex_m3-&gt;fp_comparator_list;
 
 	if (!breakpoint-&gt;set)
@@ -984,9 +963,7 @@ cortex_m3_unset_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 static int
 cortex_m3_add_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
 
 	if (cortex_m3-&gt;auto_bp_type)
 	{
@@ -1035,9 +1012,7 @@ cortex_m3_add_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 static int
 cortex_m3_remove_breakpoint(struct target_s *target, breakpoint_t *breakpoint)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
 
 	/* REVISIT why check? FBP can be updated with core running ... */
 	if (target-&gt;state != TARGET_HALTED)
@@ -1067,10 +1042,7 @@ cortex_m3_set_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 {
 	int dwt_num = 0;
 	uint32_t mask, temp;
-
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
 
 	/* watchpoint params were validated earlier */
 	mask = 0;
@@ -1133,9 +1105,7 @@ cortex_m3_set_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 static int
 cortex_m3_unset_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
 	cortex_m3_dwt_comparator_t *comparator;
 	int dwt_num;
 
@@ -1172,9 +1142,7 @@ cortex_m3_unset_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 static int
 cortex_m3_add_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
 
 	/* REVISIT why check? DWT can be updated with core running ... */
 	if (target-&gt;state != TARGET_HALTED)
@@ -1232,9 +1200,7 @@ cortex_m3_add_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 static int
 cortex_m3_remove_watchpoint(struct target_s *target, watchpoint_t *watchpoint)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
 
 	/* REVISIT why check? DWT can be updated with core running ... */
 	if (target-&gt;state != TARGET_HALTED)
@@ -1271,8 +1237,7 @@ static int cortex_m3_load_core_reg_u32(struct target_s *target,
 		enum armv7m_regtype type, uint32_t num, uint32_t * value)
 {
 	int retval;
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 
 	/* NOTE:  we &quot;know&quot; here that the register identifiers used
@@ -1336,9 +1301,7 @@ static int cortex_m3_store_core_reg_u32(struct target_s *target,
 {
 	int retval;
 	uint32_t reg;
-
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 
 #ifdef ARMV7_GDB_HACKS
@@ -1413,8 +1376,7 @@ static int cortex_m3_store_core_reg_u32(struct target_s *target,
 static int cortex_m3_read_memory(struct target_s *target, uint32_t address,
 		uint32_t size, uint32_t count, uint8_t *buffer)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 	int retval;
 
@@ -1446,8 +1408,7 @@ static int cortex_m3_read_memory(struct target_s *target, uint32_t address,
 static int cortex_m3_write_memory(struct target_s *target, uint32_t address,
 		uint32_t size, uint32_t count, uint8_t *buffer)
 {
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 	int retval;
 
@@ -1632,11 +1593,8 @@ static int cortex_m3_examine(struct target_s *target)
 	int retval;
 	uint32_t cpuid, fpcr;
 	int i;
-
-	/* get pointers to arch-specific information */
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
-	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
+	struct swjdp_common_s *swjdp = &amp;cortex_m3-&gt;armv7m.swjdp_info;
 
 	if ((retval = ahbap_debugport_init(swjdp)) != ERROR_OK)
 		return retval;
@@ -1702,7 +1660,7 @@ static int cortex_m3_dcc_read(swjdp_common_t *swjdp, uint8_t *value, uint8_t *ct
 static int cortex_m3_target_request_data(target_t *target,
 		uint32_t size, uint8_t *buffer)
 {
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 	uint8_t data;
 	uint8_t ctrl;
@@ -1722,7 +1680,7 @@ static int cortex_m3_handle_target_request(void *priv)
 	target_t *target = priv;
 	if (!target_was_examined(target))
 		return ERROR_OK;
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 
 	if (!target-&gt;dbg_msg_enabled)
@@ -1759,8 +1717,7 @@ static int cortex_m3_init_arch_info(target_t *target,
 		cortex_m3_common_t *cortex_m3, jtag_tap_t *tap)
 {
 	int retval;
-	armv7m_common_t *armv7m;
-	armv7m = &amp;cortex_m3-&gt;armv7m;
+	struct armv7m_common_s *armv7m = &amp;cortex_m3-&gt;armv7m;
 
 	armv7m_init_arch_info(target, armv7m);
 
@@ -1775,11 +1732,6 @@ static int cortex_m3_init_arch_info(target_t *target,
 	armv7m-&gt;swjdp_info.memaccess_tck = 8;
 	armv7m-&gt;swjdp_info.tar_autoincr_block = (1 &lt;&lt; 12);	/* Cortex-M3 has 4096 bytes autoincrement range */
 
-	/* initialize arch-specific breakpoint handling */
-
-	cortex_m3-&gt;common_magic = CORTEX_M3_COMMON_MAGIC;
-	cortex_m3-&gt;arch_info = NULL;
-
 	/* register arch-specific functions */
 	armv7m-&gt;examine_debug_reason = cortex_m3_examine_debug_reason;
 
@@ -1788,7 +1740,6 @@ static int cortex_m3_init_arch_info(target_t *target,
 	armv7m-&gt;pre_restore_context = NULL;
 	armv7m-&gt;post_restore_context = NULL;
 
-	armv7m-&gt;arch_info = cortex_m3;
 	armv7m-&gt;load_core_reg_u32 = cortex_m3_load_core_reg_u32;
 	armv7m-&gt;store_core_reg_u32 = cortex_m3_store_core_reg_u32;
 
@@ -1806,11 +1757,30 @@ static int cortex_m3_target_create(struct target_s *target, Jim_Interp *interp)
 {
 	cortex_m3_common_t *cortex_m3 = calloc(1,sizeof(cortex_m3_common_t));
 
+	cortex_m3-&gt;common_magic = CORTEX_M3_COMMON_MAGIC;
 	cortex_m3_init_arch_info(target, cortex_m3, target-&gt;tap);
 
 	return ERROR_OK;
 }
 
+/*--------------------------------------------------------------------------*/
+
+static int cortex_m3_verify_pointer(struct command_context_s *cmd_ctx,
+		struct cortex_m3_common_s *cm3)
+{
+	if (cm3-&gt;common_magic != CORTEX_M3_COMMON_MAGIC) {
+		command_print(cmd_ctx, &quot;target is not a Cortex-M3&quot;);
+		return ERROR_TARGET_INVALID;
+	}
+	return ERROR_OK;
+}
+
+/*
+ * Only stuff below this line should need to verify that its target
+ * is a Cortex-M3.  Everything else should have indirected through the
+ * cortexm3_target structure, which is only used with CM3 targets.
+ */
+
 /*
  * REVISIT Thumb2 disassembly should work for all ARMv7 cores, as well
  * as at least ARM-1156T2.  The interesting thing about Cortex-M is
@@ -1821,12 +1791,17 @@ static int
 handle_cortex_m3_disassemble_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
-	int retval = ERROR_OK;
+	int retval;
 	target_t *target = get_current_target(cmd_ctx);
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
 	uint32_t address;
 	unsigned long count = 1;
 	arm_instruction_t cur_instruction;
 
+	retval = cortex_m3_verify_pointer(cmd_ctx, cortex_m3);
+	if (retval != ERROR_OK)
+		return retval;
+
 	errno = 0;
 	switch (argc) {
 	case 2:
@@ -1871,11 +1846,17 @@ handle_cortex_m3_vector_catch_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **argv, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv7m_common_t *armv7m = target-&gt;arch_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
+	struct armv7m_common_s *armv7m = &amp;cortex_m3-&gt;armv7m;
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 	uint32_t demcr = 0;
+	int retval;
 	int i;
 
+	retval = cortex_m3_verify_pointer(cmd_ctx, cortex_m3);
+	if (retval != ERROR_OK)
+		return retval;
+
 	mem_ap_read_atomic_u32(swjdp, DCB_DEMCR, &amp;demcr);
 
 	if (argc &gt; 0) {
@@ -1924,8 +1905,12 @@ handle_cortex_m3_mask_interrupts_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	target_t *target = get_current_target(cmd_ctx);
-	armv7m_common_t *armv7m = target-&gt;arch_info;
-	cortex_m3_common_t *cortex_m3 = armv7m-&gt;arch_info;
+	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
+	int retval;
+
+	retval = cortex_m3_verify_pointer(cmd_ctx, cortex_m3);
+	if (retval != ERROR_OK)
+		return retval;
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
@@ -2016,4 +2001,3 @@ target_type_t cortexm3_target =
 	.has_mmu = cortex_m3_has_mmu,
 	.examine = cortex_m3_examine,
 };
-
diff --git a/src/target/cortex_m3.h b/src/target/cortex_m3.h
index 629db8e..9ad9dca 100644
--- a/src/target/cortex_m3.h
+++ b/src/target/cortex_m3.h
@@ -161,7 +161,6 @@ typedef struct cortex_m3_common_s
 	struct reg_cache_s *dwt_cache;
 
 	armv7m_common_t armv7m;
-	void *arch_info;
 } cortex_m3_common_t;
 
 static inline struct cortex_m3_common_s *

commit db116b1ea3c77a3c5850fccbce9e0795faa21dda
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Thu Nov 5 21:59:39 2009 -0800

    target: provide container_of()
    
    Provide a cleaner way to handle single inheritance of targets
    in C, using the same model Linux does:  structs containing other
    structs, un-nested via calls to a &quot;container_of()&quot; macro that
    are packaged in typesafe inline functions.
    
    Targets already use this containment idiom, but make it much
    more complicated because they un-nest using embedded &quot;void *&quot;
    pointers ... in chains of up to five per target, which is all
    pure needless complication.  (Example: arm92x core, arm9tdmi,
    arm7_9, armv4_5 ... on top of the base &quot;target&quot; class.)
    
    Applying this scheme consistently simplifies things, and gets
    rid of many error-prone untyped pointers.  It won't change any
    part of the type model though -- it just simplifies things.
    (And facilitates more cleanup later on.)
    
    Rule of thumb:  where there's an X-&gt;arch_info void* pointer,
    access to that pointer can and should be removed.  It may be
    convenient to set up pointers to some of the embedded structs;
    and shrink their current &quot;*_common&quot; names (annoyingly long).
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/arm720t.h b/src/target/arm720t.h
index c769626..0689e44 100644
--- a/src/target/arm720t.h
+++ b/src/target/arm720t.h
@@ -35,4 +35,11 @@ typedef struct arm720t_common_s
 	uint32_t far_reg;
 } arm720t_common_t;
 
+static inline struct arm720t_common_s *
+target_to_arm720(struct target_s *target)
+{
+	return container_of(target-&gt;arch_info, struct arm720t_common_s,
+			arm7tdmi_common.arm7_9_common.armv4_5_common);
+}
+
 #endif /* ARM720T_H */
diff --git a/src/target/arm7_9_common.h b/src/target/arm7_9_common.h
index 80f8fc7..d86ac24 100644
--- a/src/target/arm7_9_common.h
+++ b/src/target/arm7_9_common.h
@@ -112,6 +112,13 @@ typedef struct arm7_9_common_s
 
 } arm7_9_common_t;
 
+static inline struct arm7_9_common_s *
+target_to_arm7_9(struct target_s *target)
+{
+	return container_of(target-&gt;arch_info, struct arm7_9_common_s,
+			armv4_5_common);
+}
+
 int arm7_9_register_commands(struct command_context_s *cmd_ctx);
 
 int arm7_9_poll(target_t *target);
diff --git a/src/target/arm920t.h b/src/target/arm920t.h
index ed851a9..eb66eaa 100644
--- a/src/target/arm920t.h
+++ b/src/target/arm920t.h
@@ -38,6 +38,13 @@ typedef struct arm920t_common_s
 	int preserve_cache;
 } arm920t_common_t;
 
+static inline struct arm920t_common_s *
+target_to_arm920(struct target_s *target)
+{
+	return container_of(target-&gt;arch_info, struct arm920t_common_s,
+			arm9tdmi_common.arm7_9_common.armv4_5_common);
+}
+
 typedef struct arm920t_cache_line_s
 {
 	uint32_t cam;
diff --git a/src/target/arm926ejs.h b/src/target/arm926ejs.h
index 7adbf1f..ff811e3 100644
--- a/src/target/arm926ejs.h
+++ b/src/target/arm926ejs.h
@@ -38,6 +38,14 @@ typedef struct arm926ejs_common_s
 	uint32_t d_far;
 } arm926ejs_common_t;
 
+static inline struct arm926ejs_common_s *
+target_to_arm926(struct target_s *target)
+{
+	return container_of(target-&gt;arch_info, struct arm926ejs_common_s,
+		arm9tdmi_common.arm7_9_common.armv4_5_common);
+}
+
+
 extern int arm926ejs_init_arch_info(target_t *target, arm926ejs_common_t *arm926ejs, jtag_tap_t *tap);
 extern int arm926ejs_register_commands(struct command_context_s *cmd_ctx);
 extern int arm926ejs_arch_state(struct target_s *target);
diff --git a/src/target/arm966e.h b/src/target/arm966e.h
index 21dee1e..710f207 100644
--- a/src/target/arm966e.h
+++ b/src/target/arm966e.h
@@ -34,6 +34,13 @@ typedef struct arm966e_common_s
 	uint32_t cp15_control_reg;
 } arm966e_common_t;
 
+static inline struct arm966e_common_s *
+target_to_arm966(struct target_s *target)
+{
+	return container_of(target-&gt;arch_info, struct arm966e_common_s,
+			arm9tdmi_common.arm7_9_common.armv4_5_common);
+}
+
 extern int arm966e_init_arch_info(target_t *target, arm966e_common_t *arm966e, jtag_tap_t *tap);
 extern int arm966e_register_commands(struct command_context_s *cmd_ctx);
 extern int arm966e_write_cp15(target_t *target, int reg_addr, uint32_t value);
diff --git a/src/target/armv4_5.h b/src/target/armv4_5.h
index 80f28db..fb7926b 100644
--- a/src/target/armv4_5.h
+++ b/src/target/armv4_5.h
@@ -86,6 +86,12 @@ typedef struct armv4_5_common_s
 	void *arch_info;
 } armv4_5_common_t;
 
+static inline struct armv4_5_common_s *
+target_to_armv4_5(struct target_s *target)
+{
+	return target-&gt;arch_info;
+}
+
 typedef struct armv4_5_algorithm_s
 {
 	int common_magic;
diff --git a/src/target/armv7a.h b/src/target/armv7a.h
index c5e3257..3fc97f1 100644
--- a/src/target/armv7a.h
+++ b/src/target/armv7a.h
@@ -127,6 +127,13 @@ typedef struct armv7a_common_s
 
 } armv7a_common_t;
 
+static inline struct armv7a_common_s *
+target_to_armv7a(struct target_s *target)
+{
+	return container_of(target-&gt;arch_info, struct armv7a_common_s,
+			armv4_5_common);
+}
+
 typedef struct armv7a_algorithm_s
 {
 	int common_magic;
diff --git a/src/target/armv7m.h b/src/target/armv7m.h
index d9c62a8..487d6fd 100644
--- a/src/target/armv7m.h
+++ b/src/target/armv7m.h
@@ -116,6 +116,12 @@ typedef struct armv7m_common_s
 	void *arch_info;
 } armv7m_common_t;
 
+static inline struct armv7m_common_s *
+target_to_armv7m(struct target_s *target)
+{
+	return target-&gt;arch_info;
+}
+
 typedef struct armv7m_algorithm_s
 {
 	int common_magic;
diff --git a/src/target/cortex_a8.h b/src/target/cortex_a8.h
index 3695696..b98a7de 100644
--- a/src/target/cortex_a8.h
+++ b/src/target/cortex_a8.h
@@ -137,6 +137,13 @@ typedef struct cortex_a8_common_s
 	void *arch_info;
 } cortex_a8_common_t;
 
+static inline struct cortex_a8_common_s *
+target_to_cortex_a8(struct target_s *target)
+{
+	return container_of(target-&gt;arch_info, struct cortex_a8_common_s,
+			armv7a_common.armv4_5_common);
+}
+
 extern int cortex_a8_init_arch_info(target_t *target, cortex_a8_common_t *cortex_a8, jtag_tap_t *tap);
 int cortex_a8_read_memory(struct target_s *target, uint32_t address, uint32_t size, uint32_t count, uint8_t *buffer);
 int cortex_a8_write_memory(struct target_s *target, uint32_t address, uint32_t size, uint32_t count, uint8_t *buffer);
diff --git a/src/target/cortex_m3.h b/src/target/cortex_m3.h
index 1dd724c..629db8e 100644
--- a/src/target/cortex_m3.h
+++ b/src/target/cortex_m3.h
@@ -164,4 +164,11 @@ typedef struct cortex_m3_common_s
 	void *arch_info;
 } cortex_m3_common_t;
 
+static inline struct cortex_m3_common_s *
+target_to_cm3(struct target_s *target)
+{
+	return container_of(target-&gt;arch_info,
+			struct cortex_m3_common_s, armv7m);
+}
+
 #endif /* CORTEX_M3_H */
diff --git a/src/target/target.h b/src/target/target.h
index c971f18..1bbf40f 100644
--- a/src/target/target.h
+++ b/src/target/target.h
@@ -26,6 +26,8 @@
 #ifndef TARGET_H
 #define TARGET_H
 
+#include &lt;stddef.h&gt;
+
 #include &quot;breakpoints.h&quot;
 #include &quot;algorithm.h&quot;
 #include &quot;command.h&quot;
@@ -34,6 +36,19 @@ struct reg_s;
 struct trace_s;
 struct command_context_s;
 
+
+/**
+ * Cast a member of a structure out to the containing structure.
+ * @param ptr The pointer to the member.
+ * @param type The type of the container struct this is embedded in.
+ * @param member The name of the member within the struct.
+ *
+ * This is a mechanism which is used throughout the Linux kernel.
+ */
+#define container_of(ptr, type, member) ({			\
+	const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr);	\
+	(type *)( (char *)__mptr - offsetof(type,member) );})
+
 /*
  * TARGET_UNKNOWN = 0: we don't know anything about the target yet
  * TARGET_RUNNING = 1: the target is executing user code
diff --git a/src/target/xscale.h b/src/target/xscale.h
index 4b34cf8..a1f3d46 100644
--- a/src/target/xscale.h
+++ b/src/target/xscale.h
@@ -134,6 +134,13 @@ typedef struct xscale_common_s
 	int fast_memory_access;
 } xscale_common_t;
 
+static inline struct xscale_common_s *
+target_to_xscale(struct target_s *target)
+{
+	return container_of(target-&gt;arch_info, struct xscale_common_s,
+			armv4_5_common);
+}
+
 typedef struct xscale_reg_s
 {
 	int dbg_handler_number;

-----------------------------------------------------------------------

Summary of changes:
 src/target/arm720t.c       |  110 +++++------------
 src/target/arm720t.h       |    9 +-
 src/target/arm7_9_common.c |  129 ++++++++-----------
 src/target/arm7_9_common.h |   10 +-
 src/target/arm7tdmi.c      |   91 ++++----------
 src/target/arm7tdmi.h      |    7 +-
 src/target/arm920t.c       |  211 ++++++++++--------------------
 src/target/arm920t.h       |    9 +-
 src/target/arm926ejs.c     |  171 +++++++------------------
 src/target/arm926ejs.h     |   10 ++-
 src/target/arm966e.c       |   63 ++--------
 src/target/arm966e.h       |    9 +-
 src/target/arm9tdmi.c      |  135 +++++---------------
 src/target/arm9tdmi.h      |    7 +-
 src/target/arm_simulator.c |   22 ++--
 src/target/armv4_5.c       |   18 ++--
 src/target/armv4_5.h       |    6 +
 src/target/armv7a.c        |   28 ++---
 src/target/armv7a.h        |    8 +-
 src/target/armv7m.c        |   52 ++++----
 src/target/armv7m.h        |    9 +-
 src/target/cortex_a8.c     |  146 ++++++---------------
 src/target/cortex_a8.h     |    8 +-
 src/target/cortex_m3.c     |  192 +++++++++++++---------------
 src/target/cortex_m3.h     |    8 +-
 src/target/embeddedice.c   |    9 +-
 src/target/etm.c           |    3 +-
 src/target/fa526.c         |   35 +----
 src/target/target.h        |   15 ++
 src/target/xscale.c        |  305 +++++++++++++++++---------------------------
 src/target/xscale.h        |   16 ++-
 31 files changed, 685 insertions(+), 1166 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001731.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-74-gb7e4c26
</A></li>
	<LI>Next message: <A HREF="001733.html">[openocd-svn] Main OpenOCD repository annotated tag, v0.1.0,	created. v0.1.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1732">[ date ]</a>
              <a href="thread.html#1732">[ thread ]</a>
              <a href="subject.html#1732">[ subject ]</a>
              <a href="author.html#1732">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openocd-svn">More information about the openocd-svn
mailing list</a><br>
</body></html>
