<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-531-gdc22fd8
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openocd-svn/2009-November/index.html" >
   <LINK REL="made" HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.3.0-531-gdc22fd8&In-Reply-To=%3CE1NCHB5-000463-CH%40sfp-scmshell-4.v30.ch3.sourceforge.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001841.html">
   <LINK REL="Next"  HREF="001843.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-531-gdc22fd8</H1>
    <B>David Brownell</B> 
    <A HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.3.0-531-gdc22fd8&In-Reply-To=%3CE1NCHB5-000463-CH%40sfp-scmshell-4.v30.ch3.sourceforge.com%3E"
       TITLE="[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-531-gdc22fd8">dbrownell at users.sourceforge.net
       </A><BR>
    <I>Sun Nov 22 19:28:50 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001841.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-526-g5416c52
</A></li>
        <LI>Next message: <A HREF="001843.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-532-gbcebce3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1842">[ date ]</a>
              <a href="thread.html#1842">[ thread ]</a>
              <a href="subject.html#1842">[ subject ]</a>
              <a href="author.html#1842">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Main OpenOCD repository&quot;.

The branch, master has been updated
       via  dc22fd899eb8081c46566566cfe23d11e13a7b63 (commit)
       via  b404b9ab57f17d84eb8dbfb42e6ac49c32913eee (commit)
       via  fa618cc74deea6741c745b4f80dace2421209a1e (commit)
       via  1c619a2f12cbfe1887824d41e68e85a1c4f5a8b3 (commit)
       via  ab5ac33fd462c37e4cf5a6bc1fe5fd0631e44469 (commit)
      from  5416c525d4e232161572fbbd1b200a7f3a7c2819 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit dc22fd899eb8081c46566566cfe23d11e13a7b63
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Sun Nov 22 10:28:19 2009 -0800

    TODO: ref 'checkstack.pl' not 'checkpatch.pl'
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/TODO b/TODO
index 2b7fad9..c7e341d 100644
--- a/TODO
+++ b/TODO
@@ -308,10 +308,10 @@ fairly easy to complete:
 
 
 - use dynamic allocations for working memory. Scan &amp; fix code
-for excessive stack allocations. take linux/scripts/checkpatch.pl and
+for excessive stack allocations. take linux/scripts/checkstack.pl and
 see what the worst offenders are.  Example, on amd64:
 
- $ objdump -d | checkpatch.pl | head -10
+ $ objdump -d | checkstack.pl | head -10
  0x004311e3 image_open [openocd]:                      13464
  0x00431301 image_open [openocd]:                      13464
  0x004237a4 target_array2mem [openocd]:                        4376

commit b404b9ab57f17d84eb8dbfb42e6ac49c32913eee
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Sun Nov 22 10:21:48 2009 -0800

    ARM: use arm_reg_current()
    
    Start using the arm_reg_current() call.  This shrinks and speeds
    the affected code.  It can also prevent some coredumps coming from
    invalid CPSR values ... the ARMV4_5_CORE_REG_MODE() macro returns
    bogus registers if e.g. &quot;Secure Monitor&quot; mode isn't supported by
    the current CPU.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/arm7_9_common.c b/src/target/arm7_9_common.c
index a58bd3b..4c5e286 100644
--- a/src/target/arm7_9_common.c
+++ b/src/target/arm7_9_common.c
@@ -1245,9 +1245,11 @@ int arm7_9_soft_reset_halt(struct target *target)
 	/* reset registers */
 	for (i = 0; i &lt;= 14; i++)
 	{
-		buf_set_u32(ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, i).value, 0, 32, 0xffffffff);
-		ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, i).dirty = 1;
-		ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, i).valid = 1;
+		struct reg *r = arm_reg_current(armv4_5, i);
+
+		buf_set_u32(r-&gt;value, 0, 32, 0xffffffff);
+		r-&gt;dirty = 1;
+		r-&gt;valid = 1;
 	}
 
 	if ((retval = target_call_event_callbacks(target, TARGET_EVENT_HALTED)) != ERROR_OK)
@@ -1443,32 +1445,31 @@ static int arm7_9_debug_entry(struct target *target)
 
 	for (i = 0; i &lt;= 15; i++)
 	{
+		struct reg *r = arm_reg_current(armv4_5, i);
+
 		LOG_DEBUG(&quot;r%i: 0x%8.8&quot; PRIx32 &quot;&quot;, i, context[i]);
-		buf_set_u32(ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, i).value, 0, 32, context[i]);
-		ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, i).dirty = 0;
-		ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, i).valid = 1;
+
+		buf_set_u32(r-&gt;value, 0, 32, context[i]);
+		/* r0 and r15 (pc) have to be restored later */
+		r-&gt;dirty = (i == 0) || (i == 15);
+		r-&gt;valid = 1;
 	}
 
 	LOG_DEBUG(&quot;entered debug state at PC 0x%&quot; PRIx32 &quot;&quot;, context[15]);
 
 	/* exceptions other than USR &amp; SYS have a saved program status register */
-	if ((armv4_5-&gt;core_mode != ARMV4_5_MODE_USR) &amp;&amp; (armv4_5-&gt;core_mode != ARMV4_5_MODE_SYS))
-	{
+	if (armv4_5-&gt;spsr) {
 		uint32_t spsr;
 		arm7_9-&gt;read_xpsr(target, &amp;spsr, 1);
 		if ((retval = jtag_execute_queue()) != ERROR_OK)
 		{
 			return retval;
 		}
-		buf_set_u32(ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 16).value, 0, 32, spsr);
-		ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 16).dirty = 0;
-		ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 16).valid = 1;
+		buf_set_u32(armv4_5-&gt;spsr-&gt;value, 0, 32, spsr);
+		armv4_5-&gt;spsr-&gt;dirty = 0;
+		armv4_5-&gt;spsr-&gt;valid = 1;
 	}
 
-	/* r0 and r15 (pc) have to be restored later */
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 0).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 0).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 15).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 15).valid;
-
 	if ((retval = jtag_execute_queue()) != ERROR_OK)
 		return retval;
 
@@ -2377,8 +2378,11 @@ int arm7_9_read_memory(struct target *target, uint32_t address, uint32_t size, u
 	if (!is_arm_mode(armv4_5-&gt;core_mode))
 		return ERROR_FAIL;
 
-	for (i = 0; i &lt;= last_reg; i++)
-		ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, i).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, i).valid;
+	for (i = 0; i &lt;= last_reg; i++) {
+		struct reg *r = arm_reg_current(armv4_5, i);
+
+		r-&gt;dirty = r-&gt;valid;
+	}
 
 	arm7_9-&gt;read_xpsr(target, &amp;cpsr, 0);
 	if ((retval = jtag_execute_queue()) != ERROR_OK)
@@ -2562,8 +2566,11 @@ int arm7_9_write_memory(struct target *target, uint32_t address, uint32_t size,
 	if (!is_arm_mode(armv4_5-&gt;core_mode))
 		return ERROR_FAIL;
 
-	for (i = 0; i &lt;= last_reg; i++)
-		ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, i).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, i).valid;
+	for (i = 0; i &lt;= last_reg; i++) {
+		struct reg *r = arm_reg_current(armv4_5, i);
+
+		r-&gt;dirty = r-&gt;valid;
+	}
 
 	arm7_9-&gt;read_xpsr(target, &amp;cpsr, 0);
 	if ((retval = jtag_execute_queue()) != ERROR_OK)
diff --git a/src/target/arm920t.c b/src/target/arm920t.c
index a1fb7f3..0610c93 100644
--- a/src/target/arm920t.c
+++ b/src/target/arm920t.c
@@ -216,6 +216,7 @@ static int arm920t_read_cp15_interpreted(struct target *target,
 	uint32_t* regs_p[1];
 	uint32_t regs[2];
 	uint32_t cp15c15 = 0x0;
+	struct reg *r = armv4_5-&gt;core_cache-&gt;reg_list;
 
 	/* load address into R1 */
 	regs[1] = address;
@@ -247,8 +248,8 @@ static int arm920t_read_cp15_interpreted(struct target *target,
 	if (!is_arm_mode(armv4_5-&gt;core_mode))
 		return ERROR_FAIL;
 
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 0).dirty = 1;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 1).dirty = 1;
+	r[0].dirty = 1;
+	r[1].dirty = 1;
 
 	return ERROR_OK;
 }
@@ -260,6 +261,7 @@ int arm920t_write_cp15_interpreted(struct target *target,
 	uint32_t cp15c15 = 0x0;
 	struct arm *armv4_5 = target_to_armv4_5(target);
 	uint32_t regs[2];
+	struct reg *r = armv4_5-&gt;core_cache-&gt;reg_list;
 
 	/* load value, address into R0, R1 */
 	regs[0] = value;
@@ -287,8 +289,8 @@ int arm920t_write_cp15_interpreted(struct target *target,
 	if (!is_arm_mode(armv4_5-&gt;core_mode))
 		return ERROR_FAIL;
 
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 0).dirty = 1;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 1).dirty = 1;
+	r[0].dirty = 1;
+	r[1].dirty = 1;
 
 	return ERROR_OK;
 }
@@ -678,6 +680,7 @@ COMMAND_HANDLER(arm920t_handle_read_cache_command)
 	FILE *output;
 	struct arm920t_cache_line d_cache[8][64], i_cache[8][64];
 	int segment, index;
+	struct reg *r;
 
 	retval = arm920t_verify_pointer(CMD_CTX, arm920t);
 	if (retval != ERROR_OK)
@@ -893,17 +896,22 @@ COMMAND_HANDLER(arm920t_handle_read_cache_command)
 	if (!is_arm_mode(armv4_5-&gt;core_mode))
 		return ERROR_FAIL;
 
-	/* mark registers dirty. */
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 0).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 0).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 1).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 1).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 2).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 2).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 3).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 3).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 4).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 4).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 5).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 5).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 6).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 6).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 7).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 7).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 8).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 8).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 9).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 9).valid;
+	/* force writeback of the valid data */
+	r = armv4_5-&gt;core_cache-&gt;reg_list;
+	r[0].dirty = r[0].valid;
+	r[1].dirty = r[1].valid;
+	r[2].dirty = r[2].valid;
+	r[3].dirty = r[3].valid;
+	r[4].dirty = r[4].valid;
+	r[5].dirty = r[5].valid;
+	r[6].dirty = r[6].valid;
+	r[7].dirty = r[7].valid;
+
+	r = arm_reg_current(armv4_5, 8);
+	r-&gt;dirty = r-&gt;valid;
+
+	r = arm_reg_current(armv4_5, 9);
+	r-&gt;dirty = r-&gt;valid;
 
 	return ERROR_OK;
 }
@@ -924,6 +932,7 @@ COMMAND_HANDLER(arm920t_handle_read_mmu_command)
 	uint32_t Dlockdown, Ilockdown;
 	struct arm920t_tlb_entry d_tlb[64], i_tlb[64];
 	int victim;
+	struct reg *r;
 
 	retval = arm920t_verify_pointer(CMD_CTX, arm920t);
 	if (retval != ERROR_OK)
@@ -1176,17 +1185,22 @@ COMMAND_HANDLER(arm920t_handle_read_mmu_command)
 	if (!is_arm_mode(armv4_5-&gt;core_mode))
 		return ERROR_FAIL;
 
-	/* mark registers dirty */
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 0).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 0).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 1).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 1).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 2).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 2).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 3).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 3).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 4).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 4).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 5).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 5).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 6).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 6).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 7).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 7).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 8).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 8).valid;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 9).dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 9).valid;
+	/* force writeback of the valid data */
+	r = armv4_5-&gt;core_cache-&gt;reg_list;
+	r[0].dirty = r[0].valid;
+	r[1].dirty = r[1].valid;
+	r[2].dirty = r[2].valid;
+	r[3].dirty = r[3].valid;
+	r[4].dirty = r[4].valid;
+	r[5].dirty = r[5].valid;
+	r[6].dirty = r[6].valid;
+	r[7].dirty = r[7].valid;
+
+	r = arm_reg_current(armv4_5, 8);
+	r-&gt;dirty = r-&gt;valid;
+
+	r = arm_reg_current(armv4_5, 9);
+	r-&gt;dirty = r-&gt;valid;
 
 	return ERROR_OK;
 }
diff --git a/src/target/cortex_a8.c b/src/target/cortex_a8.c
index de579fe..b006e81 100644
--- a/src/target/cortex_a8.c
+++ b/src/target/cortex_a8.c
@@ -496,8 +496,7 @@ static int cortex_a8_resume(struct target *target, int current,
 
 	/* current = 1: continue on current pc, otherwise continue at &lt;address&gt; */
 	resume_pc = buf_get_u32(
-			ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache,
-				armv4_5-&gt;core_mode, 15).value,
+			armv4_5-&gt;core_cache-&gt;reg_list[15].value,
 			0, 32);
 	if (!current)
 		resume_pc = address;
@@ -522,13 +521,10 @@ static int cortex_a8_resume(struct target *target, int current,
 		return ERROR_FAIL;
 	}
 	LOG_DEBUG(&quot;resume pc = 0x%08&quot; PRIx32, resume_pc);
-	buf_set_u32(ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache,
-				armv4_5-&gt;core_mode, 15).value,
+	buf_set_u32(armv4_5-&gt;core_cache-&gt;reg_list[15].value,
 			0, 32, resume_pc);
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache,
-			armv4_5-&gt;core_mode, 15).dirty = 1;
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache,
-			armv4_5-&gt;core_mode, 15).valid = 1;
+	armv4_5-&gt;core_cache-&gt;reg_list[15].dirty = 1;
+	armv4_5-&gt;core_cache-&gt;reg_list[15].valid = 1;
 
 	cortex_a8_restore_context(target);
 
@@ -653,8 +649,7 @@ static int cortex_a8_debug_entry(struct target *target)
 	/* update cache */
 	for (i = 0; i &lt;= ARM_PC; i++)
 	{
-		reg = &amp;ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache,
-					armv4_5-&gt;core_mode, i);
+		reg = arm_reg_current(armv4_5, i);
 
 		buf_set_u32(reg-&gt;value, 0, 32, regfile[i]);
 		reg-&gt;valid = 1;
@@ -672,13 +667,10 @@ static int cortex_a8_debug_entry(struct target *target)
 		// ARM state
 		regfile[ARM_PC] -= 8;
 	}
-	buf_set_u32(ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache,
-				armv4_5-&gt;core_mode, ARM_PC).value,
-			0, 32, regfile[ARM_PC]);
 
-	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 0)
-		.dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache,
-				armv4_5-&gt;core_mode, 0).valid;
+	reg = armv4_5-&gt;core_cache-&gt;reg_list + 15;
+	buf_set_u32(reg-&gt;value, 0, 32, regfile[ARM_PC]);
+	reg-&gt;dirty = reg-&gt;valid;
 	ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache, armv4_5-&gt;core_mode, 15)
 		.dirty = ARMV4_5_CORE_REG_MODE(armv4_5-&gt;core_cache,
 				armv4_5-&gt;core_mode, 15).valid;

commit fa618cc74deea6741c745b4f80dace2421209a1e
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Sun Nov 22 10:21:22 2009 -0800

    ARM11: remove needless string format #ifdeffery
    
    We don't need to use size_t in these places; so it's easy
    to be rid of the need for this #ifdef and its MS-derived
    portability problems.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/arm11.c b/src/target/arm11.c
index 9c42705..1a7b4e0 100644
--- a/src/target/arm11.c
+++ b/src/target/arm11.c
@@ -448,15 +448,16 @@ static int arm11_leave_debug_state(struct arm11_common *arm11)
 
 	/* restore R1 - R14 */
 
-	for (size_t i = 1; i &lt; 15; i++)
+	for (unsigned i = 1; i &lt; 15; i++)
 	{
 		if (!arm11-&gt;reg_list[ARM11_RC_RX + i].dirty)
 			continue;
 
 		/* MRC p14,0,r?,c0,c5,0 */
-		arm11_run_instr_data_to_core1(arm11, 0xee100e15 | (i &lt;&lt; 12), R(RX + i));
+		arm11_run_instr_data_to_core1(arm11,
+				0xee100e15 | (i &lt;&lt; 12), R(RX + i));
 
-		//	LOG_DEBUG(&quot;RESTORE R&quot; ZU &quot; %08x&quot;, i, R(RX + i));
+		//	LOG_DEBUG(&quot;RESTORE R%u %08x&quot;, i, R(RX + i));
 	}
 
 	retval = arm11_run_instr_data_finish(arm11);
@@ -742,7 +743,7 @@ static int arm11_resume(struct target *target, int current,
 
 		/* set all breakpoints */
 
-		size_t		brp_num = 0;
+		unsigned brp_num = 0;
 
 		for (bp = target-&gt;breakpoints; bp; bp = bp-&gt;next)
 		{
@@ -757,7 +758,8 @@ static int arm11_resume(struct target *target, int current,
 
 			arm11_sc7_run(arm11, brp, ARRAY_SIZE(brp));
 
-			LOG_DEBUG(&quot;Add BP &quot; ZU &quot; at %08&quot; PRIx32 &quot;&quot;, brp_num, bp-&gt;address);
+			LOG_DEBUG(&quot;Add BP %d at %08&quot; PRIx32, brp_num,
+					bp-&gt;address);
 
 			brp_num++;
 		}
@@ -1869,7 +1871,14 @@ static int arm11_build_reg_cache(struct target *target)
 		ARM11_REGCACHE_COUNT != ARRAY_SIZE(arm11_reg_defs) ||
 		ARM11_REGCACHE_COUNT != ARM11_RC_MAX)
 	{
-		LOG_ERROR(&quot;BUG: arm11-&gt;reg_values inconsistent (%d &quot; ZU &quot; &quot; ZU &quot; %d)&quot;, ARM11_REGCACHE_COUNT, ARRAY_SIZE(arm11-&gt;reg_values), ARRAY_SIZE(arm11_reg_defs), ARM11_RC_MAX);
+		LOG_ERROR(&quot;BUG: arm11-&gt;reg_values inconsistent (%d %u %u %d)&quot;,
+				ARM11_REGCACHE_COUNT,
+				(unsigned) ARRAY_SIZE(arm11-&gt;reg_values),
+				(unsigned) ARRAY_SIZE(arm11_reg_defs),
+				ARM11_RC_MAX);
+		/* FIXME minimally, use a build_bug_on(X) mechanism;
+		 * runtime exit() here is bad!
+		 */
 		exit(-1);
 	}
 
diff --git a/src/target/arm11.h b/src/target/arm11.h
index 79f4b6b..0b37929 100644
--- a/src/target/arm11.h
+++ b/src/target/arm11.h
@@ -28,16 +28,6 @@
 #define NEW(type, variable, items)			\
 	type * variable = calloc(1, sizeof(type) * items)
 
-/* For MinGW use 'I' prefix to print size_t (instead of 'z') */
-/* Except if __USE_MINGW_ANSI_STDIO is defined with MinGW    */
-
-#if (!defined(__MSVCRT__) || defined(__USE_MINGW_ANSI_STDIO))
-#define ZU		&quot;%zu&quot;
-#else
-#define ZU		&quot;%Iu&quot;
-#endif
-
-
 /* TEMPORARY -- till we switch to the shared infrastructure */
 #define ARM11_REGCACHE_COUNT		20
 
diff --git a/src/target/arm11_dbgtap.c b/src/target/arm11_dbgtap.c
index bdbcc8f..0f7e495 100644
--- a/src/target/arm11_dbgtap.c
+++ b/src/target/arm11_dbgtap.c
@@ -588,12 +588,13 @@ int arm11_run_instr_data_to_core_noack(struct arm11_common * arm11, uint32_t opc
 	arm11_setup_field(arm11,  1,    NULL,			NULL,				chain5_fields + 2);
 
 	uint8_t			*Readies;
-	size_t readiesNum = (count + 1);
-	size_t bytes = sizeof(*Readies)*readiesNum;
+	unsigned readiesNum = count + 1;
+	unsigned bytes = sizeof(*Readies)*readiesNum;
+
 	Readies = (uint8_t *) malloc(bytes);
 	if (Readies == NULL)
 	{
-		LOG_ERROR(&quot;Out of memory allocating &quot; ZU &quot; bytes&quot;, bytes);
+		LOG_ERROR(&quot;Out of memory allocating %u bytes&quot;, bytes);
 		return ERROR_FAIL;
 	}
 
@@ -626,7 +627,7 @@ int arm11_run_instr_data_to_core_noack(struct arm11_common * arm11, uint32_t opc
 	int retval = jtag_execute_queue();
 	if (retval == ERROR_OK)
 	{
-		size_t error_count = 0;
+		unsigned error_count = 0;
 
 		for (size_t i = 0; i &lt; readiesNum; i++)
 		{
@@ -637,7 +638,8 @@ int arm11_run_instr_data_to_core_noack(struct arm11_common * arm11, uint32_t opc
 		}
 
 		if (error_count &gt; 0 )
-			LOG_ERROR(ZU &quot; words out of &quot; ZU &quot; not transferred&quot;, error_count, readiesNum);
+			LOG_ERROR(&quot;%u words out of %u not transferred&quot;,
+				error_count, readiesNum);
 
 	}
 

commit 1c619a2f12cbfe1887824d41e68e85a1c4f5a8b3
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Sun Nov 22 10:20:14 2009 -0800

    target: make register flags &quot;bool&quot;
    
    Mostly for clarity, but it also saves code and data space.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/register.h b/src/target/register.h
index 0f8f2f4..0cd0ddf 100644
--- a/src/target/register.h
+++ b/src/target/register.h
@@ -29,8 +29,8 @@ struct reg
 {
 	char *name;
 	void *value;
-	int dirty;
-	int valid;
+	bool dirty;
+	bool valid;
 	uint32_t size;
 	void *arch_info;
 	const struct reg_arch_type *type;

commit ab5ac33fd462c37e4cf5a6bc1fe5fd0631e44469
Author: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;
Date:   Sun Nov 22 10:19:58 2009 -0800

    ARM: remove 'armv4_5_common_s' migration #define
    
    Finish migrating from the old symbol to the new one.
    
    Signed-off-by: David Brownell &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">dbrownell at users.sourceforge.net</A>&gt;

diff --git a/src/target/arm720t.c b/src/target/arm720t.c
index 3aa77ea..f9388ab 100644
--- a/src/target/arm720t.c
+++ b/src/target/arm720t.c
@@ -225,7 +225,7 @@ static int arm720t_verify_pointer(struct command_context *cmd_ctx,
 static int arm720t_arch_state(struct target *target)
 {
 	struct arm720t_common *arm720t = target_to_arm720(target);
-	struct armv4_5_common_s *armv4_5;
+	struct arm *armv4_5;
 
 	static const char *state[] =
 	{
@@ -307,7 +307,7 @@ static int arm720t_soft_reset_halt(struct target *target)
 	struct arm720t_common *arm720t = target_to_arm720(target);
 	struct reg *dbg_stat = &amp;arm720t-&gt;arm7_9_common
 			.eice_cache-&gt;reg_list[EICE_DBG_STAT];
-	struct armv4_5_common_s *armv4_5 = &amp;arm720t-&gt;arm7_9_common
+	struct arm *armv4_5 = &amp;arm720t-&gt;arm7_9_common
 			.armv4_5_common;
 
 	if ((retval = target_halt(target)) != ERROR_OK)
diff --git a/src/target/arm7_9_common.c b/src/target/arm7_9_common.c
index 19fe98d..a58bd3b 100644
--- a/src/target/arm7_9_common.c
+++ b/src/target/arm7_9_common.c
@@ -1160,7 +1160,7 @@ int arm7_9_clear_halt(struct target *target)
 int arm7_9_soft_reset_halt(struct target *target)
 {
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	struct reg *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 	struct reg *dbg_ctrl = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_CTRL];
 	int i;
@@ -1338,7 +1338,7 @@ static int arm7_9_debug_entry(struct target *target)
 	uint32_t cpsr, cpsr_mask = 0;
 	int retval;
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	struct reg *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 	struct reg *dbg_ctrl = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_CTRL];
 
@@ -1492,7 +1492,7 @@ int arm7_9_full_context(struct target *target)
 	int i;
 	int retval;
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 
 	LOG_DEBUG(&quot;-&quot;);
 
@@ -1586,7 +1586,7 @@ int arm7_9_full_context(struct target *target)
 int arm7_9_restore_context(struct target *target)
 {
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	struct reg *reg;
 	struct arm_reg *reg_arch_info;
 	enum armv4_5_mode current_mode = armv4_5-&gt;core_mode;
@@ -1797,7 +1797,7 @@ void arm7_9_enable_breakpoints(struct target *target)
 int arm7_9_resume(struct target *target, int current, uint32_t address, int handle_breakpoints, int debug_execution)
 {
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	struct breakpoint *breakpoint = target-&gt;breakpoints;
 	struct reg *dbg_ctrl = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_CTRL];
 	int err, retval = ERROR_OK;
@@ -1957,7 +1957,7 @@ int arm7_9_resume(struct target *target, int current, uint32_t address, int hand
 void arm7_9_enable_eice_step(struct target *target, uint32_t next_pc)
 {
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	uint32_t current_pc;
 	current_pc = buf_get_u32(armv4_5-&gt;core_cache-&gt;reg_list[15].value, 0, 32);
 
@@ -2009,7 +2009,7 @@ void arm7_9_disable_eice_step(struct target *target)
 int arm7_9_step(struct target *target, int current, uint32_t address, int handle_breakpoints)
 {
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	struct breakpoint *breakpoint = NULL;
 	int err, retval;
 
@@ -2107,7 +2107,7 @@ static int arm7_9_read_core_reg(struct target *target, struct reg *r,
 	int retval;
 	struct arm_reg *areg = r-&gt;arch_info;
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 
 	if (!is_arm_mode(armv4_5-&gt;core_mode))
 		return ERROR_FAIL;
@@ -2169,7 +2169,7 @@ static int arm7_9_write_core_reg(struct target *target, struct reg *r,
 	uint32_t reg[16];
 	struct arm_reg *areg = r-&gt;arch_info;
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 
 	if (!is_arm_mode(armv4_5-&gt;core_mode))
 		return ERROR_FAIL;
@@ -2227,7 +2227,7 @@ static int arm7_9_write_core_reg(struct target *target, struct reg *r,
 int arm7_9_read_memory(struct target *target, uint32_t address, uint32_t size, uint32_t count, uint8_t *buffer)
 {
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	uint32_t reg[16];
 	uint32_t num_accesses = 0;
 	int thisrun_accesses;
@@ -2404,7 +2404,7 @@ int arm7_9_read_memory(struct target *target, uint32_t address, uint32_t size, u
 int arm7_9_write_memory(struct target *target, uint32_t address, uint32_t size, uint32_t count, uint8_t *buffer)
 {
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	struct reg *dbg_ctrl = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_CTRL];
 
 	uint32_t reg[16];
diff --git a/src/target/arm7tdmi.c b/src/target/arm7tdmi.c
index e7ea768..742eace 100644
--- a/src/target/arm7tdmi.c
+++ b/src/target/arm7tdmi.c
@@ -581,7 +581,7 @@ static void arm7tdmi_branch_resume(struct target *target)
 static void arm7tdmi_branch_resume_thumb(struct target *target)
 {
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	struct arm_jtag *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	struct reg *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 
@@ -641,7 +641,7 @@ static void arm7tdmi_branch_resume_thumb(struct target *target)
 static void arm7tdmi_build_reg_cache(struct target *target)
 {
 	struct reg_cache **cache_p = register_get_last_cache_p(&amp;target-&gt;reg_cache);
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 
 	(*cache_p) = armv4_5_build_reg_cache(target, armv4_5);
 }
diff --git a/src/target/arm920t.c b/src/target/arm920t.c
index 8a03554..a1fb7f3 100644
--- a/src/target/arm920t.c
+++ b/src/target/arm920t.c
@@ -212,7 +212,7 @@ static int arm920t_execute_cp15(struct target *target, uint32_t cp15_opcode,
 static int arm920t_read_cp15_interpreted(struct target *target,
 		uint32_t cp15_opcode, uint32_t address, uint32_t *value)
 {
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 	uint32_t* regs_p[1];
 	uint32_t regs[2];
 	uint32_t cp15c15 = 0x0;
@@ -258,7 +258,7 @@ int arm920t_write_cp15_interpreted(struct target *target,
 		uint32_t cp15_opcode, uint32_t value, uint32_t address)
 {
 	uint32_t cp15c15 = 0x0;
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 	uint32_t regs[2];
 
 	/* load value, address into R0, R1 */
@@ -436,7 +436,7 @@ int arm920t_arch_state(struct target *target)
 	};
 
 	struct arm920t_common *arm920t = target_to_arm920(target);
-	struct armv4_5_common_s *armv4_5;
+	struct arm *armv4_5;
 
 	if (arm920t-&gt;common_magic != ARM920T_COMMON_MAGIC)
 	{
@@ -555,7 +555,7 @@ int arm920t_soft_reset_halt(struct target *target)
 	int retval = ERROR_OK;
 	struct arm920t_common *arm920t = target_to_arm920(target);
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	struct reg *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 
 	if ((retval = target_halt(target)) != ERROR_OK)
@@ -668,7 +668,7 @@ COMMAND_HANDLER(arm920t_handle_read_cache_command)
 	struct target *target = get_current_target(CMD_CTX);
 	struct arm920t_common *arm920t = target_to_arm920(target);
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	uint32_t cp15c15;
 	uint32_t cp15_ctrl, cp15_ctrl_saved;
 	uint32_t regs[16];
@@ -914,7 +914,7 @@ COMMAND_HANDLER(arm920t_handle_read_mmu_command)
 	struct target *target = get_current_target(CMD_CTX);
 	struct arm920t_common *arm920t = target_to_arm920(target);
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	uint32_t cp15c15;
 	uint32_t cp15_ctrl, cp15_ctrl_saved;
 	uint32_t regs[16];
diff --git a/src/target/arm926ejs.c b/src/target/arm926ejs.c
index aa29989..a9d454b 100644
--- a/src/target/arm926ejs.c
+++ b/src/target/arm926ejs.c
@@ -494,7 +494,7 @@ int arm926ejs_arch_state(struct target *target)
 	};
 
 	struct arm926ejs_common *arm926ejs = target_to_arm926(target);
-	struct armv4_5_common_s *armv4_5;
+	struct arm *armv4_5;
 
 	if (arm926ejs-&gt;common_magic != ARM926EJS_COMMON_MAGIC)
 	{
@@ -524,7 +524,7 @@ int arm926ejs_soft_reset_halt(struct target *target)
 	int retval = ERROR_OK;
 	struct arm926ejs_common *arm926ejs = target_to_arm926(target);
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	struct reg *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 
 	if ((retval = target_halt(target)) != ERROR_OK)
diff --git a/src/target/arm9tdmi.c b/src/target/arm9tdmi.c
index 38b2284..298b26a 100644
--- a/src/target/arm9tdmi.c
+++ b/src/target/arm9tdmi.c
@@ -664,7 +664,7 @@ static void arm9tdmi_branch_resume_thumb(struct target *target)
 	LOG_DEBUG(&quot;-&quot;);
 
 	struct arm7_9_common *arm7_9 = target_to_arm7_9(target);
-	struct armv4_5_common_s *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;arm7_9-&gt;armv4_5_common;
 	struct arm_jtag *jtag_info = &amp;arm7_9-&gt;jtag_info;
 	struct reg *dbg_stat = &amp;arm7_9-&gt;eice_cache-&gt;reg_list[EICE_DBG_STAT];
 
@@ -751,7 +751,7 @@ void arm9tdmi_disable_single_step(struct target *target)
 static void arm9tdmi_build_reg_cache(struct target *target)
 {
 	struct reg_cache **cache_p = register_get_last_cache_p(&amp;target-&gt;reg_cache);
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 
 	(*cache_p) = armv4_5_build_reg_cache(target, armv4_5);
 }
diff --git a/src/target/arm_simulator.c b/src/target/arm_simulator.c
index 23cc556..73aac96 100644
--- a/src/target/arm_simulator.c
+++ b/src/target/arm_simulator.c
@@ -850,7 +850,7 @@ static enum armv4_5_mode armv4_5_get_mode(struct arm_sim_interface *sim)
 
 int arm_simulate_step(struct target *target, uint32_t *dry_run_pc)
 {
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 	struct arm_sim_interface sim;
 
 	sim.user_data = armv4_5;
diff --git a/src/target/armv4_5.c b/src/target/armv4_5.c
index 22e1186..461d206 100644
--- a/src/target/armv4_5.c
+++ b/src/target/armv4_5.c
@@ -487,7 +487,7 @@ static int armv4_5_set_core_reg(struct reg *reg, uint8_t *buf)
 {
 	struct arm_reg *armv4_5 = reg-&gt;arch_info;
 	struct target *target = armv4_5-&gt;target;
-	struct armv4_5_common_s *armv4_5_target = target_to_armv4_5(target);
+	struct arm *armv4_5_target = target_to_armv4_5(target);
 	uint32_t value = buf_get_u32(buf, 0, 32);
 
 	if (target-&gt;state != TARGET_HALTED)
@@ -579,7 +579,7 @@ struct reg_cache* armv4_5_build_reg_cache(struct target *target, struct arm *arm
 
 int armv4_5_arch_state(struct target *target)
 {
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 
 	if (armv4_5-&gt;common_magic != ARMV4_5_COMMON_MAGIC)
 	{
@@ -603,7 +603,7 @@ int armv4_5_arch_state(struct target *target)
 COMMAND_HANDLER(handle_armv4_5_reg_command)
 {
 	struct target *target = get_current_target(CMD_CTX);
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 	unsigned num_regs;
 	struct reg *regs;
 
@@ -690,7 +690,7 @@ COMMAND_HANDLER(handle_armv4_5_reg_command)
 COMMAND_HANDLER(handle_armv4_5_core_state_command)
 {
 	struct target *target = get_current_target(CMD_CTX);
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 
 	if (!is_arm(armv4_5))
 	{
@@ -810,7 +810,7 @@ int armv4_5_register_commands(struct command_context *cmd_ctx)
 
 int armv4_5_get_gdb_reg_list(struct target *target, struct reg **reg_list[], int *reg_list_size)
 {
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 	int i;
 
 	if (!is_arm_mode(armv4_5-&gt;core_mode))
@@ -835,7 +835,7 @@ int armv4_5_get_gdb_reg_list(struct target *target, struct reg **reg_list[], int
 static int armv4_5_run_algorithm_completion(struct target *target, uint32_t exit_point, int timeout_ms, void *arch_info)
 {
 	int retval;
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 
 	if ((retval = target_wait_state(target, TARGET_HALTED, timeout_ms)) != ERROR_OK)
 	{
@@ -866,7 +866,7 @@ static int armv4_5_run_algorithm_completion(struct target *target, uint32_t exit
 
 int armv4_5_run_algorithm_inner(struct target *target, int num_mem_params, struct mem_param *mem_params, int num_reg_params, struct reg_param *reg_params, uint32_t entry_point, uint32_t exit_point, int timeout_ms, void *arch_info, int (*run_it)(struct target *target, uint32_t exit_point, int timeout_ms, void *arch_info))
 {
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 	struct armv4_5_algorithm *armv4_5_algorithm_info = arch_info;
 	enum armv4_5_state core_state = armv4_5-&gt;core_state;
 	uint32_t context[17];
@@ -1217,7 +1217,7 @@ int arm_blank_check_memory(struct target *target,
 
 static int arm_full_context(struct target *target)
 {
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 	unsigned num_regs = armv4_5-&gt;core_cache-&gt;num_regs;
 	struct reg *reg = armv4_5-&gt;core_cache-&gt;reg_list;
 	int retval = ERROR_OK;
diff --git a/src/target/armv4_5.h b/src/target/armv4_5.h
index a9599c8..4931455 100644
--- a/src/target/armv4_5.h
+++ b/src/target/armv4_5.h
@@ -67,9 +67,6 @@ enum { ARMV4_5_CPSR = 31, };
 
 #define ARMV4_5_COMMON_MAGIC 0x0A450A45
 
-/* NOTE:  this is being morphed into a generic toplevel holder for ARMs. */
-#define armv4_5_common_s arm
-
 /**
  * Represents a generic ARM core, with standard application registers.
  *
diff --git a/src/target/armv7a.c b/src/target/armv7a.c
index 63f95b8..1d13779 100644
--- a/src/target/armv7a.c
+++ b/src/target/armv7a.c
@@ -59,7 +59,7 @@ int armv7a_arch_state(struct target *target)
 	};
 
 	struct armv7a_common *armv7a = target_to_armv7a(target);
-	struct armv4_5_common_s *armv4_5 = &amp;armv7a-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;armv7a-&gt;armv4_5_common;
 
 	if (armv7a-&gt;common_magic != ARMV7_COMMON_MAGIC)
 	{
diff --git a/src/target/cortex_a8.c b/src/target/cortex_a8.c
index fa26b6a..de579fe 100644
--- a/src/target/cortex_a8.c
+++ b/src/target/cortex_a8.c
@@ -457,7 +457,7 @@ static int cortex_a8_resume(struct target *target, int current,
 		uint32_t address, int handle_breakpoints, int debug_execution)
 {
 	struct armv7a_common *armv7a = target_to_armv7a(target);
-	struct armv4_5_common_s *armv4_5 = &amp;armv7a-&gt;armv4_5
_common;
+	struct arm *armv4_5 = &amp;armv7a-&gt;armv4_5_common;
 	struct swjdp_common *swjdp = &amp;armv7a-&gt;swjdp_info;
 
 //	struct breakpoint *breakpoint = NULL;
@@ -587,7 +587,7 @@ static int cortex_a8_debug_entry(struct target *target)
 	struct working_area *regfile_working_area = NULL;
 	struct cortex_a8_common *cortex_a8 = target_to_cortex_a8(target);
 	struct armv7a_common *armv7a = target_to_armv7a(target);
-	struct armv4_5_common_s *armv4_5 = &amp;armv7a-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;armv7a-&gt;armv4_5_common;
 	struct swjdp_common *swjdp = &amp;armv7a-&gt;swjdp_info;
 	struct reg *reg;
 
@@ -743,7 +743,7 @@ static int cortex_a8_step(struct target *target, int current, uint32_t address,
 		int handle_breakpoints)
 {
 	struct armv7a_common *armv7a = target_to_armv7a(target);
-	struct armv4_5_common_s *armv4_5 = &amp;armv7a-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;armv7a-&gt;armv4_5_common;
 	struct breakpoint *breakpoint = NULL;
 	struct breakpoint stepbreakpoint;
 
@@ -915,7 +915,7 @@ static int cortex_a8_load_core_reg_u32(struct target *target, int num,
 		armv4_5_mode_t mode, uint32_t * value)
 {
 	int retval;
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 
 	if ((num &lt;= ARM_CPSR))
 	{
@@ -953,7 +953,7 @@ static int cortex_a8_store_core_reg_u32(struct target *target, int num,
 {
 	int retval;
 //	uint32_t reg;
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 
 #ifdef ARMV7_GDB_HACKS
 	/* If the LR register is being modified, make sure it will put us
@@ -998,7 +998,7 @@ static int cortex_a8_read_core_reg(struct target *target, struct reg *r,
 {
 	uint32_t value;
 	int retval;
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 	struct reg *cpsr_r = NULL;
 	uint32_t cpsr = 0;
 	unsigned cookie = num;
@@ -1053,7 +1053,7 @@ static int cortex_a8_write_core_reg(struct target *target, struct reg *r,
 		int num, enum armv4_5_mode mode, uint32_t value)
 {
 	int retval;
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 	struct reg *cpsr_r = NULL;
 	uint32_t cpsr = 0;
 	unsigned cookie = num;
@@ -1584,7 +1584,7 @@ static int cortex_a8_examine(struct target *target)
 static void cortex_a8_build_reg_cache(struct target *target)
 {
 	struct reg_cache **cache_p = register_get_last_cache_p(&amp;target-&gt;reg_cache);
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 
 	armv4_5-&gt;core_type = ARM_MODE_MON;
 
diff --git a/src/target/xscale.c b/src/target/xscale.c
index e8a3e49..e471ac3 100644
--- a/src/target/xscale.c
+++ b/src/target/xscale.c
@@ -833,7 +833,7 @@ static int xscale_update_vectors(struct target *target)
 static int xscale_arch_state(struct target *target)
 {
 	struct xscale_common *xscale = target_to_xscale(target);
-	struct armv4_5_common_s *armv4_5 = &amp;xscale-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;xscale-&gt;armv4_5_common;
 
 	static const char *state[] =
 	{
@@ -911,7 +911,7 @@ static int xscale_poll(struct target *target)
 static int xscale_debug_entry(struct target *target)
 {
 	struct xscale_common *xscale = target_to_xscale(target);
-	struct armv4_5_common_s *armv4_5 = &amp;xscale-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;xscale-&gt;armv4_5_common;
 	uint32_t pc;
 	uint32_t buffer[10];
 	int i;
@@ -1179,7 +1179,7 @@ static int xscale_resume(struct target *target, int current,
 		uint32_t address, int handle_breakpoints, int debug_execution)
 {
 	struct xscale_common *xscale = target_to_xscale(target);
-	struct armv4_5_common_s *armv4_5 = &amp;xscale-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;xscale-&gt;armv4_5_common;
 	struct breakpoint *breakpoint = target-&gt;breakpoints;
 	uint32_t current_pc;
 	int retval;
@@ -1335,7 +1335,7 @@ static int xscale_step_inner(struct target *target, int current,
 		uint32_t address, int handle_breakpoints)
 {
 	struct xscale_common *xscale = target_to_xscale(target);
-	struct armv4_5_common_s *armv4_5 = &amp;xscale-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;xscale-&gt;armv4_5_common;
 	uint32_t next_pc;
 	int retval;
 	int i;
@@ -1416,7 +1416,7 @@ static int xscale_step_inner(struct target *target, int current,
 static int xscale_step(struct target *target, int current,
 		uint32_t address, int handle_breakpoints)
 {
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 	struct breakpoint *breakpoint = target-&gt;breakpoints;
 
 	uint32_t current_pc;
@@ -1661,7 +1661,7 @@ static int xscale_write_core_reg(struct target *target, struct reg *r,
 
 static int xscale_full_context(struct target *target)
 {
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 
 	uint32_t *buffer;
 
@@ -1737,7 +1737,7 @@ static int xscale_full_context(struct target *target)
 
 static int xscale_restore_context(struct target *target)
 {
-	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
+	struct arm *armv4_5 = target_to_armv4_5(target);
 
 	int i, j;
 
@@ -2470,7 +2470,7 @@ static int xscale_write_dcsr_sw(struct target *target, uint32_t value)
 static int xscale_read_trace(struct target *target)
 {
 	struct xscale_common *xscale = target_to_xscale(target);
-	struct armv4_5_common_s *armv4_5 = &amp;xscale-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;xscale-&gt;armv4_5_common;
 	struct xscale_trace_data **trace_data_p;
 
 	/* 258 words from debug handler
@@ -2821,7 +2821,7 @@ static const struct reg_arch_type xscale_reg_type = {
 static void xscale_build_reg_cache(struct target *target)
 {
 	struct xscale_common *xscale = target_to_xscale(target);
-	struct armv4_5_common_s *armv4_5 = &amp;xscale-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;xscale-&gt;armv4_5_common;
 	struct reg_cache **cache_p = register_get_last_cache_p(&amp;target-&gt;reg_cache);
 	struct xscale_reg *arch_info = malloc(sizeof(xscale_reg_arch_info));
 	int i;
@@ -3271,7 +3271,7 @@ COMMAND_HANDLER(xscale_handle_trace_buffer_command)
 {
 	struct target *target = get_current_target(CMD_CTX);
 	struct xscale_common *xscale = target_to_xscale(target);
-	struct armv4_5_common_s *armv4_5 = &amp;xscale-&gt;armv4_5_common;
+	struct arm *armv4_5 = &amp;xscale-&gt;armv4_5_common;
 	uint32_t dcsr_value;
 	int retval;
 

-----------------------------------------------------------------------

Summary of changes:
 TODO                       |    4 +-
 src/target/arm11.c         |   21 ++++++++---
 src/target/arm11.h         |   10 ------
 src/target/arm11_dbgtap.c  |   12 ++++---
 src/target/arm720t.c       |    4 +-
 src/target/arm7_9_common.c |   67 +++++++++++++++++++++-----------------
 src/target/arm7tdmi.c      |    4 +-
 src/target/arm920t.c       |   78 ++++++++++++++++++++++++++------------------
 src/target/arm926ejs.c     |    4 +-
 src/target/arm9tdmi.c      |    4 +-
 src/target/arm_simulator.c |    2 +-
 src/target/armv4_5.c       |   16 ++++----
 src/target/armv4_5.h       |    3 --
 src/target/armv7a.c        |    2 +-
 src/target/cortex_a8.c     |   40 +++++++++-------------
 src/target/register.h      |    4 +-
 src/target/xscale.c        |   20 ++++++------
 17 files changed, 153 insertions(+), 142 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001841.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-526-g5416c52
</A></li>
	<LI>Next message: <A HREF="001843.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-532-gbcebce3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1842">[ date ]</a>
              <a href="thread.html#1842">[ thread ]</a>
              <a href="subject.html#1842">[ subject ]</a>
              <a href="author.html#1842">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openocd-svn">More information about the openocd-svn
mailing list</a><br>
</body></html>
