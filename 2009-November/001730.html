<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-67-g36b4ac9
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openocd-svn/2009-November/index.html" >
   <LINK REL="made" HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.3.0-67-g36b4ac9&In-Reply-To=%3CE1N6EUt-0007WL-OJ%40cxgxhf1.ch3.sourceforge.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001729.html">
   <LINK REL="Next"  HREF="001731.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-67-g36b4ac9</H1>
    <B>Zach Welch</B> 
    <A HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.3.0-67-g36b4ac9&In-Reply-To=%3CE1N6EUt-0007WL-OJ%40cxgxhf1.ch3.sourceforge.com%3E"
       TITLE="[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-67-g36b4ac9">zwelch at users.sourceforge.net
       </A><BR>
    <I>Fri Nov  6 03:24:18 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001729.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-23-g0f3117c
</A></li>
        <LI>Next message: <A HREF="001731.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-74-gb7e4c26
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1730">[ date ]</a>
              <a href="thread.html#1730">[ thread ]</a>
              <a href="subject.html#1730">[ subject ]</a>
              <a href="author.html#1730">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Main OpenOCD repository&quot;.

The branch, master has been updated
       via  36b4ac90e45dda4df505981bd8d090971e478867 (commit)
       via  fa9e5d102708df2dcc0f070c847adf250ee1aa33 (commit)
       via  111b7a6a9dbd68c906b8a8dff6e6c34d780297db (commit)
       via  aa9351ba46d0959555a4b293627ea14b5b42344f (commit)
       via  786106d725aace7637e8b628a66aa0fbc03b2e19 (commit)
       via  fc116380bf26ac00b8d0a37fee91e74118e12d8d (commit)
       via  ee4723c494fb9cd8deefdbf5387f0ba31ea57c65 (commit)
       via  c63671e4f7eac5488e1ec0ef50f9d32e12cf3b31 (commit)
       via  7b2d8d93e6b132048f951106480b4e6a6f0b885a (commit)
       via  0004691e9104c9a59336fbe6e230597d48e8cb57 (commit)
       via  7f6ad49d12e3d166c730d27306d887bb3ed48a1b (commit)
       via  680e22c4d7d71d88128bd12e3ecc08b135da626a (commit)
       via  7b3d54a1278dc89f5ad43a5c00bfacbbddc8a9b6 (commit)
       via  266c423bbdea4e09c6b1f6cd216f872f8e3ef3f8 (commit)
       via  7b49739790cf8c7638ff11573c0e40626b936d3d (commit)
       via  75b601b1f31de52885448bc59ce5c5f5a5048d93 (commit)
       via  5e0ee6ab083f999e7007696762d8c55d647624dd (commit)
       via  93ab9ce8885cd45f5f9beba7d7e55536655eb5bf (commit)
       via  e9566a4a6af9b16762c66cf632abbeafbe8f874f (commit)
       via  11e545f56091e4fa808bd57a215d6b8066b39295 (commit)
       via  4189fdad28c283602b80ff7bc5a43bd5963019e7 (commit)
       via  d660721ba8821aa92248bddcbeefde1b3e629744 (commit)
       via  04b8a2a6f3e85fc701ce19c8c5999ab8a75964cd (commit)
       via  a8886cdfee58aff32a6c3e3cdf818e584d1075d7 (commit)
       via  9b3781e5a4c0145f0be4e7c262975e3b9909d1c4 (commit)
       via  af84cd33a2e0b8af31d4c7dbd64cfd0348d65a0e (commit)
       via  4d67b0974f23c1d24050eeec8c8533a2396fa6d4 (commit)
       via  b699aef4c009e705660ee5a0bdfd3a2064fa0a20 (commit)
       via  f8f1ac886519d8ea4e21572f86a42a223ce72457 (commit)
       via  714d92a954ad348571713c4ccc2611d7b910bcc7 (commit)
       via  0442bda216ef89a212f1dc58591db6edfd6b9f08 (commit)
       via  11a0afc932853fc9cb8d33a5fdce954195f406e2 (commit)
       via  3541ed3aa3beb93c80bb2a01be429dacdec33919 (commit)
       via  3dd5c59d7d4d4dc13ebd3fc870bd4bc695c9fda8 (commit)
       via  b62ee5a3c56cfbb000a40c05083dd31720c7cb1e (commit)
       via  ab33bdd46c3bb3acdb3f1b1f09a0e1a9393ef798 (commit)
       via  6e542407e7927ec589824b56ba706ed02d0ba97f (commit)
       via  2b78a4e82b1845ee7cc89f6e31d7b49e9299cb32 (commit)
       via  ae5732b9e4f085b89da3f9ce07eb526e159e1937 (commit)
       via  653ea7b25c4bec65fbe60101eb55d2564ba982af (commit)
       via  b7b561aae809ab9022b9f213dc5a12b6d58ce2ee (commit)
       via  f6f1dbfafdfac93d8f9a9540c71f011fac7611e0 (commit)
       via  36a3646c2205474345482188c8c05e50d1f67e44 (commit)
       via  68785af4da7727238c86dcf8858e0b5975bc988e (commit)
      from  0f3117c19d3b0bf8d693b25c2e97ff874d8acc99 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 36b4ac90e45dda4df505981bd8d090971e478867
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Fri Oct 23 01:18:25 2009 -0700

    Improve str9xpec command argument parsing.

diff --git a/src/flash/str9xpec.c b/src/flash/str9xpec.c
index 33471e6..711ee7a 100644
--- a/src/flash/str9xpec.c
+++ b/src/flash/str9xpec.c
@@ -795,7 +795,6 @@ static int str9xpec_probe(struct flash_bank_s *bank)
 
 static int str9xpec_handle_part_id_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	scan_field_t field;
 	uint8_t *buffer = NULL;
 	jtag_tap_t *tap;
@@ -803,16 +802,12 @@ static int str9xpec_handle_part_id_command(struct command_context_s *cmd_ctx, ch
 	str9xpec_flash_controller_t *str9xpec_info = NULL;
 
 	if (argc &lt; 1)
-	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
-	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	str9xpec_info = bank-&gt;driver_priv;
 	tap = str9xpec_info-&gt;tap;
@@ -851,7 +846,6 @@ static int str9xpec_info(struct flash_bank_s *bank, char *buf, int buf_size)
 
 static int str9xpec_handle_flash_options_read_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	uint8_t status;
 	str9xpec_flash_controller_t *str9xpec_info = NULL;
 
@@ -861,12 +855,10 @@ static int str9xpec_handle_flash_options_read_command(struct command_context_s *
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	str9xpec_info = bank-&gt;driver_priv;
 
@@ -971,7 +963,6 @@ static int str9xpec_write_options(struct flash_bank_s *bank)
 
 static int str9xpec_handle_flash_options_write_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	uint8_t status;
 
 	if (argc &lt; 1)
@@ -980,12 +971,10 @@ static int str9xpec_handle_flash_options_write_command(struct command_context_s
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	status = str9xpec_write_options(bank);
 
@@ -997,7 +986,6 @@ static int str9xpec_handle_flash_options_write_command(struct command_context_s
 
 static int str9xpec_handle_flash_options_cmap_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	str9xpec_flash_controller_t *str9xpec_info = NULL;
 
 	if (argc &lt; 2)
@@ -1006,12 +994,10 @@ static int str9xpec_handle_flash_options_cmap_command(struct command_context_s *
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	str9xpec_info = bank-&gt;driver_priv;
 
@@ -1029,7 +1015,6 @@ static int str9xpec_handle_flash_options_cmap_command(struct command_context_s *
 
 static int str9xpec_handle_flash_options_lvdthd_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	str9xpec_flash_controller_t *str9xpec_info = NULL;
 
 	if (argc &lt; 2)
@@ -1038,12 +1023,10 @@ static int str9xpec_handle_flash_options_lvdthd_command(struct command_context_s
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	str9xpec_info = bank-&gt;driver_priv;
 
@@ -1061,7 +1044,6 @@ static int str9xpec_handle_flash_options_lvdthd_command(struct command_context_s
 
 int str9xpec_handle_flash_options_lvdsel_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	str9xpec_flash_controller_t *str9xpec_info = NULL;
 
 	if (argc &lt; 2)
@@ -1070,12 +1052,10 @@ int str9xpec_handle_flash_options_lvdsel_command(struct command_context_s *cmd_c
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	str9xpec_info = bank-&gt;driver_priv;
 
@@ -1093,7 +1073,6 @@ int str9xpec_handle_flash_options_lvdsel_command(struct command_context_s *cmd_c
 
 static int str9xpec_handle_flash_options_lvdwarn_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	str9xpec_flash_controller_t *str9xpec_info = NULL;
 
 	if (argc &lt; 2)
@@ -1102,12 +1081,10 @@ static int str9xpec_handle_flash_options_lvdwarn_command(struct command_context_
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	str9xpec_info = bank-&gt;driver_priv;
 
@@ -1126,7 +1103,6 @@ static int str9xpec_handle_flash_options_lvdwarn_command(struct command_context_
 static int str9xpec_handle_flash_lock_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
 	uint8_t status;
-	flash_bank_t *bank;
 
 	if (argc &lt; 1)
 	{
@@ -1134,12 +1110,10 @@ static int str9xpec_handle_flash_lock_command(struct command_context_s *cmd_ctx,
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	status = str9xpec_lock_device(bank);
 
@@ -1152,7 +1126,6 @@ static int str9xpec_handle_flash_lock_command(struct command_context_s *cmd_ctx,
 static int str9xpec_handle_flash_unlock_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
 	uint8_t status;
-	flash_bank_t *bank;
 
 	if (argc &lt; 1)
 	{
@@ -1160,12 +1133,10 @@ static int str9xpec_handle_flash_unlock_command(struct command_context_s *cmd_ct
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	status = str9xpec_unlock_device(bank);
 
@@ -1177,8 +1148,6 @@ static int str9xpec_handle_flash_unlock_command(struct command_context_s *cmd_ct
 
 static int str9xpec_handle_flash_enable_turbo_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	int retval;
-	flash_bank_t *bank;
 	jtag_tap_t *tap0;
 	jtag_tap_t *tap1;
 	jtag_tap_t *tap2;
@@ -1190,12 +1159,10 @@ static int str9xpec_handle_flash_enable_turbo_command(struct command_context_s *
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	str9xpec_info = bank-&gt;driver_priv;
 
@@ -1230,7 +1197,6 @@ static int str9xpec_handle_flash_enable_turbo_command(struct command_context_s *
 
 static int str9xpec_handle_flash_disable_turbo_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	jtag_tap_t *tap;
 	str9xpec_flash_controller_t *str9xpec_info = NULL;
 
@@ -1240,12 +1206,10 @@ static int str9xpec_handle_flash_disable_turbo_command(struct command_context_s
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	str9xpec_info = bank-&gt;driver_priv;
 	tap = str9xpec_info-&gt;tap;

commit fa9e5d102708df2dcc0f070c847adf250ee1aa33
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Fri Oct 23 01:25:22 2009 -0700

    Improve str9x config command argument parsing.

diff --git a/src/flash/str9x.c b/src/flash/str9x.c
index 9d7b672..fe6c086 100644
--- a/src/flash/str9x.c
+++ b/src/flash/str9x.c
@@ -673,7 +673,6 @@ static int str9x_handle_flash_config_command(struct command_context_s *cmd_ctx,
 		char *cmd, char **args, int argc)
 {
 	str9x_flash_bank_t *str9x_info;
-	flash_bank_t *bank;
 	target_t *target = NULL;
 
 	if (argc &lt; 5)
@@ -681,12 +680,16 @@ static int str9x_handle_flash_config_command(struct command_context_s *cmd_ctx,
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
+
+	uint32_t bbsr, nbbsr, bbadr, nbbadr;
+	COMMAND_PARSE_NUMBER(u32, args[1], bbsr);
+	COMMAND_PARSE_NUMBER(u32, args[2], nbbsr);
+	COMMAND_PARSE_NUMBER(u32, args[3], bbadr);
+	COMMAND_PARSE_NUMBER(u32, args[4], nbbadr);
 
 	str9x_info = bank-&gt;driver_priv;
 
@@ -699,10 +702,10 @@ static int str9x_handle_flash_config_command(struct command_context_s *cmd_ctx,
 	}
 
 	/* config flash controller */
-	target_write_u32(target, FLASH_BBSR, strtoul(args[1], NULL, 0));
-	target_write_u32(target, FLASH_NBBSR, strtoul(args[2], NULL, 0));
-	target_write_u32(target, FLASH_BBADR, (strtoul(args[3], NULL, 0) &gt;&gt; 2));
-	target_write_u32(target, FLASH_NBBADR, (strtoul(args[4], NULL, 0) &gt;&gt; 2));
+	target_write_u32(target, FLASH_BBSR, bbsr);
+	target_write_u32(target, FLASH_NBBSR, nbbsr);
+	target_write_u32(target, FLASH_BBADR, bbadr &gt;&gt; 2);
+	target_write_u32(target, FLASH_NBBADR, nbbadr &gt;&gt; 2);
 
 	/* set bit 18 instruction TCM order as per flash programming manual */
 	arm966e_write_cp15(target, 62, 0x40000);

commit 111b7a6a9dbd68c906b8a8dff6e6c34d780297db
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Fri Oct 23 01:32:20 2009 -0700

    Improve str7x config command argument parsing.

diff --git a/src/flash/str7x.c b/src/flash/str7x.c
index 4d35748..650c0bc 100644
--- a/src/flash/str7x.c
+++ b/src/flash/str7x.c
@@ -640,12 +640,10 @@ static int str7x_info(struct flash_bank_s *bank, char *buf, int buf_size)
 
 static int str7x_handle_disable_jtag_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	target_t *target = NULL;
 	str7x_flash_bank_t *str7x_info = NULL;
 
 	uint32_t flash_cmd;
-	uint32_t retval;
 	uint16_t ProtectionLevel = 0;
 	uint16_t ProtectionRegs;
 
@@ -655,12 +653,10 @@ static int str7x_handle_disable_jtag_command(struct command_context_s *cmd_ctx,
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;str7x disable_jtag &lt;bank&gt; ok&quot;);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	str7x_info = bank-&gt;driver_priv;
 
@@ -673,15 +669,16 @@ static int str7x_handle_disable_jtag_command(struct command_context_s *cmd_ctx,
 	}
 
 	/* first we get protection status */
-	target_read_u32(target, str7x_get_flash_adr(bank, FLASH_NVAPR0), &amp;retval);
+	uint32_t reg;
+	target_read_u32(target, str7x_get_flash_adr(bank, FLASH_NVAPR0), &amp;reg);
 
-	if (!(retval &amp; str7x_info-&gt;disable_bit))
+	if (!(reg &amp; str7x_info-&gt;disable_bit))
 	{
 		ProtectionLevel = 1;
 	}
 
-	target_read_u32(target, str7x_get_flash_adr(bank, FLASH_NVAPR1), &amp;retval);
-	ProtectionRegs = ~(retval &gt;&gt; 16);
+	target_read_u32(target, str7x_get_flash_adr(bank, FLASH_NVAPR1), &amp;reg);
+	ProtectionRegs = ~(reg &gt;&gt; 16);
 
 	while (((ProtectionRegs) != 0) &amp;&amp; (ProtectionLevel &lt; 16))
 	{

commit aa9351ba46d0959555a4b293627ea14b5b42344f
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 22:33:12 2009 -0700

    Improve stm32x.c command argument parsing.

diff --git a/src/flash/stm32x.c b/src/flash/stm32x.c
index 22bd4f9..158f264 100644
--- a/src/flash/stm32x.c
+++ b/src/flash/stm32x.c
@@ -942,7 +942,6 @@ static int stm32x_info(struct flash_bank_s *bank, char *buf, int buf_size)
 
 static int stm32x_handle_lock_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	target_t *target = NULL;
 	stm32x_flash_bank_t *stm32x_info = NULL;
 
@@ -952,12 +951,10 @@ static int stm32x_handle_lock_command(struct command_context_s *cmd_ctx, char *c
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	stm32x_info = bank-&gt;driver_priv;
 
@@ -991,7 +988,6 @@ static int stm32x_handle_lock_command(struct command_context_s *cmd_ctx, char *c
 
 static int stm32x_handle_unlock_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	target_t *target = NULL;
 	stm32x_flash_bank_t *stm32x_info = NULL;
 
@@ -1001,12 +997,10 @@ static int stm32x_handle_unlock_command(struct command_context_s *cmd_ctx, char
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	stm32x_info = bank-&gt;driver_priv;
 
@@ -1037,7 +1031,6 @@ static int stm32x_handle_unlock_command(struct command_context_s *cmd_ctx, char
 
 static int stm32x_handle_options_read_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	uint32_t optionbyte;
 	target_t *target = NULL;
 	stm32x_flash_bank_t *stm32x_info = NULL;
@@ -1048,12 +1041,10 @@ static int stm32x_handle_options_read_command(struct command_context_s *cmd_ctx,
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	stm32x_info = bank-&gt;driver_priv;
 
@@ -1096,7 +1087,6 @@ static int stm32x_handle_options_read_command(struct command_context_s *cmd_ctx,
 
 static int stm32x_handle_options_write_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	target_t *target = NULL;
 	stm32x_flash_bank_t *stm32x_info = NULL;
 	uint16_t optionbyte = 0xF8;
@@ -1107,12 +1097,10 @@ static int stm32x_handle_options_write_command(struct command_context_s *cmd_ctx
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	stm32x_info = bank-&gt;driver_priv;
 
@@ -1210,7 +1198,6 @@ static int stm32x_mass_erase(struct flash_bank_s *bank)
 
 static int stm32x_handle_mass_erase_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	int i;
 
 	if (argc &lt; 1)
@@ -1219,12 +1206,10 @@ static int stm32x_handle_mass_erase_command(struct command_context_s *cmd_ctx, c
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	if (stm32x_mass_erase(bank) == ERROR_OK)
 	{

commit 786106d725aace7637e8b628a66aa0fbc03b2e19
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Fri Oct 23 01:40:47 2009 -0700

    Improve stellaris.c erase argument parsing.

diff --git a/src/flash/stellaris.c b/src/flash/stellaris.c
index dfc276e..b482ce2 100644
--- a/src/flash/stellaris.c
+++ b/src/flash/stellaris.c
@@ -1162,7 +1162,6 @@ static int stellaris_mass_erase(struct flash_bank_s *bank)
 
 static int stellaris_handle_mass_erase_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	int i;
 
 	if (argc &lt; 1)
@@ -1171,12 +1170,10 @@ static int stellaris_handle_mass_erase_command(struct command_context_s *cmd_ctx
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	if (stellaris_mass_erase(bank) == ERROR_OK)
 	{

commit fc116380bf26ac00b8d0a37fee91e74118e12d8d
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 22:33:12 2009 -0700

    Improve pic32mx.c command argument parsing.

diff --git a/src/flash/pic32mx.c b/src/flash/pic32mx.c
index 48ba38c..d9966bf 100644
--- a/src/flash/pic32mx.c
+++ b/src/flash/pic32mx.c
@@ -724,7 +724,6 @@ static int pic32mx_info(struct flash_bank_s *bank, char *buf, int buf_size)
 #if 0
 int pic32mx_handle_lock_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	target_t *target = NULL;
 	pic32mx_flash_bank_t *pic32mx_info = NULL;
 
@@ -734,12 +733,10 @@ int pic32mx_handle_lock_command(struct command_context_s *cmd_ctx, char *cmd, ch
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	pic32mx_info = bank-&gt;driver_priv;
 
@@ -773,7 +770,6 @@ int pic32mx_handle_lock_command(struct command_context_s *cmd_ctx, char *cmd, ch
 
 int pic32mx_handle_unlock_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	target_t *target = NULL;
 	pic32mx_flash_bank_t *pic32mx_info = NULL;
 
@@ -783,12 +779,10 @@ int pic32mx_handle_unlock_command(struct command_context_s *cmd_ctx, char *cmd,
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	pic32mx_info = bank-&gt;driver_priv;
 
@@ -867,7 +861,6 @@ static int pic32mx_chip_erase(struct flash_bank_s *bank)
 static int pic32mx_handle_chip_erase_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
 #if 0
-	flash_bank_t *bank;
 	int i;
 
 	if (argc != 0)
@@ -876,12 +869,10 @@ static int pic32mx_handle_chip_erase_command(struct command_context_s *cmd_ctx,
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	if (pic32mx_chip_erase(bank) == ERROR_OK)
 	{
@@ -904,7 +895,6 @@ static int pic32mx_handle_chip_erase_command(struct command_context_s *cmd_ctx,
 
 static int pic32mx_handle_pgm_word_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	uint32_t address, value;
 	int status, res;
 
@@ -914,15 +904,14 @@ static int pic32mx_handle_pgm_word_command(struct command_context_s *cmd_ctx, ch
 		return ERROR_OK;
 	}
 
-	address = strtoul(args[0], NULL, 0);
-	value   = strtoul(args[1], NULL, 0);
+	COMMAND_PARSE_NUMBER(u32, args[0], address);
+	COMMAND_PARSE_NUMBER(u32, args[1], value);
+
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[2], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
-	bank = get_flash_bank_by_num(strtoul(args[2], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[2]);
-		return ERROR_OK;
-	}
 	if (address &lt; bank-&gt;base || address &gt;= (bank-&gt;base + bank-&gt;size))
 	{
 		command_print(cmd_ctx, &quot;flash address '%s' is out of bounds&quot;, args[0]);

commit ee4723c494fb9cd8deefdbf5387f0ba31ea57c65
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Fri Oct 23 02:17:17 2009 -0700

    Improve mflash.c command argument parsing.

diff --git a/src/flash/mflash.c b/src/flash/mflash.c
index 63ba054..bf759c9 100644
--- a/src/flash/mflash.c
+++ b/src/flash/mflash.c
@@ -716,7 +716,7 @@ static int mg_write_cmd(struct command_context_s *cmd_ctx, char *cmd, char **arg
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	address = strtoul(args[2], NULL, 0);
+	COMMAND_PARSE_NUMBER(u32, args[2], address);
 
 	ret = fileio_open(&amp;fileio, args[1], FILEIO_READ, FILEIO_BINARY);
 	if (ret != ERROR_OK)
@@ -783,8 +783,8 @@ static int mg_dump_cmd(struct command_context_s *cmd_ctx, char *cmd, char **args
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	address = strtoul(args[2], NULL, 0);
-	size = strtoul(args[3], NULL, 0);
+	COMMAND_PARSE_NUMBER(u32, args[2], address);
+	COMMAND_PARSE_NUMBER(u32, args[3], size);
 
 	ret = fileio_open(&amp;fileio, args[1], FILEIO_WRITE, FILEIO_BINARY);
 	if (ret != ERROR_OK)
@@ -1238,7 +1238,9 @@ int mg_config_cmd(struct command_context_s *cmd_ctx, char *cmd,
 			break;
 		case 3:
 			if (!strcmp(args[1], &quot;pll&quot;)) {
-				fin = strtoul(args[2], NULL, 0);
+				unsigned long freq;
+				COMMAND_PARSE_NUMBER(ulong, args[2], freq);
+				fin = freq;
 
 				if (fin &gt; MG_PLL_CLK_OUT) {
 					LOG_ERROR(&quot;mflash: input freq. is too large&quot;);
@@ -1288,7 +1290,6 @@ int mflash_init_drivers(struct command_context_s *cmd_ctx)
 static int mg_bank_cmd(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
 	target_t *target;
-	char *str;
 	int i;
 
 	if (argc &lt; 4)
@@ -1303,7 +1304,9 @@ static int mg_bank_cmd(struct command_context_s *cmd_ctx, char *cmd, char **args
 	}
 
 	mflash_bank = calloc(sizeof(mflash_bank_t), 1);
-	mflash_bank-&gt;base = strtoul(args[1], NULL, 0);
+	COMMAND_PARSE_NUMBER(u32, args[1], mflash_bank-&gt;base);
+	/// @todo Verify how this parsing should work, then document it.
+	char *str;
 	mflash_bank-&gt;rst_pin.num = strtoul(args[2], &amp;str, 0);
 	if (*str)
 		mflash_bank-&gt;rst_pin.port[0] = (uint16_t)tolower(str[0]);

commit c63671e4f7eac5488e1ec0ef50f9d32e12cf3b31
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Fri Oct 23 02:17:17 2009 -0700

    Improve lpc3180_nand_controller.c parsing.
    
    This fixes a memory leak in lpc3180_nand_device_command by
    reordering the malloc to occur after all parsing has completed.

diff --git a/src/flash/lpc3180_nand_controller.c b/src/flash/lpc3180_nand_controller.c
index de6d4e2..ac079c6 100644
--- a/src/flash/lpc3180_nand_controller.c
+++ b/src/flash/lpc3180_nand_controller.c
@@ -60,25 +60,29 @@ nand_flash_controller_t lpc3180_nand_controller =
  */
 static int lpc3180_nand_device_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct nand_device_s *device)
 {
-	lpc3180_nand_controller_t *lpc3180_info;
-
 	if (argc &lt; 3)
 	{
 		LOG_WARNING(&quot;incomplete 'lpc3180' nand flash configuration&quot;);
 		return ERROR_FLASH_BANK_INVALID;
 	}
 
-	lpc3180_info = malloc(sizeof(lpc3180_nand_controller_t));
-	device-&gt;controller_priv = lpc3180_info;
-
-	lpc3180_info-&gt;target = get_target(args[1]);
-	if (!lpc3180_info-&gt;target)
+	target_t *target = get_target(args[1]);
+	if (NULL == target)
 	{
 		LOG_ERROR(&quot;target '%s' not defined&quot;, args[1]);
 		return ERROR_NAND_DEVICE_INVALID;
 	}
 
-	lpc3180_info-&gt;osc_freq = strtoul(args[2], NULL, 0);
+	uint32_t osc_freq;
+	COMMAND_PARSE_NUMBER(u32, args[2], osc_freq);
+
+	lpc3180_nand_controller_t *lpc3180_info;
+	lpc3180_info = malloc(sizeof(lpc3180_nand_controller_t));
+	device-&gt;controller_priv = lpc3180_info;
+
+	lpc3180_info-&gt;target = target;
+	lpc3180_info-&gt;osc_freq = osc_freq;
+
 	if ((lpc3180_info-&gt;osc_freq &lt; 1000) || (lpc3180_info-&gt;osc_freq &gt; 20000))
 	{
 		LOG_WARNING(&quot;LPC3180 oscillator frequency should be between 1000 and 20000 kHz, was %i&quot;, lpc3180_info-&gt;osc_freq);
@@ -864,7 +868,6 @@ static int lpc3180_nand_ready(struct nand_device_s *device, int timeout)
 
 static int handle_lpc3180_select_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	nand_device_t *device = NULL;
 	lpc3180_nand_controller_t *lpc3180_info = NULL;
 	char *selected[] =
 	{
@@ -876,7 +879,9 @@ static int handle_lpc3180_select_command(struct command_context_s *cmd_ctx, char
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	device = get_nand_device_by_num(strtoul(args[0], NULL, 0));
+	unsigned num;
+	COMMAND_PARSE_NUMBER(uint, args[1], num);
+	nand_device_t *device = get_nand_device_by_num(num);
 	if (!device)
 	{
 		command_print(cmd_ctx, &quot;nand device '#%s' is out of bounds&quot;, args[0]);

commit 7b2d8d93e6b132048f951106480b4e6a6f0b885a
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Fri Oct 23 02:17:17 2009 -0700

    Improve lpc2900.c command argument parsing.

diff --git a/src/flash/lpc2900.c b/src/flash/lpc2900.c
index 902180c..e15d93b 100644
--- a/src/flash/lpc2900.c
+++ b/src/flash/lpc2900.c
@@ -554,7 +554,6 @@ static uint32_t lpc2900_calc_tr( uint32_t clock, uint32_t time )
 static int lpc2900_handle_signature_command( struct command_context_s *cmd_ctx,
                                              char *cmd, char **args, int argc )
 {
-	flash_bank_t *bank;
 	uint32_t status;
 	uint32_t signature[4];
 
@@ -565,13 +564,10 @@ static int lpc2900_handle_signature_command( struct command_context_s *cmd_ctx,
 		return ERROR_FLASH_BANK_INVALID;
 	}
 
-	/* Get the bank descriptor */
-	bank = get_flash_bank_by_num( strtoul(args[0], NULL, 0) );
-	if( !bank )
-	{
-		command_print( cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0] );
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	if( bank-&gt;target-&gt;state != TARGET_HALTED )
 	{
@@ -614,21 +610,16 @@ static int lpc2900_handle_signature_command( struct command_context_s *cmd_ctx,
 static int lpc2900_handle_read_custom_command( struct command_context_s *cmd_ctx,
                                                char *cmd, char **args, int argc )
 {
-	flash_bank_t *bank;
-
-
 	if( argc &lt; 2 )
 	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	/* Get the bank descriptor */
-	bank = get_flash_bank_by_num( strtoul(args[0], NULL, 0) );
-	if( !bank )
-	{
-		command_print( cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0] );
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
+
 	lpc2900_flash_bank_t *lpc2900_info = bank-&gt;driver_priv;
 	lpc2900_info-&gt;risky = 0;
 
@@ -696,21 +687,16 @@ static int lpc2900_handle_read_custom_command( struct command_context_s *cmd_ctx
 static int lpc2900_handle_password_command(struct command_context_s *cmd_ctx,
                                            char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
-
-
 	if (argc &lt; 2)
 	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	/* Get the bank descriptor */
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
+
 	lpc2900_flash_bank_t *lpc2900_info = bank-&gt;driver_priv;
 
 #define ISS_PASSWORD &quot;I_know_what_I_am_doing&quot;
@@ -747,13 +733,11 @@ static int lpc2900_handle_write_custom_command( struct command_context_s *cmd_ct
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	/* Get the bank descriptor */
-	flash_bank_t *bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
+
 	lpc2900_flash_bank_t *lpc2900_info = bank-&gt;driver_priv;
 
 	/* Check if command execution is allowed. */
@@ -780,7 +764,7 @@ static int lpc2900_handle_write_custom_command( struct command_context_s *cmd_ct
 
 	char *filename = args[1];
 	char *type = (argc &gt;= 3) ? args[2] : NULL;
-	int retval = image_open(&amp;image, filename, type);
+	retval = image_open(&amp;image, filename, type);
 	if (retval != ERROR_OK)
 	{
 		return retval;
@@ -866,12 +850,11 @@ static int lpc2900_handle_secure_sector_command(struct command_context_s *cmd_ct
 	}
 
 	/* Get the bank descriptor */
-	flash_bank_t *bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
+
 	lpc2900_flash_bank_t *lpc2900_info = bank-&gt;driver_priv;
 
 	/* Check if command execution is allowed. */
@@ -884,8 +867,9 @@ static int lpc2900_handle_secure_sector_command(struct command_context_s *cmd_ct
 	lpc2900_info-&gt;risky = 0;
 
 	/* Read sector range, and do a sanity check. */
-	int first = strtoul(args[1], NULL, 0);
-	int last = strtoul(args[2], NULL, 0);
+	int first, last;
+	COMMAND_PARSE_NUMBER(int, args[1], first);
+	COMMAND_PARSE_NUMBER(int, args[2], last);
 	if( (first &gt;= bank-&gt;num_sectors) ||
 	    (last &gt;= bank-&gt;num_sectors) ||
 	    (first &gt; last) )
@@ -896,7 +880,6 @@ static int lpc2900_handle_secure_sector_command(struct command_context_s *cmd_ct
 
 	uint8_t page[FLASH_PAGE_SIZE];
 	int sector;
-	int retval;
 
 	/* Sectors in page 6 */
 	if( (first &lt;= 4) || (last &gt;= 8) )
@@ -972,12 +955,11 @@ static int lpc2900_handle_secure_jtag_command(struct command_context_s *cmd_ctx,
 	}
 
 	/* Get the bank descriptor */
-	flash_bank_t *bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
+
 	lpc2900_flash_bank_t *lpc2900_info = bank-&gt;driver_priv;
 
 	/* Check if command execution is allowed. */
@@ -1001,7 +983,6 @@ static int lpc2900_handle_secure_jtag_command(struct command_context_s *cmd_ctx,
 	page[0x30 +  3] = 0x7F;
 
 	/* Write to page 5 */
-	int retval;
 	if( (retval = lpc2900_write_index_page( bank, 5, &amp;page ))
 			!= ERROR_OK )
 	{
@@ -1117,7 +1098,9 @@ static int lpc2900_flash_bank_command(struct command_context_s *cmd_ctx,
 	 * Reject it if we can't meet the requirements for program time
 	 * (if clock too slow), or for erase time (clock too fast).
 	 */
-	lpc2900_info-&gt;clk_sys_fmc = strtoul(args[6], NULL, 0) * 1000;
+	uint32_t clk_sys_fmc;
+	COMMAND_PARSE_NUMBER(u32, args[6], clk_sys_fmc);
+	lpc2900_info-&gt;clk_sys_fmc = clk_sys_fmc * 1000;
 
 	uint32_t clock_limit;
 	/* Check program time limit */

commit 0004691e9104c9a59336fbe6e230597d48e8cb57
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Fri Oct 23 02:17:17 2009 -0700

    Improve lpc288x.c command argument parsing.

diff --git a/src/flash/lpc288x.c b/src/flash/lpc288x.c
index 513e2fc..61aa3a0 100644
--- a/src/flash/lpc288x.c
+++ b/src/flash/lpc288x.c
@@ -209,7 +209,7 @@ static int lpc288x_flash_bank_command(struct command_context_s *cmd_ctx, char *c
 
 	/* part wasn't probed for info yet */
 	lpc288x_info-&gt;cidr = 0;
-	lpc288x_info-&gt;cclk = strtoul(args[6], NULL, 0);
+	COMMAND_PARSE_NUMBER(u32, args[6], lpc288x_info-&gt;cclk);
 
 	return ERROR_OK;
 }

commit 7f6ad49d12e3d166c730d27306d887bb3ed48a1b
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Fri Oct 23 02:17:17 2009 -0700

    Improve lpc2000.c command argument parsing.

diff --git a/src/flash/lpc2000.c b/src/flash/lpc2000.c
index 5dcf1bb..ed9c7c3 100644
--- a/src/flash/lpc2000.c
+++ b/src/flash/lpc2000.c
@@ -501,7 +501,7 @@ static int lpc2000_flash_bank_command(struct command_context_s *cmd_ctx, char *c
 	}
 
 	lpc2000_info-&gt;iap_working_area = NULL;
-	lpc2000_info-&gt;cclk = strtoul(args[7], NULL, 0);
+	COMMAND_PARSE_NUMBER(u32, args[7], lpc2000_info-&gt;cclk);
 	lpc2000_info-&gt;calc_checksum = 0;
 	lpc2000_build_sector_list(bank);
 
@@ -776,7 +776,6 @@ static int lpc2000_info(struct flash_bank_s *bank, char *buf, int buf_size)
 
 static int lpc2000_handle_part_id_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	uint32_t param_table[5];
 	uint32_t result_table[4];
 	int status_code;
@@ -786,12 +785,10 @@ static int lpc2000_handle_part_id_command(struct command_context_s *cmd_ctx, cha
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	if (bank-&gt;target-&gt;state != TARGET_HALTED)
 	{

commit 680e22c4d7d71d88128bd12e3ecc08b135da626a
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Fri Oct 23 02:17:17 2009 -0700

    Improve cfi.c command argument parsing.

diff --git a/src/flash/cfi.c b/src/flash/cfi.c
index 2d75ff4..93e661c 100644
--- a/src/flash/cfi.c
+++ b/src/flash/cfi.c
@@ -641,8 +641,12 @@ static int cfi_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd,
 		return ERROR_FLASH_BANK_INVALID;
 	}
 
-	if ((strtoul(args[4], NULL, 0) &gt; CFI_MAX_CHIP_WIDTH)
-		|| (strtoul(args[3], NULL, 0) &gt; CFI_MAX_BUS_WIDTH))
+	uint16_t chip_width, bus_width;
+	COMMAND_PARSE_NUMBER(u16, args[3], bus_width);
+	COMMAND_PARSE_NUMBER(u16, args[4], chip_width);
+
+	if ((chip_width &gt; CFI_MAX_CHIP_WIDTH)
+			|| (bus_width &gt; CFI_MAX_BUS_WIDTH))
 	{
 		LOG_ERROR(&quot;chip and bus width have to specified in bytes&quot;);
 		return ERROR_FLASH_BANK_INVALID;

commit 7b3d54a1278dc89f5ad43a5c00bfacbbddc8a9b6
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Fri Oct 23 02:17:17 2009 -0700

    Improve avrf.c command argument parsing.

diff --git a/src/flash/avrf.c b/src/flash/avrf.c
index 533822e..2b95b8a 100644
--- a/src/flash/avrf.c
+++ b/src/flash/avrf.c
@@ -456,7 +456,6 @@ static int avrf_mass_erase(struct flash_bank_s *bank)
 
 static int avrf_handle_mass_erase_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *bank;
 	int i;
 
 	if (argc &lt; 1)
@@ -465,12 +464,10 @@ static int avrf_handle_mass_erase_command(struct command_context_s *cmd_ctx, cha
 		return ERROR_OK;
 	}
 
-	bank = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!bank)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *bank;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;bank);
+	if (ERROR_OK != retval)
+		return retval;
 
 	if (avrf_mass_erase(bank) == ERROR_OK)
 	{

commit 266c423bbdea4e09c6b1f6cd216f872f8e3ef3f8
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 22:33:12 2009 -0700

    Improve orion_nand.c command argument parsing.

diff --git a/src/flash/orion_nand.c b/src/flash/orion_nand.c
index 94df17b..6e88f82 100644
--- a/src/flash/orion_nand.c
+++ b/src/flash/orion_nand.c
@@ -152,7 +152,7 @@ int orion_nand_device_command(struct command_context_s *cmd_ctx, char *cmd,
 		return ERROR_NAND_DEVICE_INVALID;
 	}
 
-	base = strtoul(args[2], NULL, 0);
+	COMMAND_PARSE_NUMBER(u32, args[2], base);
 	cle = 0;
 	ale = 1;
 

commit 7b49739790cf8c7638ff11573c0e40626b936d3d
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 22:33:12 2009 -0700

    Improve davinci_nand.c command argument parsing.

diff --git a/src/flash/davinci_nand.c b/src/flash/davinci_nand.c
index 41c2b20..b6210b8 100644
--- a/src/flash/davinci_nand.c
+++ b/src/flash/davinci_nand.c
@@ -638,7 +638,6 @@ static int davinci_nand_device_command(struct command_context_s *cmd_ctx,
 	unsigned long chip, aemif;
 	enum ecc eccmode;
 	int chipsel;
-	char *ep;
 
 	/* arguments:
 	 *  - &quot;davinci&quot;
@@ -661,8 +660,8 @@ static int davinci_nand_device_command(struct command_context_s *cmd_ctx,
 		goto fail;
 	}
 
-	chip = strtoul(argv[2], &amp;ep, 0);
-	if (*ep || chip == 0 || chip == ULONG_MAX) {
+	COMMAND_PARSE_NUMBER(ulong, argv[2], chip);
+	if (chip == 0) {
 		LOG_ERROR(&quot;Invalid NAND chip address %s&quot;, argv[2]);
 		goto fail;
 	}
@@ -678,8 +677,8 @@ static int davinci_nand_device_command(struct command_context_s *cmd_ctx,
 		goto fail;
 	}
 
-	aemif = strtoul(argv[4], &amp;ep, 0);
-	if (*ep || aemif == 0 || aemif == ULONG_MAX) {
+	COMMAND_PARSE_NUMBER(ulong, argv[4], aemif);
+	if (aemif == 0) {
 		LOG_ERROR(&quot;Invalid AEMIF controller address %s&quot;, argv[4]);
 		goto fail;
 	}

commit 75b601b1f31de52885448bc59ce5c5f5a5048d93
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 22:33:12 2009 -0700

    Improve at91sam7.c command argument parsing.

diff --git a/src/flash/at91sam7.c b/src/flash/at91sam7.c
index 315a3f3..7d93c9e 100644
--- a/src/flash/at91sam7.c
+++ b/src/flash/at91sam7.c
@@ -752,7 +752,7 @@ static int at91sam7_flash_bank_command(struct command_context_s *cmd_ctx, char *
 
 	uint32_t base_address;
 	uint32_t bank_size;
-	uint32_t ext_freq;
+	uint32_t ext_freq = 0;
 
 	int chip_width;
 	int bus_width;
@@ -776,33 +776,37 @@ static int at91sam7_flash_bank_command(struct command_context_s *cmd_ctx, char *
 	at91sam7_info-&gt;ext_freq = 0;
 	at91sam7_info-&gt;flash_autodetection = 0;
 
-	if (argc == 14)
+	if (argc &lt; 13)
 	{
-		ext_freq = atol(args[13]) * 1000;
+		at91sam7_info-&gt;flash_autodetection = 1;
+		return ERROR_OK;
+	}
+
+	COMMAND_PARSE_NUMBER(u32, args[1], base_address);
+
+	COMMAND_PARSE_NUMBER(int, args[3], chip_width);
+	COMMAND_PARSE_NUMBER(int, args[4], bus_width);
+
+	COMMAND_PARSE_NUMBER(int, args[8], banks_num);
+	COMMAND_PARSE_NUMBER(int, args[9], num_sectors);
+	COMMAND_PARSE_NUMBER(u16, args[10], pages_per_sector);
+	COMMAND_PARSE_NUMBER(u16, args[11], page_size);
+	COMMAND_PARSE_NUMBER(u16, args[12], num_nvmbits);
+
+	if (argc == 14) {
+		unsigned long freq;
+		COMMAND_PARSE_NUMBER(ulong, args[13], freq);
+		ext_freq = freq * 1000;
 		at91sam7_info-&gt;ext_freq = ext_freq;
 	}
 
-	if ((argc != 14)                ||
-		(atoi(args[4]) == 0)        ||  /* bus width */
-		(atoi(args[8]) == 0)        ||  /* banks number */
-		(atoi(args[9]) == 0)        ||  /* sectors per bank */
-		(atoi(args[10]) == 0)       ||  /* pages per sector */
-		(atoi(args[11]) == 0)       ||  /* page size */
-		(atoi(args[12]) == 0))          /* nvmbits number */
+	if ((bus_width == 0) || (banks_num == 0) || (num_sectors == 0) ||
+		(pages_per_sector == 0) || (page_size == 0) || (num_nvmbits == 0))
 	{
 		at91sam7_info-&gt;flash_autodetection = 1;
 		return ERROR_OK;
 	}
 
-	base_address = strtoul(args[1], NULL, 0);
-	chip_width = atoi(args[3]);
-	bus_width = atoi(args[4]);
-	banks_num = atoi(args[8]);
-	num_sectors = atoi(args[9]);
-	pages_per_sector = atoi(args[10]);
-	page_size = atoi(args[11]);
-	num_nvmbits = atoi(args[12]);
-
 	target_name = calloc(strlen(args[7]) + 1, sizeof(char));
 	strcpy(target_name, args[7]);
 
@@ -1181,7 +1185,7 @@ static int at91sam7_handle_gpnvm_command(struct command_context_s *cmd_ctx, char
 		}
 	}
 
-	bit = atoi(args[0]);
+	COMMAND_PARSE_NUMBER(int, args[0], bit);
 	if ((bit &lt; 0) || (bit &gt;= at91sam7_info-&gt;num_nvmbits))
 	{
 		command_print(cmd_ctx, &quot;gpnvm bit '#%s' is out of bounds for target %s&quot;, args[0], at91sam7_info-&gt;target_name);

commit 5e0ee6ab083f999e7007696762d8c55d647624dd
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 22:33:12 2009 -0700

    Improve at91sam3.c command argument parsing.

diff --git a/src/flash/at91sam3.c b/src/flash/at91sam3.c
index 5edaa69..aff4d98 100644
--- a/src/flash/at91sam3.c
+++ b/src/flash/at91sam3.c
@@ -2347,7 +2347,6 @@ static int
 sam3_handle_gpnvm_command(struct command_context_s *cmd_ctx, char *cmd, char **argv, int argc)
 {
 	unsigned x,v;
-	uint32_t v32;
 	int r,who;
 	struct sam3_chip *pChip;
 
@@ -2391,11 +2390,8 @@ sam3_handle_gpnvm_command(struct command_context_s *cmd_ctx, char *cmd, char **a
 		if ((0 == strcmp(argv[0], &quot;show&quot;)) &amp;&amp; (0 == strcmp(argv[1], &quot;all&quot;))) {
 			who = -1;
 		} else {
-			r = parse_u32(argv[1], &amp;v32);
-			if (r != ERROR_OK) {
-				command_print(cmd_ctx, &quot;Not a number: %s&quot;, argv[1]);
-				return r;
-			}
+			uint32_t v32;
+			COMMAND_PARSE_NUMBER(u32, argv[1], v32);
 			who = v32;
 		}
 		break;
@@ -2444,9 +2440,6 @@ sam3_handle_gpnvm_command(struct command_context_s *cmd_ctx, char *cmd, char **a
 static int
 sam3_handle_slowclk_command(struct command_context_s *cmd_ctx, char *cmd, char **argv, int argc)
 {
-	uint32_t v;
-	int r;
-
 	struct sam3_chip *pChip;
 
 	pChip = get_current_sam3(cmd_ctx);
@@ -2460,8 +2453,10 @@ sam3_handle_slowclk_command(struct command_context_s *cmd_ctx, char *cmd, char *
 		// show
 		break;
 	case 1:
+	{
 		// set
-		r = parse_u32(argv[0], &amp;v);
+		uint32_t v;
+		COMMAND_PARSE_NUMBER(u32, argv[0], v);
 		if (v &gt; 200000) {
 			// absurd slow clock of 200Khz?
 			command_print(cmd_ctx,&quot;Absurd/illegal slow clock freq: %d\n&quot;, (int)(v));
@@ -2469,7 +2464,7 @@ sam3_handle_slowclk_command(struct command_context_s *cmd_ctx, char *cmd, char *
 		}
 		pChip-&gt;cfg.slow_freq = v;
 		break;
-
+	}
 	default:
 		// error
 		command_print(cmd_ctx,&quot;Too many parameters&quot;);

commit 93ab9ce8885cd45f5f9beba7d7e55536655eb5bf
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 22:33:12 2009 -0700

    Improve nand.c command argument parsing.

diff --git a/src/flash/nand.c b/src/flash/nand.c
index d97c817..7fb7c99 100644
--- a/src/flash/nand.c
+++ b/src/flash/nand.c
@@ -1107,12 +1107,16 @@ int handle_nand_list_command(struct command_context_s *cmd_ctx, char *cmd, char
 
 static int handle_nand_info_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	nand_device_t *p;
 	int i = 0;
 	int j = 0;
 	int first = -1;
 	int last = -1;
 
+	nand_device_t *p;
+	int retval = nand_command_get_device_by_num(cmd_ctx, args[0], &amp;p);
+	if (ERROR_OK != retval)
+		return retval;
+
 	switch (argc) {
 	default:
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -1121,15 +1125,16 @@ static int handle_nand_info_command(struct command_context_s *cmd_ctx, char *cmd
 		last = INT32_MAX;
 		break;
 	case 2:
-		first = last = strtoul(args[1], NULL, 0);
+		COMMAND_PARSE_NUMBER(int, args[1], i);
+		first = last = i;
+		i = 0;
 		break;
 	case 3:
-		first = strtoul(args[1], NULL, 0);
-		last = strtoul(args[2], NULL, 0);
+		COMMAND_PARSE_NUMBER(int, args[1], first);
+		COMMAND_PARSE_NUMBER(int, args[2], last);
 		break;
 	}
 
-	p = get_nand_device_by_num(strtoul(args[0], NULL, 0));
 	if (p)
 	{
 		if (p-&gt;device)
@@ -1181,15 +1186,16 @@ static int handle_nand_info_command(struct command_context_s *cmd_ctx, char *cmd
 
 static int handle_nand_probe_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	nand_device_t *p;
-	int retval;
-
 	if (argc != 1)
 	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	p = get_nand_device_by_num(strtoul(args[0], NULL, 0));
+	nand_device_t *p;
+	int retval = nand_command_get_device_by_num(cmd_ctx, args[0], &amp;p);
+	if (ERROR_OK != retval)
+		return retval;
+
 	if (p)
 	{
 		if ((retval = nand_probe(p)) == ERROR_OK)
@@ -1205,29 +1211,25 @@ static int handle_nand_probe_command(struct command_context_s *cmd_ctx, char *cm
 			command_print(cmd_ctx, &quot;unknown error when probing NAND flash device&quot;);
 		}
 	}
-	else
-	{
-		command_print(cmd_ctx, &quot;NAND flash device '#%s' is out of bounds&quot;, args[0]);
-	}
 
 	return ERROR_OK;
 }
 
 static int handle_nand_erase_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	nand_device_t *p;
-	int retval;
-
 	if (argc != 1 &amp;&amp; argc != 3)
 	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
 
 	}
 
-	p = get_nand_device_by_num(strtoul(args[0], NULL, 0));
+	nand_device_t *p;
+	int retval = nand_command_get_device_by_num(cmd_ctx, args[0], &amp;p);
+	if (ERROR_OK != retval)
+		return retval;
+
 	if (p)
 	{
-		char *cp;
 		unsigned long offset;
 		unsigned long length;
 
@@ -1235,16 +1237,12 @@ static int handle_nand_erase_command(struct command_context_s *cmd_ctx, char *cm
 		if (argc == 3) {
 			unsigned long size = p-&gt;erase_size * p-&gt;num_blocks;
 
-			offset = strtoul(args[1], &amp;cp, 0);
-			if (*cp || (offset == ULONG_MAX)
-					|| (offset % p-&gt;erase_size) != 0
-					|| offset &gt;= size)
+			COMMAND_PARSE_NUMBER(ulong, args[1], offset);
+			if ((offset % p-&gt;erase_size) != 0 || offset &gt;= size)
 				return ERROR_INVALID_ARGUMENTS;
 
-			length = strtoul(args[2], &amp;cp, 0);
-			if (*cp || (length == ULONG_MAX)
-					|| (length == 0)
-					|| (length % p-&gt;erase_size) != 0
+			COMMAND_PARSE_NUMBER(ulong, args[2], length);
+			if ((length == 0) || (length % p-&gt;erase_size) != 0
 					|| (length + offset) &gt; size)
 				return ERROR_INVALID_ARGUMENTS;
 
@@ -1272,18 +1270,12 @@ static int handle_nand_erase_command(struct command_context_s *cmd_ctx, char *cm
 			command_print(cmd_ctx, &quot;unknown error when erasing NAND flash device&quot;);
 		}
 	}
-	else
-	{
-		command_print(cmd_ctx, &quot;NAND flash device '#%s' is out of bounds&quot;, args[0]);
-	}
 
 	return ERROR_OK;
 }
 
 int handle_nand_check_bad_blocks_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	nand_device_t *p;
-	int retval;
 	int first = -1;
 	int last = -1;
 
@@ -1293,31 +1285,25 @@ int handle_nand_check_bad_blocks_command(struct command_context_s *cmd_ctx, char
 
 	}
 
-	p = get_nand_device_by_num(strtoul(args[0], NULL, 0));
-	if (!p) {
-		command_print(cmd_ctx, &quot;NAND flash device '#%s' is out of bounds&quot;,
-				args[0]);
-		return ERROR_INVALID_ARGUMENTS;
-	}
+	nand_device_t *p;
+	int retval = nand_command_get_device_by_num(cmd_ctx, args[0], &amp;p);
+	if (ERROR_OK != retval)
+		return retval;
 
 	if (argc == 3)
 	{
-		char *cp;
 		unsigned long offset;
 		unsigned long length;
 
-		offset = strtoul(args[1], &amp;cp, 0);
-		if (*cp || offset == ULONG_MAX || offset % p-&gt;erase_size)
-		{
+		COMMAND_PARSE_NUMBER(ulong, args[1], offset);
+		if (offset % p-&gt;erase_size)
 			return ERROR_INVALID_ARGUMENTS;
-		}
 		offset /= p-&gt;erase_size;
 
-		length = strtoul(args[2], &amp;cp, 0);
-		if (*cp || length == ULONG_MAX || length % p-&gt;erase_size)
-		{
+		COMMAND_PARSE_NUMBER(ulong, args[2], length);
+		if (length % p-&gt;erase_size)
 			return ERROR_INVALID_ARGUMENTS;
-		}
+
 		length -= 1;
 		length /= p-&gt;erase_size;
 
@@ -1357,15 +1343,16 @@ static int handle_nand_write_command(struct command_context_s *cmd_ctx, char *cm
 	duration_t duration;
 	char *duration_text;
 
-	nand_device_t *p;
-
 	if (argc &lt; 3)
 	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
-
 	}
 
-	p = get_nand_device_by_num(strtoul(args[0], NULL, 0));
+	nand_device_t *p;
+	int retval = nand_command_get_device_by_num(cmd_ctx, args[0], &amp;p);
+	if (ERROR_OK != retval)
+		return retval;
+
 	if (p)
 	{
 		uint8_t *page = NULL;
@@ -1374,7 +1361,7 @@ static int handle_nand_write_command(struct command_context_s *cmd_ctx, char *cm
 		uint32_t oob_size = 0;
 		const int *eccpos = NULL;
 
-		offset = strtoul(args[2], NULL, 0);
+		COMMAND_PARSE_NUMBER(u32, args[2], offset);
 
 		if (argc &gt; 3)
 		{
@@ -1509,24 +1496,22 @@ static int handle_nand_write_command(struct command_context_s *cmd_ctx, char *cm
 		free(duration_text);
 		duration_text = NULL;
 	}
-	else
-	{
-		command_print(cmd_ctx, &quot;NAND flash device '#%s' is out of bounds&quot;, args[0]);
-	}
 
 	return ERROR_OK;
 }
 
 static int handle_nand_dump_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	nand_device_t *p;
-
 	if (argc &lt; 4)
 	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	p = get_nand_device_by_num(strtoul(args[0], NULL, 0));
+	nand_device_t *p;
+	int retval = nand_command_get_device_by_num(cmd_ctx, args[0], &amp;p);
+	if (ERROR_OK != retval)
+		return retval;
+
 	if (p)
 	{
 		if (p-&gt;device)
@@ -1540,8 +1525,10 @@ static int handle_nand_dump_command(struct command_context_s *cmd_ctx, char *cmd
 			uint32_t page_size = 0;
 			uint8_t *oob = NULL;
 			uint32_t oob_size = 0;
-			uint32_t address = strtoul(args[2], NULL, 0);
-			uint32_t size = strtoul(args[3], NULL, 0);
+			uint32_t address;
+			COMMAND_PARSE_NUMBER(u32, args[2], address);
+			uint32_t size;
+			COMMAND_PARSE_NUMBER(u32, args[3], size);
 			uint32_t bytes_done = 0;
 			enum oob_formats oob_format = NAND_OOB_NONE;
 
@@ -1631,24 +1618,22 @@ static int handle_nand_dump_command(struct command_context_s *cmd_ctx, char *cmd
 			command_print(cmd_ctx, &quot;#%s: not probed&quot;, args[0]);
 		}
 	}
-	else
-	{
-		command_print(cmd_ctx, &quot;NAND flash device '#%s' is out of bounds&quot;, args[0]);
-	}
 
 	return ERROR_OK;
 }
 
 static int handle_nand_raw_access_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	nand_device_t *p;
-
 	if ((argc &lt; 1) || (argc &gt; 2))
 	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	p = get_nand_device_by_num(strtoul(args[0], NULL, 0));
+	nand_device_t *p;
+	int retval = nand_command_get_device_by_num(cmd_ctx, args[0], &amp;p);
+	if (ERROR_OK != retval)
+		return retval;
+
 	if (p)
 	{
 		if (p-&gt;device)
@@ -1676,10 +1661,6 @@ static int handle_nand_raw_access_command(struct command_context_s *cmd_ctx, cha
 			command_print(cmd_ctx, &quot;#%s: not probed&quot;, args[0]);
 		}
 	}
-	else
-	{
-		command_print(cmd_ctx, &quot;NAND flash device '#%s' is out of bounds&quot;, args[0]);
-	}
 
 	return ERROR_OK;
 }

commit e9566a4a6af9b16762c66cf632abbeafbe8f874f
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 22:33:12 2009 -0700

    Improve flash.c command argument parsing.

diff --git a/src/flash/flash.c b/src/flash/flash.c
index aa24659..b40e074 100644
--- a/src/flash/flash.c
+++ b/src/flash/flash.c
@@ -307,10 +307,10 @@ static int handle_flash_bank_command(struct command_context_s *cmd_ctx, char *cm
 			c-&gt;target = target;
 			c-&gt;driver = flash_drivers[i];
 			c-&gt;driver_priv = NULL;
-			c-&gt;base = strtoul(args[1], NULL, 0);
-			c-&gt;size = strtoul(args[2], NULL, 0);
-			c-&gt;chip_width = strtoul(args[3], NULL, 0);
-			c-&gt;bus_width = strtoul(args[4], NULL, 0);
+			COMMAND_PARSE_NUMBER(u32, args[1], c-&gt;base);
+			COMMAND_PARSE_NUMBER(u32, args[2], c-&gt;size);
+			COMMAND_PARSE_NUMBER(int, args[3], c-&gt;chip_width);
+			COMMAND_PARSE_NUMBER(int, args[4], c-&gt;bus_width);
 			c-&gt;num_sectors = 0;
 			c-&gt;sectors = NULL;
 			c-&gt;next = NULL;
@@ -360,13 +360,14 @@ static int handle_flash_info_command(struct command_context_s *cmd_ctx, char *cm
 	int retval;
 
 	if (argc != 1)
-	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
-	}
+
+	unsigned bank_nr;
+	COMMAND_PARSE_NUMBER(uint, args[0], bank_nr);
 
 	for (p = flash_banks; p; p = p-&gt;next, i++)
 	{
-		if (i == strtoul(args[0], NULL, 0))
+		if (i == bank_nr)
 		{
 			char buf[1024];
 
@@ -415,7 +416,6 @@ static int handle_flash_info_command(struct command_context_s *cmd_ctx, char *cm
 
 static int handle_flash_probe_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *p;
 	int retval;
 
 	if (argc != 1)
@@ -423,7 +423,9 @@ static int handle_flash_probe_command(struct command_context_s *cmd_ctx, char *c
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	p = get_flash_bank_by_num_noprobe(strtoul(args[0], NULL, 0));
+	unsigned bank_nr;
+	COMMAND_PARSE_NUMBER(uint, args[0], bank_nr);
+	flash_bank_t *p = get_flash_bank_by_num_noprobe(bank_nr);
 	if (p)
 	{
 		if ((retval = p-&gt;driver-&gt;probe(p)) == ERROR_OK)
@@ -451,15 +453,16 @@ static int handle_flash_probe_command(struct command_context_s *cmd_ctx, char *c
 
 static int handle_flash_erase_check_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *p;
-	int retval;
-
 	if (argc != 1)
 	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	p = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
+	flash_bank_t *p;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;p);
+	if (ERROR_OK != retval)
+		return retval;
+
 	if (p)
 	{
 		int j;
@@ -509,12 +512,10 @@ static int handle_flash_erase_address_command(struct command_context_s *cmd_ctx,
 	target_t *target = get_current_target(cmd_ctx);
 
 	if (argc != 2)
-	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
-	}
 
-	address = strtoul(args[0], NULL, 0);
-	length = strtoul(args[1], NULL, 0);
+	COMMAND_PARSE_NUMBER(int, args[0], address);
+	COMMAND_PARSE_NUMBER(int, args[1], length);
 	if (length &lt;= 0)
 	{
 		command_print(cmd_ctx, &quot;Length must be &gt;0&quot;);
@@ -547,17 +548,17 @@ static int handle_flash_erase_address_command(struct command_context_s *cmd_ctx,
 
 static int handle_flash_protect_check_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	flash_bank_t *p;
-	int retval;
-
 	if (argc != 1)
-	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
-	}
 
-	p = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
+	flash_bank_t *p;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;p);
+	if (ERROR_OK != retval)
+		return retval;
+
 	if (p)
 	{
+		int retval;
 		if ((retval = p-&gt;driver-&gt;protect_check(p)) == ERROR_OK)
 		{
 			command_print(cmd_ctx, &quot;successfully checked protect state&quot;);
@@ -571,10 +572,6 @@ static int handle_flash_protect_check_command(struct command_context_s *cmd_ctx,
 			command_print(cmd_ctx, &quot;unknown error when checking protection state of flash bank '#%s' at 0x%8.8&quot; PRIx32, args[0], p-&gt;base);
 		}
 	}
-	else
-	{
-		return ERROR_COMMAND_SYNTAX_ERROR;
-	}
 
 	return ERROR_OK;
 }
@@ -605,23 +602,19 @@ static int handle_flash_erase_command(struct command_context_s *cmd_ctx,
 		uint32_t bank_nr;
 		uint32_t first;
 		uint32_t last;
-		int retval;
-
-		if ((retval = parse_u32(args[0], &amp;bank_nr)) != ERROR_OK)
-			return retval;
 
+		COMMAND_PARSE_NUMBER(u32, args[0], bank_nr);
 		flash_bank_t *p = get_flash_bank_by_num(bank_nr);
 		if (!p)
 			return ERROR_OK;
 
-		if ((retval = parse_u32(args[1], &amp;first)) != ERROR_OK)
-			return retval;
+		COMMAND_PARSE_NUMBER(u32, args[1], first);
 		if (strcmp(args[2], &quot;last&quot;) == 0)
 			last = p-&gt;num_sectors - 1;
 		else
-			if ((retval = parse_u32(args[2], &amp;last)) != ERROR_OK)
-				return retval;
+			COMMAND_PARSE_NUMBER(u32, args[2], last);
 
+		int retval;
 		if ((retval = flash_check_sector_parameters(cmd_ctx,
 				first, last, p-&gt;num_sectors)) != ERROR_OK)
 			return retval;
@@ -655,23 +648,18 @@ static int handle_flash_protect_command(struct command_context_s *cmd_ctx,
 		uint32_t bank_nr;
 		uint32_t first;
 		uint32_t last;
-		int retval;
 		int set;
 
-		if ((retval = parse_u32(args[0], &amp;bank_nr)) != ERROR_OK)
-			return retval;
-
+		COMMAND_PARSE_NUMBER(u32, args[0], bank_nr);
 		flash_bank_t *p = get_flash_bank_by_num(bank_nr);
 		if (!p)
 			return ERROR_OK;
 
-		if ((retval = parse_u32(args[1], &amp;first)) != ERROR_OK)
-			return retval;
+		COMMAND_PARSE_NUMBER(u32, args[1], first);
 		if (strcmp(args[2], &quot;last&quot;) == 0)
 			last = p-&gt;num_sectors - 1;
 		else
-			if ((retval = parse_u32(args[2], &amp;last)) != ERROR_OK)
-				return retval;
+			COMMAND_PARSE_NUMBER(u32, args[2], last);
 
 		if (strcmp(args[3], &quot;on&quot;) == 0)
 			set = 1;
@@ -680,6 +668,7 @@ static int handle_flash_protect_command(struct command_context_s *cmd_ctx,
 		else
 			return ERROR_COMMAND_SYNTAX_ERROR;
 
+		int retval;
 		if ((retval = flash_check_sector_parameters(cmd_ctx,
 				first, last, p-&gt;num_sectors)) != ERROR_OK)
 			return retval;
@@ -755,7 +744,7 @@ static int handle_flash_write_image_command(struct command_context_s *cmd_ctx, c
 	if (argc &gt;= 2)
 	{
 		image.base_address_set = 1;
-		image.base_address = strtoul(args[1], NULL, 0);
+		COMMAND_PARSE_NUMBER(int, args[1], image.base_address);
 	}
 	else
 	{
@@ -818,13 +807,11 @@ static int handle_flash_fill_command(struct command_context_s *cmd_ctx, char *cm
 	uint32_t wordsize;
 
 	if (argc != 3)
-	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
-	}
 
-	address	= strtoul(args[0], NULL, 0);
-	pattern	= strtoul(args[1], NULL, 0);
-	count 	= strtoul(args[2], NULL, 0);
+	COMMAND_PARSE_NUMBER(u32, args[0], address);
+	COMMAND_PARSE_NUMBER(u32, args[1], pattern);
+	COMMAND_PARSE_NUMBER(u32, args[2], count);
 
 	if (count == 0)
 		return ERROR_OK;
@@ -928,23 +915,18 @@ static int handle_flash_write_bank_command(struct command_context_s *cmd_ctx, ch
 	duration_t duration;
 	char *duration_text;
 
-	int retval, retvaltemp;
-	flash_bank_t *p;
 
 	if (argc != 3)
-	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
-	}
 
 	duration_start_measure(&amp;duration);
 
-	offset = strtoul(args[2], NULL, 0);
-	p = get_flash_bank_by_num(strtoul(args[0], NULL, 0));
-	if (!p)
-	{
-		command_print(cmd_ctx, &quot;flash bank '#%s' is out of bounds&quot;, args[0]);
-		return ERROR_OK;
-	}
+	flash_bank_t *p;
+	int retval = flash_command_get_bank_by_num(cmd_ctx, args[0], &amp;p);
+	if (ERROR_OK != retval)
+		return retval;
+
+	COMMAND_PARSE_NUMBER(u32, args[2], offset);
 
 	if (fileio_open(&amp;fileio, args[1], FILEIO_READ, FILEIO_BINARY) != ERROR_OK)
 	{
@@ -964,6 +946,7 @@ static int handle_flash_write_bank_command(struct command_context_s *cmd_ctx, ch
 	free(buffer);
 	buffer = NULL;
 
+	int retvaltemp;
 	if ((retvaltemp = duration_stop_measure(&amp;duration, &amp;duration_text)) != ERROR_OK)
 	{
 		fileio_close(&amp;fileio);
@@ -971,14 +954,14 @@ static int handle_flash_write_bank_command(struct command_context_s *cmd_ctx, ch
 	}
 	if (retval == ERROR_OK)
 	{
-	command_print(cmd_ctx,
-				  &quot;wrote  %lld byte from file %s to flash bank %li at offset 0x%8.8&quot; PRIx32 &quot; in %s (%f kb/s)&quot;,
-				  fileio.size,
-				  args[1],
-				  strtoul(args[0], NULL, 0),
-				  offset,
-				  duration_text,
-				  (float)fileio.size / 1024.0 / ((float)duration.duration.tv_sec + ((float)duration.duration.tv_usec / 1000000.0)));
+		float elapsed = (float)duration.duration.tv_sec;
+		elapsed += (float)duration.duration.tv_usec / 1000000.0;
+		float speed = (float)fileio.size / elapsed;
+		command_print(cmd_ctx,
+				&quot;wrote  %lld byte from file %s to flash bank %u &quot;
+				&quot;at offset 0x%8.8&quot; PRIx32 &quot; in %s (%f kb/s)&quot;,
+				fileio.size, args[1], p-&gt;bank_number, offset,
+				duration_text, speed / 1024);
 	}
 	free(duration_text);
 

commit 11e545f56091e4fa808bd57a215d6b8066b39295
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Fri Oct 23 01:13:19 2009 -0700

    Add Flash/NAND bank command argument helpers.
    
    This eliminates redundant code for parsing and retreiving the bank
    specified from a script command argument.  This patch was written to
    replace existing functionality; however, the parsing logic can be
    updated later to allow flash commands to accept bank names as well as
    their numbers.

diff --git a/src/flash/flash.c b/src/flash/flash.c
index db04e6e..aa24659 100644
--- a/src/flash/flash.c
+++ b/src/flash/flash.c
@@ -255,6 +255,23 @@ flash_bank_t *get_flash_bank_by_num(int num)
 	return p;
 }
 
+int flash_command_get_bank_by_num(
+	struct command_context_s *cmd_ctx, char *str, flash_bank_t **bank)
+{
+	unsigned bank_num;
+	COMMAND_PARSE_NUMBER(uint, str, bank_num);
+
+	*bank = get_flash_bank_by_num(bank_num);
+	if (!*bank)
+	{
+		command_print(cmd_ctx,
+			&quot;flash bank '#%u' not found&quot;, bank_num);
+		return ERROR_INVALID_ARGUMENTS;
+	}
+	return ERROR_OK;
+}
+
+
 static int handle_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
 	int retval;
diff --git a/src/flash/flash.h b/src/flash/flash.h
index a7f08f6..05c4b2c 100644
--- a/src/flash/flash.h
+++ b/src/flash/flash.h
@@ -314,6 +314,16 @@ extern int default_flash_mem_blank_check(struct flash_bank_s *bank);
  */
 extern flash_bank_t *get_flash_bank_by_num(int num);
 /**
+ * Retreives @a bank from a command argument, reporting errors parsing
+ * the bank identifier or retreiving the specified bank.
+ * @param cmd_ctx The command context for reporting errors.
+ * @param str The string containing the bank identifier.
+ * @param bank On output, contians a pointer to the bank or NULL.
+ * @returns ERROR_OK on success, or an error indicating the problem.
+ */
+int flash_command_get_bank_by_num(
+	struct command_context_s *cmd_ctx, char *str, flash_bank_t **bank);
+/**
  * Returns the flash bank like get_flash_bank_by_num(), without probing.
  * @param num The flash bank number.
  * @returns A flash_bank_t for flash bank @a num, or NULL.
diff --git a/src/flash/nand.c b/src/flash/nand.c
index 6e45075..d97c817 100644
--- a/src/flash/nand.c
+++ b/src/flash/nand.c
@@ -340,6 +340,19 @@ nand_device_t *get_nand_device_by_num(int num)
 	return NULL;
 }
 
+int nand_command_get_device_by_num(struct command_context_s *cmd_ctx,
+		char *str, nand_device_t **device)
+{
+	unsigned num;
+	COMMAND_PARSE_NUMBER(uint, str, num);
+	*device = get_nand_device_by_num(num);
+	if (!*device) {
+		command_print(cmd_ctx, &quot;NAND flash device '#%s' is out of bounds&quot;, str);
+		return ERROR_INVALID_ARGUMENTS;
+	}
+	return ERROR_OK;
+}
+
 static int nand_build_bbt(struct nand_device_s *device, int first, int last)
 {
 	uint32_t page = 0x0;
diff --git a/src/flash/nand.h b/src/flash/nand.h
index b73e330..d867494 100644
--- a/src/flash/nand.h
+++ b/src/flash/nand.h
@@ -217,6 +217,11 @@ extern int nand_calculate_ecc_kw(struct nand_device_s *device, const uint8_t *da
 extern int nand_register_commands(struct command_context_s *cmd_ctx);
 extern int nand_init(struct command_context_s *cmd_ctx);
 
+/// helper for parsing a nand device command argument string
+int nand_command_get_device_by_num(struct command_context_s *cmd_ctx,
+		char *str, nand_device_t **device);
+
+
 #define		ERROR_NAND_DEVICE_INVALID		(-1100)
 #define		ERROR_NAND_OPERATION_FAILED		(-1101)
 #define		ERROR_NAND_OPERATION_TIMEOUT	(-1102)

commit 4189fdad28c283602b80ff7bc5a43bd5963019e7
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 08:11:55 2009 -0700

    Improve ETM tracemode update command.

diff --git a/src/target/etm.c b/src/target/etm.c
index 0f5a96f..8229bb0 100644
--- a/src/target/etm.c
+++ b/src/target/etm.c
@@ -1155,112 +1155,108 @@ static int etmv1_analyze_trace(etm_context_t *ctx, struct command_context_s *cmd
 	return ERROR_OK;
 }
 
-static int handle_etm_tracemode_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+static int handle_etm_tracemode_command_update(
+		struct command_context_s *cmd_ctx,
+		char **args, etmv1_tracemode_t *mode)
 {
-	target_t *target;
-	armv4_5_common_t *armv4_5;
-	arm7_9_common_t *arm7_9;
 	etmv1_tracemode_t tracemode;
 
-	target = get_current_target(cmd_ctx);
-
-	if (arm7_9_get_arch_pointers(target, &amp;armv4_5, &amp;arm7_9) != ERROR_OK)
+	/* what parts of data access are traced? */
+	if (strcmp(args[0], &quot;none&quot;) == 0)
+		tracemode = ETMV1_TRACE_NONE;
+	else if (strcmp(args[0], &quot;data&quot;) == 0)
+		tracemode = ETMV1_TRACE_DATA;
+	else if (strcmp(args[0], &quot;address&quot;) == 0)
+		tracemode = ETMV1_TRACE_ADDR;
+	else if (strcmp(args[0], &quot;all&quot;) == 0)
+		tracemode = ETMV1_TRACE_DATA | ETMV1_TRACE_ADDR;
+	else
 	{
-		command_print(cmd_ctx, &quot;current target isn't an ARM7/ARM9 target&quot;);
+		command_print(cmd_ctx, &quot;invalid option '%s'&quot;, args[0]);
 		return ERROR_OK;
 	}
 
-	if (!arm7_9-&gt;etm_ctx)
-	{
-		command_print(cmd_ctx, &quot;current target doesn't have an ETM configured&quot;);
+	uint8_t context_id;
+	COMMAND_PARSE_NUMBER(u8, args[1], context_id);
+	switch (context_id)
+	{
+	case 0:
+		tracemode |= ETMV1_CONTEXTID_NONE;
+		break;
+	case 8:
+		tracemode |= ETMV1_CONTEXTID_8;
+		break;
+	case 16:
+		tracemode |= ETMV1_CONTEXTID_16;
+		break;
+	case 32:
+		tracemode |= ETMV1_CONTEXTID_32;
+		break;
+	default:
+		command_print(cmd_ctx, &quot;invalid option '%s'&quot;, args[1]);
 		return ERROR_OK;
 	}
 
-	tracemode = arm7_9-&gt;etm_ctx-&gt;tracemode;
+	if (strcmp(args[2], &quot;enable&quot;) == 0)
+		tracemode |= ETMV1_CYCLE_ACCURATE;
+	else if (strcmp(args[2], &quot;disable&quot;) == 0)
+		tracemode |= 0;
+	else
+	{
+		command_print(cmd_ctx, &quot;invalid option '%s'&quot;, args[2]);
+		return ERROR_OK;
+	}
 
-	if (argc == 4)
+	if (strcmp(args[3], &quot;enable&quot;) == 0)
+		tracemode |= ETMV1_BRANCH_OUTPUT;
+	else if (strcmp(args[3], &quot;disable&quot;) == 0)
+		tracemode |= 0;
+	else
 	{
-		/* what parts of data access are traced? */
-		if (strcmp(args[0], &quot;none&quot;) == 0)
-		{
-			tracemode = ETMV1_TRACE_NONE;
-		}
-		else if (strcmp(args[0], &quot;data&quot;) == 0)
-		{
-			tracemode = ETMV1_TRACE_DATA;
-		}
-		else if (strcmp(args[0], &quot;address&quot;) == 0)
-		{
-			tracemode = ETMV1_TRACE_ADDR;
-		}
-		else if (strcmp(args[0], &quot;all&quot;) == 0)
-		{
-			tracemode = ETMV1_TRACE_DATA | ETMV1_TRACE_ADDR;
-		}
-		else
-		{
-			command_print(cmd_ctx, &quot;invalid option '%s'&quot;, args[0]);
-			return ERROR_OK;
-		}
+		command_print(cmd_ctx, &quot;invalid option '%s'&quot;, args[3]);
+		return ERROR_OK;
+	}
 
-		uint8_t context_id;
-		COMMAND_PARSE_NUMBER(u8, args[1], context_id);
-		switch (context_id)
-		{
-			case 0:
-				tracemode |= ETMV1_CONTEXTID_NONE;
-				break;
-			case 8:
-				tracemode |= ETMV1_CONTEXTID_8;
-				break;
-			case 16:
-				tracemode |= ETMV1_CONTEXTID_16;
-				break;
-			case 32:
-				tracemode |= ETMV1_CONTEXTID_32;
-				break;
-			default:
-				command_print(cmd_ctx, &quot;invalid option '%s'&quot;, args[1]);
-				return ERROR_OK;
-		}
+	/* IGNORED:
+	 *  - CPRT tracing (coprocessor register transfers)
+	 *  - debug request (causes debug entry on trigger)
+	 *  - stall on FIFOFULL (preventing tracedata lossage)
+	 */
+	*mode = tracemode;
 
-		if (strcmp(args[2], &quot;enable&quot;) == 0)
-		{
-			tracemode |= ETMV1_CYCLE_ACCURATE;
-		}
-		else if (strcmp(args[2], &quot;disable&quot;) == 0)
-		{
-			tracemode |= 0;
-		}
-		else
-		{
-			command_print(cmd_ctx, &quot;invalid option '%s'&quot;, args[2]);
-			return ERROR_OK;
-		}
+	return ERROR_OK;
+}
 
-		if (strcmp(args[3], &quot;enable&quot;) == 0)
-		{
-			tracemode |= ETMV1_BRANCH_OUTPUT;
-		}
-		else if (strcmp(args[3], &quot;disable&quot;) == 0)
-		{
-			tracemode |= 0;
-		}
-		else
-		{
-			command_print(cmd_ctx, &quot;invalid option '%s'&quot;, args[2]);
-			return ERROR_OK;
-		}
+static int handle_etm_tracemode_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+{
+	target_t *target = get_current_target(cmd_ctx);
 
-		/* IGNORED:
-		 *  - CPRT tracing (coprocessor register transfers)
-		 *  - debug request (causes debug entry on trigger)
-		 *  - stall on FIFOFULL (preventing tracedata lossage)
-		 */
+	armv4_5_common_t *armv4_5;
+	arm7_9_common_t *arm7_9;
+	if (arm7_9_get_arch_pointers(target, &amp;armv4_5, &amp;arm7_9) != ERROR_OK)
+	{
+		command_print(cmd_ctx, &quot;current target isn't an ARM7/ARM9 target&quot;);
+		return ERROR_OK;
 	}
-	else if (argc != 0)
+
+	if (!arm7_9-&gt;etm_ctx)
+	{
+		command_print(cmd_ctx, &quot;current target doesn't have an ETM configured&quot;);
+		return ERROR_OK;
+	}
+
+	etmv1_tracemode_t tracemode = arm7_9-&gt;etm_ctx-&gt;tracemode;
+	switch (argc)
 	{
-		command_print(cmd_ctx, &quot;usage: configure trace mode &lt;none | data | address | all&gt; &lt;context id bits&gt; &lt;cycle accurate&gt; &lt;branch output&gt;&quot;);
+	case 0:
+		break;
+	case 4:
+		handle_etm_tracemode_command_update(cmd_ctx, args, &amp;tracemode);
+		break;
+	default:
+		command_print(cmd_ctx, &quot;usage: configure trace mode &quot;
+				&quot;&lt;none | data | address | all&gt; &quot;
+				&quot;&lt;context id bits&gt; &lt;cycle accurate&gt; &lt;branch output&gt;&quot;);
 		return ERROR_OK;
 	}
 

commit d660721ba8821aa92248bddcbeefde1b3e629744
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 08:15:37 2009 -0700

    Improve etm command argument parsing.

diff --git a/src/target/etm.c b/src/target/etm.c
index 5106581..0f5a96f 100644
--- a/src/target/etm.c
+++ b/src/target/etm.c
@@ -1203,7 +1203,9 @@ static int handle_etm_tracemode_command(struct command_context_s *cmd_ctx, char
 			return ERROR_OK;
 		}
 
-		switch (strtol(args[1], NULL, 0))
+		uint8_t context_id;
+		COMMAND_PARSE_NUMBER(u8, args[1], context_id);
+		switch (context_id)
 		{
 			case 0:
 				tracemode |= ETMV1_CONTEXTID_NONE;
@@ -1376,7 +1378,9 @@ static int handle_etm_config_command(struct command_context_s *cmd_ctx, char *cm
 		return ERROR_FAIL;
 	}
 
-	switch (strtoul(args[1], NULL, 0))
+	uint8_t port_width;
+	COMMAND_PARSE_NUMBER(u8, args[1], port_width);
+	switch (port_width)
 	{
 		case 4:
 			portmode |= ETM_PORT_4BIT;
@@ -1688,7 +1692,7 @@ static int handle_etm_image_command(struct command_context_s *cmd_ctx, char *cmd
 	if (argc &gt;= 2)
 	{
 		etm_ctx-&gt;image-&gt;base_address_set = 1;
-		etm_ctx-&gt;image-&gt;base_address = strtoul(args[1], NULL, 0);
+		COMMAND_PARSE_NUMBER(int, args[1], etm_ctx-&gt;image-&gt;base_address);
 	}
 	else
 	{
@@ -1880,7 +1884,8 @@ static int handle_etm_trigger_percent_command(struct command_context_s *cmd_ctx,
 
 	if (argc &gt; 0)
 	{
-		uint32_t new_value = strtoul(args[0], NULL, 0);
+		uint32_t new_value;
+		COMMAND_PARSE_NUMBER(u32, args[0], new_value);
 
 		if ((new_value &lt; 2) || (new_value &gt; 100))
 		{

commit 04b8a2a6f3e85fc701ce19c8c5999ab8a75964cd
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 06:36:06 2009 -0700

    Improve trace command argument parsing.

diff --git a/src/target/trace.c b/src/target/trace.c
index 9387f83..e74c616 100644
--- a/src/target/trace.c
+++ b/src/target/trace.c
@@ -86,7 +86,9 @@ static int handle_trace_point_command(struct command_context_s *cmd_ctx, char *c
 		trace-&gt;trace_points_size += 32;
 	}
 
-	trace-&gt;trace_points[trace-&gt;num_trace_points].address = strtoul(args[0], NULL, 0);
+	uint32_t address;
+	COMMAND_PARSE_NUMBER(u32, args[0], address);
+	trace-&gt;trace_points[trace-&gt;num_trace_points].address = address;
 	trace-&gt;trace_points[trace-&gt;num_trace_points].hit_counter = 0;
 	trace-&gt;num_trace_points++;
 
@@ -112,7 +114,7 @@ static int handle_trace_history_command(struct command_context_s *cmd_ctx, char
 		if (trace-&gt;trace_history)
 			free(trace-&gt;trace_history);
 
-		trace-&gt;trace_history_size = strtoul(args[0], NULL, 0);
+		COMMAND_PARSE_NUMBER(u32, args[0], trace-&gt;trace_history_size);
 		trace-&gt;trace_history = malloc(sizeof(uint32_t) * trace-&gt;trace_history_size);
 
 		command_print(cmd_ctx, &quot;new trace history size: %i&quot;, (int)(trace-&gt;trace_history_size));

commit a8886cdfee58aff32a6c3e3cdf818e584d1075d7
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 06:36:05 2009 -0700

    Improve arm_adi_v5 command argument parsing.

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 3364132..0fc2976 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -1370,10 +1370,18 @@ int dap_baseaddr_command(struct command_context_s *cmd_ctx,
 	uint32_t apsel, apselsave, baseaddr;
 	int retval;
 
-	apsel = swjdp-&gt;apsel;
 	apselsave = swjdp-&gt;apsel;
-	if (argc &gt; 0)
-		apsel = strtoul(args[0], NULL, 0);
+	switch (argc) {
+	case 0:
+		apsel = swjdp-&gt;apsel;
+		break;
+	case 1:
+		COMMAND_PARSE_NUMBER(u32, args[0], apsel);
+		break;
+	default:
+		return ERROR_COMMAND_SYNTAX_ERROR;
+	}
+
 	if (apselsave != apsel)
 		dap_ap_select(swjdp, apsel);
 
@@ -1392,11 +1400,18 @@ int dap_memaccess_command(struct command_context_s *cmd_ctx,
 {
 	uint32_t memaccess_tck;
 
-	memaccess_tck = swjdp-&gt;memaccess_tck;
-	if (argc &gt; 0)
-		memaccess_tck = strtoul(args[0], NULL, 0);
-
+	switch (argc) {
+	case 0:
+		memaccess_tck = swjdp-&gt;memaccess_tck;
+		break;
+	case 1:
+		COMMAND_PARSE_NUMBER(u32, args[0], memaccess_tck);
+		break;
+	default:
+		return ERROR_COMMAND_SYNTAX_ERROR;
+	}
 	swjdp-&gt;memaccess_tck = memaccess_tck;
+
 	command_print(cmd_ctx, &quot;memory bus access delay set to %&quot; PRIi32 &quot; tck&quot;,
 			swjdp-&gt;memaccess_tck);
 
@@ -1409,9 +1424,16 @@ int dap_apsel_command(struct command_context_s *cmd_ctx,
 	uint32_t apsel, apid;
 	int retval;
 
-	apsel = 0;
-	if (argc &gt; 0)
-		apsel = strtoul(args[0], NULL, 0);
+	switch (argc) {
+	case 0:
+		apsel = 0;
+		break;
+	case 1:
+		COMMAND_PARSE_NUMBER(u32, args[0], apsel);
+		break;
+	default:
+		return ERROR_COMMAND_SYNTAX_ERROR;
+	}
 
 	dap_ap_select(swjdp, apsel);
 	dap_ap_read_reg_u32(swjdp, 0xFC, &amp;apid);
@@ -1428,10 +1450,17 @@ int dap_apid_command(struct command_context_s *cmd_ctx,
 	uint32_t apsel, apselsave, apid;
 	int retval;
 
-	apsel = swjdp-&gt;apsel;
 	apselsave = swjdp-&gt;apsel;
-	if (argc &gt; 0)
-		apsel = strtoul(args[0], NULL, 0);
+	switch (argc) {
+	case 0:
+		apsel = swjdp-&gt;apsel;
+		break;
+	case 1:
+		COMMAND_PARSE_NUMBER(u32, args[0], apsel);
+		break;
+	default:
+		return ERROR_COMMAND_SYNTAX_ERROR;
+	}
 
 	if (apselsave != apsel)
 		dap_ap_select(swjdp, apsel);
@@ -1444,5 +1473,3 @@ int dap_apid_command(struct command_context_s *cmd_ctx,
 
 	return retval;
 }
-
-

commit 9b3781e5a4c0145f0be4e7c262975e3b9909d1c4
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 06:36:06 2009 -0700

    Improve cortex_m3 command argument parsing.

diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index 51481a9..a1d1cbc 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -1830,14 +1830,10 @@ handle_cortex_m3_disassemble_command(struct command_context_s *cmd_ctx,
 	errno = 0;
 	switch (argc) {
 	case 2:
-		count = strtoul(args[1], NULL, 0);
-		if (errno)
-			return ERROR_FAIL;
+		COMMAND_PARSE_NUMBER(ulong, args[1], count);
 		/* FALL THROUGH */
 	case 1:
-		address = strtoul(args[0], NULL, 0);
-		if (errno)
-			return ERROR_FAIL;
+		COMMAND_PARSE_NUMBER(u32, args[0], address);
 		break;
 	default:
 		command_print(cmd_ctx,

commit af84cd33a2e0b8af31d4c7dbd64cfd0348d65a0e
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 06:36:06 2009 -0700

    Improve xscale command argument parsing.

diff --git a/src/target/xscale.c b/src/target/xscale.c
index 4598872..78c2124 100644
--- a/src/target/xscale.c
+++ b/src/target/xscale.c
@@ -3290,7 +3290,7 @@ static int xscale_handle_vector_catch_command(command_context_t *cmd_ctx,
 	}
 	else
 	{
-		COMMAND_PARSE_NUMBER(u32, args[0], xscale-&gt;vector_catch);
+		COMMAND_PARSE_NUMBER(u8, args[0], xscale-&gt;vector_catch);
 		buf_set_u32(xscale-&gt;reg_cache-&gt;reg_list[XSCALE_DCSR].value, 16, 8, xscale-&gt;vector_catch);
 		xscale_write_dcsr(target, -1, -1);
 	}
@@ -3478,7 +3478,7 @@ xscale_handle_trace_image_command(struct command_context_s *cmd_ctx,
 	if (argc &gt;= 2)
 	{
 		xscale-&gt;trace.image-&gt;base_address_set = 1;
-		COMMAND_PARSE_NUMBER(u32, args[1], xscale-&gt;trace.image-&gt;base_address);
+		COMMAND_PARSE_NUMBER(int, args[1], xscale-&gt;trace.image-&gt;base_address);
 	}
 	else
 	{

commit 4d67b0974f23c1d24050eeec8c8533a2396fa6d4
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 06:36:05 2009 -0700

    Improve arm11 command argument parsing.

diff --git a/src/target/arm11.c b/src/target/arm11.c
index 5411b04..28ee723 100644
--- a/src/target/arm11.c
+++ b/src/target/arm11.c
@@ -2060,12 +2060,12 @@ BOOL_WRAPPER(hardware_step,			&quot;hardware single step&quot;)
 
 int arm11_handle_vcr(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	if (argc == 1)
-	{
-		arm11_vcr = strtoul(args[0], NULL, 0);
-	}
-	else if (argc != 0)
-	{
+	switch (argc) {
+	case 0:
+		break;
+	case 1:
+		COMMAND_PARSE_NUMBER(u32, args[0], arm11_vcr);
+	default:
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
@@ -2134,7 +2134,7 @@ int arm11_handle_mrc_mcr(struct command_context_s *cmd_ctx, char *cmd, char **ar
 
 	for (size_t i = 0; i &lt; (read ? 5 : 6); i++)
 	{
-		values[i] = strtoul(args[i + 1], NULL, 0);
+		COMMAND_PARSE_NUMBER(u32, args[i + 1], values[i]);
 
 		if (values[i] &gt; arm11_coproc_instruction_limits[i])
 		{

commit b699aef4c009e705660ee5a0bdfd3a2064fa0a20
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 06:36:05 2009 -0700

    Improve arm966e command argument parsing.

diff --git a/src/target/arm966e.c b/src/target/arm966e.c
index c06562c..5770895 100644
--- a/src/target/arm966e.c
+++ b/src/target/arm966e.c
@@ -270,7 +270,8 @@ int arm966e_handle_cp15_command(struct command_context_s *cmd_ctx, char *cmd, ch
 	/* one or more argument, access a single register (write if second argument is given */
 	if (argc &gt;= 1)
 	{
-		int address = strtoul(args[0], NULL, 0);
+		uint32_t address;
+		COMMAND_PARSE_NUMBER(u32, args[0], address);
 
 		if (argc == 1)
 		{
@@ -289,7 +290,8 @@ int arm966e_handle_cp15_command(struct command_context_s *cmd_ctx, char *cmd, ch
 		}
 		else if (argc == 2)
 		{
-			uint32_t value = strtoul(args[1], NULL, 0);
+			uint32_t value;
+			COMMAND_PARSE_NUMBER(u32, args[1], value);
 			if ((retval = arm966e_write_cp15(target, address, value)) != ERROR_OK)
 			{
 				command_print(cmd_ctx, &quot;couldn't access reg %i&quot;, address);

commit f8f1ac886519d8ea4e21572f86a42a223ce72457
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 06:36:05 2009 -0700

    Improve arm926ejs command argument parsing.

diff --git a/src/target/arm926ejs.c b/src/target/arm926ejs.c
index ee24f5c..03adc77 100644
--- a/src/target/arm926ejs.c
+++ b/src/target/arm926ejs.c
@@ -807,10 +807,10 @@ static int arm926ejs_handle_cp15_command(struct command_context_s *cmd_ctx,
 		return ERROR_OK;
 	}
 
-	opcode_1 = strtoul(args[0], NULL, 0);
-	opcode_2 = strtoul(args[1], NULL, 0);
-	CRn = strtoul(args[2], NULL, 0);
-	CRm = strtoul(args[3], NULL, 0);
+	COMMAND_PARSE_NUMBER(int, args[0], opcode_1);
+	COMMAND_PARSE_NUMBER(int, args[1], opcode_2);
+	COMMAND_PARSE_NUMBER(int, args[2], CRn);
+	COMMAND_PARSE_NUMBER(int, args[3], CRm);
 
 	if (arm926ejs_get_arch_pointers(target, &amp;armv4_5, &amp;arm7_9, &amp;arm9tdmi, &amp;arm926ejs) != ERROR_OK)
 	{
@@ -841,7 +841,8 @@ static int arm926ejs_handle_cp15_command(struct command_context_s *cmd_ctx,
 	}
 	else
 	{
-		uint32_t value = strtoul(args[4], NULL, 0);
+		uint32_t value;
+		COMMAND_PARSE_NUMBER(u32, args[4], value);
 		if ((retval = arm926ejs-&gt;write_cp15(target, opcode_1, opcode_2, CRn, CRm, value)) != ERROR_OK)
 		{
 			command_print(cmd_ctx, &quot;couldn't access register&quot;);

commit 714d92a954ad348571713c4ccc2611d7b910bcc7
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 06:36:05 2009 -0700

    Improve arm920t command argument parsing.

diff --git a/src/target/arm920t.c b/src/target/arm920t.c
index 2556002..40f4b4d 100644
--- a/src/target/arm920t.c
+++ b/src/target/arm920t.c
@@ -1295,7 +1295,8 @@ int arm920t_handle_cp15_command(struct command_context_s *cmd_ctx, char *cmd, ch
 	/* one or more argument, access a single register (write if second argument is given */
 	if (argc &gt;= 1)
 	{
-		int address = strtoul(args[0], NULL, 0);
+		int address;
+		COMMAND_PARSE_NUMBER(int, args[0], address);
 
 		if (argc == 1)
 		{
@@ -1314,7 +1315,8 @@ int arm920t_handle_cp15_command(struct command_context_s *cmd_ctx, char *cmd, ch
 		}
 		else if (argc == 2)
 		{
-			uint32_t value = strtoul(args[1], NULL, 0);
+			uint32_t value;
+			COMMAND_PARSE_NUMBER(u32, args[1], value);
 			if ((retval = arm920t_write_cp15_physical(target, address, value)) != ERROR_OK)
 			{
 				command_print(cmd_ctx, &quot;couldn't access reg %i&quot;, address);
@@ -1354,7 +1356,8 @@ int arm920t_handle_cp15i_command(struct command_context_s *cmd_ctx, char *cmd, c
 	/* one or more argument, access a single register (write if second argument is given */
 	if (argc &gt;= 1)
 	{
-		uint32_t opcode = strtoul(args[0], NULL, 0);
+		uint32_t opcode;
+		COMMAND_PARSE_NUMBER(u32, args[0], opcode);
 
 		if (argc == 1)
 		{
@@ -1369,7 +1372,8 @@ int arm920t_handle_cp15i_command(struct command_context_s *cmd_ctx, char *cmd, c
 		}
 		else if (argc == 2)
 		{
-			uint32_t value = strtoul(args[1], NULL, 0);
+			uint32_t value;
+			COMMAND_PARSE_NUMBER(u32, args[1], value);
 			if ((retval = arm920t_write_cp15_interpreted(target, opcode, value, 0)) != ERROR_OK)
 			{
 				command_print(cmd_ctx, &quot;couldn't execute %8.8&quot; PRIx32 &quot;&quot;, opcode);
@@ -1379,8 +1383,10 @@ int arm920t_handle_cp15i_command(struct command_context_s *cmd_ctx, char *cmd, c
 		}
 		else if (argc == 3)
 		{
-			uint32_t value = strtoul(args[1], NULL, 0);
-			uint32_t address = strtoul(args[2], NULL, 0);
+			uint32_t value;
+			COMMAND_PARSE_NUMBER(u32, args[1], value);
+			uint32_t address;
+			COMMAND_PARSE_NUMBER(u32, args[2], address);
 			if ((retval = arm920t_write_cp15_interpreted(target, opcode, value, address)) != ERROR_OK)
 			{
 				command_print(cmd_ctx, &quot;couldn't execute %8.8&quot; PRIx32 &quot;&quot;, opcode);

commit 0442bda216ef89a212f1dc58591db6edfd6b9f08
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 06:36:05 2009 -0700

    Improve arm720t command argument parsing.

diff --git a/src/target/arm720t.c b/src/target/arm720t.c
index c18291a..836d347 100644
--- a/src/target/arm720t.c
+++ b/src/target/arm720t.c
@@ -544,7 +544,8 @@ int arm720t_handle_cp15_command(struct command_context_s *cmd_ctx, char *cmd, ch
 	/* one or more argument, access a single register (write if second argument is given */
 	if (argc &gt;= 1)
 	{
-		uint32_t opcode = strtoul(args[0], NULL, 0);
+		uint32_t opcode;
+		COMMAND_PARSE_NUMBER(u32, args[0], opcode);
 
 		if (argc == 1)
 		{
@@ -564,7 +565,9 @@ int arm720t_handle_cp15_command(struct command_context_s *cmd_ctx, char *cmd, ch
 		}
 		else if (argc == 2)
 		{
-			uint32_t value = strtoul(args[1], NULL, 0);
+			uint32_t value;
+			COMMAND_PARSE_NUMBER(u32, args[1], value);
+
 			if ((retval = arm720t_write_cp15(target, opcode, value)) != ERROR_OK)
 			{
 				command_print(cmd_ctx, &quot;couldn't access cp15 with opcode 0x%8.8&quot; PRIx32 &quot;&quot;, opcode);

commit 11a0afc932853fc9cb8d33a5fdce954195f406e2
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 07:03:20 2009 -0700

    Improve arm7_9_common command argument parsing.

diff --git a/src/target/arm7_9_common.c b/src/target/arm7_9_common.c
index 45394b7..21c5c7a 100644
--- a/src/target/arm7_9_common.c
+++ b/src/target/arm7_9_common.c
@@ -2959,8 +2959,8 @@ int handle_arm7_9_write_xpsr_command(struct command_context_s *cmd_ctx, char *cm
 		return ERROR_OK;
 	}
 
-	value = strtoul(args[0], NULL, 0);
-	spsr = strtol(args[1], NULL, 0);
+	COMMAND_PARSE_NUMBER(u32, args[0], value);
+	COMMAND_PARSE_NUMBER(int, args[1], spsr);
 
 	/* if we're writing the CPSR, mask the T bit */
 	if (!spsr)
@@ -3004,9 +3004,9 @@ int handle_arm7_9_write_xpsr_im8_command(struct command_context_s *cmd_ctx, char
 		return ERROR_OK;
 	}
 
-	value = strtoul(args[0], NULL, 0);
-	rotate = strtol(args[1], NULL, 0);
-	spsr = strtol(args[2], NULL, 0);
+	COMMAND_PARSE_NUMBER(u32, args[0], value);
+	COMMAND_PARSE_NUMBER(int, args[1], rotate);
+	COMMAND_PARSE_NUMBER(int, args[2], spsr);
 
 	arm7_9-&gt;write_xpsr_im8(target, value, rotate, spsr);
 	if ((retval = jtag_execute_queue()) != ERROR_OK)
@@ -3045,9 +3045,9 @@ int handle_arm7_9_write_core_reg_command(struct command_context_s *cmd_ctx, char
 		return ERROR_OK;
 	}
 
-	num = strtol(args[0], NULL, 0);
-	mode = strtoul(args[1], NULL, 0);
-	value = strtoul(args[2], NULL, 0);
+	COMMAND_PARSE_NUMBER(int, args[0], num);
+	COMMAND_PARSE_NUMBER(u32, args[1], mode);
+	COMMAND_PARSE_NUMBER(u32, args[2], value);
 
 	return arm7_9_write_core_reg(target, num, mode, value);
 }

commit 3541ed3aa3beb93c80bb2a01be429dacdec33919
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 06:36:06 2009 -0700

    Improve armv7m command argument parsing.

diff --git a/src/target/armv7m.c b/src/target/armv7m.c
index 64bdfd5..49e50f4 100644
--- a/src/target/armv7m.c
+++ b/src/target/armv7m.c
@@ -756,25 +756,27 @@ static int handle_dap_baseaddr_command(struct command_context_s *cmd_ctx,
 	uint32_t apsel, apselsave, baseaddr;
 	int retval;
 
-	apsel = swjdp-&gt;apsel;
 	apselsave = swjdp-&gt;apsel;
-	if (argc &gt; 0)
-	{
-		apsel = strtoul(args[0], NULL, 0);
+	switch (argc) {
+	case 0:
+		apsel = swjdp-&gt;apsel;
+		break;
+	case 1:
+		COMMAND_PARSE_NUMBER(u32, args[0], apsel);
+		break;
+	default:
+		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
+
 	if (apselsave != apsel)
-	{
 		dap_ap_select(swjdp, apsel);
-	}
 
 	dap_ap_read_reg_u32(swjdp, 0xF8, &amp;baseaddr);
 	retval = swjdp_transaction_endcheck(swjdp);
 	command_print(cmd_ctx, &quot;0x%8.8&quot; PRIx32 &quot;&quot;, baseaddr);
 
 	if (apselsave != apsel)
-	{
 		dap_ap_select(swjdp, apselsave);
-	}
 
 	return retval;
 }
@@ -822,9 +824,16 @@ static int handle_dap_info_command(struct command_context_s *cmd_ctx,
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 	uint32_t apsel;
 
-	apsel =  swjdp-&gt;apsel;
-	if (argc &gt; 0)
-		apsel = strtoul(args[0], NULL, 0);
+	switch (argc) {
+	case 0:
+		apsel = swjdp-&gt;apsel;
+		break;
+	case 1:
+		COMMAND_PARSE_NUMBER(u32, args[0], apsel);
+		break;
+	default:
+		return ERROR_COMMAND_SYNTAX_ERROR;
+	}
 
 	return dap_info_command(cmd_ctx, swjdp, apsel);
 }

commit 3dd5c59d7d4d4dc13ebd3fc870bd4bc695c9fda8
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 06:36:06 2009 -0700

    Improve armv7a command argument parsing.

diff --git a/src/target/armv7a.c b/src/target/armv7a.c
index 1e0e02f..1583e99 100644
--- a/src/target/armv7a.c
+++ b/src/target/armv7a.c
@@ -286,9 +286,16 @@ static int handle_dap_info_command(struct command_context_s *cmd_ctx,
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 	uint32_t apsel;
 
-	apsel =  swjdp-&gt;apsel;
-	if (argc &gt; 0)
-		apsel = strtoul(args[0], NULL, 0);
+	switch (argc) {
+	case 0:
+		apsel = swjdp-&gt;apsel;
+		break;
+	case 1:
+		COMMAND_PARSE_NUMBER(u32, args[0], apsel);
+		break;
+	default:
+		return ERROR_COMMAND_SYNTAX_ERROR;
+	}
 
 	return dap_info_command(cmd_ctx, swjdp, apsel);
 }
@@ -320,10 +327,10 @@ handle_armv7a_disassemble_command(struct command_context_s *cmd_ctx,
 		thumb = 1;
 		/* FALL THROUGH */
 	case 2:
-		count = strtoul(args[1], NULL, 0);
+		COMMAND_PARSE_NUMBER(int, args[1], count);
 		/* FALL THROUGH */
 	case 1:
-		address = strtoul(args[0], NULL, 0);
+		COMMAND_PARSE_NUMBER(u32, args[0], address);
 		if (address &amp; 0x01) {
 			if (!thumb) {
 				command_print(cmd_ctx, &quot;Disassemble as Thumb&quot;);

commit b62ee5a3c56cfbb000a40c05083dd31720c7cb1e
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 06:36:05 2009 -0700

    Improve armv4_5 command argument parsing.

diff --git a/src/target/armv4_5.c b/src/target/armv4_5.c
index eedbc70..9d942ae 100644
--- a/src/target/armv4_5.c
+++ b/src/target/armv4_5.c
@@ -415,10 +415,10 @@ handle_armv4_5_disassemble_command(struct command_context_s *cmd_ctx,
 		thumb = 1;
 		/* FALL THROUGH */
 	case 2:
-		count = strtoul(args[1], NULL, 0);
+		COMMAND_PARSE_NUMBER(int, args[1], count);
 		/* FALL THROUGH */
 	case 1:
-		address = strtoul(args[0], NULL, 0);
+		COMMAND_PARSE_NUMBER(u32, args[0], address);
 		if (address &amp; 0x01) {
 			if (!thumb) {
 				command_print(cmd_ctx, &quot;Disassemble as Thumb&quot;);

commit ab33bdd46c3bb3acdb3f1b1f09a0e1a9393ef798
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 05:55:23 2009 -0700

    Improve xscale command argument parsing.

diff --git a/src/target/xscale.c b/src/target/xscale.c
index cc4176b..4598872 100644
--- a/src/target/xscale.c
+++ b/src/target/xscale.c
@@ -3069,7 +3069,7 @@ xscale_handle_debug_handler_command(struct command_context_s *cmd_ctx,
 		return ERROR_FAIL;
 	}
 
-	handler_address = strtoul(args[1], NULL, 0);
+	COMMAND_PARSE_NUMBER(u32, args[1], handler_address);
 
 	if (((handler_address &gt;= 0x800) &amp;&amp; (handler_address &lt;= 0x1fef800)) ||
 		((handler_address &gt;= 0xfe000800) &amp;&amp; (handler_address &lt;= 0xfffff800)))
@@ -3112,7 +3112,7 @@ xscale_handle_cache_clean_address_command(struct command_context_s *cmd_ctx,
 		return ERROR_FAIL;
 	}
 
-	cache_clean_address = strtoul(args[1], NULL, 0);
+	COMMAND_PARSE_NUMBER(u32, args[1], cache_clean_address);
 
 	if (cache_clean_address &amp; 0xffff)
 	{
@@ -3290,7 +3290,7 @@ static int xscale_handle_vector_catch_command(command_context_t *cmd_ctx,
 	}
 	else
 	{
-		xscale-&gt;vector_catch = strtoul(args[0], NULL, 0);
+		COMMAND_PARSE_NUMBER(u32, args[0], xscale-&gt;vector_catch);
 		buf_set_u32(xscale-&gt;reg_cache-&gt;reg_list[XSCALE_DCSR].value, 16, 8, xscale-&gt;vector_catch);
 		xscale_write_dcsr(target, -1, -1);
 	}
@@ -3333,9 +3333,9 @@ static int xscale_handle_vector_table_command(command_context_t *cmd_ctx,
 	else
 	{
 		int idx;
+		COMMAND_PARSE_NUMBER(int, args[1], idx);
 		uint32_t vec;
-		idx = strtoul(args[1], NULL, 0);
-		vec = strtoul(args[2], NULL, 0);
+		COMMAND_PARSE_NUMBER(u32, args[2], vec);
 
 		if (idx &lt; 1 || idx &gt;= 8)
 			err = 1;
@@ -3406,10 +3406,10 @@ xscale_handle_trace_buffer_command(struct command_context_s *cmd_ctx,
 
 	if ((argc &gt;= 2) &amp;&amp; (strcmp(&quot;fill&quot;, args[1]) == 0))
 	{
+		uint32_t fill = 1;
 		if (argc &gt;= 3)
-			xscale-&gt;trace.buffer_fill = strtoul(args[2], NULL, 0);
-		else
-			xscale-&gt;trace.buffer_fill = 1;
+			COMMAND_PARSE_NUMBER(u32, args[2], fill);
+		xscale-&gt;trace.buffer_fill = fill;
 	}
 	else if ((argc &gt;= 2) &amp;&amp; (strcmp(&quot;wrap&quot;, args[1]) == 0))
 	{
@@ -3478,7 +3478,7 @@ xscale_handle_trace_image_command(struct command_context_s *cmd_ctx,
 	if (argc &gt;= 2)
 	{
 		xscale-&gt;trace.image-&gt;base_address_set = 1;
-		xscale-&gt;trace.image-&gt;base_address = strtoul(args[1], NULL, 0);
+		COMMAND_PARSE_NUMBER(u32, args[1], xscale-&gt;trace.image-&gt;base_address);
 	}
 	else
 	{
@@ -3593,7 +3593,7 @@ static int xscale_handle_cp15(command_context_t *cmd_ctx,
 	reg_t *reg = NULL;
 	if (argc &gt; 0)
 	{
-		reg_no = strtoul(args[0], NULL, 0);
+		COMMAND_PARSE_NUMBER(u32, args[0], reg_no);
 		/*translate from xscale cp15 register no to openocd register*/
 		switch (reg_no)
 		{
@@ -3639,8 +3639,8 @@ static int xscale_handle_cp15(command_context_t *cmd_ctx,
 	}
 	else if (argc == 2)
 	{
-
-		uint32_t value = strtoul(args[1], NULL, 0);
+		uint32_t value;
+		COMMAND_PARSE_NUMBER(u32, args[1], value);
 
 		/* send CP write request (command 0x41) */
 		xscale_send_u32(target, 0x41);

commit 6e542407e7927ec589824b56ba706ed02d0ba97f
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 01:22:58 2009 -0700

    Improve pld command argument parsing.

diff --git a/src/pld/pld.c b/src/pld/pld.c
index 391fb76..2bfb401 100644
--- a/src/pld/pld.c
+++ b/src/pld/pld.c
@@ -175,7 +175,9 @@ static int handle_pld_load_command(struct command_context_s *cmd_ctx,
 		return ERROR_OK;
 	}
 
-	p = get_pld_device_by_num(strtoul(args[0], NULL, 0));
+	unsigned dev_id;
+	COMMAND_PARSE_NUMBER(uint, args[0], dev_id);
+	p = get_pld_device_by_num(dev_id);
 	if (!p)
 	{
 		command_print(cmd_ctx, &quot;pld device '#%s' is out of bounds&quot;, args[0]);
@@ -184,19 +186,20 @@ static int handle_pld_load_command(struct command_context_s *cmd_ctx,
 
 	if ((retval = p-&gt;driver-&gt;load(p, args[1])) != ERROR_OK)
 	{
-		command_print(cmd_ctx, &quot;failed loading file %s to pld device %lu&quot;,
-			args[1], strtoul(args[0], NULL, 0));
+		command_print(cmd_ctx, &quot;failed loading file %s to pld device %u&quot;,
+			args[1], dev_id);
 		switch (retval)
 		{
 		}
+		return retval;
 	}
 	else
 	{
 		gettimeofday(&amp;end, NULL);
 		timeval_subtract(&amp;duration, &amp;end, &amp;start);
 
-		command_print(cmd_ctx, &quot;loaded file %s to pld device %lu in %jis %jius&quot;,
-			args[1], strtoul(args[0], NULL, 0),
+		command_print(cmd_ctx, &quot;loaded file %s to pld device %u in %jis %jius&quot;,
+			args[1], dev_id,
 			(intmax_t)duration.tv_sec, (intmax_t)duration.tv_usec);
 	}
 
diff --git a/src/pld/virtex2.c b/src/pld/virtex2.c
index 831503a..28cae6c 100644
--- a/src/pld/virtex2.c
+++ b/src/pld/virtex2.c
@@ -202,7 +202,9 @@ static int virtex2_handle_read_stat_command(struct command_context_s *cmd_ctx,
 		return ERROR_OK;
 	}
 
-	device = get_pld_device_by_num(strtoul(args[0], NULL, 0));
+	unsigned dev_id;
+	COMMAND_PARSE_NUMBER(uint, args[0], dev_id);
+	device = get_pld_device_by_num(dev_id);
 	if (!device)
 	{
 		command_print(cmd_ctx, &quot;pld device '#%s' is out of bounds&quot;, args[0]);

commit 2b78a4e82b1845ee7cc89f6e31d7b49e9299cb32
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 01:12:56 2009 -0700

    Update all server port command to use new helper.

diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index adf5c68..3ed2b1f 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -2271,15 +2271,7 @@ int handle_gdb_sync_command(struct command_context_s *cmd_ctx, char *cmd, char *
 /* daemon configuration command gdb_port */
 int handle_gdb_port_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	if (argc == 0)
-	{
-		command_print(cmd_ctx, &quot;%d&quot;, gdb_port);
-		return ERROR_OK;
-	}
-
-	gdb_port = strtoul(args[0], NULL, 0);
-
-	return ERROR_OK;
+	return server_port_command(cmd_ctx, cmd, args, argc, &amp;gdb_port);
 }
 
 int handle_gdb_memory_map_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
diff --git a/src/server/tcl_server.c b/src/server/tcl_server.c
index e588677..178d86b 100644
--- a/src/server/tcl_server.c
+++ b/src/server/tcl_server.c
@@ -179,10 +179,8 @@ int tcl_register_commands(command_context_t *cmd_ctx)
 	return ERROR_OK;
 }
 
-static int handle_tcl_port_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+static int handle_tcl_port_command(struct command_context_s *cmd_ctx,
+		char *cmd, char **args, int argc)
 {
-	if (argc == 1) {
-		tcl_port = strtoul(args[0], NULL, 0);
-	}
-	return ERROR_OK;
+	return server_port_command(cmd_ctx, cmd, args, argc, &amp;tcl_port);
 }
diff --git a/src/server/telnet_server.c b/src/server/telnet_server.c
index f26ad9f..c9c60bb 100644
--- a/src/server/telnet_server.c
+++ b/src/server/telnet_server.c
@@ -622,15 +622,7 @@ int telnet_register_commands(command_context_t *command_context)
 /* daemon configuration command telnet_port */
 int handle_telnet_port_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
 {
-	if (argc == 0)
-	{
-		command_print(cmd_ctx, &quot;%d&quot;, telnet_port);
-		return ERROR_OK;
-	}
-
-	telnet_port = strtoul(args[0], NULL, 0);
-
-	return ERROR_OK;
+	return server_port_command(cmd_ctx, cmd, args, argc, &amp;telnet_port);
 }
 
 int handle_exit_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)

commit ae5732b9e4f085b89da3f9ce07eb526e159e1937
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Sat Oct 24 01:11:13 2009 -0700

    Add server port command helper function.

diff --git a/src/server/server.c b/src/server/server.c
index d259611..03f0ee6 100644
--- a/src/server/server.c
+++ b/src/server/server.c
@@ -549,3 +549,23 @@ int handle_shutdown_command(struct command_context_s *cmd_ctx, char *cmd, char *
 
 	return ERROR_COMMAND_CLOSE_CONNECTION;
 }
+
+int server_port_command(struct command_context_s *cmd_ctx,
+		char *cmd, char **args, int argc, unsigned short *out)
+{
+	switch (argc) {
+	case 0:
+		command_print(cmd_ctx, &quot;%d&quot;, *out);
+		break;
+	case 1:
+	{
+		uint16_t port;
+		COMMAND_PARSE_NUMBER(u16, args[0], port);
+		*out = port;
+		break;
+	}
+	default:
+		return ERROR_INVALID_ARGUMENTS;
+	}
+	return ERROR_OK;
+}
diff --git a/src/server/server.h b/src/server/server.h
index 2dba3da..dab28ec 100644
--- a/src/server/server.h
+++ b/src/server/server.h
@@ -75,6 +75,9 @@ extern int server_quit(void);
 extern int server_loop(command_context_t *command_context);
 extern int server_register_commands(command_context_t *context);
 
+int server_port_command(struct command_context_s *cmd_ctx,
+		char *cmd, char **args, int argc, unsigned short *port);
+
 extern int server_use_pipes;
 
 #define ERROR_SERVER_REMOTE_CLOSED	(-400)

commit 653ea7b25c4bec65fbe60101eb55d2564ba982af
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 21:04:23 2009 -0700

    Improve target.c command argument parsing.
    
    Passes cmd_ctx into parse_load_image_command_args for reporting the
    parsing errors therein.

diff --git a/src/target/target.c b/src/target/target.c
index 9502490..b5c473b 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -2014,9 +2014,7 @@ static int handle_reg_command(struct command_context_s *cmd_ctx, char *cmd, char
 	if ((args[0][0] &gt;= '0') &amp;&amp; (args[0][0] &lt;= '9'))
 	{
 		unsigned num;
-		int retval = parse_uint(args[0], &amp;num);
-		if (ERROR_OK != retval)
-			return ERROR_COMMAND_SYNTAX_ERROR;
+		COMMAND_PARSE_NUMBER(uint, args[0], num);
 
 		reg_cache_t *cache = target-&gt;reg_cache;
 		count = 0;
@@ -2270,9 +2268,7 @@ static int handle_resume_command(struct command_context_s *cmd_ctx, char *cmd, c
 	uint32_t addr = 0;
 	if (argc == 1)
 	{
-		int retval = parse_u32(args[0], &amp;addr);
-		if (ERROR_OK != retval)
-			return retval;
+		COMMAND_PARSE_NUMBER(u32, args[0], addr);
 		current = 0;
 	}
 
@@ -2293,9 +2289,7 @@ static int handle_step_command(struct command_context_s *cmd_ctx, char *cmd, cha
 	int current_pc = 1;
 	if (argc == 1)
 	{
-		int retval = parse_u32(args[0], &amp;addr);
-		if (ERROR_OK != retval)
-			return retval;
+		COMMAND_PARSE_NUMBER(u32, args[0], addr);
 		current_pc = 0;
 	}
 
@@ -2382,23 +2376,18 @@ static int handle_md_command(struct command_context_s *cmd_ctx, char *cmd, char
 	{
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
+
 	uint32_t address;
-	int retval = parse_u32(args[0], &amp;address);
-	if (ERROR_OK != retval)
-		return retval;
+	COMMAND_PARSE_NUMBER(u32, args[0], address);
 
 	unsigned count = 1;
 	if (argc == 2)
-	{
-		retval = parse_uint(args[1], &amp;count);
-		if (ERROR_OK != retval)
-			return retval;
-	}
+		COMMAND_PARSE_NUMBER(uint, args[1], count);
 
 	uint8_t *buffer = calloc(count, size);
 
 	target_t *target = get_current_target(cmd_ctx);
-	retval = fn(target, address, size, count, buffer);
+	int retval = fn(target, address, size, count, buffer);
 	if (ERROR_OK == retval)
 		handle_md_output(cmd_ctx, target, address, size, count, buffer);
 
@@ -2429,22 +2418,14 @@ static int handle_mw_command(struct command_context_s *cmd_ctx, char *cmd, char
 		return ERROR_COMMAND_SYNTAX_ERROR;
 
 	uint32_t address;
-	int retval = parse_u32(args[0], &amp;address);
-	if (ERROR_OK != retval)
-		return retval;
+	COMMAND_PARSE_NUMBER(u32, args[0], address);
 
 	uint32_t value;
-	retval = parse_u32(args[1], &amp;value);
-	if (ERROR_OK != retval)
-		return retval;
+	COMMAND_PARSE_NUMBER(u32, args[1], value);
 
 	unsigned count = 1;
 	if (argc == 3)
-	{
-		retval = parse_uint(args[2], &amp;count);
-		if (ERROR_OK != retval)
-			return retval;
-	}
+		COMMAND_PARSE_NUMBER(uint, args[2], count);
 
 	target_t *target = get_current_target(cmd_ctx);
 	unsigned wordsize;
@@ -2468,7 +2449,7 @@ static int handle_mw_command(struct command_context_s *cmd_ctx, char *cmd, char
 	}
 	for (unsigned i = 0; i &lt; count; i++)
 	{
-		retval = fn(target,
+		int retval = fn(target,
 				address + i * wordsize, wordsize, 1, value_buf);
 		if (ERROR_OK != retval)
 			return retval;
@@ -2479,8 +2460,9 @@ static int handle_mw_command(struct command_context_s *cmd_ctx, char *cmd, char
 
 }
 
-static int parse_load_image_command_args(char **args, int argc,
-		image_t *image, uint32_t *min_address, uint32_t *max_address)
+static int parse_load_image_command_args(struct command_context_s *cmd_ctx,
+		char **args, int argc, image_t *image,
+		uint32_t *min_address, uint32_t *max_address)
 {
 	if (argc &lt; 1 || argc &gt; 5)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -2490,9 +2472,7 @@ static int parse_load_image_command_args(char **args, int argc,
 	if (argc &gt;= 2)
 	{
 		uint32_t addr;
-		int retval = parse_u32(args[1], &amp;addr);
-		if (ERROR_OK != retval)
-			return ERROR_COMMAND_SYNTAX_ERROR;
+		COMMAND_PARSE_NUMBER(u32, args[1], addr);
 		image-&gt;base_address = addr;
 		image-&gt;base_address_set = 1;
 	}
@@ -2503,15 +2483,11 @@ static int parse_load_image_command_args(char **args, int argc,
 
 	if (argc &gt;= 4)
 	{
-		int retval = parse_u32(args[3], min_address);
-		if (ERROR_OK != retval)
-			return ERROR_COMMAND_SYNTAX_ERROR;
+		COMMAND_PARSE_NUMBER(u32, args[3], *min_address);
 	}
 	if (argc == 5)
 	{
-		int retval = parse_u32(args[4], max_address);
-		if (ERROR_OK != retval)
-			return ERROR_COMMAND_SYNTAX_ERROR;
+		COMMAND_PARSE_NUMBER(u32, args[4], *max_address);
 		// use size (given) to find max (required)
 		*max_address += *min_address;
 	}
@@ -2537,7 +2513,7 @@ static int handle_load_image_command(struct command_context_s *cmd_ctx, char *cm
 	duration_t duration;
 	char *duration_text;
 
-	int retval = parse_load_image_command_args(args, argc,
+	int retval = parse_load_image_command_args(cmd_ctx, args, argc,
 			&amp;image, &amp;min_address, &amp;max_address);
 	if (ERROR_OK != retval)
 		return retval;
@@ -2642,14 +2618,9 @@ static int handle_dump_image_command(struct command_context_s *cmd_ctx, char *cm
 	}
 
 	uint32_t address;
-	int retval = parse_u32(args[1], &amp;address);
-	if (ERROR_OK != retval)
-		return retval;
-
+	COMMAND_PARSE_NUMBER(u32, args[1], address);
 	uint32_t size;
-	retval = parse_u32(args[2], &amp;size);
-	if (ERROR_OK != retval)
-		return retval;
+	COMMAND_PARSE_NUMBER(u32, args[2], size);
 
 	if (fileio_open(&amp;fileio, args[0], FILEIO_WRITE, FILEIO_BINARY) != ERROR_OK)
 	{
@@ -2658,11 +2629,11 @@ static int handle_dump_image_command(struct command_context_s *cmd_ctx, char *cm
 
 	duration_start_measure(&amp;duration);
 
+	int retval = ERROR_OK;
 	while (size &gt; 0)
 	{
 		uint32_t size_written;
 		uint32_t this_run_size = (size &gt; 560) ? 560 : size;
-
 		retval = target_read_buffer(target, address, this_run_size, buffer);
 		if (retval != ERROR_OK)
 		{
@@ -2728,9 +2699,7 @@ static int handle_verify_image_command_internal(struct command_context_s *cmd_ct
 	if (argc &gt;= 2)
 	{
 		uint32_t addr;
-		retval = parse_u32(args[1], &amp;addr);
-		if (ERROR_OK != retval)
-			return ERROR_COMMAND_SYNTAX_ERROR;
+		COMMAND_PARSE_NUMBER(u32, args[1], addr);
 		image.base_address = addr;
 		image.base_address_set = 1;
 	}
@@ -2915,14 +2884,9 @@ static int handle_bp_command(struct command_context_s *cmd_ctx,
 	}
 
 	uint32_t addr;
-	int retval = parse_u32(args[0], &amp;addr);
-	if (ERROR_OK != retval)
-		return retval;
-
+	COMMAND_PARSE_NUMBER(u32, args[0], addr);
 	uint32_t length;
-	retval = parse_u32(args[1], &amp;length);
-	if (ERROR_OK != retval)
-		return retval;
+	COMMAND_PARSE_NUMBER(u32, args[1], length);
 
 	int hw = BKPT_SOFT;
 	if (argc == 3)
@@ -2942,9 +2906,7 @@ static int handle_rbp_command(struct command_context_s *cmd_ctx, char *cmd, char
 		return ERROR_COMMAND_SYNTAX_ERROR;
 
 	uint32_t addr;
-	int retval = parse_u32(args[0], &amp;addr);
-	if (ERROR_OK != retval)
-		return retval;
+	COMMAND_PARSE_NUMBER(u32, args[0], addr);
 
 	target_t *target = get_current_target(cmd_ctx);
 	breakpoint_remove(target, addr);
@@ -2979,19 +2941,14 @@ static int handle_wp_command(struct command_context_s *cmd_ctx, char *cmd, char
 	uint32_t length = 0;
 	uint32_t data_value = 0x0;
 	uint32_t data_mask = 0xffffffff;
-	int retval;
 
 	switch (argc)
 	{
 	case 5:
-		retval = parse_u32(args[4], &amp;data_mask);
-		if (ERROR_OK != retval)
-			return retval;
+		COMMAND_PARSE_NUMBER(u32, args[4], data_mask);
 		// fall through
 	case 4:
-		retval = parse_u32(args[3], &amp;data_value);
-		if (ERROR_OK != retval)
-			return retval;
+		COMMAND_PARSE_NUMBER(u32, args[3], data_value);
 		// fall through
 	case 3:
 		switch (args[2][0])
@@ -3011,12 +2968,8 @@ static int handle_wp_command(struct command_context_s *cmd_ctx, char *cmd, char
 		}
 		// fall through
 	case 2:
-		retval = parse_u32(args[1], &amp;length);
-		if (ERROR_OK != retval)
-			return retval;
-		retval = parse_u32(args[0], &amp;addr);
-		if (ERROR_OK != retval)
-			return retval;
+		COMMAND_PARSE_NUMBER(u32, args[1], length);
+		COMMAND_PARSE_NUMBER(u32, args[0], addr);
 		break;
 
 	default:
@@ -3025,7 +2978,7 @@ static int handle_wp_command(struct command_context_s *cmd_ctx, char *cmd, char
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	retval = watchpoint_add(target, addr, length, type,
+	int retval = watchpoint_add(target, addr, length, type,
 			data_value, data_mask);
 	if (ERROR_OK != retval)
 		LOG_ERROR(&quot;Failure setting watchpoints&quot;);
@@ -3039,9 +2992,7 @@ static int handle_rwp_command(struct command_context_s *cmd_ctx, char *cmd, char
 		return ERROR_COMMAND_SYNTAX_ERROR;
 
 	uint32_t addr;
-	int retval = parse_u32(args[0], &amp;addr);
-	if (ERROR_OK != retval)
-		return retval;
+	COMMAND_PARSE_NUMBER(u32, args[0], addr);
 
 	target_t *target = get_current_target(cmd_ctx);
 	watchpoint_remove(target, addr);
@@ -3063,13 +3014,11 @@ static int handle_virt2phys_command(command_context_t *cmd_ctx,
 		return ERROR_COMMAND_SYNTAX_ERROR;
 
 	uint32_t va;
-	int retval = parse_u32(args[0], &amp;va);
-	if (ERROR_OK != retval)
-		return retval;
+	COMMAND_PARSE_NUMBER(u32, args[0], va);
 	uint32_t pa;
 
 	target_t *target = get_current_target(cmd_ctx);
-	retval = target-&gt;type-&gt;virt2phys(target, va, &amp;pa);
+	int retval = target-&gt;type-&gt;virt2phys(target, va, &amp;pa);
 	if (retval == ERROR_OK)
 		command_print(cmd_ctx, &quot;Physical address 0x%08&quot; PRIx32 &quot;&quot;, pa);
 
@@ -3204,9 +3153,7 @@ static int handle_profile_command(struct command_context_s *cmd_ctx, char *cmd,
 		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 	unsigned offset;
-	int retval = parse_uint(args[0], &amp;offset);
-	if (ERROR_OK != retval)
-		return retval;
+	COMMAND_PARSE_NUMBER(uint, args[0], offset);
 
 	timeval_add_time(&amp;timeout, offset, 0);
 
@@ -3223,6 +3170,7 @@ static int handle_profile_command(struct command_context_s *cmd_ctx, char *cmd,
 
 	for (;;)
 	{
+		int retval;
 		target_poll(target);
 		if (target-&gt;state == TARGET_HALTED)
 		{
@@ -4726,7 +4674,7 @@ static int handle_fast_load_image_command(struct command_context_s *cmd_ctx, cha
 	duration_t duration;
 	char *duration_text;
 
-	int retval = parse_load_image_command_args(args, argc,
+	int retval = parse_load_image_command_args(cmd_ctx, args, argc,
 			&amp;image, &amp;min_address, &amp;max_address);
 	if (ERROR_OK != retval)
 		return retval;

commit b7b561aae809ab9022b9f213dc5a12b6d58ce2ee
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 21:05:50 2009 -0700

    Improve jtag command argument parsing.

diff --git a/src/jtag/amt_jtagaccel.c b/src/jtag/amt_jtagaccel.c
index b12aa76..e3f440c 100644
--- a/src/jtag/amt_jtagaccel.c
+++ b/src/jtag/amt_jtagaccel.c
@@ -534,9 +534,9 @@ static int amt_jtagaccel_handle_parport_port_command(
 		/* only if the port wasn't overwritten by cmdline */
 		if (amt_jtagaccel_port == 0)
 		{
-			int retval = parse_u16(args[0], &amp;amt_jtagaccel_port);
-			if (ERROR_OK != retval)
-				return retval;
+			uint16_t port;
+			COMMAND_PARSE_NUMBER(u16, args[0], port);
+			amt_jtagaccel_port = port;
 		}
 		else
 		{
diff --git a/src/jtag/ft2232.c b/src/jtag/ft2232.c
index bd910b3..b3389cc 100644
--- a/src/jtag/ft2232.c
+++ b/src/jtag/ft2232.c
@@ -2919,12 +2919,8 @@ static int ft2232_handle_vid_pid_command(struct command_context_s* cmd_ctx, char
 	int retval = ERROR_OK;
 	for (i = 0; i &lt; argc; i += 2)
 	{
-		retval = parse_u16(args[i], &amp;ft2232_vid[i &gt;&gt; 1]);
-		if (ERROR_OK != retval)
-			break;
-		retval = parse_u16(args[i + 1], &amp;ft2232_pid[i &gt;&gt; 1]);
-		if (ERROR_OK != retval)
-			break;
+		COMMAND_PARSE_NUMBER(u16, args[i], ft2232_vid[i &gt;&gt; 1]);
+		COMMAND_PARSE_NUMBER(u16, args[i + 1], ft2232_pid[i &gt;&gt; 1]);
 	}
 
 	/*
diff --git a/src/jtag/gw16012.c b/src/jtag/gw16012.c
index 46635d0..4b0ffd7 100644
--- a/src/jtag/gw16012.c
+++ b/src/jtag/gw16012.c
@@ -576,9 +576,7 @@ static int gw16012_handle_parport_port_command(struct command_context_s *cmd_ctx
 		/* only if the port wasn't overwritten by cmdline */
 		if (gw16012_port == 0)
 		{
-			int retval = parse_u16(args[0], &amp;gw16012_port);
-			if (ERROR_OK != retval)
-				return retval;
+			COMMAND_PARSE_NUMBER(u16, args[0], gw16012_port);
 		}
 		else
 		{
diff --git a/src/jtag/parport.c b/src/jtag/parport.c
index 41e0247..12a5eea 100644
--- a/src/jtag/parport.c
+++ b/src/jtag/parport.c
@@ -435,9 +435,7 @@ static int parport_handle_parport_port_command(struct command_context_s *cmd_ctx
 		/* only if the port wasn't overwritten by cmdline */
 		if (parport_port == 0)
 		{
-			int retval = parse_u16(args[0], &amp;parport_port);
-			if (ERROR_OK != retval)
-				return retval;
+			COMMAND_PARSE_NUMBER(u16, args[0], parport_port);
 		}
 		else
 		{
diff --git a/src/jtag/tcl.c b/src/jtag/tcl.c
index 5056a5c..c064a82 100644
--- a/src/jtag/tcl.c
+++ b/src/jtag/tcl.c
@@ -1050,9 +1050,8 @@ static int handle_jtag_nsrst_delay_command(struct command_context_s *cmd_ctx,
 	if (argc == 1)
 	{
 		unsigned delay;
-		int retval = parse_uint(args[0], &amp;delay);
-		if (ERROR_OK != retval)
-			return retval;
+		COMMAND_PARSE_NUMBER(uint, args[0], delay);
+
 		jtag_set_nsrst_delay(delay);
 	}
 	command_print(cmd_ctx, &quot;jtag_nsrst_delay: %u&quot;, jtag_get_nsrst_delay());
@@ -1067,9 +1066,8 @@ static int handle_jtag_ntrst_delay_command(struct command_context_s *cmd_ctx,
 	if (argc == 1)
 	{
 		unsigned delay;
-		int retval = parse_uint(args[0], &amp;delay);
-		if (ERROR_OK != retval)
-			return retval;
+		COMMAND_PARSE_NUMBER(uint, args[0], delay);
+
 		jtag_set_ntrst_delay(delay);
 	}
 	command_print(cmd_ctx, &quot;jtag_ntrst_delay: %u&quot;, jtag_get_ntrst_delay());
@@ -1084,9 +1082,8 @@ static int handle_jtag_nsrst_assert_width_command(struct command_context_s *cmd_
 	if (argc == 1)
 	{
 		unsigned delay;
-		int retval = parse_uint(args[0], &amp;delay);
-		if (ERROR_OK != retval)
-			return retval;
+		COMMAND_PARSE_NUMBER(uint, args[0], delay);
+
 		jtag_set_nsrst_assert_width(delay);
 	}
 	command_print(cmd_ctx, &quot;jtag_nsrst_assert_width: %u&quot;, jtag_get_nsrst_assert_width());
@@ -1101,9 +1098,8 @@ static int handle_jtag_ntrst_assert_width_command(struct command_context_s *cmd_
 	if (argc == 1)
 	{
 		unsigned delay;
-		int retval = parse_uint(args[0], &amp;delay);
-		if (ERROR_OK != retval)
-			return retval;
+		COMMAND_PARSE_NUMBER(uint, args[0], delay);
+
 		jtag_set_ntrst_assert_width(delay);
 	}
 	command_print(cmd_ctx, &quot;jtag_ntrst_assert_width: %u&quot;, jtag_get_ntrst_assert_width());
@@ -1124,11 +1120,9 @@ static int handle_jtag_speed_command(struct command_context_s *cmd_ctx, char *cm
 		LOG_DEBUG(&quot;handle jtag speed&quot;);
 
 		unsigned cur_speed = 0;
-		int retval = parse_uint(args[0], &amp;cur_speed);
-		if (ERROR_OK != retval)
-			return retval;
-		retval = jtag_config_speed(cur_speed);
+		COMMAND_PARSE_NUMBER(uint, args[0], cur_speed);
 
+		retval = jtag_config_speed(cur_speed);
 	}
 	command_print(cmd_ctx, &quot;jtag_speed: %d&quot;, jtag_get_speed());
 
@@ -1144,9 +1138,8 @@ static int handle_jtag_khz_command(struct command_context_s *cmd_ctx, char *cmd,
 	if (argc == 1)
 	{
 		unsigned khz = 0;
-		int retval = parse_uint(args[0], &amp;khz);
-		if (ERROR_OK != retval)
-			return retval;
+		COMMAND_PARSE_NUMBER(uint, args[0], khz);
+
 		retval = jtag_config_khz(khz);
 		if (ERROR_OK != retval)
 			return retval;
@@ -1174,9 +1167,8 @@ static int handle_jtag_rclk_command(struct command_context_s *cmd_ctx, char *cmd
 	if (argc == 1)
 	{
 		unsigned khz = 0;
-		int retval = parse_uint(args[0], &amp;khz);
-		if (ERROR_OK != retval)
-			return retval;
+		COMMAND_PARSE_NUMBER(uint, args[0], khz);
+
 		retval = jtag_config_rclk(khz);
 		if (ERROR_OK != retval)
 			return retval;
@@ -1231,9 +1223,7 @@ static int handle_runtest_command(struct command_context_s *cmd_ctx,
 		return ERROR_COMMAND_SYNTAX_ERROR;
 
 	unsigned num_clocks;
-	int retval = parse_uint(args[0], &amp;num_clocks);
-	if (ERROR_OK != retval)
-		return retval;
+	COMMAND_PARSE_NUMBER(uint, args[0], num_clocks);
 
 	jtag_add_runtest(num_clocks, TAP_IDLE);
 	return jtag_execute_queue();
diff --git a/src/jtag/vsllink.c b/src/jtag/vsllink.c
index ab55a19..1f1b867 100644
--- a/src/jtag/vsllink.c
+++ b/src/jtag/vsllink.c
@@ -1407,7 +1407,8 @@ static int vsllink_handle_usb_vid_command(struct command_context_s *cmd_ctx, cha
 		return ERROR_OK;
 	}
 
-	return parse_u16(args[0], &amp;vsllink_usb_vid);
+	COMMAND_PARSE_NUMBER(u16, args[0], vsllink_usb_vid);
+	return ERROR_OK;
 }
 
 static int vsllink_handle_usb_pid_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
@@ -1417,7 +1418,8 @@ static int vsllink_handle_usb_pid_command(struct command_context_s *cmd_ctx, cha
 		LOG_ERROR(&quot;parameter error, should be one parameter for PID&quot;);
 		return ERROR_OK;
 	}
-	return parse_u16(args[0], &amp;vsllink_usb_pid);
+	COMMAND_PARSE_NUMBER(u16, args[0], vsllink_usb_pid);
+	return ERROR_OK;
 }
 
 static int vsllink_handle_usb_bulkin_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
@@ -1428,11 +1430,11 @@ static int vsllink_handle_usb_bulkin_command(struct command_context_s *cmd_ctx,
 		return ERROR_OK;
 	}
 
-	int retval = parse_u8(args[0], &amp;vsllink_usb_bulkin);
-	if (ERROR_OK == retval)
-		vsllink_usb_bulkin |= 0x80;
+	COMMAND_PARSE_NUMBER(u8, args[0], vsllink_usb_bulkin);
 
-	return retval;
+	vsllink_usb_bulkin |= 0x80;
+
+	return ERROR_OK;
 }
 
 static int vsllink_handle_usb_bulkout_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
@@ -1443,11 +1445,11 @@ static int vsllink_handle_usb_bulkout_command(struct command_context_s *cmd_ctx,
 		return ERROR_OK;
 	}
 
-	int retval = parse_u8(args[0], &amp;vsllink_usb_bulkout);
-	if (ERROR_OK == retval)
-		vsllink_usb_bulkout &amp;= ~0x80;
+	COMMAND_PARSE_NUMBER(u8, args[0], vsllink_usb_bulkin);
 
-	return retval;
+	vsllink_usb_bulkout &amp;= ~0x80;
+
+	return ERROR_OK;
 }
 
 static int vsllink_handle_usb_interface_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
@@ -1458,7 +1460,8 @@ static int vsllink_handle_usb_interface_command(struct command_context_s *cmd_ct
 		return ERROR_OK;
 	}
 
-	return parse_u8(args[0], &amp;vsllink_usb_interface);
+	COMMAND_PARSE_NUMBER(u8, args[0], vsllink_usb_interface);
+	return ERROR_OK;
 }
 
 /***************************************************************************/

commit f6f1dbfafdfac93d8f9a9540c71f011fac7611e0
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 22:34:19 2009 -0700

    Improve debug_level command argument parsing.

diff --git a/src/helper/log.c b/src/helper/log.c
index f68c9a3..a8b519a 100644
--- a/src/helper/log.c
+++ b/src/helper/log.c
@@ -279,9 +279,7 @@ int handle_debug_level_command(struct command_context_s *cmd_ctx, char *cmd, cha
 	if (argc == 1)
 	{
 		unsigned new_level;
-		int retval = parse_uint(args[0], &amp;new_level);
-		if (ERROR_OK != retval)
-			return retval;
+		COMMAND_PARSE_NUMBER(uint, args[0], new_level);
 		debug_level = MIN(new_level, LOG_LVL_DEBUG);
 	}
 	else if (argc &gt; 1)

commit 36a3646c2205474345482188c8c05e50d1f67e44
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 07:44:54 2009 -0700

    Add macro for parsing numeric command arguments.
    
    This helper eliminates significant amount of redundant code in command
    handler functions throughout the system.  It wraps the lower-level
    parse_* macros to implement a policy for reporting parse errors to the
    active command context (cmd_ctx).  If errors do occur, this macro causes
    the calling function to abort with the proper return code.

diff --git a/src/helper/command.h b/src/helper/command.h
index ba825bc..2d0142f 100644
--- a/src/helper/command.h
+++ b/src/helper/command.h
@@ -138,6 +138,27 @@ DECLARE_PARSE_WRAPPER(_s32, int32_t);
 DECLARE_PARSE_WRAPPER(_s16, int16_t);
 DECLARE_PARSE_WRAPPER(_s8, int8_t);
 
+/**
+ * @brief parses the string @a in into @a out as a @a type, or prints
+ * a command error and passes the error code to the caller.  If an error
+ * does occur, the calling function will return the error code produced
+ * by the parsing function (one of ERROR_COMMAND_ARGUMENT_*).
+ *
+ * This function may cause the calling function to return immediately,
+ * so it should be used carefully to avoid leaking resources.  In most
+ * situations, parsing should be completed in full before proceding
+ * to allocate resources, and this strategy will most prevents leaks.
+ */
+#define COMMAND_PARSE_NUMBER(type, in, out) \
+	do { \
+		int retval = parse_##type(in, &amp;(out)); \
+		if (ERROR_OK != retval) { \
+			command_print(cmd_ctx, stringify(out) \
+				&quot; option value ('%s') is not valid&quot;, in); \
+			return retval; \
+		} \
+	} while (0)
+
 void script_debug(Jim_Interp *interp, const char *cmd, int argc, Jim_Obj *const *argv);
 
 #endif /* COMMAND_H */

commit 68785af4da7727238c86dcf8858e0b5975bc988e
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Thu Oct 22 07:39:23 2009 -0700

    Add stringify macros in src/helper/types.h.

diff --git a/src/helper/types.h b/src/helper/types.h
index eb836c2..50f5fe2 100644
--- a/src/helper/types.h
+++ b/src/helper/types.h
@@ -56,6 +56,10 @@ typedef bool _Bool;
 
 #endif	/* HAVE_STDBOOL_H */
 
+/// turns a macro argument into a string constant
+#define stringify(s) __stringify(s)
+#define __stringify(s) #s
+
 /* DANGER!!!! here be dragons!
  *
  * Leave these fn's as byte accesses because it is safe

-----------------------------------------------------------------------

Summary of changes:
 src/flash/at91sam3.c                |   17 +--
 src/flash/at91sam7.c                |   44 +++++----
 src/flash/avrf.c                    |   11 +--
 src/flash/cfi.c                     |    8 +-
 src/flash/davinci_nand.c            |    9 +-
 src/flash/flash.c                   |  136 +++++++++++++-------------
 src/flash/flash.h                   |   10 ++
 src/flash/lpc2000.c                 |   13 +--
 src/flash/lpc288x.c                 |    2 +-
 src/flash/lpc2900.c                 |   89 +++++++----------
 src/flash/lpc3180_nand_controller.c |   25 +++--
 src/flash/mflash.c                  |   15 ++-
 src/flash/nand.c                    |  138 +++++++++++++--------------
 src/flash/nand.h                    |    5 +
 src/flash/orion_nand.c              |    2 +-
 src/flash/pic32mx.c                 |   49 ++++------
 src/flash/stellaris.c               |   11 +--
 src/flash/stm32x.c                  |   55 ++++-------
 src/flash/str7x.c                   |   21 ++---
 src/flash/str9x.c                   |   25 +++--
 src/flash/str9xpec.c                |  124 +++++++++----------------
 src/helper/command.h                |   21 ++++
 src/helper/log.c                    |    4 +-
 src/helper/types.h                  |    4 +
 src/jtag/amt_jtagaccel.c            |    6 +-
 src/jtag/ft2232.c                   |    8 +-
 src/jtag/gw16012.c                  |    4 +-
 src/jtag/parport.c                  |    4 +-
 src/jtag/tcl.c                      |   40 +++-----
 src/jtag/vsllink.c                  |   25 +++--
 src/pld/pld.c                       |   13 ++-
 src/pld/virtex2.c                   |    4 +-
 src/server/gdb_server.c             |   10 +--
 src/server/server.c                 |   20 ++++
 src/server/server.h                 |    3 +
 src/server/tcl_server.c             |    8 +-
 src/server/telnet_server.c          |   10 +--
 src/target/arm11.c                  |   14 ++--
 src/target/arm720t.c                |    7 +-
 src/target/arm7_9_common.c          |   16 ++--
 src/target/arm920t.c                |   18 +++-
 src/target/arm926ejs.c              |   11 +-
 src/target/arm966e.c                |    6 +-
 src/target/arm_adi_v5.c             |   57 ++++++++---
 src/target/armv4_5.c                |    4 +-
 src/target/armv7a.c                 |   17 +++-
 src/target/armv7m.c                 |   31 ++++--
 src/target/cortex_m3.c              |    8 +-
 src/target/etm.c                    |  179 ++++++++++++++++++-----------------
 src/target/target.c                 |  124 +++++++-----------------
 src/target/trace.c                  |    6 +-
 src/target/xscale.c                 |   24 +++---
 52 files changed, 733 insertions(+), 782 deletions(-)


hooks/post-receive
-- 
Main OpenOCD repository

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001729.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-23-g0f3117c
</A></li>
	<LI>Next message: <A HREF="001731.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-74-gb7e4c26
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1730">[ date ]</a>
              <a href="thread.html#1730">[ thread ]</a>
              <a href="subject.html#1730">[ subject ]</a>
              <a href="author.html#1730">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openocd-svn">More information about the openocd-svn
mailing list</a><br>
</body></html>
