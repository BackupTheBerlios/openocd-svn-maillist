<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-183-gebbc762
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openocd-svn/2009-November/index.html" >
   <LINK REL="made" HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.3.0-183-gebbc762&In-Reply-To=%3CE1N91Qg-0001MO-L6%40cj8yhf1.ch3.sourceforge.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001773.html">
   <LINK REL="Next"  HREF="001775.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-183-gebbc762</H1>
    <B>Zach Welch</B> 
    <A HREF="mailto:openocd-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenocd-svn%5D%20Main%20OpenOCD%20repository%20branch%2C%20master%2C%0A%09updated.%20v0.3.0-183-gebbc762&In-Reply-To=%3CE1N91Qg-0001MO-L6%40cj8yhf1.ch3.sourceforge.com%3E"
       TITLE="[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-183-gebbc762">zwelch at users.sourceforge.net
       </A><BR>
    <I>Fri Nov 13 20:03:29 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001773.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-164-g5eb638c
</A></li>
        <LI>Next message: <A HREF="001775.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-184-g99b57b6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1774">[ date ]</a>
              <a href="thread.html#1774">[ thread ]</a>
              <a href="subject.html#1774">[ subject ]</a>
              <a href="author.html#1774">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;Main OpenOCD repository&quot;.

The branch, master has been updated
       via  ebbc762182c943d5967ea106933181a2fb726b1b (commit)
       via  89870c86e7aafd81a5720fcfd30002d24d26b232 (commit)
       via  f973320cbb98d661bc0e4ba4fa9939ce8bce2b83 (commit)
       via  deede35c270b078ae63713cfc12aa2bbc9eb78a7 (commit)
       via  cc63d6e72b49dd01706c4d768c1f9bb91db2ae1d (commit)
       via  d22270e0ed291d3b08fd03a25181b279ca5e0911 (commit)
       via  a585bdf7269ce5c861c83ee3294ba1f074e9c877 (commit)
       via  5b6df55a1e5e4c0f531bc336691bc7c9a6a0df87 (commit)
       via  1df5cc18f51366b823bccdaec4ffa1ee3fac2447 (commit)
       via  670f999e7a1ec04cda599a5487de068379e36f0e (commit)
       via  0796dfff89bf00f82a780d7719767bcffe881d67 (commit)
       via  57c5c5f46304a785092874a7dc0f6abc84794cc3 (commit)
       via  76868e071306bc83d25b89e57b785fef4637c4c8 (commit)
       via  d02fee197f62331e36e9de110040f0170341c3e8 (commit)
       via  63a26b421b1731df5826a157ea633b9d2c02aaee (commit)
       via  cfc4d5c6b7b6f8f82dc5bbf3ee661c179814666e (commit)
       via  ddb6138ed428f666064d26bb08036de3afe44bc8 (commit)
       via  3f9fd4e2a6ab7b3ce3819c385c34cf6f4630763c (commit)
       via  1ae4d93c3c90f176f6b94579ba3fabe1e17d715e (commit)
      from  5eb638c71e95048b090b8a19640d7d4902c07902 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit ebbc762182c943d5967ea106933181a2fb726b1b
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Wed Nov 11 01:31:34 2009 -0800

    add documention for writing built-in commands
    
    This documentation update provides an introduction to the command
    handling facilities provided by command.[ch].  A primer walks the user
    through the elements of a pointedly pedantic module: src/hello.c.
    
    A summary of the API is provided in the OpenOCD Architecture section.

diff --git a/doc/manual/helper.txt b/doc/manual/helper.txt
index 91bf2d5..7060607 100644
--- a/doc/manual/helper.txt
+++ b/doc/manual/helper.txt
@@ -31,7 +31,63 @@ This section needs to be expanded to describe OpenOCD's Jim API.
 
 /** @page helpercommand OpenOCD Command API
 
-This section needs to be expanded to describe OpenOCD's Command API.
+OpenOCD's command API allows modules to register callbacks that are then
+available to the scripting services.  It provides the mechanism for
+these commands to be dispatched to the modlue using a standard
+interfaces.  It provides macros for defining functions that use and
+extend this interface.
+
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at section</A> helpercmdhandler Command Handlers
+
+Command handlers are functions with a particular signature, which can
+be extended by modules for passing additional parameters to helpers or
+another layer of handlers.
+
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at subsection</A> helpercmdhandlerdef Defining and Calling Command Handlers
+
+These functions should be defined using the COMMAND_HANDLER macro.
+These methods must be defined as static, as their principle entry point
+should be the run_command dispatch mechanism.
+
+Command helper functions that require access to the full set of
+parameters should be defined using the COMMAND_HELPER.  These must be
+declared static by you, as sometimes you might want to share a helper
+among several files (e.g. s3c24xx_nand.h).
+
+Both types of routines must be called using the CALL_COMMAND_HANDLER macro.
+Calls using this macro to normal handlers require the name of the command
+handler (which can a name or function pointer).  Calls to helpers and
+derived handlers must pass those extra parameters specified by their
+definitions; however, lexical capture is used for the core parameters.
+This dirty trick is being used as a stop-gap measure while the API is
+migrated to one that passes a pointer to a structure containing the
+same ingredients.  At that point, this macro will be removed and callers
+will be able to use direct invocations.
+
+Thus, the following macros can be used to define and call command
+handlers or helpers:
+
+- COMMAND_HANDLER - declare or define a command handler.
+- COMMAND_HELPER - declare or define a derived command handler or helper.
+- CALL_COMMAND_COMMAND - call a command handler/helper.
+
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at subsection</A> helpercmdhandlerparam Command Handler Parameters
+
+The following parameters are defined in the scope of all command
+handlers and helpers:
+- &lt;code&gt;struct command_context_s *cmd_ctx&lt;/code&gt; - the command's context
+- &lt;code&gt;unsigned argc&lt;/code&gt; - the number of command arguments
+- &lt;code&gt;const char *args[]&lt;/code&gt; - contains the command arguments
+
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at subsection</A> helpercmdhandlermacros Command Handler Macros
+
+In addition, the following macro may be used:
+- &lt;code&gt;COMMAND_NAME&lt;/code&gt; - contains the command name
+
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at section</A> helpercmdprimer Command Development Primer
+
+This @ref primercommand provides details about the @c hello module,
+showing how the pieces desrcribed on this page fit together.
 
  */
 
diff --git a/doc/manual/main.txt b/doc/manual/main.txt
index b9430b6..8e76464 100644
--- a/doc/manual/main.txt
+++ b/doc/manual/main.txt
@@ -42,11 +42,17 @@ associated with the fundamental technologies used by OpenOCD.
 - @subpage primertcl
 - @subpage primerjtag
 
-These documents should bridge any &quot;ancillary&quot; gaps in contributor
+The above documents should bridge any &quot;ancillary&quot; gaps in contributor
 knowledge, without having to learn the complete languages or technology.
 They should provide enough information for experienced developers to
 learn how to make &quot;correct&quot; changes when creating patches.
 
+Beyond the fundamentals, the following primers provide introductory
+tutorials for OpenOCD's sub-systems.  These complement the @ref oocd
+pages that provide more high-level perspective on related topics.
+
+- @subpage primercommand
+
 In all cases, these Primers should use idiomatic conventions that the
 community has agreed are the &quot;right way of doing things&quot;.  In this
 respect, these documents typically assume some familiarity with the
diff --git a/doc/manual/primer/commands.txt b/doc/manual/primer/commands.txt
new file mode 100644
index 0000000..9efcca2
--- /dev/null
+++ b/doc/manual/primer/commands.txt
@@ -0,0 +1,99 @@
+/** @page primercommand Command Development Primer
+
+This page provides a primer for writing commands by introducing @c hello
+module.  The full source code used in this example can be found in
+hello.c, and the @ref primercmdcode section shows how to use it.
+
+A summary of this information can be found in @ref helpercommand .
+
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at section</A> primercmdhandler Command Handlers
+
+Defining new commands and their helpers is easy.  The following code
+defines a simple command handler that delegates its argument parsing:
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at code</A>
+COMMAND_HANDLER(handle_hello_command)
+{
+	const char *sep, *name;
+	int retval = CALL_COMMAND_HANDLER(handle_hello_args);
+	if (ERROR_OK == retval)
+		command_print(cmd_ctx, &quot;Greetings%s%s!&quot;, sep, name);
+	return retval;
+}
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at endcode</A>
+
+Here, the @c COMMAND_HANDLER macro establishes the function signature,
+see in command.h by the @c __COMMAND_HANDLER macro.
+
+The COMMAND_HELPER macro function allows defining functions with an
+extended version of the base signature.  These helper functions can be
+called (with the appropriate parameters), the @c CALL_COMMAND_HANDLER
+macro to pass any e as parameters to the following helper function:
+
+The subsequent blocks of code are a normal C function that can do
+anything, so only complex commands deserve should use comamnd helper
+functions.  In this respect, this example uses one to demonstrate how --
+not when -- they should be used.
+
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at code</A>
+static COMMAND_HELPER(handle_hello_args, const char **sep, const char **name)
+{
+	if (argc &gt; 1)
+	{
+		LOG_ERROR(&quot;%s: too many arguments&quot;, COMMAND_NAME);
+		return ERROR_COMMAND_SYNTAX_ERROR;
+	}
+	if (1 == argc)
+	{
+		*sep = &quot;, &quot;;
+		*name = args[0];
+	}
+	else
+		*sep = *name = &quot;&quot;;
+
+	return ERROR_OK;
+}
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at endcode</A>
+
+Of course, you may also call other macros or functions, but that extends
+beyond the scope of this tutorial on writing commands. 
+
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at section</A> primercmdreg Command Registration
+
+Before this new function can be used, it must be registered somehow.
+For a new module, registering should be done in a new function for
+the purpose, which must be called from @c openocd.c:
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at code</A>
+int hello_register_commands(struct command_context_s *cmd_ctx)
+{
+	struct command_s *cmd = register_command(cmd_ctx, NULL, &quot;hello&quot;,
+			NULL, COMMAND_ANY, &quot;print greetings&quot;);
+	return cmd ? ERROR_OK : -ENOMEM;
+}
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at endcode</A>
+
+That's it!  The command should now be registered and avaiable to scripts.
+
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at section</A> primercmdcode Trying These Example Commands
+
+The commands may be enabled by editing src/openocd.c and uncommenting
+the call to @c hello_register_commands and rebuilding the source tree.
+
+Once OpenOCD has been built with this example code, the following script
+demonstrate the abilities that the @c hello module provides:
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at code</A>
+hello
+hello World
+hello {John Doe}
+hello John Doe  # error: too many arguments
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at endcode</A>
+
+If saved in @c hello.cfg, then running &lt;code&gt;openocd -f hello.cfg&lt;/code&gt;
+should produce the following output before exiting:
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at code</A>
+Greetings!
+Greetings, World!
+Greetings, John Doe!
+Error: ocd_hello: too many arguments
<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">+ at endcode</A>
+
+ */

commit 89870c86e7aafd81a5720fcfd30002d24d26b232
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Wed Nov 11 01:20:49 2009 -0800

    add src/hello.c to augment new command tutorial
    
    The hello module provides the 'hello' command, printing a greetings
    to the command console.  It can grow to serve as pedagogical example
    of services that OpenOCD developers should use: a runnable style guide.

diff --git a/src/Makefile.am b/src/Makefile.am
index 6717910..7721f34 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -12,7 +12,9 @@ endif
 openocd_SOURCES = $(MAINFILE)
 openocd_LDADD = libopenocd.la
 
-libopenocd_la_SOURCES = openocd.c
+libopenocd_la_SOURCES = \
+	hello.c \
+	openocd.c
 
 # set the include path found by configure
 AM_CPPFLAGS = \
diff --git a/src/hello.c b/src/hello.c
new file mode 100644
index 0000000..8a4f701
--- /dev/null
+++ b/src/hello.c
@@ -0,0 +1,57 @@
+/***************************************************************************
+ *   Copyright (C) 2009 Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;             *
+ *                                                                         *
+ *   This program is free software; you can redistribute it and/or modify  *
+ *   it under the terms of the GNU General Public License as published by  *
+ *   the Free Software Foundation; either version 2 of the License, or     *
+ *   (at your option) any later version.                                   *
+ *                                                                         *
+ *   This program is distributed in the hope that it will be useful,       *
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
+ *   GNU General Public License for more details.                          *
+ *                                                                         *
+ *   You should have received a copy of the GNU General Public License     *
+ *   along with this program; if not, write to the                         *
+ *   Free Software Foundation, Inc.,                                       *
+ *   59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             *
+ ***************************************************************************/
+
+#ifdef HAVE_CONFIG_H
+#include &lt;config.h&gt;
+#endif
+#include &quot;log.h&quot;
+
+static COMMAND_HELPER(handle_hello_args, const char **sep, const char **name)
+{
+	if (argc &gt; 1)
+	{
+		LOG_ERROR(&quot;%s: too many arguments&quot;, CMD_NAME);
+		return ERROR_COMMAND_SYNTAX_ERROR;
+	}
+	if (1 == argc)
+	{
+		*sep = &quot; &quot;;
+		*name = args[0];
+	}
+	else
+		*sep = *name = &quot;&quot;;
+
+	return ERROR_OK;
+}
+COMMAND_HANDLER(handle_hello_command)
+{
+	const char *sep, *name;
+	int retval = CALL_COMMAND_HANDLER(handle_hello_args, &amp;sep, &amp;name);
+	if (ERROR_OK == retval)
+		command_print(cmd_ctx, &quot;Greetings%s%s!&quot;, sep, name);
+	return retval;
+}
+
+int hello_register_commands(struct command_context_s *cmd_ctx)
+{
+	struct command_s *cmd = register_command(cmd_ctx, NULL, &quot;hello&quot;,
+			&amp;handle_hello_command, COMMAND_ANY,
+			&quot;option&quot;);
+	return cmd ? ERROR_OK : -ENOMEM;
+}
diff --git a/src/openocd.c b/src/openocd.c
index 2a74a46..d67ebd5 100644
--- a/src/openocd.c
+++ b/src/openocd.c
@@ -177,6 +177,9 @@ COMMAND_HANDLER(handle_init_command)
 
 command_context_t *global_cmd_ctx;
 
+/// src/hello.c gives a simple example for writing new command modules
+int hello_register_commands(struct command_context_s *cmd_ctx);
+
 /* NB! this fn can be invoked outside this file for non PC hosted builds */
 command_context_t *setup_command_handler(void)
 {
@@ -188,6 +191,7 @@ command_context_t *setup_command_handler(void)
 					 COMMAND_EXEC, &quot;show OpenOCD version&quot;);
 
 	/* register subsystem commands */
+	hello_register_commands(cmd_ctx);
 	server_register_commands(cmd_ctx);
 	telnet_register_commands(cmd_ctx);
 	gdb_register_commands(cmd_ctx);

commit f973320cbb98d661bc0e4ba4fa9939ce8bce2b83
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 23:01:44 2009 -0800

    command_handler_t: make cmd an indirect parameter
    
    This patch removes 'cmd' from the list of direct parameters, moving
    that pointer to args[-1] (by way of the new CMD_NAME macro).

diff --git a/src/helper/command.c b/src/helper/command.c
index 7a42ab2..3cd11d2 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -102,7 +102,8 @@ static int script_command(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 
 	script_debug(interp, c-&gt;name, argc, argv);
 
-	words = malloc(sizeof(char *) * argc);
+	words = malloc(sizeof(char *) * (argc + 1));
+	words[0] = c-&gt;name;
 	for (i = 0; i &lt; argc; i++)
 	{
 		int len;
@@ -112,12 +113,12 @@ static int script_command(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 			/* hit an end of line comment */
 			break;
 		}
-		words[i] = strdup(w);
-		if (words[i] == NULL)
+		words[i + 1] = strdup(w);
+		if (words[i + 1] == NULL)
 		{
 			int j;
 			for (j = 0; j &lt; i; j++)
-				free(words[j]);
+				free(words[j + 1]);
 			free(words);
 			return JIM_ERR;
 		}
@@ -141,7 +142,8 @@ static int script_command(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 
 	log_add_callback(tcl_output, tclOutput);
 
-	retval = run_command(context, c, (const char **)words, nwords);
+	// turn words[0] into args[-1] with this cast
+	retval = run_command(context, c, (const char **)words + 1, nwords);
 
 	log_remove_callback(tcl_output, tclOutput);
 
@@ -150,7 +152,7 @@ static int script_command(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 	Jim_DecrRefCount(interp, tclOutput);
 
 	for (i = 0; i &lt; nwords; i++)
-		free(words[i]);
+		free(words[i + 1]);
 	free(words);
 
 	int *return_retval = Jim_GetAssocData(interp, &quot;retval&quot;);
@@ -447,7 +449,7 @@ static int run_command(command_context_t *context,
 
 	unsigned argc = num_words - start_word - 1;
 	const char **args = words + start_word + 1;
-	int retval = c-&gt;handler(context, c-&gt;name, args, argc);
+	int retval = c-&gt;handler(context, args, argc);
 	if (retval == ERROR_COMMAND_SYNTAX_ERROR)
 	{
 		/* Print help for command */
diff --git a/src/helper/command.h b/src/helper/command.h
index fbcc0aa..bddb053 100644
--- a/src/helper/command.h
+++ b/src/helper/command.h
@@ -88,7 +88,7 @@ typedef struct command_context_s
  */
 #define __COMMAND_HANDLER(name, extra...) \
 		int name(struct command_context_s *cmd_ctx, \
-				const char *cmd, const char *args[], unsigned argc, ##extra)
+				const char *args[], unsigned argc, ##extra)
 
 /**
  * Use this to macro to call a command helper (or a nested handler).
@@ -104,7 +104,7 @@ typedef struct command_context_s
  * variables in intervening scope(s) by accident.
  */
 #define CALL_COMMAND_HANDLER(name, extra...) \
-		name(cmd_ctx, cmd, args, argc, ##extra)
+		name(cmd_ctx, args, argc, ##extra)
 
 /**
  * Always use this macro to define new command handler functions.
@@ -125,7 +125,7 @@ typedef struct command_context_s
  * Use this macro to access the name of the command being handled,
  * rather than accessing the variable directly.  It may be moved.
  */
-#define CMD_NAME cmd
+#define CMD_NAME args[-1]
 
 
 /// The type signature for commands' handler functions.

commit deede35c270b078ae63713cfc12aa2bbc9eb78a7
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 04:37:17 2009 -0800

    command_handler_t: make args parameter const
    
    This patch prevents command handlers from modifying the strings passed
    in the 'args' array.

diff --git a/src/helper/command.c b/src/helper/command.c
index 4ce5085..7a42ab2 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -48,7 +48,7 @@ int fast_and_dangerous = 0;
 Jim_Interp *interp = NULL;
 
 static int run_command(command_context_t *context,
-		command_t *c, char *words[], unsigned num_words);
+		command_t *c, const char *words[], unsigned num_words);
 
 static void tcl_output(void *privData, const char *file, unsigned line,
 		const char *function, const char *string)
@@ -141,7 +141,7 @@ static int script_command(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 
 	log_add_callback(tcl_output, tclOutput);
 
-	retval = run_command(context, c, words, nwords);
+	retval = run_command(context, c, (const char **)words, nwords);
 
 	log_remove_callback(tcl_output, tclOutput);
 
@@ -435,7 +435,7 @@ char *command_name(struct command_s *c, char delim)
 }
 
 static int run_command(command_context_t *context,
-		command_t *c, char *words[], unsigned num_words)
+		command_t *c, const char *words[], unsigned num_words)
 {
 	int start_word = 0;
 	if (!((context-&gt;mode == COMMAND_CONFIG) || (c-&gt;mode == COMMAND_ANY) || (c-&gt;mode == context-&gt;mode)))
@@ -445,7 +445,9 @@ static int run_command(command_context_t *context,
 		return ERROR_FAIL;
 	}
 
-	int retval = c-&gt;handler(context, c-&gt;name, words + start_word + 1, num_words - start_word - 1);
+	unsigned argc = num_words - start_word - 1;
+	const char **args = words + start_word + 1;
+	int retval = c-&gt;handler(context, c-&gt;name, args, argc);
 	if (retval == ERROR_COMMAND_SYNTAX_ERROR)
 	{
 		/* Print help for command */
diff --git a/src/helper/command.h b/src/helper/command.h
index 18664d2..fbcc0aa 100644
--- a/src/helper/command.h
+++ b/src/helper/command.h
@@ -88,7 +88,7 @@ typedef struct command_context_s
  */
 #define __COMMAND_HANDLER(name, extra...) \
 		int name(struct command_context_s *cmd_ctx, \
-				const char *cmd, char **args, unsigned argc, ##extra)
+				const char *cmd, const char *args[], unsigned argc, ##extra)
 
 /**
  * Use this to macro to call a command helper (or a nested handler).

commit cc63d6e72b49dd01706c4d768c1f9bb91db2ae1d
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 00:10:25 2009 -0800

    command_handler_t: make cmd parameter const
    
    Prevents the command name from being modified in command handlers.
    Again, this has cascading effects, but the patches are fairly minimal.

diff --git a/src/helper/command.h b/src/helper/command.h
index 5577315..18664d2 100644
--- a/src/helper/command.h
+++ b/src/helper/command.h
@@ -88,7 +88,7 @@ typedef struct command_context_s
  */
 #define __COMMAND_HANDLER(name, extra...) \
 		int name(struct command_context_s *cmd_ctx, \
-				char *cmd, char **args, unsigned argc, ##extra)
+				const char *cmd, char **args, unsigned argc, ##extra)
 
 /**
  * Use this to macro to call a command helper (or a nested handler).

commit d22270e0ed291d3b08fd03a25181b279ca5e0911
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 00:02:18 2009 -0800

    command_handler_t: make argc unsigned
    
    The number of command arguments will always be 0 or more, so use
    the right type in handlers.  This has a cascading effect up through
    the layers, but the new COMMAND_HANDLER macros prevented total chaos.

diff --git a/src/flash/cfi.c b/src/flash/cfi.c
index 08c4358..88f57df 100644
--- a/src/flash/cfi.c
+++ b/src/flash/cfi.c
@@ -604,9 +604,6 @@ static int cfi_register_commands(struct command_context_s *cmd_ctx)
 FLASH_BANK_COMMAND_HANDLER(cfi_flash_bank_command)
 {
 	cfi_flash_bank_t *cfi_info;
-	int i;
-	(void) cmd_ctx;
-	(void) cmd;
 
 	if (argc &lt; 6)
 	{
@@ -635,7 +632,7 @@ FLASH_BANK_COMMAND_HANDLER(cfi_flash_bank_command)
 	cfi_info-&gt;jedec_probe = 0;
 	cfi_info-&gt;not_cfi = 0;
 
-	for (i = 6; i &lt; argc; i++)
+	for (unsigned i = 6; i &lt; argc; i++)
 	{
 		if (strcmp(args[i], &quot;x16_as_x8&quot;) == 0)
 		{
diff --git a/src/flash/nand.c b/src/flash/nand.c
index 88d3e42..26eb63a 100644
--- a/src/flash/nand.c
+++ b/src/flash/nand.c
@@ -1315,8 +1315,7 @@ COMMAND_HANDLER(handle_nand_write_command)
 
 	if (argc &gt; 3)
 	{
-		int i;
-		for (i = 3; i &lt; argc; i++)
+		for (unsigned i = 3; i &lt; argc; i++)
 		{
 			if (!strcmp(args[i], &quot;oob_raw&quot;))
 				oob_format |= NAND_OOB_RAW;
@@ -1485,8 +1484,7 @@ COMMAND_HANDLER(handle_nand_dump_command)
 
 	if (argc &gt; 4)
 	{
-		int i;
-		for (i = 4; i &lt; argc; i++)
+		for (unsigned i = 4; i &lt; argc; i++)
 		{
 			if (!strcmp(args[i], &quot;oob_raw&quot;))
 				oob_format |= NAND_OOB_RAW;
diff --git a/src/helper/command.h b/src/helper/command.h
index 74c6f36..5577315 100644
--- a/src/helper/command.h
+++ b/src/helper/command.h
@@ -88,7 +88,7 @@ typedef struct command_context_s
  */
 #define __COMMAND_HANDLER(name, extra...) \
 		int name(struct command_context_s *cmd_ctx, \
-				char *cmd, char **args, int argc, ##extra)
+				char *cmd, char **args, unsigned argc, ##extra)
 
 /**
  * Use this to macro to call a command helper (or a nested handler).
diff --git a/src/helper/ioutil.c b/src/helper/ioutil.c
index 1423462..3a62961 100644
--- a/src/helper/ioutil.c
+++ b/src/helper/ioutil.c
@@ -214,9 +214,9 @@ COMMAND_HANDLER(handle_append_command)
 	config_file = fopen(args[0], &quot;a&quot;);
 	if (config_file != NULL)
 	{
-		int i;
 		fseek(config_file, 0, SEEK_END);
 
+		unsigned i;
 		for (i = 1; i &lt; argc; i++)
 		{
 			if (fwrite(args[i], 1, strlen(args[i]), config_file) != strlen(args[i]))
diff --git a/src/jtag/ft2232.c b/src/jtag/ft2232.c
index 6d23356..39036bc 100644
--- a/src/jtag/ft2232.c
+++ b/src/jtag/ft2232.c
@@ -2874,8 +2874,7 @@ COMMAND_HANDLER(ft2232_handle_vid_pid_command)
 		argc -= 1;
 	}
 
-	int i;
-	int retval = ERROR_OK;
+	unsigned i;
 	for (i = 0; i &lt; argc; i += 2)
 	{
 		COMMAND_PARSE_NUMBER(u16, args[i], ft2232_vid[i &gt;&gt; 1]);
@@ -2888,7 +2887,7 @@ COMMAND_HANDLER(ft2232_handle_vid_pid_command)
 	 */
 	ft2232_vid[i &gt;&gt; 1] = ft2232_pid[i &gt;&gt; 1] = 0;
 
-	return retval;
+	return ERROR_OK;
 }
 
 COMMAND_HANDLER(ft2232_handle_latency_command)
diff --git a/src/svf/svf.c b/src/svf/svf.c
index 76b0670..8f2ee80 100644
--- a/src/svf/svf.c
+++ b/src/svf/svf.c
@@ -304,7 +304,7 @@ int svf_add_statemove(tap_state_t state_to)
 COMMAND_HANDLER(handle_svf_command)
 {
 #define SVF_NUM_OF_OPTIONS			1
-	int command_num = 0, i;
+	int command_num = 0;
 	int ret = ERROR_OK;
 	long long time_ago;
 
@@ -316,7 +316,7 @@ COMMAND_HANDLER(handle_svf_command)
 
 	// parse variant
 	svf_quiet = 0;
-	for (i = 1; i &lt; argc; i++)
+	for (unsigned i = 1; i &lt; argc; i++)
 	{
 		if (!strcmp(args[i], &quot;quiet&quot;))
 		{
diff --git a/src/target/arm9tdmi.c b/src/target/arm9tdmi.c
index 112ec2a..416fe79 100644
--- a/src/target/arm9tdmi.c
+++ b/src/target/arm9tdmi.c
@@ -862,7 +862,6 @@ COMMAND_HANDLER(handle_arm9tdmi_catch_vectors_command)
 	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
 	reg_t *vector_catch;
 	uint32_t vector_catch_value;
-	int i, j;
 
 	/* it's uncommon, but some ARM7 chips can support this */
 	if (arm7_9-&gt;common_magic != ARM7_9_COMMON_MAGIC
@@ -894,9 +893,10 @@ COMMAND_HANDLER(handle_arm9tdmi_catch_vectors_command)
 		}
 		else
 		{
-			for (i = 0; i &lt; argc; i++)
+			for (unsigned i = 0; i &lt; argc; i++)
 			{
 				/* go through list of vectors */
+				unsigned j;
 				for (j = 0; arm9tdmi_vectors[j].name; j++)
 				{
 					if (strcmp(args[i], arm9tdmi_vectors[j].name) == 0)
@@ -927,7 +927,7 @@ COMMAND_HANDLER(handle_arm9tdmi_catch_vectors_command)
 	}
 
 	/* output current settings */
-	for (i = 0; arm9tdmi_vectors[i].name; i++) {
+	for (unsigned i = 0; arm9tdmi_vectors[i].name; i++) {
 		command_print(cmd_ctx, &quot;%s: %s&quot;, arm9tdmi_vectors[i].name,
 			(vector_catch_value &amp; arm9tdmi_vectors[i].value)
 				? &quot;catch&quot; : &quot;don't catch&quot;);

commit a585bdf7269ce5c861c83ee3294ba1f074e9c877
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 22:29:36 2009 -0800

    add CMD_NAME macro for command handlers
    
    By introducing the CMD_NAME macro, this parameter may be integrated
    as args[-1] in command.[ch], without touching any other call sites.

diff --git a/src/flash/flash.c b/src/flash/flash.c
index da43e1a..f3f0086 100644
--- a/src/flash/flash.c
+++ b/src/flash/flash.c
@@ -728,7 +728,7 @@ COMMAND_HANDLER(handle_flash_fill_command)
 	if (count == 0)
 		return ERROR_OK;
 
-	switch (cmd[4])
+	switch (CMD_NAME[4])
 	{
 	case 'w':
 		wordsize = 4;
diff --git a/src/helper/command.h b/src/helper/command.h
index aec066d..74c6f36 100644
--- a/src/helper/command.h
+++ b/src/helper/command.h
@@ -121,6 +121,12 @@ typedef struct command_context_s
  */
 #define COMMAND_HELPER(name, extra...) __COMMAND_HANDLER(name, extra)
 
+/**
+ * Use this macro to access the name of the command being handled,
+ * rather than accessing the variable directly.  It may be moved.
+ */
+#define CMD_NAME cmd
+
 
 /// The type signature for commands' handler functions.
 typedef __COMMAND_HANDLER((*command_handler_t));
diff --git a/src/jtag/tcl.c b/src/jtag/tcl.c
index 4da8838..923542f 100644
--- a/src/jtag/tcl.c
+++ b/src/jtag/tcl.c
@@ -605,7 +605,7 @@ static int default_srst_asserted(int *srst_asserted)
 
 COMMAND_HANDLER(handle_interface_list_command)
 {
-	if (strcmp(cmd, &quot;interface_list&quot;) == 0 &amp;&amp; argc &gt; 0)
+	if (strcmp(CMD_NAME, &quot;interface_list&quot;) == 0 &amp;&amp; argc &gt; 0)
 		return ERROR_COMMAND_SYNTAX_ERROR;
 
 	command_print(cmd_ctx, &quot;The following JTAG interfaces are available:&quot;);
diff --git a/src/target/arm720t.c b/src/target/arm720t.c
index 6a5a4e7..af326bf 100644
--- a/src/target/arm720t.c
+++ b/src/target/arm720t.c
@@ -424,7 +424,7 @@ COMMAND_HANDLER(arm720t_handle_cp15_command)
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
-		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, cmd);
+		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, CMD_NAME);
 		return ERROR_OK;
 	}
 
diff --git a/src/target/arm920t.c b/src/target/arm920t.c
index 5576f60..81f5c6a 100644
--- a/src/target/arm920t.c
+++ b/src/target/arm920t.c
@@ -1203,7 +1203,7 @@ COMMAND_HANDLER(arm920t_handle_cp15_command)
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
-		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, cmd);
+		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, CMD_NAME);
 		return ERROR_OK;
 	}
 
@@ -1257,7 +1257,7 @@ COMMAND_HANDLER(arm920t_handle_cp15i_command)
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
-		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, cmd);
+		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, CMD_NAME);
 		return ERROR_OK;
 	}
 
diff --git a/src/target/arm926ejs.c b/src/target/arm926ejs.c
index 6f347d8..77405a8 100644
--- a/src/target/arm926ejs.c
+++ b/src/target/arm926ejs.c
@@ -740,7 +740,7 @@ COMMAND_HANDLER(arm926ejs_handle_cp15_command)
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
-		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, cmd);
+		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, CMD_NAME);
 		return ERROR_OK;
 	}
 
diff --git a/src/target/arm966e.c b/src/target/arm966e.c
index e61943a..62ccaa8 100644
--- a/src/target/arm966e.c
+++ b/src/target/arm966e.c
@@ -174,7 +174,7 @@ COMMAND_HANDLER(arm966e_handle_cp15_command)
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
-		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, cmd);
+		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, CMD_NAME);
 		return ERROR_OK;
 	}
 
diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index 5084231..86469c4 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -1902,7 +1902,7 @@ COMMAND_HANDLER(handle_cortex_m3_mask_interrupts_command)
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
-		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, cmd);
+		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, CMD_NAME);
 		return ERROR_OK;
 	}
 
diff --git a/src/target/target.c b/src/target/target.c
index 21c0526..8cc46ec 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -2046,7 +2046,7 @@ COMMAND_HANDLER(handle_wait_halt_command)
 		int retval = parse_uint(args[0], &amp;ms);
 		if (ERROR_OK != retval)
 		{
-			command_print(cmd_ctx, &quot;usage: %s [seconds]&quot;, cmd);
+			command_print(cmd_ctx, &quot;usage: %s [seconds]&quot;, CMD_NAME);
 			return ERROR_COMMAND_SYNTAX_ERROR;
 		}
 		// convert seconds (given) to milliseconds (needed)
@@ -2256,7 +2256,7 @@ COMMAND_HANDLER(handle_md_command)
 		return ERROR_COMMAND_SYNTAX_ERROR;
 
 	unsigned size = 0;
-	switch (cmd[2]) {
+	switch (CMD_NAME[2]) {
 	case 'w': size = 4; break;
 	case 'h': size = 2; break;
 	case 'b': size = 1; break;
@@ -2333,7 +2333,7 @@ COMMAND_HANDLER(handle_mw_command)
 	target_t *target = get_current_target(cmd_ctx);
 	unsigned wordsize;
 	uint8_t value_buf[4];
-	switch (cmd[2])
+	switch (CMD_NAME[2])
 	{
 		case 'w':
 			wordsize = 4;
diff --git a/src/target/xscale.c b/src/target/xscale.c
index 6f2d6ee..e18d591 100644
--- a/src/target/xscale.c
+++ b/src/target/xscale.c
@@ -3127,7 +3127,7 @@ COMMAND_HANDLER(xscale_handle_mmu_command)
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
-		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, cmd);
+		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, CMD_NAME);
 		return ERROR_OK;
 	}
 
@@ -3163,13 +3163,13 @@ COMMAND_HANDLER(xscale_handle_idcache_command)
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
-		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, cmd);
+		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, CMD_NAME);
 		return ERROR_OK;
 	}
 
-	if (strcmp(cmd, &quot;icache&quot;) == 0)
+	if (strcmp(CMD_NAME, &quot;icache&quot;) == 0)
 		icache = 1;
-	else if (strcmp(cmd, &quot;dcache&quot;) == 0)
+	else if (strcmp(CMD_NAME, &quot;dcache&quot;) == 0)
 		dcache = 1;
 
 	if (argc &gt;= 1)
@@ -3302,7 +3302,7 @@ COMMAND_HANDLER(xscale_handle_trace_buffer_command)
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
-		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, cmd);
+		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, CMD_NAME);
 		return ERROR_OK;
 	}
 
@@ -3429,7 +3429,7 @@ COMMAND_HANDLER(xscale_handle_dump_trace_command)
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
-		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, cmd);
+		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, CMD_NAME);
 		return ERROR_OK;
 	}
 
@@ -3499,7 +3499,7 @@ COMMAND_HANDLER(xscale_handle_cp15)
 
 	if (target-&gt;state != TARGET_HALTED)
 	{
-		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, cmd);
+		command_print(cmd_ctx, &quot;target must be stopped for \&quot;%s\&quot; command&quot;, CMD_NAME);
 		return ERROR_OK;
 	}
 	uint32_t reg_no = 0;

commit 5b6df55a1e5e4c0f531bc336691bc7c9a6a0df87
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 22:23:07 2009 -0800

    use CALL_COMMAND_HANDLER instead of direct calls
    
    By using CALL_COMMAND_HANDLER, parameters can be reordered, added, or
    even removed in inherited signatures, without requiring revisiting
    all of the various call sites.

diff --git a/src/flash/flash.c b/src/flash/flash.c
index d3889b9..da43e1a 100644
--- a/src/flash/flash.c
+++ b/src/flash/flash.c
@@ -259,7 +259,8 @@ COMMAND_HANDLER(handle_flash_bank_command)
 		c-&gt;sectors = NULL;
 		c-&gt;next = NULL;
 
-		if ((retval = flash_drivers[i]-&gt;flash_bank_command(cmd_ctx, cmd, args, argc, c)) != ERROR_OK)
+		retval = CALL_COMMAND_HANDLER(flash_drivers[i]-&gt;flash_bank_command, c);
+		if (ERROR_OK != retval)
 		{
 			LOG_ERROR(&quot;'%s' driver rejected flash bank at 0x%8.8&quot; PRIx32 , args[0], c-&gt;base);
 			free(c);
diff --git a/src/flash/nand.c b/src/flash/nand.c
index 181700d..88d3e42 100644
--- a/src/flash/nand.c
+++ b/src/flash/nand.c
@@ -241,7 +241,8 @@ COMMAND_HANDLER(handle_nand_device_command)
 			c-&gt;use_raw = 0;
 			c-&gt;next = NULL;
 
-			if ((retval = nand_flash_controllers[i]-&gt;nand_device_command(cmd_ctx, cmd, args, argc, c)) != ERROR_OK)
+			retval = CALL_COMMAND_HANDLER(nand_flash_controllers[i]-&gt;nand_device_command, c);
+			if (ERROR_OK != retval)
 			{
 				LOG_ERROR(&quot;'%s' driver rejected nand flash&quot;, c-&gt;controller-&gt;name);
 				free(c);
diff --git a/src/jtag/tcl.c b/src/jtag/tcl.c
index 653d3a7..4da8838 100644
--- a/src/jtag/tcl.c
+++ b/src/jtag/tcl.c
@@ -658,7 +658,7 @@ COMMAND_HANDLER(handle_interface_command)
 	 * didn't match one of the compiled-in interfaces
 	 */
 	LOG_ERROR(&quot;The specified JTAG interface was not found (%s)&quot;, args[0]);
-	handle_interface_list_command(cmd_ctx, cmd, args, argc);
+	CALL_COMMAND_HANDLER(handle_interface_list_command);
 	return ERROR_JTAG_INVALID_INTERFACE;
 }
 
diff --git a/src/pld/pld.c b/src/pld/pld.c
index c20b936..e8cd075 100644
--- a/src/pld/pld.c
+++ b/src/pld/pld.c
@@ -85,7 +85,8 @@ COMMAND_HANDLER(handle_pld_device_command)
 			c-&gt;driver = pld_drivers[i];
 			c-&gt;next = NULL;
 
-			if (pld_drivers[i]-&gt;pld_device_command(cmd_ctx, cmd, args, argc, c) != ERROR_OK)
+			int retval = CALL_COMMAND_HANDLER(pld_drivers[i]-&gt;pld_device_command, c);
+			if (ERROR_OK != retval)
 			{
 				LOG_ERROR(&quot;'%s' driver rejected pld device&quot;, args[0]);
 				free(c);
diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index c0c5d77..761ae40 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -2271,7 +2271,7 @@ COMMAND_HANDLER(handle_gdb_sync_command)
 /* daemon configuration command gdb_port */
 COMMAND_HANDLER(handle_gdb_port_command)
 {
-	return server_port_command(cmd_ctx, cmd, args, argc, &amp;gdb_port);
+	return CALL_COMMAND_HANDLER(server_port_command, &amp;gdb_port);
 }
 
 COMMAND_HANDLER(handle_gdb_memory_map_command)
diff --git a/src/server/tcl_server.c b/src/server/tcl_server.c
index 3410ca9..c8da5bc 100644
--- a/src/server/tcl_server.c
+++ b/src/server/tcl_server.c
@@ -172,7 +172,7 @@ int tcl_init(void)
 
 COMMAND_HANDLER(handle_tcl_port_command)
 {
-	return server_port_command(cmd_ctx, cmd, args, argc, &amp;tcl_port);
+	return CALL_COMMAND_HANDLER(server_port_command, &amp;tcl_port);
 }
 
 int tcl_register_commands(command_context_t *cmd_ctx)
diff --git a/src/server/telnet_server.c b/src/server/telnet_server.c
index c409ec0..6cb4746 100644
--- a/src/server/telnet_server.c
+++ b/src/server/telnet_server.c
@@ -608,7 +608,7 @@ int telnet_init(char *banner)
 /* daemon configuration command telnet_port */
 COMMAND_HANDLER(handle_telnet_port_command)
 {
-	return server_port_command(cmd_ctx, cmd, args, argc, &amp;telnet_port);
+	return CALL_COMMAND_HANDLER(server_port_command, &amp;telnet_port);
 }
 
 COMMAND_HANDLER(handle_exit_command)
diff --git a/src/target/arm11.c b/src/target/arm11.c
index 949c947..5b11f8e 100644
--- a/src/target/arm11.c
+++ b/src/target/arm11.c
@@ -2029,7 +2029,8 @@ static COMMAND_HELPER(arm11_handle_bool, bool *var, char *name)
 #define BOOL_WRAPPER(name, print_name)	\
 COMMAND_HANDLER(arm11_handle_bool_##name) \
 { \
-	return arm11_handle_bool(cmd_ctx, cmd, args, argc, &amp;arm11_config_##name, print_name); \
+	return CALL_COMMAND_HANDLER(arm11_handle_bool, \
+			&amp;arm11_config_##name, print_name); \
 }
 
 BOOL_WRAPPER(memwrite_burst,			&quot;memory write burst mode&quot;)
@@ -2186,12 +2187,12 @@ static COMMAND_HELPER(arm11_handle_etm_read_write, bool read)
 
 COMMAND_HANDLER(arm11_handle_etmr)
 {
-	return arm11_handle_etm_read_write(cmd_ctx, cmd, args, argc, true);
+	return CALL_COMMAND_HANDLER(arm11_handle_etm_read_write, true);
 }
 
 COMMAND_HANDLER(arm11_handle_etmw)
 {
-	return arm11_handle_etm_read_write(cmd_ctx, cmd, args, argc, false);
+	return CALL_COMMAND_HANDLER(arm11_handle_etm_read_write, false);
 }
 
 #define ARM11_HANDLER(x)	.x = arm11_##x
diff --git a/src/target/etm.c b/src/target/etm.c
index df02904..a4ff6c5 100644
--- a/src/target/etm.c
+++ b/src/target/etm.c
@@ -1271,7 +1271,7 @@ COMMAND_HANDLER(handle_etm_tracemode_command)
 	case 0:
 		break;
 	case 4:
-		handle_etm_tracemode_command_update(cmd_ctx, cmd, args, argc, &amp;tracemode);
+		CALL_COMMAND_HANDLER(handle_etm_tracemode_command_update, &amp;tracemode);
 		break;
 	default:
 		command_print(cmd_ctx, &quot;usage: configure trace mode &quot;
diff --git a/src/target/target.c b/src/target/target.c
index 26c20cf..21c0526 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -2121,7 +2121,7 @@ COMMAND_HANDLER(handle_halt_command)
 			return ERROR_OK;
 	}
 
-	return handle_wait_halt_command(cmd_ctx, cmd, args, argc);
+	return CALL_COMMAND_HANDLER(handle_wait_halt_command);
 }
 
 COMMAND_HANDLER(handle_soft_reset_halt_command)
@@ -2410,7 +2410,7 @@ COMMAND_HANDLER(handle_load_image_command)
 	int i;
 	image_t image;
 
-	int retval = parse_load_image_command_args(cmd_ctx, cmd, args, argc,
+	int retval = CALL_COMMAND_HANDLER(parse_load_image_command_args,
 			&amp;image, &amp;min_address, &amp;max_address);
 	if (ERROR_OK != retval)
 		return retval;
@@ -2701,12 +2701,12 @@ done:
 
 COMMAND_HANDLER(handle_verify_image_command)
 {
-	return handle_verify_image_command_internal(cmd_ctx, cmd, args, argc, 1);
+	return CALL_COMMAND_HANDLER(handle_verify_image_command_internal, 1);
 }
 
 COMMAND_HANDLER(handle_test_image_command)
 {
-	return handle_verify_image_command_internal(cmd_ctx, cmd, args, argc, 0);
+	return CALL_COMMAND_HANDLER(handle_verify_image_command_internal, 0);
 }
 
 static int handle_bp_command_list(struct command_context_s *cmd_ctx)
@@ -4547,7 +4547,7 @@ COMMAND_HANDLER(handle_fast_load_image_command)
 
 	image_t image;
 
-	int retval = parse_load_image_command_args(cmd_ctx, cmd, args, argc,
+	int retval = CALL_COMMAND_HANDLER(parse_load_image_command_args,
 			&amp;image, &amp;min_address, &amp;max_address);
 	if (ERROR_OK != retval)
 		return retval;

commit 1df5cc18f51366b823bccdaec4ffa1ee3fac2447
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 01:21:29 2009 -0800

    add PLD_DEVICE_COMMAND_HANDLER macro
    
    Update virtex module to use abstracted PLD command handling.

diff --git a/src/pld/pld.h b/src/pld/pld.h
index 3db4bad..22f2c13 100644
--- a/src/pld/pld.h
+++ b/src/pld/pld.h
@@ -24,14 +24,19 @@
 
 struct pld_device_s;
 
+#define __PLD_DEVICE_COMMAND(name) \
+		COMMAND_HELPER(name, struct pld_device_s *pld)
+
 typedef struct pld_driver_s
 {
 	char *name;
+	__PLD_DEVICE_COMMAND((*pld_device_command));
 	int (*register_commands)(struct command_context_s *cmd_ctx);
-	int (*pld_device_command)(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct pld_device_s *pld_device);
 	int (*load)(struct pld_device_s *pld_device, const char *filename);
 } pld_driver_t;
 
+#define PLD_DEVICE_COMMAND_HANDLER(name) static __PLD_DEVICE_COMMAND(name)
+
 typedef struct pld_device_s
 {
 	pld_driver_t *driver;
diff --git a/src/pld/virtex2.c b/src/pld/virtex2.c
index 3c6d61f..7e422fb 100644
--- a/src/pld/virtex2.c
+++ b/src/pld/virtex2.c
@@ -207,8 +207,7 @@ COMMAND_HANDLER(virtex2_handle_read_stat_command)
 	return ERROR_OK;
 }
 
-static int virtex2_pld_device_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc, struct pld_device_s *pld_device)
+PLD_DEVICE_COMMAND_HANDLER(virtex2_pld_device_command)
 {
 	jtag_tap_t *tap;
 
@@ -227,9 +226,10 @@ static int virtex2_pld_device_command(struct command_context_s *cmd_ctx,
 	}
 
 	virtex2_info = malloc(sizeof(virtex2_pld_device_t));
-	pld_device-&gt;driver_priv = virtex2_info;
 	virtex2_info-&gt;tap = tap;
 
+	pld-&gt;driver_priv = virtex2_info;
+
 	return ERROR_OK;
 }
 

commit 670f999e7a1ec04cda599a5487de068379e36f0e
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 00:53:40 2009 -0800

    nand: add NAND_DEVICE_COMMAND_HANDLER macro
    
    Abstracts the extended NAND command handling to allow the function
    signature to be controlled by __COMMAND_HANDLER.

diff --git a/src/flash/davinci_nand.c b/src/flash/davinci_nand.c
index 6ecc60a..b3164ab 100644
--- a/src/flash/davinci_nand.c
+++ b/src/flash/davinci_nand.c
@@ -629,9 +629,7 @@ static int davinci_read_page_ecc4infix(struct nand_device_s *nand, uint32_t page
 	return ERROR_OK;
 }
 
-static int davinci_nand_device_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc,
-		struct nand_device_s *nand)
+NAND_DEVICE_COMMAND_HANDLER(davinci_nand_device_command)
 {
 	struct davinci_nand *info;
 	target_t *target;
diff --git a/src/flash/lpc3180_nand_controller.c b/src/flash/lpc3180_nand_controller.c
index 4b12077..41cc33e 100644
--- a/src/flash/lpc3180_nand_controller.c
+++ b/src/flash/lpc3180_nand_controller.c
@@ -29,7 +29,7 @@ static int lpc3180_controller_ready(struct nand_device_s *nand, int timeout);
 
 /* nand device lpc3180 &lt;target#&gt; &lt;oscillator_frequency&gt;
  */
-static int lpc3180_nand_device_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct nand_device_s *nand)
+NAND_DEVICE_COMMAND_HANDLER(lpc3180_nand_device_command)
 {
 	if (argc &lt; 3)
 	{
diff --git a/src/flash/mx3_nand.c b/src/flash/mx3_nand.c
index f6a75ef..a51f8c8 100644
--- a/src/flash/mx3_nand.c
+++ b/src/flash/mx3_nand.c
@@ -61,9 +61,7 @@ static int imx31_command (struct nand_device_s *nand, uint8_t command);
 static int imx31_address (struct nand_device_s *nand, uint8_t address);
 static int imx31_controller_ready (struct nand_device_s *nand, int tout);
 
-static int imx31_nand_device_command (struct command_context_s *cmd_ctx,
-				      char *cmd, char **args, int argc,
-				      struct nand_device_s *nand)
+NAND_DEVICE_COMMAND_HANDLER(imx31_nand_device_command)
 {
 	mx3_nf_controller_t *mx3_nf_info;
 	mx3_nf_info = malloc (sizeof (mx3_nf_controller_t));
diff --git a/src/flash/nand.h b/src/flash/nand.h
index d96e288..57076d5 100644
--- a/src/flash/nand.h
+++ b/src/flash/nand.h
@@ -29,10 +29,13 @@
 
 struct nand_device_s;
 
+#define __NAND_DEVICE_COMMAND(name) \
+		COMMAND_HELPER(name, struct nand_device_s *nand)
+
 typedef struct nand_flash_controller_s
 {
 	char *name;
-	int (*nand_device_command)(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct nand_device_s *nand);
+	__NAND_DEVICE_COMMAND((*nand_device_command));
 	int (*register_commands)(struct command_context_s *cmd_ctx);
 	int (*init)(struct nand_device_s *nand);
 	int (*reset)(struct nand_device_s *nand);
@@ -48,6 +51,8 @@ typedef struct nand_flash_controller_s
 	int (*nand_ready)(struct nand_device_s *nand, int timeout);
 } nand_flash_controller_t;
 
+#define NAND_DEVICE_COMMAND_HANDLER(name) static __NAND_DEVICE_COMMAND(name)
+
 typedef struct nand_block_s
 {
 	uint32_t offset;
diff --git a/src/flash/orion_nand.c b/src/flash/orion_nand.c
index 471c562..b112c9e 100644
--- a/src/flash/orion_nand.c
+++ b/src/flash/orion_nand.c
@@ -125,9 +125,7 @@ static int orion_nand_register_commands(struct command_context_s *cmd_ctx)
 	return ERROR_OK;
 }
 
-int orion_nand_device_command(struct command_context_s *cmd_ctx, char *cmd,
-			      char **args, int argc,
-			      struct nand_device_s *nand)
+NAND_DEVICE_COMMAND_HANDLER(orion_nand_device_command)
 {
 	orion_nand_controller_t *hw;
 	uint32_t base;
diff --git a/src/flash/s3c2410_nand.c b/src/flash/s3c2410_nand.c
index 176a1a4..5badf1a 100644
--- a/src/flash/s3c2410_nand.c
+++ b/src/flash/s3c2410_nand.c
@@ -30,9 +30,7 @@
 
 #include &quot;s3c24xx_nand.h&quot;
 
-static int s3c2410_nand_device_command(struct command_context_s *cmd_ctx, char *cmd,
-				char **args, int argc,
-				struct nand_device_s *nand)
+NAND_DEVICE_COMMAND_HANDLER(s3c2410_nand_device_command)
 {
 	s3c24xx_nand_controller_t *info;
 	CALL_S3C24XX_DEVICE_COMMAND(nand, &amp;info);
diff --git a/src/flash/s3c2412_nand.c b/src/flash/s3c2412_nand.c
index 7b65f84..958f013 100644
--- a/src/flash/s3c2412_nand.c
+++ b/src/flash/s3c2412_nand.c
@@ -30,9 +30,7 @@
 
 #include &quot;s3c24xx_nand.h&quot;
 
-static int s3c2412_nand_device_command(struct command_context_s *cmd_ctx, char *cmd,
-				char **args, int argc,
-				struct nand_device_s *nand)
+NAND_DEVICE_COMMAND_HANDLER(s3c2412_nand_device_command)
 {
 	s3c24xx_nand_controller_t *info;
 	CALL_S3C24XX_DEVICE_COMMAND(nand, &amp;info);
diff --git a/src/flash/s3c2440_nand.c b/src/flash/s3c2440_nand.c
index c6d658d..80020f6 100644
--- a/src/flash/s3c2440_nand.c
+++ b/src/flash/s3c2440_nand.c
@@ -31,9 +31,7 @@
 #include &quot;s3c24xx_nand.h&quot;
 
 
-static int s3c2440_nand_device_command(struct command_context_s *cmd_ctx, char *cmd,
-				char **args, int argc,
-				struct nand_device_s *nand)
+NAND_DEVICE_COMMAND_HANDLER(s3c2440_nand_device_command)
 {
 	s3c24xx_nand_controller_t *info;
 	CALL_S3C24XX_DEVICE_COMMAND(nand, &amp;info);
diff --git a/src/flash/s3c2443_nand.c b/src/flash/s3c2443_nand.c
index 6e92021..af7d9a9 100644
--- a/src/flash/s3c2443_nand.c
+++ b/src/flash/s3c2443_nand.c
@@ -31,9 +31,7 @@
 #include &quot;s3c24xx_nand.h&quot;
 
 
-static int s3c2443_nand_device_command(struct command_context_s *cmd_ctx, char *cmd,
-				char **args, int argc,
-				struct nand_device_s *nand)
+NAND_DEVICE_COMMAND_HANDLER(s3c2443_nand_device_command)
 {
 	s3c24xx_nand_controller_t *info;
 	CALL_S3C24XX_DEVICE_COMMAND(nand, &amp;info);

commit 0796dfff89bf00f82a780d7719767bcffe881d67
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 01:41:30 2009 -0800

    use FLASH_BANK_COMMAND_HANDLER macro
    
    Defines all flash_bank_command handlers using the new macro.

diff --git a/src/flash/aduc702x.c b/src/flash/aduc702x.c
index 7d6fa24..0e862e9 100644
--- a/src/flash/aduc702x.c
+++ b/src/flash/aduc702x.c
@@ -61,7 +61,7 @@ typedef struct
 
 /* flash bank aduc702x 0 0 0 0 &lt;target#&gt;
  * The ADC7019-28 devices all have the same flash layout */
-static int aduc702x_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(aduc702x_flash_bank_command)
 {
 	aduc702x_flash_bank_t *nbank;
 
diff --git a/src/flash/at91sam3.c b/src/flash/at91sam3.c
index 804a35b..7e6b456 100644
--- a/src/flash/at91sam3.c
+++ b/src/flash/at91sam3.c
@@ -1641,12 +1641,7 @@ sam3_protect_check(struct flash_bank_s *bank)
 	return ERROR_OK;
 }
 
-static int
-sam3_flash_bank_command(struct command_context_s *cmd_ctx,
-			    char *cmd,
-			    char **args,
-			    int argc,
-			    struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(sam3_flash_bank_command)
 {
 	struct sam3_chip *pChip;
 
diff --git a/src/flash/at91sam7.c b/src/flash/at91sam7.c
index 4cd2705..266be06 100644
--- a/src/flash/at91sam7.c
+++ b/src/flash/at91sam7.c
@@ -711,7 +711,7 @@ static int at91sam7_protect_check(struct flash_bank_s *bank)
 	return ERROR_OK;
 }
 
-static int at91sam7_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(at91sam7_flash_bank_command)
 {
 	flash_bank_t *t_bank = bank;
 	at91sam7_flash_bank_t *at91sam7_info;
diff --git a/src/flash/avrf.c b/src/flash/avrf.c
index 6badb2d..35d31fb 100644
--- a/src/flash/avrf.c
+++ b/src/flash/avrf.c
@@ -180,7 +180,7 @@ static int avr_jtagprg_writeflashpage(avr_common_t *avr, uint8_t *page_buf, uint
 	return ERROR_OK;
 }
 
-static int avrf_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(avrf_flash_bank_command)
 {
 	avrf_flash_bank_t *avrf_info;
 
diff --git a/src/flash/cfi.c b/src/flash/cfi.c
index b448a30..08c4358 100644
--- a/src/flash/cfi.c
+++ b/src/flash/cfi.c
@@ -601,7 +601,7 @@ static int cfi_register_commands(struct command_context_s *cmd_ctx)
 
 /* flash_bank cfi &lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt; &lt;target#&gt; [options]
  */
-static int cfi_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(cfi_flash_bank_command)
 {
 	cfi_flash_bank_t *cfi_info;
 	int i;
diff --git a/src/flash/ecos.c b/src/flash/ecos.c
index 401fdf2..2c3190a 100644
--- a/src/flash/ecos.c
+++ b/src/flash/ecos.c
@@ -104,7 +104,7 @@ flash_errmsg(int err)
 
 /* flash bank ecosflash &lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt; &lt;target#&gt; &lt;driverPath&gt;
  */
-static int ecosflash_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(ecosflash_flash_bank_command)
 {
 	ecosflash_flash_bank_t *info;
 
diff --git a/src/flash/faux.c b/src/flash/faux.c
index 474dee5..b997b87 100644
--- a/src/flash/faux.c
+++ b/src/flash/faux.c
@@ -37,7 +37,7 @@ static const int sectorSize = 0x10000;
 
 /* flash bank faux &lt;base&gt; &lt;size&gt; &lt;chip_width&gt; &lt;bus_width&gt; &lt;target#&gt; &lt;driverPath&gt;
  */
-static int faux_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(faux_flash_bank_command)
 {
 	faux_flash_bank_t *info;
 
diff --git a/src/flash/lpc2000.c b/src/flash/lpc2000.c
index 4d4d9a2..0481355 100644
--- a/src/flash/lpc2000.c
+++ b/src/flash/lpc2000.c
@@ -419,7 +419,7 @@ static int lpc2000_iap_blank_check(struct flash_bank_s *bank, int first, int las
 /*
  * flash bank lpc2000 &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt; &lt;lpc_variant&gt; &lt;cclk&gt; [calc_checksum]
  */
-static int lpc2000_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(lpc2000_flash_bank_command)
 {
 	lpc2000_flash_bank_t *lpc2000_info;
 
diff --git a/src/flash/lpc288x.c b/src/flash/lpc288x.c
index 36444fb..3c3e1e4 100644
--- a/src/flash/lpc288x.c
+++ b/src/flash/lpc288x.c
@@ -165,7 +165,7 @@ static int lpc288x_protect_check(struct flash_bank_s *bank)
 }
 
 /* flash_bank LPC288x 0 0 0 0 &lt;target#&gt; &lt;cclk&gt; */
-static int lpc288x_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(lpc288x_flash_bank_command)
 {
 	lpc288x_flash_bank_t *lpc288x_info;
 
diff --git a/src/flash/lpc2900.c b/src/flash/lpc2900.c
index 945fc9a..953a62a 100644
--- a/src/flash/lpc2900.c
+++ b/src/flash/lpc2900.c
@@ -1016,9 +1016,7 @@ static int lpc2900_register_commands(struct command_context_s *cmd_ctx)
 
 
 /// Evaluate flash bank command.
-static int lpc2900_flash_bank_command(struct command_context_s *cmd_ctx,
-                                      char *cmd, char **args, int argc,
-                                      struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(lpc2900_flash_bank_command)
 {
 	lpc2900_flash_bank_t *lpc2900_info;
 
diff --git a/src/flash/ocl.c b/src/flash/ocl.c
index 51ccc96..63e9282 100644
--- a/src/flash/ocl.c
+++ b/src/flash/ocl.c
@@ -44,7 +44,7 @@ static int ocl_protect_check(struct flash_bank_s *bank)
 }
 
 /* flash_bank ocl 0 0 0 0 &lt;target#&gt; */
-static int ocl_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(ocl_flash_bank_command)
 {
 	int retval;
 	armv4_5_common_t *armv4_5;
diff --git a/src/flash/pic32mx.c b/src/flash/pic32mx.c
index aa34aea..1408fe9 100644
--- a/src/flash/pic32mx.c
+++ b/src/flash/pic32mx.c
@@ -62,7 +62,7 @@ static int pic32mx_write_word(struct flash_bank_s *bank, uint32_t address, uint3
 
 /* flash bank pic32mx &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt;
  */
-static int pic32mx_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(pic32mx_flash_bank_command)
 {
 	pic32mx_flash_bank_t *pic32mx_info;
 
diff --git a/src/flash/stellaris.c b/src/flash/stellaris.c
index 22d5bc4..d66b9a8 100644
--- a/src/flash/stellaris.c
+++ b/src/flash/stellaris.c
@@ -213,7 +213,7 @@ static char * StellarisClassname[5] =
 
 /* flash_bank stellaris &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt;
  */
-static int stellaris_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(stellaris_flash_bank_command)
 {
 	stellaris_flash_bank_t *stellaris_info;
 
diff --git a/src/flash/stm32x.c b/src/flash/stm32x.c
index 95d15a9..41b9008 100644
--- a/src/flash/stm32x.c
+++ b/src/flash/stm32x.c
@@ -33,7 +33,7 @@ static int stm32x_mass_erase(struct flash_bank_s *bank);
 
 /* flash bank stm32x &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt;
  */
-static int stm32x_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(stm32x_flash_bank_command)
 {
 	stm32x_flash_bank_t *stm32x_info;
 
diff --git a/src/flash/str7x.c b/src/flash/str7x.c
index 028eab6..9738180 100644
--- a/src/flash/str7x.c
+++ b/src/flash/str7x.c
@@ -109,7 +109,7 @@ static int str7x_build_block_list(struct flash_bank_s *bank)
 
 /* flash bank str7x &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt; &lt;str71_variant&gt;
  */
-static int str7x_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(str7x_flash_bank_command)
 {
 	str7x_flash_bank_t *str7x_info;
 
diff --git a/src/flash/str9x.c b/src/flash/str9x.c
index 665c160..cdee571 100644
--- a/src/flash/str9x.c
+++ b/src/flash/str9x.c
@@ -116,8 +116,7 @@ static int str9x_build_block_list(struct flash_bank_s *bank)
 
 /* flash bank str9x &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt;
  */
-static int str9x_flash_bank_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(str9x_flash_bank_command)
 {
 	str9x_flash_bank_t *str9x_info;
 
diff --git a/src/flash/str9xpec.c b/src/flash/str9xpec.c
index 3a35ee1..4056ba7 100644
--- a/src/flash/str9xpec.c
+++ b/src/flash/str9xpec.c
@@ -235,7 +235,7 @@ static int str9xpec_build_block_list(struct flash_bank_s *bank)
 
 /* flash bank str9x &lt;base&gt; &lt;size&gt; 0 0 &lt;target#&gt;
  */
-static int str9xpec_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(str9xpec_flash_bank_command)
 {
 	str9xpec_flash_controller_t *str9xpec_info;
 	armv4_5_common_t *armv4_5 = NULL;
diff --git a/src/flash/tms470.c b/src/flash/tms470.c
index 53043cd..d33ccd6 100644
--- a/src/flash/tms470.c
+++ b/src/flash/tms470.c
@@ -1222,7 +1222,7 @@ static int tms470_info(struct flash_bank_s *bank, char *buf, int buf_size)
  * [options...]
  */
 
-static int tms470_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, struct flash_bank_s *bank)
+FLASH_BANK_COMMAND_HANDLER(tms470_flash_bank_command)
 {
 	bank-&gt;driver_priv = malloc(sizeof(tms470_flash_bank_t));
 

commit 57c5c5f46304a785092874a7dc0f6abc84794cc3
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 01:39:30 2009 -0800

    add FLASH_BANK_COMMAND_HANDLER macro
    
    The FLASH_BANK_COMMAND_HANDLER provides an extended command handler
    using the __COMMAND_HANDLER macro, whereby changing that macro is
    sufficient to update flash handlers with the new signature.  It also
    enforces uniform style and scope when implementing this handler.

diff --git a/src/flash/flash.h b/src/flash/flash.h
index 7f5875e..7afb132 100644
--- a/src/flash/flash.h
+++ b/src/flash/flash.h
@@ -59,6 +59,9 @@ typedef struct flash_sector_s
 
 struct flash_bank_s;
 
+#define __FLASH_BANK_COMMAND(name) \
+		COMMAND_HELPER(name, struct flash_bank_s *bank)
+
 /**
  * @brief Provides the implementation-independent structure that defines
  * all of the callbacks required by OpenOCD flash drivers.
@@ -121,8 +124,7 @@ typedef struct flash_driver_s
 	 *
 	 * @returns ERROR_OK if successful; otherwise, an error code.
 	 */
-	int (*flash_bank_command)(struct command_context_s *cmd_ctx,
-			char *cmd, char **args, int argc, struct flash_bank_s *bank);
+	__FLASH_BANK_COMMAND((*flash_bank_command));
 
 	/**
 	 * Bank/sector erase routine (target-specific).  When
@@ -224,6 +226,8 @@ typedef struct flash_driver_s
 	int (*auto_probe)(struct flash_bank_s *bank);
 } flash_driver_t;
 
+#define FLASH_BANK_COMMAND_HANDLER(name) static __FLASH_BANK_COMMAND(name)
+
 /**
  * Provides details of a flash bank, available either on-chip or through
  * a major interface.

commit 76868e071306bc83d25b89e57b785fef4637c4c8
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 05:32:51 2009 -0800

    s3c24xx: use COMMAND_HANDLER with command helper
    
    Add S3C24XX_DEVICE_COMMAND macros to abstract common command handler
    conventions.

diff --git a/src/flash/s3c2410_nand.c b/src/flash/s3c2410_nand.c
index e663507..176a1a4 100644
--- a/src/flash/s3c2410_nand.c
+++ b/src/flash/s3c2410_nand.c
@@ -35,11 +35,7 @@ static int s3c2410_nand_device_command(struct command_context_s *cmd_ctx, char *
 				struct nand_device_s *nand)
 {
 	s3c24xx_nand_controller_t *info;
-
-	info = s3c24xx_nand_device_command(cmd_ctx, cmd, args, argc, nand);
-	if (info == NULL) {
-		return ERROR_NAND_DEVICE_INVALID;
-	}
+	CALL_S3C24XX_DEVICE_COMMAND(nand, &amp;info);
 
 	/* fill in the address fields for the core device */
 	info-&gt;cmd = S3C2410_NFCMD;
diff --git a/src/flash/s3c2412_nand.c b/src/flash/s3c2412_nand.c
index 5c9d319..7b65f84 100644
--- a/src/flash/s3c2412_nand.c
+++ b/src/flash/s3c2412_nand.c
@@ -35,11 +35,7 @@ static int s3c2412_nand_device_command(struct command_context_s *cmd_ctx, char *
 				struct nand_device_s *nand)
 {
 	s3c24xx_nand_controller_t *info;
-
-	info = s3c24xx_nand_device_command(cmd_ctx, cmd, args, argc, nand);
-	if (info == NULL) {
-		return ERROR_NAND_DEVICE_INVALID;
-	}
+	CALL_S3C24XX_DEVICE_COMMAND(nand, &amp;info);
 
 	/* fill in the address fields for the core device */
 	info-&gt;cmd = S3C2440_NFCMD;
diff --git a/src/flash/s3c2440_nand.c b/src/flash/s3c2440_nand.c
index fd1fbd0..c6d658d 100644
--- a/src/flash/s3c2440_nand.c
+++ b/src/flash/s3c2440_nand.c
@@ -36,11 +36,7 @@ static int s3c2440_nand_device_command(struct command_context_s *cmd_ctx, char *
 				struct nand_device_s *nand)
 {
 	s3c24xx_nand_controller_t *info;
-
-	info = s3c24xx_nand_device_command(cmd_ctx, cmd, args, argc, nand);
-	if (info == NULL) {
-		return ERROR_NAND_DEVICE_INVALID;
-	}
+	CALL_S3C24XX_DEVICE_COMMAND(nand, &amp;info);
 
 	/* fill in the address fields for the core device */
 	info-&gt;cmd = S3C2440_NFCMD;
diff --git a/src/flash/s3c2443_nand.c b/src/flash/s3c2443_nand.c
index 82d9b8e..6e92021 100644
--- a/src/flash/s3c2443_nand.c
+++ b/src/flash/s3c2443_nand.c
@@ -36,11 +36,7 @@ static int s3c2443_nand_device_command(struct command_context_s *cmd_ctx, char *
 				struct nand_device_s *nand)
 {
 	s3c24xx_nand_controller_t *info;
-
-	info = s3c24xx_nand_device_command(cmd_ctx, cmd, args, argc, nand);
-	if (info == NULL) {
-		return ERROR_NAND_DEVICE_INVALID;
-	}
+	CALL_S3C24XX_DEVICE_COMMAND(nand, &amp;info);
 
 	/* fill in the address fields for the core device */
 	info-&gt;cmd = S3C2440_NFCMD;
diff --git a/src/flash/s3c24xx_nand.c b/src/flash/s3c24xx_nand.c
index 59d4d5b..e2bc005 100644
--- a/src/flash/s3c24xx_nand.c
+++ b/src/flash/s3c24xx_nand.c
@@ -31,17 +31,14 @@
 #include &quot;s3c24xx_nand.h&quot;
 
 
-s3c24xx_nand_controller_t *
-s3c24xx_nand_device_command(struct command_context_s *cmd_ctx, char *cmd,
-			    char **args, int argc,
-			    struct nand_device_s *nand)
+S3C24XX_DEVICE_COMMAND()
 {
 	s3c24xx_nand_controller_t *s3c24xx_info;
 
 	s3c24xx_info = malloc(sizeof(s3c24xx_nand_controller_t));
 	if (s3c24xx_info == NULL) {
 		LOG_ERROR(&quot;no memory for nand controller\n&quot;);
-		return NULL;
+		return -ENOMEM;
 	}
 
 	nand-&gt;controller_priv = s3c24xx_info;
@@ -49,10 +46,10 @@ s3c24xx_nand_device_command(struct command_context_s *cmd_ctx, char *cmd,
 	s3c24xx_info-&gt;target = get_target(args[1]);
 	if (s3c24xx_info-&gt;target == NULL) {
 		LOG_ERROR(&quot;target '%s' not defined&quot;, args[1]);
-		return NULL;
+		return ERROR_COMMAND_SYNTAX_ERROR;
 	}
 
-	return s3c24xx_info;
+	return ERROR_OK;
 }
 
 int s3c24xx_register_commands(struct command_context_s *cmd_ctx)
diff --git a/src/flash/s3c24xx_nand.h b/src/flash/s3c24xx_nand.h
index ed14295..3f304a9 100644
--- a/src/flash/s3c24xx_nand.h
+++ b/src/flash/s3c24xx_nand.h
@@ -45,9 +45,19 @@ typedef struct s3c24xx_nand_controller_s
 #undef S3C2410_NFREG
 #define S3C2410_NFREG(x) ((x) + 0x4e000000)
 
-s3c24xx_nand_controller_t *s3c24xx_nand_device_command(
-			struct command_context_s *cmd_ctx, char *cmd,
-			char **args, int argc, struct nand_device_s *nand);
+#define S3C24XX_DEVICE_COMMAND() \
+		COMMAND_HELPER(s3c24xx_nand_device_command, \
+				struct nand_device_s *nand, \
+				s3c24xx_nand_controller_t **info)
+
+S3C24XX_DEVICE_COMMAND();
+
+#define CALL_S3C24XX_DEVICE_COMMAND(d, i) \
+	do { \
+		int retval = CALL_COMMAND_HANDLER(s3c24xx_nand_device_command, d, i); \
+		if (ERROR_OK != retval) \
+			return retval; \
+	} while (0)
 
 int s3c24xx_register_commands(struct command_context_s *cmd_ctx);
 
diff --git a/src/target/avrt.o.RcaTm5 b/src/target/avrt.o.RcaTm5
new file mode 100644
index 0000000..e69de29

commit d02fee197f62331e36e9de110040f0170341c3e8
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 05:32:04 2009 -0800

    arm_adi,armv7[am]: use COMMAND_HELPER for helpers
    
    Rewrites the dap_* command helpers to use the COMMAND_HELPER paradigm.
    Uses CALL_COMMAND_HELPER to hide inherited calling conventions.

diff --git a/src/target/arm_adi_v5.c b/src/target/arm_adi_v5.c
index 0fc2976..4a7a37c 100644
--- a/src/target/arm_adi_v5.c
+++ b/src/target/arm_adi_v5.c
@@ -1364,8 +1364,7 @@ int dap_info_command(struct command_context_s *cmd_ctx, swjdp_common_t *swjdp, i
 	return ERROR_OK;
 }
 
-int dap_baseaddr_command(struct command_context_s *cmd_ctx,
-		swjdp_common_t *swjdp, char **args, int argc)
+DAP_COMMAND_HANDLER(dap_baseaddr_command)
 {
 	uint32_t apsel, apselsave, baseaddr;
 	int retval;
@@ -1395,8 +1394,7 @@ int dap_baseaddr_command(struct command_context_s *cmd_ctx,
 	return retval;
 }
 
-int dap_memaccess_command(struct command_context_s *cmd_ctx,
-		swjdp_common_t *swjdp, char **args, int argc)
+DAP_COMMAND_HANDLER(dap_memaccess_command)
 {
 	uint32_t memaccess_tck;
 
@@ -1418,8 +1416,7 @@ int dap_memaccess_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-int dap_apsel_command(struct command_context_s *cmd_ctx,
-		swjdp_common_t *swjdp, char **args, int argc)
+DAP_COMMAND_HANDLER(dap_apsel_command)
 {
 	uint32_t apsel, apid;
 	int retval;
@@ -1444,8 +1441,7 @@ int dap_apsel_command(struct command_context_s *cmd_ctx,
 	return retval;
 }
 
-int dap_apid_command(struct command_context_s *cmd_ctx,
-		swjdp_common_t *swjdp, char **args, int argc)
+DAP_COMMAND_HANDLER(dap_apid_command)
 {
 	uint32_t apsel, apselsave, apid;
 	int retval;
diff --git a/src/target/arm_adi_v5.h b/src/target/arm_adi_v5.h
index 442b45c..90b4cbd 100644
--- a/src/target/arm_adi_v5.h
+++ b/src/target/arm_adi_v5.h
@@ -158,13 +158,12 @@ int ahbap_debugport_init(swjdp_common_t *swjdp);
 /* Commands for user dap access */
 int dap_info_command(struct command_context_s *cmd_ctx,
 		swjdp_common_t *swjdp, int apsel);
-int dap_baseaddr_command(struct command_context_s *cmd_ctx,
-		swjdp_common_t *swjdp, char **args, int argc);
-int dap_memaccess_command(struct command_context_s *cmd_ctx,
-		swjdp_common_t *swjdp, char **args, int argc);
-int dap_apsel_command(struct command_context_s *cmd_ctx,
-		swjdp_common_t *swjdp, char **args, int argc);
-int dap_apid_command(struct command_context_s *cmd_ctx,
-		swjdp_common_t *swjdp, char **args, int argc);
+
+#define DAP_COMMAND_HANDLER(name) \
+		COMMAND_HELPER(name, swjdp_common_t *swjdp)
+DAP_COMMAND_HANDLER(dap_baseaddr_command);
+DAP_COMMAND_HANDLER(dap_memaccess_command);
+DAP_COMMAND_HANDLER(dap_apsel_command);
+DAP_COMMAND_HANDLER(dap_apid_command);
 
 #endif
diff --git a/src/target/armv7a.c b/src/target/armv7a.c
index f067926..eb5bfa9 100644
--- a/src/target/armv7a.c
+++ b/src/target/armv7a.c
@@ -236,7 +236,7 @@ COMMAND_HANDLER(handle_dap_baseaddr_command)
 	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
-	return dap_baseaddr_command(cmd_ctx, swjdp, args, argc);
+	return CALL_COMMAND_HANDLER(dap_baseaddr_command, swjdp);
 }
 
 COMMAND_HANDLER(handle_dap_memaccess_command)
@@ -245,7 +245,7 @@ COMMAND_HANDLER(handle_dap_memaccess_command)
 	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
-	return dap_memaccess_command(cmd_ctx, swjdp, args, argc);
+	return CALL_COMMAND_HANDLER(dap_memaccess_command, swjdp);
 }
 
 COMMAND_HANDLER(handle_dap_apsel_command)
@@ -254,7 +254,7 @@ COMMAND_HANDLER(handle_dap_apsel_command)
 	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
-	return dap_apsel_command(cmd_ctx, swjdp, args, argc);
+	return CALL_COMMAND_HANDLER(dap_apsel_command, swjdp);
 }
 
 COMMAND_HANDLER(handle_dap_apid_command)
@@ -263,7 +263,7 @@ COMMAND_HANDLER(handle_dap_apid_command)
 	struct armv7a_common_s *armv7a = target_to_armv7a(target);
 	swjdp_common_t *swjdp = &amp;armv7a-&gt;swjdp_info;
 
-	return dap_apid_command(cmd_ctx, swjdp, args, argc);
+	return CALL_COMMAND_HANDLER(dap_apid_command, swjdp);
 }
 
 COMMAND_HANDLER(handle_dap_info_command)
diff --git a/src/target/armv7m.c b/src/target/armv7m.c
index f6de5e1..0f9d811 100644
--- a/src/target/armv7m.c
+++ b/src/target/armv7m.c
@@ -788,7 +788,7 @@ COMMAND_HANDLER(handle_dap_apid_command)
 	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 
-	return dap_apid_command(cmd_ctx, swjdp, args, argc);
+	return CALL_COMMAND_HANDLER(dap_apid_command, swjdp);
 }
 
 COMMAND_HANDLER(handle_dap_apsel_command)
@@ -797,7 +797,7 @@ COMMAND_HANDLER(handle_dap_apsel_command)
 	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 
-	return dap_apsel_command(cmd_ctx, swjdp, args, argc);
+	return CALL_COMMAND_HANDLER(dap_apsel_command, swjdp);
 }
 
 COMMAND_HANDLER(handle_dap_memaccess_command)
@@ -806,7 +806,7 @@ COMMAND_HANDLER(handle_dap_memaccess_command)
 	struct armv7m_common_s *armv7m = target_to_armv7m(target);
 	swjdp_common_t *swjdp = &amp;armv7m-&gt;swjdp_info;
 
-	return dap_memaccess_command(cmd_ctx, swjdp, args, argc);
+	return CALL_COMMAND_HANDLER(dap_memaccess_command, swjdp);
 }
 
 

commit 63a26b421b1731df5826a157ea633b9d2c02aaee
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 03:12:21 2009 -0800

    use COMMAND_HELPER for command helper functions
    
    Define the numerous helpers that inherit command handler parameters
    using the COMMAND_HELPER macro.

diff --git a/src/jtag/parport.c b/src/jtag/parport.c
index cee7a16..a18b3f6 100644
--- a/src/jtag/parport.c
+++ b/src/jtag/parport.c
@@ -462,9 +462,7 @@ COMMAND_HANDLER(parport_handle_write_on_exit_command)
 	return ERROR_OK;
 }
 
-static int
-parport_handle_parport_toggling_time_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(parport_handle_parport_toggling_time_command)
 {
 	if (argc == 1) {
 		uint32_t ns;
diff --git a/src/server/server.c b/src/server/server.c
index c000b7c..ada0a60 100644
--- a/src/server/server.c
+++ b/src/server/server.c
@@ -551,8 +551,7 @@ int server_register_commands(command_context_t *context)
 }
 
 
-int server_port_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc, unsigned short *out)
+SERVER_PORT_COMMAND()
 {
 	switch (argc) {
 	case 0:
diff --git a/src/server/server.h b/src/server/server.h
index d4f1b6b..abb501d 100644
--- a/src/server/server.h
+++ b/src/server/server.h
@@ -81,8 +81,16 @@ int server_loop(command_context_t *command_context);
 
 int server_register_commands(command_context_t *context);
 
-int server_port_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc, unsigned short *port);
+/**
+ * Defines an extended command handler function declaration to enable
+ * access to (and manipulation of) the server port number.
+ * Call server_port like a normal COMMAND_HANDLER with an extra @a out parameter
+ * to receive the specified port number.
+ */
+#define SERVER_PORT_COMMAND() \
+		COMMAND_HELPER(server_port_command, unsigned short *out)
+
+SERVER_PORT_COMMAND();
 
 extern int server_use_pipes;
 
diff --git a/src/target/arm11.c b/src/target/arm11.c
index 098b0af..949c947 100644
--- a/src/target/arm11.c
+++ b/src/target/arm11.c
@@ -1991,8 +1991,7 @@ static int arm11_build_reg_cache(target_t *target)
 	return ERROR_OK;
 }
 
-static int arm11_handle_bool(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc, bool * var, char * name)
+static COMMAND_HELPER(arm11_handle_bool, bool *var, char *name)
 {
 	if (argc == 0)
 	{
@@ -2143,7 +2142,7 @@ static int arm11_mcr(target_t *target, int cpnum,
 	return arm11_mrc_inner(target, cpnum, op1, op2, CRn, CRm, &amp;value, false);
 }
 
-static int arm11_handle_etm_read_write(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, bool read)
+static COMMAND_HELPER(arm11_handle_etm_read_write, bool read)
 {
 	if (argc != (read ? 2 : 3))
 	{
diff --git a/src/target/etm.c b/src/target/etm.c
index 0fc9249..df02904 100644
--- a/src/target/etm.c
+++ b/src/target/etm.c
@@ -1176,9 +1176,8 @@ static int etmv1_analyze_trace(etm_context_t *ctx, struct command_context_s *cmd
 	return ERROR_OK;
 }
 
-static int handle_etm_tracemode_command_update(
-		struct command_context_s *cmd_ctx,
-		char **args, etmv1_tracemode_t *mode)
+static COMMAND_HELPER(handle_etm_tracemode_command_update,
+		etmv1_tracemode_t *mode)
 {
 	etmv1_tracemode_t tracemode;
 
@@ -1272,7 +1271,7 @@ COMMAND_HANDLER(handle_etm_tracemode_command)
 	case 0:
 		break;
 	case 4:
-		handle_etm_tracemode_command_update(cmd_ctx, args, &amp;tracemode);
+		handle_etm_tracemode_command_update(cmd_ctx, cmd, args, argc, &amp;tracemode);
 		break;
 	default:
 		command_print(cmd_ctx, &quot;usage: configure trace mode &quot;
diff --git a/src/target/target.c b/src/target/target.c
index 401f4df..26c20cf 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -2363,8 +2363,7 @@ COMMAND_HANDLER(handle_mw_command)
 
 }
 
-static int parse_load_image_command_args(struct command_context_s *cmd_ctx,
-		char **args, int argc, image_t *image,
+static COMMAND_HELPER(parse_load_image_command_args, image_t *image,
 		uint32_t *min_address, uint32_t *max_address)
 {
 	if (argc &lt; 1 || argc &gt; 5)
@@ -2411,7 +2410,7 @@ COMMAND_HANDLER(handle_load_image_command)
 	int i;
 	image_t image;
 
-	int retval = parse_load_image_command_args(cmd_ctx, args, argc,
+	int retval = parse_load_image_command_args(cmd_ctx, cmd, args, argc,
 			&amp;image, &amp;min_address, &amp;max_address);
 	if (ERROR_OK != retval)
 		return retval;
@@ -2555,7 +2554,7 @@ COMMAND_HANDLER(handle_dump_image_command)
 	return retval;
 }
 
-static int handle_verify_image_command_internal(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc, int verify)
+static COMMAND_HELPER(handle_verify_image_command_internal, int verify)
 {
 	uint8_t *buffer;
 	uint32_t buf_cnt;
@@ -4548,7 +4547,7 @@ COMMAND_HANDLER(handle_fast_load_image_command)
 
 	image_t image;
 
-	int retval = parse_load_image_command_args(cmd_ctx, args, argc,
+	int retval = parse_load_image_command_args(cmd_ctx, cmd, args, argc,
 			&amp;image, &amp;min_address, &amp;max_address);
 	if (ERROR_OK != retval)
 		return retval;

commit cfc4d5c6b7b6f8f82dc5bbf3ee661c179814666e
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Mon Nov 9 23:56:52 2009 -0800

    use COMMAND_HANDLER macro to define all commands

diff --git a/src/flash/at91sam3.c b/src/flash/at91sam3.c
index 714e8b8..804a35b 100644
--- a/src/flash/at91sam3.c
+++ b/src/flash/at91sam3.c
@@ -2266,8 +2266,7 @@ sam3_write(struct flash_bank_s *bank,
 	return r;
 }
 
-static int
-sam3_handle_info_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(sam3_handle_info_command)
 {
 	struct sam3_chip *pChip;
 	void *vp;
@@ -2343,8 +2342,7 @@ sam3_handle_info_command(struct command_context_s *cmd_ctx, char *cmd, char **ar
 	return ERROR_OK;
 }
 
-static int
-sam3_handle_gpnvm_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(sam3_handle_gpnvm_command)
 {
 	unsigned x,v;
 	int r,who;
@@ -2437,8 +2435,7 @@ sam3_handle_gpnvm_command(struct command_context_s *cmd_ctx, char *cmd, char **a
 	return r;
 }
 
-static int
-sam3_handle_slowclk_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(sam3_handle_slowclk_command)
 {
 	struct sam3_chip *pChip;
 
diff --git a/src/flash/at91sam7.c b/src/flash/at91sam7.c
index 134c9e5..4cd2705 100644
--- a/src/flash/at91sam7.c
+++ b/src/flash/at91sam7.c
@@ -1098,7 +1098,7 @@ static int at91sam7_info(struct flash_bank_s *bank, char *buf, int buf_size)
 *   The maximum number of write/erase cycles for Non volatile Memory bits is 100. this includes
 *   Lock Bits (LOCKx), General Purpose NVM bits (GPNVMx) and the Security Bit.
 */
-static int at91sam7_handle_gpnvm_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(at91sam7_handle_gpnvm_command)
 {
 	flash_bank_t *bank;
 	int bit;
diff --git a/src/flash/avrf.c b/src/flash/avrf.c
index b045909..6badb2d 100644
--- a/src/flash/avrf.c
+++ b/src/flash/avrf.c
@@ -415,7 +415,7 @@ static int avrf_mass_erase(struct flash_bank_s *bank)
 	return ERROR_OK;
 }
 
-static int avrf_handle_mass_erase_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(avrf_handle_mass_erase_command)
 {
 	int i;
 
diff --git a/src/flash/flash.c b/src/flash/flash.c
index 1a04e12..d3889b9 100644
--- a/src/flash/flash.c
+++ b/src/flash/flash.c
@@ -215,7 +215,7 @@ int flash_command_get_bank_by_num(
 }
 
 
-static int handle_flash_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_flash_bank_command)
 {
 	int retval;
 	int i;
@@ -295,7 +295,7 @@ static int handle_flash_bank_command(struct command_context_s *cmd_ctx, char *cm
 	return ERROR_OK;
 }
 
-static int handle_flash_info_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_flash_info_command)
 {
 	flash_bank_t *p;
 	uint32_t i = 0;
@@ -357,7 +357,7 @@ static int handle_flash_info_command(struct command_context_s *cmd_ctx, char *cm
 	return ERROR_OK;
 }
 
-static int handle_flash_probe_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_flash_probe_command)
 {
 	int retval;
 
@@ -394,7 +394,7 @@ static int handle_flash_probe_command(struct command_context_s *cmd_ctx, char *c
 	return ERROR_OK;
 }
 
-static int handle_flash_erase_check_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_flash_erase_check_command)
 {
 	if (argc != 1)
 	{
@@ -440,7 +440,7 @@ static int handle_flash_erase_check_command(struct command_context_s *cmd_ctx, c
 	return ERROR_OK;
 }
 
-static int handle_flash_erase_address_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_flash_erase_address_command)
 {
 	flash_bank_t *p;
 	int retval;
@@ -484,7 +484,7 @@ static int handle_flash_erase_address_command(struct command_context_s *cmd_ctx,
 	return retval;
 }
 
-static int handle_flash_protect_check_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_flash_protect_check_command)
 {
 	if (argc != 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -528,8 +528,7 @@ static int flash_check_sector_parameters(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_flash_erase_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_flash_erase_command)
 {
 	if (argc != 2)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -569,8 +568,7 @@ static int handle_flash_erase_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_flash_protect_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_flash_protect_command)
 {
 	if (argc != 3)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -614,7 +612,7 @@ static int handle_flash_protect_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_flash_write_image_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_flash_write_image_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 
@@ -704,7 +702,7 @@ static int handle_flash_write_image_command(struct command_context_s *cmd_ctx, c
 	return retval;
 }
 
-static int handle_flash_fill_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_flash_fill_command)
 {
 	int err = ERROR_OK;
 	uint32_t address;
@@ -808,7 +806,7 @@ static int handle_flash_fill_command(struct command_context_s *cmd_ctx, char *cm
 	return ERROR_OK;
 }
 
-static int handle_flash_write_bank_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_flash_write_bank_command)
 {
 	uint32_t offset;
 	uint8_t *buffer;
diff --git a/src/flash/lpc2000.c b/src/flash/lpc2000.c
index e71629e..4d4d9a2 100644
--- a/src/flash/lpc2000.c
+++ b/src/flash/lpc2000.c
@@ -737,7 +737,7 @@ static int lpc2000_info(struct flash_bank_s *bank, char *buf, int buf_size)
 	return ERROR_OK;
 }
 
-static int lpc2000_handle_part_id_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(lpc2000_handle_part_id_command)
 {
 	uint32_t param_table[5];
 	uint32_t result_table[4];
diff --git a/src/flash/lpc2900.c b/src/flash/lpc2900.c
index 379b4e8..945fc9a 100644
--- a/src/flash/lpc2900.c
+++ b/src/flash/lpc2900.c
@@ -531,8 +531,7 @@ static uint32_t lpc2900_calc_tr( uint32_t clock, uint32_t time )
  * Uses the Built-In-Self-Test (BIST) to generate a 128-bit hash value
  * of the flash content.
  */
-static int lpc2900_handle_signature_command( struct command_context_s *cmd_ctx,
-                                             char *cmd, char **args, int argc )
+COMMAND_HANDLER(lpc2900_handle_signature_command)
 {
 	uint32_t status;
 	uint32_t signature[4];
@@ -582,8 +581,7 @@ static int lpc2900_handle_signature_command( struct command_context_s *cmd_ctx,
  * Read customer info from index sector, and store that block of data into
  * a disk file. The format is binary.
  */
-static int lpc2900_handle_read_custom_command( struct command_context_s *cmd_ctx,
-                                               char *cmd, char **args, int argc )
+COMMAND_HANDLER(lpc2900_handle_read_custom_command)
 {
 	if( argc &lt; 2 )
 	{
@@ -654,8 +652,7 @@ static int lpc2900_handle_read_custom_command( struct command_context_s *cmd_ctx
 /**
  * Enter password to enable potentially dangerous options.
  */
-static int lpc2900_handle_password_command(struct command_context_s *cmd_ctx,
-                                           char *cmd, char **args, int argc)
+COMMAND_HANDLER(lpc2900_handle_password_command)
 {
 	if (argc &lt; 2)
 	{
@@ -690,8 +687,7 @@ static int lpc2900_handle_password_command(struct command_context_s *cmd_ctx,
 /**
  * Write customer info from file to the index sector.
  */
-static int lpc2900_handle_write_custom_command( struct command_context_s *cmd_ctx,
-                                                char *cmd, char **args, int argc )
+COMMAND_HANDLER(lpc2900_handle_write_custom_command)
 {
 	if (argc &lt; 2)
 	{
@@ -801,8 +797,7 @@ static int lpc2900_handle_write_custom_command( struct command_context_s *cmd_ct
 /**
  * Activate 'sector security' for a range of sectors.
  */
-static int lpc2900_handle_secure_sector_command(struct command_context_s *cmd_ctx,
-                                                char *cmd, char **args, int argc)
+COMMAND_HANDLER(lpc2900_handle_secure_sector_command)
 {
 	if (argc &lt; 3)
 	{
@@ -901,8 +896,7 @@ static int lpc2900_handle_secure_sector_command(struct command_context_s *cmd_ct
 /**
  * Activate JTAG protection.
  */
-static int lpc2900_handle_secure_jtag_command(struct command_context_s *cmd_ctx,
-                                              char *cmd, char **args, int argc)
+COMMAND_HANDLER(lpc2900_handle_secure_jtag_command)
 {
 	if (argc &lt; 1)
 	{
diff --git a/src/flash/lpc3180_nand_controller.c b/src/flash/lpc3180_nand_controller.c
index f02c880..4b12077 100644
--- a/src/flash/lpc3180_nand_controller.c
+++ b/src/flash/lpc3180_nand_controller.c
@@ -828,7 +828,7 @@ static int lpc3180_nand_ready(struct nand_device_s *nand, int timeout)
 	return 0;
 }
 
-static int handle_lpc3180_select_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_lpc3180_select_command)
 {
 	lpc3180_nand_controller_t *lpc3180_info = NULL;
 	char *selected[] =
diff --git a/src/flash/mflash.c b/src/flash/mflash.c
index 5a392a4..5a9b7c3 100644
--- a/src/flash/mflash.c
+++ b/src/flash/mflash.c
@@ -408,7 +408,7 @@ static int mg_mflash_probe(void)
 	return mg_dsk_drv_info();
 }
 
-static int mg_probe_cmd(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(mg_probe_cmd)
 {
 	int ret;
 
@@ -702,7 +702,7 @@ static int mg_mflash_write(uint32_t addr, uint8_t *buff, uint32_t len)
 	return ret;
 }
 
-static int mg_write_cmd(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(mg_write_cmd)
 {
 	uint32_t address, buf_cnt, cnt, res, i;
 	uint8_t *buffer;
@@ -766,7 +766,7 @@ mg_write_cmd_err:
 	return ret;
 }
 
-static int mg_dump_cmd(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(mg_dump_cmd)
 {
 	uint32_t address, size_written, size, cnt, res, i;
 	uint8_t *buffer;
@@ -1208,8 +1208,7 @@ static int mg_erase_nand(void)
 	return ret;
 }
 
-int mg_config_cmd(struct command_context_s *cmd_ctx, char *cmd,
-		char **args, int argc)
+COMMAND_HANDLER(mg_config_cmd)
 {
 	double fin, fout;
 	mg_pll_t pll;
@@ -1281,7 +1280,7 @@ int mflash_init_drivers(struct command_context_s *cmd_ctx)
 	return ERROR_OK;
 }
 
-static int mg_bank_cmd(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(mg_bank_cmd)
 {
 	target_t *target;
 	int i;
diff --git a/src/flash/nand.c b/src/flash/nand.c
index 4d32d25..181700d 100644
--- a/src/flash/nand.c
+++ b/src/flash/nand.c
@@ -205,7 +205,7 @@ static nand_ecclayout_t nand_oob_64 = {
 
 /* nand device &lt;nand_controller&gt; [controller options]
  */
-static int handle_nand_device_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_nand_device_command)
 {
 	int i;
 	int retval;
@@ -1041,7 +1041,7 @@ int nand_write_page_raw(struct nand_device_s *nand, uint32_t page, uint8_t *data
 	return ERROR_OK;
 }
 
-int handle_nand_list_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_nand_list_command)
 {
 	nand_device_t *p;
 	int i;
@@ -1068,7 +1068,7 @@ int handle_nand_list_command(struct command_context_s *cmd_ctx, char *cmd, char
 	return ERROR_OK;
 }
 
-static int handle_nand_info_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_nand_info_command)
 {
 	int i = 0;
 	int j = 0;
@@ -1143,7 +1143,7 @@ static int handle_nand_info_command(struct command_context_s *cmd_ctx, char *cmd
 	return ERROR_OK;
 }
 
-static int handle_nand_probe_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_nand_probe_command)
 {
 	if (argc != 1)
 	{
@@ -1171,7 +1171,7 @@ static int handle_nand_probe_command(struct command_context_s *cmd_ctx, char *cm
 	return ERROR_OK;
 }
 
-static int handle_nand_erase_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_nand_erase_command)
 {
 	if (argc != 1 &amp;&amp; argc != 3)
 	{
@@ -1227,7 +1227,7 @@ static int handle_nand_erase_command(struct command_context_s *cmd_ctx, char *cm
 	return ERROR_OK;
 }
 
-int handle_nand_check_bad_blocks_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_nand_check_bad_blocks_command)
 {
 	int first = -1;
 	int last = -1;
@@ -1284,7 +1284,7 @@ int handle_nand_check_bad_blocks_command(struct command_context_s *cmd_ctx, char
 	return ERROR_OK;
 }
 
-static int handle_nand_write_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_nand_write_command)
 {
 	uint32_t offset;
 	uint32_t binary_size;
@@ -1451,7 +1451,7 @@ static int handle_nand_write_command(struct command_context_s *cmd_ctx, char *cm
 	return ERROR_OK;
 }
 
-static int handle_nand_dump_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_nand_dump_command)
 {
 	if (argc &lt; 4)
 	{
@@ -1569,7 +1569,7 @@ static int handle_nand_dump_command(struct command_context_s *cmd_ctx, char *cmd
 	return ERROR_OK;
 }
 
-static int handle_nand_raw_access_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_nand_raw_access_command)
 {
 	if ((argc &lt; 1) || (argc &gt; 2))
 	{
diff --git a/src/flash/pic32mx.c b/src/flash/pic32mx.c
index 78ed185..aa34aea 100644
--- a/src/flash/pic32mx.c
+++ b/src/flash/pic32mx.c
@@ -631,7 +631,7 @@ static int pic32mx_auto_probe(struct flash_bank_s *bank)
 }
 
 #if 0
-static int pic32mx_handle_part_id_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(pic32mx_handle_part_id_command)
 {
 	return ERROR_OK;
 }
@@ -672,7 +672,7 @@ static int pic32mx_info(struct flash_bank_s *bank, char *buf, int buf_size)
 }
 
 #if 0
-int pic32mx_handle_lock_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(pic32mx_handle_lock_command)
 {
 	target_t *target = NULL;
 	pic32mx_flash_bank_t *pic32mx_info = NULL;
@@ -718,7 +718,7 @@ int pic32mx_handle_lock_command(struct command_context_s *cmd_ctx, char *cmd, ch
 	return ERROR_OK;
 }
 
-int pic32mx_handle_unlock_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(pic32mx_handle_unlock_command)
 {
 	target_t *target = NULL;
 	pic32mx_flash_bank_t *pic32mx_info = NULL;
@@ -808,7 +808,7 @@ static int pic32mx_chip_erase(struct flash_bank_s *bank)
 }
 #endif
 
-static int pic32mx_handle_chip_erase_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(pic32mx_handle_chip_erase_command)
 {
 #if 0
 	int i;
@@ -843,7 +843,7 @@ static int pic32mx_handle_chip_erase_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int pic32mx_handle_pgm_word_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(pic32mx_handle_pgm_word_command)
 {
 	uint32_t address, value;
 	int status, res;
diff --git a/src/flash/stellaris.c b/src/flash/stellaris.c
index bd561a6..22d5bc4 100644
--- a/src/flash/stellaris.c
+++ b/src/flash/stellaris.c
@@ -1127,7 +1127,7 @@ static int stellaris_mass_erase(struct flash_bank_s *bank)
 	return ERROR_OK;
 }
 
-static int stellaris_handle_mass_erase_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(stellaris_handle_mass_erase_command)
 {
 	int i;
 
diff --git a/src/flash/stm32x.c b/src/flash/stm32x.c
index 2ca5fa9..95d15a9 100644
--- a/src/flash/stm32x.c
+++ b/src/flash/stm32x.c
@@ -780,7 +780,7 @@ static int stm32x_auto_probe(struct flash_bank_s *bank)
 }
 
 #if 0
-static int stm32x_handle_part_id_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(stm32x_handle_part_id_command)
 {
 	return ERROR_OK;
 }
@@ -892,7 +892,7 @@ static int stm32x_info(struct flash_bank_s *bank, char *buf, int buf_size)
 	return ERROR_OK;
 }
 
-static int stm32x_handle_lock_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(stm32x_handle_lock_command)
 {
 	target_t *target = NULL;
 	stm32x_flash_bank_t *stm32x_info = NULL;
@@ -938,7 +938,7 @@ static int stm32x_handle_lock_command(struct command_context_s *cmd_ctx, char *c
 	return ERROR_OK;
 }
 
-static int stm32x_handle_unlock_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(stm32x_handle_unlock_command)
 {
 	target_t *target = NULL;
 	stm32x_flash_bank_t *stm32x_info = NULL;
@@ -981,7 +981,7 @@ static int stm32x_handle_unlock_command(struct command_context_s *cmd_ctx, char
 	return ERROR_OK;
 }
 
-static int stm32x_handle_options_read_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(stm32x_handle_options_read_command)
 {
 	uint32_t optionbyte;
 	target_t *target = NULL;
@@ -1037,7 +1037,7 @@ static int stm32x_handle_options_read_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int stm32x_handle_options_write_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(stm32x_handle_options_write_command)
 {
 	target_t *target = NULL;
 	stm32x_flash_bank_t *stm32x_info = NULL;
@@ -1148,7 +1148,7 @@ static int stm32x_mass_erase(struct flash_bank_s *bank)
 	return ERROR_OK;
 }
 
-static int stm32x_handle_mass_erase_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(stm32x_handle_mass_erase_command)
 {
 	int i;
 
diff --git a/src/flash/str7x.c b/src/flash/str7x.c
index ed107f3..028eab6 100644
--- a/src/flash/str7x.c
+++ b/src/flash/str7x.c
@@ -589,7 +589,7 @@ static int str7x_probe(struct flash_bank_s *bank)
 }
 
 #if 0
-static int str7x_handle_part_id_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(str7x_handle_part_id_command)
 {
 	return ERROR_OK;
 }
@@ -601,7 +601,7 @@ static int str7x_info(struct flash_bank_s *bank, char *buf, int buf_size)
 	return ERROR_OK;
 }
 
-static int str7x_handle_disable_jtag_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(str7x_handle_disable_jtag_command)
 {
 	target_t *target = NULL;
 	str7x_flash_bank_t *str7x_info = NULL;
diff --git a/src/flash/str9x.c b/src/flash/str9x.c
index 893baf5..665c160 100644
--- a/src/flash/str9x.c
+++ b/src/flash/str9x.c
@@ -619,8 +619,7 @@ static int str9x_probe(struct flash_bank_s *bank)
 }
 
 #if 0
-static int str9x_handle_part_id_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(str9x_handle_part_id_command)
 {
 	return ERROR_OK;
 }
@@ -632,8 +631,7 @@ static int str9x_info(struct flash_bank_s *bank, char *buf, int buf_size)
 	return ERROR_OK;
 }
 
-static int str9x_handle_flash_config_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(str9x_handle_flash_config_command)
 {
 	str9x_flash_bank_t *str9x_info;
 	target_t *target = NULL;
diff --git a/src/flash/str9xpec.c b/src/flash/str9xpec.c
index 73b9a1d..3a35ee1 100644
--- a/src/flash/str9xpec.c
+++ b/src/flash/str9xpec.c
@@ -726,7 +726,7 @@ static int str9xpec_probe(struct flash_bank_s *bank)
 	return ERROR_OK;
 }
 
-static int str9xpec_handle_part_id_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(str9xpec_handle_part_id_command)
 {
 	scan_field_t field;
 	uint8_t *buffer = NULL;
@@ -777,7 +777,7 @@ static int str9xpec_info(struct flash_bank_s *bank, char *buf, int buf_size)
 	return ERROR_OK;
 }
 
-static int str9xpec_handle_flash_options_read_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(str9xpec_handle_flash_options_read_command)
 {
 	uint8_t status;
 	str9xpec_flash_controller_t *str9xpec_info = NULL;
@@ -894,7 +894,7 @@ static int str9xpec_write_options(struct flash_bank_s *bank)
 	return status;
 }
 
-static int str9xpec_handle_flash_options_write_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(str9xpec_handle_flash_options_write_command)
 {
 	uint8_t status;
 
@@ -917,7 +917,7 @@ static int str9xpec_handle_flash_options_write_command(struct command_context_s
 	return ERROR_OK;
 }
 
-static int str9xpec_handle_flash_options_cmap_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(str9xpec_handle_flash_options_cmap_command)
 {
 	str9xpec_flash_controller_t *str9xpec_info = NULL;
 
@@ -946,7 +946,7 @@ static int str9xpec_handle_flash_options_cmap_command(struct command_context_s *
 	return ERROR_OK;
 }
 
-static int str9xpec_handle_flash_options_lvdthd_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(str9xpec_handle_flash_options_lvdthd_command)
 {
 	str9xpec_flash_controller_t *str9xpec_info = NULL;
 
@@ -975,7 +975,7 @@ static int str9xpec_handle_flash_options_lvdthd_command(struct command_context_s
 	return ERROR_OK;
 }
 
-int str9xpec_handle_flash_options_lvdsel_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(str9xpec_handle_flash_options_lvdsel_command)
 {
 	str9xpec_flash_controller_t *str9xpec_info = NULL;
 
@@ -1004,7 +1004,7 @@ int str9xpec_handle_flash_options_lvdsel_command(struct command_context_s *cmd_c
 	return ERROR_OK;
 }
 
-static int str9xpec_handle_flash_options_lvdwarn_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(str9xpec_handle_flash_options_lvdwarn_command)
 {
 	str9xpec_flash_controller_t *str9xpec_info = NULL;
 
@@ -1033,7 +1033,7 @@ static int str9xpec_handle_flash_options_lvdwarn_command(struct command_context_
 	return ERROR_OK;
 }
 
-static int str9xpec_handle_flash_lock_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(str9xpec_handle_flash_lock_command)
 {
 	uint8_t status;
 
@@ -1056,7 +1056,7 @@ static int str9xpec_handle_flash_lock_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int str9xpec_handle_flash_unlock_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(str9xpec_handle_flash_unlock_command)
 {
 	uint8_t status;
 
@@ -1079,7 +1079,7 @@ static int str9xpec_handle_flash_unlock_command(struct command_context_s *cmd_ct
 	return ERROR_OK;
 }
 
-static int str9xpec_handle_flash_enable_turbo_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(str9xpec_handle_flash_enable_turbo_command)
 {
 	jtag_tap_t *tap0;
 	jtag_tap_t *tap1;
@@ -1128,7 +1128,7 @@ static int str9xpec_handle_flash_enable_turbo_command(struct command_context_s *
 	return ERROR_OK;
 }
 
-static int str9xpec_handle_flash_disable_turbo_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(str9xpec_handle_flash_disable_turbo_command)
 {
 	jtag_tap_t *tap;
 	str9xpec_flash_controller_t *str9xpec_info = NULL;
diff --git a/src/flash/tms470.c b/src/flash/tms470.c
index 1348697..53043cd 100644
--- a/src/flash/tms470.c
+++ b/src/flash/tms470.c
@@ -289,7 +289,7 @@ static int tms470_read_part_info(struct flash_bank_s *bank)
 static uint32_t keysSet = 0;
 static uint32_t flashKeys[4];
 
-static int tms470_handle_flash_keyset_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(tms470_handle_flash_keyset_command)
 {
 	if (argc &gt; 4)
 	{
@@ -353,7 +353,7 @@ static const uint32_t FLASH_KEYS_MIX2[] = { 0x0000ffff, 0x0000ffff,
 
 static int oscMHz = 12;
 
-static int tms470_handle_osc_megahertz_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(tms470_handle_osc_megahertz_command)
 {
 	if (argc &gt; 1)
 	{
@@ -382,7 +382,7 @@ static int tms470_handle_osc_megahertz_command(struct command_context_s *cmd_ctx
 
 static int plldis = 0;
 
-static int tms470_handle_plldis_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(tms470_handle_plldis_command)
 {
 	if (argc &gt; 1)
 	{
diff --git a/src/helper/command.c b/src/helper/command.c
index e467be0..4ce5085 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -716,8 +716,7 @@ static int jim_capture(Jim_Interp *interp, int argc, Jim_Obj *const *argv)
 /* sleep command sleeps for &lt;n&gt; miliseconds
  * this is useful in target startup scripts
  */
-static int handle_sleep_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_sleep_command)
 {
 	bool busy = false;
 	if (argc == 2)
@@ -750,7 +749,7 @@ static int handle_sleep_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_fast_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_fast_command)
 {
 	if (argc != 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
diff --git a/src/helper/ioutil.c b/src/helper/ioutil.c
index b3171bc..1423462 100644
--- a/src/helper/ioutil.c
+++ b/src/helper/ioutil.c
@@ -57,8 +57,7 @@
 #endif
 
 
-int handle_rm_command(struct command_context_s *cmd_ctx, char *cmd,
-		char **args, int argc)
+COMMAND_HANDLER(handle_rm_command)
 {
 	if (argc != 1)
 	{
@@ -134,10 +133,7 @@ int loadFile(const char *fileName, void **data, size_t *len)
 	return ERROR_OK;
 }
 
-
-
-int handle_cat_command(struct command_context_s *cmd_ctx, char *cmd,
-		char **args, int argc)
+COMMAND_HANDLER(handle_cat_command)
 {
 	if (argc != 1)
 	{
@@ -162,8 +158,8 @@ int handle_cat_command(struct command_context_s *cmd_ctx, char *cmd,
 
 	return ERROR_OK;
 }
-int handle_trunc_command(struct command_context_s *cmd_ctx, char *cmd,
-		char **args, int argc)
+
+COMMAND_HANDLER(handle_trunc_command)
 {
 	if (argc != 1)
 	{
@@ -179,8 +175,7 @@ int handle_trunc_command(struct command_context_s *cmd_ctx, char *cmd,
 	return ERROR_OK;
 }
 
-
-int handle_meminfo_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_meminfo_command)
 {
 	static int prev = 0;
 	struct mallinfo info;
@@ -205,8 +200,7 @@ int handle_meminfo_command(struct command_context_s *cmd_ctx, char *cmd, char **
 }
 
 
-int handle_append_command(struct command_context_s *cmd_ctx, char *cmd,
-		char **args, int argc)
+COMMAND_HANDLER(handle_append_command)
 {
 	if (argc &lt; 1)
 	{
@@ -245,7 +239,7 @@ int handle_append_command(struct command_context_s *cmd_ctx, char *cmd,
 
 
 
-int handle_cp_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_cp_command)
 {
 	if (argc != 2)
 	{
diff --git a/src/helper/log.c b/src/helper/log.c
index a8b519a..ccc0c01 100644
--- a/src/helper/log.c
+++ b/src/helper/log.c
@@ -274,7 +274,7 @@ void log_printf_lf(enum log_levels level, const char *file, int line, const char
  * 2: + INFORMATIONAL MSGS
  * 3: + DEBUG MSGS
  */
-int handle_debug_level_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_debug_level_command)
 {
 	if (argc == 1)
 	{
@@ -302,7 +302,7 @@ int handle_debug_level_command(struct command_context_s *cmd_ctx, char *cmd, cha
 	return ERROR_OK;
 }
 
-int handle_log_output_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_log_output_command)
 {
 	if (argc == 1)
 	{
diff --git a/src/jtag/amt_jtagaccel.c b/src/jtag/amt_jtagaccel.c
index abfaadc..a34387f 100644
--- a/src/jtag/amt_jtagaccel.c
+++ b/src/jtag/amt_jtagaccel.c
@@ -495,8 +495,7 @@ static int amt_jtagaccel_quit(void)
 	return ERROR_OK;
 }
 
-static int amt_jtagaccel_handle_parport_port_command(
-		struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(amt_jtagaccel_handle_parport_port_command)
 {
 	if (argc == 1)
 	{
@@ -519,7 +518,7 @@ static int amt_jtagaccel_handle_parport_port_command(
 	return ERROR_OK;
 }
 
-static int amt_jtagaccel_handle_rtck_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(amt_jtagaccel_handle_rtck_command)
 {
 	if (argc == 0)
 	{
diff --git a/src/jtag/ft2232.c b/src/jtag/ft2232.c
index 243479d..6d23356 100644
--- a/src/jtag/ft2232.c
+++ b/src/jtag/ft2232.c
@@ -2798,7 +2798,7 @@ static int ft2232_quit(void)
 	return ERROR_OK;
 }
 
-static int ft2232_handle_device_desc_command(struct command_context_s* cmd_ctx, char* cmd, char** args, int argc)
+COMMAND_HANDLER(ft2232_handle_device_desc_command)
 {
 	char *cp;
 	char buf[200];
@@ -2832,7 +2832,7 @@ static int ft2232_handle_device_desc_command(struct command_context_s* cmd_ctx,
 	return ERROR_OK;
 }
 
-static int ft2232_handle_serial_command(struct command_context_s* cmd_ctx, char* cmd, char** args, int argc)
+COMMAND_HANDLER(ft2232_handle_serial_command)
 {
 	if (argc == 1)
 	{
@@ -2846,7 +2846,7 @@ static int ft2232_handle_serial_command(struct command_context_s* cmd_ctx, char*
 	return ERROR_OK;
 }
 
-static int ft2232_handle_layout_command(struct command_context_s* cmd_ctx, char* cmd, char** args, int argc)
+COMMAND_HANDLER(ft2232_handle_layout_command)
 {
 	if (argc == 0)
 		return ERROR_OK;
@@ -2857,7 +2857,7 @@ static int ft2232_handle_layout_command(struct command_context_s* cmd_ctx, char*
 	return ERROR_OK;
 }
 
-static int ft2232_handle_vid_pid_command(struct command_context_s* cmd_ctx, char* cmd, char** args, int argc)
+COMMAND_HANDLER(ft2232_handle_vid_pid_command)
 {
 	if (argc &gt; MAX_USB_IDS * 2)
 	{
@@ -2891,7 +2891,7 @@ static int ft2232_handle_vid_pid_command(struct command_context_s* cmd_ctx, char
 	return retval;
 }
 
-static int ft2232_handle_latency_command(struct command_context_s* cmd_ctx, char* cmd, char** args, int argc)
+COMMAND_HANDLER(ft2232_handle_latency_command)
 {
 	if (argc == 1)
 	{
diff --git a/src/jtag/gw16012.c b/src/jtag/gw16012.c
index 35473ab..07188f4 100644
--- a/src/jtag/gw16012.c
+++ b/src/jtag/gw16012.c
@@ -541,7 +541,7 @@ static int gw16012_quit(void)
 	return ERROR_OK;
 }
 
-static int gw16012_handle_parport_port_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(gw16012_handle_parport_port_command)
 {
 	if (argc == 1)
 	{
diff --git a/src/jtag/parport.c b/src/jtag/parport.c
index 9b20290..cee7a16 100644
--- a/src/jtag/parport.c
+++ b/src/jtag/parport.c
@@ -410,7 +410,7 @@ static int parport_quit(void)
 	return ERROR_OK;
 }
 
-static int parport_handle_parport_port_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(parport_handle_parport_port_command)
 {
 	if (argc == 1)
 	{
@@ -431,7 +431,7 @@ static int parport_handle_parport_port_command(struct command_context_s *cmd_ctx
 	return ERROR_OK;
 }
 
-static int parport_handle_parport_cable_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(parport_handle_parport_cable_command)
 {
 	if (argc == 0)
 		return ERROR_OK;
@@ -446,7 +446,7 @@ static int parport_handle_parport_cable_command(struct command_context_s *cmd_ct
 	return ERROR_OK;
 }
 
-static int parport_handle_write_on_exit_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(parport_handle_write_on_exit_command)
 {
 	if (argc != 1)
 	{
diff --git a/src/jtag/presto.c b/src/jtag/presto.c
index 0972223..8789bed 100644
--- a/src/jtag/presto.c
+++ b/src/jtag/presto.c
@@ -752,7 +752,7 @@ static int presto_jtag_speed(int speed)
 
 static char *presto_serial;
 
-static int presto_handle_serial_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(presto_handle_serial_command)
 {
 	if (argc == 1)
 	{
diff --git a/src/jtag/tcl.c b/src/jtag/tcl.c
index b86e006..653d3a7 100644
--- a/src/jtag/tcl.c
+++ b/src/jtag/tcl.c
@@ -603,8 +603,7 @@ static int default_srst_asserted(int *srst_asserted)
 	return ERROR_OK;
 }
 
-static int handle_interface_list_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_interface_list_command)
 {
 	if (strcmp(cmd, &quot;interface_list&quot;) == 0 &amp;&amp; argc &gt; 0)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -619,8 +618,7 @@ static int handle_interface_list_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_interface_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_interface_command)
 {
 	/* check whether the interface is already configured */
 	if (jtag_interface)
@@ -664,7 +662,7 @@ static int handle_interface_command(struct command_context_s *cmd_ctx,
 	return ERROR_JTAG_INVALID_INTERFACE;
 }
 
-static int handle_scan_chain_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_scan_chain_command)
 {
 	jtag_tap_t *tap;
 
@@ -701,7 +699,7 @@ static int handle_scan_chain_command(struct command_context_s *cmd_ctx, char *cm
 	return ERROR_OK;
 }
 
-static int handle_reset_config_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_reset_config_command)
 {
 	int new_cfg = 0;
 	int mask = 0;
@@ -897,8 +895,7 @@ next:
 	return ERROR_OK;
 }
 
-static int handle_jtag_nsrst_delay_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_jtag_nsrst_delay_command)
 {
 	if (argc &gt; 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -913,8 +910,7 @@ static int handle_jtag_nsrst_delay_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_jtag_ntrst_delay_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_jtag_ntrst_delay_command)
 {
 	if (argc &gt; 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -929,8 +925,7 @@ static int handle_jtag_ntrst_delay_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_jtag_nsrst_assert_width_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_jtag_nsrst_assert_width_command)
 {
 	if (argc &gt; 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -945,8 +940,7 @@ static int handle_jtag_nsrst_assert_width_command(struct command_context_s *cmd_
 	return ERROR_OK;
 }
 
-static int handle_jtag_ntrst_assert_width_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_jtag_ntrst_assert_width_command)
 {
 	if (argc &gt; 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -961,7 +955,7 @@ static int handle_jtag_ntrst_assert_width_command(struct command_context_s *cmd_
 	return ERROR_OK;
 }
 
-static int handle_jtag_khz_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_jtag_khz_command)
 {
 	if (argc &gt; 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -990,7 +984,7 @@ static int handle_jtag_khz_command(struct command_context_s *cmd_ctx, char *cmd,
 	return retval;
 }
 
-static int handle_jtag_rclk_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_jtag_rclk_command)
 {
 	if (argc &gt; 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -1019,8 +1013,7 @@ static int handle_jtag_rclk_command(struct command_context_s *cmd_ctx, char *cmd
 	return retval;
 }
 
-static int handle_jtag_reset_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_jtag_reset_command)
 {
 	if (argc != 2)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -1048,8 +1041,7 @@ static int handle_jtag_reset_command(struct command_context_s *cmd_ctx,
 	return jtag_execute_queue();
 }
 
-static int handle_runtest_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_runtest_command)
 {
 	if (argc != 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -1083,7 +1075,7 @@ static bool scan_is_safe(tap_state_t state)
 }
 
 
-static int handle_irscan_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_irscan_command)
 {
 	int i;
 	scan_field_t *fields;
@@ -1358,7 +1350,7 @@ static int Jim_Command_flush_count(Jim_Interp *interp, int argc, Jim_Obj *const
 }
 
 
-static int handle_verify_ircapture_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_verify_ircapture_command)
 {
 	if (argc &gt; 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -1379,7 +1371,7 @@ static int handle_verify_ircapture_command(struct command_context_s *cmd_ctx, ch
 	return ERROR_OK;
 }
 
-static int handle_verify_jtag_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_verify_jtag_command)
 {
 	if (argc &gt; 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -1400,7 +1392,7 @@ static int handle_verify_jtag_command(struct command_context_s *cmd_ctx, char *c
 	return ERROR_OK;
 }
 
-static int handle_tms_sequence_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_tms_sequence_command)
 {
 	if (argc &gt; 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
diff --git a/src/jtag/vsllink.c b/src/jtag/vsllink.c
index b008467..decca16 100644
--- a/src/jtag/vsllink.c
+++ b/src/jtag/vsllink.c
@@ -1325,7 +1325,7 @@ static void vsllink_simple_command(uint8_t command)
 	}
 }
 
-static int vsllink_handle_mode_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(vsllink_handle_mode_command)
 {
 	if (argc != 1) {
 		LOG_ERROR(&quot;parameter error, should be one parameter for VID&quot;);
@@ -1349,7 +1349,7 @@ static int vsllink_handle_mode_command(struct command_context_s *cmd_ctx, char *
 	return ERROR_OK;
 }
 
-static int vsllink_handle_usb_vid_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(vsllink_handle_usb_vid_command)
 {
 	if (argc != 1)
 	{
@@ -1361,7 +1361,7 @@ static int vsllink_handle_usb_vid_command(struct command_context_s *cmd_ctx, cha
 	return ERROR_OK;
 }
 
-static int vsllink_handle_usb_pid_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(vsllink_handle_usb_pid_command)
 {
 	if (argc != 1)
 	{
@@ -1372,7 +1372,7 @@ static int vsllink_handle_usb_pid_command(struct command_context_s *cmd_ctx, cha
 	return ERROR_OK;
 }
 
-static int vsllink_handle_usb_bulkin_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(vsllink_handle_usb_bulkin_command)
 {
 	if (argc != 1)
 	{
@@ -1387,7 +1387,7 @@ static int vsllink_handle_usb_bulkin_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int vsllink_handle_usb_bulkout_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(vsllink_handle_usb_bulkout_command)
 {
 	if (argc != 1)
 	{
@@ -1402,7 +1402,7 @@ static int vsllink_handle_usb_bulkout_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int vsllink_handle_usb_interface_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(vsllink_handle_usb_interface_command)
 {
 	if (argc != 1)
 	{
diff --git a/src/openocd.c b/src/openocd.c
index 7384065..2a74a46 100644
--- a/src/openocd.c
+++ b/src/openocd.c
@@ -67,7 +67,7 @@ static void print_version(void)
 }
 
 /* Give TELNET a way to find out what version this is */
-static int handle_version_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_version_command)
 {
 	if (argc != 0)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -109,7 +109,7 @@ static int log_target_callback_event_handler(struct target_s *target, enum targe
 int ioutil_init(struct command_context_s *cmd_ctx);
 
 /* OpenOCD can't really handle failure of this command. Patches welcome! :-) */
-static int handle_init_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_init_command)
 {
 
 	if (argc != 0)
diff --git a/src/pld/pld.c b/src/pld/pld.c
index df7e2fd..c20b936 100644
--- a/src/pld/pld.c
+++ b/src/pld/pld.c
@@ -57,8 +57,7 @@ pld_device_t *get_pld_device_by_num(int num)
 
 /* pld device &lt;driver&gt; [driver_options ...]
  */
-static int handle_pld_device_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_pld_device_command)
 {
 	int i;
 	int found = 0;
@@ -120,8 +119,7 @@ static int handle_pld_device_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_pld_devices_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_pld_devices_command)
 {
 	pld_device_t *p;
 	int i = 0;
@@ -140,8 +138,7 @@ static int handle_pld_devices_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_pld_load_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_pld_load_command)
 {
 	int retval;
 	struct timeval start, end, duration;
diff --git a/src/pld/virtex2.c b/src/pld/virtex2.c
index fa64650..3c6d61f 100644
--- a/src/pld/virtex2.c
+++ b/src/pld/virtex2.c
@@ -177,8 +177,7 @@ static int virtex2_load(struct pld_device_s *pld_device, const char *filename)
 	return ERROR_OK;
 }
 
-static int virtex2_handle_read_stat_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(virtex2_handle_read_stat_command)
 {
 	pld_device_t *device;
 	virtex2_pld_device_t *virtex2_info;
diff --git a/src/server/gdb_server.c b/src/server/gdb_server.c
index 21b58d0..c0c5d77 100644
--- a/src/server/gdb_server.c
+++ b/src/server/gdb_server.c
@@ -2249,7 +2249,7 @@ int gdb_init(void)
 	return ERROR_OK;
 }
 
-static int handle_gdb_sync_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_gdb_sync_command)
 {
 	if (argc != 0)
 	{
@@ -2269,12 +2269,12 @@ static int handle_gdb_sync_command(struct command_context_s *cmd_ctx, char *cmd,
 }
 
 /* daemon configuration command gdb_port */
-static int handle_gdb_port_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_gdb_port_command)
 {
 	return server_port_command(cmd_ctx, cmd, args, argc, &amp;gdb_port);
 }
 
-static int handle_gdb_memory_map_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_gdb_memory_map_command)
 {
 	if (argc == 1)
 	{
@@ -2295,7 +2295,7 @@ static int handle_gdb_memory_map_command(struct command_context_s *cmd_ctx, char
 	return ERROR_COMMAND_SYNTAX_ERROR;
 }
 
-static int handle_gdb_flash_program_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_gdb_flash_program_command)
 {
 	if (argc == 1)
 	{
@@ -2316,7 +2316,7 @@ static int handle_gdb_flash_program_command(struct command_context_s *cmd_ctx, c
 	return ERROR_COMMAND_SYNTAX_ERROR;
 }
 
-static int handle_gdb_report_data_abort_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_gdb_report_data_abort_command)
 {
 	if (argc == 1)
 	{
@@ -2338,7 +2338,7 @@ static int handle_gdb_report_data_abort_command(struct command_context_s *cmd_ct
 }
 
 /* gdb_breakpoint_override */
-static int handle_gdb_breakpoint_override_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_gdb_breakpoint_override_command)
 {
 	if (argc == 0)
 	{
diff --git a/src/server/server.c b/src/server/server.c
index 0501869..c000b7c 100644
--- a/src/server/server.c
+++ b/src/server/server.c
@@ -534,8 +534,7 @@ int server_quit(void)
 }
 
 /* tell the server we want to shut down */
-static int handle_shutdown_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_shutdown_command)
 {
 	shutdown_openocd = 1;
 
diff --git a/src/server/tcl_server.c b/src/server/tcl_server.c
index 2e93e36..3410ca9 100644
--- a/src/server/tcl_server.c
+++ b/src/server/tcl_server.c
@@ -170,8 +170,7 @@ int tcl_init(void)
 	return retval;
 }
 
-static int handle_tcl_port_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_tcl_port_command)
 {
 	return server_port_command(cmd_ctx, cmd, args, argc, &amp;tcl_port);
 }
diff --git a/src/server/telnet_server.c b/src/server/telnet_server.c
index b77deff..c409ec0 100644
--- a/src/server/telnet_server.c
+++ b/src/server/telnet_server.c
@@ -606,14 +606,12 @@ int telnet_init(char *banner)
 }
 
 /* daemon confi
guration command telnet_port */
-static int handle_telnet_port_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_telnet_port_command)
 {
 	return server_port_command(cmd_ctx, cmd, args, argc, &amp;telnet_port);
 }
 
-static int handle_exit_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_exit_command)
 {
 	return ERROR_COMMAND_CLOSE_CONNECTION;
 }
diff --git a/src/svf/svf.c b/src/svf/svf.c
index ba6ed1b..76b0670 100644
--- a/src/svf/svf.c
+++ b/src/svf/svf.c
@@ -301,7 +301,7 @@ int svf_add_statemove(tap_state_t state_to)
 	return ERROR_FAIL;
 }
 
-static int handle_svf_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_svf_command)
 {
 #define SVF_NUM_OF_OPTIONS			1
 	int command_num = 0, i;
diff --git a/src/target/arm11.c b/src/target/arm11.c
index fe39d6e..098b0af 100644
--- a/src/target/arm11.c
+++ b/src/target/arm11.c
@@ -2028,7 +2028,7 @@ static int arm11_handle_bool(struct command_context_s *cmd_ctx,
 }
 
 #define BOOL_WRAPPER(name, print_name)	\
-static int arm11_handle_bool_##name(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc) \
+COMMAND_HANDLER(arm11_handle_bool_##name) \
 { \
 	return arm11_handle_bool(cmd_ctx, cmd, args, argc, &amp;arm11_config_##name, print_name); \
 }
@@ -2038,7 +2038,7 @@ BOOL_WRAPPER(memwrite_error_fatal,		&quot;fatal error mode for memory writes&quot;)
 BOOL_WRAPPER(step_irq_enable,			&quot;IRQs while stepping&quot;)
 BOOL_WRAPPER(hardware_step,			&quot;hardware single step&quot;)
 
-static int arm11_handle_vcr(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(arm11_handle_vcr)
 {
 	switch (argc) {
 	case 0:
@@ -2185,17 +2185,16 @@ static int arm11_handle_etm_read_write(struct command_context_s *cmd_ctx, char *
 	return ERROR_OK;
 }
 
-int arm11_handle_etmr(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(arm11_handle_etmr)
 {
 	return arm11_handle_etm_read_write(cmd_ctx, cmd, args, argc, true);
 }
 
-int arm11_handle_etmw(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(arm11_handle_etmw)
 {
 	return arm11_handle_etm_read_write(cmd_ctx, cmd, args, argc, false);
 }
 
-
 #define ARM11_HANDLER(x)	.x = arm11_##x
 
 target_type_t arm11_target = {
diff --git a/src/target/arm720t.c b/src/target/arm720t.c
index 6ce7980..6a5a4e7 100644
--- a/src/target/arm720t.c
+++ b/src/target/arm720t.c
@@ -409,8 +409,7 @@ static int arm720t_target_create(struct target_s *target, Jim_Interp *interp)
 	return arm720t_init_arch_info(target, arm720t, target-&gt;tap);
 }
 
-static int arm720t_handle_cp15_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(arm720t_handle_cp15_command)
 {
 	int retval;
 	target_t *target = get_current_target(cmd_ctx);
diff --git a/src/target/arm7_9_common.c b/src/target/arm7_9_common.c
index b6606a1..6a56417 100644
--- a/src/target/arm7_9_common.c
+++ b/src/target/arm7_9_common.c
@@ -2871,7 +2871,7 @@ int arm7_9_blank_check_memory(struct target_s *target, uint32_t address, uint32_
 	return ERROR_OK;
 }
 
-int handle_arm7_9_write_xpsr_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_arm7_9_write_xpsr_command)
 {
 	uint32_t value;
 	int spsr;
@@ -2915,7 +2915,7 @@ int handle_arm7_9_write_xpsr_command(struct command_context_s *cmd_ctx, char *cm
 	return ERROR_OK;
 }
 
-int handle_arm7_9_write_xpsr_im8_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_arm7_9_write_xpsr_im8_command)
 {
 	uint32_t value;
 	int rotate;
@@ -2957,7 +2957,7 @@ int handle_arm7_9_write_xpsr_im8_command(struct command_context_s *cmd_ctx, char
 	return ERROR_OK;
 }
 
-int handle_arm7_9_write_core_reg_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_arm7_9_write_core_reg_command)
 {
 	uint32_t value;
 	uint32_t mode;
@@ -2991,7 +2991,7 @@ int handle_arm7_9_write_core_reg_command(struct command_context_s *cmd_ctx, char
 	return arm7_9_write_core_reg(target, num, mode, value);
 }
 
-int handle_arm7_9_dbgrq_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_arm7_9_dbgrq_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	armv4_5_common_t *armv4_5;
@@ -3024,7 +3024,7 @@ int handle_arm7_9_dbgrq_command(struct command_context_s *cmd_ctx, char *cmd, ch
 	return ERROR_OK;
 }
 
-int handle_arm7_9_fast_memory_access_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_arm7_9_fast_memory_access_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	armv4_5_common_t *armv4_5;
@@ -3057,7 +3057,7 @@ int handle_arm7_9_fast_memory_access_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-int handle_arm7_9_dcc_downloads_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_arm7_9_dcc_downloads_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	armv4_5_common_t *armv4_5;
diff --git a/src/target/arm920t.c b/src/target/arm920t.c
index e043aee..5576f60 100644
--- a/src/target/arm920t.c
+++ b/src/target/arm920t.c
@@ -662,8 +662,7 @@ static int arm920t_target_create(struct target_s *target, Jim_Interp *interp)
 	return arm920t_init_arch_info(target, arm920t, target-&gt;tap);
 }
 
-static int arm920t_handle_read_cache_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(arm920t_handle_read_cache_command)
 {
 	int retval = ERROR_OK;
 	target_t *target = get_current_target(cmd_ctx);
@@ -909,8 +908,7 @@ static int arm920t_handle_read_cache_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int arm920t_handle_read_mmu_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(arm920t_handle_read_mmu_command)
 {
 	int retval = ERROR_OK;
 	target_t *target = get_current_target(cmd_ctx);
@@ -1193,8 +1191,7 @@ static int arm920t_handle_read_mmu_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int arm920t_handle_cp15_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(arm920t_handle_cp15_command)
 {
 	int retval;
 	target_t *target = get_current_target(cmd_ctx);
@@ -1247,8 +1244,7 @@ static int arm920t_handle_cp15_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int arm920t_handle_cp15i_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(arm920t_handle_cp15i_command)
 {
 	int retval;
 	target_t *target = get_current_target(cmd_ctx);
@@ -1315,8 +1311,7 @@ static int arm920t_handle_cp15i_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int arm920t_handle_cache_info_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(arm920t_handle_cache_info_command)
 {
 	int retval;
 	target_t *target = get_current_target(cmd_ctx);
diff --git a/src/target/arm926ejs.c b/src/target/arm926ejs.c
index 316f127..6f347d8 100644
--- a/src/target/arm926ejs.c
+++ b/src/target/arm926ejs.c
@@ -713,8 +713,7 @@ static int arm926ejs_target_create(struct target_s *target, Jim_Interp *interp)
 	return arm926ejs_init_arch_info(target, arm926ejs, target-&gt;tap);
 }
 
-static int arm926ejs_handle_cp15_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(arm926ejs_handle_cp15_command)
 {
 	int retval;
 	target_t *target = get_current_target(cmd_ctx);
@@ -775,9 +774,7 @@ static int arm926ejs_handle_cp15_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int
-arm926ejs_handle_cache_info_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(arm926ejs_handle_cache_info_command)
 {
 	int retval;
 	target_t *target = get_current_target(cmd_ctx);
diff --git a/src/target/arm966e.c b/src/target/arm966e.c
index 5b464ef..e61943a 100644
--- a/src/target/arm966e.c
+++ b/src/target/arm966e.c
@@ -162,8 +162,7 @@ int arm966e_write_cp15(target_t *target, int reg_addr, uint32_t value)
 	return ERROR_OK;
 }
 
-static int arm966e_handle_cp15_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(arm966e_handle_cp15_command)
 {
 	int retval;
 	target_t *target = get_current_target(cmd_ctx);
diff --git a/src/target/arm9tdmi.c b/src/target/arm9tdmi.c
index 58b8efd..112ec2a 100644
--- a/src/target/arm9tdmi.c
+++ b/src/target/arm9tdmi.c
@@ -856,8 +856,7 @@ static int arm9tdmi_target_create(struct target_s *target, Jim_Interp *interp)
 	return ERROR_OK;
 }
 
-static int handle_arm9tdmi_catch_vectors_command(
-	struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_arm9tdmi_catch_vectors_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct arm7_9_common_s *arm7_9 = target_to_arm7_9(target);
diff --git a/src/target/armv4_5.c b/src/target/armv4_5.c
index 0fe9ee4..c0a9c8a 100644
--- a/src/target/armv4_5.c
+++ b/src/target/armv4_5.c
@@ -307,7 +307,7 @@ int armv4_5_arch_state(struct target_s *target)
 	return ERROR_OK;
 }
 
-int handle_armv4_5_reg_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_armv4_5_reg_command)
 {
 	char output[128];
 	int output_len;
@@ -359,7 +359,7 @@ int handle_armv4_5_reg_command(struct command_context_s *cmd_ctx, char *cmd, cha
 	return ERROR_OK;
 }
 
-int handle_armv4_5_core_state_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_armv4_5_core_state_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
@@ -387,9 +387,7 @@ int handle_armv4_5_core_state_command(struct command_context_s *cmd_ctx, char *c
 	return ERROR_OK;
 }
 
-static int
-handle_armv4_5_disassemble_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_armv4_5_disassemble_command)
 {
 	int retval = ERROR_OK;
 	target_t *target = get_current_target(cmd_ctx);
diff --git a/src/target/armv7a.c b/src/target/armv7a.c
index 6dfbb16..f067926 100644
--- a/src/target/armv7a.c
+++ b/src/target/armv7a.c
@@ -230,8 +230,7 @@ int armv7a_arch_state(struct target_s *target)
 }
 
 
-static int handle_dap_baseaddr_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_dap_baseaddr_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct armv7a_common_s *armv7a = target_to_armv7a(target);
@@ -240,8 +239,7 @@ static int handle_dap_baseaddr_command(struct command_context_s *cmd_ctx,
 	return dap_baseaddr_command(cmd_ctx, swjdp, args, argc);
 }
 
-static int handle_dap_memaccess_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_dap_memaccess_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct armv7a_common_s *armv7a = target_to_armv7a(target);
@@ -250,8 +248,7 @@ static int handle_dap_memaccess_command(struct command_context_s *cmd_ctx,
 	return dap_memaccess_command(cmd_ctx, swjdp, args, argc);
 }
 
-static int handle_dap_apsel_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_dap_apsel_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct armv7a_common_s *armv7a = target_to_armv7a(target);
@@ -260,8 +257,7 @@ static int handle_dap_apsel_command(struct command_context_s *cmd_ctx,
 	return dap_apsel_command(cmd_ctx, swjdp, args, argc);
 }
 
-static int handle_dap_apid_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_dap_apid_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct armv7a_common_s *armv7a = target_to_armv7a(target);
@@ -270,8 +266,7 @@ static int handle_dap_apid_command(struct command_context_s *cmd_ctx,
 	return dap_apid_command(cmd_ctx, swjdp, args, argc);
 }
 
-static int handle_dap_info_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_dap_info_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct armv7a_common_s *armv7a = target_to_armv7a(target);
@@ -292,9 +287,7 @@ static int handle_dap_info_command(struct command_context_s *cmd_ctx,
 	return dap_info_command(cmd_ctx, swjdp, apsel);
 }
 
-static int
-handle_armv7a_disassemble_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_armv7a_disassemble_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct armv4_5_common_s *armv4_5 = target_to_armv4_5(target);
diff --git a/src/target/armv7m.c b/src/target/armv7m.c
index 0fcee31..f6de5e1 100644
--- a/src/target/armv7m.c
+++ b/src/target/armv7m.c
@@ -745,8 +745,7 @@ int armv7m_blank_check_memory(struct target_s *target,
  * Return the debug ap baseaddress in hexadecimal;
  * no extra output to simplify script processing
  */
-static int handle_dap_baseaddr_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_dap_baseaddr_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct armv7m_common_s *armv7m = target_to_armv7m(target);
@@ -783,8 +782,7 @@ static int handle_dap_baseaddr_command(struct command_context_s *cmd_ctx,
  * Return the debug ap id in hexadecimal;
  * no extra output to simplify script processing
  */
-static int handle_dap_apid_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_dap_apid_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct armv7m_common_s *armv7m = target_to_armv7m(target);
@@ -793,8 +791,7 @@ static int handle_dap_apid_command(struct command_context_s *cmd_ctx,
 	return dap_apid_command(cmd_ctx, swjdp, args, argc);
 }
 
-static int handle_dap_apsel_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_dap_apsel_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct armv7m_common_s *armv7m = target_to_armv7m(target);
@@ -803,8 +800,7 @@ static int handle_dap_apsel_command(struct command_context_s *cmd_ctx,
 	return dap_apsel_command(cmd_ctx, swjdp, args, argc);
 }
 
-static int handle_dap_memaccess_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_dap_memaccess_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct armv7m_common_s *armv7m = target_to_armv7m(target);
@@ -814,8 +810,7 @@ static int handle_dap_memaccess_command(struct command_context_s *cmd_ctx,
 }
 
 
-static int handle_dap_info_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_dap_info_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct armv7m_common_s *armv7m = target_to_armv7m(target);
diff --git a/src/target/cortex_a8.c b/src/target/cortex_a8.c
index 667c582..3ce861c 100644
--- a/src/target/cortex_a8.c
+++ b/src/target/cortex_a8.c
@@ -1526,8 +1526,7 @@ static int cortex_a8_target_create(struct target_s *target, Jim_Interp *interp)
 	return ERROR_OK;
 }
 
-static int cortex_a8_handle_cache_info_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(cortex_a8_handle_cache_info_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct armv7a_common_s *armv7a = target_to_armv7a(target);
@@ -1537,8 +1536,7 @@ static int cortex_a8_handle_cache_info_command(struct command_context_s *cmd_ctx
 }
 
 
-static int cortex_a8_handle_dbginit_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(cortex_a8_handle_dbginit_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 
diff --git a/src/target/cortex_m3.c b/src/target/cortex_m3.c
index 6c95b4e..5084231 100644
--- a/src/target/cortex_m3.c
+++ b/src/target/cortex_m3.c
@@ -1781,9 +1781,7 @@ static int cortex_m3_verify_pointer(struct command_context_s *cmd_ctx,
  * that *only* Thumb2 disassembly matters.  There are also some small
  * additions to Thumb2 that are specific to ARMv7-M.
  */
-static int
-handle_cortex_m3_disassemble_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_cortex_m3_disassemble_command)
 {
 	int retval;
 	target_t *target = get_current_target(cmd_ctx);
@@ -1835,9 +1833,7 @@ static const struct {
 	{ &quot;reset&quot;,	VC_CORERESET, },
 };
 
-static int
-handle_cortex_m3_vector_catch_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_cortex_m3_vector_catch_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
@@ -1894,9 +1890,7 @@ write:
 	return ERROR_OK;
 }
 
-static int
-handle_cortex_m3_mask_interrupts_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_cortex_m3_mask_interrupts_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct cortex_m3_common_s *cortex_m3 = target_to_cm3(target);
diff --git a/src/target/etb.c b/src/target/etb.c
index 3a4e3fe..c0c485f 100644
--- a/src/target/etb.c
+++ b/src/target/etb.c
@@ -349,7 +349,7 @@ static int etb_write_reg(reg_t *reg, uint32_t value)
 	return ERROR_OK;
 }
 
-static int handle_etb_config_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_etb_config_command)
 {
 	target_t *target;
 	jtag_tap_t *tap;
diff --git a/src/target/etm.c b/src/target/etm.c
index f01f366..0fc9249 100644
--- a/src/target/etm.c
+++ b/src/target/etm.c
@@ -1248,8 +1248,7 @@ static int handle_etm_tracemode_command_update(
 	return ERROR_OK;
 }
 
-static int handle_etm_tracemode_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_etm_tracemode_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct arm *arm = target_to_arm(target);
@@ -1371,8 +1370,7 @@ static int handle_etm_tracemode_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_etm_config_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_etm_config_command)
 {
 	target_t *target;
 	struct arm *arm;
@@ -1522,8 +1520,7 @@ static int handle_etm_config_command(struct command_context_s *cmd_ctx,
 	return etm_register_user_commands(cmd_ctx);
 }
 
-static int handle_etm_info_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_etm_info_command)
 {
 	target_t *target;
 	struct arm *arm;
@@ -1655,8 +1652,7 @@ static int handle_etm_info_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_etm_status_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_etm_status_command)
 {
 	target_t *target;
 	struct arm *arm;
@@ -1732,8 +1728,7 @@ static int handle_etm_status_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_etm_image_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_etm_image_command)
 {
 	target_t *target;
 	struct arm *arm;
@@ -1792,8 +1787,7 @@ static int handle_etm_image_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_etm_dump_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_etm_dump_command)
 {
 	fileio_t file;
 	target_t *target;
@@ -1861,8 +1855,7 @@ static int handle_etm_dump_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_etm_load_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_etm_load_command)
 {
 	fileio_t file;
 	target_t *target;
@@ -1946,8 +1939,7 @@ static int handle_etm_load_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_etm_trigger_percent_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_etm_trigger_percent_command)
 {
 	target_t *target;
 	struct arm *arm;
@@ -1988,8 +1980,7 @@ static int handle_etm_trigger_percent_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_etm_start_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_etm_start_command)
 {
 	target_t *target;
 	struct arm *arm;
@@ -2037,8 +2028,7 @@ static int handle_etm_start_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_etm_stop_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_etm_stop_command)
 {
 	target_t *target;
 	struct arm *arm;
@@ -2077,8 +2067,7 @@ static int handle_etm_stop_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_etm_analyze_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_etm_analyze_command)
 {
 	target_t *target;
 	struct arm *arm;
diff --git a/src/target/etm_dummy.c b/src/target/etm_dummy.c
index 0c5fc11..6bb2cde 100644
--- a/src/target/etm_dummy.c
+++ b/src/target/etm_dummy.c
@@ -25,7 +25,7 @@
 #include &quot;etm_dummy.h&quot;
 
 
-static int handle_etm_dummy_config_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_etm_dummy_config_command)
 {
 	target_t *target;
 	struct arm *arm;
diff --git a/src/target/oocd_trace.c b/src/target/oocd_trace.c
index e0048e6..755e1b6 100644
--- a/src/target/oocd_trace.c
+++ b/src/target/oocd_trace.c
@@ -289,7 +289,7 @@ etm_capture_driver_t oocd_trace_capture_driver =
 	.read_trace = oocd_trace_read_trace,
 };
 
-static int handle_oocd_trace_config_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_oocd_trace_config_command)
 {
 	target_t *target;
 	struct arm *arm;
@@ -326,7 +326,7 @@ static int handle_oocd_trace_config_command(struct command_context_s *cmd_ctx, c
 	return ERROR_OK;
 }
 
-static int handle_oocd_trace_status_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_oocd_trace_status_command)
 {
 	target_t *target;
 	struct arm *arm;
@@ -366,7 +366,7 @@ static int handle_oocd_trace_status_command(struct command_context_s *cmd_ctx, c
 	return ERROR_OK;
 }
 
-static int handle_oocd_trace_resync_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_oocd_trace_resync_command)
 {
 	target_t *target;
 	struct arm *arm;
diff --git a/src/target/target.c b/src/target/target.c
index 575a99c..401f4df 100644
--- a/src/target/target.c
+++ b/src/target/target.c
@@ -1650,7 +1650,7 @@ int target_write_u8(struct target_s *target, uint32_t address, uint8_t value)
 	return retval;
 }
 
-static int handle_targets_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_targets_command)
 {
 	target_t *target = all_targets;
 
@@ -1862,7 +1862,7 @@ int handle_target(void *priv)
 	return retval;
 }
 
-static int handle_reg_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_reg_command)
 {
 	target_t *target;
 	reg_t *reg = NULL;
@@ -1993,7 +1993,7 @@ static int handle_reg_command(struct command_context_s *cmd_ctx, char *cmd, char
 	return ERROR_OK;
 }
 
-static int handle_poll_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_poll_command)
 {
 	int retval = ERROR_OK;
 	target_t *target = get_current_target(cmd_ctx);
@@ -2035,7 +2035,7 @@ static int handle_poll_command(struct command_context_s *cmd_ctx, char *cmd, cha
 	return retval;
 }
 
-static int handle_wait_halt_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_wait_halt_command)
 {
 	if (argc &gt; 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -2102,7 +2102,7 @@ int target_wait_state(target_t *target, enum target_state state, int ms)
 	return ERROR_OK;
 }
 
-static int handle_halt_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_halt_command)
 {
 	LOG_DEBUG(&quot;-&quot;);
 
@@ -2124,7 +2124,7 @@ static int handle_halt_command(struct command_context_s *cmd_ctx, char *cmd, cha
 	return handle_wait_halt_command(cmd_ctx, cmd, args, argc);
 }
 
-static int handle_soft_reset_halt_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_soft_reset_halt_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 
@@ -2135,7 +2135,7 @@ static int handle_soft_reset_halt_command(struct command_context_s *cmd_ctx, cha
 	return ERROR_OK;
 }
 
-static int handle_reset_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_reset_command)
 {
 	if (argc &gt; 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -2156,7 +2156,7 @@ static int handle_reset_command(struct command_context_s *cmd_ctx, char *cmd, ch
 }
 
 
-static int handle_resume_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_resume_command)
 {
 	int current = 1;
 	if (argc &gt; 1)
@@ -2178,7 +2178,7 @@ static int handle_resume_command(struct command_context_s *cmd_ctx, char *cmd, c
 	return target_resume(target, current, addr, 1, 0);
 }
 
-static int handle_step_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_step_command)
 {
 	if (argc &gt; 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -2250,7 +2250,7 @@ static void handle_md_output(struct command_context_s *cmd_ctx,
 	}
 }
 
-static int handle_md_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_md_command)
 {
 	if (argc &lt; 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -2299,7 +2299,7 @@ static int handle_md_command(struct command_context_s *cmd_ctx, char *cmd, char
 	return retval;
 }
 
-static int handle_mw_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_mw_command)
 {
 	if (argc &lt; 2)
 	{
@@ -2401,7 +2401,7 @@ static int parse_load_image_command_args(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int handle_load_image_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_load_image_command)
 {
 	uint8_t *buffer;
 	uint32_t buf_cnt;
@@ -2492,7 +2492,7 @@ static int handle_load_image_command(struct command_context_s *cmd_ctx, char *cm
 
 }
 
-static int handle_dump_image_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_dump_image_command)
 {
 	fileio_t fileio;
 
@@ -2700,12 +2700,12 @@ done:
 	return retval;
 }
 
-static int handle_verify_image_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_verify_image_command)
 {
 	return handle_verify_image_command_internal(cmd_ctx, cmd, args, argc, 1);
 }
 
-static int handle_test_image_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_test_image_command)
 {
 	return handle_verify_image_command_internal(cmd_ctx, cmd, args, argc, 0);
 }
@@ -2750,8 +2750,7 @@ static int handle_bp_command_set(struct command_context_s *cmd_ctx,
 	return retval;
 }
 
-static int handle_bp_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_bp_command)
 {
 	if (argc == 0)
 		return handle_bp_command_list(cmd_ctx);
@@ -2779,7 +2778,7 @@ static int handle_bp_command(struct command_context_s *cmd_ctx,
 	return handle_bp_command_set(cmd_ctx, addr, length, hw);
 }
 
-static int handle_rbp_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_rbp_command)
 {
 	if (argc != 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -2793,7 +2792,7 @@ static int handle_rbp_command(struct command_context_s *cmd_ctx, char *cmd, char
 	return ERROR_OK;
 }
 
-static int handle_wp_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_wp_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 
@@ -2865,7 +2864,7 @@ static int handle_wp_command(struct command_context_s *cmd_ctx, char *cmd, char
 	return retval;
 }
 
-static int handle_rwp_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_rwp_command)
 {
 	if (argc != 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -2886,8 +2885,7 @@ static int handle_rwp_command(struct command_context_s *cmd_ctx, char *cmd, char
  * The low-level target implementation must have logged a detailed error
  * which is forwarded to telnet/GDB session.
  */
-static int handle_virt2phys_command(command_context_t *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_virt2phys_command)
 {
 	if (argc != 1)
 		return ERROR_COMMAND_SYNTAX_ERROR;
@@ -3021,7 +3019,7 @@ static void writeGmon(uint32_t *samples, uint32_t sampleNum, const char *filenam
 }
 
 /* profiling samples the CPU PC as quickly as OpenOCD is able, which will be used as a random sampling of PC */
-static int handle_profile_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_profile_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct timeval timeout, now;
@@ -4539,7 +4537,7 @@ static void free_fastload(void)
 
 
 
-static int handle_fast_load_image_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_fast_load_image_command)
 {
 	uint8_t *buffer;
 	uint32_t buf_cnt;
@@ -4650,7 +4648,7 @@ static int handle_fast_load_image_command(struct command_context_s *cmd_ctx, cha
 	return retval;
 }
 
-static int handle_fast_load_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_fast_load_command)
 {
 	if (argc &gt; 0)
 		return ERROR_COMMAND_SYNTAX_ERROR;
diff --git a/src/target/target_request.c b/src/target/target_request.c
index 5bfd57a..4bfda5b 100644
--- a/src/target/target_request.c
+++ b/src/target/target_request.c
@@ -257,7 +257,7 @@ int delete_debug_msg_receiver(struct command_context_s *cmd_ctx, target_t *targe
 	return ERROR_OK;
 }
 
-static int handle_target_request_debugmsgs_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_target_request_debugmsgs_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 
diff --git a/src/target/trace.c b/src/target/trace.c
index e74c616..2c25970 100644
--- a/src/target/trace.c
+++ b/src/target/trace.c
@@ -47,7 +47,7 @@ int trace_point(target_t *target, uint32_t number)
 	return ERROR_OK;
 }
 
-static int handle_trace_point_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_trace_point_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	trace_t *trace = target-&gt;trace_info;
@@ -95,7 +95,7 @@ static int handle_trace_point_command(struct command_context_s *cmd_ctx, char *c
 	return ERROR_OK;
 }
 
-static int handle_trace_history_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_trace_history_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	trace_t *trace = target-&gt;trace_info;
diff --git a/src/target/xscale.c b/src/target/xscale.c
index 0dc18f0..6f2d6ee 100644
--- a/src/target/xscale.c
+++ b/src/target/xscale.c
@@ -2989,9 +2989,7 @@ static int xscale_target_create(struct target_s *target, Jim_Interp *interp)
 			target-&gt;variant);
 }
 
-static int
-xscale_handle_debug_handler_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(xscale_handle_debug_handler_command)
 {
 	target_t *target = NULL;
 	xscale_common_t *xscale;
@@ -3031,9 +3029,7 @@ xscale_handle_debug_handler_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int
-xscale_handle_cache_clean_address_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(xscale_handle_cache_clean_address_command)
 {
 	target_t *target = NULL;
 	xscale_common_t *xscale;
@@ -3070,9 +3066,7 @@ xscale_handle_cache_clean_address_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int
-xscale_handle_cache_info_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(xscale_handle_cache_info_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct xscale_common_s *xscale = target_to_xscale(target);
@@ -3121,8 +3115,7 @@ static int xscale_mmu(struct target_s *target, int *enabled)
 	return ERROR_OK;
 }
 
-static int xscale_handle_mmu_command(command_context_t *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(xscale_handle_mmu_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct xscale_common_s *xscale = target_to_xscale(target);
@@ -3157,8 +3150,7 @@ static int xscale_handle_mmu_command(command_context_t *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int xscale_handle_idcache_command(command_context_t *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(xscale_handle_idcache_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct xscale_common_s *xscale = target_to_xscale(target);
@@ -3211,8 +3203,7 @@ static int xscale_handle_idcache_command(command_context_t *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int xscale_handle_vector_catch_command(command_context_t *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(xscale_handle_vector_catch_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct xscale_common_s *xscale = target_to_xscale(target);
@@ -3239,8 +3230,7 @@ static int xscale_handle_vector_catch_command(command_context_t *cmd_ctx,
 }
 
 
-static int xscale_handle_vector_table_command(command_context_t *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(xscale_handle_vector_table_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct xscale_common_s *xscale = target_to_xscale(target);
@@ -3298,9 +3288,7 @@ static int xscale_handle_vector_table_command(command_context_t *cmd_ctx,
 }
 
 
-static int
-xscale_handle_trace_buffer_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(xscale_handle_trace_buffer_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct xscale_common_s *xscale = target_to_xscale(target);
@@ -3379,9 +3367,7 @@ xscale_handle_trace_buffer_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int
-xscale_handle_trace_image_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(xscale_handle_trace_image_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct xscale_common_s *xscale = target_to_xscale(target);
@@ -3429,8 +3415,7 @@ xscale_handle_trace_image_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int xscale_handle_dump_trace_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(xscale_handle_dump_trace_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct xscale_common_s *xscale = target_to_xscale(target);
@@ -3487,9 +3472,7 @@ static int xscale_handle_dump_trace_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int
-xscale_handle_analyze_trace_buffer_command(struct command_context_s *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(xscale_handle_analyze_trace_buffer_command)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct xscale_common_s *xscale = target_to_xscale(target);
@@ -3504,8 +3487,7 @@ xscale_handle_analyze_trace_buffer_command(struct command_context_s *cmd_ctx,
 	return ERROR_OK;
 }
 
-static int xscale_handle_cp15(command_context_t *cmd_ctx,
-		char *cmd, char **args, int argc)
+COMMAND_HANDLER(xscale_handle_cp15)
 {
 	target_t *target = get_current_target(cmd_ctx);
 	struct xscale_common_s *xscale = target_to_xscale(target);
diff --git a/src/xsvf/xsvf.c b/src/xsvf/xsvf.c
index 909d7a1..e0756b5 100644
--- a/src/xsvf/xsvf.c
+++ b/src/xsvf/xsvf.c
@@ -175,7 +175,7 @@ static int xsvf_read_buffer(int num_bits, int fd, uint8_t* buf)
 }
 
 
-static int handle_xsvf_command(struct command_context_s *cmd_ctx, char *cmd, char **args, int argc)
+COMMAND_HANDLER(handle_xsvf_command)
 {
 	uint8_t *dr_out_buf = NULL;				/* from host to device (TDI) */
 	uint8_t *dr_in_buf = NULL;				/* from device to host (TDO) */

commit ddb6138ed428f666064d26bb08036de3afe44bc8
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 19:00:01 2009 -0800

    add command_handler_t type
    
    This patch adds new typedefs for command handler callback functions.
    Users of this type signature were updated to use these new types.
    It uses the new __COMMAND_HANDLER macro to prevent duplication.

diff --git a/src/helper/command.c b/src/helper/command.c
index 603da82..e467be0 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -225,9 +225,7 @@ static void command_add_child(struct command_s **head, struct command_s *c)
 }
 
 command_t* register_command(command_context_t *context,
-		command_t *parent, char *name,
-		int (*handler)(struct command_context_s *context,
-				char* name, char** args, int argc),
+		command_t *parent, char *name, command_handler_t handler,
 		enum command_mode mode, char *help)
 {
 	if (!context || !name)
diff --git a/src/helper/command.h b/src/helper/command.h
index 236dabb..aec066d 100644
--- a/src/helper/command.h
+++ b/src/helper/command.h
@@ -122,12 +122,15 @@ typedef struct command_context_s
 #define COMMAND_HELPER(name, extra...) __COMMAND_HANDLER(name, extra)
 
 
+/// The type signature for commands' handler functions.
+typedef __COMMAND_HANDLER((*command_handler_t));
+
 typedef struct command_s
 {
 	char *name;
 	struct command_s *parent;
 	struct command_s *children;
-	int (*handler)(struct command_context_s *context, char* name, char** args, int argc);
+	command_handler_t handler;
 	enum command_mode mode;
 	struct command_s *next;
 } command_t;
@@ -143,9 +146,7 @@ typedef struct command_s
 char *command_name(struct command_s *c, char delim);
 
 command_t* register_command(command_context_t *context,
-		command_t *parent, char *name,
-		int (*handler)(struct command_context_s *context,
-				char* name, char** args, int argc),
+		command_t *parent, char *name, command_handler_t handler,
 		enum command_mode mode, char *help);
 
 int unregister_command(command_context_t *context, char *name);

commit 3f9fd4e2a6ab7b3ce3819c385c34cf6f4630763c
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 18:51:32 2009 -0800

    add COMMAND_HANDLER and COMMAND_HELPER macros
    
    The COMMAND_HANDLER and COMMAND_HELPER macros allow commands to be
    defined in a manner that decouples them from the exact order and type of
    their parameters.  Once converted, incremental changes to the command
    handler type can be addressed in incremental patches that do not need to
    touch the entire tree.
    
    These macros' implementation, __COMMAND_HANDLER, is used to define the
    new command_handler_t type, and additional patches will use it to derive
    new macros to define extended command types (e.g. flash, nand, pld).
    The CALL_COMMAND_HANDLER provides a means of calling helpers or nested
    handlers from withing a command handler.
    
    This patch uses C99 varadic macro expansion.  Please report compilers
    that cannot handle this code.

diff --git a/src/helper/command.h b/src/helper/command.h
index ded76fe..236dabb 100644
--- a/src/helper/command.h
+++ b/src/helper/command.h
@@ -80,6 +80,48 @@ typedef struct command_context_s
 	void *output_handler_priv;
 } command_context_t;
 
+
+/**
+ * Command handlers may be defined with more parameters than the base
+ * set provided by command.c.  This macro uses C99 magic to allow
+ * defining all such derivative types using this macro.
+ */
+#define __COMMAND_HANDLER(name, extra...) \
+		int name(struct command_context_s *cmd_ctx, \
+				char *cmd, char **args, int argc, ##extra)
+
+/**
+ * Use this to macro to call a command helper (or a nested handler).
+ * It provides command handler authors protection against reordering or
+ * removal of unused parameters.
+ *
+ * @b Note: This macro uses lexical capture to provide some arguments.
+ * As a result, this macro should be used @b only within functions
+ * defined by the COMMAND_HANDLER or COMMAND_HELPER macros.  Those
+ * macros provide the expected lexical context captured by this macro.
+ * Furthermore, it should be used only from the top-level of handler or
+ * helper function, or care must be taken to avoid redefining the same
+ * variables in intervening scope(s) by accident.
+ */
+#define CALL_COMMAND_HANDLER(name, extra...) \
+		name(cmd_ctx, cmd, args, argc, ##extra)
+
+/**
+ * Always use this macro to define new command handler functions.
+ * It ensures the parameters are ordered, typed, and named properly, so
+ * they be can be used by other macros (e.g. COMMAND_PARSE_NUMBER).
+ * All command handler functions must be defined as static in scope.
+ */
+#define COMMAND_HANDLER(name) static __COMMAND_HANDLER(name)
+
+/**
+ * Similar to COMMAND_HANDLER, except some parameters are expected.
+ * A helper is globally-scoped because it may be shared between several
+ * source files (e.g. the s3c24xx device command helper).
+ */
+#define COMMAND_HELPER(name, extra...) __COMMAND_HANDLER(name, extra)
+
+
 typedef struct command_s
 {
 	char *name;

commit 1ae4d93c3c90f176f6b94579ba3fabe1e17d715e
Author: Zachary T Welch &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openocd-svn">zw at superlucidity.net</A>&gt;
Date:   Tue Nov 10 18:42:45 2009 -0800

    add command_output_handler_t
    
    Add a typedef for command output handler function type, simplifying
    the appearance of functions that use it and eliminating duplicate code.

diff --git a/src/helper/command.c b/src/helper/command.c
index f960127..603da82 100644
--- a/src/helper/command.c
+++ b/src/helper/command.c
@@ -558,7 +558,8 @@ int command_run_linef(command_context_t *context, const char *format, ...)
 	return retval;
 }
 
-void command_set_output_handler(command_context_t* context, int (*output_handler)(struct command_context_s *context, const char* line), void *priv)
+void command_set_output_handler(command_context_t* context,
+		command_output_handler_t output_handler, void *priv)
 {
 	context-&gt;output_handler = output_handler;
 	context-&gt;output_handler_priv = priv;
diff --git a/src/helper/command.h b/src/helper/command.h
index 732fa52..ded76fe 100644
--- a/src/helper/command.h
+++ b/src/helper/command.h
@@ -51,6 +51,12 @@ enum command_mode
 	COMMAND_ANY,
 };
 
+struct command_context_s;
+
+/// The type signature for command context's output handler.
+typedef int (*command_output_handler_t)(struct command_context_s *context,
+				const char* line);
+
 typedef struct command_context_s
 {
 	enum command_mode mode;
@@ -70,7 +76,7 @@ typedef struct command_context_s
 	 * Returning ERROR_COMMAND_SYNTAX_ERROR will have the effect of
 	 * printing out the syntax of the command.
 	 */
-	int (*output_handler)(struct command_context_s *context, const char* line);
+	command_output_handler_t output_handler;
 	void *output_handler_priv;
 } command_context_t;
 
@@ -104,8 +110,7 @@ int unregister_command(command_context_t *context, char *name);
 int unregister_all_commands(command_context_t *context);
 
 void command_set_output_handler(command_context_t* context,
-		int (*output_handler)(struct command_context_s *context,
-		const char* line), void *priv);
+		command_output_handler_t output_handler, void *priv);
 
 command_context_t* copy_command_context(command_context_t* context);
 

-----------------------------------------------------------------------

Summary of changes:
 doc/manual/helper.txt               |   58 ++++++++++++++++++++-
 doc/manual/main.txt                 |    8 +++-
 doc/manual/primer/commands.txt      |   99 +++++++++++++++++++++++++++++++++++
 src/Makefile.am                     |    4 +-
 src/flash/aduc702x.c                |    2 +-
 src/flash/at91sam3.c                |   16 ++----
 src/flash/at91sam7.c                |    4 +-
 src/flash/avrf.c                    |    4 +-
 src/flash/cfi.c                     |    7 +--
 src/flash/davinci_nand.c            |    4 +-
 src/flash/ecos.c                    |    2 +-
 src/flash/faux.c                    |    2 +-
 src/flash/flash.c                   |   29 +++++-----
 src/flash/flash.h                   |    8 ++-
 src/flash/lpc2000.c                 |    4 +-
 src/flash/lpc288x.c                 |    2 +-
 src/flash/lpc2900.c                 |   22 +++-----
 src/flash/lpc3180_nand_controller.c |    4 +-
 src/flash/mflash.c                  |   11 ++--
 src/flash/mx3_nand.c                |    4 +-
 src/flash/nand.c                    |   27 +++++-----
 src/flash/nand.h                    |    7 ++-
 src/flash/ocl.c                     |    2 +-
 src/flash/orion_nand.c              |    4 +-
 src/flash/pic32mx.c                 |   12 ++--
 src/flash/s3c2410_nand.c            |   10 +---
 src/flash/s3c2412_nand.c            |   10 +---
 src/flash/s3c2440_nand.c            |   10 +---
 src/flash/s3c2443_nand.c            |   10 +---
 src/flash/s3c24xx_nand.c            |   11 ++---
 src/flash/s3c24xx_nand.h            |   16 +++++-
 src/flash/stellaris.c               |    4 +-
 src/flash/stm32x.c                  |   14 +++---
 src/flash/str7x.c                   |    6 +-
 src/flash/str9x.c                   |    9 +--
 src/flash/str9xpec.c                |   24 ++++----
 src/flash/tms470.c                  |    8 ++--
 src/{target/algorithm.c =&gt; hello.c} |   55 ++++++++++---------
 src/helper/command.c                |   34 ++++++------
 src/helper/command.h                |   68 +++++++++++++++++++++---
 src/helper/ioutil.c                 |   22 +++-----
 src/helper/log.c                    |    4 +-
 src/jtag/amt_jtagaccel.c            |    5 +-
 src/jtag/ft2232.c                   |   15 +++---
 src/jtag/gw16012.c                  |    2 +-
 src/jtag/parport.c                  |   10 ++--
 src/jtag/presto.c                   |    2 +-
 src/jtag/tcl.c                      |   44 ++++++---------
 src/jtag/vsllink.c                  |   12 ++--
 src/openocd.c                       |    8 ++-
 src/pld/pld.c                       |   12 ++---
 src/pld/pld.h                       |    7 ++-
 src/pld/virtex2.c                   |    9 ++--
 src/server/gdb_server.c             |   14 +++---
 src/server/server.c                 |    6 +--
 src/server/server.h                 |   12 ++++-
 src/server/tcl_server.c             |    5 +-
 src/server/telnet_server.c          |    8 +--
 src/svf/svf.c                       |    6 +-
 src/target/arm11.c                  |   21 ++++----
 src/target/arm720t.c                |    5 +-
 src/target/arm7_9_common.c          |   12 ++--
 src/target/arm920t.c                |   19 +++----
 src/target/arm926ejs.c              |    9 +--
 src/target/arm966e.c                |    5 +-
 src/target/arm9tdmi.c               |    9 ++--
 src/target/arm_adi_v5.c             |   12 ++---
 src/target/arm_adi_v5.h             |   15 +++---
 src/target/armv4_5.c                |    8 +--
 src/target/armv7a.c                 |   27 ++++------
 src/target/armv7m.c                 |   21 +++-----
 src/target/cortex_a8.c              |    6 +--
 src/target/cortex_m3.c              |   14 ++----
 src/target/etb.c                    |    2 +-
 src/target/etm.c                    |   40 +++++---------
 src/target/etm_dummy.c              |    2 +-
 src/target/oocd_trace.c             |    6 +-
 src/target/target.c                 |   69 ++++++++++++-------------
 src/target/target_request.c         |    2 +-
 src/target/trace.c                  |    4 +-
 src/target/xscale.c                 |   56 +++++++-------------
 src/xsvf/xsvf.c                     |    2 +-
 82 files changed, 653 insertions(+), 551 deletions(-)
 create mode 100644 doc/manual/primer/commands.txt
 copy src/{target/algorithm.c =&gt; hello.c} (62%)
 create mode 100644 src/target/avrt.o.RcaTm5


hooks/post-receive
-- 
Main OpenOCD repository

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001773.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-164-g5eb638c
</A></li>
	<LI>Next message: <A HREF="001775.html">[openocd-svn] Main OpenOCD repository branch, master,	updated. v0.3.0-184-g99b57b6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1774">[ date ]</a>
              <a href="thread.html#1774">[ thread ]</a>
              <a href="subject.html#1774">[ subject ]</a>
              <a href="author.html#1774">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openocd-svn">More information about the openocd-svn
mailing list</a><br>
</body></html>
